
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Exercise 3: Async programming introduction &mdash; Learn MongoDB And Node.js The Hard Way</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Learn MongoDB And Node.js The Hard Way" href="index.html" />
    <link rel="next" title="Exercise 4: Connecting to a single MongoDB instance from Node.js" href="ex4.html" />
    <link rel="prev" title="Exercise 2: Installing MongoDB" href="ex2.html" /> 
  </head>
  <body>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="ex4.html" title="Exercise 4: Connecting to a single MongoDB instance from Node.js"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="ex2.html" title="Exercise 2: Installing MongoDB"
             accesskey="P">previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>



    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="exercise-3-async-programming-introduction">
<h1>Exercise 3: Async programming introduction<a class="headerlink" href="#exercise-3-async-programming-introduction" title="Permalink to this headline">¶</a></h1>
<p>There are several pitfals that are worth understanding before we get started
exploring the driver and <tt class="docutils literal"><span class="pre">MongoDB</span></tt> in general. This have to do with the
essential differences between synchronous and asynchronous programming. It's
best served by some examples. For the rest of the exercises we will assume that
you understand how to enter code using the editor for your system.</p>
<p>Lets take a simple application that fetches a twitter feed a couple of thousand
times. But before we start let's install another <tt class="docutils literal"><span class="pre">npm</span> <span class="pre">package</span></tt> that simplifies
the fetching of web pages. This module is called <tt class="docutils literal"><span class="pre">request</span></tt>. Perform the following
tasks to install it and then lets get one with some coding.</p>
<div class="section" id="mac-osx">
<h2>Mac OSX<a class="headerlink" href="#mac-osx" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Start up the <tt class="docutils literal"><span class="pre">Terminal</span></tt> application.</p>
</li>
<li><p class="first">Go to the directory <tt class="docutils literal"><span class="pre">learn-exercises</span></tt> we created in <tt class="docutils literal"><span class="pre">exercise</span> <span class="pre">0</span></tt>.</p>
</li>
<li><p class="first">Install the <tt class="docutils literal"><span class="pre">request</span></tt> package using <tt class="docutils literal"><span class="pre">NPM</span></tt></p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">~ $ npm install request</span>
<span class="go">npm http GET https://registry.npmjs.org/request</span>
<span class="go">npm http 200 https://registry.npmjs.org/request</span>
<span class="go">npm http GET https://registry.npmjs.org/request/-/request-2.12.0.tgz</span>
<span class="go">npm http 200 https://registry.npmjs.org/request/-/request-2.12.0.tgz</span>
<span class="go">request@2.12.0 node_modules/request</span>
</pre></div>
</div>
</li>
<li><p class="first">Bring up <tt class="docutils literal"><span class="pre">TextWrangler</span></tt> and enter the script below</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">);</span>

<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">request</span><span class="p">(</span><span class="s1">&#39;http://www.google.com&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Retrieved the web page&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;DONE&quot;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>Save it as the file <tt class="docutils literal"><span class="pre">ex1.js</span></tt> in the directory <tt class="docutils literal"><span class="pre">learn-exercises</span></tt></p>
</li>
<li><p class="first">From the terminal execute the script <tt class="docutils literal"><span class="pre">ex1.js</span></tt></p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">~ $ node ex1.js</span>
<span class="go">DONE</span>
<span class="go">Retrieved the web page</span>
<span class="go">Retrieved the web page</span>
<span class="go">Retrieved the web page</span>
<span class="go">Retrieved the web page</span>
<span class="go">Retrieved the web page</span>
<span class="go">Retrieved the web page</span>
<span class="go">Retrieved the web page</span>
<span class="go">Retrieved the web page</span>
<span class="go">(node) warning: possible EventEmitter memory leak detected. 11 listeners added. Use emitter.setMaxListeners() to increase limit.</span>
<span class="go">Trace</span>
<span class="go">    at Socket.EventEmitter.addListener (events.js:175:15)</span>
<span class="go">    at Socket.EventEmitter.once (events.js:196:8)</span>
<span class="go">    at ClientRequest.&lt;anonymous&gt; (/Users/ck/coding/projects/learnexercises/node_modules/request/main.js:521:27)</span>
<span class="go">    at ClientRequest.g (events.js:192:14)</span>
<span class="go">    at ClientRequest.EventEmitter.emit (events.js:96:17)</span>
<span class="go">    at HTTPParser.parserOnIncomingClient [as onIncoming] (http.js:1462:7)</span>
<span class="go">    at HTTPParser.parserOnHeadersComplete [as onHeadersComplete] (http.js:111:23)</span>
<span class="go">    at Socket.socketOnData [as ondata] (http.js:1367:20)</span>
<span class="go">    at TCP.onread (net.js:403:27)</span>
<span class="go">(node) warning: possible EventEmitter memory leak detected. 11 listeners added. Use emitter.setMaxListeners() to increase limit.</span>

<span class="go">Looking at the output from our little program notice that the first line ``DONE``</span>
<span class="go">was the last line in our program. This shows one of the main pitfals most developers</span>
<span class="go">fall into when they start using ``Node.js`` and merits a more profound explanation</span>
<span class="go">and then an example on how to avoid this.</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="asynchronous-programming">
<h2>Asynchronous Programming<a class="headerlink" href="#asynchronous-programming" title="Permalink to this headline">¶</a></h2>
<p>The traditional way a programming language works is by stopping when we do an operation
that requires the program to talk to things like your hard disk or a server on a network
until they answer. If you wrote the example above in <tt class="docutils literal"><span class="pre">ruby</span></tt> or <tt class="docutils literal"><span class="pre">python</span></tt> it would
process each fetch one after the other and once it had finished it would print <tt class="docutils literal"><span class="pre">DONE</span></tt>.</p>
<p>But in <tt class="docutils literal"><span class="pre">Node.JS</span></tt> any operation that wants to communicate with a hard disk or server
returns at once and the results are then returned to the program in an callback. So
when the program runs all the requests to fetch the google homepage starts at the same
time and as each is finished the function containing the <tt class="docutils literal"><span class="pre">console.log</span></tt> statement is
triggered. Since they all get started at the same time <tt class="docutils literal"><span class="pre">Node.js</span></tt> complains that we
might have a memory leak. If we start enough of these requests it will schedule retrivals
of the google homepage until our program runs out of memory and crashes.</p>
<p>But this can be easily fixed. Let's enter it. Write the code and save it as <tt class="docutils literal"><span class="pre">ex2.js</span></tt></p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">load10AtATime</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>  

  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">(</span><span class="s1">&#39;http://www.google.com&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Retrieved the web page&quot;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">callback</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">loadBatches</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">numberOfBatches</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;= Loading batch :: &quot;</span> <span class="o">+</span> <span class="nx">numberOfBatches</span><span class="p">);</span>

  <span class="nx">load10AtATime</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">numberOfBatches</span> <span class="o">=</span> <span class="nx">numberOfBatches</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    
    <span class="k">if</span><span class="p">(</span><span class="nx">numberOfBatches</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">();</span>
    <span class="nx">loadBatches</span><span class="p">(</span><span class="nx">numberOfBatches</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">loadBatches</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;DONE&quot;</span><span class="p">);</span>  
<span class="p">})</span>
</pre></div>
</td></tr></table></div>
<p>Did I say easily. Hmm maybe not easily. Let's do a review of the code and look at what it
means. The function <tt class="docutils literal"><span class="pre">load10AtATime</span></tt> has a <tt class="docutils literal"><span class="pre">callback</span></tt> function. This function will only be
called once the 10 requests have completed. To ensure that all the requests have completed
we have a count down variable called <tt class="docutils literal"><span class="pre">counter</span></tt> that is only decremented once the result
is returned from the request. Once <tt class="docutils literal"><span class="pre">counter</span></tt> reaches <tt class="docutils literal"><span class="pre">0</span></tt> we call the function <tt class="docutils literal"><span class="pre">callback</span></tt>
signaling that we have finished fetching the 10 copies of the google homepage. This function
thus takes care of loading 10 pages at a time in parallel.</p>
<p>Calling <tt class="docutils literal"><span class="pre">load10AtATime</span></tt> is the function <tt class="docutils literal"><span class="pre">loadBatches</span></tt>. This function is a recursive function
that calls itself 10 times until <tt class="docutils literal"><span class="pre">numberOfBatches</span></tt> is 0 and for each time it calls the <tt class="docutils literal"><span class="pre">load10AtATime</span></tt> function and waits for it to return before executing the next batch. Once <tt class="docutils literal"><span class="pre">numberOfBatches</span></tt>
reaches <tt class="docutils literal"><span class="pre">0</span></tt> it calls the callback function to return to the original caller.</p>
<p>Finally the last part of the code just starts the batch loading by calling it <tt class="docutils literal"><span class="pre">loadBatches</span></tt> with a start value of <tt class="docutils literal"><span class="pre">10</span></tt> and waits for it to finish before printing it out to the console.</p>
<p>One problem with this code is that if the number of batches is to high you can run out of stack
meaning the application will crash. A better way to handle this recurssion is to use a method called
<tt class="docutils literal"><span class="pre">process.nextTick</span></tt>. Below is an example of the code will look when using <tt class="docutils literal"><span class="pre">process.nextTick</span></tt>.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">load10AtATime</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>  

  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">(</span><span class="s1">&#39;http://www.google.com&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Retrieved the web page&quot;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">callback</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">loadBatches</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">numberOfBatches</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;= Loading batch :: &quot;</span> <span class="o">+</span> <span class="nx">numberOfBatches</span><span class="p">);</span>

  <span class="nx">load10AtATime</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">numberOfBatches</span> <span class="o">=</span> <span class="nx">numberOfBatches</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    
    <span class="k">if</span><span class="p">(</span><span class="nx">numberOfBatches</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">();</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">loadBatches</span><span class="p">(</span><span class="nx">numberOfBatches</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>      
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">loadBatches</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;DONE&quot;</span><span class="p">);</span>  
<span class="p">})</span>
</pre></div>
</td></tr></table></div>
<p><tt class="docutils literal"><span class="pre">process.nextTick</span></tt> schedules the function call for the next tick in the eventloop of Node.js. This
happens with a new stack allowing us to avoid running out of stack and crashing if we have are loading
to many batches in one go. There is another technique called a <tt class="docutils literal"><span class="pre">trampolining</span></tt> that can do the same but
this is left to you to investigate. The main issue is the lack of tail recurrsion. You can read more about it at <a class="reference external" href="http://en.wikipedia.org/wiki/Tail_call">http://en.wikipedia.org/wiki/Tail_call</a> including <tt class="docutils literal"><span class="pre">trampolining</span></tt>. That said I prefer to use
<tt class="docutils literal"><span class="pre">process.nextTick</span></tt> because it schedules the function call in the eventloop of Node.js letting other code run inbetween.</p>
<p>I also recommend using some of the excellent libraries for asynchronous programming for Node.js. Let's
see how we can accomplish the same using the <tt class="docutils literal"><span class="pre">async</span></tt> npm module. First install the npm module doing</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">npm install async</span>
</pre></div>
</div>
<p>Then fire up the text editor of your choice and enter the following example.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">async</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;async&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">numberOfBatches</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

<span class="nx">async</span><span class="p">.</span><span class="nx">whilst</span><span class="p">(</span>
    <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">numberOfBatches</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;= Loading batch :: &quot;</span> <span class="o">+</span> <span class="nx">numberOfBatches</span><span class="p">);</span>
      <span class="nx">numberOfBatches</span> <span class="o">=</span> <span class="nx">numberOfBatches</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">request</span><span class="p">(</span><span class="s1">&#39;http://www.google.com&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Retrieved the web page&quot;</span><span class="p">);</span>
          <span class="p">}</span>

          <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">callback</span><span class="p">();</span>
        <span class="p">});</span>        
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;DONE&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Let's have a quick look at the code. The <tt class="docutils literal"><span class="pre">async.whilst</span></tt> method takes three functions. The first
function is the <tt class="docutils literal"><span class="pre">while</span></tt> statement that tells <tt class="docutils literal"><span class="pre">whilst</span></tt> to keep running until the returned value
from the first function is <tt class="docutils literal"><span class="pre">false</span></tt>. The second function is the actual work being done in each pass
through the <tt class="docutils literal"><span class="pre">while</span></tt>. Once the program is done with it's work it calls the callback and the loop
repeats. When the first function returns false <tt class="docutils literal"><span class="pre">whilst</span></tt> calls the last function with the final
result. The second function is the same as the previous code example.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Grasping the fundamentals about asynchronous programming is important to the correct behaviour of you applications and also to leverage the high concurrency available in Node.js. Don't worry if you don't grasp it the first time around it can take a while to get used to it especially if you come from another programming platform that is synchronous like ruby, python, perl or php.</p>
<p class="last">It's worth spending some time practicing it or understanding how the <tt class="docutils literal"><span class="pre">async</span></tt> library works.</p>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="ex4.html" title="Exercise 4: Connecting to a single MongoDB instance from Node.js"
             >next</a></li>
        <li class="right" >
          <a href="ex2.html" title="Exercise 2: Installing MongoDB"
             >previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>
    <a name="comments"><hr/></a>

<div sytle="text-align: left">
    <div style="background: white; padding: 10px" id="disqus_thread"></div>
</div>
    <script type="text/javascript">
        var dow = new Date().getDay();

        if(dow == 5 || dow == 6) {
            $("#disqus_thread").html("<h1>Today Is Christians's Day Off</h1><p>I take Saturday and Sunday off.  Comments open again on Monday-Friday.</p>")
        } else {
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'learnmongodbthehardway'; // required: replace example with your forum shortname


            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        }
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <div class="footer">
      &copy; Copyright 2012, Christian Amor Kvalheim.
      Last updated on Jan 31, 2013.
</div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24168052-9']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </body>
</html>