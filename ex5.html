
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Exercise 5: Document documents everywhere &mdash; Learn MongoDB And Node.js The Hard Way</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Learn MongoDB And Node.js The Hard Way" href="index.html" />
    <link rel="next" title="Exercise 6: Databases and Collections" href="ex6.html" />
    <link rel="prev" title="Exercise 4: Connecting to a single MongoDB instance from Node.js" href="ex4.html" /> 
  </head>
  <body>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="ex6.html" title="Exercise 6: Databases and Collections"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="ex4.html" title="Exercise 4: Connecting to a single MongoDB instance from Node.js"
             accesskey="P">previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>



    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="exercise-5-document-documents-everywhere">
<h1>Exercise 5: Document documents everywhere<a class="headerlink" href="#exercise-5-document-documents-everywhere" title="Permalink to this headline">Â¶</a></h1>
<p>So it's probably dawned on you that MongoDB is a document database. Moreover it's schemaless database. So what does that mean in layman terms. Let's start with a simple example of a <tt class="docutils literal"><span class="pre">JSON</span></tt> document.</p>
<div class="highlight-json"><pre>{
  'name': 'MongoDB',
  'version': 2.2,
  'description': 'A schemaless document database',
  'features': ['schemaless', 'document oriented', 'fast', 'scalable'],
  'main developer': {
    name: '10gen',
    location: 'new york city'
  }
}</pre>
</div>
<p>As we can the document is made up of set of names and values <tt class="docutils literal"><span class="pre">'name':</span> <span class="pre">'MongoDB'</span></tt> and we can see that we can express such concepts as a list of features and a <tt class="docutils literal"><span class="pre">JSON</span></tt> embedded document under the name <tt class="docutils literal"><span class="pre">main</span> <span class="pre">developer</span></tt>. The possibilities on how to structure your data in documents is only limited by your imagination and the current 16MB limit for a single document.</p>
<p>MongoDB extends on <tt class="docutils literal"><span class="pre">JSON</span></tt> by adding types. This format is called <tt class="docutils literal"><span class="pre">BSON</span></tt> and is a binary representation of <tt class="docutils literal"><span class="pre">JSON</span></tt> with additonal types so the database can operate on them. These types can be summed up in a table (more details available at <a class="reference external" href="http://bsonspec.org/#/specification">http://bsonspec.org/#/specification</a>). We've only included the types that you will use from your application and ignored the ones that are internal data types or are not generally used in documents.</p>
<table border="1" class="docutils">
<colgroup>
<col width="7%" />
<col width="93%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Long</td>
<td>A 64 bit integer value that can take the value of +/- 9,223,372,036,854,775,808</td>
</tr>
<tr class="row-odd"><td>Date</td>
<td>A UTC Datetime value</td>
</tr>
<tr class="row-even"><td>Regexp</td>
<td>A regular expression</td>
</tr>
<tr class="row-odd"><td>Code</td>
<td>A Javascript string with an option scope for the script</td>
</tr>
<tr class="row-even"><td>Binary</td>
<td>A Binary blob object (can have a subtype)</td>
</tr>
<tr class="row-odd"><td>Double</td>
<td>A 64 bit float value (only use this if you have a whole number that you want stored as a double instead and not an integer)</td>
</tr>
</tbody>
</table>
<p>So how do we express a Document with all these special types in Node.js. Well fire up the text editor and let's get cracking on the code below.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">Long</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">Long</span>
  <span class="p">,</span> <span class="nx">Binary</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">Binary</span>
  <span class="p">,</span> <span class="nx">Code</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">Code</span>
  <span class="p">,</span> <span class="nx">ObjectID</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">ObjectID</span>
  <span class="p">,</span> <span class="nx">serialize</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">BSONPure</span><span class="p">.</span><span class="nx">BSON</span><span class="p">.</span><span class="nx">serialize</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="s1">&#39;hello world&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;64bitvalue&#39;</span><span class="o">:</span> <span class="nx">Long</span><span class="p">.</span><span class="nx">fromNumber</span><span class="p">(</span><span class="mi">45000000</span><span class="p">)</span>
  <span class="p">,</span> <span class="s1">&#39;array of values&#39;</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">}]</span>
  <span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Binary</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span>
  <span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Code</span><span class="p">(</span><span class="kd">function</span> <span class="nx">test</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;hello world&quot;</span><span class="p">;</span>
    <span class="p">})</span>
  <span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
  <span class="p">,</span> <span class="s1">&#39;regexp&#39;</span><span class="o">:</span> <span class="sr">/^hello/</span>
  <span class="p">,</span> <span class="s1">&#39;_id&#39;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">()</span>
<span class="p">}</span>

<span class="nx">serialize</span><span class="p">(</span><span class="nb">document</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>The <tt class="docutils literal"><span class="pre">serialize</span></tt> function is not a function you'll usually use in your programs but allows us to verify that the document is a valid <tt class="docutils literal"><span class="pre">BSON</span></tt> document by serializing it to it's binary representation.</p>
<p>There are some interesting limitations in Javascript due to the way way numbers are represented in the language. All numbers are actually <tt class="docutils literal"><span class="pre">double</span> <span class="pre">floats</span></tt> which means that the highest number you can represent in Javascript is 53 bits of resolution or <tt class="docutils literal"><span class="pre">+/-</span> <span class="pre">9,007,199,254,740,992</span></tt> which is significantly less than the <tt class="docutils literal"><span class="pre">Long</span></tt> type. This means that any <tt class="docutils literal"><span class="pre">Long</span></tt> values stored in MongoDB is returned as a <tt class="docutils literal"><span class="pre">Long</span></tt> instance instead of a <tt class="docutils literal"><span class="pre">Number</span></tt> instance. Since MongoDB can only store either 32 bit ints, 64 bit ints or 64 bit doubles the driver does intelligent conversion where possible. You can override this by doing <tt class="docutils literal"><span class="pre">new</span> <span class="pre">Double(1)</span></tt> to force it to store it as a 64 bit float instead of a 32 bit integer.</p>
<p>If we look a the second value in the document <tt class="docutils literal"><span class="pre">array</span> <span class="pre">of</span> <span class="pre">values</span></tt> we can see that it's an array composed of some numbers, a string and a document. This is a reflection of the flexibility of expression the document model gives you when modeling your applications data and one of the main reasons I think MongoDB is a blast of fresh air to traditional data modelling with relational tables.</p>
<p>The <tt class="docutils literal"><span class="pre">Binary</span></tt> type let's us store raw byte data in MongoDB. You can store such things as images or maybe binary files such as word documents or pdf's. However remember that a single document has a maximum size of 16MB. If you need to store Bigger files we will show you how in a later exercise using a driver feature called <tt class="docutils literal"><span class="pre">GridFS</span></tt>.</p>
<p>The <tt class="docutils literal"><span class="pre">Code</span></tt> object is kind of interesting and is used to store actual Javascript code in MongoDB. You can even execute this code on the server if you store it in a special place (but this is not recommended as Javascript on the server is not very performant and comes with some fairly harsh limitations, more on that later).</p>
<p>The <tt class="docutils literal"><span class="pre">date</span></tt> value is a Javascript Date object and MongoDB has native support for dates so you can sort on them in the database. For the driver this shows the perfect match of MongoDB and Node.js since the date type is just the one that already comes pre-packaged with Javascript.</p>
<p>The next value <tt class="docutils literal"><span class="pre">regexp</span></tt> is a a regular expression that can also be stored in MongoDB. For pure documents it might not be so useful but because queries in MongoDB are actually <tt class="docutils literal"><span class="pre">BSON</span></tt> documents it means that MongoDB supports regular expressions in queries.</p>
<p>The last value <tt class="docutils literal"><span class="pre">_id</span></tt> is a special type in MongoDB that is a 12 bit unique identifier inside a collection. This type is the default primary key in a collection (the primary key in a document is alway the <tt class="docutils literal"><span class="pre">_id</span></tt> field in a document) and is made up of a timestamp + some additional fields and an incremental value. This gives it a great secondary property of being sortable by time allowing you to sort any record that just contains the <tt class="docutils literal"><span class="pre">_id</span></tt> field by it's creation time.</p>
<p>So as you can see we can store pure <tt class="docutils literal"><span class="pre">JSON</span></tt> objects but also more complex types that go beyond what Javascript supports natively. This matching makes MongoDB a great database for Node.js. As we will see in future exercises the match between MongoDB and Node.js can be leveraged to do some very interesting and unique things.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Much of the power of MongoDB is locked in the design of your schema, how you design your data will impact the way you read and write the data and also the performance of you application. We will go more indepth on schema design in future exercises and look at benefits and tradeoffs associated with specific solutions.</p>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="ex6.html" title="Exercise 6: Databases and Collections"
             >next</a></li>
        <li class="right" >
          <a href="ex4.html" title="Exercise 4: Connecting to a single MongoDB instance from Node.js"
             >previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>
    <a name="comments"><hr/></a>

<div sytle="text-align: left">
    <div style="background: white; padding: 10px" id="disqus_thread"></div>
</div>
    <script type="text/javascript">
        var dow = new Date().getDay();

        if(dow == 5 || dow == 6) {
            $("#disqus_thread").html("<h1>Today Is Christians's Day Off</h1><p>I take Saturday and Sunday off.  Comments open again on Monday-Friday.</p>")
        } else {
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'learnmongodbthehardway'; // required: replace example with your forum shortname


            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        }
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <div class="footer">
      &copy; Copyright 2012, Christian Amor Kvalheim.
      Last updated on Jan 31, 2013.
</div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24168052-9']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </body>
</html>