
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Exercise 4: Connecting to a single MongoDB instance from Node.js &mdash; Learn MongoDB And Node.js The Hard Way</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Learn MongoDB And Node.js The Hard Way" href="index.html" />
    <link rel="next" title="Exercise 5: Document documents everywhere" href="ex5.html" />
    <link rel="prev" title="Exercise 3: Async programming introduction" href="ex3.html" /> 
  </head>
  <body>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="ex5.html" title="Exercise 5: Document documents everywhere"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="ex3.html" title="Exercise 3: Async programming introduction"
             accesskey="P">previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>



    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="exercise-4-connecting-to-a-single-mongodb-instance-from-node-js">
<h1>Exercise 4: Connecting to a single MongoDB instance from Node.js<a class="headerlink" href="#exercise-4-connecting-to-a-single-mongodb-instance-from-node-js" title="Permalink to this headline">Â¶</a></h1>
<p>In this exercise we will look at how to connect to <tt class="docutils literal"><span class="pre">MongoDB</span></tt> from Node.js. We will write a simple program that connects to the server and then disconnects itself. We are assuming the npm <tt class="docutils literal"><span class="pre">mongodb</span></tt> package is already installed (if not revisit exercise 1). Fire up your text editor and enter the following program.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>    
  <span class="p">}</span>
  
  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="p">})</span>
</pre></div>
</td></tr></table></div>
<p>Notice the weird string <tt class="docutils literal"><span class="pre">mongodb://localhost:27017/test</span></tt> this is called an <tt class="docutils literal"><span class="pre">URI</span></tt> connection string and is used by the driver to allow you to specify how to connect to a MongoDB server without specifying it programatically. This is useful if you need to use the same program against multiple different MongoDB setups as you can just store a seperate string for each environment.</p>
<p>The <tt class="docutils literal"><span class="pre">MongoClient.connect</span></tt> takes a function with 2 parameters where the first one is named <tt class="docutils literal"><span class="pre">err</span></tt> and the second <tt class="docutils literal"><span class="pre">db</span></tt>. This is how Node.js works and if you look at the documentation on the Node.js site <a class="reference external" href="http://nodejs.org/">http://nodejs.org/</a> you'll notice that all functions take the same function. If the function worked correctly the <tt class="docutils literal"><span class="pre">err</span></tt> parameter will be set to <tt class="docutils literal"><span class="pre">null</span></tt>. If it's not set to <tt class="docutils literal"><span class="pre">null</span></tt> there was an error during the <tt class="docutils literal"><span class="pre">MongoClient.connect</span></tt> call. To check if there was an error the code does <tt class="docutils literal"><span class="pre">if(err)</span></tt> that will return true if <tt class="docutils literal"><span class="pre">err</span></tt> is anything but <tt class="docutils literal"><span class="pre">null</span></tt> and then prints an error message before closing the connection.</p>
<p>But say we have 2 different databases we want to use. Can we do just do <tt class="docutils literal"><span class="pre">MongoClient.connect</span></tt> calls. The answer is yes but that it's not optimal. The reason is that <tt class="docutils literal"><span class="pre">MongoClient.connect</span></tt> sets up a connection pool for each call meaning that if you call <tt class="docutils literal"><span class="pre">MongoClient.connect</span></tt> a lot you might find that you are opening a lot of uneccessary connection to the MongoDB server. Luckily we can avoid this simply. Enter the following code in you text editor.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>    
  <span class="p">}</span>
  
  <span class="kd">var</span> <span class="nx">test2</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">&#39;test2&#39;</span><span class="p">);</span>
  
  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="p">})</span>
</pre></div>
</td></tr></table></div>
<p>Notice the line <tt class="docutils literal"><span class="pre">db.db('test2')</span></tt>. This creates a new Db object where all operations will go against the db <tt class="docutils literal"><span class="pre">test2</span></tt> but will share the underlying connection pool with the first database <tt class="docutils literal"><span class="pre">test</span></tt>. This lets your program get efficient reuse of the connection pool we created using <tt class="docutils literal"><span class="pre">MongoClient.connect</span></tt>.</p>
<p>That's covered <tt class="docutils literal"><span class="pre">MongoClient.connect</span></tt>. Sometime we want better programatic control of our connections to MongoDB. Luckily <tt class="docutils literal"><span class="pre">MongoClient</span></tt> allows for this aswell. Spin up the text editor again and enter the following program.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span>
  <span class="p">,</span> <span class="nx">Server</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">Server</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">mongoclient</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MongoClient</span><span class="p">(</span><span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">27017</span><span class="p">));</span>
<span class="nx">mongoclient</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">mongoclient</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>    
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="nx">mongoclient</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">test2</span> <span class="o">=</span> <span class="nx">mongoclient</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">&#39;test2&#39;</span><span class="p">);</span>

  <span class="nx">mongoclient</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="p">})</span>
</pre></div>
</td></tr></table></div>
<p>Notice the line <tt class="docutils literal"><span class="pre">Server</span> <span class="pre">=</span> <span class="pre">mongodb.Server</span></tt>. It allows us to define the settings for connecting to a server instance. The line <tt class="docutils literal"><span class="pre">new</span> <span class="pre">MongoClient(new</span> <span class="pre">Server('localhost',</span> <span class="pre">27017))</span></tt> creates an instance of <tt class="docutils literal"><span class="pre">MongoClient</span></tt> that is ready to connect to the MongoDB server at localhost on port 27017. The program then calls <tt class="docutils literal"><span class="pre">.open</span></tt> on the <tt class="docutils literal"><span class="pre">MongoClient</span></tt> instance. The main difference from the previous connection example using <tt class="docutils literal"><span class="pre">MongoClient.connect</span></tt> is that the function returns the <tt class="docutils literal"><span class="pre">MongoClient</span></tt> instance instead of a <tt class="docutils literal"><span class="pre">db</span></tt> instance. To get hold of the <tt class="docutils literal"><span class="pre">db</span></tt> instances we have to call the function <tt class="docutils literal"><span class="pre">.db('test')</span></tt> on the <tt class="docutils literal"><span class="pre">MongoClient</span></tt> instance. The code does this twice to retrieve a db instance for the databases <tt class="docutils literal"><span class="pre">test</span></tt> and <tt class="docutils literal"><span class="pre">test2</span></tt> before finally closing the connection to the MongoDB database.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">MongoDB can be configured to run as a cluster or sharded system. In later exercises we will learn how to connect to this configuarations. It's very similar to the current examples but has some slight differences. You can read more about the <tt class="docutils literal"><span class="pre">URI</span></tt> format at <a class="reference external" href="http://docs.mongodb.org/manual/reference/connection-string/">http://docs.mongodb.org/manual/reference/connection-string/</a></p>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="ex5.html" title="Exercise 5: Document documents everywhere"
             >next</a></li>
        <li class="right" >
          <a href="ex3.html" title="Exercise 3: Async programming introduction"
             >previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>
    <a name="comments"><hr/></a>

<div sytle="text-align: left">
    <div style="background: white; padding: 10px" id="disqus_thread"></div>
</div>
    <script type="text/javascript">
        var dow = new Date().getDay();

        if(dow == 5 || dow == 6) {
            $("#disqus_thread").html("<h1>Today Is Christians's Day Off</h1><p>I take Saturday and Sunday off.  Comments open again on Monday-Friday.</p>")
        } else {
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'learn-code-the-hard-way'; // required: replace example with your forum shortname


            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        }
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <div class="footer">
      &copy; Copyright 2012, Christian Amor Kvalheim.
      Last updated on Jan 31, 2013.
</div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24168052-9']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </body>
</html>