<!DOCTYPE html>

<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
    <!--[if gt IE 8]><!-->
<html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />

  <!-- Set the viewport width to device width for mobile -->
  <meta name="viewport" content="width=device-width" />

  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.9.1: http://docutils.sourceforge.net/" />
<title></title>

  <!-- Included CSS Files (Compressed) -->
  <link rel="stylesheet" href="stylesheets/foundation.min.css">
  <link rel="stylesheet" href="stylesheets/pygments.css">
  <link rel="stylesheet" href="stylesheets/app.css">

  <script src="javascripts/modernizr.foundation.js"></script>

  <script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41953057-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

  </script> 

  <!-- IE Fix for HTML5 Tags -->
  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

</head>
<body>

  <div class="row">
          
      </div>
  </div>

  <div class="row">
    <div class="eleven columns">
        <div class="section" id="learn-node-js-and-mongodb-the-hard-way">
<h1><a class="toc-backref" href="#id14">Learn Node.JS and MongoDB The Hard Way</a></h1>
<div class="section" id="table-of-contents">
<h2><a class="toc-backref" href="#id15">Table Of Contents</a></h2>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#learn-node-js-and-mongodb-the-hard-way" id="id14">Learn Node.JS and MongoDB The Hard Way</a><ul>
<li><a class="reference internal" href="#table-of-contents" id="id15">Table Of Contents</a></li>
</ul>
</li>
<li><a class="reference internal" href="#preface" id="id16">Preface</a></li>
<li><a class="reference internal" href="#introduction-introduce-your-language" id="id17">Introduction: Introduce Your Language</a><ul>
<li><a class="reference internal" href="#exercise-0-the-setup" id="id18">Exercise 0: The Setup</a></li>
<li><a class="reference internal" href="#exercise-1-the-package-manager" id="id19">Exercise 1: The package manager</a></li>
<li><a class="reference internal" href="#exercise-2-installing-mongodb" id="id20">Exercise 2: Installing MongoDB</a><ul>
<li><a class="reference internal" href="#mac-osx" id="id21">Mac OSX</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercise-3-async-programming-introduction" id="id22">Exercise 3: Async programming introduction</a><ul>
<li><a class="reference internal" href="#id1" id="id23">Mac OSX</a></li>
<li><a class="reference internal" href="#asynchronous-programming" id="id24">Asynchronous Programming</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercise-4-connecting-to-a-single-mongodb-instance-from-node-js" id="id25">Exercise 4: Connecting to a single MongoDB instance from Node.js</a></li>
<li><a class="reference internal" href="#exercise-5-document-documents-everywhere" id="id26">Exercise 5: Document documents everywhere</a></li>
<li><a class="reference internal" href="#exercise-6-databases-and-collections" id="id27">Exercise 6: Databases and Collections</a><ul>
<li><a class="reference internal" href="#capped-collections" id="id28">Capped Collections</a></li>
<li><a class="reference internal" href="#time-to-live-collections-ttl" id="id29">Time to live collections (TTL)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercise-7-inserting-documents" id="id30">Exercise 7: Inserting documents</a><ul>
<li><a class="reference internal" href="#bulk-inserts" id="id31">Bulk Inserts</a></li>
<li><a class="reference internal" href="#save" id="id32">Save</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercise-8-write-concerns" id="id33">Exercise 8: Write Concerns</a><ul>
<li><a class="reference internal" href="#problems-in-paradise" id="id34">Problems In Paradise</a></li>
<li><a class="reference internal" href="#setting-default-write-concern" id="id35">Setting Default Write Concern</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercise-9-update-basics" id="id36">Exercise 9: Update Basics</a><ul>
<li><a class="reference internal" href="#atomic-operators" id="id37">Atomic Operators</a></li>
<li><a class="reference internal" href="#set-unset-operators" id="id38">$set/$unset Operators</a></li>
<li><a class="reference internal" href="#inc-operator" id="id39">$inc Operator</a></li>
<li><a class="reference internal" href="#bit-operator" id="id40">$bit Operator</a></li>
<li><a class="reference internal" href="#isolated-or-how-i-came-to-love-the-bomb" id="id41">$isolated or how I came to love the bomb</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercise-10-update-basics" id="id42">Exercise 10: Update Basics</a><ul>
<li><a class="reference internal" href="#push-operator" id="id43">$push Operator</a></li>
<li><a class="reference internal" href="#pushall-operator" id="id44">$pushAll Operator</a></li>
<li><a class="reference internal" href="#pull-operator" id="id45">$pull Operator</a></li>
<li><a class="reference internal" href="#pop-operator" id="id46">$pop Operator</a></li>
<li><a class="reference internal" href="#addtoset-operator" id="id47">$addToSet Operator</a></li>
<li><a class="reference internal" href="#updating-a-document-in-an-array" id="id48">Updating a document in an array</a></li>
<li><a class="reference internal" href="#one-push-to-rule-them-all" id="id49">One $push To Rule Them All</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercise-11-final-update" id="id50">Exercise 11: Final Update</a><ul>
<li><a class="reference internal" href="#multi" id="id51">Multi</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercise-12-findandmodify" id="id52">Exercise 12: FindAndModify</a><ul>
<li><a class="reference internal" href="#the-findandmodify-command" id="id53">The findAndModify Command</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercise-13-removing-documents" id="id54">Exercise 13: Removing Documents</a></li>
<li><a class="reference internal" href="#exercise-14-querying-mongodb" id="id55">Exercise 14: Querying MongoDB</a><ul>
<li><a class="reference internal" href="#the-query-language" id="id56">The Query Language</a></li>
<li><a class="reference internal" href="#comparison-operators" id="id57">Comparison operators</a></li>
<li><a class="reference internal" href="#all-contains-all" id="id58"><tt class="docutils literal">$all</tt> (Contains all)</a></li>
<li><a class="reference internal" href="#gt-greater-than" id="id59"><tt class="docutils literal">$gt</tt> (Greater Than)</a></li>
<li><a class="reference internal" href="#gte-greater-than-or-equal" id="id60"><tt class="docutils literal">$gte</tt> (Greater Than or Equal)</a></li>
<li><a class="reference internal" href="#in-contains-one-of" id="id61"><tt class="docutils literal">$in</tt> (Contains One Of)</a></li>
<li><a class="reference internal" href="#lt-less-than" id="id62"><tt class="docutils literal">$lt</tt> (Less Than)</a></li>
<li><a class="reference internal" href="#lte-less-than-or-equal" id="id63"><tt class="docutils literal">$lte</tt> (Less Than or Equal)</a></li>
<li><a class="reference internal" href="#ne-not-equal-to" id="id64"><tt class="docutils literal">$ne</tt> (Not Equal To)</a></li>
<li><a class="reference internal" href="#nin-contains-none-of" id="id65"><tt class="docutils literal">$nin</tt> (Contains None Of)</a></li>
<li><a class="reference internal" href="#logical-operators" id="id66">Logical operators</a></li>
<li><a class="reference internal" href="#and" id="id67"><tt class="docutils literal">$and</tt></a></li>
<li><a class="reference internal" href="#or" id="id68"><tt class="docutils literal">$or</tt></a></li>
<li><a class="reference internal" href="#not" id="id69"><tt class="docutils literal">$not</tt></a></li>
<li><a class="reference internal" href="#nor" id="id70"><tt class="docutils literal">$nor</tt></a></li>
<li><a class="reference internal" href="#element-operators" id="id71">Element operators</a></li>
<li><a class="reference internal" href="#exists" id="id72"><tt class="docutils literal">$exists</tt></a></li>
<li><a class="reference internal" href="#mod" id="id73"><tt class="docutils literal">$mod</tt></a></li>
<li><a class="reference internal" href="#type" id="id74"><tt class="docutils literal">$type</tt></a></li>
<li><a class="reference internal" href="#javascript-operators" id="id75">JavaScript operators</a></li>
<li><a class="reference internal" href="#regexp-regular-expressions" id="id76"><tt class="docutils literal">$regexp</tt> (Regular expressions)</a></li>
<li><a class="reference internal" href="#where" id="id77"><tt class="docutils literal">$where</tt></a></li>
<li><a class="reference internal" href="#array-operators" id="id78">Array Operators</a></li>
<li><a class="reference internal" href="#size" id="id79"><tt class="docutils literal">$size</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercise-15-index-this" id="id80">Exercise 15: Index This</a><ul>
<li><a class="reference internal" href="#index-magic" id="id81">Index Magic</a></li>
<li><a class="reference internal" href="#compound-indexes" id="id82">Compound indexes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercise-16-basic-indexes-in-mongodb" id="id83">Exercise 16: Basic Indexes in MongoDB</a></li>
<li><a class="reference internal" href="#exercise-17-index-katas" id="id84">Exercise 17: Index Katas</a><ul>
<li><a class="reference internal" href="#single-value-index" id="id85">Single Value Index</a></li>
<li><a class="reference internal" href="#single-value-index-with-sorting" id="id86">Single Value Index With Sorting</a></li>
<li><a class="reference internal" href="#compound-that-index" id="id87">Compound That Index</a></li>
<li><a class="reference internal" href="#i-ve-got-you-covered" id="id88">I've Got You Covered</a></li>
<li><a class="reference internal" href="#sparse-indexes" id="id89">Sparse Indexes</a></li>
<li><a class="reference internal" href="#i-m-an-unique-flower" id="id90">I'm An Unique Flower</a></li>
<li><a class="reference internal" href="#indexing-arrays-and-sub-documents" id="id91">Indexing Arrays and Sub Documents</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercise-18-the-importance-of-schema-design" id="id92">Exercise 18: The Importance of Schema Design</a><ul>
<li><a class="reference internal" href="#facts" id="id93">Facts</a><ul>
<li><a class="reference internal" href="#book-facts" id="id94">Book Facts</a></li>
<li><a class="reference internal" href="#author-facts" id="id95">Author Facts</a></li>
<li><a class="reference internal" href="#publisher-facts" id="id96">Publisher Facts</a></li>
</ul>
</li>
<li><a class="reference internal" href="#entity-relational-modeling" id="id97">Entity Relational Modeling</a><ul>
<li><a class="reference internal" href="#book-table" id="id98">Book Table</a></li>
<li><a class="reference internal" href="#publisher-table" id="id99">Publisher Table</a></li>
<li><a class="reference internal" href="#author-table" id="id100">Author Table</a></li>
<li><a class="reference internal" href="#authorbook-table" id="id101">AuthorBook Table</a></li>
</ul>
</li>
<li><a class="reference internal" href="#document-modeling" id="id102">Document Modeling</a><ul>
<li><a class="reference internal" href="#book" id="id103">Book</a></li>
<li><a class="reference internal" href="#author" id="id104">Author</a></li>
<li><a class="reference internal" href="#publisher" id="id105">Publisher</a></li>
</ul>
</li>
<li><a class="reference internal" href="#things-to-note" id="id106">Things To Note</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercise-19-evolving-a-simple-schema" id="id107">Exercise 19: Evolving A Simple Schema</a><ul>
<li><a class="reference internal" href="#id2" id="id108">Facts</a><ul>
<li><a class="reference internal" href="#id3" id="id109">Book</a></li>
<li><a class="reference internal" href="#edition" id="id110">Edition</a></li>
<li><a class="reference internal" href="#id4" id="id111">Author</a></li>
<li><a class="reference internal" href="#id5" id="id112">Publisher</a></li>
<li><a class="reference internal" href="#user" id="id113">User</a></li>
</ul>
</li>
<li><a class="reference internal" href="#document-representation" id="id114">Document Representation</a><ul>
<li><a class="reference internal" href="#user-document" id="id115">User Document</a></li>
<li><a class="reference internal" href="#author-document" id="id116">Author Document</a></li>
<li><a class="reference internal" href="#publisher-document" id="id117">Publisher Document</a></li>
<li><a class="reference internal" href="#book-document" id="id118">Book Document</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#exercise-20-a-restful-programming-exercise" id="id119">Exercise 20: A RESTFul Programming exercise</a><ul>
<li><a class="reference internal" href="#it-s-alive" id="id120">It's alive</a></li>
<li><a class="reference internal" href="#we-ve-got-power" id="id121">We've got power</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercise-21-let-s-loan-out-some-books" id="id122">Exercise 21: Let's Loan Out Some Books</a></li>
<li><a class="reference internal" href="#exercise-22-mongodb-topologies" id="id123">Exercise 22: MongoDB Topologies</a><ul>
<li><a class="reference internal" href="#the-single-server" id="id124">The Single Server</a></li>
<li><a class="reference internal" href="#the-replicaset" id="id125">The Replicaset</a><ul>
<li><a class="reference internal" href="#top-level-fields" id="id126">Top Level Fields</a></li>
<li><a class="reference internal" href="#member-fields" id="id127">Member Fields</a></li>
<li><a class="reference internal" href="#settings-fields" id="id128">Settings Fields</a></li>
</ul>
</li>
<li><a class="reference internal" href="#read-preferences" id="id129">Read Preferences</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tic-tac-toe-exercise-1" id="id130">Tic-Tac-Toe: Exercise 1</a><ul>
<li><a class="reference internal" href="#where-is-the-code" id="id131">Where Is The Code</a></li>
<li><a class="reference internal" href="#architecture" id="id132">Architecture</a></li>
<li><a class="reference internal" href="#mac-osx-and-linux" id="id133">Mac OSX and Linux</a></li>
<li><a class="reference internal" href="#app-js" id="id134">App.js</a></li>
<li><a class="reference internal" href="#env-js" id="id135">Env.js</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tic-tac-toe-exercise-2" id="id136">Tic-Tac-Toe: Exercise 2</a><ul>
<li><a class="reference internal" href="#id8" id="id137">Where Is The Code</a></li>
<li><a class="reference internal" href="#it-s-like-lego-but-with-code" id="id138">It's Like LEGO But With Code</a></li>
<li><a class="reference internal" href="#modeling-that-data" id="id139">Modeling That Data</a></li>
<li><a class="reference internal" href="#handlers-for-the-win" id="id140">Handlers For The Win</a></li>
<li><a class="reference internal" href="#the-register-handler-function" id="id141">The register_handler Function</a></li>
<li><a class="reference internal" href="#fronting-it" id="id142">Fronting It</a></li>
<li><a class="reference internal" href="#wiring-up-the-code" id="id143">Wiring Up The Code</a></li>
<li><a class="reference internal" href="#notes" id="id144">Notes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tic-tac-toe-exercise-3" id="id145">Tic-Tac-Toe: Exercise 3</a><ul>
<li><a class="reference internal" href="#id11" id="id146">Where Is The Code</a></li>
<li><a class="reference internal" href="#the-glue-of-it-all" id="id147">The Glue Of It All</a></li>
<li><a class="reference internal" href="#the-game-model" id="id148">The Game Model</a></li>
<li><a class="reference internal" href="#the-game-handler" id="id149">The Game Handler</a></li>
<li><a class="reference internal" href="#the-find-all-available-gamers-handler" id="id150">The find_all_available_gamers Handler</a></li>
<li><a class="reference internal" href="#the-invite-gamer-handler" id="id151">The invite_gamer Handler</a></li>
<li><a class="reference internal" href="#the-decline-game-handler" id="id152">The decline_game Handler</a></li>
<li><a class="reference internal" href="#the-accept-game-handler" id="id153">The accept_game Handler</a></li>
<li><a class="reference internal" href="#the-place-marker-handler" id="id154">The place_marker Handler</a></li>
<li><a class="reference internal" href="#the-front-end" id="id155">The Front End</a></li>
<li><a class="reference internal" href="#the-gamer-joined-event-handler" id="id156">The gamer_joined Event Handler</a></li>
<li><a class="reference internal" href="#the-game-move-event-handler" id="id157">The game_move Event Handler</a></li>
<li><a class="reference internal" href="#the-game-invite-event-handler" id="id158">The game_invite Event Handler</a></li>
<li><a class="reference internal" href="#the-register-button-handler-handler" id="id159">The register_button_handler Handler</a></li>
<li><a class="reference internal" href="#the-login-button-handler-handler" id="id160">The login_button_handler Handler</a></li>
<li><a class="reference internal" href="#the-invite-gamer-button-handler-handler" id="id161">The invite_gamer_button_handler Handler</a></li>
<li><a class="reference internal" href="#the-invite-accept-button-handler-handler" id="id162">The invite_accept_button_handler Handler</a></li>
<li><a class="reference internal" href="#the-invite-decline-button-handler-handler" id="id163">The invite_decline_button_handler Handler</a></li>
<li><a class="reference internal" href="#the-setupboardgame-function" id="id164">The setupBoardGame Function</a></li>
<li><a class="reference internal" href="#the-game-board-cell-handler-function" id="id165">The game_board_cell_handler Function</a></li>
<li><a class="reference internal" href="#the-general-box-show-function" id="id166">The general_box_show Function</a></li>
<li><a class="reference internal" href="#the-decline-box-show-function" id="id167">The decline_box_show Function</a></li>
<li><a class="reference internal" href="#the-game-invite-box-show-function" id="id168">The game_invite_box_show Function</a></li>
<li><a class="reference internal" href="#styling-that-game" id="id169">Styling That Game</a></li>
<li><a class="reference internal" href="#wrapping-up" id="id170">Wrapping Up</a></li>
<li><a class="reference internal" href="#id12" id="id171">Notes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tic-tac-toe-exercise-4" id="id172">Tic-Tac-Toe: Exercise 4</a><ul>
<li><a class="reference internal" href="#id13" id="id173">Where Is The Code</a></li>
<li><a class="reference internal" href="#chatting-it-up" id="id174">Chatting It Up</a></li>
<li><a class="reference internal" href="#front-end" id="id175">Front End</a></li>
<li><a class="reference internal" href="#reddit-is-more-interesting-i-m-out-of-here" id="id176">Reddit Is More Interesting I'm Out Of Here</a></li>
<li><a class="reference internal" href="#frontend-handling" id="id177">Frontend Handling</a></li>
<li><a class="reference internal" href="#we-did-it" id="id178">We Did It</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#next-steps" id="id179">Next Steps</a></li>
</ul>
</div>
</div>
</div>
<div class="section" id="preface">
<h1><a class="toc-backref" href="#id16">Preface</a></h1>
</div>
<div class="section" id="introduction-introduce-your-language">
<h1><a class="toc-backref" href="#id17">Introduction: Introduce Your Language</a></h1>
<div class="section" id="exercise-0-the-setup">
<h2><a class="toc-backref" href="#id18">Exercise 0: The Setup</a></h2>
</div>
<div class="section" id="exercise-1-the-package-manager">
<h2><a class="toc-backref" href="#id19">Exercise 1: The package manager</a></h2>
<p>Node.js has and outstanding amount of libraries available for usage
allowing you to reuse a massive collection of code written by other
programmers for your application. This tool is called the <tt class="docutils literal">Node Package Manager</tt>
or <tt class="docutils literal">NPM</tt> for short. In this exercise we will learn the basics of using
<tt class="docutils literal">NPM</tt> to install some packages.</p>
<ol class="arabic">
<li><p class="first">Open the <tt class="docutils literal">Terminal</tt> application and type</p>
<pre class="code console literal-block">
<span class="go">~ $ npm search mongodb
mongodb           A node.js driver for MongoDB               =christkv 2012-12-03 17:
mongodb-async     Thin &amp; clean async wrapper for mongodb     =zir 2012-10-26 17:
mongodb-errors    Helper classes to deal with mongodb errors =mwawrusch 2012-11-25 03:</span>
</pre>
<p>The <tt class="docutils literal">npm search text</tt> command lets you search for available modules that you can use</p>
</li>
<li><p class="first">Go to the directory <tt class="docutils literal"><span class="pre">learn-exercises</span></tt> we created in <tt class="docutils literal">exercise 0</tt>.</p>
</li>
<li><p class="first">Let's install some packages that we will use in the exercises.</p>
<pre class="code console literal-block">
<span class="go">~ $ npm install mongodb
npm http GET https://registry.npmjs.org/mongodb
npm http 304 https://registry.npmjs.org/mongodb
npm http GET https://registry.npmjs.org/bson/0.1.5
npm http 304 https://registry.npmjs.org/bson/0.1.5

</span><span class="gp">&gt;</span> bson&#64;0.1.5 install /Users/ck/coding/projects/learnexercises
<span class="go">/node_modules/mongodb/node_modules/bson
</span><span class="gp">&gt;</span> node install.js <span class="o">||</span> <span class="o">(</span><span class="nb">exit </span>0<span class="o">)</span>
<span class="go">
================================================================================
=                                                                              =
=  Attempting to build bson c++ extension                                      =
=   Windows: no build will be attempted as binaries are prepackaged            =
=   Unix: on failure the package will still install without the C++ extension  =
=                                                                              =
================================================================================
node-gyp clean
node-gyp configure build
  CXX(target) Release/obj.target/bson/ext/bson.o
  SOLINK_MODULE(target) Release/bson.node
  SOLINK_MODULE(target) Release/bson.node: Finished
child process exited with code 0
mongodb&#64;1.2.2 node_modules/mongodb
└── bson&#64;0.1.5</span>
</pre>
<p>You should see something like the text above, if it's slightly different don't worry.</p>
</li>
<li><p class="first"><tt class="docutils literal">NPM</tt> is has a lot of options for handling <tt class="docutils literal">packages</tt> you can use <tt class="docutils literal">npm help</tt> to
read more about all options available. Also have a look at <a class="reference external" href="https://npmjs.org/">https://npmjs.org/</a> for a
great web interface to search for available packages.</p>
</li>
<li><p class="first">Notice that there is a new directory under <tt class="docutils literal"><span class="pre">learn-exercises</span></tt> called <tt class="docutils literal">node_modules</tt>
this directory contains all the npm packages we install.</p>
</li>
</ol>
</div>
<div class="section" id="exercise-2-installing-mongodb">
<h2><a class="toc-backref" href="#id20">Exercise 2: Installing MongoDB</a></h2>
<p>This book is all about using <tt class="docutils literal">Node.js</tt> with <tt class="docutils literal">MongoDB</tt> so naturally
we need to install <tt class="docutils literal">MongoDB</tt>. With no further ado let's get to it.</p>
<div class="section" id="mac-osx">
<h3><a class="toc-backref" href="#id21">Mac OSX</a></h3>
<p>This exercise is made up by the following tasks that we need to complete
to finish this exercise.</p>
<ol class="arabic">
<li><p class="first">Go to the <tt class="docutils literal">MongoDB</tt> website at <a class="reference external" href="http://www.mongodb.org/downloads">http://www.mongodb.org/downloads</a></p>
</li>
<li><p class="first">Locate the latest <tt class="docutils literal">MongoDB</tt> production release for <tt class="docutils literal">OS X 64 bit</tt></p>
</li>
<li><p class="first">Copy the link address to the latest release in the browser (right click
on the link).</p>
</li>
<li><p class="first">Open <tt class="docutils literal">Terminal</tt> application</p>
</li>
<li><p class="first">Go to the directory <tt class="docutils literal"><span class="pre">learn-exercises</span></tt> we created in <tt class="docutils literal">exercise 0</tt>.</p>
</li>
<li><p class="first">Write the following, where <tt class="docutils literal">link</tt> is the pasted link from the browser
Following the download do an <tt class="docutils literal">`ls <span class="pre">-la</span></tt> to see the file you downloaded.</p>
<p>The example below is with 2.2.2 of mongodb</p>
<pre class="code console literal-block">
<span class="go">~ $ curl -O link
</span><span class="gp">%</span> Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
<span class="go">                                 Dload  Upload   Total   Spent    Left  Speed
100 56.6M  100 56.6M    0     0   353k      0  0:02:44  0:02:44 --:--:--  277k
~ $ ls -la
total 115928
drwxr-xr-x   4 ck  staff       136 Dec  4 13:20 .
drwxr-xr-x  25 ck  staff       850 Dec  4 12:56 ..
-rw-r--r--   1 ck  staff  59352946 Dec  4 13:23 mongodb-osx-x86_64-2.2.2.tgz
drwxr-xr-x   3 ck  staff       102 Dec  4 12:57 node_modules</span>
</pre>
</li>
<li><p class="first">Unpack the mongodb server in the local directory</p>
<pre class="code console literal-block">
<span class="go">~ $ tar xvfz mongodb-osx-x86_64-2.2.2.tgz
x mongodb-osx-x86_64-2.2.2/GNU-AGPL-3.0
x mongodb-osx-x86_64-2.2.2/README
x mongodb-osx-x86_64-2.2.2/THIRD-PARTY-NOTICES
x mongodb-osx-x86_64-2.2.2/bin/mongodump
x mongodb-osx-x86_64-2.2.2/bin/mongorestore
x mongodb-osx-x86_64-2.2.2/bin/mongoexport
x mongodb-osx-x86_64-2.2.2/bin/mongoimport
x mongodb-osx-x86_64-2.2.2/bin/mongostat
x mongodb-osx-x86_64-2.2.2/bin/mongotop
x mongodb-osx-x86_64-2.2.2/bin/mongooplog
x mongodb-osx-x86_64-2.2.2/bin/mongofiles
x mongodb-osx-x86_64-2.2.2/bin/bsondump
x mongodb-osx-x86_64-2.2.2/bin/mongoperf
x mongodb-osx-x86_64-2.2.2/bin/mongosniff
x mongodb-osx-x86_64-2.2.2/bin/mongod
x mongodb-osx-x86_64-2.2.2/bin/mongos
x mongodb-osx-x86_64-2.2.2/bin/mongo</span>
</pre>
<p>We are going to create a file called <tt class="docutils literal"><span class="pre">start-mongodb.sh</span></tt> that we will
use to start the server.</p>
</li>
<li><p class="first">Open <tt class="docutils literal">TextWrangler</tt> and a new document. Enter the following code but
change the directory reference to the one matching your mongodb version.</p>
<p>In this case it's <tt class="docutils literal"><span class="pre">mongodb-osx-x86_64-2.2.2</span></tt></p>
<p>Enter the following code.</p>
<pre class="code bash literal-block">
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>./mongodb-osx-x86_64-2.2.2/bin:<span class="nv">$PATH</span>
</pre>
<p>Save the file to the <tt class="docutils literal"><span class="pre">learn-exercises</span></tt> directory as <tt class="docutils literal">setup.sh</tt></p>
</li>
<li><p class="first">Change the permission of the file so it can be executed</p>
<pre class="code console literal-block">
<span class="go">~ $ chmod 775 ./setup.sh</span>
</pre>
</li>
<li><p class="first">Execute the <tt class="docutils literal">setup.sh</tt> script in our local context to set the
environmental settings.</p>
<pre class="code console literal-block">
<span class="go">~ $ . ./setup.sh</span>
</pre>
<p>Notice the <tt class="docutils literal">.</tt> before the file, this runs the script in the current
shell context allowing us to modify the current PATH.</p>
</li>
<li><p class="first">Let's create a directory to store our database and start up <tt class="docutils literal">MongoDB</tt></p>
<pre class="code console literal-block">
<span class="go">~ $ mkdir data
~ $ mongod --dbpath=./data
Tue Dec  4 14:33:17 [initandlisten] MongoDB starting : pid=79402 port=27017
dbpath=./data/ 64-bit host=ChristianK-MacBook-Pro.local
Tue Dec  4 14:33:17 [initandlisten]
Tue Dec  4 14:33:17 [initandlisten] ** WARNING: soft rlimits too low. Number of
files is 256, should be at least 1000
Tue Dec  4 14:33:17 [initandlisten] db version v2.2.2, pdfile version 4.5
Tue Dec  4 14:33:17 [initandlisten] git version:
d1b43b61a5308c4ad0679d34b262c5af9d664267
Tue Dec  4 14:33:17 [initandlisten] build info: Darwin bs-osx-106-x86-64-1.local
10.8.0 Darwin Kernel Version 10.8.0: Tue Jun  7 16:33:36 PDT 2011;
root:xnu-1504.15.3~1/RELEASE_I386 i386 BOOST_LIB_VERSION=1_49
Tue Dec  4 14:33:17 [initandlisten] options: { dbpath: &quot;./data/&quot; }
Tue Dec  4 14:33:17 [initandlisten] journal dir=./data/journal
Tue Dec  4 14:33:17 [initandlisten] recover : no journal files present,
no recovery needed
Tue Dec  4 14:33:17 [websvr] admin web console waiting for connections on port 28017
Tue Dec  4 14:33:17 [initandlisten] waiting for connections on port 27017</span>
</pre>
</li>
<li><p class="first">Open a new terminal shell window, ensure you are in the directory <tt class="docutils literal"><span class="pre">learn-exercises</span></tt>
and do.</p>
<pre class="code console literal-block">
<span class="go">~ $ . ./setup.sh</span>
</pre>
</li>
<li><p class="first">Let's connect to the <tt class="docutils literal">MongoDB</tt> instance using the <tt class="docutils literal">Mongo</tt> shell and execute
a couple of commands.</p>
<pre class="code console literal-block">
<span class="go">~ $ mongos
MongoDB shell version: 2.2.2
connecting to: test
</span><span class="gp">&gt;</span> show dbs
<span class="go">local (empty)
</span><span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test
</span><span class="gp">&gt;</span> db.test.insert<span class="o">({</span>a:1<span class="o">})</span>
<span class="gp">&gt;</span> db.test.find<span class="o">()</span>.pretty<span class="o">()</span>
<span class="go">{ &quot;_id&quot; : ObjectId(&quot;50bdfd7d9806fc973570b5b2&quot;), &quot;a&quot; : 1 }
</span><span class="gp">&gt;</span> <span class="nb">exit</span>
<span class="go">bye</span>
</pre>
</li>
</ol>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">For the rest of our exercises we are going to assume that you have mongod running on your development machine running on <tt class="docutils literal">localhost</tt> and port <tt class="docutils literal">27017</tt> which are the default. All the code in the rest of the examples that use <tt class="docutils literal">MongoDB</tt> will assume this unless otherwise stated.</p>
</div>
</div>
</div>
<div class="section" id="exercise-3-async-programming-introduction">
<h2><a class="toc-backref" href="#id22">Exercise 3: Async programming introduction</a></h2>
<p>There are several pitfalls that are worth understanding before we get started
exploring the driver and <tt class="docutils literal">MongoDB</tt> in general. This have to do with the
essential differences between synchronous and asynchronous programming. It's
best served by some examples. For the rest of the exercises we will assume that
you understand how to enter code using the editor for your system.</p>
<p>Lets take a simple application that fetches a twitter feed a couple of thousand
times. But before we start let's install another <tt class="docutils literal">npm package</tt> that simplifies
the fetching of web pages. This module is called <tt class="docutils literal">request</tt>. Perform the following
tasks to install it and then lets get one with some coding.</p>
<div class="section" id="id1">
<h3><a class="toc-backref" href="#id23">Mac OSX</a></h3>
<ol class="arabic">
<li><p class="first">Start up the <tt class="docutils literal">Terminal</tt> application.</p>
</li>
<li><p class="first">Go to the directory <tt class="docutils literal"><span class="pre">learn-exercises</span></tt> we created in <tt class="docutils literal">exercise 0</tt>.</p>
</li>
<li><p class="first">Install the <tt class="docutils literal">request</tt> package using <tt class="docutils literal">NPM</tt></p>
<pre class="code console literal-block">
<span class="go">~ $ npm install request
npm http GET https://registry.npmjs.org/request
npm http 200 https://registry.npmjs.org/request
npm http GET https://registry.npmjs.org/request/-/request-2.12.0.tgz
npm http 200 https://registry.npmjs.org/request/-/request-2.12.0.tgz
request&#64;2.12.0 node_modules/request</span>
</pre>
</li>
<li><p class="first">Bring up <tt class="docutils literal">TextWrangler</tt> and enter the script below</p>
<div class="highlight"><pre><a name="code--ex3--ex1.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">);</span>
<a name="code--ex3--ex1.js-pyg.html-2"></a>
<a name="code--ex3--ex1.js-pyg.html-3"></a><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex3--ex1.js-pyg.html-4"></a>  <span class="nx">request</span><span class="p">(</span><span class="s1">&#39;http://www.google.com&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex3--ex1.js-pyg.html-5"></a>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex3--ex1.js-pyg.html-6"></a>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Retrieved the web page&quot;</span><span class="p">);</span>
<a name="code--ex3--ex1.js-pyg.html-7"></a>    <span class="p">}</span>
<a name="code--ex3--ex1.js-pyg.html-8"></a>  <span class="p">});</span>
<a name="code--ex3--ex1.js-pyg.html-9"></a><span class="p">}</span>
<a name="code--ex3--ex1.js-pyg.html-10"></a>
<a name="code--ex3--ex1.js-pyg.html-11"></a><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;DONE&quot;</span><span class="p">);</span>
</pre></div><p>Save it as the file <tt class="docutils literal">ex1.js</tt> in the directory <tt class="docutils literal"><span class="pre">learn-exercises</span></tt></p>
</li>
<li><p class="first">From the terminal execute the script <tt class="docutils literal">ex1.js</tt></p>
<pre class="code console literal-block">
<span class="go">~ $ node ex1.js
DONE
Retrieved the web page
Retrieved the web page
Retrieved the web page
Retrieved the web page
Retrieved the web page
Retrieved the web page
Retrieved the web page
Retrieved the web page
(node) warning: possible EventEmitter memory leak detected. 11 listeners added.
Use emitter.setMaxListeners() to increase limit.
Trace
    at Socket.EventEmitter.addListener (events.js:175:15)
    at Socket.EventEmitter.once (events.js:196:8)
    at ClientRequest.&lt;anonymous&gt;
    (/Users/ck/coding/projects/learnexercises/node_modules/request/main.js:521:27)
    at ClientRequest.g (events.js:192:14)
    at ClientRequest.EventEmitter.emit (events.js:96:17)
    at HTTPParser.parserOnIncomingClient [as onIncoming] (http.js:1462:7)
    at HTTPParser.parserOnHeadersComplete [as onHeadersComplete] (http.js:111:23)
    at Socket.socketOnData [as ondata] (http.js:1367:20)
    at TCP.onread (net.js:403:27)
(node) warning: possible EventEmitter memory leak detected. 11 listeners added.
Use emitter.setMaxListeners() to increase limit.

Looking at the output from our little program notice that the first line ``DONE``
was the last line in our program. This shows one of the main pitfals most developers
fall into when they start using ``Node.js`` and merits a more profound explanation
and then an example on how to avoid this.</span>
</pre>
</li>
</ol>
</div>
<div class="section" id="asynchronous-programming">
<h3><a class="toc-backref" href="#id24">Asynchronous Programming</a></h3>
<p>The traditional way a programming language works is by stopping when we do an operation that requires the program to talk to things like your hard disk or a server on a network until they answer. If you wrote the example above in <tt class="docutils literal">ruby</tt> or <tt class="docutils literal">python</tt> it would process each fetch one after the other and once it had finished it would print <tt class="docutils literal">DONE</tt>.</p>
<p>But in <tt class="docutils literal">Node.JS</tt> any operation that wants to communicate with a hard disk or server
returns at once and the results are then returned to the program in an callback. So
when the program runs all the requests to fetch the google homepage starts at the same
time and as each is finished the function containing the <tt class="docutils literal">console.log</tt> statement is
triggered. Since they all get started at the same time <tt class="docutils literal">Node.js</tt> complains that we
might have a memory leak. If we start enough of these requests it will schedule retrivals
of the google homepage until our program runs out of memory and crashes.</p>
<p>But this can be easily fixed. Let's enter it. Write the code and save it as <tt class="docutils literal">ex2.js</tt></p>
<div class="highlight"><pre><a name="code--ex3--ex2.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">);</span>
<a name="code--ex3--ex2.js-pyg.html-2"></a>
<a name="code--ex3--ex2.js-pyg.html-3"></a><span class="kd">var</span> <span class="nx">load10AtATime</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex3--ex2.js-pyg.html-4"></a>  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<a name="code--ex3--ex2.js-pyg.html-5"></a>
<a name="code--ex3--ex2.js-pyg.html-6"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex3--ex2.js-pyg.html-7"></a>    <span class="nx">request</span><span class="p">(</span><span class="s1">&#39;http://www.google.com&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex3--ex2.js-pyg.html-8"></a>      <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="code--ex3--ex2.js-pyg.html-9"></a>
<a name="code--ex3--ex2.js-pyg.html-10"></a>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex3--ex2.js-pyg.html-11"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Retrieved the web page&quot;</span><span class="p">);</span>
<a name="code--ex3--ex2.js-pyg.html-12"></a>      <span class="p">}</span>
<a name="code--ex3--ex2.js-pyg.html-13"></a>
<a name="code--ex3--ex2.js-pyg.html-14"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">callback</span><span class="p">();</span>
<a name="code--ex3--ex2.js-pyg.html-15"></a>    <span class="p">});</span>
<a name="code--ex3--ex2.js-pyg.html-16"></a>  <span class="p">}</span>
<a name="code--ex3--ex2.js-pyg.html-17"></a><span class="p">}</span>
<a name="code--ex3--ex2.js-pyg.html-18"></a>
<a name="code--ex3--ex2.js-pyg.html-19"></a><span class="kd">var</span> <span class="nx">loadBatches</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">numberOfBatches</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex3--ex2.js-pyg.html-20"></a>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;= Loading batch :: &quot;</span> <span class="o">+</span> <span class="nx">numberOfBatches</span><span class="p">);</span>
<a name="code--ex3--ex2.js-pyg.html-21"></a>
<a name="code--ex3--ex2.js-pyg.html-22"></a>  <span class="nx">load10AtATime</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex3--ex2.js-pyg.html-23"></a>    <span class="nx">numberOfBatches</span> <span class="o">=</span> <span class="nx">numberOfBatches</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="code--ex3--ex2.js-pyg.html-24"></a>
<a name="code--ex3--ex2.js-pyg.html-25"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">numberOfBatches</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">();</span>
<a name="code--ex3--ex2.js-pyg.html-26"></a>    <span class="nx">loadBatches</span><span class="p">(</span><span class="nx">numberOfBatches</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--ex3--ex2.js-pyg.html-27"></a>  <span class="p">})</span>
<a name="code--ex3--ex2.js-pyg.html-28"></a><span class="p">}</span>
<a name="code--ex3--ex2.js-pyg.html-29"></a>
<a name="code--ex3--ex2.js-pyg.html-30"></a><span class="nx">loadBatches</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex3--ex2.js-pyg.html-31"></a>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;DONE&quot;</span><span class="p">);</span>
<a name="code--ex3--ex2.js-pyg.html-32"></a><span class="p">})</span>
</pre></div><p>Did I say easily. Hmm maybe not easily. Let's do a review of the code and look at what it
means. The function <tt class="docutils literal">load10AtATime</tt> has a <tt class="docutils literal">callback</tt> function. This function will only be
called once the 10 requests have completed. To ensure that all the requests have completed
we have a count down variable called <tt class="docutils literal">counter</tt> that is only decremented once the result
is returned from the request. Once <tt class="docutils literal">counter</tt> reaches <tt class="docutils literal">0</tt> we call the function <tt class="docutils literal">callback</tt>
signaling that we have finished fetching the 10 copies of the google homepage. This function
thus takes care of loading 10 pages at a time in parallel.</p>
<p>Calling <tt class="docutils literal">load10AtATime</tt> is the function <tt class="docutils literal">loadBatches</tt>. This function is a recursive function that calls itself 10 times until <tt class="docutils literal">numberOfBatches</tt> is 0 and for each time it calls the <tt class="docutils literal">load10AtATime</tt> function and waits for it to return before executing the next batch. Once <tt class="docutils literal">numberOfBatches</tt> reaches <tt class="docutils literal">0</tt> it calls the callback function to return to the original caller.</p>
<p>Finally the last part of the code just starts the batch loading by calling it <tt class="docutils literal">loadBatches` with a start value of ``10</tt> and waits for it to finish before printing it out to the console.</p>
<p>One problem with this code is that if the number of batches is to high you can run out of stack meaning the application will crash. A better way to handle this recurssion is to use a method called <tt class="docutils literal">process.nextTick</tt>. Below is an example of the code will look when using <tt class="docutils literal">process.nextTick</tt>.</p>
<div class="highlight"><pre><a name="code--ex3--ex3.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">);</span>
<a name="code--ex3--ex3.js-pyg.html-2"></a>
<a name="code--ex3--ex3.js-pyg.html-3"></a><span class="kd">var</span> <span class="nx">load10AtATime</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex3--ex3.js-pyg.html-4"></a>  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<a name="code--ex3--ex3.js-pyg.html-5"></a>
<a name="code--ex3--ex3.js-pyg.html-6"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex3--ex3.js-pyg.html-7"></a>    <span class="nx">request</span><span class="p">(</span><span class="s1">&#39;http://www.google.com&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex3--ex3.js-pyg.html-8"></a>      <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="code--ex3--ex3.js-pyg.html-9"></a>
<a name="code--ex3--ex3.js-pyg.html-10"></a>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex3--ex3.js-pyg.html-11"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Retrieved the web page&quot;</span><span class="p">);</span>
<a name="code--ex3--ex3.js-pyg.html-12"></a>      <span class="p">}</span>
<a name="code--ex3--ex3.js-pyg.html-13"></a>
<a name="code--ex3--ex3.js-pyg.html-14"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">callback</span><span class="p">();</span>
<a name="code--ex3--ex3.js-pyg.html-15"></a>    <span class="p">});</span>
<a name="code--ex3--ex3.js-pyg.html-16"></a>  <span class="p">}</span>
<a name="code--ex3--ex3.js-pyg.html-17"></a><span class="p">}</span>
<a name="code--ex3--ex3.js-pyg.html-18"></a>
<a name="code--ex3--ex3.js-pyg.html-19"></a><span class="kd">var</span> <span class="nx">loadBatches</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">numberOfBatches</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex3--ex3.js-pyg.html-20"></a>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;= Loading batch :: &quot;</span> <span class="o">+</span> <span class="nx">numberOfBatches</span><span class="p">);</span>
<a name="code--ex3--ex3.js-pyg.html-21"></a>
<a name="code--ex3--ex3.js-pyg.html-22"></a>  <span class="nx">load10AtATime</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex3--ex3.js-pyg.html-23"></a>    <span class="nx">numberOfBatches</span> <span class="o">=</span> <span class="nx">numberOfBatches</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="code--ex3--ex3.js-pyg.html-24"></a>
<a name="code--ex3--ex3.js-pyg.html-25"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">numberOfBatches</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">();</span>
<a name="code--ex3--ex3.js-pyg.html-26"></a>    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex3--ex3.js-pyg.html-27"></a>      <span class="nx">loadBatches</span><span class="p">(</span><span class="nx">numberOfBatches</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--ex3--ex3.js-pyg.html-28"></a>    <span class="p">})</span>
<a name="code--ex3--ex3.js-pyg.html-29"></a>  <span class="p">})</span>
<a name="code--ex3--ex3.js-pyg.html-30"></a><span class="p">}</span>
<a name="code--ex3--ex3.js-pyg.html-31"></a>
<a name="code--ex3--ex3.js-pyg.html-32"></a><span class="nx">loadBatches</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex3--ex3.js-pyg.html-33"></a>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;DONE&quot;</span><span class="p">);</span>
<a name="code--ex3--ex3.js-pyg.html-34"></a><span class="p">})</span>
</pre></div><p><tt class="docutils literal">process.nextTick</tt> schedules the function call for the next tick in the eventloop of Node.js. This happens with a new stack allowing us to avoid running out of stack and crashing if we have are loading to many batches in one go. There is another technique called a <tt class="docutils literal">trampolining</tt> that can do the same but this is left to you to investigate. The main issue is the lack of tail recurrsion. You can read more about it at <a class="reference external" href="http://en.wikipedia">http://en.wikipedia</a> org/wiki/Tail_call including <tt class="docutils literal">trampolining</tt>. That said I prefer to use <tt class="docutils literal">process.nextTick</tt> because it schedules the function call in the eventloop of Node.js letting other code run inbetween.</p>
<p>I also recommend using some of the excellent libraries for asynchronous programming for Node.js. Let's see how we can accomplish the same using the <tt class="docutils literal">async</tt> npm module. First install the npm module doing</p>
<pre class="code console literal-block">
<span class="go">npm install async</span>
</pre>
<p>Then fire up the text editor of your choice and enter the following example.</p>
<div class="highlight"><pre><a name="code--ex3--ex4.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">async</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;async&#39;</span><span class="p">)</span>
<a name="code--ex3--ex4.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">);</span>
<a name="code--ex3--ex4.js-pyg.html-3"></a>
<a name="code--ex3--ex4.js-pyg.html-4"></a><span class="kd">var</span> <span class="nx">numberOfBatches</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<a name="code--ex3--ex4.js-pyg.html-5"></a>
<a name="code--ex3--ex4.js-pyg.html-6"></a><span class="nx">async</span><span class="p">.</span><span class="nx">whilst</span><span class="p">(</span>
<a name="code--ex3--ex4.js-pyg.html-7"></a>    <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">numberOfBatches</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<a name="code--ex3--ex4.js-pyg.html-8"></a>  <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex3--ex4.js-pyg.html-9"></a>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;= Loading batch :: &quot;</span> <span class="o">+</span> <span class="nx">numberOfBatches</span><span class="p">);</span>
<a name="code--ex3--ex4.js-pyg.html-10"></a>      <span class="nx">numberOfBatches</span> <span class="o">=</span> <span class="nx">numberOfBatches</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="code--ex3--ex4.js-pyg.html-11"></a>
<a name="code--ex3--ex4.js-pyg.html-12"></a>      <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<a name="code--ex3--ex4.js-pyg.html-13"></a>
<a name="code--ex3--ex4.js-pyg.html-14"></a>      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex3--ex4.js-pyg.html-15"></a>        <span class="nx">request</span><span class="p">(</span><span class="s1">&#39;http://www.google.com&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex3--ex4.js-pyg.html-16"></a>          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex3--ex4.js-pyg.html-17"></a>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Retrieved the web page&quot;</span><span class="p">);</span>
<a name="code--ex3--ex4.js-pyg.html-18"></a>          <span class="p">}</span>
<a name="code--ex3--ex4.js-pyg.html-19"></a>
<a name="code--ex3--ex4.js-pyg.html-20"></a>          <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="code--ex3--ex4.js-pyg.html-21"></a>          <span class="k">if</span><span class="p">(</span><span class="nx">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">callback</span><span class="p">();</span>
<a name="code--ex3--ex4.js-pyg.html-22"></a>        <span class="p">});</span>
<a name="code--ex3--ex4.js-pyg.html-23"></a>      <span class="p">}</span>
<a name="code--ex3--ex4.js-pyg.html-24"></a>    <span class="p">}</span>
<a name="code--ex3--ex4.js-pyg.html-25"></a>  <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex3--ex4.js-pyg.html-26"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;DONE&quot;</span><span class="p">);</span>
<a name="code--ex3--ex4.js-pyg.html-27"></a>  <span class="p">}</span>
<a name="code--ex3--ex4.js-pyg.html-28"></a><span class="p">)</span>
</pre></div><p>Let's have a quick look at the code. The <tt class="docutils literal">async.whilst</tt> method takes three functions. The first function is the <tt class="docutils literal">while</tt> statement that tells <tt class="docutils literal">whilst</tt> to keep running until the returned value from the first function is <tt class="docutils literal">false</tt>. The second function is the actual work being done in each pass through the <tt class="docutils literal">while</tt>. Once the program is done with it's work it calls the callback and the loop repeats. When the first function returns false <tt class="docutils literal">whilst</tt> calls the last function with the final result. The second function is the same as the previous code example.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p>Grasping the fundamentals about asynchronous programming is important to the correct behaviour of you applications and also to leverage the high concurrency available in Node.js. Don't worry if you don't grasp it the first time around it can take a while to get used to it especially if you come from another programming platform that is synchronous like ruby, python, perl or php.</p>
<p class="last">It's worth spending some time practicing it or understanding how the <tt class="docutils literal">async</tt> library works.</p>
</div>
</div>
</div>
<div class="section" id="exercise-4-connecting-to-a-single-mongodb-instance-from-node-js">
<h2><a class="toc-backref" href="#id25">Exercise 4: Connecting to a single MongoDB instance from Node.js</a></h2>
<p>In this exercise we will look at how to connect to <tt class="docutils literal">MongoDB</tt> from Node.js. We will write a simple program that connects to the server and then disconnects itself. We are assuming the npm <tt class="docutils literal">mongodb</tt> package is already installed (if not revisit exercise 1). Fire up your text editor and enter the following program.</p>
<div class="highlight"><pre><a name="code--ex4--ex1.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex4--ex1.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex4--ex1.js-pyg.html-3"></a>
<a name="code--ex4--ex1.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex4--ex1.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex4--ex1.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex4--ex1.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex4--ex1.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex4--ex1.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex4--ex1.js-pyg.html-10"></a>
<a name="code--ex4--ex1.js-pyg.html-11"></a>  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex4--ex1.js-pyg.html-12"></a><span class="p">})</span>
</pre></div><p>Notice the weird string <tt class="docutils literal"><span class="pre">mongodb://localhost:27017/test</span></tt> this is called an <tt class="docutils literal">URI</tt> connection string and is used by the driver to allow you to specify how to connect to a MongoDB server without specifying it programatically. This is useful if you need to use the same program against multiple different MongoDB setups as you can just store a seperate string for each environment.</p>
<p>The <tt class="docutils literal">MongoClient.connect</tt> takes a function with 2 parameters where the first one is named <tt class="docutils literal">err</tt> and the second <tt class="docutils literal">db</tt>. This is how Node.js works and if you look at the documentation on the Node.js site <a class="reference external" href="http://nodejs.org/">http://nodejs.org/</a> you'll notice that all functions take the same function. If the function worked correctly the <tt class="docutils literal">err</tt> parameter will be set to <tt class="docutils literal">null</tt>. If it's not set to <tt class="docutils literal">null</tt> there was an error during the <tt class="docutils literal">MongoClient.connect</tt> call. To check if there was an error the code does <tt class="docutils literal">if(err)</tt> that will return true if <tt class="docutils literal">err</tt> is anything but <tt class="docutils literal">null</tt> and then prints an error message before closing the connection.</p>
<p>But say we have 2 different databases we want to use. Can we do just do <tt class="docutils literal">MongoClient.connect</tt> calls. The answer is yes but that it's not optimal. The reason is that <tt class="docutils literal">MongoClient.connect</tt> sets up a connection pool for each call meaning that if you call <tt class="docutils literal">MongoClient.connect</tt> a lot you might find that you are opening a lot of uneccessary connection to the MongoDB server. Luckily we can avoid this simply. Enter the following code in you text editor.</p>
<div class="highlight"><pre><a name="code--ex4--ex2.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex4--ex2.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex4--ex2.js-pyg.html-3"></a>
<a name="code--ex4--ex2.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex4--ex2.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex4--ex2.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex4--ex2.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex4--ex2.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex4--ex2.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex4--ex2.js-pyg.html-10"></a>
<a name="code--ex4--ex2.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">test2</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">&#39;test2&#39;</span><span class="p">);</span>
<a name="code--ex4--ex2.js-pyg.html-12"></a>
<a name="code--ex4--ex2.js-pyg.html-13"></a>  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex4--ex2.js-pyg.html-14"></a><span class="p">})</span>
</pre></div><p>Notice the line <tt class="docutils literal"><span class="pre">db.db('test2')</span></tt>. This creates a new Db object where all operations will go against the db <tt class="docutils literal">test2</tt> but will share the underlying connection pool with the first database <tt class="docutils literal">test</tt>. This lets your program get efficient reuse of the connection pool we created using <tt class="docutils literal">MongoClient.connect</tt>.</p>
<p>That's covered <tt class="docutils literal">MongoClient.connect</tt>. Sometime we want better programatic control of our connections to MongoDB. Luckily <tt class="docutils literal">MongoClient</tt> allows for this aswell. Spin up the text editor again and enter the following program.</p>
<div class="highlight"><pre><a name="code--ex4--ex3.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex4--ex3.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span>
<a name="code--ex4--ex3.js-pyg.html-3"></a>  <span class="p">,</span> <span class="nx">Server</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">Server</span><span class="p">;</span>
<a name="code--ex4--ex3.js-pyg.html-4"></a>
<a name="code--ex4--ex3.js-pyg.html-5"></a><span class="kd">var</span> <span class="nx">mongoclient</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MongoClient</span><span class="p">(</span><span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">27017</span><span class="p">));</span>
<a name="code--ex4--ex3.js-pyg.html-6"></a><span class="nx">mongoclient</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">mongoclient</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex4--ex3.js-pyg.html-7"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex4--ex3.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex4--ex3.js-pyg.html-9"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex4--ex3.js-pyg.html-10"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex4--ex3.js-pyg.html-11"></a>  <span class="p">}</span>
<a name="code--ex4--ex3.js-pyg.html-12"></a>
<a name="code--ex4--ex3.js-pyg.html-13"></a>  <span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="nx">mongoclient</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">);</span>
<a name="code--ex4--ex3.js-pyg.html-14"></a>  <span class="kd">var</span> <span class="nx">test2</span> <span class="o">=</span> <span class="nx">mongoclient</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">&#39;test2&#39;</span><span class="p">);</span>
<a name="code--ex4--ex3.js-pyg.html-15"></a>
<a name="code--ex4--ex3.js-pyg.html-16"></a>  <span class="nx">mongoclient</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex4--ex3.js-pyg.html-17"></a><span class="p">})</span>
</pre></div><p>Notice the line <tt class="docutils literal">Server = mongodb.Server</tt>. It allows us to define the settings for connecting to a server instance. The line <tt class="docutils literal">new MongoClient(new <span class="pre">Server('localhost',</span> 27017))</tt> creates an instance of <tt class="docutils literal">MongoClient</tt> that is ready to connect to the MongoDB server at localhost on port 27017. The program then calls <tt class="docutils literal">.open</tt> on the <tt class="docutils literal">MongoClient</tt> instance. The main difference from the previous connection example using <tt class="docutils literal">MongoClient.connect</tt> is that the function returns the <tt class="docutils literal">MongoClient</tt> instance instead of a <tt class="docutils literal">db</tt> instance. To get hold of the <tt class="docutils literal">db</tt> instances we have to call the function <tt class="docutils literal"><span class="pre">.db('test')</span></tt> on the <tt class="docutils literal">MongoClient</tt> instance. The code does this twice to retrieve a db instance for the databases <tt class="docutils literal">test</tt> and <tt class="docutils literal">test2</tt> before finally closing the connection to the MongoDB database.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">MongoDB can be configured to run as a cluster or sharded system. In later exercises we will learn how to connect to this configuarations. It's very similar to the current examples but has some slight differences. You can read more about the <tt class="docutils literal">URI</tt> format at <a class="reference external" href="http://docs.mongodb.org/manual/reference/connection-string/">http://docs.mongodb.org/manual/reference/connection-string/</a></p>
</div>
</div>
<div class="section" id="exercise-5-document-documents-everywhere">
<h2><a class="toc-backref" href="#id26">Exercise 5: Document documents everywhere</a></h2>
<p>So it's probably dawned on you that MongoDB is a document database. Moreover it's schemaless database. So what does that mean in layman terms. Let's start with a simple example of a <tt class="docutils literal">JSON</tt> document.</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;MongoDB&quot;</span><span class="p">,</span>
  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;A schemaless document database&quot;</span><span class="p">,</span>
  <span class="nt">&quot;features&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;schemaless&quot;</span><span class="p">,</span> <span class="s2">&quot;document oriented&quot;</span><span class="p">,</span> <span class="s2">&quot;fast&quot;</span><span class="p">,</span> <span class="s2">&quot;scalable&quot;</span><span class="p">],</span>
  <span class="nt">&quot;main developer&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;10gen&quot;</span><span class="p">,</span>
    <span class="nt">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;new york city&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>As we can the document is made up of set of names and values <tt class="docutils literal">'name': 'MongoDB'</tt> and we can see that we can express such concepts as a list of features and a <tt class="docutils literal">JSON</tt> embedded document under the name <tt class="docutils literal">main developer</tt>. The possibilities on how to structure your data in documents is only limited by your imagination and the current 16MB limit for a single document.</p>
<p>MongoDB extends on <tt class="docutils literal">JSON</tt> by adding types. This format is called <tt class="docutils literal">BSON</tt> and is a binary representation of <tt class="docutils literal">JSON</tt> with additonal types so the database can operate on them. These types can be summed up in a table (more details available at <a class="reference external" href="http://bsonspec.org/#/specification">http://bsonspec.org/#/specification</a>). We've only included the types that you will use from your application and ignored the ones that are internal data types or are not generally used in documents.</p>
<table border="1" class="docutils">
<colgroup>
<col width="7%" />
<col width="93%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Long</td>
<td>A 64 bit integer value that can take the value of +/- 9,223,372,036,854,775,808</td>
</tr>
<tr><td>Date</td>
<td>A UTC Datetime value</td>
</tr>
<tr><td>Regexp</td>
<td>A regular expression</td>
</tr>
<tr><td>Code</td>
<td>A Javascript string with an option scope for the script</td>
</tr>
<tr><td>Binary</td>
<td>A Binary blob object (can have a subtype)</td>
</tr>
<tr><td>Double</td>
<td>A 64 bit float value (only use this if you have a whole number that you want stored as a double instead and not an integer)</td>
</tr>
</tbody>
</table>
<p>So how do we express a Document with all these special types in Node.js. Well fire up the text editor and let's get cracking on the code below.</p>
<div class="highlight"><pre><a name="code--ex5--ex1.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex5--ex1.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">Long</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">Long</span>
<a name="code--ex5--ex1.js-pyg.html-3"></a>  <span class="p">,</span> <span class="nx">Binary</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">Binary</span>
<a name="code--ex5--ex1.js-pyg.html-4"></a>  <span class="p">,</span> <span class="nx">Code</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">Code</span>
<a name="code--ex5--ex1.js-pyg.html-5"></a>  <span class="p">,</span> <span class="nx">ObjectID</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">ObjectID</span>
<a name="code--ex5--ex1.js-pyg.html-6"></a>  <span class="p">,</span> <span class="nx">serialize</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">BSONPure</span><span class="p">.</span><span class="nx">BSON</span><span class="p">.</span><span class="nx">serialize</span><span class="p">;</span>
<a name="code--ex5--ex1.js-pyg.html-7"></a>
<a name="code--ex5--ex1.js-pyg.html-8"></a><span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="s1">&#39;hello world&#39;</span><span class="p">);</span>
<a name="code--ex5--ex1.js-pyg.html-9"></a>
<a name="code--ex5--ex1.js-pyg.html-10"></a><span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex5--ex1.js-pyg.html-11"></a>    <span class="s1">&#39;64bitvalue&#39;</span><span class="o">:</span> <span class="nx">Long</span><span class="p">.</span><span class="nx">fromNumber</span><span class="p">(</span><span class="mi">45000000</span><span class="p">)</span>
<a name="code--ex5--ex1.js-pyg.html-12"></a>  <span class="p">,</span> <span class="s1">&#39;array of values&#39;</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">}]</span>
<a name="code--ex5--ex1.js-pyg.html-13"></a>  <span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Binary</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span>
<a name="code--ex5--ex1.js-pyg.html-14"></a>  <span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Code</span><span class="p">(</span><span class="kd">function</span> <span class="nx">test</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex5--ex1.js-pyg.html-15"></a>      <span class="k">return</span> <span class="s2">&quot;hello world&quot;</span><span class="p">;</span>
<a name="code--ex5--ex1.js-pyg.html-16"></a>    <span class="p">})</span>
<a name="code--ex5--ex1.js-pyg.html-17"></a>  <span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
<a name="code--ex5--ex1.js-pyg.html-18"></a>  <span class="p">,</span> <span class="s1">&#39;regexp&#39;</span><span class="o">:</span> <span class="sr">/^hello/</span>
<a name="code--ex5--ex1.js-pyg.html-19"></a>  <span class="p">,</span> <span class="s1">&#39;_id&#39;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">()</span>
<a name="code--ex5--ex1.js-pyg.html-20"></a><span class="p">}</span>
<a name="code--ex5--ex1.js-pyg.html-21"></a>
<a name="code--ex5--ex1.js-pyg.html-22"></a><span class="nx">serialize</span><span class="p">(</span><span class="nb">document</span><span class="p">);</span>
</pre></div><p>The <tt class="docutils literal">serialize</tt> function is not a function you'll usually use in your programs but allows us to verify that the document is a valid <tt class="docutils literal">BSON</tt> document by serializing it to it's binary representation.</p>
<p>There are some interesting limitations in Javascript due to the way way numbers are represented in the language. All numbers are actually <tt class="docutils literal">double floats</tt> which means that the highest number you can represent in Javascript is 53 bits of resolution or <tt class="docutils literal">+/- 9,007,199,254,740,992</tt> which is significantly less than the <tt class="docutils literal">Long</tt> type. This means that any <tt class="docutils literal">Long</tt> values stored in MongoDB is returned as a <tt class="docutils literal">Long</tt> instance instead of a <tt class="docutils literal">Number</tt> instance. Since MongoDB can only store either 32 bit ints, 64 bit ints or 64 bit doubles the driver does intelligent conversion where possible. You can override this by doing <tt class="docutils literal">new Double(1)</tt> to force it to store it as a 64 bit float instead of a 32 bit integer.</p>
<p>If we look a the second value in the document <tt class="docutils literal">array of values</tt> we can see that it's an array composed of some numbers, a string and a document. This is a reflection of the flexibility of expression the document model gives you when modeling your applications data and one of the main reasons I think MongoDB is a blast of fresh air to traditional data modelling with relational tables.</p>
<p>The <tt class="docutils literal">Binary</tt> type let's us store raw byte data in MongoDB. You can store such things as images or maybe binary files such as word documents or pdf's. However remember that a single document has a maximum size of 16MB. If you need to store Bigger files we will show you how in a later exercise using a driver feature called <tt class="docutils literal">GridFS</tt>.</p>
<p>The <tt class="docutils literal">Code</tt> object is kind of interesting and is used to store actual Javascript code in MongoDB. You can even execute this code on the server if you store it in a special place (but this is not recommended as Javascript on the server is not very performant and comes with some fairly harsh limitations, more on that later).</p>
<p>The <tt class="docutils literal">date</tt> value is a Javascript Date object and MongoDB has native support for dates so you can sort on them in the database. For the driver this shows the perfect match of MongoDB and Node.js since the date type is just the one that already comes pre-packaged with Javascript.</p>
<p>The next value <tt class="docutils literal">regexp</tt> is a a regular expression that can also be stored in MongoDB. For pure documents it might not be so useful but because queries in MongoDB are actually <tt class="docutils literal">BSON</tt> documents it means that MongoDB supports regular expressions in queries.</p>
<p>The last value <tt class="docutils literal">_id</tt> is a special type in MongoDB that is a 12 bit unique identifier inside a collection. This type is the default primary key in a collection (the primary key in a document is alway the <tt class="docutils literal">_id</tt> field in a document) and is made up of a timestamp + some additional fields and an incremental value. This gives it a great secondary property of being sortable by time allowing you to sort any record that just contains the <tt class="docutils literal">_id</tt> field by it's creation time.</p>
<p>So as you can see we can store pure <tt class="docutils literal">JSON</tt> objects but also more complex types that go beyond what Javascript supports natively. This matching makes MongoDB a great database for Node.js. As we will see in future exercises the match between MongoDB and Node.js can be leveraged to do some very interesting and unique things.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">Much of the power of MongoDB is locked in the design of your schema, how you design your data will impact the way you read and write the data and also the performance of you application. We will go more indepth on schema design in future exercises and look at benefits and tradeoffs associated with specific solutions.</p>
</div>
</div>
<div class="section" id="exercise-6-databases-and-collections">
<h2><a class="toc-backref" href="#id27">Exercise 6: Databases and Collections</a></h2>
<p>MongoDB has is build around 3 main concepts. One or more <tt class="docutils literal">db's</tt> that contain one or more <tt class="docutils literal">collections</tt> that contain one or more <tt class="docutils literal">documents</tt>. So how do we get hold of a <tt class="docutils literal">collection</tt>? Time for some code entry.</p>
<div class="highlight"><pre><a name="code--ex6--ex1.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex6--ex1.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex6--ex1.js-pyg.html-3"></a>
<a name="code--ex6--ex1.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex6--ex1.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex6--ex1.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex6--ex1.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex6--ex1.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex6--ex1.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex6--ex1.js-pyg.html-10"></a>
<a name="code--ex6--ex1.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">myotherdb</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">&#39;myotherdb&#39;</span><span class="p">);</span>
<a name="code--ex6--ex1.js-pyg.html-12"></a>  <span class="kd">var</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">admin</span><span class="p">();</span>
<a name="code--ex6--ex1.js-pyg.html-13"></a>
<a name="code--ex6--ex1.js-pyg.html-14"></a>  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mydocuments&#39;</span><span class="p">);</span>
<a name="code--ex6--ex1.js-pyg.html-15"></a>
<a name="code--ex6--ex1.js-pyg.html-16"></a>  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex6--ex1.js-pyg.html-17"></a><span class="p">});</span>
</pre></div><p>The example shows how to use the <tt class="docutils literal">MongoClient.connect</tt> method to fetch a connection to a database directly. The <tt class="docutils literal">connect</tt> method actually returns a database object. If we want to use other databases we can call the <tt class="docutils literal">.db()</tt> method on the <tt class="docutils literal">db</tt> object returned by the <tt class="docutils literal">MongoClient.connect</tt> method. Notice that we don't need a new callback, this is because the <tt class="docutils literal">.db()</tt> method does not open a new connection but reuses the existing connections that was created during the <tt class="docutils literal">MongoClient.connect</tt> call.</p>
<p>So what is the <tt class="docutils literal">.admin()</tt> method. Some administrative commands must be run against a special database called <tt class="docutils literal">admin</tt>. To make the it a little bit easier I created an <tt class="docutils literal">.admin()</tt> method that returns an instance of the <tt class="docutils literal">Admin</tt> class with helper methods to make it easier to use the administrative commands available.</p>
<p>The other main usage of the <tt class="docutils literal">admin()</tt> database is for storing user credentials as a server level. Don't worry we will touch on this later as for now it's a more advanced topic than we need to be concerned about.</p>
<p>After having fetched the new dbs <tt class="docutils literal">myotherdb</tt> and <tt class="docutils literal">admin</tt> we want to grab some collections to do some work on. This is done by calling <tt class="docutils literal">db.collection()</tt> that returns a <tt class="docutils literal">Collection</tt> object helper methods to help us do work on the collection. The reason we don't need to use a callback function here is that <tt class="docutils literal">.collection()</tt> does not actually call out to the database to create a collection. This happens automatically when we save the first document to MongoDB. MongoDB will create a default collection with the name we passed into the <tt class="docutils literal">.collection()</tt> method and save the document to it.</p>
<div class="section" id="capped-collections">
<h3><a class="toc-backref" href="#id28">Capped Collections</a></h3>
<p>However this might not always be what we want. MongoDB has two types of collection types available. The first one we will refer to as the <tt class="docutils literal">standard</tt> collection type and the second as the <tt class="docutils literal">capped collection</tt> type. The <tt class="docutils literal">capped collection</tt> type is quite a different beast from the <tt class="docutils literal">standard</tt> collection type. It's of a fixed size (you have to specify the size of the intial collection in bytes) and you can set a max number of documents it can store. It's als a FIFO (First in first out) queue which means that when it reaches the end of the space it will wrap around. Other limitiations are that you cannot add fields to an existing document and you cannot delete them.</p>
<p>This might sound like a lot of limitiations but the FIFO property and the semantics of operations are actually really good if you want to limit the amount of data stored or don't care if data is overwritten after awhile.</p>
<p>So how do we create a <tt class="docutils literal">capped collection</tt> instead of a <tt class="docutils literal">standard</tt> collection ? Let's explore some code, typing it up in your editor.</p>
<div class="highlight"><pre><a name="code--ex6--ex2.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex6--ex2.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex6--ex2.js-pyg.html-3"></a>
<a name="code--ex6--ex2.js-pyg.html-4"></a><span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex6--ex2.js-pyg.html-5"></a>  <span class="s1">&#39;hello&#39;</span><span class="o">:</span> <span class="s1">&#39;world&#39;</span>
<a name="code--ex6--ex2.js-pyg.html-6"></a><span class="p">}</span>
<a name="code--ex6--ex2.js-pyg.html-7"></a>
<a name="code--ex6--ex2.js-pyg.html-8"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex6--ex2.js-pyg.html-9"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex6--ex2.js-pyg.html-10"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex6--ex2.js-pyg.html-11"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex6--ex2.js-pyg.html-12"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex6--ex2.js-pyg.html-13"></a>  <span class="p">}</span>
<a name="code--ex6--ex2.js-pyg.html-14"></a>
<a name="code--ex6--ex2.js-pyg.html-15"></a>  <span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="s2">&quot;mycappedcollection&quot;</span><span class="p">,</span>
<a name="code--ex6--ex2.js-pyg.html-16"></a>    <span class="p">{</span> <span class="nx">capped</span><span class="o">:</span><span class="kc">true</span>
<a name="code--ex6--ex2.js-pyg.html-17"></a>      <span class="p">,</span> <span class="nx">size</span><span class="o">:</span><span class="mi">100000</span>
<a name="code--ex6--ex2.js-pyg.html-18"></a>      <span class="p">,</span> <span class="nx">max</span><span class="o">:</span> <span class="mi">100</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span> <span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex6--ex2.js-pyg.html-19"></a>
<a name="code--ex6--ex2.js-pyg.html-20"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex6--ex2.js-pyg.html-21"></a>  <span class="p">});</span>
<a name="code--ex6--ex2.js-pyg.html-22"></a><span class="p">});</span>
</pre></div><p>Notice the <tt class="docutils literal">db.createCollection()</tt> method we are using. This is a method specifically made to allow us to create collections that are not <tt class="docutils literal">standard</tt> collections. In this code example we are creating a <tt class="docutils literal">capped collection</tt> with a size of <tt class="docutils literal">100000</tt> bytes and holding a maximum of <tt class="docutils literal">100</tt> documents before it starts overwritting them. The options we can pass in to the <tt class="docutils literal">db.createCollection</tt> for a capped collection are.</p>
<ul class="simple">
<li><tt class="docutils literal">capped</tt>: (true/false), specified that this is a capped (FIFO) collection</li>
<li><tt class="docutils literal">size</tt>: (a number of bytes larger than 0), specifies the maximum size in bytes of the capped collection.</li>
<li><tt class="docutils literal">max</tt>: (a number larger than 0), specifies the maximum number of documents that can be stored in the collection before the collection starts overwritten old documents.</li>
</ul>
</div>
<div class="section" id="time-to-live-collections-ttl">
<h3><a class="toc-backref" href="#id29">Time to live collections (TTL)</a></h3>
<p>From MongoDB 2.2 onwards there is a new type of collection called a <tt class="docutils literal">TTL</tt> collection. It's a bit of a misdemeaner to call it a type of collections as it's actually a <tt class="docutils literal">standard</tt> collection with a special type to live <tt class="docutils literal">index</tt> on a date fields that automatically removes documents that are older than the time specified for the <tt class="docutils literal">TTL index</tt>. It's a very useful when want only to store data for a specified time period. Say we only want to keep 48 hours of log data in a collection. With <tt class="docutils literal">TTL</tt> you can set the time of expiry to be 48 hours and documents will be removed when they are older than 48 hours. Code is a thousand words so fire up your editor and enter the code below.</p>
<div class="highlight"><pre><a name="code--ex6--ex3.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex6--ex3.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex6--ex3.js-pyg.html-3"></a>
<a name="code--ex6--ex3.js-pyg.html-4"></a><span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex6--ex3.js-pyg.html-5"></a>  <span class="s1">&#39;hello&#39;</span><span class="o">:</span> <span class="s1">&#39;world&#39;</span>
<a name="code--ex6--ex3.js-pyg.html-6"></a><span class="p">}</span>
<a name="code--ex6--ex3.js-pyg.html-7"></a>
<a name="code--ex6--ex3.js-pyg.html-8"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex6--ex3.js-pyg.html-9"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex6--ex3.js-pyg.html-10"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex6--ex3.js-pyg.html-11"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex6--ex3.js-pyg.html-12"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex6--ex3.js-pyg.html-13"></a>  <span class="p">}</span>
<a name="code--ex6--ex3.js-pyg.html-14"></a>
<a name="code--ex6--ex3.js-pyg.html-15"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;myttlcollection&#39;</span><span class="p">);</span>
<a name="code--ex6--ex3.js-pyg.html-16"></a>  <span class="kd">var</span> <span class="nx">fortyeighthours</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">48</span><span class="p">;</span>
<a name="code--ex6--ex3.js-pyg.html-17"></a>
<a name="code--ex6--ex3.js-pyg.html-18"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">ensureIndex</span><span class="p">(</span>
<a name="code--ex6--ex3.js-pyg.html-19"></a>      <span class="p">{</span><span class="nx">created_on</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span>
<a name="code--ex6--ex3.js-pyg.html-20"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">expireAfterSeconds</span><span class="o">:</span> <span class="nx">fortyeighthours</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex6--ex3.js-pyg.html-21"></a>
<a name="code--ex6--ex3.js-pyg.html-22"></a>      <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex6--ex3.js-pyg.html-23"></a>  <span class="p">});</span>
<a name="code--ex6--ex3.js-pyg.html-24"></a><span class="p">});</span>
</pre></div><p>Notice the <tt class="docutils literal">collection.ensureIndex()</tt> method. We will go deeper into how indexes work and how the Node.js driver can create them in a later exercise. The point to notice here is that the <tt class="docutils literal">TTL</tt> collection needs an index on a data field to work correctly and that the <tt class="docutils literal">expireAfterSeconds</tt> parameter is in seconds.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">One particular note to be made about <tt class="docutils literal">TTL</tt> collections is that the expiry time is not a hard expiry time. What's meant by hard. Well it means that even if a document is exactly 48 hours old it might not be removed at exactly 48 hours but some time after that when MongoDB has free resources to remove the document. Also due to the fact that <tt class="docutils literal">TTL</tt> collections need to remove documents from a collection <tt class="docutils literal">TTL</tt> does not work with <tt class="docutils literal">capped collections</tt> so keep that in mind.</p>
</div>
</div>
</div>
<div class="section" id="exercise-7-inserting-documents">
<h2><a class="toc-backref" href="#id30">Exercise 7: Inserting documents</a></h2>
<p>The first and most important feature of a database is to be able to store data in it. Let's get cracking on inserting documents into MongoDB. There are 3 main things you need to know about inserting documents in MongoDB using the Node.js driver. These are single inserts, bulk inserts and write concerns. Before hitting the details let's do a single document insert to get us moving and explain the basic concept. Fire up your text editor and enter the following code.</p>
<div class="highlight"><pre><a name="code--ex7--ex1.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex7--ex1.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex7--ex1.js-pyg.html-3"></a>
<a name="code--ex7--ex1.js-pyg.html-4"></a><span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex7--ex1.js-pyg.html-5"></a>  <span class="s1">&#39;hello&#39;</span><span class="o">:</span> <span class="s1">&#39;world&#39;</span>
<a name="code--ex7--ex1.js-pyg.html-6"></a><span class="p">}</span>
<a name="code--ex7--ex1.js-pyg.html-7"></a>
<a name="code--ex7--ex1.js-pyg.html-8"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex1.js-pyg.html-9"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex1.js-pyg.html-10"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex1.js-pyg.html-11"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex7--ex1.js-pyg.html-12"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex1.js-pyg.html-13"></a>  <span class="p">}</span>
<a name="code--ex7--ex1.js-pyg.html-14"></a>
<a name="code--ex7--ex1.js-pyg.html-15"></a>  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mydocuments&#39;</span><span class="p">);</span>
<a name="code--ex7--ex1.js-pyg.html-16"></a>
<a name="code--ex7--ex1.js-pyg.html-17"></a>  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span><span class="mi">0</span><span class="p">});</span>
<a name="code--ex7--ex1.js-pyg.html-18"></a>
<a name="code--ex7--ex1.js-pyg.html-19"></a>  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex7--ex1.js-pyg.html-20"></a><span class="p">});</span>
</pre></div><p>Let's digest the code example. The first thing we notice after connecting to the database is that we create a document containing <tt class="docutils literal">'hello': 'world'</tt>. After that we grab the collection <tt class="docutils literal">mydocuments</tt> and we call the method on the collection called <tt class="docutils literal">.insert()</tt>. The first parameter is the document we wish to store and the second is an object with the parameter <tt class="docutils literal">w</tt> set to 0. Notice that we have not provided any callback function. We will touch on the concept of <tt class="docutils literal">write concerns</tt> a bit down the line. Sufficient for now is to know that if we set <tt class="docutils literal">w:0</tt> we are not asking MongoDB to acknowledge that the write was correctly recieved by the database server. Rather it's a <tt class="docutils literal">fire and forget</tt> write of the document to MongoDB.</p>
<p>What happens under the cover is that the driver takes your document and converts it into a <tt class="docutils literal">BSON</tt> document that is then sent over the socket to MongoDB. Let's boot up the MongoDB console and verify that the document made it to the console (we are assuming you have the executable <tt class="docutils literal">mongodb</tt> in your path for your terminal/shell/windows prompt).</p>
<pre class="code console literal-block">
<span class="go">~ $ mongo
MongoDB shell version: 2.2
connecting to: test
</span><span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test
</span><span class="gp">&gt;</span> show collections
<span class="go">mydocuments
system.indexes
</span><span class="gp">&gt;</span> db.mydocuments.findOne<span class="o">()</span>
<span class="go">{ &quot;hello&quot; : &quot;world&quot;, &quot;_id&quot; : ObjectId(&quot;50c5f63780ebe8585f000001&quot;) }</span>
</pre>
<p>Notice that our document is correctly stored in our <tt class="docutils literal">test</tt> database. But also notice that we have an additional field called <tt class="docutils literal">_id</tt> that seems to be of a type known as <tt class="docutils literal">ObjectId</tt>. The first thing to understand is that all documents in a collection in MongoDB has what is termed a <tt class="docutils literal">primary key</tt> called <tt class="docutils literal">_id</tt>. A <tt class="docutils literal">primary key</tt> is a unqiue identifier for that specific document that is unique for the whole collection. There is a guarante from MongoDB's side that there cannot be more than one document using a specific <tt class="docutils literal">ObjectId</tt> for the field <tt class="docutils literal">_id</tt> in a collection. You can use the same <tt class="docutils literal">ObjectId</tt> in other collections of course or in other field names. The driver actually generates these for you when you insert if they don't exist from before. Also notice that the number inside the <tt class="docutils literal"><span class="pre">ObjectId(...)</span></tt> will vary on your computer in comparision to the example as it's a generated value.</p>
<p>But you can also override the <tt class="docutils literal">_id</tt> field yourself and set it to application generated id. This might be useful if you are generating your own globally unique numbers for example. Let's do this and also see what happens if we try to insert the same document with the same id twice. Enter the following code in your editor.</p>
<div class="highlight"><pre><a name="code--ex7--ex2.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex7--ex2.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex7--ex2.js-pyg.html-3"></a>
<a name="code--ex7--ex2.js-pyg.html-4"></a><span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex7--ex2.js-pyg.html-5"></a>    <span class="s1">&#39;_id&#39;</span><span class="o">:</span> <span class="mi">1</span>
<a name="code--ex7--ex2.js-pyg.html-6"></a>  <span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="o">:</span> <span class="s1">&#39;world&#39;</span>
<a name="code--ex7--ex2.js-pyg.html-7"></a><span class="p">}</span>
<a name="code--ex7--ex2.js-pyg.html-8"></a>
<a name="code--ex7--ex2.js-pyg.html-9"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex2.js-pyg.html-10"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex2.js-pyg.html-11"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex2.js-pyg.html-12"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex7--ex2.js-pyg.html-13"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex2.js-pyg.html-14"></a>  <span class="p">}</span>
<a name="code--ex7--ex2.js-pyg.html-15"></a>
<a name="code--ex7--ex2.js-pyg.html-16"></a>  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mydocuments&#39;</span><span class="p">);</span>
<a name="code--ex7--ex2.js-pyg.html-17"></a>
<a name="code--ex7--ex2.js-pyg.html-18"></a>  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex2.js-pyg.html-19"></a>
<a name="code--ex7--ex2.js-pyg.html-20"></a>    <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex2.js-pyg.html-21"></a>
<a name="code--ex7--ex2.js-pyg.html-22"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex2.js-pyg.html-23"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;document with _id already exists&quot;</span><span class="p">);</span>
<a name="code--ex7--ex2.js-pyg.html-24"></a>      <span class="p">}</span>
<a name="code--ex7--ex2.js-pyg.html-25"></a>
<a name="code--ex7--ex2.js-pyg.html-26"></a>      <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex7--ex2.js-pyg.html-27"></a>    <span class="p">});</span>
<a name="code--ex7--ex2.js-pyg.html-28"></a>  <span class="p">});</span>
<a name="code--ex7--ex2.js-pyg.html-29"></a><span class="p">});</span>
</pre></div><p>When you run this you should see the following output</p>
<pre class="code console literal-block">
<span class="go">connected to database
document with _id already exists</span>
</pre>
<p>Let's check what's in the database after we ran our script.</p>
<pre class="code console literal-block">
<span class="go">~ $ mongo
MongoDB shell version: 2.2
connecting to: test
</span><span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test
</span><span class="gp">&gt;</span> show collections
<span class="go">mydocuments
system.indexes
</span><span class="gp">&gt;</span> db.mydocuments.find<span class="o">()</span>.pretty<span class="o">()</span>
<span class="go">{ &quot;hello&quot; : &quot;world&quot;, &quot;_id&quot; : ObjectId(&quot;50c5f63780ebe8585f000001&quot;) }
{ &quot;_id&quot; : 1, &quot;hello&quot; : &quot;world&quot; }</span>
</pre>
<p>So what happened here. The first insert command worked as expected and our document was saved in the database with the <tt class="docutils literal">_id</tt> set to <tt class="docutils literal">1</tt> as we expected. When the second insert was tried however it failed and we got the message that the document with that <tt class="docutils literal">_id</tt> already exists. Since <tt class="docutils literal">_id</tt> needs to be unique that is as expected.</p>
<p>One thing to remember is that the <tt class="docutils literal">_id</tt> can be any <tt class="docutils literal">BSON</tt> type including a binary which is used to for example use global unique identifiers called <tt class="docutils literal">UUID's</tt> (read more at <a class="reference external" href="http://en.wikipedia.org/wiki/Universally_unique_identifier">http://en.wikipedia.org/wiki/Universally_unique_identifier</a> about UUID). This can be quite useful as we mentioned above for some specific scenarios. But for this book we will stick to the plain vanilla <tt class="docutils literal">ObjectId</tt> or <tt class="docutils literal">ObjectID</tt> as its nown in the Node.js driver.</p>
<div class="section" id="bulk-inserts">
<h3><a class="toc-backref" href="#id31">Bulk Inserts</a></h3>
<p>So this is quite good, we can easily insert a document. So what if we want to insert 100 documents. The first thought might be something like the code below. Enter it an run it.</p>
<div class="highlight"><pre><a name="code--ex7--ex3.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex7--ex3.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex7--ex3.js-pyg.html-3"></a>
<a name="code--ex7--ex3.js-pyg.html-4"></a><span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex7--ex3.js-pyg.html-5"></a>    <span class="s1">&#39;_id&#39;</span><span class="o">:</span> <span class="mi">1</span>
<a name="code--ex7--ex3.js-pyg.html-6"></a>  <span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="o">:</span> <span class="s1">&#39;world&#39;</span>
<a name="code--ex7--ex3.js-pyg.html-7"></a><span class="p">}</span>
<a name="code--ex7--ex3.js-pyg.html-8"></a>
<a name="code--ex7--ex3.js-pyg.html-9"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex3.js-pyg.html-10"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex3.js-pyg.html-11"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex3.js-pyg.html-12"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex7--ex3.js-pyg.html-13"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex3.js-pyg.html-14"></a>  <span class="p">}</span>
<a name="code--ex7--ex3.js-pyg.html-15"></a>
<a name="code--ex7--ex3.js-pyg.html-16"></a>  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mycountingdocuments&#39;</span><span class="p">);</span>
<a name="code--ex7--ex3.js-pyg.html-17"></a>  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<a name="code--ex7--ex3.js-pyg.html-18"></a>
<a name="code--ex7--ex3.js-pyg.html-19"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex3.js-pyg.html-20"></a>    <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">i</span><span class="o">:</span><span class="nx">i</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex3.js-pyg.html-21"></a>      <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="code--ex7--ex3.js-pyg.html-22"></a>
<a name="code--ex7--ex3.js-pyg.html-23"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex3.js-pyg.html-24"></a>        <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex7--ex3.js-pyg.html-25"></a>      <span class="p">}</span>
<a name="code--ex7--ex3.js-pyg.html-26"></a>    <span class="p">});</span>
<a name="code--ex7--ex3.js-pyg.html-27"></a>  <span class="p">}</span>
<a name="code--ex7--ex3.js-pyg.html-28"></a><span class="p">});</span>
</pre></div><p>Let's check that the documents made it to the database. Notice that we changed the name of the collection.</p>
<pre class="code console literal-block">
<span class="go">~ $ mongo
MongoDB shell version: 2.2
connecting to: test
</span><span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test
</span><span class="gp">&gt;</span> show collections
<span class="go">mycountingdocuments
mydocuments
system.indexes
</span><span class="gp">&gt;</span> db.mycountingdocuments.find<span class="o">()</span>.pretty<span class="o">()</span>
<span class="go">{ &quot;i&quot; : 0, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000001&quot;) }
{ &quot;i&quot; : 1, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000002&quot;) }
{ &quot;i&quot; : 5, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000006&quot;) }
{ &quot;i&quot; : 3, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000004&quot;) }
{ &quot;i&quot; : 4, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000005&quot;) }
{ &quot;i&quot; : 2, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000003&quot;) }
{ &quot;i&quot; : 9, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000a&quot;) }
{ &quot;i&quot; : 8, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000009&quot;) }
{ &quot;i&quot; : 6, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000007&quot;) }
{ &quot;i&quot; : 7, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000008&quot;) }
{ &quot;i&quot; : 10, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000b&quot;) }
{ &quot;i&quot; : 11, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000c&quot;) }
{ &quot;i&quot; : 12, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000d&quot;) }
{ &quot;i&quot; : 13, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000e&quot;) }
{ &quot;i&quot; : 14, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000f&quot;) }
{ &quot;i&quot; : 15, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000010&quot;) }
{ &quot;i&quot; : 16, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000011&quot;) }
{ &quot;i&quot; : 17, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000012&quot;) }
{ &quot;i&quot; : 18, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000013&quot;) }
{ &quot;i&quot; : 19, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000014&quot;) }
Type &quot;it&quot; for more
</span><span class="gp">&gt;</span> db.mycountingdocuments.count<span class="o">()</span>
<span class="go">100</span>
</pre>
<p>As you can see we have inserted 100 documents into the database as expected. But surely there must be a better way to bulk insert documents than issuing 100 seperate insert commands. Luckily there is. MongoDB support bulk inserts. In fact the bulk insert command sent to the server is a single message. There is a limit on how much data you can send in a single bulk insert. For now the drivers enforce a 16MB limit. With this information let's rewrite the example to do the insert as a bulk insert.</p>
<div class="highlight"><pre><a name="code--ex7--ex4.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex7--ex4.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex7--ex4.js-pyg.html-3"></a>
<a name="code--ex7--ex4.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex4.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex4.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex4.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex7--ex4.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex4.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex7--ex4.js-pyg.html-10"></a>
<a name="code--ex7--ex4.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mycountingdocuments&#39;</span><span class="p">);</span>
<a name="code--ex7--ex4.js-pyg.html-12"></a>  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<a name="code--ex7--ex4.js-pyg.html-13"></a>  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--ex7--ex4.js-pyg.html-14"></a>
<a name="code--ex7--ex4.js-pyg.html-15"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex4.js-pyg.html-16"></a>    <span class="nx">documents</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">i</span><span class="o">:</span><span class="nx">i</span><span class="p">});</span>
<a name="code--ex7--ex4.js-pyg.html-17"></a>  <span class="p">}</span>
<a name="code--ex7--ex4.js-pyg.html-18"></a>
<a name="code--ex7--ex4.js-pyg.html-19"></a>  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex4.js-pyg.html-20"></a>
<a name="code--ex7--ex4.js-pyg.html-21"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex7--ex4.js-pyg.html-22"></a>  <span class="p">});</span>
<a name="code--ex7--ex4.js-pyg.html-23"></a><span class="p">});</span>
</pre></div><p>Before running the code let's cleanup the collection to ensure we don't have any existing documents in the collection. Fire up the console and do the following to remove all the documents.</p>
<pre class="code console literal-block">
<span class="go">~ $ mongo
MongoDB shell version: 2.2
connecting to: test
</span><span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test
</span><span class="gp">&gt;</span> show collections
<span class="go">mycountingdocuments
mydocuments
system.indexes
</span><span class="gp">&gt;</span> db.mycountingdocuments.remove<span class="o">()</span>
<span class="gp">&gt;</span> db.mycountingdocuments.count<span class="o">()</span>
<span class="go">0</span>
</pre>
<p>Run the example above and verify that all the documents made it to the collection on MongoDB.</p>
<pre class="code console literal-block">
<span class="go">~ $ mongo
MongoDB shell version: 2.2
connecting to: test
</span><span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test
</span><span class="gp">&gt;</span> show collections
<span class="go">mycountingdocuments
mydocuments
system.indexes
</span><span class="gp">&gt;</span> db.mycountingdocuments.find<span class="o">()</span>.pretty<span class="o">()</span>
<span class="go">{ &quot;i&quot; : 0, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000001&quot;) }
{ &quot;i&quot; : 1, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000002&quot;) }
{ &quot;i&quot; : 5, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000006&quot;) }
{ &quot;i&quot; : 3, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000004&quot;) }
{ &quot;i&quot; : 4, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000005&quot;) }
{ &quot;i&quot; : 2, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000003&quot;) }
{ &quot;i&quot; : 9, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000a&quot;) }
{ &quot;i&quot; : 8, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000009&quot;) }
{ &quot;i&quot; : 6, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000007&quot;) }
{ &quot;i&quot; : 7, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000008&quot;) }
{ &quot;i&quot; : 10, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000b&quot;) }
{ &quot;i&quot; : 11, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000c&quot;) }
{ &quot;i&quot; : 12, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000d&quot;) }
{ &quot;i&quot; : 13, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000e&quot;) }
{ &quot;i&quot; : 14, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000f&quot;) }
{ &quot;i&quot; : 15, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000010&quot;) }
{ &quot;i&quot; : 16, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000011&quot;) }
{ &quot;i&quot; : 17, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000012&quot;) }
{ &quot;i&quot; : 18, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000013&quot;) }
{ &quot;i&quot; : 19, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000014&quot;) }
Type &quot;it&quot; for more
</span><span class="gp">&gt;</span> db.mycountingdocuments.count<span class="o">()</span>
<span class="go">100</span>
</pre>
<p>Awesome not hard right. Well what happens if there is a document with an error inbetween the <tt class="docutils literal">100</tt> documents we plan to insert. Well let's try it and see what happens. Enter the example below. Before running it clear out the collection as previously shown. When you run it you should see the following output.</p>
<pre class="code console literal-block">
<span class="go">connected to database
failed to perform bulk insert due to multiple documents havin the same _id field</span>
</pre>
<div class="highlight"><pre><a name="code--ex7--ex5.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex7--ex5.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex7--ex5.js-pyg.html-3"></a>
<a name="code--ex7--ex5.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex5.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex5.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex5.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex7--ex5.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex5.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex7--ex5.js-pyg.html-10"></a>
<a name="code--ex7--ex5.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mycountingdocuments&#39;</span><span class="p">);</span>
<a name="code--ex7--ex5.js-pyg.html-12"></a>  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[</span>
<a name="code--ex7--ex5.js-pyg.html-13"></a>      <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1000</span><span class="p">}</span>
<a name="code--ex7--ex5.js-pyg.html-14"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1001</span><span class="p">}</span>
<a name="code--ex7--ex5.js-pyg.html-15"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1000</span><span class="p">}</span>
<a name="code--ex7--ex5.js-pyg.html-16"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1002</span><span class="p">}</span>
<a name="code--ex7--ex5.js-pyg.html-17"></a>  <span class="p">];</span>
<a name="code--ex7--ex5.js-pyg.html-18"></a>
<a name="code--ex7--ex5.js-pyg.html-19"></a>  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex5.js-pyg.html-20"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex5.js-pyg.html-21"></a>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to perform bulk insert due to duplicate _id field&quot;</span><span class="p">)</span>
<a name="code--ex7--ex5.js-pyg.html-22"></a>    <span class="p">}</span>
<a name="code--ex7--ex5.js-pyg.html-23"></a>
<a name="code--ex7--ex5.js-pyg.html-24"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex7--ex5.js-pyg.html-25"></a>  <span class="p">});</span>
<a name="code--ex7--ex5.js-pyg.html-26"></a><span class="p">});</span>
</pre></div><p>Ok we got an error from MongoDB but what happened in the database. Did it finish inserting the documents or did it stop. Let's have a look in the db.</p>
<pre class="code console literal-block">
<span class="go">~ $ mongo
MongoDB shell version: 2.2
connecting to: test
</span><span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test
</span><span class="gp">&gt;</span> show collections
<span class="go">mycountingdocuments
mydocuments
system.indexes
</span><span class="gp">&gt;</span> db.mycountingdocuments.find<span class="o">()</span>.pretty<span class="o">()</span>
<span class="go">{ &quot;_id&quot; : 1000 }
{ &quot;_id&quot; : 1001 }</span>
</pre>
<p>As we can see MongoDB kept accepting the documents until we hit the document with the duplicate <tt class="docutils literal">_id</tt> value and then stopped and returned an error. But what if we want to make the inserts continue even if there is an error. Well it's also possible. Clear out the db, enter the code below and run it.</p>
<div class="highlight"><pre><a name="code--ex7--ex6.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex7--ex6.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex7--ex6.js-pyg.html-3"></a>
<a name="code--ex7--ex6.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex6.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex6.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex6.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex7--ex6.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex6.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex7--ex6.js-pyg.html-10"></a>
<a name="code--ex7--ex6.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mycountingdocuments&#39;</span><span class="p">);</span>
<a name="code--ex7--ex6.js-pyg.html-12"></a>  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[</span>
<a name="code--ex7--ex6.js-pyg.html-13"></a>      <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1000</span><span class="p">}</span>
<a name="code--ex7--ex6.js-pyg.html-14"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1001</span><span class="p">}</span>
<a name="code--ex7--ex6.js-pyg.html-15"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1000</span><span class="p">}</span>
<a name="code--ex7--ex6.js-pyg.html-16"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1002</span><span class="p">}</span>
<a name="code--ex7--ex6.js-pyg.html-17"></a>  <span class="p">];</span>
<a name="code--ex7--ex6.js-pyg.html-18"></a>
<a name="code--ex7--ex6.js-pyg.html-19"></a>  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="p">{</span><span class="nx">continueOnError</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex6.js-pyg.html-20"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex6.js-pyg.html-21"></a>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to perform bulk insert due to duplicate _id field&quot;</span><span class="p">)</span>
<a name="code--ex7--ex6.js-pyg.html-22"></a>    <span class="p">}</span>
<a name="code--ex7--ex6.js-pyg.html-23"></a>
<a name="code--ex7--ex6.js-pyg.html-24"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex7--ex6.js-pyg.html-25"></a>  <span class="p">});</span>
<a name="code--ex7--ex6.js-pyg.html-26"></a><span class="p">});</span>
</pre></div><p>Notice that we get the same ouput as the following example but let's have a look at what's in MongoDB now.</p>
<pre class="code console literal-block">
<span class="go">~ $ mongo
MongoDB shell version: 2.2
connecting to: test
</span><span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test
</span><span class="gp">&gt;</span> show collections
<span class="go">mycountingdocuments
mydocuments
system.indexes
</span><span class="gp">&gt;</span> db.mycountingdocuments.find<span class="o">()</span>.pretty<span class="o">()</span>
<span class="go">{ &quot;_id&quot; : 1000 }
{ &quot;_id&quot; : 1001 }
{ &quot;_id&quot; : 1002 }</span>
</pre>
<p>As we can see MongoDB did not stop inserting on the error but kept going inserting all the valid documents it could find. However one problem is that MongoDB is not currently able to tell us what specific document failed to insert so we need to programatically in our code. Let's see how we can identify what documents had the same <tt class="docutils literal">_id</tt> variable below. Clean out the collection, then enter and run the code below.</p>
<div class="highlight"><pre><a name="code--ex7--ex7.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex7--ex7.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex7--ex7.js-pyg.html-3"></a>
<a name="code--ex7--ex7.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex7.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex7.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-10"></a>
<a name="code--ex7--ex7.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mycountingdocuments&#39;</span><span class="p">);</span>
<a name="code--ex7--ex7.js-pyg.html-12"></a>  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<a name="code--ex7--ex7.js-pyg.html-13"></a>  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[</span>
<a name="code--ex7--ex7.js-pyg.html-14"></a>      <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1000</span><span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-15"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1001</span><span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-16"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1000</span><span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-17"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1002</span><span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-18"></a>  <span class="p">];</span>
<a name="code--ex7--ex7.js-pyg.html-19"></a>
<a name="code--ex7--ex7.js-pyg.html-20"></a>  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="p">{</span><span class="nx">continueOnError</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-21"></a>
<a name="code--ex7--ex7.js-pyg.html-22"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-23"></a>      <span class="kd">var</span> <span class="nx">ids</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--ex7--ex7.js-pyg.html-24"></a>      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">documents</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-25"></a>        <span class="nx">ids</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">documents</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">);</span>
<a name="code--ex7--ex7.js-pyg.html-26"></a>      <span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-27"></a>
<a name="code--ex7--ex7.js-pyg.html-28"></a>      <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="p">{</span><span class="nx">$in</span><span class="o">:</span> <span class="nx">ids</span><span class="p">}},</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">}).</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-29"></a>        <span class="kd">var</span> <span class="nx">docHash</span> <span class="o">=</span> <span class="p">{};</span>
<a name="code--ex7--ex7.js-pyg.html-30"></a>        <span class="kd">var</span> <span class="nx">docsNotFound</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--ex7--ex7.js-pyg.html-31"></a>
<a name="code--ex7--ex7.js-pyg.html-32"></a>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">docs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-33"></a>          <span class="nx">docHash</span><span class="p">[</span><span class="nx">docs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--ex7--ex7.js-pyg.html-34"></a>        <span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-35"></a>
<a name="code--ex7--ex7.js-pyg.html-36"></a>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">documents</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-37"></a>          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">docHash</span><span class="p">[</span><span class="nx">documents</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">])</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-38"></a>            <span class="nx">docsNotFound</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
<a name="code--ex7--ex7.js-pyg.html-39"></a>          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-40"></a>            <span class="nx">docHash</span><span class="p">[</span><span class="nx">documents</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<a name="code--ex7--ex7.js-pyg.html-41"></a>          <span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-42"></a>        <span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-43"></a>
<a name="code--ex7--ex7.js-pyg.html-44"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">docsNotFound</span><span class="p">);</span>
<a name="code--ex7--ex7.js-pyg.html-45"></a>      <span class="p">});</span>
<a name="code--ex7--ex7.js-pyg.html-46"></a>    <span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-47"></a>
<a name="code--ex7--ex7.js-pyg.html-48"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex7--ex7.js-pyg.html-49"></a>  <span class="p">});</span>
<a name="code--ex7--ex7.js-pyg.html-50"></a><span class="p">});</span>
</pre></div><p>This code is a bit complicated but the basic explanation is that after we try to do the bulk insert and it fails we retrieve all documents which has a <tt class="docutils literal">_id</tt> value equal to the documents we were trying to insert. We then create a hashmap of the <tt class="docutils literal">_id</tt> where each value is set to true. Iterating through our original documents if we find it in the hashmap we set the hashmap value to false indicating it's been seen by the application. Any other document in the <tt class="docutils literal">documents</tt> array will then trigger the condition <tt class="docutils literal"><span class="pre">!docHash[documents[i]._id]</span></tt> that will save the index in the <tt class="docutils literal">documents</tt> array to the <tt class="docutils literal">docsNotFound</tt> array. The <tt class="docutils literal">docsNotFound</tt> array will contain all the indexes of the documents that failed to insert during the bulk insert.</p>
<p>You might wonder what the <tt class="docutils literal">$in</tt> means and we will get into that in a later exercise. Sufficient to say for now that it's a asking MongoDB to return all documents where <tt class="docutils literal">_id</tt> is in the list of <tt class="docutils literal">_id's</tt> in the <tt class="docutils literal">ids</tt> array.</p>
<p>One thing to note is that you might get a duplicate key error on another field in your document, how to resolve this issue I leave as an exercise for you to figure out.</p>
</div>
<div class="section" id="save">
<h3><a class="toc-backref" href="#id32">Save</a></h3>
<p>If you've looked at the documentation for the driver you might have noticed there is a <tt class="docutils literal">save</tt> function on the <tt class="docutils literal">collection</tt> object. From the beginning this might look like a resonable method to use to save your document. If this document already exists (it matches it by the <tt class="docutils literal">_id</tt>) it will replace the entire document. We will go through why this is non optimial later when we talk about updates but I'll give you a hint. Why replace the whole document if you only want to change a single field ? There are some other side effects of full document replacement that we will highlight later.</p>
<p>But for now let's move on to the next exercise which is about one of the most interesting features of MongoDB the ability to specify the durability concern for your application.</p>
</div>
</div>
<div class="section" id="exercise-8-write-concerns">
<h2><a class="toc-backref" href="#id33">Exercise 8: Write Concerns</a></h2>
<p>Remember we briefly mentioned something called <tt class="docutils literal">write concerns</tt> earlier when we introduced the option <tt class="docutils literal">w:0</tt> on the insert. Write concerns is one of the more crucial concepts to understand when using MongoDB. They allow you to set the guarantee of persitance that you want for your documents. This means you can set your app to wait for MongoDB to save the document to memory, disk or send it over to other members in a cluster (more on clusters later). At one end of the spectrum is <tt class="docutils literal">w:0</tt> which means no <tt class="docutils literal">acknowledgement</tt> from MongoDB. This means the driver does not ask MongoDB if the write succeded or not (fire and forget). You application will never know if the data was correctly written to MongoDB unless you attempt to retrieve the data later. This might now sound like a good idea but it comes with one good upside, namely raw insert performance. Let's say you are inserting analytical data from a mouse tracking application. The analytics might be all about aggregation so a single missing data point does not matter but the insert speed does. So to avoid that the application has to wait for an acknowledgement from MongoDB you set <tt class="docutils literal">w:0</tt> and don't incur the cost of the acknowledgement.</p>
<p>So what kind of values can write concerns be and what do they mean. Below is a table outlining the write concerns and what they mean.</p>
<table border="1" class="docutils">
<colgroup>
<col width="6%" />
<col width="94%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">WriteConcern</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>w:0</td>
<td>No acknowlegement of the write from MongoDB</td>
</tr>
<tr><td>w:1</td>
<td>MongoDB acknowleges when the document has been safely written to memory</td>
</tr>
<tr><td>w:2 or larger</td>
<td>MongoDB acknowleges when the document has been safely written to memory in N servers</td>
</tr>
<tr><td>w:'majority'</td>
<td>MongoDB acknowleges when the document has been safely written to memory in a majority of servers (f.ex if you have 1 primary and 4 secondaries this would be 3 servers as 3 out of 5 is a majority of servers)</td>
</tr>
<tr><td>j:true</td>
<td>MongoDB acknowleges when the document has been safely written to the MongoDB journal</td>
</tr>
<tr><td>fsync:true</td>
<td>MongoDB acknowleges when the document has been safely written to disk</td>
</tr>
</tbody>
</table>
<p>Quite a bit of new terminology. Let's look through the different write concerns and explain what they mean. I will introduce the concept of a <tt class="docutils literal">replicaset</tt> here but only as a concept as we will go more indepth in later exercises. In short a <tt class="docutils literal">replicaset</tt> is a MongoDB cluster that in the simplest form concists of a <tt class="docutils literal">primary</tt> which accepts writes (inserts/update/removes) and one or more <tt class="docutils literal">secondaries</tt> that only accept reads (queries).</p>
<p>Let's look at how MongoDB actually works under the cover when you want to ackowledge an insert. The first thing we need to understand is that MongoDB seperates the writing of the data from the ackowledgement. They are in fact two different commands. So when the driver does a non ackowledge write using <tt class="docutils literal">w:0</tt> it only sends the write command. If your application needs written to memory ackowledgement with <tt class="docutils literal">w:1</tt> it will send a write command and a <tt class="docutils literal">getLastError</tt> command together.</p>
<p>The <tt class="docutils literal">getLastError</tt> command is the command that returns the the status of the last executed operation on a specific socket. It will wait until the specified write concern is fulfilled. Let's try it ourselves. Let's fire up the <tt class="docutils literal">mongo</tt> console.</p>
<pre class="code console literal-block">
<span class="go">~ $ mongo
MongoDB shell version: 2.2
connecting to: test
</span><span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test
</span><span class="gp">&gt;</span> db.getlasterrortest.insert<span class="o">({</span>_id: 1<span class="o">})</span>
<span class="gp">&gt;</span> db.getlasterrortest.insert<span class="o">({</span>_id: 1<span class="o">})</span>
<span class="go">E11000 duplicate key error index: test.getlasterrortest.$_id_  dup key: { : 1.0 }
</span><span class="gp">&gt;</span> db.getLastError<span class="o">()</span>
<span class="go">E11000 duplicate key error index: test.getlasterrortest.$_id_  dup key: { : 1.0 }
</span><span class="gp">&gt;</span> db.getlasterrortest.insert<span class="o">({</span>_id: 2<span class="o">})</span>
<span class="gp">&gt;</span> db.getLastError<span class="o">()</span>
<span class="go">null</span>
</pre>
<p>As we can see the <tt class="docutils literal">getLastError</tt> returns the last command status for our connection. Once we insert a new record with no error <tt class="docutils literal">getLastError</tt> returns <tt class="docutils literal">null</tt>.</p>
<p>So let's play with the write concerns in a bit of code. Get your editor and start typing.</p>
<div class="highlight"><pre><a name="code--ex8--ex1.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex8--ex1.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex8--ex1.js-pyg.html-3"></a>
<a name="code--ex8--ex1.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex1.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex1.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex8--ex1.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex8--ex1.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex8--ex1.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex8--ex1.js-pyg.html-10"></a>
<a name="code--ex8--ex1.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;playing_with_write_concerns&#39;</span><span class="p">);</span>
<a name="code--ex8--ex1.js-pyg.html-12"></a>  <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
<a name="code--ex8--ex1.js-pyg.html-13"></a>
<a name="code--ex8--ex1.js-pyg.html-14"></a>  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex1.js-pyg.html-15"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;time w:0 ~ &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">start</span><span class="p">))</span>
<a name="code--ex8--ex1.js-pyg.html-16"></a>
<a name="code--ex8--ex1.js-pyg.html-17"></a>    <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex1.js-pyg.html-18"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex1.js-pyg.html-19"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Duplicate document&quot;</span><span class="p">)</span>
<a name="code--ex8--ex1.js-pyg.html-20"></a>      <span class="p">}</span>
<a name="code--ex8--ex1.js-pyg.html-21"></a>
<a name="code--ex8--ex1.js-pyg.html-22"></a>      <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex1.js-pyg.html-23"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex1.js-pyg.html-24"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Duplicate document&quot;</span><span class="p">)</span>
<a name="code--ex8--ex1.js-pyg.html-25"></a>        <span class="p">}</span>
<a name="code--ex8--ex1.js-pyg.html-26"></a>
<a name="code--ex8--ex1.js-pyg.html-27"></a>        <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
<a name="code--ex8--ex1.js-pyg.html-28"></a>
<a name="code--ex8--ex1.js-pyg.html-29"></a>        <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex1.js-pyg.html-30"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;time w:1 ~ &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">start</span><span class="p">))</span>
<a name="code--ex8--ex1.js-pyg.html-31"></a>
<a name="code--ex8--ex1.js-pyg.html-32"></a>          <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
<a name="code--ex8--ex1.js-pyg.html-33"></a>
<a name="code--ex8--ex1.js-pyg.html-34"></a>          <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="nx">j</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex1.js-pyg.html-35"></a>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;time j:true ~ &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">start</span><span class="p">))</span>
<a name="code--ex8--ex1.js-pyg.html-36"></a>
<a name="code--ex8--ex1.js-pyg.html-37"></a>            <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="nx">j</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex1.js-pyg.html-38"></a>              <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex1.js-pyg.html-39"></a>                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Duplicate document&quot;</span><span class="p">)</span>
<a name="code--ex8--ex1.js-pyg.html-40"></a>              <span class="p">}</span>
<a name="code--ex8--ex1.js-pyg.html-41"></a>
<a name="code--ex8--ex1.js-pyg.html-42"></a>              <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
<a name="code--ex8--ex1.js-pyg.html-43"></a>
<a name="code--ex8--ex1.js-pyg.html-44"></a>              <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="nx">fsync</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex1.js-pyg.html-45"></a>                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;time fsync:true ~ &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">start</span><span class="p">))</span>
<a name="code--ex8--ex1.js-pyg.html-46"></a>
<a name="code--ex8--ex1.js-pyg.html-47"></a>                <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="nx">fsync</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex1.js-pyg.html-48"></a>                  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex1.js-pyg.html-49"></a>                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Duplicate document&quot;</span><span class="p">)</span>
<a name="code--ex8--ex1.js-pyg.html-50"></a>                  <span class="p">}</span>
<a name="code--ex8--ex1.js-pyg.html-51"></a>
<a name="code--ex8--ex1.js-pyg.html-52"></a>                  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex8--ex1.js-pyg.html-53"></a>                <span class="p">});</span>
<a name="code--ex8--ex1.js-pyg.html-54"></a>              <span class="p">});</span>
<a name="code--ex8--ex1.js-pyg.html-55"></a>            <span class="p">});</span>
<a name="code--ex8--ex1.js-pyg.html-56"></a>          <span class="p">});</span>
<a name="code--ex8--ex1.js-pyg.html-57"></a>        <span class="p">});</span>
<a name="code--ex8--ex1.js-pyg.html-58"></a>      <span class="p">});</span>
<a name="code--ex8--ex1.js-pyg.html-59"></a>    <span class="p">});</span>
<a name="code--ex8--ex1.js-pyg.html-60"></a>  <span class="p">});</span>
<a name="code--ex8--ex1.js-pyg.html-61"></a><span class="p">});</span>
</pre></div><p>When I run it on my local machine the output looks something like.</p>
<pre class="code console literal-block">
<span class="go">connected to database
time w:0 ~ 0
Duplicate document
time w:1 ~ 0
time j:true ~ 31
Duplicate document
time fsync:true ~ 35
Duplicate document</span>
</pre>
<p>Let's look at the usage of the write concerns. We are doing 4 different types in this code. The first one is <tt class="docutils literal">w:0</tt>, the second one is <tt class="docutils literal">w:1</tt> the third <tt class="docutils literal">j:true</tt> and the last one <tt class="docutils literal">fsync:true</tt>. Note that when we try to insert a duplicate document using <tt class="docutils literal">w:0</tt> we don't recieve any error message back as we are not sending the <tt class="docutils literal">getLastError</tt> command to the MongoDB server. Once we use <tt class="docutils literal">w:1, j:true or fsync:true</tt> we get an error message back when we try to insert a duplicate document. The example also calculates the time it took to insert a document when using <tt class="docutils literal">w:0, w:1, j:true, fsync:true</tt> and as we can see there is a marked jump in time take from <tt class="docutils literal">w:1</tt> to <tt class="docutils literal">j:true</tt> and <tt class="docutils literal">fsync:true</tt>. This is because when you put <tt class="docutils literal">j:true</tt> <tt class="docutils literal">getLastError</tt> waits for the document to be written to the MongoDB <tt class="docutils literal">journal</tt>. The <tt class="docutils literal">journal</tt> flushes to disk every <tt class="docutils literal">100</tt> ms so in the worst case it will take <tt class="docutils literal">100</tt> miliseconds before you get an acknowledgement but most likely it will be less than <tt class="docutils literal">100</tt> miliseconds. However if you wait for <tt class="docutils literal">j:true</tt> you have a guarantee that you can recover the data if the MongoDB database should crash.</p>
<p>For <tt class="docutils literal">fsync:true</tt> the server needs to write the document to memory and then write that memory to disk which can be quite slow depending on how much data MongoDB has to write and what kind of disk you have (SSD or HD). Safe to say you should avoid <tt class="docutils literal">fsync:true</tt> if possible.</p>
<p>We can see that <tt class="docutils literal">w:1</tt> is close to <tt class="docutils literal">w:0</tt> and this will for the most part be true. There are some corner cases where this is not true and that is if MongoDB has to make some space in memory before it can write the document. In this case it might take longer as it needs to be shuffle memory around to make some space for the new document. Some of the more observant might point out that <tt class="docutils literal">w:0</tt> cannot be measures as it does not perform a <tt class="docutils literal">getLastError</tt>. That's very true but it still shows that there is little difference between <tt class="docutils literal">w:0</tt> and <tt class="docutils literal">w:1</tt> when it comes to general performance.</p>
<div class="section" id="problems-in-paradise">
<h3><a class="toc-backref" href="#id34">Problems In Paradise</a></h3>
<p>So one of the traps you can fall into is that you decide to do all the inserts using <tt class="docutils literal">w:0</tt> only to discover that you run out of memory on huge inserts of documents. This happens because Node.js is capable of processing more documents for insert than MongoDB and your network can handle so they back up in the socket buffers until you run out of memory. Or you find that you are writing so much to MongoDB that is has problems responding to other operations.</p>
<p>Luckily there is a way to control the flow of the inserts and the clue lies in <tt class="docutils literal">getLastError</tt>. Let's type in the example below and have a look at how the flow control works.</p>
<div class="highlight"><pre><a name="code--ex8--ex2.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex8--ex2.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex8--ex2.js-pyg.html-3"></a>
<a name="code--ex8--ex2.js-pyg.html-4"></a><span class="kd">var</span> <span class="nx">batch</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">documents</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex2.js-pyg.html-5"></a>  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="nx">documents</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<a name="code--ex8--ex2.js-pyg.html-6"></a>
<a name="code--ex8--ex2.js-pyg.html-7"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">documents</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex2.js-pyg.html-8"></a>    <span class="kd">var</span> <span class="nx">writeConcern</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">==</span> <span class="nx">documents</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span><span class="mi">1</span><span class="p">}</span> <span class="o">:</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span><span class="mi">0</span><span class="p">};</span>
<a name="code--ex8--ex2.js-pyg.html-9"></a>
<a name="code--ex8--ex2.js-pyg.html-10"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">writeConcern</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex2.js-pyg.html-11"></a>      <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="code--ex8--ex2.js-pyg.html-12"></a>
<a name="code--ex8--ex2.js-pyg.html-13"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex2.js-pyg.html-14"></a>        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a name="code--ex8--ex2.js-pyg.html-15"></a>      <span class="p">}</span>
<a name="code--ex8--ex2.js-pyg.html-16"></a>    <span class="p">});</span>
<a name="code--ex8--ex2.js-pyg.html-17"></a>  <span class="p">}</span>
<a name="code--ex8--ex2.js-pyg.html-18"></a><span class="p">}</span>
<a name="code--ex8--ex2.js-pyg.html-19"></a>
<a name="code--ex8--ex2.js-pyg.html-20"></a><span class="kd">var</span> <span class="nx">runBatches</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">batchSize</span><span class="p">,</span> <span class="nx">numberOfBatches</span><span class="p">,</span> <span class="nx">documents</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex2.js-pyg.html-21"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">numberOfBatches</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">();</span>
<a name="code--ex8--ex2.js-pyg.html-22"></a>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;number of batches left = &quot;</span> <span class="o">+</span> <span class="nx">numberOfBatches</span><span class="p">);</span>
<a name="code--ex8--ex2.js-pyg.html-23"></a>
<a name="code--ex8--ex2.js-pyg.html-24"></a>  <span class="nx">batch</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">documents</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">batchSize</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex2.js-pyg.html-25"></a>    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex8--ex2.js-pyg.html-26"></a>      <span class="nx">runBatches</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">batchSize</span><span class="p">,</span> <span class="nx">numberOfBatches</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">documents</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--ex8--ex2.js-pyg.html-27"></a>    <span class="p">});</span>
<a name="code--ex8--ex2.js-pyg.html-28"></a>  <span class="p">});</span>
<a name="code--ex8--ex2.js-pyg.html-29"></a><span class="p">}</span>
<a name="code--ex8--ex2.js-pyg.html-30"></a>
<a name="code--ex8--ex2.js-pyg.html-31"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex2.js-pyg.html-32"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex2.js-pyg.html-33"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex8--ex2.js-pyg.html-34"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex8--ex2.js-pyg.html-35"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex8--ex2.js-pyg.html-36"></a>  <span class="p">}</span>
<a name="code--ex8--ex2.js-pyg.html-37"></a>
<a name="code--ex8--ex2.js-pyg.html-38"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mybatchdocs&#39;</span><span class="p">);</span>
<a name="code--ex8--ex2.js-pyg.html-39"></a>  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--ex8--ex2.js-pyg.html-40"></a>  <span class="kd">var</span> <span class="nx">batchSize</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
<a name="code--ex8--ex2.js-pyg.html-41"></a>  <span class="kd">var</span> <span class="nx">numberOfDocuments</span> <span class="o">=</span> <span class="mi">100005</span><span class="p">;</span>
<a name="code--ex8--ex2.js-pyg.html-42"></a>  <span class="kd">var</span> <span class="nx">numberOfBatches</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">numberOfDocuments</span> <span class="o">/</span> <span class="nx">batchSize</span><span class="p">);</span>
<a name="code--ex8--ex2.js-pyg.html-43"></a>  <span class="kd">var</span> <span class="nx">leftOverDocuments</span> <span class="o">=</span> <span class="nx">numberOfDocuments</span> <span class="o">%</span> <span class="nx">batchSize</span><span class="p">;</span>
<a name="code--ex8--ex2.js-pyg.html-44"></a>
<a name="code--ex8--ex2.js-pyg.html-45"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">numberOfDocuments</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex2.js-pyg.html-46"></a>    <span class="nx">documents</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">i</span><span class="o">:</span><span class="nx">i</span><span class="p">});</span>
<a name="code--ex8--ex2.js-pyg.html-47"></a>  <span class="p">}</span>
<a name="code--ex8--ex2.js-pyg.html-48"></a>
<a name="code--ex8--ex2.js-pyg.html-49"></a>  <span class="nx">runBatches</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">batchSize</span><span class="p">,</span> <span class="nx">numberOfBatches</span><span class="p">,</span> <span class="nx">documents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex2.js-pyg.html-50"></a>
<a name="code--ex8--ex2.js-pyg.html-51"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">leftOverDocuments</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex8--ex2.js-pyg.html-52"></a>
<a name="code--ex8--ex2.js-pyg.html-53"></a>    <span class="nx">batch</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">documents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex2.js-pyg.html-54"></a>      <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex8--ex2.js-pyg.html-55"></a>    <span class="p">});</span>
<a name="code--ex8--ex2.js-pyg.html-56"></a>  <span class="p">});</span>
<a name="code--ex8--ex2.js-pyg.html-57"></a><span class="p">});</span>
</pre></div><p>The first part of the code after the <tt class="docutils literal">MongoClient.connect</tt> is to generate an array of documents (in this case <tt class="docutils literal">100005</tt> documents). After creating the documents we calculate the number of batches needed when the batchsize is <tt class="docutils literal">1000</tt>. And after getting the right number of batches we use the <tt class="docutils literal">modulo operator %</tt> in the statement <tt class="docutils literal">var leftOverDocuments = numberOfDocuments % batchSize;</tt> to determine how many documents are left outside the batches. In this case the number of batches are <tt class="docutils literal">100</tt> and the left over number of documents <tt class="docutils literal">5</tt></p>
<p>We then call the <tt class="docutils literal">runBatches</tt> function with the collection, batchSize, numberOfBatches and documents. The <tt class="docutils literal">runBatches</tt> function calls the <tt class="docutils literal">batch</tt> function that inserts <tt class="docutils literal">999</tt> with the write concern <tt class="docutils literal">w:0</tt> and then the last one of the <tt class="docutils literal">1000</tt> with the write concern <tt class="docutils literal">w:1</tt>. Once the <tt class="docutils literal">batch</tt> function finishes we call <tt class="docutils literal">runBatches</tt> again with <tt class="docutils literal">numberOfBatches - 1</tt> until <tt class="docutils literal">numberOfBatches</tt> equals <tt class="docutils literal">0</tt> (notice that we call <tt class="docutils literal">numberOfBatches</tt> using <tt class="docutils literal">process.nextTick()</tt> to make sure we don't run out of stack space). After the batch inserts are done we check if we have any left over documents and do a final <tt class="docutils literal">batch</tt> insert with any leftover documents.</p>
<p>The benefit of this is that we are inserting <tt class="docutils literal">1000</tt> documents and for each <tt class="docutils literal">1000</tt> documents we are doing a write concern of <tt class="docutils literal">w:1</tt> to let MongoDB catch up. This lets us throttle the insert rate, get the benefit of no ackowledgement using <tt class="docutils literal">w:0</tt> but at the same time avoiding overflowing the socket buffers.</p>
</div>
<div class="section" id="setting-default-write-concern">
<h3><a class="toc-backref" href="#id35">Setting Default Write Concern</a></h3>
<p>The Node.js driver lets you set the default write concern at different levels. <tt class="docutils literal">MongoClient</tt> already comes with the default write concern set to <tt class="docutils literal">w:1</tt> but your application can set it at the <tt class="docutils literal">Db</tt>, <tt class="docutils literal">Collection</tt> or individual operation. Let's enter some example code showing how to set it at different levels.</p>
<div class="highlight"><pre><a name="code--ex8--ex3.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex8--ex3.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex8--ex3.js-pyg.html-3"></a>
<a name="code--ex8--ex3.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test?w=0&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex3.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex3.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex8--ex3.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex8--ex3.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex8--ex3.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex8--ex3.js-pyg.html-10"></a>
<a name="code--ex8--ex3.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;my_write_concern_docs&#39;</span><span class="p">);</span>
<a name="code--ex8--ex3.js-pyg.html-12"></a>
<a name="code--ex8--ex3.js-pyg.html-13"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">});</span>
<a name="code--ex8--ex3.js-pyg.html-14"></a>
<a name="code--ex8--ex3.js-pyg.html-15"></a>  <span class="kd">var</span> <span class="nx">collectionWithWriteConcernSet</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;my_write_concern_docs&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span><span class="mi">1</span><span class="p">});</span>
<a name="code--ex8--ex3.js-pyg.html-16"></a>
<a name="code--ex8--ex3.js-pyg.html-17"></a>  <span class="nx">collectionWithWriteConcernSet</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex3.js-pyg.html-18"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex3.js-pyg.html-19"></a>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;write concern on collection caught duplicate key error&quot;</span><span class="p">);</span>
<a name="code--ex8--ex3.js-pyg.html-20"></a>    <span class="p">}</span>
<a name="code--ex8--ex3.js-pyg.html-21"></a>
<a name="code--ex8--ex3.js-pyg.html-22"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">j</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex3.js-pyg.html-23"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex8--ex3.js-pyg.html-24"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;write concern on collection caught duplicate key error&quot;</span><span class="p">);</span>
<a name="code--ex8--ex3.js-pyg.html-25"></a>      <span class="p">}</span>
<a name="code--ex8--ex3.js-pyg.html-26"></a>
<a name="code--ex8--ex3.js-pyg.html-27"></a>      <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex8--ex3.js-pyg.html-28"></a>    <span class="p">});</span>
<a name="code--ex8--ex3.js-pyg.html-29"></a>  <span class="p">});</span>
<a name="code--ex8--ex3.js-pyg.html-30"></a><span class="p">});</span>
</pre></div><p>When you run the script the output should look something like this.</p>
<pre class="code console literal-block">
<span class="go">connected to database
write concern on collection caught duplicate key error
write concern on collection caught duplicate key error</span>
</pre>
<p>Let's dissect the code and look at how it works. The first insert is the <tt class="docutils literal"><span class="pre">collection.insert({_id:1})</span></tt> when we connected to the db we used the connection string <tt class="docutils literal"><span class="pre">mongodb://localhost:27017/test?w=0</span></tt> where <tt class="docutils literal">w=0</tt> means no ackowledgement by default. This is inherited by the collection when we do <tt class="docutils literal">var collection = <span class="pre">db.collection('my_write_concern_docs');</span></tt> meaning that the first insert is done with <tt class="docutils literal">w:0</tt>. The second insert shows how we can override the default write concern set for the database for a collection. <tt class="docutils literal">var collectionWithWriteConcernSet = <span class="pre">db.collection('my_write_concern_docs',</span> <span class="pre">{w:1});</span></tt> creates a new collection object where all operations will default to <tt class="docutils literal">w:1</tt>. This causes the insert to fail as we try to insert a duplicate document. The last insert shows how we can override the write concern on an individual insert operation. In this case we take the <tt class="docutils literal">collection</tt> variable which has the default write concern <tt class="docutils literal">w:0</tt> and override it for the insert to be <tt class="docutils literal">j:true</tt> by doing <tt class="docutils literal"><span class="pre">collection.insert({_id:1},</span> {j:true}, <span class="pre">.......</span></tt>.</p>
<p>As we can see write concerns can be specified at the <tt class="docutils literal">Db</tt>, <tt class="docutils literal">Collection</tt> and the individual operation level and if not set the individual operation inherits from the <tt class="docutils literal">Collection</tt> settings while the <tt class="docutils literal">Collection</tt> inherits the write concern from the <tt class="docutils literal">Db</tt> if not set.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal">Replicasets</tt> and write concerns will be covered in later exercises. One of the things to keep in mind about write concerns is that the cost of higher guarantees of durability comes with an insert performance cost. So think carefully if you need your documents to be replicated across multiple <tt class="docutils literal">secondaries</tt> or if you are good enough with them being ackowledged as written to the memory of the <tt class="docutils literal">primary</tt> server. A typical mistake is to be to paranoid about losing data and setting the highest possible durability you can do and getting very bad insert performance as a consequence.</p>
</div>
</div>
</div>
<div class="section" id="exercise-9-update-basics">
<h2><a class="toc-backref" href="#id36">Exercise 9: Update Basics</a></h2>
<p>In the previous exercises we learned how to insert documents into MongoDB and what a write concern is. We also learned why <tt class="docutils literal">.save()</tt> is not a good way of saving your documents and how bulk inserts work. We've managed to get all those documents into MongoDB but now we find we need to update some of the fields. In this exercise we will focus on the basic operations to change your documents in MongoDB and in the next exercise on the more advanced ways to modify your existing documents.</p>
<p>Lets start with a simple insert and full document update and explain why this in general is a bad idea. Fire up the editor and type in the following code.</p>
<div class="highlight"><pre><a name="code--ex9--ex1.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex9--ex1.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex9--ex1.js-pyg.html-3"></a>
<a name="code--ex9--ex1.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex1.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex1.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex9--ex1.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex9--ex1.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex9--ex1.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex9--ex1.js-pyg.html-10"></a>
<a name="code--ex9--ex1.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;my_basic_update_documents&#39;</span><span class="p">);</span>
<a name="code--ex9--ex1.js-pyg.html-12"></a>
<a name="code--ex9--ex1.js-pyg.html-13"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">a</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex1.js-pyg.html-14"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex1.js-pyg.html-15"></a>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;write concern on collection caught duplicate key error&quot;</span><span class="p">);</span>
<a name="code--ex9--ex1.js-pyg.html-16"></a>    <span class="p">}</span>
<a name="code--ex9--ex1.js-pyg.html-17"></a>
<a name="code--ex9--ex1.js-pyg.html-18"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex1.js-pyg.html-19"></a>
<a name="code--ex9--ex1.js-pyg.html-20"></a>      <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex9--ex1.js-pyg.html-21"></a>    <span class="p">});</span>
<a name="code--ex9--ex1.js-pyg.html-22"></a>  <span class="p">});</span>
<a name="code--ex9--ex1.js-pyg.html-23"></a><span class="p">});</span>
</pre></div><p>We first insert a document with the values <tt class="docutils literal">{_id: 1, a:1}</tt> then after it inserted we do an update statement</p>
<pre class="code javascript literal-block">
<span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="p">);</span>
<span class="p">});</span>
</pre>
<p>The update statement is made up of two different objects. The first part is the query to match locate the document we wish to change <tt class="docutils literal">{_id:1}</tt> and the second object is the way we wish to change the document. In this case we are passing in the document <tt class="docutils literal">{_id:1, b:1}</tt> which will replace the existing document with the new one. Let's see what's in the database. Let's fire up mongo.</p>
<pre class="code console literal-block">
<span class="go">~ $ mongo
MongoDB shell version: 2.2
connecting to: test
</span><span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test
</span><span class="gp">&gt;</span> db.my_basic_update_documents.find<span class="o">()</span>
<span class="go">{ &quot;_id&quot; : 1, &quot;b&quot; : 1 }</span>
</pre>
<p>As we can see the whole document <tt class="docutils literal">{_id: 1, a:1}</tt> was replaced. This can cause some issues. Imagine that there are several applications trying to modify the same document. Each <tt class="docutils literal">update</tt> would overwrite any changes in the document meaning we would loose all changes but the last update. This is what the <tt class="docutils literal">collection.save()</tt> function does. There is also a problem of efficiency. When we save the whole document we need to transfer the whole document to MongoDB even if we only want to change one field. This is less than optimial as we can imagine especially if we have a large document. Luckily we don't have to do that and we can also avoid the problem of overwritting any existing changes in a document. We do this using special operators called <tt class="docutils literal">atomic</tt> operators.</p>
<div class="section" id="atomic-operators">
<h3><a class="toc-backref" href="#id37">Atomic Operators</a></h3>
<p>Let's start with the basics of what an Atomic operator is. To do this let's imagine that we have a document that looks like this.</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>
</pre>
<p>Now let's imagine that two different applications wish to change the value by incrementing it by one. The end result should be <tt class="docutils literal">3</tt>. To make sure that <tt class="docutils literal">value</tt> is incremented correctly we need to ensure that only one of the two applications can change the the <tt class="docutils literal">value</tt> at any given time. Otherwise both applications might read the <tt class="docutils literal">value</tt> to be incremented at the same time and increment it from <tt class="docutils literal">1</tt> to <tt class="docutils literal">2</tt>. The property of ensuring only one application can change the value at a time is called an atomic operation. The second benefit of atomic operators is that we are changing are only sending the changes to MongoDB not the whole document so the amount of information that needs to be sent over the network is smaller and MongoDB can in most cases update the document where it is in memory without having to move the document to a new location on the Database.</p>
<p>So what kind of operators does MongoDB have that are atomic.</p>
<table border="1" class="docutils">
<colgroup>
<col width="9%" />
<col width="7%" />
<col width="84%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Operator</th>
<th class="head">Operates On</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>$set</td>
<td>Field</td>
<td>Set a particular field in the document</td>
</tr>
<tr><td>$unset</td>
<td>Field</td>
<td>Remove a particular field from the document</td>
</tr>
<tr><td>$inc</td>
<td>Field</td>
<td>Increments a numeric field by the provided value and sets it to the provided value if the field does not exist</td>
</tr>
<tr><td>$rename</td>
<td>Field</td>
<td>Renames a field or overwrites the existing field with the new field</td>
</tr>
<tr><td>$</td>
<td>Array</td>
<td>Updates an element in an array field to update without specifiying the exact position. Acts as a placeholder for the first match.</td>
</tr>
<tr><td>$push</td>
<td>Array</td>
<td>Appends a value to an array, if the array does not exist it gets created.</td>
</tr>
<tr><td>$pushAll</td>
<td>Array</td>
<td>Works as $push but lets you push multiple values to the array</td>
</tr>
<tr><td>$addToSet</td>
<td>Array</td>
<td>Only adds the value to the array if it does not already exist</td>
</tr>
<tr><td>$pop</td>
<td>Array</td>
<td>Pop the last element off the array or shift the first element of the array</td>
</tr>
<tr><td>$pull</td>
<td>Array</td>
<td>Removes all instances of a value from an array</td>
</tr>
<tr><td>$pullAll</td>
<td>Array</td>
<td>Removes all instances of the list of values passed from an array</td>
</tr>
<tr><td>$bit</td>
<td>Bitwise</td>
<td>Perform a bitwise operation on a field, letting you do bitmapped files for compact storing of flags etc.</td>
</tr>
</tbody>
</table>
<p>Since <tt class="docutils literal">atomic</tt> operations are only guaranteed for one of these operations at a time MongoDB also has a special operator called <tt class="docutils literal">$isolated</tt> that will guarantee that multiple <tt class="docutils literal">atomic</tt> operations in an update happen without changes being applied by other applications during it's execution.</p>
<p>That's a lot to take in so in this exercise we are going to just focus on the field and bitwise operators and leave the array operators for the next exercise.</p>
</div>
<div class="section" id="set-unset-operators">
<h3><a class="toc-backref" href="#id38">$set/$unset Operators</a></h3>
<p>Let's have a look at the <tt class="docutils literal">$set</tt>. For this exercise we will also use a method called <tt class="docutils literal">collection.findOne()</tt> to retrieve the document and allow us to print it out to see the changes instead of using the <tt class="docutils literal">mongo</tt> console. Also notice that we are removing all the documents from the collection before starting using the <tt class="docutils literal">collection.remove()</tt> method. Fire up the editor and enter the code below.</p>
<div class="highlight"><pre><a name="code--ex9--ex3.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex9--ex3.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex9--ex3.js-pyg.html-3"></a>
<a name="code--ex9--ex3.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex3.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex3.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex9--ex3.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex9--ex3.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex9--ex3.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex9--ex3.js-pyg.html-10"></a>
<a name="code--ex9--ex3.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;my_basic_update_documents&#39;</span><span class="p">);</span>
<a name="code--ex9--ex3.js-pyg.html-12"></a>
<a name="code--ex9--ex3.js-pyg.html-13"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex9--ex3.js-pyg.html-14"></a>
<a name="code--ex9--ex3.js-pyg.html-15"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex3.js-pyg.html-16"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex3.js-pyg.html-17"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;write concern on collection caught duplicate key error&quot;</span><span class="p">);</span>
<a name="code--ex9--ex3.js-pyg.html-18"></a>      <span class="p">}</span>
<a name="code--ex9--ex3.js-pyg.html-19"></a>
<a name="code--ex9--ex3.js-pyg.html-20"></a>      <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="nx">$unset</span><span class="o">:</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">full_result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex3.js-pyg.html-21"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;updated &quot;</span> <span class="o">+</span> <span class="nx">result</span> <span class="o">+</span> <span class="s2">&quot; number of documents&quot;</span><span class="p">);</span>
<a name="code--ex9--ex3.js-pyg.html-22"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">full_result</span><span class="p">);</span>
<a name="code--ex9--ex3.js-pyg.html-23"></a>
<a name="code--ex9--ex3.js-pyg.html-24"></a>        <span class="nx">collection</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex3.js-pyg.html-25"></a>
<a name="code--ex9--ex3.js-pyg.html-26"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
<a name="code--ex9--ex3.js-pyg.html-27"></a>
<a name="code--ex9--ex3.js-pyg.html-28"></a>          <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex9--ex3.js-pyg.html-29"></a>        <span class="p">});</span>
<a name="code--ex9--ex3.js-pyg.html-30"></a>      <span class="p">});</span>
<a name="code--ex9--ex3.js-pyg.html-31"></a>    <span class="p">});</span>
<a name="code--ex9--ex3.js-pyg.html-32"></a>  <span class="p">});</span>
<a name="code--ex9--ex3.js-pyg.html-33"></a><span class="p">});</span>
</pre></div><p>Run the code in the console and you should see the following ouput</p>
<pre class="code console literal-block">
<span class="go">connected to database
updated 1 number of documents
{ updatedExisting: true, n: 1, connectionId: 55, err: null, ok: 1 }
{ _id: 2, value: 2 }</span>
</pre>
<p>Let's dissect the code we just ran. The <tt class="docutils literal">collection.remove()</tt> function does what name implies. It removes all the documents in the collection. This is just done so it will be a bit easier to run the example multiple times as we can avoid the duplicate document errors. The next operation <tt class="docutils literal">collection.insert()</tt> should be familiar by now. It inserts a document containing <tt class="docutils literal">{_id:2, value:1}</tt> in the collection. The following operation is what we are interested in here. <tt class="docutils literal"><span class="pre">collection.update({_id:</span> 2}, {$set: {value: <span class="pre">2}},</span> function(err, result) {})</tt>. The first part of the <tt class="docutils literal">update</tt> operation <tt class="docutils literal">{_id: 2}</tt> matches the first document where <tt class="docutils literal">_id: 2</tt>. Note <tt class="docutils literal">changes the first document matched</tt>, if you have two documents with the same field you are matching on it will not change both just the first one it finds which which might not be consistent. In the next exercise we will explain how to do multi document updates. The second part of the update is the bread and butter of this exercise namely the <tt class="docutils literal">atomic</tt> operator <tt class="docutils literal">$set</tt>. The statement <tt class="docutils literal">{$set: {value: 2}}</tt> sets the <tt class="docutils literal">value</tt> field of the matched document to 2.</p>
<p>Once the update operation has finished the callback happens and returns the result. Notice that we have 3 return parameters in this case. The first <tt class="docutils literal">err</tt> is the normal error object, the second is the number of documents changed during the update and the last <tt class="docutils literal">full_result</tt> contains the whole update result including a special field called <tt class="docutils literal">updatedExisting</tt> that will contain the information if we updated an existing document or a new one was created. The secret of this field will be revealed in the next exercise.</p>
<p>Let's move on and look at $unset. Enter the following code in your editor and run it.</p>
<div class="highlight"><pre><a name="code--ex9--ex3.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex9--ex3.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex9--ex3.js-pyg.html-3"></a>
<a name="code--ex9--ex3.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex3.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex3.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex9--ex3.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex9--ex3.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex9--ex3.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex9--ex3.js-pyg.html-10"></a>
<a name="code--ex9--ex3.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;my_basic_update_documents&#39;</span><span class="p">);</span>
<a name="code--ex9--ex3.js-pyg.html-12"></a>
<a name="code--ex9--ex3.js-pyg.html-13"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex9--ex3.js-pyg.html-14"></a>
<a name="code--ex9--ex3.js-pyg.html-15"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex3.js-pyg.html-16"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex3.js-pyg.html-17"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;write concern on collection caught duplicate key error&quot;</span><span class="p">);</span>
<a name="code--ex9--ex3.js-pyg.html-18"></a>      <span class="p">}</span>
<a name="code--ex9--ex3.js-pyg.html-19"></a>
<a name="code--ex9--ex3.js-pyg.html-20"></a>      <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="nx">$unset</span><span class="o">:</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">full_result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex3.js-pyg.html-21"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;updated &quot;</span> <span class="o">+</span> <span class="nx">result</span> <span class="o">+</span> <span class="s2">&quot; number of documents&quot;</span><span class="p">);</span>
<a name="code--ex9--ex3.js-pyg.html-22"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">full_result</span><span class="p">);</span>
<a name="code--ex9--ex3.js-pyg.html-23"></a>
<a name="code--ex9--ex3.js-pyg.html-24"></a>        <span class="nx">collection</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex3.js-pyg.html-25"></a>
<a name="code--ex9--ex3.js-pyg.html-26"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
<a name="code--ex9--ex3.js-pyg.html-27"></a>
<a name="code--ex9--ex3.js-pyg.html-28"></a>          <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex9--ex3.js-pyg.html-29"></a>        <span class="p">});</span>
<a name="code--ex9--ex3.js-pyg.html-30"></a>      <span class="p">});</span>
<a name="code--ex9--ex3.js-pyg.html-31"></a>    <span class="p">});</span>
<a name="code--ex9--ex3.js-pyg.html-32"></a>  <span class="p">});</span>
<a name="code--ex9--ex3.js-pyg.html-33"></a><span class="p">});</span>
</pre></div><p>Your console output should look something like.</p>
<pre class="code console literal-block">
<span class="go">connected to database
updated 1 number of documents
{ updatedExisting: true, n: 1, connectionId: 75, err: null, ok: 1 }
{ _id: 2 }</span>
</pre>
<p>The main difference from the previous example is that the second term of the update now reads like <tt class="docutils literal">{$unset: {value: <span class="pre">&quot;&quot;}}</span></tt>, this removes the field <tt class="docutils literal">value</tt> from the document. That's fairly straight forward.</p>
</div>
<div class="section" id="inc-operator">
<h3><a class="toc-backref" href="#id39">$inc Operator</a></h3>
<p>Let's move on to the <tt class="docutils literal">$inc</tt> operator that lets us manipulate a numeric value. Fire up your editor and enter the code.</p>
<div class="highlight"><pre><a name="code--ex9--ex4.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex9--ex4.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex9--ex4.js-pyg.html-3"></a>
<a name="code--ex9--ex4.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex4.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex4.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex9--ex4.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex9--ex4.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex9--ex4.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex9--ex4.js-pyg.html-10"></a>
<a name="code--ex9--ex4.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;my_basic_update_documents&#39;</span><span class="p">);</span>
<a name="code--ex9--ex4.js-pyg.html-12"></a>
<a name="code--ex9--ex4.js-pyg.html-13"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex9--ex4.js-pyg.html-14"></a>
<a name="code--ex9--ex4.js-pyg.html-15"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex4.js-pyg.html-16"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex4.js-pyg.html-17"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;write concern on collection caught duplicate key error&quot;</span><span class="p">);</span>
<a name="code--ex9--ex4.js-pyg.html-18"></a>      <span class="p">}</span>
<a name="code--ex9--ex4.js-pyg.html-19"></a>
<a name="code--ex9--ex4.js-pyg.html-20"></a>      <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="nx">$inc</span><span class="o">:</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="mi">1</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">full_result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex4.js-pyg.html-21"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;updated &quot;</span> <span class="o">+</span> <span class="nx">result</span> <span class="o">+</span> <span class="s2">&quot; number of documents&quot;</span><span class="p">);</span>
<a name="code--ex9--ex4.js-pyg.html-22"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">full_result</span><span class="p">);</span>
<a name="code--ex9--ex4.js-pyg.html-23"></a>
<a name="code--ex9--ex4.js-pyg.html-24"></a>        <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="nx">$inc</span><span class="o">:</span> <span class="p">{</span><span class="nx">value2</span><span class="o">:</span> <span class="o">-</span><span class="mf">5.1</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">full_result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex4.js-pyg.html-25"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;updated &quot;</span> <span class="o">+</span> <span class="nx">result</span> <span class="o">+</span> <span class="s2">&quot; number of documents&quot;</span><span class="p">);</span>
<a name="code--ex9--ex4.js-pyg.html-26"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">full_result</span><span class="p">);</span>
<a name="code--ex9--ex4.js-pyg.html-27"></a>
<a name="code--ex9--ex4.js-pyg.html-28"></a>          <span class="nx">collection</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex4.js-pyg.html-29"></a>
<a name="code--ex9--ex4.js-pyg.html-30"></a>            <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
<a name="code--ex9--ex4.js-pyg.html-31"></a>
<a name="code--ex9--ex4.js-pyg.html-32"></a>            <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex9--ex4.js-pyg.html-33"></a>          <span class="p">});</span>
<a name="code--ex9--ex4.js-pyg.html-34"></a>        <span class="p">});</span>
<a name="code--ex9--ex4.js-pyg.html-35"></a>      <span class="p">});</span>
<a name="code--ex9--ex4.js-pyg.html-36"></a>    <span class="p">});</span>
<a name="code--ex9--ex4.js-pyg.html-37"></a>  <span class="p">});</span>
<a name="code--ex9--ex4.js-pyg.html-38"></a><span class="p">});</span>
</pre></div><p>Execute the code and your output should look something like.</p>
<pre class="code console literal-block">
<span class="go">connected to database
updated 1 number of documents
{ updatedExisting: true, n: 1, connectionId: 85, err: null, ok: 1 }
updated 1 number of documents
{ updatedExisting: true, n: 1, connectionId: 86, err: null, ok: 1 }
{ _id: 2, value: 2, value2: -5.1 }</span>
</pre>
<p>The first update operation uses the update statement <tt class="docutils literal">{$inc: {value: 1}}</tt>, since the <tt class="docutils literal">value</tt> field already exists it gets incremented by 1. The operation translates to <tt class="docutils literal">new value = old value + increment value</tt>. The second update statement creates the field <tt class="docutils literal">value2</tt> as it does not already exist and sets it to <tt class="docutils literal"><span class="pre">-5.1</span></tt>. Pretty cool we can now do such things as keeping count of items. Also note that <tt class="docutils literal">$inc</tt> works with floating point values aswell as whole integers.</p>
</div>
<div class="section" id="bit-operator">
<h3><a class="toc-backref" href="#id40">$bit Operator</a></h3>
<p>Sweet let's touch on the last field operator before we show how we can apply multiple updates to a single document. The last field operator is the <tt class="docutils literal">$bit</tt> operator. It's very useful for some situations. Imagine that you might want to store <tt class="docutils literal">8</tt> different status flags. You could do it like this.</p>
<pre class="code console literal-block">
<span class="go">{
    flag1: true
  , flag2: true
  , flag3: true
  , flag4: true
  , flag5: true
  , flag6: true
  , flag7: true
  , flag8: true
}

or maybe like this

{
  flags: [true, true, true, true, true, true, true, true]
}</span>
</pre>
<p>But they take up quite a bit of memory space. So say you want to save space and want to pack all the <tt class="docutils literal">8</tt> flags into a single field. That's where bitwise operators come in (more information on bit fields at <a class="reference external" href="http://en.wikipedia.org/wiki/Bit_field">http://en.wikipedia.org/wiki/Bit_field</a>). Let's fire up the editor and enter the code below. Don't worry if bitwise operations are a bit difficult to understand, consider it priming you brain with an idea you can exploit at some later point in the future.</p>
<div class="highlight"><pre><a name="code--ex9--ex5.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex9--ex5.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex9--ex5.js-pyg.html-3"></a>
<a name="code--ex9--ex5.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex5.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex5.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex9--ex5.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex9--ex5.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex9--ex5.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex9--ex5.js-pyg.html-10"></a>
<a name="code--ex9--ex5.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;my_basic_update_documents&#39;</span><span class="p">);</span>
<a name="code--ex9--ex5.js-pyg.html-12"></a>
<a name="code--ex9--ex5.js-pyg.html-13"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex9--ex5.js-pyg.html-14"></a>
<a name="code--ex9--ex5.js-pyg.html-15"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex5.js-pyg.html-16"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex5.js-pyg.html-17"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;write concern on collection caught duplicate key error&quot;</span><span class="p">);</span>
<a name="code--ex9--ex5.js-pyg.html-18"></a>      <span class="p">}</span>
<a name="code--ex9--ex5.js-pyg.html-19"></a>
<a name="code--ex9--ex5.js-pyg.html-20"></a>      <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="nx">$bit</span><span class="o">:</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="p">{</span><span class="nx">or</span><span class="o">:</span> <span class="mh">0x10</span><span class="p">}}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">full_result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex5.js-pyg.html-21"></a>        <span class="nx">collection</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex5.js-pyg.html-22"></a>
<a name="code--ex9--ex5.js-pyg.html-23"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
<a name="code--ex9--ex5.js-pyg.html-24"></a>
<a name="code--ex9--ex5.js-pyg.html-25"></a>          <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="nx">$bit</span><span class="o">:</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="p">{</span><span class="nx">and</span><span class="o">:</span> <span class="mh">0xEF</span><span class="p">}}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">full_result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex5.js-pyg.html-26"></a>            <span class="nx">collection</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex5.js-pyg.html-27"></a>
<a name="code--ex9--ex5.js-pyg.html-28"></a>              <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
<a name="code--ex9--ex5.js-pyg.html-29"></a>
<a name="code--ex9--ex5.js-pyg.html-30"></a>              <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex9--ex5.js-pyg.html-31"></a>            <span class="p">});</span>
<a name="code--ex9--ex5.js-pyg.html-32"></a>          <span class="p">});</span>
<a name="code--ex9--ex5.js-pyg.html-33"></a>        <span class="p">});</span>
<a name="code--ex9--ex5.js-pyg.html-34"></a>      <span class="p">});</span>
<a name="code--ex9--ex5.js-pyg.html-35"></a>    <span class="p">});</span>
<a name="code--ex9--ex5.js-pyg.html-36"></a>  <span class="p">});</span>
<a name="code--ex9--ex5.js-pyg.html-37"></a><span class="p">});</span>
</pre></div><p>You should see the following output</p>
<pre class="code console literal-block">
<span class="go">connected to database
{ _id: 2, value: 17 }
{ _id: 2, value: 1 }</span>
</pre>
<p>So what does this little example do. It first inserts a document with the field <tt class="docutils literal">value</tt> set to 1. The first update applies the value <tt class="docutils literal">0x10</tt> (hex value) against the field using the <tt class="docutils literal">$bit</tt> operator and an <tt class="docutils literal">or</tt>. First lets we need to understand how <tt class="docutils literal">or</tt> works. Let's look at the <tt class="docutils literal">or</tt> table.</p>
<pre class="code console literal-block">
<span class="go">    value: 0 0 1 1
 or value: 0 1 0 1
------------------
   result: 0 1 1 1</span>
</pre>
<p>Basically if the bit position is not set it will be set if we <tt class="docutils literal">or</tt> with a <tt class="docutils literal">1</tt> while preserving existing flags.Let's see what happens to the value when we apply it.</p>
<pre class="code console literal-block">
<span class="go"> existing value:   0 0 0 0  0 0 0 1
or value (0x10):   0 0 0 1  0 0 0 0
-----------------------------------
    final value:   0 0 0 1  0 0 0 1
      hex value:   0x11
  decimal value:   17</span>
</pre>
<p>Cool we flipped a single bit positon to 1 which we consider to be the true value. What if we want to flip it back. Normally you would use an operation called <tt class="docutils literal">xor</tt> to do this but as of now MongoDB does not support <tt class="docutils literal">xor</tt>. Luckily it does support an operation called <tt class="docutils literal">and</tt>. How does and work. Well let's look at the <tt class="docutils literal">and</tt> table.</p>
<pre class="code console literal-block">
<span class="go">    value: 0 0 1 1
and value: 0 1 0 1
------------------
   result: 0 0 0 1</span>
</pre>
<p>If we <tt class="docutils literal">and</tt> a bit with the value <tt class="docutils literal">1</tt> it will preserve the existing bit value. If we <tt class="docutils literal">and</tt> it with <tt class="docutils literal">0</tt> it will set the corresponding bit to <tt class="docutils literal">0</tt> as well. This lets us flip a bit to <tt class="docutils literal">0</tt> as long as all the bits in our value are set to <tt class="docutils literal">1</tt>. Let's see what happens when we apply the value.</p>
<pre class="code console literal-block">
<span class="go">  existing value:   0 0 0 1  0 0 0 1
and value (0xEF):   1 1 1 0  1 1 1 1
------------------------------------
     final value:   0 0 0 0  0 0 0 1
       hex value:   0x01
   decimal value:   1</span>
</pre>
<p>Perfect we just flipped the value back to <tt class="docutils literal">0</tt> setting our flag to <tt class="docutils literal">false</tt>. In short <tt class="docutils literal">bit fields</tt> can be very useful to compress values into a smaller space in the database. As an example a <tt class="docutils literal">32bit</tt> integer can contain <tt class="docutils literal">32</tt> binary flags and will take up very little space in comparision to 32 indidvidual fields or 32 entries in an array.</p>
</div>
<div class="section" id="isolated-or-how-i-came-to-love-the-bomb">
<h3><a class="toc-backref" href="#id41">$isolated or how I came to love the bomb</a></h3>
<p>Let's start right off the bat in the editor, fire it up and enter the code below.</p>
<div class="highlight"><pre><a name="code--ex9--ex6.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex9--ex6.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex9--ex6.js-pyg.html-3"></a>
<a name="code--ex9--ex6.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex6.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex6.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex9--ex6.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex9--ex6.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex9--ex6.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex9--ex6.js-pyg.html-10"></a>
<a name="code--ex9--ex6.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;my_basic_update_documents&#39;</span><span class="p">);</span>
<a name="code--ex9--ex6.js-pyg.html-12"></a>
<a name="code--ex9--ex6.js-pyg.html-13"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex9--ex6.js-pyg.html-14"></a>
<a name="code--ex9--ex6.js-pyg.html-15"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex6.js-pyg.html-16"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex6.js-pyg.html-17"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;write concern on collection caught duplicate key error&quot;</span><span class="p">);</span>
<a name="code--ex9--ex6.js-pyg.html-18"></a>      <span class="p">}</span>
<a name="code--ex9--ex6.js-pyg.html-19"></a>
<a name="code--ex9--ex6.js-pyg.html-20"></a>      <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">$isolated</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span>
<a name="code--ex9--ex6.js-pyg.html-21"></a>        <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">value2</span><span class="o">:</span> <span class="s1">&#39;hello&#39;</span><span class="p">},</span> <span class="nx">$inc</span><span class="o">:</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">full_result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex6.js-pyg.html-22"></a>
<a name="code--ex9--ex6.js-pyg.html-23"></a>          <span class="nx">collection</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex9--ex6.js-pyg.html-24"></a>
<a name="code--ex9--ex6.js-pyg.html-25"></a>            <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
<a name="code--ex9--ex6.js-pyg.html-26"></a>
<a name="code--ex9--ex6.js-pyg.html-27"></a>            <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex9--ex6.js-pyg.html-28"></a>          <span class="p">});</span>
<a name="code--ex9--ex6.js-pyg.html-29"></a>      <span class="p">});</span>
<a name="code--ex9--ex6.js-pyg.html-30"></a>    <span class="p">});</span>
<a name="code--ex9--ex6.js-pyg.html-31"></a>  <span class="p">});</span>
<a name="code--ex9--ex6.js-pyg.html-32"></a><span class="p">});</span>
</pre></div><p>Your output should look like.</p>
<pre class="code console literal-block">
<span class="go">connected to database
{ _id: 2, value: -4, value2: 'hello' }</span>
</pre>
<p>So as you might have suspected you can make multiple changes on a document in a single update. However by default each operation is atomic by itself but not all of them together as MongoDB will let other update operations on the same document happen at the same time. What does that mean? Well easier said with an example. Say we have to updates executing at the same time.</p>
<pre class="code console literal-block">
<span class="go">  initial document state: {value: 5}
 first update operations: $set: {value2: 'hello'} and $inc: {value: -5}
second update operations: $inc: {value: -1}

possible ordering of operations:
-----------------------------------------
    first update: $set: {value2: 'hello'}
   second update: $inc: {value: -1}
    first update: $inc: {value: -5}</span>
</pre>
<p>MongoDB will interleave the operations. In this particular this might cause a problem. Imagine if the matcher for the document is <tt class="docutils literal">only update document if value &gt; 0</tt>. Since both of them match correctly but get intermixed the end value of <tt class="docutils literal">value</tt> could potentially be <tt class="docutils literal"><span class="pre">-1</span></tt> not <tt class="docutils literal">0</tt> as we expect.</p>
<p>To avoid this in the example above we use the <tt class="docutils literal">$isolated</tt> operator as part of the update matching. This tells MongoDB to not let anyone else modify the document until the current operation is done and forces the ordering to look like.</p>
<pre class="code console literal-block">
<span class="go">  initial document state: {value: 5}
 first update operations: $set: {value2: 'hello'} and $inc: {value: -5}
second update operations: $inc: {value: -1}

possible ordering of operations:
----------------------------------------------------------
    first update: $set: {value2: 'hello'}
    first update: $inc: {value: -5}
   second update: $inc: {value: -1} (failes as value is 0)</span>
</pre>
<p>So as we can see <tt class="docutils literal">$isolated</tt> can be quite useful. With this we are ready to take the tackle the next step of dealing with arrays when performing updates.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">You might be tempted to always use <tt class="docutils literal">$isolated</tt> but you should not fall into this temptation. Only use it where appropriate as you are losing out on the benefit of concurrent writes to MongoDB forcing all updates to be serial. But keep it in mind when doing multiple field updates in a document if you are unsure something else could be changing the field while your application is executing a complex update.</p>
</div>
</div>
</div>
<div class="section" id="exercise-10-update-basics">
<h2><a class="toc-backref" href="#id42">Exercise 10: Update Basics</a></h2>
<p>In the previous exercises we learned how to insert document into MongoDB and what a write concern is. We also learned why <tt class="docutils literal">.save()</tt> is not a good way of saving your documents and how bulk inserts work. Having covered the basics we will spend this exercise looking at how to use the <tt class="docutils literal">update</tt> array operators to manipulate document level arrays.</p>
<div class="section" id="push-operator">
<h3><a class="toc-backref" href="#id43">$push Operator</a></h3>
<p>The <tt class="docutils literal">$push</tt> operator lets you add a document to the end of an array inside a <tt class="docutils literal">MongoDB</tt> document. If the array does not exist it will create the array and then add the document to the newly created array. Let's put some code in showing the usage of the <tt class="docutils literal">$push</tt> operator.</p>
<div class="highlight"><pre><a name="code--ex10--ex1.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex10--ex1.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex10--ex1.js-pyg.html-3"></a>
<a name="code--ex10--ex1.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex1.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex1.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex10--ex1.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex10--ex1.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex10--ex1.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex10--ex1.js-pyg.html-10"></a>
<a name="code--ex10--ex1.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;my_basic_update_documents&#39;</span><span class="p">);</span>
<a name="code--ex10--ex1.js-pyg.html-12"></a>
<a name="code--ex10--ex1.js-pyg.html-13"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex10--ex1.js-pyg.html-14"></a>
<a name="code--ex10--ex1.js-pyg.html-15"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex1.js-pyg.html-16"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex1.js-pyg.html-17"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;write concern on collection caught duplicate key error&quot;</span><span class="p">);</span>
<a name="code--ex10--ex1.js-pyg.html-18"></a>      <span class="p">}</span>
<a name="code--ex10--ex1.js-pyg.html-19"></a>
<a name="code--ex10--ex1.js-pyg.html-20"></a>      <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">}</span>
<a name="code--ex10--ex1.js-pyg.html-21"></a>        <span class="p">,</span> <span class="p">{</span><span class="nx">$push</span><span class="o">:</span> <span class="p">{</span><span class="nx">array</span><span class="o">:</span> <span class="mi">1</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">full_result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex1.js-pyg.html-22"></a>
<a name="code--ex10--ex1.js-pyg.html-23"></a>          <span class="nx">collection</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex1.js-pyg.html-24"></a>
<a name="code--ex10--ex1.js-pyg.html-25"></a>            <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
<a name="code--ex10--ex1.js-pyg.html-26"></a>
<a name="code--ex10--ex1.js-pyg.html-27"></a>            <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex10--ex1.js-pyg.html-28"></a>          <span class="p">});</span>
<a name="code--ex10--ex1.js-pyg.html-29"></a>      <span class="p">});</span>
<a name="code--ex10--ex1.js-pyg.html-30"></a>    <span class="p">});</span>
<a name="code--ex10--ex1.js-pyg.html-31"></a>  <span class="p">});</span>
<a name="code--ex10--ex1.js-pyg.html-32"></a><span class="p">});</span>
</pre></div><p>The output from running the script with <tt class="docutils literal">node</tt> should look like.</p>
<pre class="code console literal-block">
<span class="go">connected to database
{ _id: 2, array: [ 1 ], value: 1 }</span>
</pre>
<p>If we look at the code we you'll notice that the <tt class="docutils literal">update</tt> statement looks like.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">$push</span><span class="o">:</span> <span class="p">{</span><span class="nx">array</span><span class="o">:</span> <span class="mi">1</span><span class="p">}}</span>
</pre>
<p>The way the <tt class="docutils literal">$push</tt> operator works is that it will attempt to locate the field named <tt class="docutils literal">array</tt> in the document with <tt class="docutils literal">_id</tt> equal to <tt class="docutils literal">2</tt>. Since there is no field named <tt class="docutils literal">array</tt> in the document it will create a new field <tt class="docutils literal">array</tt> that is an empty array and then will add the value <tt class="docutils literal">1</tt> to the array. The value added to the array can be of any type. It's thus possible to do things like.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">$push</span><span class="o">:</span> <span class="p">{</span><span class="nx">array</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]}}</span>
</pre>
<p>that will return a document looking like this.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span> <span class="o">:</span> <span class="p">[</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">]</span> <span class="p">]</span> <span class="p">}</span>
</pre>
<p>Or even adding a document to the array.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">$push</span><span class="o">:</span> <span class="p">{</span><span class="nx">array</span><span class="o">:</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">}}}</span>
</pre>
<p>that will return a document looking like this.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span> <span class="o">:</span> <span class="p">[</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span> <span class="p">]</span> <span class="p">}</span>
</pre>
<p>The only time the <tt class="docutils literal">$push</tt> operation will fail is if the document already contains a field named <tt class="docutils literal">array</tt> that is not an array. So what if we want to push a series of documents to an array all at the same time ? Well there is an operator for that too.</p>
</div>
<div class="section" id="pushall-operator">
<h3><a class="toc-backref" href="#id44">$pushAll Operator</a></h3>
<p>Let's consider a document that represents a meeting. The first part of the meeting might be a simple one line title outlining the reason for the meeting and it might also have some sort of description as well as a start time and end time. We also have an array of users that we want to add as participants to the meeting in question. Let's enter the code.</p>
<div class="highlight"><pre><a name="code--ex10--ex2.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex10--ex2.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex10--ex2.js-pyg.html-3"></a>
<a name="code--ex10--ex2.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex2.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex2.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex10--ex2.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex10--ex2.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex10--ex2.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex10--ex2.js-pyg.html-10"></a>
<a name="code--ex10--ex2.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">meeting</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex10--ex2.js-pyg.html-12"></a>      <span class="nx">_id</span> <span class="o">:</span> <span class="mi">1</span>
<a name="code--ex10--ex2.js-pyg.html-13"></a>    <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Let&#39;s buy a widget&quot;</span>
<a name="code--ex10--ex2.js-pyg.html-14"></a>    <span class="p">,</span> <span class="nx">description</span><span class="o">:</span> <span class="s2">&quot;We need to buy the ACME widget and need budget approval&quot;</span>
<a name="code--ex10--ex2.js-pyg.html-15"></a>    <span class="p">,</span> <span class="nx">startTime</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
<a name="code--ex10--ex2.js-pyg.html-16"></a>    <span class="p">,</span> <span class="nx">endTime</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
<a name="code--ex10--ex2.js-pyg.html-17"></a>  <span class="p">}</span>
<a name="code--ex10--ex2.js-pyg.html-18"></a>
<a name="code--ex10--ex2.js-pyg.html-19"></a>  <span class="kd">var</span> <span class="nx">users</span> <span class="o">=</span> <span class="p">[</span>
<a name="code--ex10--ex2.js-pyg.html-20"></a>      <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;April&#39;</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;april@inc.com&#39;</span><span class="p">}</span>
<a name="code--ex10--ex2.js-pyg.html-21"></a>    <span class="p">,</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;john@inc.com&#39;</span><span class="p">}</span>
<a name="code--ex10--ex2.js-pyg.html-22"></a>  <span class="p">]</span>
<a name="code--ex10--ex2.js-pyg.html-23"></a>
<a name="code--ex10--ex2.js-pyg.html-24"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;meetings&#39;</span><span class="p">);</span>
<a name="code--ex10--ex2.js-pyg.html-25"></a>
<a name="code--ex10--ex2.js-pyg.html-26"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex10--ex2.js-pyg.html-27"></a>
<a name="code--ex10--ex2.js-pyg.html-28"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">meeting</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex2.js-pyg.html-29"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex2.js-pyg.html-30"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;write concern on collection caught duplicate key error&quot;</span><span class="p">);</span>
<a name="code--ex10--ex2.js-pyg.html-31"></a>      <span class="p">}</span>
<a name="code--ex10--ex2.js-pyg.html-32"></a>
<a name="code--ex10--ex2.js-pyg.html-33"></a>      <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">_id</span> <span class="p">}</span>
<a name="code--ex10--ex2.js-pyg.html-34"></a>        <span class="p">,</span> <span class="p">{</span><span class="nx">$pushAll</span><span class="o">:</span> <span class="p">{</span><span class="nx">participants</span><span class="o">:</span> <span class="nx">users</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">full_result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex2.js-pyg.html-35"></a>
<a name="code--ex10--ex2.js-pyg.html-36"></a>          <span class="nx">collection</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">_id</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex2.js-pyg.html-37"></a>
<a name="code--ex10--ex2.js-pyg.html-38"></a>            <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
<a name="code--ex10--ex2.js-pyg.html-39"></a>
<a name="code--ex10--ex2.js-pyg.html-40"></a>            <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex10--ex2.js-pyg.html-41"></a>          <span class="p">});</span>
<a name="code--ex10--ex2.js-pyg.html-42"></a>      <span class="p">});</span>
<a name="code--ex10--ex2.js-pyg.html-43"></a>    <span class="p">});</span>
<a name="code--ex10--ex2.js-pyg.html-44"></a>  <span class="p">});</span>
<a name="code--ex10--ex2.js-pyg.html-45"></a><span class="p">});</span>
</pre></div><p>the output should look like this.</p>
<pre class="code console literal-block">
<span class="go">connected to database
{ _id: 1,
  description: 'We need to buy the ACME widget and need budget approval',
  endTime: Wed Jan 23 2013 14:18:21 GMT+0100 (CET),
  participants:
   [ { name: 'April', email: 'april&#64;inc.com' },
     { name: 'John', email: 'john&#64;inc.com' } ],
  startTime: Wed Jan 23 2013 14:18:21 GMT+0100 (CET),
  title: 'Let\'s buy a widget' }</span>
</pre>
<p>As you can see the <tt class="docutils literal">$pushAll</tt> operator added both of the documents in the <tt class="docutils literal">user</tt> array to the <tt class="docutils literal">meeting</tt> document under the field name <tt class="docutils literal">participants</tt>. Just as with <tt class="docutils literal">$push</tt> the <tt class="docutils literal">$pushAll</tt> operator will fail if there is an existing field that is not an array. If the field does exist and is an array the documents will be added to the end of the array. But what if we wish to remove documents from an Array ?</p>
</div>
<div class="section" id="pull-operator">
<h3><a class="toc-backref" href="#id45">$pull Operator</a></h3>
<p>Let's imagine that <tt class="docutils literal">April</tt> no longer can attend the meeting. How do we remove her from the list ? Let's fire up our editor and enter some code and then have a look at how it works.</p>
<div class="highlight"><pre><a name="code--ex10--ex3.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex10--ex3.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex10--ex3.js-pyg.html-3"></a>
<a name="code--ex10--ex3.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex3.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex3.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex10--ex3.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex10--ex3.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex10--ex3.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex10--ex3.js-pyg.html-10"></a>
<a name="code--ex10--ex3.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">meeting</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex10--ex3.js-pyg.html-12"></a>      <span class="nx">_id</span> <span class="o">:</span> <span class="mi">1</span>
<a name="code--ex10--ex3.js-pyg.html-13"></a>    <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Let&#39;s buy a widget&quot;</span>
<a name="code--ex10--ex3.js-pyg.html-14"></a>    <span class="p">,</span> <span class="nx">description</span><span class="o">:</span> <span class="s2">&quot;We need to buy the ACME widget and need budget approval&quot;</span>
<a name="code--ex10--ex3.js-pyg.html-15"></a>    <span class="p">,</span> <span class="nx">startTime</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
<a name="code--ex10--ex3.js-pyg.html-16"></a>    <span class="p">,</span> <span class="nx">endTime</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
<a name="code--ex10--ex3.js-pyg.html-17"></a>  <span class="p">}</span>
<a name="code--ex10--ex3.js-pyg.html-18"></a>
<a name="code--ex10--ex3.js-pyg.html-19"></a>  <span class="kd">var</span> <span class="nx">users</span> <span class="o">=</span> <span class="p">[</span>
<a name="code--ex10--ex3.js-pyg.html-20"></a>      <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;April&#39;</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;april@inc.com&#39;</span><span class="p">}</span>
<a name="code--ex10--ex3.js-pyg.html-21"></a>    <span class="p">,</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;john@inc.com&#39;</span><span class="p">}</span>
<a name="code--ex10--ex3.js-pyg.html-22"></a>  <span class="p">]</span>
<a name="code--ex10--ex3.js-pyg.html-23"></a>
<a name="code--ex10--ex3.js-pyg.html-24"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;meetings&#39;</span><span class="p">);</span>
<a name="code--ex10--ex3.js-pyg.html-25"></a>
<a name="code--ex10--ex3.js-pyg.html-26"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex10--ex3.js-pyg.html-27"></a>
<a name="code--ex10--ex3.js-pyg.html-28"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">meeting</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex3.js-pyg.html-29"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex3.js-pyg.html-30"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;write concern on collection caught duplicate key error&quot;</span><span class="p">);</span>
<a name="code--ex10--ex3.js-pyg.html-31"></a>      <span class="p">}</span>
<a name="code--ex10--ex3.js-pyg.html-32"></a>
<a name="code--ex10--ex3.js-pyg.html-33"></a>      <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">_id</span> <span class="p">}</span>
<a name="code--ex10--ex3.js-pyg.html-34"></a>        <span class="p">,</span> <span class="p">{</span><span class="nx">$pushAll</span><span class="o">:</span> <span class="p">{</span><span class="nx">participants</span><span class="o">:</span> <span class="nx">users</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">full_result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex3.js-pyg.html-35"></a>
<a name="code--ex10--ex3.js-pyg.html-36"></a>          <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">_id</span><span class="p">},</span> <span class="p">{</span><span class="nx">$pull</span><span class="o">:</span> <span class="p">{</span> <span class="nx">participants</span><span class="o">:</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;April&#39;</span><span class="p">}}}</span>
<a name="code--ex10--ex3.js-pyg.html-37"></a>            <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">full_result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex3.js-pyg.html-38"></a>
<a name="code--ex10--ex3.js-pyg.html-39"></a>              <span class="nx">collection</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">_id</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex3.js-pyg.html-40"></a>
<a name="code--ex10--ex3.js-pyg.html-41"></a>                <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
<a name="code--ex10--ex3.js-pyg.html-42"></a>
<a name="code--ex10--ex3.js-pyg.html-43"></a>                <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex10--ex3.js-pyg.html-44"></a>              <span class="p">});</span>
<a name="code--ex10--ex3.js-pyg.html-45"></a>          <span class="p">})</span>
<a name="code--ex10--ex3.js-pyg.html-46"></a>      <span class="p">});</span>
<a name="code--ex10--ex3.js-pyg.html-47"></a>    <span class="p">});</span>
<a name="code--ex10--ex3.js-pyg.html-48"></a>  <span class="p">});</span>
<a name="code--ex10--ex3.js-pyg.html-49"></a><span class="p">});</span>
</pre></div><p>the output should look like this.</p>
<pre class="code console literal-block">
<span class="go">{ _id: 1,
  description: 'We need to buy the ACME widget and need budget approval',
  endTime: Wed Jan 23 2013 14:30:29 GMT+0100 (CET),
  participants: [ { name: 'John', email: 'john&#64;inc.com' } ],
  startTime: Wed Jan 23 2013 14:30:29 GMT+0100 (CET),
  title: 'Let\'s buy a widget' }</span>
</pre>
<p>The <tt class="docutils literal">$pull</tt> operator removes all instances of a value from an existing array. Given the update statement.</p>
<pre class="code javascript literal-block">
<span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">_id</span><span class="p">},</span> <span class="p">{</span><span class="nx">$pull</span><span class="o">:</span> <span class="p">{</span> <span class="nx">participants</span><span class="o">:</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">'April'</span><span class="p">}}}</span> <span class="p">....</span>
</pre>
<p><tt class="docutils literal">MongoDB</tt> will first locate the document that matches the initial query of <tt class="docutils literal">{_id: meeting._id}</tt> and then the <tt class="docutils literal">$pull</tt> operator will traverse the array <tt class="docutils literal">participants</tt> looking for any values that contains the field <tt class="docutils literal">name</tt> with the value set to <tt class="docutils literal">April</tt> and if found will remove them from the <tt class="docutils literal">participants</tt> array.</p>
<p>The <tt class="docutils literal">$pull</tt> operator and the <tt class="docutils literal">$push</tt> operator make it easy to operate on arrays inside of <tt class="docutils literal">MongoDB</tt> documents.</p>
</div>
<div class="section" id="pop-operator">
<h3><a class="toc-backref" href="#id46">$pop Operator</a></h3>
<p>The <tt class="docutils literal">$pop</tt> operator let's you remove the first or the last document from an array in a document.</p>
<p>Give a document that looks like this.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]}</span>
</pre>
<p>the update statement</p>
<pre class="code javascript literal-block">
<span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">$pop</span><span class="o">:</span> <span class="p">{</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">1</span><span class="p">}}</span> <span class="p">....</span>
</pre>
<p>would remove the element <tt class="docutils literal">3</tt> from the array in field <tt class="docutils literal">b</tt>. leaving you with a document looking like this.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]}</span>
</pre>
<p>similarly the statement.</p>
<pre class="code javascript literal-block">
<span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">$pop</span><span class="o">:</span> <span class="p">{</span> <span class="nx">b</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}}</span> <span class="p">....</span>
</pre>
<p>would remove the element <tt class="docutils literal">1</tt> from the array in field <tt class="docutils literal">b</tt>, leaving you with a document looking like this.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]}</span>
</pre>
<p>Unfortunately the <tt class="docutils literal">$pop</tt> operator does not actually return the value that was removed. There is a special command for this called <tt class="docutils literal">findAndModify</tt> that we will cover in the next exercise. What if we need to guarantee that there is only a single instance of a specific document in an array.</p>
</div>
<div class="section" id="addtoset-operator">
<h3><a class="toc-backref" href="#id47">$addToSet Operator</a></h3>
<p>The <tt class="docutils literal">$addToSet</tt> only adds a value to an array if the value does not already exist. Let's see how we can use this in practice. Remember the meeting. Well let's use <tt class="docutils literal">$addToSet</tt> and attempt to add a duplicate document. Open up your editor and type in.</p>
<div class="highlight"><pre><a name="code--ex10--ex4.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex10--ex4.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex10--ex4.js-pyg.html-3"></a>
<a name="code--ex10--ex4.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex10--ex4.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex10--ex4.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex10--ex4.js-pyg.html-10"></a>
<a name="code--ex10--ex4.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">meeting</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-12"></a>      <span class="nx">_id</span> <span class="o">:</span> <span class="mi">1</span>
<a name="code--ex10--ex4.js-pyg.html-13"></a>    <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Let&#39;s buy a widget&quot;</span>
<a name="code--ex10--ex4.js-pyg.html-14"></a>    <span class="p">,</span> <span class="nx">description</span><span class="o">:</span> <span class="s2">&quot;We need to buy the ACME widget and need budget approval&quot;</span>
<a name="code--ex10--ex4.js-pyg.html-15"></a>    <span class="p">,</span> <span class="nx">startTime</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
<a name="code--ex10--ex4.js-pyg.html-16"></a>    <span class="p">,</span> <span class="nx">endTime</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
<a name="code--ex10--ex4.js-pyg.html-17"></a>  <span class="p">}</span>
<a name="code--ex10--ex4.js-pyg.html-18"></a>
<a name="code--ex10--ex4.js-pyg.html-19"></a>  <span class="kd">var</span> <span class="nx">users</span> <span class="o">=</span> <span class="p">[</span>
<a name="code--ex10--ex4.js-pyg.html-20"></a>      <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;April&#39;</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;april@inc.com&#39;</span><span class="p">}</span>
<a name="code--ex10--ex4.js-pyg.html-21"></a>    <span class="p">,</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;john@inc.com&#39;</span><span class="p">}</span>
<a name="code--ex10--ex4.js-pyg.html-22"></a>  <span class="p">]</span>
<a name="code--ex10--ex4.js-pyg.html-23"></a>
<a name="code--ex10--ex4.js-pyg.html-24"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;meetings&#39;</span><span class="p">);</span>
<a name="code--ex10--ex4.js-pyg.html-25"></a>
<a name="code--ex10--ex4.js-pyg.html-26"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-27"></a>
<a name="code--ex10--ex4.js-pyg.html-28"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">meeting</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-29"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-30"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;write concern on collection caught duplicate key error&quot;</span><span class="p">);</span>
<a name="code--ex10--ex4.js-pyg.html-31"></a>      <span class="p">}</span>
<a name="code--ex10--ex4.js-pyg.html-32"></a>
<a name="code--ex10--ex4.js-pyg.html-33"></a>      <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">_id</span> <span class="p">}</span>
<a name="code--ex10--ex4.js-pyg.html-34"></a>        <span class="p">,</span> <span class="p">{</span><span class="nx">$pushAll</span><span class="o">:</span> <span class="p">{</span><span class="nx">participants</span><span class="o">:</span> <span class="nx">users</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">full_result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-35"></a>
<a name="code--ex10--ex4.js-pyg.html-36"></a>          <span class="kd">var</span> <span class="nx">april</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;April&#39;</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;april@inc.com&#39;</span><span class="p">};</span>
<a name="code--ex10--ex4.js-pyg.html-37"></a>
<a name="code--ex10--ex4.js-pyg.html-38"></a>          <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">_id</span><span class="p">}</span>
<a name="code--ex10--ex4.js-pyg.html-39"></a>            <span class="p">,</span> <span class="p">{</span><span class="nx">$addToSet</span><span class="o">:</span> <span class="p">{</span><span class="nx">participants</span><span class="o">:</span> <span class="nx">april</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">full_result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-40"></a>
<a name="code--ex10--ex4.js-pyg.html-41"></a>            <span class="nx">collection</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">_id</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-42"></a>
<a name="code--ex10--ex4.js-pyg.html-43"></a>              <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
<a name="code--ex10--ex4.js-pyg.html-44"></a>
<a name="code--ex10--ex4.js-pyg.html-45"></a>              <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex10--ex4.js-pyg.html-46"></a>            <span class="p">});</span>
<a name="code--ex10--ex4.js-pyg.html-47"></a>        <span class="p">});</span>
<a name="code--ex10--ex4.js-pyg.html-48"></a>      <span class="p">});</span>
<a name="code--ex10--ex4.js-pyg.html-49"></a>    <span class="p">});</span>
<a name="code--ex10--ex4.js-pyg.html-50"></a>  <span class="p">});</span>
<a name="code--ex10--ex4.js-pyg.html-51"></a><span class="p">});</span>
</pre></div><p>Your output should look like the following.</p>
<pre class="code console literal-block">
<span class="go">connected to database
{ _id: 1,
  description: 'We need to buy the ACME widget and need budget approval',
  endTime: Wed Jan 23 2013 15:35:03 GMT+0100 (CET),
  participants:
   [ { name: 'April', email: 'april&#64;inc.com' },
     { name: 'John', email: 'john&#64;inc.com' } ],
  startTime: Wed Jan 23 2013 15:35:03 GMT+0100 (CET),
  title: 'Let\'s buy a widget' }</span>
</pre>
<p>As you can see there was no duplicate entries of the user <tt class="docutils literal">April</tt> in the participants field when using <tt class="docutils literal">$addToSet</tt>. But what if we want to modify a document inside an array, not remove it from the array but set a value on it. Luckily there are a couple of ways we can go about doing this.</p>
</div>
<div class="section" id="updating-a-document-in-an-array">
<h3><a class="toc-backref" href="#id48">Updating a document in an array</a></h3>
<p>If we know the where in the array a particular document is we can specify to update that particular document. Let's take our sample meetings document.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">description</span><span class="o">:</span> <span class="s1">'We need to buy the ACME widget and need budget approval'</span><span class="p">,</span>
  <span class="nx">endTime</span><span class="o">:</span> <span class="nx">Wed</span> <span class="nx">Jan</span> <span class="mi">23</span> <span class="mi">2013</span> <span class="mi">15</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mi">03</span> <span class="nx">GMT</span><span class="o">+</span><span class="mi">0100</span> <span class="p">(</span><span class="nx">CET</span><span class="p">),</span>
  <span class="nx">participants</span><span class="o">:</span>
   <span class="p">[</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'April'</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">'april&#64;inc.com'</span> <span class="p">},</span>
     <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'John'</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">'john&#64;inc.com'</span> <span class="p">}</span> <span class="p">],</span>
  <span class="nx">startTime</span><span class="o">:</span> <span class="nx">Wed</span> <span class="nx">Jan</span> <span class="mi">23</span> <span class="mi">2013</span> <span class="mi">15</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mi">03</span> <span class="nx">GMT</span><span class="o">+</span><span class="mi">0100</span> <span class="p">(</span><span class="nx">CET</span><span class="p">),</span>
  <span class="nx">title</span><span class="o">:</span> <span class="s1">'Let\'s buy a widget'</span> <span class="p">}</span>
</pre>
<p>Say we want to add a contact number for <tt class="docutils literal">April</tt> to the document. Since we know it's the first document we can address it as element <tt class="docutils literal">0</tt> in the array (more information about it's why <tt class="docutils literal">0</tt> and not <tt class="docutils literal">1</tt> at <a class="reference external" href="http://en.wikipedia.org/wiki/Zero-based_numbering">http://en.wikipedia.org/wiki/Zero-based_numbering</a>). Let's write the update statement to add the phone number.</p>
<pre class="code javascript literal-block">
<span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="s1">'participants.0.phone'</span><span class="o">:</span> <span class="s1">'333-444-5555'</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<span class="p">});</span>
</pre>
<p>After the update the document will look like.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">description</span><span class="o">:</span> <span class="s1">'We need to buy the ACME widget and need budget approval'</span><span class="p">,</span>
  <span class="nx">endTime</span><span class="o">:</span> <span class="nx">Wed</span> <span class="nx">Jan</span> <span class="mi">23</span> <span class="mi">2013</span> <span class="mi">15</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mi">03</span> <span class="nx">GMT</span><span class="o">+</span><span class="mi">0100</span> <span class="p">(</span><span class="nx">CET</span><span class="p">),</span>
  <span class="nx">participants</span><span class="o">:</span>
   <span class="p">[</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'April'</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">'april&#64;inc.com'</span><span class="p">,</span> <span class="nx">phone</span> <span class="o">:</span> <span class="s1">'333-444-5555'</span> <span class="p">},</span>
     <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'John'</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">'john&#64;inc.com'</span> <span class="p">}</span> <span class="p">],</span>
  <span class="nx">startTime</span><span class="o">:</span> <span class="nx">Wed</span> <span class="nx">Jan</span> <span class="mi">23</span> <span class="mi">2013</span> <span class="mi">15</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mi">03</span> <span class="nx">GMT</span><span class="o">+</span><span class="mi">0100</span> <span class="p">(</span><span class="nx">CET</span><span class="p">),</span>
  <span class="nx">title</span><span class="o">:</span> <span class="s1">'Let\'s buy a widget'</span> <span class="p">}</span>
</pre>
<p>Notice <tt class="docutils literal">'participants.0.phone'</tt> this tells <tt class="docutils literal">MongoDB</tt> that the field <tt class="docutils literal">participants</tt> is an array and that we are accessing the first element of the array and in that element we wish to set the field <tt class="docutils literal">phone</tt>.</p>
<p>That's great but what if we don't know the location of the document in the array <tt class="docutils literal">participants</tt>. How do we select the right document to update. Luckily for us we have a operator called the positional operator available to do this. The positional operator is the <tt class="docutils literal">$</tt> sign. Let's show it with an update example. Let's add a phone number to <tt class="docutils literal">John</tt> using the positional operator.</p>
<pre class="code javascript literal-block">
<span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">participants</span><span class="p">.</span><span class="nx">name</span><span class="o">:</span><span class="s1">'John'</span><span class="p">},</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="s1">'participants.$.phone'</span><span class="o">:</span> <span class="s1">'111-222-3333'</span><span class="p">}}</span>
  <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">});</span>
</pre>
<p>After the update the document will look like.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">description</span><span class="o">:</span> <span class="s1">'We need to buy the ACME widget and need budget approval'</span><span class="p">,</span>
  <span class="nx">endTime</span><span class="o">:</span> <span class="nx">Wed</span> <span class="nx">Jan</span> <span class="mi">23</span> <span class="mi">2013</span> <span class="mi">15</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mi">03</span> <span class="nx">GMT</span><span class="o">+</span><span class="mi">0100</span> <span class="p">(</span><span class="nx">CET</span><span class="p">),</span>
  <span class="nx">participants</span><span class="o">:</span>
   <span class="p">[</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'April'</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">'april&#64;inc.com'</span><span class="p">,</span> <span class="nx">phone</span> <span class="o">:</span> <span class="s1">'333-444-5555'</span> <span class="p">},</span>
     <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'John'</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">'john&#64;inc.com'</span><span class="p">,</span> <span class="nx">phone</span> <span class="o">:</span> <span class="s1">'111-222-3333'</span> <span class="p">}</span> <span class="p">],</span>
  <span class="nx">startTime</span><span class="o">:</span> <span class="nx">Wed</span> <span class="nx">Jan</span> <span class="mi">23</span> <span class="mi">2013</span> <span class="mi">15</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mi">03</span> <span class="nx">GMT</span><span class="o">+</span><span class="mi">0100</span> <span class="p">(</span><span class="nx">CET</span><span class="p">),</span>
  <span class="nx">title</span><span class="o">:</span> <span class="s1">'Let\'s buy a widget'</span> <span class="p">}</span>
</pre>
<p>Notice the two main differences. The first part is the query which looks like <tt class="docutils literal">{_id:1, <span class="pre">participants.name:'John'}</span></tt>. This will locate the document where <tt class="docutils literal">_id</tt> is <tt class="docutils literal">1</tt> and it contains a participant document where the <tt class="docutils literal">name</tt> field equals to <tt class="docutils literal">John</tt>.</p>
<p>The update part  <tt class="docutils literal"><span class="pre">{'$set':</span> <span class="pre">{'participants.$.phone':</span> <span class="pre">'111-222-3333'}}</span></tt> contains the <tt class="docutils literal">$</tt> which tells <tt class="docutils literal">MongoDB</tt> to locate the first participant who's <tt class="docutils literal">name</tt> field equals <tt class="docutils literal">John</tt> and update <tt class="docutils literal">$set</tt> the value of the field <tt class="docutils literal">phone</tt> in that document to <tt class="docutils literal"><span class="pre">111-222-3333</span></tt>.</p>
<p>There are a couple of limitations to the <tt class="docutils literal">$</tt> operator. The first is that it will only change the <tt class="docutils literal">first</tt> matching document so if you use a <tt class="docutils literal">query</tt> that is picking a document in an array by a <tt class="docutils literal">field</tt> that is not unique it will only update the first match. So it's important to make sure you are using a field in the documents for your query uniquely identifies it. There are some other limitations for the command that you can read more about at <a class="reference external" href="http://docs.mongodb.org/manual/reference/operator/positional/#_S_">http://docs.mongodb.org/manual/reference/operator/positional/#_S_</a>.</p>
</div>
<div class="section" id="one-push-to-rule-them-all">
<h3><a class="toc-backref" href="#id49">One $push To Rule Them All</a></h3>
<p><tt class="docutils literal">MongoDB</tt> 2.4 or higher introduces some changes in the <tt class="docutils literal">$push</tt> operator that deprecates the usage of <tt class="docutils literal">$pushAll</tt> and allows you to fix the max size of an array. This is most easily showed using an example.</p>
<p>Say we have a document that looks like this.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">a</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="p">}</span>
</pre>
<p>Let's add 2 more elements but we want to keep the size fixed to a max of 5 elements.</p>
<pre class="code javascript literal-block">
<span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">$push</span><span class="o">:</span> <span class="p">{</span> <span class="nx">a</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$each</span><span class="o">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="nx">$slice</span><span class="o">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">}}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<span class="p">});</span>
</pre>
<p>The results from the update.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">a</span><span class="o">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span> <span class="p">}</span>
</pre>
<p>Let's pick apart the update statement.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">$push</span><span class="o">:</span> <span class="p">{</span> <span class="nx">a</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$each</span><span class="o">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="nx">$slice</span><span class="o">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">}}}</span>
</pre>
<p>The <tt class="docutils literal">$each</tt> parameter of the <tt class="docutils literal">$push</tt> operator takes an array of values or objects and replaces the <tt class="docutils literal">$pushAll</tt> operation. so the operation <tt class="docutils literal">{$push: { a: { $each: [6, <span class="pre">7]}}}</span></tt> is equivalent to <tt class="docutils literal">{$pushAll: {a : [6, <span class="pre">7]}}</span></tt>. The second parameter is <tt class="docutils literal">$slice</tt>. <tt class="docutils literal">$slice</tt> takes a value that is <tt class="docutils literal">0</tt> or less and trims the number of elements in the array from right to left. In other words the following happens.</p>
<pre class="code console literal-block">
<span class="go">[1, 2, 3, 4, 5]
[1, 2, 3, 4, 5, 6, 7]
[3, 4, 5, 6, 7]</span>
</pre>
<p>Between the second and third step the <tt class="docutils literal">$push</tt> operator takes the last five elements and removes the rest. This makes it possible to <tt class="docutils literal">enforce</tt> a fixed size array field in a document. The last parameter we will show is the <tt class="docutils literal">$sort</tt> parameter. Let's write up an example. Take a document like.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">a</span><span class="o">:</span> <span class="p">[</span><span class="p">{</span><span class="nx">pri</span><span class="o">:</span><span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="nx">pri</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">pri</span><span class="o">:</span><span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="nx">pri</span><span class="o">:</span><span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="nx">pri</span><span class="o">:</span><span class="mi">3</span><span class="p">}]</span> <span class="p">}</span>
</pre>
<p>Now let's add some new objects to our fixed size array and sort them in <tt class="docutils literal">descending</tt> order with the highest priority object first.</p>
<pre class="code javascript literal-block">
<span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">$push</span><span class="o">:</span> <span class="p">{</span> <span class="nx">a</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$each</span><span class="o">:</span> <span class="p">[</span> <span class="p">{</span><span class="nx">pri</span><span class="o">:</span><span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="nx">pri</span><span class="o">:</span><span class="mi">1</span><span class="p">}],</span> <span class="nx">$slice</span><span class="o">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="nx">$sort</span><span class="o">:</span> <span class="p">{</span><span class="nx">pri</span><span class="o">:</span><span class="o">-</span><span class="mi">1</span><span class="p">}}}}</span>
  <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

  <span class="p">});</span>
</pre>
<p>The results from the update.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">a</span><span class="o">:</span> <span class="p">[</span><span class="p">{</span><span class="nx">pri</span><span class="o">:</span><span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="nx">pri</span><span class="o">:</span><span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="nx">pri</span><span class="o">:</span><span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="nx">pri</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">pri</span><span class="o">:</span><span class="mi">1</span><span class="p">}]</span> <span class="p">}</span>
</pre>
<p>The thing to notice is that the <tt class="docutils literal">$sort</tt> will be applied before the <tt class="docutils literal">slice</tt> and that it only supports sorting of objects. You cannot use <tt class="docutils literal">$sort</tt> with an array of numbers for example.</p>
<p>That covers working with arrays when performing updates. As we briefly touched upon earlier there is an additional update command available called <tt class="docutils literal">findAndModify</tt>. In the next exercise we will learn how it works and for what kind of situations it's useful.</p>
</div>
</div>
<div class="section" id="exercise-11-final-update">
<h2><a class="toc-backref" href="#id50">Exercise 11: Final Update</a></h2>
<p>The last two elements we are going to touch when it comes to the <tt class="docutils literal">update</tt> operation is the <tt class="docutils literal">upsert</tt> and the <tt class="docutils literal">multi</tt> option. Let's start with a simple example to illustrate the usage of the <tt class="docutils literal">upsert</tt> option.</p>
<div class="highlight"><pre><a name="code--ex11--ex1.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex11--ex1.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex11--ex1.js-pyg.html-3"></a>
<a name="code--ex11--ex1.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex11--ex1.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex11--ex1.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex11--ex1.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex11--ex1.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex11--ex1.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex11--ex1.js-pyg.html-10"></a>
<a name="code--ex11--ex1.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;upserts&#39;</span><span class="p">);</span>
<a name="code--ex11--ex1.js-pyg.html-12"></a>
<a name="code--ex11--ex1.js-pyg.html-13"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex11--ex1.js-pyg.html-14"></a>
<a name="code--ex11--ex1.js-pyg.html-15"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex11--ex1.js-pyg.html-16"></a>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;added document&quot;</span><span class="p">);</span>
<a name="code--ex11--ex1.js-pyg.html-17"></a>
<a name="code--ex11--ex1.js-pyg.html-18"></a>      <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex11--ex1.js-pyg.html-19"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;will fail&quot;</span><span class="p">);</span>
<a name="code--ex11--ex1.js-pyg.html-20"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--ex11--ex1.js-pyg.html-21"></a>
<a name="code--ex11--ex1.js-pyg.html-22"></a>        <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">value</span><span class="o">:</span><span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">upserted</span><span class="o">:</span><span class="kc">true</span><span class="p">}},</span> <span class="p">{</span><span class="nx">upsert</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
<a name="code--ex11--ex1.js-pyg.html-23"></a>          <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex11--ex1.js-pyg.html-24"></a>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;upserted document&quot;</span><span class="p">);</span>
<a name="code--ex11--ex1.js-pyg.html-25"></a>
<a name="code--ex11--ex1.js-pyg.html-26"></a>            <span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex11--ex1.js-pyg.html-27"></a>              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;documents&quot;</span><span class="p">);</span>
<a name="code--ex11--ex1.js-pyg.html-28"></a>              <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">docs</span><span class="p">);</span>
<a name="code--ex11--ex1.js-pyg.html-29"></a>              <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex11--ex1.js-pyg.html-30"></a>            <span class="p">});</span>
<a name="code--ex11--ex1.js-pyg.html-31"></a>        <span class="p">});</span>
<a name="code--ex11--ex1.js-pyg.html-32"></a>      <span class="p">});</span>
<a name="code--ex11--ex1.js-pyg.html-33"></a>    <span class="p">});</span>
<a name="code--ex11--ex1.js-pyg.html-34"></a>  <span class="p">});</span>
<a name="code--ex11--ex1.js-pyg.html-35"></a><span class="p">});</span>
</pre></div><p>The results should look like this.</p>
<pre class="code console literal-block">
<span class="go">connected to database
added document
will fail
{ [MongoError: Mod on _id not allowed]
  name: 'MongoError',
  err: 'Mod on _id not allowed',
  code: 10148,
  n: 0,
  connectionId: 153,
  ok: 1 }
upserted document
documents
[ { _id: 1, value: 1 },
  { _id: 510124cc0ac025483df1af08, upserted: true, value: 2 } ]</span>
</pre>
<p>The <tt class="docutils literal">upsert</tt> option will run the update creating a new document if no document is found for the query. The first <tt class="docutils literal">upsert</tt> fails because we cannot modify the <tt class="docutils literal">_id</tt> field as it's the unique identifier for the document. The second succeeds as there is not document with the field <tt class="docutils literal">value</tt> set to <tt class="docutils literal">2</tt>. This means the update is run but creates a new document. If there had been a document present it would have been modified as if it was a normal update statement.</p>
<div class="section" id="multi">
<h3><a class="toc-backref" href="#id51">Multi</a></h3>
<p>As you might have discovered by now the <tt class="docutils literal">update</tt> command updates a single document at the time. But what if we want do update all documents matching a query. This is where the <tt class="docutils literal">multi</tt> command comes in. Let's have a look at an example.</p>
<div class="highlight"><pre><a name="code--ex11--ex2.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex11--ex2.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex11--ex2.js-pyg.html-3"></a>
<a name="code--ex11--ex2.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex11--ex2.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex11--ex2.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex11--ex2.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex11--ex2.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex11--ex2.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex11--ex2.js-pyg.html-10"></a>
<a name="code--ex11--ex2.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[{</span>
<a name="code--ex11--ex2.js-pyg.html-12"></a>        <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
<a name="code--ex11--ex2.js-pyg.html-13"></a>      <span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="mi">1</span>
<a name="code--ex11--ex2.js-pyg.html-14"></a>      <span class="p">,</span> <span class="nx">read</span><span class="o">:</span><span class="kc">false</span>
<a name="code--ex11--ex2.js-pyg.html-15"></a>    <span class="p">},</span> <span class="p">{</span>
<a name="code--ex11--ex2.js-pyg.html-16"></a>        <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
<a name="code--ex11--ex2.js-pyg.html-17"></a>      <span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="mi">1</span>
<a name="code--ex11--ex2.js-pyg.html-18"></a>      <span class="p">,</span> <span class="nx">read</span><span class="o">:</span><span class="kc">false</span>
<a name="code--ex11--ex2.js-pyg.html-19"></a>    <span class="p">},</span> <span class="p">{</span>
<a name="code--ex11--ex2.js-pyg.html-20"></a>        <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
<a name="code--ex11--ex2.js-pyg.html-21"></a>      <span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="mi">2</span>
<a name="code--ex11--ex2.js-pyg.html-22"></a>      <span class="p">,</span> <span class="nx">read</span><span class="o">:</span><span class="kc">false</span>
<a name="code--ex11--ex2.js-pyg.html-23"></a>    <span class="p">}</span>
<a name="code--ex11--ex2.js-pyg.html-24"></a>  <span class="p">];</span>
<a name="code--ex11--ex2.js-pyg.html-25"></a>
<a name="code--ex11--ex2.js-pyg.html-26"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;upserts&#39;</span><span class="p">);</span>
<a name="code--ex11--ex2.js-pyg.html-27"></a>
<a name="code--ex11--ex2.js-pyg.html-28"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex11--ex2.js-pyg.html-29"></a>
<a name="code--ex11--ex2.js-pyg.html-30"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex11--ex2.js-pyg.html-31"></a>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;added document&quot;</span><span class="p">);</span>
<a name="code--ex11--ex2.js-pyg.html-32"></a>
<a name="code--ex11--ex2.js-pyg.html-33"></a>      <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">read</span><span class="o">:</span><span class="kc">false</span><span class="p">},</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">read</span><span class="o">:</span><span class="kc">true</span><span class="p">}},</span> <span class="p">{</span><span class="nx">multi</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
<a name="code--ex11--ex2.js-pyg.html-34"></a>        <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex11--ex2.js-pyg.html-35"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;updated documents&quot;</span><span class="p">);</span>
<a name="code--ex11--ex2.js-pyg.html-36"></a>
<a name="code--ex11--ex2.js-pyg.html-37"></a>          <span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex11--ex2.js-pyg.html-38"></a>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;documents&quot;</span><span class="p">);</span>
<a name="code--ex11--ex2.js-pyg.html-39"></a>            <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">docs</span><span class="p">);</span>
<a name="code--ex11--ex2.js-pyg.html-40"></a>            <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex11--ex2.js-pyg.html-41"></a>          <span class="p">});</span>
<a name="code--ex11--ex2.js-pyg.html-42"></a>        <span class="p">});</span>
<a name="code--ex11--ex2.js-pyg.html-43"></a>    <span class="p">});</span>
<a name="code--ex11--ex2.js-pyg.html-44"></a>  <span class="p">});</span>
<a name="code--ex11--ex2.js-pyg.html-45"></a><span class="p">});</span>
</pre></div><p>The results should look like this.</p>
<pre class="code console literal-block">
<span class="go">connected to database
added document
updated documents
documents
[ { _id: 1, user: 1, read: true },
  { _id: 2, user: 1, read: true },
  { _id: 3, user: 2, read: false } ]</span>
</pre>
<p>Our <tt class="docutils literal">update</tt> statement will select all the documents that match the expression <tt class="docutils literal">{user:1, read:false}</tt>.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">read</span><span class="o">:</span><span class="kc">false</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">read</span><span class="o">:</span><span class="kc">false</span>
<span class="p">}]</span>
</pre>
<p>And will then set the <tt class="docutils literal">read</tt> field for both documents to <tt class="docutils literal">true</tt>. This covers the last two options of the <tt class="docutils literal">update</tt> command. In the next exercise we will introduce a way to modify and retrieve a document in one operation called <tt class="docutils literal">findAndModify</tt>.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">You might be tempted to use <tt class="docutils literal">update</tt> with <tt class="docutils literal">upsert</tt> set to true instead of <tt class="docutils literal">insert</tt>. This might have a performance impact as you collection grows as the database needs to perform a query and an update operation instead of just an insert operation.</p>
</div>
</div>
</div>
<div class="section" id="exercise-12-findandmodify">
<h2><a class="toc-backref" href="#id52">Exercise 12: FindAndModify</a></h2>
<p>In exercise 10 we introduced the <tt class="docutils literal">$pop</tt> command that removes an element from the start or the end of an array in a document. Unfortunately it does not return the actual element. What if we need to modify and retrieve a document in one go ? Thankfully we have a command called <tt class="docutils literal">findAndModify</tt> that allows you to do exactly that.</p>
<div class="section" id="the-findandmodify-command">
<h3><a class="toc-backref" href="#id53">The findAndModify Command</a></h3>
<p>The definition of the method looks like <tt class="docutils literal">findAndModify (query, sort, doc, options, callback)</tt>. Let's have a look at what the different parameters mean.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="85%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>query</td>
<td>The query matching to the document we wish to change</td>
</tr>
<tr><td>sort</td>
<td>The sort order of the documents returned from the query</td>
</tr>
<tr><td>doc</td>
<td>The update statements for the first document returned from the query and sort</td>
</tr>
<tr><td>options</td>
<td>A set of options that allow us to define how the operation will behave</td>
</tr>
</tbody>
</table>
<p>Let's look at the options that we use to define how our <tt class="docutils literal">findAndModify</tt> command will operate.</p>
<table border="1" class="docutils">
<colgroup>
<col width="9%" />
<col width="91%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>remove</td>
<td>Will remove the document from the collection and return it</td>
</tr>
<tr><td>upsert</td>
<td>Will create a new document if none is found to modify</td>
</tr>
<tr><td>new</td>
<td>Will return the modified document (if false will return the original document before changes. This is ignored if you set remove to true)</td>
</tr>
</tbody>
</table>
<p>Let's start with the simplest example. We will insert four documents into a collection we call work and then retrieve the highest priority document where work has not been started.</p>
<div class="highlight"><pre><a name="code--ex12--ex1.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex12--ex1.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex12--ex1.js-pyg.html-3"></a>
<a name="code--ex12--ex1.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex12--ex1.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex12--ex1.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex12--ex1.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex12--ex1.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex12--ex1.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex12--ex1.js-pyg.html-10"></a>
<a name="code--ex12--ex1.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[{</span>
<a name="code--ex12--ex1.js-pyg.html-12"></a>      <span class="nx">_id</span> <span class="o">:</span> <span class="mi">1</span>
<a name="code--ex12--ex1.js-pyg.html-13"></a>    <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Buy milk&quot;</span>
<a name="code--ex12--ex1.js-pyg.html-14"></a>    <span class="p">,</span> <span class="nx">priority</span><span class="o">:</span> <span class="mi">5</span>
<a name="code--ex12--ex1.js-pyg.html-15"></a>    <span class="p">,</span> <span class="nx">started</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--ex12--ex1.js-pyg.html-16"></a>    <span class="p">,</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--ex12--ex1.js-pyg.html-17"></a>    <span class="p">,</span> <span class="nx">startTime</span><span class="o">:</span> <span class="kc">null</span>
<a name="code--ex12--ex1.js-pyg.html-18"></a>    <span class="p">,</span> <span class="nx">endTime</span><span class="o">:</span> <span class="kc">null</span>
<a name="code--ex12--ex1.js-pyg.html-19"></a>    <span class="p">},</span> <span class="p">{</span>
<a name="code--ex12--ex1.js-pyg.html-20"></a>      <span class="nx">_id</span> <span class="o">:</span> <span class="mi">2</span>
<a name="code--ex12--ex1.js-pyg.html-21"></a>    <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Become a Billionaire&quot;</span>
<a name="code--ex12--ex1.js-pyg.html-22"></a>    <span class="p">,</span> <span class="nx">priority</span><span class="o">:</span> <span class="mi">1</span>
<a name="code--ex12--ex1.js-pyg.html-23"></a>    <span class="p">,</span> <span class="nx">started</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--ex12--ex1.js-pyg.html-24"></a>    <span class="p">,</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--ex12--ex1.js-pyg.html-25"></a>    <span class="p">,</span> <span class="nx">startTime</span><span class="o">:</span> <span class="kc">null</span>
<a name="code--ex12--ex1.js-pyg.html-26"></a>    <span class="p">,</span> <span class="nx">endTime</span><span class="o">:</span> <span class="kc">null</span>
<a name="code--ex12--ex1.js-pyg.html-27"></a>    <span class="p">},</span> <span class="p">{</span>
<a name="code--ex12--ex1.js-pyg.html-28"></a>      <span class="nx">_id</span> <span class="o">:</span> <span class="mi">3</span>
<a name="code--ex12--ex1.js-pyg.html-29"></a>    <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Play DOOM&quot;</span>
<a name="code--ex12--ex1.js-pyg.html-30"></a>    <span class="p">,</span> <span class="nx">priority</span><span class="o">:</span> <span class="mi">1000</span>
<a name="code--ex12--ex1.js-pyg.html-31"></a>    <span class="p">,</span> <span class="nx">started</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--ex12--ex1.js-pyg.html-32"></a>    <span class="p">,</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--ex12--ex1.js-pyg.html-33"></a>    <span class="p">,</span> <span class="nx">startTime</span><span class="o">:</span> <span class="kc">null</span>
<a name="code--ex12--ex1.js-pyg.html-34"></a>    <span class="p">,</span> <span class="nx">endTime</span><span class="o">:</span> <span class="kc">null</span>
<a name="code--ex12--ex1.js-pyg.html-35"></a>    <span class="p">}</span>
<a name="code--ex12--ex1.js-pyg.html-36"></a>  <span class="p">]</span>
<a name="code--ex12--ex1.js-pyg.html-37"></a>
<a name="code--ex12--ex1.js-pyg.html-38"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;work&#39;</span><span class="p">);</span>
<a name="code--ex12--ex1.js-pyg.html-39"></a>
<a name="code--ex12--ex1.js-pyg.html-40"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex12--ex1.js-pyg.html-41"></a>
<a name="code--ex12--ex1.js-pyg.html-42"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex12--ex1.js-pyg.html-43"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex12--ex1.js-pyg.html-44"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;write concern on collection caught duplicate key error&quot;</span><span class="p">);</span>
<a name="code--ex12--ex1.js-pyg.html-45"></a>      <span class="p">}</span>
<a name="code--ex12--ex1.js-pyg.html-46"></a>
<a name="code--ex12--ex1.js-pyg.html-47"></a>      <span class="nx">collection</span><span class="p">.</span><span class="nx">findAndModify</span><span class="p">(</span>
<a name="code--ex12--ex1.js-pyg.html-48"></a>          <span class="p">{</span><span class="nx">started</span><span class="o">:</span><span class="kc">false</span><span class="p">}</span>
<a name="code--ex12--ex1.js-pyg.html-49"></a>        <span class="p">,</span> <span class="p">{</span><span class="nx">priority</span><span class="o">:-</span><span class="mi">1</span><span class="p">}</span>
<a name="code--ex12--ex1.js-pyg.html-50"></a>        <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">started</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">startTime</span><span class="o">:</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()}}</span>
<a name="code--ex12--ex1.js-pyg.html-51"></a>        <span class="p">,</span> <span class="p">{</span><span class="k">new</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex12--ex1.js-pyg.html-52"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;changed document&quot;</span><span class="p">);</span>
<a name="code--ex12--ex1.js-pyg.html-53"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
<a name="code--ex12--ex1.js-pyg.html-54"></a>
<a name="code--ex12--ex1.js-pyg.html-55"></a>          <span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({}).</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex12--ex1.js-pyg.html-56"></a>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;all documents&quot;</span><span class="p">);</span>
<a name="code--ex12--ex1.js-pyg.html-57"></a>            <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">docs</span><span class="p">);</span>
<a name="code--ex12--ex1.js-pyg.html-58"></a>
<a name="code--ex12--ex1.js-pyg.html-59"></a>            <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex12--ex1.js-pyg.html-60"></a>          <span class="p">});</span>
<a name="code--ex12--ex1.js-pyg.html-61"></a>      <span class="p">});</span>
<a name="code--ex12--ex1.js-pyg.html-62"></a>    <span class="p">});</span>
<a name="code--ex12--ex1.js-pyg.html-63"></a>  <span class="p">});</span>
<a name="code--ex12--ex1.js-pyg.html-64"></a><span class="p">});</span>
</pre></div><p>Execute the code and you should see the following results.</p>
<pre class="code console literal-block">
<span class="go">connected to database
changed document
{ _id: 3,
  done: false,
  endTime: null,
  priority: 1000,
  startTime: Thu Jan 24 2013 11:47:22 GMT+0100 (CET),
  started: true,
  title: 'Play DOOM' }
all documents
[ { _id: 1,
    title: 'Buy milk',
    priority: 5,
    started: false,
    done: false,
    startTime: null,
    endTime: null },
  { _id: 2,
    title: 'Become a Billionaire',
    priority: 1,
    started: false,
    done: false,
    startTime: null,
    endTime: null },
  { _id: 3,
    done: false,
    endTime: null,
    priority: 1000,
    startTime: Thu Jan 24 2013 11:47:22 GMT+0100 (CET),
    started: true,
    title: 'Play DOOM' } ]</span>
</pre>
<p>Let's look at the code we just entered, more specifically the line.</p>
<pre class="code console literal-block">
<span class="go">collection.findAndModify(
    {started:false}
  , {priority:-1}
  , {$set: {started:true, startTime:new Date()}}
  , {new:true}, function(err, doc) {
});</span>
</pre>
<p>Let's break down the <tt class="docutils literal">findAndModify</tt> operation we did above.</p>
<table border="1" class="docutils">
<colgroup>
<col width="5%" />
<col width="24%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Statement</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>query</td>
<td>{started:false}</td>
<td>Locate all the documents where the field started equals false</td>
</tr>
<tr><td>sort</td>
<td>{priority:-1}</td>
<td>Sort the documents in descending order (highest priority ones first, meaning the first one will be the one with the biggest priority)</td>
</tr>
<tr><td>doc</td>
<td>{$set: {started:true, startTime:new Date()}}</td>
<td>If we find a document set started to true and assign a start time</td>
</tr>
<tr><td>options</td>
<td>{new:true}</td>
<td>Return the changed document</td>
</tr>
</tbody>
</table>
<p>From the breakdown we can see that we will modify the document with the highest priority where work has not started. Since <tt class="docutils literal">findAndModify</tt> is an <tt class="docutils literal">atomic</tt> command it means that nobody else can modify the document while it's executing on the server. We are using this property in this example to model a queue of work where only one <tt class="docutils literal">worker</tt> works on a given task at a time. In a later exercise we will leverage this property to build a work queue and also a shopping cart.</p>
<p>Now let's assume we've finished performing the work and need to remove the document from the list of work (maybe to insert into a history collection of work done). Let's modify the code a little bit to do this. Notice that when using the <tt class="docutils literal">remove</tt> option we are not able to modify the document so this has to happen be done in code.</p>
<div class="highlight"><pre><a name="code--ex12--ex2.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex12--ex2.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex12--ex2.js-pyg.html-3"></a>
<a name="code--ex12--ex2.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex12--ex2.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex12--ex2.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex12--ex2.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex12--ex2.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex12--ex2.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex12--ex2.js-pyg.html-10"></a>
<a name="code--ex12--ex2.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[{</span>
<a name="code--ex12--ex2.js-pyg.html-12"></a>      <span class="nx">_id</span> <span class="o">:</span> <span class="mi">1</span>
<a name="code--ex12--ex2.js-pyg.html-13"></a>    <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Buy milk&quot;</span>
<a name="code--ex12--ex2.js-pyg.html-14"></a>    <span class="p">,</span> <span class="nx">priority</span><span class="o">:</span> <span class="mi">5</span>
<a name="code--ex12--ex2.js-pyg.html-15"></a>    <span class="p">,</span> <span class="nx">started</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--ex12--ex2.js-pyg.html-16"></a>    <span class="p">,</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--ex12--ex2.js-pyg.html-17"></a>    <span class="p">,</span> <span class="nx">startTime</span><span class="o">:</span> <span class="kc">null</span>
<a name="code--ex12--ex2.js-pyg.html-18"></a>    <span class="p">,</span> <span class="nx">endTime</span><span class="o">:</span> <span class="kc">null</span>
<a name="code--ex12--ex2.js-pyg.html-19"></a>    <span class="p">},</span> <span class="p">{</span>
<a name="code--ex12--ex2.js-pyg.html-20"></a>      <span class="nx">_id</span> <span class="o">:</span> <span class="mi">2</span>
<a name="code--ex12--ex2.js-pyg.html-21"></a>    <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Become a Billionaire&quot;</span>
<a name="code--ex12--ex2.js-pyg.html-22"></a>    <span class="p">,</span> <span class="nx">priority</span><span class="o">:</span> <span class="mi">1</span>
<a name="code--ex12--ex2.js-pyg.html-23"></a>    <span class="p">,</span> <span class="nx">started</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--ex12--ex2.js-pyg.html-24"></a>    <span class="p">,</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--ex12--ex2.js-pyg.html-25"></a>    <span class="p">,</span> <span class="nx">startTime</span><span class="o">:</span> <span class="kc">null</span>
<a name="code--ex12--ex2.js-pyg.html-26"></a>    <span class="p">,</span> <span class="nx">endTime</span><span class="o">:</span> <span class="kc">null</span>
<a name="code--ex12--ex2.js-pyg.html-27"></a>    <span class="p">},</span> <span class="p">{</span>
<a name="code--ex12--ex2.js-pyg.html-28"></a>      <span class="nx">_id</span> <span class="o">:</span> <span class="mi">3</span>
<a name="code--ex12--ex2.js-pyg.html-29"></a>    <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Play DOOM&quot;</span>
<a name="code--ex12--ex2.js-pyg.html-30"></a>    <span class="p">,</span> <span class="nx">priority</span><span class="o">:</span> <span class="mi">1000</span>
<a name="code--ex12--ex2.js-pyg.html-31"></a>    <span class="p">,</span> <span class="nx">started</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--ex12--ex2.js-pyg.html-32"></a>    <span class="p">,</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--ex12--ex2.js-pyg.html-33"></a>    <span class="p">,</span> <span class="nx">startTime</span><span class="o">:</span> <span class="kc">null</span>
<a name="code--ex12--ex2.js-pyg.html-34"></a>    <span class="p">,</span> <span class="nx">endTime</span><span class="o">:</span> <span class="kc">null</span>
<a name="code--ex12--ex2.js-pyg.html-35"></a>    <span class="p">}</span>
<a name="code--ex12--ex2.js-pyg.html-36"></a>  <span class="p">]</span>
<a name="code--ex12--ex2.js-pyg.html-37"></a>
<a name="code--ex12--ex2.js-pyg.html-38"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;work&#39;</span><span class="p">);</span>
<a name="code--ex12--ex2.js-pyg.html-39"></a>
<a name="code--ex12--ex2.js-pyg.html-40"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex12--ex2.js-pyg.html-41"></a>
<a name="code--ex12--ex2.js-pyg.html-42"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex12--ex2.js-pyg.html-43"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex12--ex2.js-pyg.html-44"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;write concern on collection caught duplicate key error&quot;</span><span class="p">);</span>
<a name="code--ex12--ex2.js-pyg.html-45"></a>      <span class="p">}</span>
<a name="code--ex12--ex2.js-pyg.html-46"></a>
<a name="code--ex12--ex2.js-pyg.html-47"></a>      <span class="nx">collection</span><span class="p">.</span><span class="nx">findAndModify</span><span class="p">(</span>
<a name="code--ex12--ex2.js-pyg.html-48"></a>          <span class="p">{</span><span class="nx">started</span><span class="o">:</span><span class="kc">false</span><span class="p">}</span>
<a name="code--ex12--ex2.js-pyg.html-49"></a>        <span class="p">,</span> <span class="p">{</span><span class="nx">priority</span><span class="o">:-</span><span class="mi">1</span><span class="p">}</span>
<a name="code--ex12--ex2.js-pyg.html-50"></a>        <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">started</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">startTime</span><span class="o">:</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()}}</span>
<a name="code--ex12--ex2.js-pyg.html-51"></a>        <span class="p">,</span> <span class="p">{</span><span class="k">new</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex12--ex2.js-pyg.html-52"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;changed document&quot;</span><span class="p">);</span>
<a name="code--ex12--ex2.js-pyg.html-53"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
<a name="code--ex12--ex2.js-pyg.html-54"></a>
<a name="code--ex12--ex2.js-pyg.html-55"></a>          <span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({}).</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex12--ex2.js-pyg.html-56"></a>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;all documents&quot;</span><span class="p">);</span>
<a name="code--ex12--ex2.js-pyg.html-57"></a>            <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">docs</span><span class="p">);</span>
<a name="code--ex12--ex2.js-pyg.html-58"></a>
<a name="code--ex12--ex2.js-pyg.html-59"></a>            <span class="nx">collection</span><span class="p">.</span><span class="nx">findAndModify</span><span class="p">(</span>
<a name="code--ex12--ex2.js-pyg.html-60"></a>                <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">}</span>
<a name="code--ex12--ex2.js-pyg.html-61"></a>              <span class="p">,</span> <span class="p">{}</span>
<a name="code--ex12--ex2.js-pyg.html-62"></a>              <span class="p">,</span> <span class="p">{}</span>
<a name="code--ex12--ex2.js-pyg.html-63"></a>              <span class="p">,</span> <span class="p">{</span><span class="nx">remove</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex12--ex2.js-pyg.html-64"></a>                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;removed document&quot;</span><span class="p">);</span>
<a name="code--ex12--ex2.js-pyg.html-65"></a>                <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
<a name="code--ex12--ex2.js-pyg.html-66"></a>
<a name="code--ex12--ex2.js-pyg.html-67"></a>                <span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({}).</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex12--ex2.js-pyg.html-68"></a>                  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;all documents&quot;</span><span class="p">);</span>
<a name="code--ex12--ex2.js-pyg.html-69"></a>                  <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">docs</span><span class="p">);</span>
<a name="code--ex12--ex2.js-pyg.html-70"></a>
<a name="code--ex12--ex2.js-pyg.html-71"></a>                  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex12--ex2.js-pyg.html-72"></a>                <span class="p">});</span>
<a name="code--ex12--ex2.js-pyg.html-73"></a>              <span class="p">});</span>
<a name="code--ex12--ex2.js-pyg.html-74"></a>          <span class="p">});</span>
<a name="code--ex12--ex2.js-pyg.html-75"></a>      <span class="p">});</span>
<a name="code--ex12--ex2.js-pyg.html-76"></a>    <span class="p">});</span>
<a name="code--ex12--ex2.js-pyg.html-77"></a>  <span class="p">});</span>
<a name="code--ex12--ex2.js-pyg.html-78"></a><span class="p">});</span>
</pre></div><p>The results should look like this.</p>
<pre class="code console literal-block">
<span class="go">connected to database
changed document
{ _id: 3,
  done: false,
  endTime: null,
  priority: 1000,
  startTime: Thu Jan 24 2013 12:32:50 GMT+0100 (CET),
  started: true,
  title: 'Play DOOM' }
all documents
[ { _id: 1,
    title: 'Buy milk',
    priority: 5,
    started: false,
    done: false,
    startTime: null,
    endTime: null },
  { _id: 2,
    title: 'Become a Billionaire',
    priority: 1,
    started: false,
    done: false,
    startTime: null,
    endTime: null },
  { _id: 3,
    done: false,
    endTime: null,
    priority: 1000,
    startTime: Thu Jan 24 2013 12:32:50 GMT+0100 (CET),
    started: true,
    title: 'Play DOOM' } ]
removed document
{ _id: 3,
  done: false,
  endTime: null,
  priority: 1000,
  startTime: Thu Jan 24 2013 12:32:50 GMT+0100 (CET),
  started: true,
  title: 'Play DOOM' }
all documents
[ { _id: 1,
    title: 'Buy milk',
    priority: 5,
    started: false,
    done: false,
    startTime: null,
    endTime: null },
  { _id: 2,
    title: 'Become a Billionaire',
    priority: 1,
    started: false,
    done: false,
    startTime: null,
    endTime: null } ]</span>
</pre>
<p>For the remove option of <tt class="docutils literal">findAndModify</tt> you can use a special version of it on the <tt class="docutils literal">collection</tt> called <tt class="docutils literal">findAndRemove</tt> that just removes the <tt class="docutils literal">update</tt> section of the <tt class="docutils literal">findAndModify</tt> command. If you do want to perform removes I recommend using this method to avoid the confusion of <tt class="docutils literal">remove</tt> not allowing modifications of the document.</p>
<p>You might have noticed that there is an <tt class="docutils literal">upsert</tt> option for the <tt class="docutils literal">findAndModify</tt> command. This works exactly as the <tt class="docutils literal">upsert</tt> for the <tt class="docutils literal">update</tt> command but of course let's you return the document. Let's take a look at a simple example using it.</p>
<div class="highlight"><pre><a name="code--ex12--ex3.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex12--ex3.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex12--ex3.js-pyg.html-3"></a>
<a name="code--ex12--ex3.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex12--ex3.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex12--ex3.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex12--ex3.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex12--ex3.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex12--ex3.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex12--ex3.js-pyg.html-10"></a>
<a name="code--ex12--ex3.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;work&#39;</span><span class="p">);</span>
<a name="code--ex12--ex3.js-pyg.html-12"></a>
<a name="code--ex12--ex3.js-pyg.html-13"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex12--ex3.js-pyg.html-14"></a>
<a name="code--ex12--ex3.js-pyg.html-15"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">findAndModify</span><span class="p">(</span>
<a name="code--ex12--ex3.js-pyg.html-16"></a>        <span class="p">{</span><span class="nx">started</span><span class="o">:</span><span class="kc">false</span><span class="p">}</span>
<a name="code--ex12--ex3.js-pyg.html-17"></a>      <span class="p">,</span> <span class="p">{</span><span class="nx">priority</span><span class="o">:-</span><span class="mi">1</span><span class="p">}</span>
<a name="code--ex12--ex3.js-pyg.html-18"></a>      <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">started</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">startTime</span><span class="o">:</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()}}</span>
<a name="code--ex12--ex3.js-pyg.html-19"></a>      <span class="p">,</span> <span class="p">{</span><span class="k">new</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">upsert</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex12--ex3.js-pyg.html-20"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;added document&quot;</span><span class="p">);</span>
<a name="code--ex12--ex3.js-pyg.html-21"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
<a name="code--ex12--ex3.js-pyg.html-22"></a>
<a name="code--ex12--ex3.js-pyg.html-23"></a>        <span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({}).</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex12--ex3.js-pyg.html-24"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;all documents&quot;</span><span class="p">);</span>
<a name="code--ex12--ex3.js-pyg.html-25"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">docs</span><span class="p">);</span>
<a name="code--ex12--ex3.js-pyg.html-26"></a>
<a name="code--ex12--ex3.js-pyg.html-27"></a>          <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex12--ex3.js-pyg.html-28"></a>        <span class="p">});</span>
<a name="code--ex12--ex3.js-pyg.html-29"></a>    <span class="p">});</span>
<a name="code--ex12--ex3.js-pyg.html-30"></a>  <span class="p">});</span>
<a name="code--ex12--ex3.js-pyg.html-31"></a><span class="p">});</span>
</pre></div><p>You should see the following when executing the code.</p>
<pre class="code console literal-block">
<span class="go">connected to database
added document
{ _id: 51011f910ac025483df1af06,
  startTime: Thu Jan 24 2013 12:48:33 GMT+0100 (CET),
  started: true }
all documents
[ { _id: 51011f910ac025483df1af06,
    startTime: Thu Jan 24 2013 12:48:33 GMT+0100 (CET),
    started: true } ]</span>
</pre>
<p>This pretty much covers the <tt class="docutils literal">findAndModify</tt> and <tt class="docutils literal">findAndRemove</tt> commands.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">It might be tempting to use <tt class="docutils literal">findAndModify</tt> everywhere you would typically use an update. You should avoid this temptation and use it only when appropriate as it takes out a write lock for the duration of the operation potentially slowing down all the other write operations in the affected database. Most of the time you might discover that you do not in fact need the returned the document and that the operation can be better described as a query and update operation. Use <tt class="docutils literal">findAndModify</tt> when you have to ensure that only a single operation can modify the document in question. The example above with the work queue is a good candidate for the usage of <tt class="docutils literal">findAndModify</tt> and in later exercises we will look at some more concrete examples that are good fits.</p>
</div>
</div>
</div>
<div class="section" id="exercise-13-removing-documents">
<h2><a class="toc-backref" href="#id54">Exercise 13: Removing Documents</a></h2>
<p>We've learned how to insert and update documents. But what if we want to remove documents from the database. Thankfully the <tt class="docutils literal">collection</tt> has a method called <tt class="docutils literal">remove</tt> that does exactly that. Let's see how it works.</p>
<div class="highlight"><pre><a name="code--ex13--ex1.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex13--ex1.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex13--ex1.js-pyg.html-3"></a>
<a name="code--ex13--ex1.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex13--ex1.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex13--ex1.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex13--ex1.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex13--ex1.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex13--ex1.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex13--ex1.js-pyg.html-10"></a>
<a name="code--ex13--ex1.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[{</span>
<a name="code--ex13--ex1.js-pyg.html-12"></a>        <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
<a name="code--ex13--ex1.js-pyg.html-13"></a>      <span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="mi">1</span>
<a name="code--ex13--ex1.js-pyg.html-14"></a>      <span class="p">,</span> <span class="nx">read</span><span class="o">:</span><span class="kc">false</span>
<a name="code--ex13--ex1.js-pyg.html-15"></a>    <span class="p">},</span> <span class="p">{</span>
<a name="code--ex13--ex1.js-pyg.html-16"></a>        <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
<a name="code--ex13--ex1.js-pyg.html-17"></a>      <span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="mi">1</span>
<a name="code--ex13--ex1.js-pyg.html-18"></a>      <span class="p">,</span> <span class="nx">read</span><span class="o">:</span><span class="kc">false</span>
<a name="code--ex13--ex1.js-pyg.html-19"></a>    <span class="p">},</span> <span class="p">{</span>
<a name="code--ex13--ex1.js-pyg.html-20"></a>        <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
<a name="code--ex13--ex1.js-pyg.html-21"></a>      <span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="mi">2</span>
<a name="code--ex13--ex1.js-pyg.html-22"></a>      <span class="p">,</span> <span class="nx">read</span><span class="o">:</span><span class="kc">false</span>
<a name="code--ex13--ex1.js-pyg.html-23"></a>    <span class="p">}</span>
<a name="code--ex13--ex1.js-pyg.html-24"></a>  <span class="p">];</span>
<a name="code--ex13--ex1.js-pyg.html-25"></a>
<a name="code--ex13--ex1.js-pyg.html-26"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;upserts&#39;</span><span class="p">);</span>
<a name="code--ex13--ex1.js-pyg.html-27"></a>
<a name="code--ex13--ex1.js-pyg.html-28"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex13--ex1.js-pyg.html-29"></a>
<a name="code--ex13--ex1.js-pyg.html-30"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex13--ex1.js-pyg.html-31"></a>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;added document&quot;</span><span class="p">);</span>
<a name="code--ex13--ex1.js-pyg.html-32"></a>
<a name="code--ex13--ex1.js-pyg.html-33"></a>      <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex13--ex1.js-pyg.html-34"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;removed documents&quot;</span><span class="p">);</span>
<a name="code--ex13--ex1.js-pyg.html-35"></a>
<a name="code--ex13--ex1.js-pyg.html-36"></a>        <span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex13--ex1.js-pyg.html-37"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;documents&quot;</span><span class="p">);</span>
<a name="code--ex13--ex1.js-pyg.html-38"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">docs</span><span class="p">);</span>
<a name="code--ex13--ex1.js-pyg.html-39"></a>          <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex13--ex1.js-pyg.html-40"></a>        <span class="p">});</span>
<a name="code--ex13--ex1.js-pyg.html-41"></a>      <span class="p">});</span>
<a name="code--ex13--ex1.js-pyg.html-42"></a>    <span class="p">});</span>
<a name="code--ex13--ex1.js-pyg.html-43"></a>  <span class="p">});</span>
<a name="code--ex13--ex1.js-pyg.html-44"></a><span class="p">});</span>
</pre></div><p>The result will be</p>
<pre class="code console literal-block">
<span class="go">connected to database
added document
removed documents
documents
[ { _id: 3, user: 2, read: false } ]</span>
</pre>
<p>Notice that it removed all the documents that matched <tt class="docutils literal">{user:1}</tt>. The default behavior of <tt class="docutils literal">remove</tt> is to remove all the documents that match. But what if we only want to remove a single document. Luckily there is an option called <tt class="docutils literal">single</tt> that allows us to do this. Let's see how it works.</p>
<div class="highlight"><pre><a name="code--ex13--ex2.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex13--ex2.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex13--ex2.js-pyg.html-3"></a>
<a name="code--ex13--ex2.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex13--ex2.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex13--ex2.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex13--ex2.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex13--ex2.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex13--ex2.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex13--ex2.js-pyg.html-10"></a>
<a name="code--ex13--ex2.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[{</span>
<a name="code--ex13--ex2.js-pyg.html-12"></a>        <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
<a name="code--ex13--ex2.js-pyg.html-13"></a>      <span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="mi">1</span>
<a name="code--ex13--ex2.js-pyg.html-14"></a>      <span class="p">,</span> <span class="nx">read</span><span class="o">:</span><span class="kc">false</span>
<a name="code--ex13--ex2.js-pyg.html-15"></a>    <span class="p">},</span> <span class="p">{</span>
<a name="code--ex13--ex2.js-pyg.html-16"></a>        <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
<a name="code--ex13--ex2.js-pyg.html-17"></a>      <span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="mi">1</span>
<a name="code--ex13--ex2.js-pyg.html-18"></a>      <span class="p">,</span> <span class="nx">read</span><span class="o">:</span><span class="kc">false</span>
<a name="code--ex13--ex2.js-pyg.html-19"></a>    <span class="p">},</span> <span class="p">{</span>
<a name="code--ex13--ex2.js-pyg.html-20"></a>        <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
<a name="code--ex13--ex2.js-pyg.html-21"></a>      <span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="mi">2</span>
<a name="code--ex13--ex2.js-pyg.html-22"></a>      <span class="p">,</span> <span class="nx">read</span><span class="o">:</span><span class="kc">false</span>
<a name="code--ex13--ex2.js-pyg.html-23"></a>    <span class="p">}</span>
<a name="code--ex13--ex2.js-pyg.html-24"></a>  <span class="p">];</span>
<a name="code--ex13--ex2.js-pyg.html-25"></a>
<a name="code--ex13--ex2.js-pyg.html-26"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;upserts&#39;</span><span class="p">);</span>
<a name="code--ex13--ex2.js-pyg.html-27"></a>
<a name="code--ex13--ex2.js-pyg.html-28"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex13--ex2.js-pyg.html-29"></a>
<a name="code--ex13--ex2.js-pyg.html-30"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex13--ex2.js-pyg.html-31"></a>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;added document&quot;</span><span class="p">);</span>
<a name="code--ex13--ex2.js-pyg.html-32"></a>
<a name="code--ex13--ex2.js-pyg.html-33"></a>      <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">single</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex13--ex2.js-pyg.html-34"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;removed documents&quot;</span><span class="p">);</span>
<a name="code--ex13--ex2.js-pyg.html-35"></a>
<a name="code--ex13--ex2.js-pyg.html-36"></a>        <span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex13--ex2.js-pyg.html-37"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;documents&quot;</span><span class="p">);</span>
<a name="code--ex13--ex2.js-pyg.html-38"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">docs</span><span class="p">);</span>
<a name="code--ex13--ex2.js-pyg.html-39"></a>          <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex13--ex2.js-pyg.html-40"></a>        <span class="p">});</span>
<a name="code--ex13--ex2.js-pyg.html-41"></a>      <span class="p">});</span>
<a name="code--ex13--ex2.js-pyg.html-42"></a>    <span class="p">});</span>
<a name="code--ex13--ex2.js-pyg.html-43"></a>  <span class="p">});</span>
<a name="code--ex13--ex2.js-pyg.html-44"></a><span class="p">});</span>
</pre></div><p>The result will be</p>
<pre class="code console literal-block">
<span class="go">connected to database
added document
removed documents
documents
[ { _id: 2, user: 1, read: false },
  { _id: 3, user: 2, read: false } ]</span>
</pre>
<p>That's all there is to removing document in <tt class="docutils literal">MongoDB</tt>. In the next couple of exercises we will start digging into how to query and use the data in <tt class="docutils literal">MongoDB</tt> using the <tt class="docutils literal">findOne</tt>, <tt class="docutils literal">find</tt> and <tt class="docutils literal">stream</tt> functions.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">One thing you might wonder is how to remove all of the documents in a <tt class="docutils literal">collection</tt>. This is can be done in two ways. <tt class="docutils literal"><span class="pre">remove({},</span> function(err, result) {})</tt> or <tt class="docutils literal">remove(function(err, result) {})</tt>.</p>
</div>
</div>
<div class="section" id="exercise-14-querying-mongodb">
<h2><a class="toc-backref" href="#id55">Exercise 14: Querying MongoDB</a></h2>
<p>To understand how queries work in <tt class="docutils literal">MongoDB</tt> we need to understand how they work under the covers. When you execute a query against <tt class="docutils literal">MongoDB</tt> it will create what is called a <tt class="docutils literal">Cursor</tt> that is pointing to the results from the query. This is easier to show. Let's imagine that we perform a query asking for all cars that are owned by Steve. The might look like this.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">owner</span><span class="o">:</span> <span class="s1">'Steve'</span><span class="p">}</span>
</pre>
<p>There might be 1000 results for this query in the database as Steve is a very rich man indeed. To avoid sending all of the documents all at once to your application <tt class="docutils literal">MongoDB</tt> decides to send only the first <tt class="docutils literal">100</tt> cars. That leaves  <tt class="docutils literal">900</tt> cars that we need to transfer. To be able to keep track of where in the 1000 cars we are for the next <tt class="docutils literal">100</tt> we want to read <tt class="docutils literal">MongoDB</tt> keeps a <tt class="docutils literal">Cursor</tt> pointing to the current read location in the 1000 cars result. In this case the <tt class="docutils literal">Cursor</tt> would point to <cite>100</cite>.</p>
<table border="1" class="docutils">
<colgroup>
<col width="22%" />
<col width="22%" />
<col width="56%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Start</th>
<th class="head">End</th>
<th class="head">Cursor Position</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>0</td>
<td>100</td>
<td>X</td>
</tr>
<tr><td>100</td>
<td>200</td>
<td>&nbsp;</td>
</tr>
<tr><td>200</td>
<td>300</td>
<td>&nbsp;</td>
</tr>
<tr><td>.</td>
<td>.</td>
<td>&nbsp;</td>
</tr>
<tr><td>900</td>
<td>1000</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p>After reading the first <tt class="docutils literal">100</tt> cars the cursor position changes to point to the next <tt class="docutils literal">100</tt> cars.</p>
<table border="1" class="docutils">
<colgroup>
<col width="21%" />
<col width="21%" />
<col width="57%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Start</th>
<th class="head">End</th>
<th class="head">Cursor Position</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>0</td>
<td>100</td>
<td>&nbsp;</td>
</tr>
<tr><td>100</td>
<td>200</td>
<td>X</td>
</tr>
<tr><td>200</td>
<td>300</td>
<td>&nbsp;</td>
</tr>
<tr><td>.</td>
<td>.</td>
<td>&nbsp;</td>
</tr>
<tr><td>900</td>
<td>1000</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p>We are only using <tt class="docutils literal">100</tt> as an example your application could choose to read only 4 documents at the time as you can tell <tt class="docutils literal">MongoDB</tt> how big you want each read to be. But more about that later. Once you finish reading the documents the <tt class="docutils literal">Cursor</tt> is removed on <tt class="docutils literal">MongoDB</tt>. There are some limitations on <tt class="docutils literal">Cursors</tt>. You cannot go backwards in time only forward. In other words if you read the first <tt class="docutils literal">100</tt> cars from the <tt class="docutils literal">Cursor</tt> you cannot then reread the first <tt class="docutils literal">100</tt> cars from the same cursor. You will have to execute a brand new query to do this.</p>
<p>The <tt class="docutils literal">NodeJS</tt> driver represents the <tt class="docutils literal">MongoDB</tt> cursor using a class called <tt class="docutils literal">Cursor</tt> that we will explore in depth in later exercises. For this exercise we will explore the <tt class="docutils literal">MongoDB</tt> query language using the simplest query function the driver has called <tt class="docutils literal">findOne</tt> that returns the first document from a query.</p>
<div class="section" id="the-query-language">
<h3><a class="toc-backref" href="#id56">The Query Language</a></h3>
<p>The <tt class="docutils literal">MongoDB</tt> query language features several different operators. These include Comparison, Logical, Element, JavaScript, Geospatial and Array operators. In this exercise we will cover the Comparison, Logical, Element, JavaScript and Array operator. We will leave Geospatial ones to a later exercise.</p>
<p>So lets start with the Comparison operators.</p>
</div>
<div class="section" id="comparison-operators">
<h3><a class="toc-backref" href="#id57">Comparison operators</a></h3>
<p>The comparison operators let's you compare documents to values to select the ones you wish to be returned. There are several operators available including <tt class="docutils literal">$all</tt>, <tt class="docutils literal">$gt</tt>, <tt class="docutils literal">$gte</tt>, <tt class="docutils literal">$in</tt>, <tt class="docutils literal">$lt</tt>, <tt class="docutils literal">$lte</tt>, <tt class="docutils literal">$ne</tt> and <tt class="docutils literal">$nin</tt>. Let's go through them and see how they work (we only look at how the matching works).</p>
</div>
<div class="section" id="all-contains-all">
<h3><a class="toc-backref" href="#id58"><tt class="docutils literal">$all</tt> (Contains all)</a></h3>
<p>Say you have a set of documents containing some tags.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Wing Commander 72&quot;</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;13+&quot;</span><span class="p">]</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Dead space 15&quot;</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;mac&quot;</span><span class="p">,</span> <span class="s2">&quot;18+&quot;</span><span class="p">]</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Star Controller 2&quot;</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;10+&quot;</span><span class="p">]</span>
<span class="p">}]</span>
</pre>
<p>Now image that you want to locate all the documents that contain the tags <tt class="docutils literal">&quot;game&quot;</tt>, <tt class="docutils literal">&quot;scifi&quot;</tt> and <tt class="docutils literal">&quot;pc&quot;</tt>. This is where the <tt class="docutils literal">$all</tt> operator comes in. Our query would look like this.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">tags</span><span class="o">:</span> <span class="p">{</span><span class="nx">$all</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">]}}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Wing Commander 72&quot;</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;13+&quot;</span> <span class="p">]</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Star Controller 2&quot;</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;10+&quot;</span> <span class="p">]</span> <span class="p">}</span>
</pre>
</div>
<div class="section" id="gt-greater-than">
<h3><a class="toc-backref" href="#id59"><tt class="docutils literal">$gt</tt> (Greater Than)</a></h3>
<p>Say you have some user documents containing the field age.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Agent Smith&quot;</span>
  <span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">67</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Mr Anderson&quot;</span>
  <span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">25</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Trinity&quot;</span>
  <span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">28</span>
<span class="p">}]</span>
</pre>
<p>You wish to query for the users that are older than 30 years. Let's use the <tt class="docutils literal">$gt</tt> or <tt class="docutils literal">Greater Than</tt> operator. The query would look like this.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">age</span><span class="o">:</span> <span class="p">{</span><span class="nx">$gt</span><span class="o">:</span> <span class="mi">28</span><span class="p">}}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;Agent Smith&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">67</span> <span class="p">}</span>
</pre>
</div>
<div class="section" id="gte-greater-than-or-equal">
<h3><a class="toc-backref" href="#id60"><tt class="docutils literal">$gte</tt> (Greater Than or Equal)</a></h3>
<p><tt class="docutils literal">$gte</tt> or <tt class="docutils literal">Greater than or Equal</tt> is similar to <tt class="docutils literal">$gt</tt> but includes any documents that match the value provided as well as any values larger than the provided value. Given the following documents.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Agent Smith&quot;</span>
  <span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">67</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Mr Anderson&quot;</span>
  <span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">25</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Trinity&quot;</span>
  <span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">28</span>
<span class="p">}]</span>
</pre>
<p>Let's select all the documents where the age is greater or equal to <tt class="docutils literal">28</tt>.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">age</span><span class="o">:</span> <span class="p">{</span><span class="nx">$gte</span><span class="o">:</span> <span class="mi">28</span><span class="p">}}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;Agent Smith&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">67</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;Trinity&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">28</span> <span class="p">}</span>
</pre>
</div>
<div class="section" id="in-contains-one-of">
<h3><a class="toc-backref" href="#id61"><tt class="docutils literal">$in</tt> (Contains One Of)</a></h3>
<p>The <tt class="docutils literal">$in</tt> operator lets us match any document where a value is in a predefined set of values. Let's take a set of documents.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Wing Commander 72&quot;</span>
  <span class="p">,</span> <span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;xbox1080&quot;</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Dead space 15&quot;</span>
  <span class="p">,</span> <span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;ps2000&quot;</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Star Controller 2&quot;</span>
  <span class="p">,</span> <span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;pc&quot;</span>
<span class="p">}]</span>
</pre>
<p>Let's select all the games that are available for the <tt class="docutils literal">xbox1080</tt> and the <tt class="docutils literal">ps2000</tt>.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">platform</span><span class="o">:</span> <span class="p">{</span><span class="nx">$in</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;ps2000&quot;</span><span class="p">,</span> <span class="s2">&quot;xbox1080&quot;</span><span class="p">]}}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Wing Commander 72&quot;</span><span class="p">,</span> <span class="s2">&quot;platform&quot;</span> <span class="o">:</span> <span class="s2">&quot;xbox1080&quot;</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Dead space 15&quot;</span><span class="p">,</span> <span class="s2">&quot;platform&quot;</span> <span class="o">:</span> <span class="s2">&quot;ps2000&quot;</span> <span class="p">}</span>
</pre>
</div>
<div class="section" id="lt-less-than">
<h3><a class="toc-backref" href="#id62"><tt class="docutils literal">$lt</tt> (Less Than)</a></h3>
<p>Say you have some user documents containing the field age.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Agent Smith&quot;</span>
  <span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">67</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Mr Anderson&quot;</span>
  <span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">25</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Trinity&quot;</span>
  <span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">28</span>
<span class="p">}]</span>
</pre>
<p>We wish to select all the users where the age is less than 28.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">age</span><span class="o">:</span> <span class="p">{</span><span class="nx">$lt</span><span class="o">:</span> <span class="mi">28</span><span class="p">}}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;Mr Anderson&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">25</span> <span class="p">}</span>
</pre>
</div>
<div class="section" id="lte-less-than-or-equal">
<h3><a class="toc-backref" href="#id63"><tt class="docutils literal">$lte</tt> (Less Than or Equal)</a></h3>
<p>Just as with <tt class="docutils literal">$gte</tt>, <tt class="docutils literal">$lte</tt> is a Less than or equal operator letting you find all documents where the specified field is less or equal to the provided value. Let's see it in action.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Agent Smith&quot;</span>
  <span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">67</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Mr Anderson&quot;</span>
  <span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">25</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Trinity&quot;</span>
  <span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">28</span>
<span class="p">}]</span>
</pre>
<p>We wish to select all the users where the age is less than 28.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">age</span><span class="o">:</span> <span class="p">{</span><span class="nx">$lte</span><span class="o">:</span> <span class="mi">28</span><span class="p">}}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;Mr Anderson&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">25</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;Trinity&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">28</span> <span class="p">}</span>
</pre>
</div>
<div class="section" id="ne-not-equal-to">
<h3><a class="toc-backref" href="#id64"><tt class="docutils literal">$ne</tt> (Not Equal To)</a></h3>
<p>Imagine if we wish to find all documents that does not specify a specific value. Let's take an example set of documents.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Agent Smith&quot;</span>
  <span class="p">,</span> <span class="nx">agent</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Mr Anderson&quot;</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Trinity&quot;</span>
  <span class="p">,</span> <span class="nx">agent</span><span class="o">:</span> <span class="kc">false</span>
<span class="p">}]</span>
</pre>
<p>We wish to select all the users who are not agents.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">agent</span><span class="o">:</span> <span class="p">{</span><span class="nx">$ne</span><span class="o">:</span> <span class="kc">true</span><span class="p">}}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;Mr Anderson&quot;</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;Trinity&quot;</span><span class="p">,</span> <span class="s2">&quot;agent&quot;</span> <span class="o">:</span> <span class="kc">false</span> <span class="p">}</span>
</pre>
<p>Take not that <tt class="docutils literal">$ne</tt> matches not only on the document that has <tt class="docutils literal">agent:false</tt> but also the document that does not contain the <tt class="docutils literal">agent</tt> field.</p>
</div>
<div class="section" id="nin-contains-none-of">
<h3><a class="toc-backref" href="#id65"><tt class="docutils literal">$nin</tt> (Contains None Of)</a></h3>
<p>Think of <tt class="docutils literal">$nin</tt> as a reverse off the <tt class="docutils literal">$in</tt> operator. Let's define a set of documents.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Wing Commander 72&quot;</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;13+&quot;</span><span class="p">]</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Dead space 15&quot;</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;mac&quot;</span><span class="p">,</span> <span class="s2">&quot;18+&quot;</span><span class="p">]</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Star Controller 2&quot;</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;10+&quot;</span><span class="p">]</span>
<span class="p">}]</span>
</pre>
<p>Let's select all the games that do not contain the <tt class="docutils literal">pc</tt> tag.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">tags</span><span class="o">:</span><span class="p">{</span><span class="nx">$nin</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;pc&quot;</span><span class="p">]}}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Dead space 15&quot;</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;mac&quot;</span><span class="p">,</span> <span class="s2">&quot;18+&quot;</span> <span class="p">]</span> <span class="p">}</span>
</pre>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">In a later exercise we will learn about something called indexes that speed up queries. <tt class="docutils literal">$nin</tt> is poison for search on very big collections because <tt class="docutils literal">$nin</tt> queries cannot use an index and needs to scan through all of the document individually. The best is to rewrite you code to avoid <tt class="docutils literal">$nin</tt> or only use it in very small collections where the cost of scanning through all of the documents is very low.</p>
</div>
<p>That covers all the comparison expressions for <tt class="docutils literal">MongoDB</tt>. Next let's see how we can combine them with <tt class="docutils literal">Logical</tt> operators to make create more advanced queries.</p>
</div>
<div class="section" id="logical-operators">
<h3><a class="toc-backref" href="#id66">Logical operators</a></h3>
<p>So what if you want to query for an age range (between 10 and 20 years) or return only documents where the age is 20 and the location is Barcelona. This is where the logical operators come in. There are four of them in <tt class="docutils literal">MongoDB</tt>. They are <tt class="docutils literal">$and</tt>, <tt class="docutils literal">$or</tt>, <tt class="docutils literal">$not</tt> and <tt class="docutils literal">$or</tt>. Let's look at them in turn.</p>
</div>
<div class="section" id="and">
<h3><a class="toc-backref" href="#id67"><tt class="docutils literal">$and</tt></a></h3>
<p>The <tt class="docutils literal">$and</tt> operator allows to ask questions like find me all users aged 28 and living in New York. Only documents matching both of them will be returned. Let's look at a simple example.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Agent Smith&quot;</span>
  <span class="p">,</span> <span class="nx">location</span><span class="o">:</span> <span class="s2">&quot;NYC&quot;</span>
  <span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">67</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Mr Anderson&quot;</span>
  <span class="p">,</span> <span class="nx">location</span><span class="o">:</span> <span class="s2">&quot;NYC&quot;</span>
  <span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">25</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Trinity&quot;</span>
  <span class="p">,</span> <span class="nx">location</span><span class="o">:</span> <span class="s2">&quot;NYC&quot;</span>
  <span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">28</span>
<span class="p">}]</span>
</pre>
<p>We wish to select all the users where the age is less than 28.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">$and</span><span class="o">:</span> <span class="p">[</span><span class="p">{</span><span class="nx">age</span><span class="o">:</span> <span class="mi">28</span><span class="p">},</span> <span class="p">{</span><span class="nx">location</span><span class="o">:</span> <span class="s2">&quot;NYC&quot;</span><span class="p">}]}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;Trinity&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span> <span class="o">:</span> <span class="s2">&quot;NYC&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">28</span> <span class="p">}</span>
</pre>
<p>Let's look at how we can combine the logical operator with a comparison operator to select a range. More specifically all the users living in NYC between and including the ages of 28 and 70.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">$and</span><span class="o">:</span> <span class="p">[</span><span class="p">{</span><span class="nx">age</span><span class="o">:</span> <span class="p">{</span><span class="nx">$gte</span><span class="o">:</span> <span class="mi">28</span><span class="p">}},</span> <span class="p">{</span><span class="nx">age</span><span class="o">:</span> <span class="p">{</span><span class="nx">$lte</span><span class="o">:</span> <span class="mi">70</span><span class="p">}},</span> <span class="p">{</span><span class="nx">location</span><span class="o">:</span> <span class="s2">&quot;NYC&quot;</span><span class="p">}]}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;Agent Smith&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span> <span class="o">:</span> <span class="s2">&quot;NYC&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">67</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;Trinity&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span> <span class="o">:</span> <span class="s2">&quot;NYC&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">28</span> <span class="p">}</span>
</pre>
<p>One thing we need to mention is that the <tt class="docutils literal">$and</tt> operator can be expressed in a different way. Let's look how. Take the same query as above.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">age</span><span class="o">:</span> <span class="p">{</span><span class="nx">$gte</span><span class="o">:</span> <span class="mi">28</span><span class="p">,</span> <span class="nx">$lte</span><span class="o">:</span> <span class="mi">70</span><span class="p">},</span> <span class="nx">location</span><span class="o">:</span> <span class="s2">&quot;NYC&quot;</span><span class="p">}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;Agent Smith&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span> <span class="o">:</span> <span class="s2">&quot;NYC&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">67</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;Trinity&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span> <span class="o">:</span> <span class="s2">&quot;NYC&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">28</span> <span class="p">}</span>
</pre>
<p>Let's look at what just happened. Take <tt class="docutils literal">age: {$gte: 28, $lte: 70}</tt> the comma between the <tt class="docutils literal">$gte</tt> and <tt class="docutils literal">$lte</tt> is an implicit <tt class="docutils literal">$and</tt> meaning this is a short form for the same expression as above using the <tt class="docutils literal">$and</tt>. So for short you can use the comma as an <tt class="docutils literal">$and</tt>.</p>
</div>
<div class="section" id="or">
<h3><a class="toc-backref" href="#id68"><tt class="docutils literal">$or</tt></a></h3>
<p>The <tt class="docutils literal">$or</tt> or logical OR let's you ask questions such as return all games where the platform is <tt class="docutils literal">pc</tt> or one of the tags is <tt class="docutils literal">&quot;pc&quot;</tt>. To be selected a document has to satisfy at least one of the <tt class="docutils literal">$or</tt> statements.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Wing Commander 72&quot;</span>
  <span class="p">,</span> <span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;steam&quot;</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;13+&quot;</span><span class="p">]</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Dead space 15&quot;</span>
  <span class="p">,</span> <span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;ps2000&quot;</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;mac&quot;</span><span class="p">,</span> <span class="s2">&quot;18+&quot;</span><span class="p">]</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Star Controller 2&quot;</span>
  <span class="p">,</span> <span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;pc&quot;</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;10+&quot;</span><span class="p">]</span>
<span class="p">}]</span>
</pre>
<p>Let's select all the games that do not contain the <tt class="docutils literal">pc</tt> tag.</p>
<pre class="code javascript literal-block">
<span class="p">{</span><span class="nx">$or</span><span class="o">:</span> <span class="p">[</span><span class="p">{</span><span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;pc&quot;</span><span class="p">},</span> <span class="p">{</span><span class="nx">tags</span><span class="o">:</span> <span class="p">{</span><span class="nx">$in</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;pc&quot;</span><span class="p">]}}]}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>   <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Wing Commander 72&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;platform&quot;</span> <span class="o">:</span> <span class="s2">&quot;steam&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;13+&quot;</span> <span class="p">]</span> <span class="p">}</span>
<span class="p">{</span>   <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Star Controller 2&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;platform&quot;</span> <span class="o">:</span> <span class="s2">&quot;pc&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;10+&quot;</span> <span class="p">]</span> <span class="p">}</span>
</pre>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">Due to each <tt class="docutils literal">$or</tt> statement actually being checked in parallel by <tt class="docutils literal">MongoDB</tt> they cannot share what is called a compound index (more on this later). To speed up this query we need to create two different indexes. One for the field tags and one for the field platform.</p>
</div>
</div>
<div class="section" id="not">
<h3><a class="toc-backref" href="#id69"><tt class="docutils literal">$not</tt></a></h3>
<p>The <tt class="docutils literal">$not</tt> or logical NOT let's you ask questions such as, show me all users that are not older than 28. Take the following documents.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Agent Smith&quot;</span>
  <span class="p">,</span> <span class="nx">location</span><span class="o">:</span> <span class="s2">&quot;NYC&quot;</span>
  <span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">67</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Mr Anderson&quot;</span>
  <span class="p">,</span> <span class="nx">location</span><span class="o">:</span> <span class="s2">&quot;NYC&quot;</span>
  <span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">25</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Trinity&quot;</span>
  <span class="p">,</span> <span class="nx">location</span><span class="o">:</span> <span class="s2">&quot;NYC&quot;</span>
  <span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">28</span>
<span class="p">}]</span>
</pre>
<p>We wish to select all the users where the age is not greater than 28 and less than 26.</p>
<pre class="code javascript literal-block">
<span class="nx">age</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$not</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$gt</span><span class="o">:</span> <span class="mi">28</span><span class="p">,</span> <span class="nx">$lt</span><span class="o">:</span> <span class="mi">26</span><span class="p">}}}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;Trinity&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span> <span class="o">:</span> <span class="s2">&quot;NYC&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">28</span> <span class="p">}</span>
</pre>
<p>In most cases a <tt class="docutils literal">$not</tt> operator can be considered a reversal of a query and can be useful to quickly find what is not covered by a given query.</p>
</div>
<div class="section" id="nor">
<h3><a class="toc-backref" href="#id70"><tt class="docutils literal">$nor</tt></a></h3>
<p>The <tt class="docutils literal">$nor</tt> or logical NOR is way to locate documents that do not satisfy an expression. Given a set of documents.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Wing Commander 72&quot;</span>
  <span class="p">,</span> <span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;steam&quot;</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;13+&quot;</span><span class="p">]</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Dead space 15&quot;</span>
  <span class="p">,</span> <span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;ps2000&quot;</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;mac&quot;</span><span class="p">,</span> <span class="s2">&quot;18+&quot;</span><span class="p">]</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Star Controller 2&quot;</span>
  <span class="p">,</span> <span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;pc&quot;</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;10+&quot;</span><span class="p">]</span>
<span class="p">}]</span>
</pre>
<p>Let's select all the games that do not have the tag <tt class="docutils literal">pc</tt> nor the tag <tt class="docutils literal">10+</tt>.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="nx">$nor</span><span class="o">:</span> <span class="p">[</span><span class="p">{</span><span class="nx">tags</span><span class="o">:</span> <span class="s2">&quot;pc&quot;</span><span class="p">},</span> <span class="p">{</span><span class="nx">tags</span><span class="o">:</span> <span class="s2">&quot;10+&quot;</span><span class="p">}]}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>   <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Dead space 15&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;platform&quot;</span> <span class="o">:</span> <span class="s2">&quot;ps2000&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;mac&quot;</span><span class="p">,</span> <span class="s2">&quot;18+&quot;</span> <span class="p">]</span> <span class="p">}</span>
</pre>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">Take care when using negations in queries where you rely on indexes as negations can sometime make it impossible for <tt class="docutils literal">MongoDB</tt> to use an index forcing it to scan the entire collection for matching documents. In a later exercise we will learn all there is to know about indexes in <tt class="docutils literal">MongoDB</tt> and how to ensure your queries uses them efficiently.</p>
</div>
<p>This covers the Logical operators the <tt class="docutils literal">MongoDB</tt> query language supports. Next up is element level operators.</p>
</div>
<div class="section" id="element-operators">
<h3><a class="toc-backref" href="#id71">Element operators</a></h3>
<p>The element operators <tt class="docutils literal">$exists</tt>, <tt class="docutils literal">$mod</tt> and <tt class="docutils literal">$type</tt> let you match on if a field exists, a specific module remainder or if the field is of a specific BSON type.</p>
</div>
<div class="section" id="exists">
<h3><a class="toc-backref" href="#id72"><tt class="docutils literal">$exists</tt></a></h3>
<p>The <tt class="docutils literal">$exists</tt> operator lets us select documents based on if a field exists or not instead of by a specific value. Given the documents below.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Wing Commander 72&quot;</span>
  <span class="p">,</span> <span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;steam&quot;</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;13+&quot;</span><span class="p">]</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Dead space 15&quot;</span>
  <span class="p">,</span> <span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;ps2000&quot;</span>
  <span class="p">,</span> <span class="nx">sale</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;mac&quot;</span><span class="p">,</span> <span class="s2">&quot;18+&quot;</span><span class="p">]</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Star Controller 2&quot;</span>
  <span class="p">,</span> <span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;pc&quot;</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;10+&quot;</span><span class="p">]</span>
<span class="p">}]</span>
</pre>
<p>Let's select all the games that are for sale (in this case has the field sale).</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="nx">sale</span><span class="o">:</span> <span class="p">{</span><span class="nx">$exists</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>   <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Dead space 15&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;platform&quot;</span> <span class="o">:</span> <span class="s2">&quot;ps2000&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;sale&quot;</span> <span class="o">:</span> <span class="kc">true</span>
  <span class="p">,</span> <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;mac&quot;</span><span class="p">,</span> <span class="s2">&quot;18+&quot;</span> <span class="p">]</span> <span class="p">}</span>
</pre>
</div>
<div class="section" id="mod">
<h3><a class="toc-backref" href="#id73"><tt class="docutils literal">$mod</tt></a></h3>
<p>The <tt class="docutils literal">$mod</tt> operator let's us match documents based on the remainder of dividing to numbers. We have two simple examples below.</p>
<pre class="code console literal-block">
<span class="go">8 / 8    = 1
8 mod 8  = 0

8 / 9    = 0.88888888
8 mod 9  = 0

16 / 8   = 2
16 mod 8 = 0</span>
</pre>
<p>As you can see the <tt class="docutils literal">remainder</tt> of the <tt class="docutils literal">8 / 9</tt> division is <tt class="docutils literal">8</tt> as it cannot be divided to a whole number. The module only show the remainder of the division. Let's look at an example that's a bit contrived but still demonstrates the usage of the <tt class="docutils literal">$mod</tt> operator.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Wing Commander 72&quot;</span>
  <span class="p">,</span> <span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;steam&quot;</span>
  <span class="p">,</span> <span class="nx">price</span><span class="o">:</span> <span class="mi">12</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;13+&quot;</span><span class="p">]</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Dead space 15&quot;</span>
  <span class="p">,</span> <span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;ps2000&quot;</span>
  <span class="p">,</span> <span class="nx">price</span><span class="o">:</span> <span class="mi">24</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;mac&quot;</span><span class="p">,</span> <span class="s2">&quot;18+&quot;</span><span class="p">]</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Star Controller 2&quot;</span>
  <span class="p">,</span> <span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;pc&quot;</span>
  <span class="p">,</span> <span class="nx">price</span><span class="o">:</span> <span class="mi">27</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;10+&quot;</span><span class="p">]</span>
<span class="p">}]</span>
</pre>
<p>Let's select all games that have a price that's a multiple of 12.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="nx">price</span><span class="o">:</span> <span class="p">{</span><span class="nx">$mod</span><span class="o">:</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">}}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>   <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Wing Commander 72&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;platform&quot;</span> <span class="o">:</span> <span class="s2">&quot;steam&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;price&quot;</span> <span class="o">:</span> <span class="mi">12</span>
  <span class="p">,</span> <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;13+&quot;</span> <span class="p">]</span> <span class="p">}</span>
<span class="p">{</span>   <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Dead space 15&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;platform&quot;</span> <span class="o">:</span> <span class="s2">&quot;ps2000&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;price&quot;</span> <span class="o">:</span> <span class="mi">24</span>
  <span class="p">,</span> <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;mac&quot;</span><span class="p">,</span> <span class="s2">&quot;18+&quot;</span> <span class="p">]</span> <span class="p">}</span>
</pre>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">The <tt class="docutils literal">$mod</tt> operator cannot use an index so it will force <tt class="docutils literal">MongoDB</tt> to scan through all of your documents potentially causing slow queries if the collection contains a lot of documents.</p>
</div>
</div>
<div class="section" id="type">
<h3><a class="toc-backref" href="#id74"><tt class="docutils literal">$type</tt></a></h3>
<p>The <tt class="docutils literal">$type</tt> operator let's us select documents based on what kind of BSON type it is. The BSON types are defined in the following table.</p>
<table border="1" class="docutils">
<colgroup>
<col width="46%" />
<col width="54%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Type</th>
<th class="head">Number</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Double</td>
<td>1</td>
</tr>
<tr><td>String</td>
<td>2</td>
</tr>
<tr><td>Object</td>
<td>3</td>
</tr>
<tr><td>Array</td>
<td>4</td>
</tr>
<tr><td>Binary data</td>
<td>5</td>
</tr>
<tr><td>Object id</td>
<td>7</td>
</tr>
<tr><td>Boolean</td>
<td>8</td>
</tr>
<tr><td>Date</td>
<td>9</td>
</tr>
<tr><td>Null</td>
<td>10</td>
</tr>
<tr><td>Regular Expression</td>
<td>11</td>
</tr>
<tr><td>JavaScript</td>
<td>13</td>
</tr>
<tr><td>Symbol</td>
<td>14</td>
</tr>
<tr><td>JavaScript w/scope</td>
<td>15</td>
</tr>
<tr><td>32 bit integer</td>
<td>16</td>
</tr>
<tr><td>Timestamp</td>
<td>17</td>
</tr>
<tr><td>64 bit integer</td>
<td>18</td>
</tr>
<tr><td>Min key</td>
<td>-1</td>
</tr>
<tr><td>Max key</td>
<td>127</td>
</tr>
</tbody>
</table>
<p>Let's look at example using the following documents.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Wing Commander 72&quot;</span>
  <span class="p">,</span> <span class="nx">price</span><span class="o">:</span> <span class="mi">12</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Dead space 15&quot;</span>
  <span class="p">,</span> <span class="nx">price</span><span class="o">:</span> <span class="mi">24</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Star Controller 2&quot;</span>
  <span class="p">,</span> <span class="nx">price</span><span class="o">:</span> <span class="s2">&quot;27&quot;</span>
<span class="p">}]</span>
</pre>
<p>Let's select all the documents where the file is a numeric type.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="nx">$or</span><span class="o">:</span> <span class="p">[</span> <span class="p">{</span><span class="nx">price</span><span class="o">:</span> <span class="p">{</span><span class="nx">$type</span><span class="o">:</span> <span class="mi">16</span><span class="p">}},</span> <span class="p">{</span><span class="nx">price</span><span class="o">:</span> <span class="p">{</span><span class="nx">$type</span><span class="o">:</span> <span class="mi">18</span><span class="p">}},</span> <span class="p">{</span><span class="nx">price</span><span class="o">:</span> <span class="p">{</span><span class="nx">$type</span><span class="o">:</span> <span class="mi">1</span><span class="p">}}]}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>   <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Wing Commander 72&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;price&quot;</span> <span class="o">:</span> <span class="mi">12</span> <span class="p">}</span>
<span class="p">{</span>   <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Dead space 15&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;price&quot;</span> <span class="o">:</span> <span class="mi">24</span> <span class="p">}</span>
</pre>
<p>Since <tt class="docutils literal">MongoDB</tt> allows a field to have any the <tt class="docutils literal">$type</tt> operator can be very useful to detect if you have documents that use a different field type than the one expected.</p>
</div>
<div class="section" id="javascript-operators">
<h3><a class="toc-backref" href="#id75">JavaScript operators</a></h3>
<p>The <tt class="docutils literal">MongoDB</tt> query language also supports the use of JavaScript in queries in the form of the <tt class="docutils literal">$regexp</tt> and <tt class="docutils literal">$where</tt> operators. However its prudent to warn against using <tt class="docutils literal">$where</tt> in your queries as it will run the comparison over all of the documents in the collection as well as in the <tt class="docutils literal">MongoDB</tt> JavaScript runtime meaning performance leaves a lot to be desired.</p>
</div>
<div class="section" id="regexp-regular-expressions">
<h3><a class="toc-backref" href="#id76"><tt class="docutils literal">$regexp</tt> (Regular expressions)</a></h3>
<p>The <tt class="docutils literal">$regexp</tt> operator lets you perform string matches using the  (<a class="reference external" href="http://www.pcre.org/">http://www.pcre.org/</a>). The <tt class="docutils literal">MongoDB</tt> query language supports the following options.</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="87%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>i</td>
<td>allows case insensitive matches</td>
</tr>
<tr><td>m</td>
<td>will match across multiple lines (otherwise stops at the first line)</td>
</tr>
<tr><td>x</td>
<td>ignores all white space in the text</td>
</tr>
<tr><td>s</td>
<td>allows dot character to match all characters</td>
</tr>
</tbody>
</table>
<p>Let's look at example using the following documents.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Wing Commander 72&quot;</span>
  <span class="p">,</span> <span class="nx">price</span><span class="o">:</span> <span class="mi">12</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Dead space 15&quot;</span>
  <span class="p">,</span> <span class="nx">price</span><span class="o">:</span> <span class="mi">24</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Star Controller 2&quot;</span>
  <span class="p">,</span> <span class="nx">price</span><span class="o">:</span> <span class="s2">&quot;27&quot;</span>
<span class="p">}]</span>
</pre>
<p>Let's select all the documents starting with Wing.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="sr">/^Wing/</span> <span class="p">}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Wing Commander 72&quot;</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span> <span class="o">:</span> <span class="mi">12</span> <span class="p">}</span>
</pre>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">One of the problems with the <tt class="docutils literal">$regexp</tt> operator is that it needs to search through all of the documents in a collection do locate matches for most cases. The only case where it will use an index (and thus execute more rapidly) is if the regular expression is performing a case sensitive match from the start of the string such as <tt class="docutils literal">/^Wing</tt>.</p>
</div>
</div>
<div class="section" id="where">
<h3><a class="toc-backref" href="#id77"><tt class="docutils literal">$where</tt></a></h3>
<p>The <tt class="docutils literal">$where</tt> operator lets you match documents using JavaScript expression. However it comes with a massive <tt class="docutils literal">Here lies dragons</tt> warning sign as it needs to scan the entire collection to match documents (using no indexes) and runs inside the <tt class="docutils literal">MongoDB</tt> JavaScript engine meaning it impacts the performance of the server and is fairly slow. Use with extreme caution. Give the dire warning let's look at an example. Given the following documents.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Wing Commander 72&quot;</span>
  <span class="p">,</span> <span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;steam&quot;</span>
  <span class="p">,</span> <span class="nx">price</span><span class="o">:</span> <span class="mi">12</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;13+&quot;</span><span class="p">]</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Dead space 15&quot;</span>
  <span class="p">,</span> <span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;ps2000&quot;</span>
  <span class="p">,</span> <span class="nx">price</span><span class="o">:</span> <span class="mi">24</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;mac&quot;</span><span class="p">,</span> <span class="s2">&quot;18+&quot;</span><span class="p">]</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Star Controller 2&quot;</span>
  <span class="p">,</span> <span class="nx">platform</span><span class="o">:</span> <span class="s2">&quot;pc&quot;</span>
  <span class="p">,</span> <span class="nx">price</span><span class="o">:</span> <span class="mi">27</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;10+&quot;</span><span class="p">,</span> <span class="s2">&quot;steam&quot;</span><span class="p">]</span>
<span class="p">}]</span>
</pre>
<p>Let's select all the documents where the number of tags is more than four.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="nx">$where</span><span class="o">:</span> <span class="s2">&quot;this.tags.length &gt; 4&quot;</span> <span class="p">}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>   <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Star Controller 2&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;platform&quot;</span> <span class="o">:</span> <span class="s2">&quot;pc&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;price&quot;</span> <span class="o">:</span> <span class="mi">27</span>
  <span class="p">,</span> <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;10+&quot;</span><span class="p">,</span> <span class="s2">&quot;steam&quot;</span> <span class="p">]</span> <span class="p">}</span>
</pre>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">As mentioned before use extreme caution when using <tt class="docutils literal">$where</tt> as it will impact your application performance.</p>
</div>
</div>
<div class="section" id="array-operators">
<h3><a class="toc-backref" href="#id78">Array Operators</a></h3>
<p>The last set of query operators we will cover in this exercise is the Array operator <tt class="docutils literal">$size</tt>.</p>
</div>
<div class="section" id="size">
<h3><a class="toc-backref" href="#id79"><tt class="docutils literal">$size</tt></a></h3>
<p>The <tt class="docutils literal">$size</tt> operator let's us match on the size of an array. Take the following documents.</p>
<pre class="code javascript literal-block">
<span class="p">[</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Wing Commander 72&quot;</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;13+&quot;</span><span class="p">]</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Dead space 15&quot;</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;mac&quot;</span><span class="p">,</span> <span class="s2">&quot;18+&quot;</span><span class="p">]</span>
<span class="p">},</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Star Controller 2&quot;</span>
  <span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;10+&quot;</span><span class="p">,</span> <span class="s2">&quot;steam&quot;</span><span class="p">]</span>
<span class="p">}]</span>
</pre>
<p>Let's select all the documents where the number of tags is four.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">{</span><span class="nx">$size</span><span class="o">:</span><span class="mi">4</span><span class="p">}}</span>
</pre>
<p>The results returned are.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>   <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Wing Commander 72&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">,</span> <span class="s2">&quot;13+&quot;</span> <span class="p">]</span> <span class="p">}</span>
<span class="p">{</span>   <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">2</span>
  <span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Dead space 15&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="s2">&quot;scifi&quot;</span><span class="p">,</span> <span class="s2">&quot;mac&quot;</span><span class="p">,</span> <span class="s2">&quot;18+&quot;</span> <span class="p">]</span> <span class="p">}</span>
</pre>
<p>This covers the query operators in <tt class="docutils literal">MongoDB</tt> that we wanted to cover in this exercise. We have intentionally skipped <tt class="docutils literal">Geospatial</tt> query operators as well as <tt class="docutils literal">Projection</tt> operators as we will introduce them in later exercises.</p>
</div>
</div>
<div class="section" id="exercise-15-index-this">
<h2><a class="toc-backref" href="#id80">Exercise 15: Index This</a></h2>
<p>Let's get a deeper understanding of how MongoDB looks up data when you issue it a query. Let's imagine a collection that contains 100 documents of the type <tt class="docutils literal">{a:i} where i = [0 to 100]</tt>. We issue a search to the server using <tt class="docutils literal">{a:5}</tt>. Think of all the documents as being on a chain, one connected to the next.</p>
<img alt="code/ex15/ex1.png" src="code/ex15/ex1.png" />
<p>Now when the query gets executes MongoDB will start from the top of the chain and check each document to see if it matches <tt class="docutils literal">a equals 5</tt>. If it does match it will add it to the result set otherwise it will skip to the next document. This is what is known as a <tt class="docutils literal">table scan</tt> in the database world. If you imagine the chain containing millions of documents you can see that this is not a very efficient way of querying data as we would have to check each document for each query meaning a lot of reading data from disk. Thus a better approach to searching is needed and this is where the concept of an index comes in.</p>
<div class="section" id="index-magic">
<h3><a class="toc-backref" href="#id81">Index Magic</a></h3>
<p>Now indexes are not truly magic and once you grasp the main concept you'll wonder why you never thought of them yourself. The main index used in MongoDB is what's called a BTree index (or more specifically a variation of a BTree+ index).</p>
<p>So let's get into what a BTree index is. In very short it's a way to keep a list of values in a sorted order that's a tree structure and not a chain. What do you mean you might ask. Well it's easier to illustrate than explain.</p>
<img alt="code/ex15/ex2.png" src="code/ex15/ex2.png" />
<p>The tree above is an <tt class="docutils literal">index</tt> for the field <tt class="docutils literal">a</tt> in the documents above. Notice how it's a tree structure, instead of a chained list of documents. Each level of the tree contains a set of id's that correspond to a value that is stored in the <tt class="docutils literal">a</tt> field in a document. So say we need to find the document with the value <tt class="docutils literal">a equals 5</tt>. We grab the top node where we find the the first value to be <tt class="docutils literal">7</tt>. We know our value is less than <tt class="docutils literal">7</tt> so we decent into the left node of the tree and scan from left to right until we find the value <tt class="docutils literal">5</tt> and we can now return the correct document. So instead of having to scan all documents we can short-cut our search because we have split the search <tt class="docutils literal">space</tt> into smaller chunks of data to search through. So in this case given that we know that <tt class="docutils literal">a is less than 7</tt> we only need to search through the documents that are <tt class="docutils literal">larger than 0 and less than 7</tt> which are all contained in the left lower node.</p>
<img alt="code/ex15/ex3.png" src="code/ex15/ex3.png" />
<p>The main benefit comes from when our collections of documents grow very big as it allows MongoDB to limit the number of documents it needs to search through to find the correct matches to the query, thus speeding up the search massively compared to searching through all of the documents.</p>
<p>An index like this lets us look up a document by an indexed value very quickly but it also lets us do what is called a <tt class="docutils literal">ranged query</tt>. A <tt class="docutils literal">ranged query</tt> is a query that looks like this in mongodb <tt class="docutils literal"><span class="pre">{a:{$gt:0,</span> $lt:10}}</tt>. This looks for all documents where <tt class="docutils literal">a is greater than 0 and less than 10</tt>. Because of the way the Btree index is structured it helps us limit the amount of documents we need to search as as can see from the first node that we only have to search the leftmost and middle node for all values that are less than 10. So we only need to search the results</p>
<img alt="code/ex15/ex4.png" src="code/ex15/ex4.png" />
<p>This is of course a very oversimplified way of explaining the way an index works but safe to say is that it allows you to search more efficiently for a value.</p>
<p>The last item we will cover is what's called a <tt class="docutils literal">compound index</tt> and a beneficial side effect of <tt class="docutils literal">compound indexes</tt> called <tt class="docutils literal">covered indexes</tt>.</p>
</div>
<div class="section" id="compound-indexes">
<h3><a class="toc-backref" href="#id82">Compound indexes</a></h3>
<p>Besides support a single value index MongoDB also supports what's called a <tt class="docutils literal">compound&nbsp; index</tt>. This type of index is made up of multiple values. Let's take an example of documents that look like this.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
  <span class="nx">pid</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">'Steve'</span><span class="p">,</span>
  <span class="nx">salary</span><span class="o">:</span> <span class="mi">10000</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="nx">pid</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">'John'</span><span class="p">,</span>
  <span class="nx">salary</span><span class="o">:</span> <span class="mi">12000</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="nx">pid</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">'Peter'</span><span class="p">,</span>
  <span class="nx">salary</span><span class="o">:</span> <span class="mi">7000</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="nx">pid</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">'Arnold'</span><span class="p">,</span>
  <span class="nx">salary</span><span class="o">:</span> <span class="mi">32000</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="nx">pid</span><span class="o">:</span> <span class="mi">23</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">'Gandalf'</span><span class="p">,</span>
  <span class="nx">salary</span><span class="o">:</span> <span class="mi">34000</span>
<span class="p">}</span>
</pre>
<p>What if we want to efficiently search for documents where <tt class="docutils literal">pid is larger than 2 and the salary is less than 10000</tt>. This is where a compound index comes in and allows us to do this efficiently. <tt class="docutils literal">Compound</tt> means to combine and that what it is, an index that combines two or more fields. Let's look at an example of a compound index of <tt class="docutils literal">{pid, salary, name}</tt>.</p>
<img alt="code/ex15/ex5.png" src="code/ex15/ex5.png" />
<p>Now let's run our query against it. The first part of the query is the pid factor, so let's locate all the <tt class="docutils literal">pids larger than 2</tt></p>
<img alt="code/ex15/ex6.png" src="code/ex15/ex6.png" />
<p>As you can see we have identified 3 nodes (colored green) that fulfill the the criteria of <tt class="docutils literal">pid larger than 2</tt>. It's time to apply the second criteria to this new sub tree of results. Inside of the green nodes we locate the ones where <tt class="docutils literal">salary is less than 10000</tt></p>
<img alt="code/ex15/ex7.png" src="code/ex15/ex7.png" />
<p>This is awesome, we can use a single index to narrow down the number of documents we need to search to locate the values in the query even if the query covers two or more fields. This brings us to the last aspect of compound indexes, namely <tt class="docutils literal">covered indexes</tt>. Given that the data for <tt class="docutils literal">pid, salary, name</tt> is already in the index we can retrieve the data directly from the index if the query only requires the fields in the index to be returned. This means we will not have to load the actual documents into memory to satisfy a query.</p>
<p>This covers the basics of how indexes work. We have not covered geo indexes or text indexes here on purpose as we will cover them in future exercises. Hopefully this introduction will be enough for you to grasp why indexes are one of the most important aspects of MongoDB and that they are vital to get maximum performance out your queries.</p>
</div>
</div>
<div class="section" id="exercise-16-basic-indexes-in-mongodb">
<h2><a class="toc-backref" href="#id83">Exercise 16: Basic Indexes in MongoDB</a></h2>
<p>In this exercise we will focus on the basics of creating indexes for MongoDB, using them and understanding how our queries use indexes. To kick off let's insert some documents into a database and create an index on the field salary.</p>
<div class="highlight"><pre><a name="code--ex16--ex1.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex16--ex1.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex16--ex1.js-pyg.html-3"></a>
<a name="code--ex16--ex1.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex16--ex1.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex16--ex1.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex16--ex1.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex16--ex1.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex16--ex1.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex16--ex1.js-pyg.html-10"></a>
<a name="code--ex16--ex1.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[</span>
<a name="code--ex16--ex1.js-pyg.html-12"></a>    <span class="p">{</span>
<a name="code--ex16--ex1.js-pyg.html-13"></a>      <span class="nx">pid</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
<a name="code--ex16--ex1.js-pyg.html-14"></a>      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Steve&#39;</span><span class="p">,</span>
<a name="code--ex16--ex1.js-pyg.html-15"></a>      <span class="nx">salary</span><span class="o">:</span> <span class="mi">10000</span>
<a name="code--ex16--ex1.js-pyg.html-16"></a>    <span class="p">},</span>
<a name="code--ex16--ex1.js-pyg.html-17"></a>    <span class="p">{</span>
<a name="code--ex16--ex1.js-pyg.html-18"></a>      <span class="nx">pid</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
<a name="code--ex16--ex1.js-pyg.html-19"></a>      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span>
<a name="code--ex16--ex1.js-pyg.html-20"></a>      <span class="nx">salary</span><span class="o">:</span> <span class="mi">12000</span>
<a name="code--ex16--ex1.js-pyg.html-21"></a>    <span class="p">},</span>
<a name="code--ex16--ex1.js-pyg.html-22"></a>    <span class="p">{</span>
<a name="code--ex16--ex1.js-pyg.html-23"></a>      <span class="nx">pid</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
<a name="code--ex16--ex1.js-pyg.html-24"></a>      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Peter&#39;</span><span class="p">,</span>
<a name="code--ex16--ex1.js-pyg.html-25"></a>      <span class="nx">salary</span><span class="o">:</span> <span class="mi">7000</span>
<a name="code--ex16--ex1.js-pyg.html-26"></a>    <span class="p">},</span>
<a name="code--ex16--ex1.js-pyg.html-27"></a>    <span class="p">{</span>
<a name="code--ex16--ex1.js-pyg.html-28"></a>      <span class="nx">pid</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span>
<a name="code--ex16--ex1.js-pyg.html-29"></a>      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Arnold&#39;</span><span class="p">,</span>
<a name="code--ex16--ex1.js-pyg.html-30"></a>      <span class="nx">salary</span><span class="o">:</span> <span class="mi">32000</span>
<a name="code--ex16--ex1.js-pyg.html-31"></a>    <span class="p">},</span>
<a name="code--ex16--ex1.js-pyg.html-32"></a>    <span class="p">{</span>
<a name="code--ex16--ex1.js-pyg.html-33"></a>      <span class="nx">pid</span><span class="o">:</span> <span class="mi">23</span><span class="p">,</span>
<a name="code--ex16--ex1.js-pyg.html-34"></a>      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Gandalf&#39;</span><span class="p">,</span>
<a name="code--ex16--ex1.js-pyg.html-35"></a>      <span class="nx">salary</span><span class="o">:</span> <span class="mi">34000</span>
<a name="code--ex16--ex1.js-pyg.html-36"></a>    <span class="p">}</span>
<a name="code--ex16--ex1.js-pyg.html-37"></a>  <span class="p">];</span>
<a name="code--ex16--ex1.js-pyg.html-38"></a>
<a name="code--ex16--ex1.js-pyg.html-39"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;salaries&#39;</span><span class="p">);</span>
<a name="code--ex16--ex1.js-pyg.html-40"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex16--ex1.js-pyg.html-41"></a>
<a name="code--ex16--ex1.js-pyg.html-42"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex16--ex1.js-pyg.html-43"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
<a name="code--ex16--ex1.js-pyg.html-44"></a>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;added salary documents&quot;</span><span class="p">);</span>
<a name="code--ex16--ex1.js-pyg.html-45"></a>
<a name="code--ex16--ex1.js-pyg.html-46"></a>      <span class="nx">collection</span><span class="p">.</span><span class="nx">ensureIndex</span><span class="p">({</span><span class="nx">salary</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">index_name</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex16--ex1.js-pyg.html-47"></a>
<a name="code--ex16--ex1.js-pyg.html-48"></a>        <span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">salary</span><span class="o">:</span><span class="mi">7000</span><span class="p">}).</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex16--ex1.js-pyg.html-49"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;documents&quot;</span><span class="p">);</span>
<a name="code--ex16--ex1.js-pyg.html-50"></a>          <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">docs</span><span class="p">);</span>
<a name="code--ex16--ex1.js-pyg.html-51"></a>          <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex16--ex1.js-pyg.html-52"></a>        <span class="p">});</span>
<a name="code--ex16--ex1.js-pyg.html-53"></a>      <span class="p">});</span>
<a name="code--ex16--ex1.js-pyg.html-54"></a>    <span class="p">});</span>
<a name="code--ex16--ex1.js-pyg.html-55"></a>  <span class="p">});</span>
<a name="code--ex16--ex1.js-pyg.html-56"></a><span class="p">});</span>
</pre></div><p>Let's have a look at the new collection method we are using called <tt class="docutils literal">ensureIndex</tt>. The call looks like.</p>
<pre class="code javascript literal-block">
<span class="nx">collection</span><span class="p">.</span><span class="nx">ensureIndex</span><span class="p">(</span><span class="p">{</span><span class="nx">salary</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">index_name</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
</pre>
<p>The <tt class="docutils literal">ensureIndex</tt> method will only add the index if there is not an index already present. This lets you specify the index creation as part of your code to ensure that the specified index exists. A typical place to locate this code is at the boot up time of your application so the indexes are built before your application is ready to process incoming requests (if an web app).</p>
<p>The meat of the story is the <tt class="docutils literal">{salary:1}</tt> index specifier. This tells MongoDB to build a <tt class="docutils literal">BTree index</tt> over the field <tt class="docutils literal">salary</tt> in all documents present in the collection. If you remember from the introduction on indexes this will create a tree structure allowing us to efficiently query the data. The next line is the actual query.</p>
<pre class="code javascript literal-block">
<span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="p">{</span><span class="nx">salary</span><span class="o">:</span><span class="mi">7000</span><span class="p">}).</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
</pre>
<p>This will look for any documents where the <tt class="docutils literal">salary is equal to 7000</tt> and the output after running the example is (_id will vary).</p>
<pre class="code console literal-block">
<span class="go">connected to database
added salary documents
documents
[ { pid: 7,
name: 'Peter',
salary: 7000,
_id: 51811ee1746bbbc015000003 } ]</span>
</pre>
<p>But how can we know if a query is using an index ?. Actually you can do this both from the driver as well as the <tt class="docutils literal">mongo shell</tt>. To be fair it's probably better to do it from the shell but let's cover what that would look like using the driver. The code below <tt class="docutils literal">requires</tt> that the first example has been run first to populate the collection and create the index. Notice that we use a option for the <tt class="docutils literal">find</tt> method called <tt class="docutils literal">explain</tt>. This tells the server to return the <tt class="docutils literal">query plan</tt> or the way it searched for data instead of the actual data for the query.</p>
<div class="highlight"><pre><a name="code--ex16--ex2.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex16--ex2.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex16--ex2.js-pyg.html-3"></a>
<a name="code--ex16--ex2.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex16--ex2.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex16--ex2.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex16--ex2.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex16--ex2.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex16--ex2.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex16--ex2.js-pyg.html-10"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;salaries&#39;</span><span class="p">);</span>
<a name="code--ex16--ex2.js-pyg.html-11"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">salary</span><span class="o">:</span><span class="mi">7000</span><span class="p">},</span> <span class="p">{</span><span class="nx">explain</span><span class="o">:</span><span class="kc">true</span><span class="p">}).</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex16--ex2.js-pyg.html-12"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;documents&quot;</span><span class="p">);</span>
<a name="code--ex16--ex2.js-pyg.html-13"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">docs</span><span class="p">);</span>
<a name="code--ex16--ex2.js-pyg.html-14"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex16--ex2.js-pyg.html-15"></a>  <span class="p">});</span>
<a name="code--ex16--ex2.js-pyg.html-16"></a><span class="p">});</span>
</pre></div><p>After running the example you'll see the following</p>
<pre class="code console literal-block">
<span class="go">connected to database
documents
[ { cursor: 'BtreeCursor salary_1',
    isMultiKey: false,
    n: 1,
    nscannedObjects: 1,
    nscanned: 1,
    nscannedObjectsAllPlans: 1,
    nscannedAllPlans: 1,
    scanAndOrder: false,
    indexOnly: false,
    nYields: 0,
    nChunkSkips: 0,
    millis: 0,
    indexBounds: { salary: [Object] },
    allPlans: [ [Object] ],
    oldPlan: { cursor: 'BtreeCursor salary_1', indexBounds: [Object] },
    server: 'localhost:27017' } ]</span>
</pre>
<p>This can be done more simply from the <tt class="docutils literal">mongo</tt> shell executing the following commands.</p>
<pre class="code console literal-block">
<span class="go">mongo
MongoDB shell version: 2.4.3
connecting to: test
</span><span class="gp">&gt;</span> db.salaries.find<span class="o">({</span>salary:7000<span class="o">})</span>.explain<span class="o">(</span><span class="nb">true</span><span class="o">)</span>
<span class="go">{
  &quot;cursor&quot; : &quot;BtreeCursor salary_1&quot;,
  &quot;isMultiKey&quot; : false,
  &quot;n&quot; : 1,
  &quot;nscannedObjects&quot; : 1,
  &quot;nscanned&quot; : 1,
  &quot;nscannedObjectsAllPlans&quot; : 1,
  &quot;nscannedAllPlans&quot; : 1,
  &quot;scanAndOrder&quot; : false,
  &quot;indexOnly&quot; : false,
  &quot;nYields&quot; : 0,
  &quot;nChunkSkips&quot; : 0,
  &quot;millis&quot; : 0,
  &quot;indexBounds&quot; : {
    &quot;salary&quot; : [
      [
        7000,
        7000
      ]
    ]
  },
  &quot;allPlans&quot; : [
      {
        &quot;cursor&quot; : &quot;BtreeCursor salary_1&quot;,
        &quot;n&quot; : 1,
        &quot;nscannedObjects&quot; : 1,
        &quot;nscanned&quot; : 1,
        &quot;indexBounds&quot; : {
          &quot;salary&quot; : [
            [
              7000,
              7000
            ]
          ]
        }
      }
    ],
    &quot;oldPlan&quot; : {
      &quot;cursor&quot; : &quot;BtreeCursor salary_1&quot;,
      &quot;indexBounds&quot; : {
        &quot;salary&quot; : [
          [
            7000,
            7000
          ]
        ]
      }
    },
  &quot;server&quot; : &quot;localhost:27017&quot;
}
</span><span class="gp">&gt;</span> <span class="nb">exit</span>
<span class="go">bye</span>
</pre>
<p>I personally prefer to use the <tt class="docutils literal">mongo</tt> shell to <tt class="docutils literal">explain</tt> queries as it does not require me to write additional code.</p>
<p>So let's pick apart what the explain document actually means and how it relates to the usage of the documents.</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="12%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Field</th>
<th class="head">Value</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>cursor</td>
<td>BtreeCursor salary_1</td>
<td>Tells us what kind of cursor was used for the query. In this case it was a BtreeCursor which means it used the <tt class="docutils literal">salary</tt> index.</td>
</tr>
<tr><td>isMultiKey</td>
<td>false</td>
<td>If true it tells us that one of the fields in the index is an array of values.</td>
</tr>
<tr><td>n</td>
<td>1</td>
<td>The number of documents that matches the query.</td>
</tr>
<tr><td>nscannedObjects</td>
<td>1</td>
<td>The number of documents scanned during the query</td>
</tr>
<tr><td>nscanned</td>
<td>1</td>
<td>The number of documents + index entries scanned during the query.</td>
</tr>
<tr><td>nscannedObjectsAllPlans</td>
<td>1</td>
<td>The total number of documents scanned for all query plans;</td>
</tr>
<tr><td>nscannedAllPlans</td>
<td>1</td>
<td>The total number of documents + index entries scanned across all query plans.</td>
</tr>
<tr><td>scanAndOrder</td>
<td>false</td>
<td>Is true if an index cannot be used to order the documents returned.</td>
</tr>
<tr><td>indexOnly</td>
<td>false</td>
<td>Is true if the query can be answered using only the data stored in the index.</td>
</tr>
<tr><td>nYields</td>
<td>0</td>
<td>The number of times MongoDB let somebody else perform work while executing the query.</td>
</tr>
<tr><td>nChunkSkips</td>
<td>0</td>
<td>Advanced field for sharding, reflects the number of chunks skipped during the search because chunks were being migrated.</td>
</tr>
<tr><td>millis</td>
<td>0</td>
<td>The miliseconds it took to execute the query.</td>
</tr>
<tr><td>indexBounds</td>
<td>salary:[[7000,7000]]</td>
<td>Contains what field in the index satisfied the query and what range of the index was used to locate the documents.</td>
</tr>
<tr><td>allPlans</td>
<td>...</td>
<td>Contains a list of all the query plans MongoDB tried when executing the query</td>
</tr>
<tr><td>oldPlan</td>
<td>...</td>
<td>Contains the last query plan used for this query (MongoDB caches the most efficient query plan and reuses it)</td>
</tr>
<tr><td>&quot;server&quot;</td>
<td>localhost:27017</td>
<td>Server the query was run against</td>
</tr>
</tbody>
</table>
<p>As you can see it's quite a lot of information. The easiest way to understand how to read it is to contrast the information above with a query that does not use an index.</p>
<pre class="code console literal-block">
<span class="go">  mongo
  MongoDB shell version: 2.4.3
  connecting to: test
  &gt; db.salaries.find({name: &quot;Steve&quot;}).explain(true)
  {
    &quot;cursor&quot; : &quot;BasicCursor&quot;,
    &quot;isMultiKey&quot; : false,
    &quot;n&quot; : 1,
    &quot;nscannedObjects&quot; : 5,
    &quot;nscanned&quot; : 5,
    &quot;nscannedObjectsAllPlans&quot; : 5,
    &quot;nscannedAllPlans&quot; : 5,
    &quot;scanAndOrder&quot; : false,
    &quot;indexOnly&quot; : false,
    &quot;nYields&quot; : 0,
    &quot;nChunkSkips&quot; : 0,
    &quot;millis&quot; : 0,
    &quot;indexBounds&quot; : {

    },
    &quot;allPlans&quot; : [
      {
        &quot;cursor&quot; : &quot;BasicCursor&quot;,
        &quot;n&quot; : 1,
        &quot;nscannedObjects&quot; : 5,
        &quot;nscanned&quot; : 5,
        &quot;indexBounds&quot; : {

        }
      }
    ],
    &quot;server&quot; : &quot;localhost:27017&quot;
  }
  quit
  bye

Let's look at the two side by side.</span>
</pre>
<table border="1" class="docutils">
<colgroup>
<col width="37%" />
<col width="33%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Field</th>
<th class="head">Value</th>
<th class="head">Value</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">cursor</tt></td>
<td><tt class="docutils literal">BtreeCursor salary_1</tt></td>
<td><tt class="docutils literal">BasicCursor</tt></td>
</tr>
<tr><td>isMultiKey</td>
<td>false</td>
<td>false</td>
</tr>
<tr><td>n</td>
<td>1</td>
<td>1</td>
</tr>
<tr><td><tt class="docutils literal">nscannedObjects</tt></td>
<td><tt class="docutils literal">1</tt></td>
<td><tt class="docutils literal">5</tt></td>
</tr>
<tr><td><tt class="docutils literal">nscanned</tt></td>
<td><tt class="docutils literal">1</tt></td>
<td><tt class="docutils literal">5</tt></td>
</tr>
<tr><td><tt class="docutils literal">nscannedObjectsAllPlans</tt></td>
<td><tt class="docutils literal">1</tt></td>
<td><tt class="docutils literal">5</tt></td>
</tr>
<tr><td><tt class="docutils literal">nscannedAllPlans</tt></td>
<td><tt class="docutils literal">1</tt></td>
<td><tt class="docutils literal">5</tt></td>
</tr>
<tr><td>scanAndOrder</td>
<td>false</td>
<td>false</td>
</tr>
<tr><td>indexOnly</td>
<td>false</td>
<td>false</td>
</tr>
<tr><td>nYields</td>
<td>0</td>
<td>0</td>
</tr>
<tr><td>nChunkSkips</td>
<td>0</td>
<td>0</td>
</tr>
<tr><td>millis</td>
<td>0</td>
<td>0</td>
</tr>
<tr><td>indexBounds</td>
<td>salary:[[7000,7000]]</td>
<td>{}</td>
</tr>
<tr><td>allPlans</td>
<td>...</td>
<td>...</td>
</tr>
<tr><td>oldPlan</td>
<td>...</td>
<td>...</td>
</tr>
<tr><td>&quot;server&quot;</td>
<td>localhost:27017</td>
<td>localhost:27017</td>
</tr>
</tbody>
</table>
<p>Notice how the <tt class="docutils literal">cursor</tt> field says <tt class="docutils literal">BasicCursor</tt> instead off <tt class="docutils literal">BtreeCursor</tt>. This tells us that the query did not use an index and had to go through all of the documents in the collection to satisfy the query. This directly leads to <tt class="docutils literal">nscannedObjects</tt>, <tt class="docutils literal">nscanned</tt>, <tt class="docutils literal">nscannedObjectsAllPlans</tt> and <tt class="docutils literal">nscannedAllPlans</tt> being <tt class="docutils literal">5</tt> as there are <tt class="docutils literal">5</tt> documents in the collection. Also as MongoDB did not use an index for the query the <tt class="docutils literal">indexBound</tt> is empty as we could not locate a boundary for the query (remember how the Btree is laid out, a boundary is the set of tree node ranges needed to satisfy the query)</p>
<p>Imagine that there was <tt class="docutils literal">hundreds of thousands</tt> of documents in the collection instead of just 5. A query looking up a name would require each query to scan through all of the documents to locate matching documents. This would very quickly become unsustainable as the slowness of the query would be compounded by many of them happening in parallel. Even worse since MongoDB would have to load every document into it could cause excessive swapping out of memory to disk (moving documents out of RAM to make space for the ones we need to scan) making the queries even slower and limiting the performance of our application. This is why we need to make sure we always use indexes and even more so if the collection of documents is very large. Cool that covers the basics of understanding how we can create a simple index and how we can investigate if a query is using it correctly or not. Next exercise we will build a ton of different indexes and see how they work and perform.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">In development I tend to use an option for <tt class="docutils literal">mongod</tt> that allows me to catch queries that don't use an index. When you start up the <tt class="docutils literal">mongod</tt> server add the option <tt class="docutils literal"><span class="pre">--notablescan</span></tt> to the <tt class="docutils literal">mongod</tt> command line. If you now attempt to run a query that does not use an index MongoDb will throw an error <tt class="docutils literal"><span class="pre">{&quot;$err&quot;</span> : &quot;table scans not allowed:test.salaries&quot;, &quot;code&quot; : 10111 }</tt></p>
</div>
</div>
<div class="section" id="exercise-17-index-katas">
<h2><a class="toc-backref" href="#id84">Exercise 17: Index Katas</a></h2>
<p>Let's do a bunch of index Katas to get used to how indexes work in MongoDB. A Kata is a form or pattern. Let's start off with the single value index.</p>
<div class="section" id="single-value-index">
<h3><a class="toc-backref" href="#id85">Single Value Index</a></h3>
<p>Given the documents inserted into the database <tt class="docutils literal">test</tt> and collection <tt class="docutils literal">users</tt>.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
  <span class="nx">pid</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">'Steve'</span><span class="p">,</span>
  <span class="nx">salary</span><span class="o">:</span> <span class="mi">10000</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="nx">pid</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">'John'</span><span class="p">,</span>
  <span class="nx">salary</span><span class="o">:</span> <span class="mi">12000</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="nx">pid</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">'Peter'</span><span class="p">,</span>
  <span class="nx">salary</span><span class="o">:</span> <span class="mi">7000</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="nx">pid</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">'Arnold'</span><span class="p">,</span>
  <span class="nx">salary</span><span class="o">:</span> <span class="mi">32000</span>
<span class="p">}</span>
</pre>
<p>We want to create an index on the <tt class="docutils literal">salary</tt> field so we can perform two queries using the index. The first one is <tt class="docutils literal">locate all users with the salary 10000</tt> and the second one is the query <tt class="docutils literal">locate all users that have a salary less then 30000 but larger than 8000</tt>.</p>
<p>Let's create the index using either the driver</p>
<pre class="code javascript literal-block">
<span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">).</span><span class="nx">ensureIndex</span><span class="p">(</span><span class="p">{</span><span class="nx">salary</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span><span class="p">});</span>
</pre>
<p>or the console</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.users.ensureIndex<span class="o">({</span>salary:1<span class="o">})</span>
</pre>
<p>Let's execute the queries mentioned above using the <tt class="docutils literal">console</tt> and have a look at the resulting explain results.</p>
<p>First the <tt class="docutils literal">locate all users with the salary 10000</tt> query</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.users.find<span class="o">({</span>salary:10000<span class="o">})</span>.explain<span class="o">()</span>
<span class="go">{
  &quot;cursor&quot; : &quot;BtreeCursor salary_1&quot;,
  &quot;isMultiKey&quot; : false,
  &quot;n&quot; : 1,
  &quot;nscannedObjects&quot; : 1,
  &quot;nscanned&quot; : 1,
  &quot;nscannedObjectsAllPlans&quot; : 1,
  &quot;nscannedAllPlans&quot; : 1,
  &quot;scanAndOrder&quot; : false,
  &quot;indexOnly&quot; : false,
  &quot;nYields&quot; : 0,
  &quot;nChunkSkips&quot; : 0,
  &quot;millis&quot; : 0,
  &quot;indexBounds&quot; : {
    &quot;salary&quot; : [
      [
        10000,
        10000
      ]
    ]
  },
  &quot;server&quot; : &quot;localhost:27017&quot;
}</span>
</pre>
<p>and then the <tt class="docutils literal">locate all users that have a salary less then 30000 but larger than 8000</tt> query.</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.users.find<span class="o">({</span>salary:<span class="o">{</span><span class="nv">$lt</span>: 30000, <span class="nv">$gt</span>: 8000<span class="o">}})</span>.explain<span class="o">()</span>
<span class="go">{
  &quot;cursor&quot; : &quot;BtreeCursor salary_1&quot;,
  &quot;isMultiKey&quot; : false,
  &quot;n&quot; : 2,
  &quot;nscannedObjects&quot; : 2,
  &quot;nscanned&quot; : 2,
  &quot;nscannedObjectsAllPlans&quot; : 2,
  &quot;nscannedAllPlans&quot; : 2,
  &quot;scanAndOrder&quot; : false,
  &quot;indexOnly&quot; : false,
  &quot;nYields&quot; : 0,
  &quot;nChunkSkips&quot; : 0,
  &quot;millis&quot; : 0,
  &quot;indexBounds&quot; : {
    &quot;salary&quot; : [
      [
        8000,
        30000
      ]
    ]
  },
  &quot;server&quot; : &quot;localhost:27017&quot;
}</span>
</pre>
<p>As you notice we are explicitly making you look the <tt class="docutils literal">explains</tt> for the queries. We are trying to impart the importance of understanding how you queries use indexes as it's a prime factor in getting the best performance out of all databases. Going forward we will only touch on the explain part when it expands the understanding of how indexes work. Let's move on to a single index with sorting.</p>
</div>
<div class="section" id="single-value-index-with-sorting">
<h3><a class="toc-backref" href="#id86">Single Value Index With Sorting</a></h3>
<p>Let's play with sorting and using an index. For this we need a bigger set of data to play with. Let's generate some using the <tt class="docutils literal">mongo</tt> shell. Remember it's a JavaScript <tt class="docutils literal">repl</tt> so we can script it in JavaScript.</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span><span class="k">for</span><span class="o">(</span>var <span class="nv">i</span> <span class="o">=</span> 0; i &lt; 10000; i++<span class="o">)</span> db.sorting.insert<span class="o">({</span>a:i, b:<span class="o">(</span>10000 - i<span class="o">)})</span>
</pre>
<p>This will generate <tt class="docutils literal">10000</tt> documents with an a field <tt class="docutils literal">a</tt> that increases for each insert (as well as an increasing <tt class="docutils literal">b</tt> field).</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">When we create an index we have to specify either <tt class="docutils literal"><span class="pre">-1</span></tt> or <tt class="docutils literal">1</tt>. This is the ordering of the data in the index. <tt class="docutils literal"><span class="pre">-1</span></tt> means in <tt class="docutils literal">descending</tt> (4, 3, 2, 1), while <tt class="docutils literal">1</tt> means <tt class="docutils literal">ascending</tt> sort order (1, 2, 3, 4). This impacts how data is scanned in indexes and optimally you should always create the index in the <tt class="docutils literal">sort</tt> order that will used in most of the queries to make them as efficient as possible.</p>
</div>
<p>Now let's add an index to this field.</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.sorting.ensureIndex<span class="o">({</span>a:1<span class="o">})</span>
</pre>
<p>The index can be created in the following way with the driver.</p>
<pre class="code javascript literal-block">
<span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'employees'</span><span class="p">).</span><span class="nx">ensureIndex</span><span class="p">(</span><span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span><span class="p">});</span>
</pre>
<p>Let's look at how it works when we are using a sort.</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.sorting.find<span class="o">({</span>a: <span class="o">{</span><span class="nv">$lt</span>:5000, <span class="nv">$gt</span>: 1000<span class="o">}})</span>.sort<span class="o">({</span>a:1<span class="o">})</span>.explain<span class="o">()</span>
<span class="go">{
  &quot;cursor&quot; : &quot;BtreeCursor a_1&quot;,
  &quot;isMultiKey&quot; : false,
  &quot;n&quot; : 3999,
  &quot;nscannedObjects&quot; : 3999,
  &quot;nscanned&quot; : 3999,
  &quot;nscannedObjectsAllPlans&quot; : 3999,
  &quot;nscannedAllPlans&quot; : 3999,
  &quot;scanAndOrder&quot; : false,
  &quot;indexOnly&quot; : false,
  &quot;nYields&quot; : 0,
  &quot;nChunkSkips&quot; : 0,
  &quot;millis&quot; : 6,
  &quot;indexBounds&quot; : {
    &quot;a&quot; : [
      [
        1000,
        5000
      ]
    ]
  },
  &quot;server&quot; : &quot;localhost:27017&quot;
}</span>
</pre>
<p>Contrast that to</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.sorting.find<span class="o">({</span>a: <span class="o">{</span><span class="nv">$lt</span>:5000, <span class="nv">$gt</span>: 1000<span class="o">}})</span>.sort<span class="o">({</span>a:-1<span class="o">})</span>.explain<span class="o">()</span>
<span class="go">{
  &quot;cursor&quot; : &quot;BtreeCursor a_1 reverse&quot;,
  &quot;isMultiKey&quot; : false,
  &quot;n&quot; : 3999,
  &quot;nscannedObjects&quot; : 3999,
  &quot;nscanned&quot; : 3999,
  &quot;nscannedObjectsAllPlans&quot; : 3999,
  &quot;nscannedAllPlans&quot; : 3999,
  &quot;scanAndOrder&quot; : false,
  &quot;indexOnly&quot; : false,
  &quot;nYields&quot; : 0,
  &quot;nChunkSkips&quot; : 0,
  &quot;millis&quot; : 6,
  &quot;indexBounds&quot; : {
    &quot;a&quot; : [
      [
        5000,
        1000
      ]
    ]
  },
  &quot;server&quot; : &quot;localhost:27017&quot;
}</span>
</pre>
<p>Notice how <tt class="docutils literal">cursor</tt> says <tt class="docutils literal">BtreeCursor a_1 reverse</tt> instead off <tt class="docutils literal">BtreeCursor a_1</tt>. This is because <tt class="docutils literal">MongoDB</tt> was able to use the index to sort the values by traversing the <tt class="docutils literal">index</tt> tree in the <tt class="docutils literal">reverse</tt> order.</p>
<p>But what if we sort on the field <tt class="docutils literal">b</tt> instead. Let's try it.</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.sorting.find<span class="o">({</span>a: <span class="o">{</span><span class="nv">$lt</span>:5000, <span class="nv">$gt</span>: 1000<span class="o">}})</span>.sort<span class="o">({</span>b:1<span class="o">})</span>.explain<span class="o">()</span>
<span class="go">{
  &quot;cursor&quot; : &quot;BtreeCursor a_1&quot;,
  &quot;isMultiKey&quot; : false,
  &quot;n&quot; : 3999,
  &quot;nscannedObjects&quot; : 3999,
  &quot;nscanned&quot; : 3999,
  &quot;nscannedObjectsAllPlans&quot; : 4100,
  &quot;nscannedAllPlans&quot; : 4100,
  &quot;scanAndOrder&quot; : true,
  &quot;indexOnly&quot; : false,
  &quot;nYields&quot; : 0,
  &quot;nChunkSkips&quot; : 0,
  &quot;millis&quot; : 22,
  &quot;indexBounds&quot; : {
    &quot;a&quot; : [
      [
        1000,
        5000
      ]
    ]
  },
  &quot;server&quot; : &quot;localhost:27017&quot;
}</span>
</pre>
<p>Let's look at the field here <tt class="docutils literal">scanAndOrder</tt>. <tt class="docutils literal">scanAndOrder</tt> is defined as <tt class="docutils literal">Is true if an index cannot be used to order the documents returned.</tt>. In the cases where we are using <tt class="docutils literal">a</tt> for sorting this is set to <tt class="docutils literal">false</tt> as the index can be used for the sorting. But in the case of using <tt class="docutils literal">b</tt> for sorting MongoDB cannot use the <tt class="docutils literal">a</tt> index for sorting so it uses it to retrieve all the matching documents by the query and then sorts them by <tt class="docutils literal">b</tt> in memory.</p>
<dl class="docutils">
<dt>NOTE::</dt>
<dd>At the moment MongoDB can only use a single index for a query and sort, this will change in the future to allow multiple indexes to be used in a query and sort scenario.</dd>
</dl>
</div>
<div class="section" id="compound-that-index">
<h3><a class="toc-backref" href="#id87">Compound That Index</a></h3>
<p>So we've looked at single value indexes. But what if we want to search by <tt class="docutils literal">a</tt> as well as <tt class="docutils literal">b</tt> and also a combination of the two. This is where <tt class="docutils literal">compound indexes</tt> come in. A <tt class="docutils literal">compound index</tt> is an index built up of one or fields. Let's use the data from the previous example to play around with the implications for search. But first let's drop the existing indexes and then create the compound index <tt class="docutils literal">{a:1, <span class="pre">b:-1}</span></tt>.</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.sorting.dropIndexes<span class="o">()</span>
<span class="gp">&gt;</span> db.sorting.ensureIndex<span class="o">({</span>a:1, b:1<span class="o">})</span>
</pre>
<p>The index can be created in the following way with the driver.</p>
<pre class="code javascript literal-block">
<span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'employees'</span><span class="p">).</span><span class="nx">ensureIndex</span><span class="p">(</span><span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span><span class="p">});</span>
</pre>
<p>Let's do the query over the field <tt class="docutils literal">a</tt> again and sort over the fields <tt class="docutils literal">a</tt> and <tt class="docutils literal">b</tt>.</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.sorting.find<span class="o">({</span>a: <span class="o">{</span><span class="nv">$lt</span>:5000, <span class="nv">$gt</span>: 1000<span class="o">}})</span>.sort<span class="o">({</span>a:1, b:1<span class="o">})</span>.explain<span class="o">()</span>
<span class="go">{
  &quot;cursor&quot; : &quot;BtreeCursor a_1_b_1&quot;,
  &quot;isMultiKey&quot; : false,
  &quot;n&quot; : 3999,
  &quot;nscannedObjects&quot; : 3999,
  &quot;nscanned&quot; : 3999,
  &quot;nscannedObjectsAllPlans&quot; : 3999,
  &quot;nscannedAllPlans&quot; : 3999,
  &quot;scanAndOrder&quot; : false,
  &quot;indexOnly&quot; : false,
  &quot;nYields&quot; : 0,
  &quot;nChunkSkips&quot; : 0,
  &quot;millis&quot; : 6,
  &quot;indexBounds&quot; : {
    &quot;a&quot; : [
      [
        1000,
        5000
      ]
    ],
    &quot;b&quot; : [
      [
        {
          &quot;$minElement&quot; : 1
        },
        {
          &quot;$maxElement&quot; : 1
        }
      ]
    ]
  },
  &quot;server&quot; : &quot;localhost:27017&quot;
}</span>
</pre>
<p>Notice how <tt class="docutils literal">scanAndOrder</tt> is false telling us MongoDB was able to use the index to sort the retrieve as well as sorting the data.</p>
<p>However if we don't specify the sort order as <tt class="docutils literal">{a:1, b:1}</tt> MongoDB cannot establish that we want to use the <tt class="docutils literal">b</tt> part of the index to sort and will have to sort all the documents after retrieving them.</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.sorting.find<span class="o">({</span>a: <span class="o">{</span><span class="nv">$lt</span>:5000, <span class="nv">$gt</span>: 1000<span class="o">}})</span>.sort<span class="o">({</span>b:1<span class="o">})</span>.explain<span class="o">()</span>
<span class="go">{
  &quot;cursor&quot; : &quot;BtreeCursor a_1_b_1&quot;,
  &quot;isMultiKey&quot; : false,
  &quot;n&quot; : 3999,
  &quot;nscannedObjects&quot; : 3999,
  &quot;nscanned&quot; : 3999,
  &quot;nscannedObjectsAllPlans&quot; : 4100,
  &quot;nscannedAllPlans&quot; : 4100,
  &quot;scanAndOrder&quot; : true,
  &quot;indexOnly&quot; : false,
  &quot;nYields&quot; : 0,
  &quot;nChunkSkips&quot; : 0,
  &quot;millis&quot; : 21,
  &quot;indexBounds&quot; : {
    &quot;a&quot; : [
      [
        1000,
        5000
      ]
    ],
    &quot;b&quot; : [
      [
        {
          &quot;$minElement&quot; : 1
        },
        {
          &quot;$maxElement&quot; : 1
        }
      ]
    ]
  },
  &quot;server&quot; : &quot;localhost:27017&quot;
}</span>
</pre>
<p>Notice how <tt class="docutils literal">scanAndOrder</tt> is <tt class="docutils literal">true</tt> when we just sort by <tt class="docutils literal">{b:1}</tt>. The reason is that when the index is built it's compounded by adding the fields <tt class="docutils literal">a</tt> and <tt class="docutils literal">b</tt> together when we use <tt class="docutils literal"><span class="pre">ensureIndex({a:1,</span> b:1})</tt> meaning we need to tell MongoDB the sort order of the first key before the second one. If we wanted to sort by only <tt class="docutils literal">{b:1}</tt> we would need to reverse the order of the fields in the compound index making it <tt class="docutils literal">{b:1, a:1}</tt> instead.</p>
<p>Let's take a sample compound index and tell which queries would use the index and which would not be able to.</p>
<p>Assume the index <tt class="docutils literal">{ a: 1, b: 1, c: 1, d: 1 }</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="78%" />
<col width="22%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Query</th>
<th class="head">Uses Index</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>db.sorting.find().sort( { a:1 } )</td>
<td>true</td>
</tr>
<tr><td>db.sorting.find().sort( { a:1, b:1 } )</td>
<td>true</td>
</tr>
<tr><td>db.sorting.find( { a:4 } ).sort( { a:1, b:1 } )</td>
<td>true</td>
</tr>
<tr><td>db.sorting.find( { b:5 } ).sort( { a:1, b:1 } )</td>
<td>true</td>
</tr>
<tr><td>db.sorting.find( { a:5 } ).sort( { b:1, c:1 } )</td>
<td>true</td>
</tr>
<tr><td>db.sorting.find( { a:5, c:4, b:3 } ).sort( { d:1 } )</td>
<td>true</td>
</tr>
<tr><td>db.sorting.find( { a: { $gt:4 } } ).sort( { a:1, b:1 } )</td>
<td>true</td>
</tr>
<tr><td>db.sorting.find( { a: { $gt:5 } } ).sort( { a:1, b:1 } )</td>
<td>true</td>
</tr>
<tr><td>db.sorting.find( { a:5, b:3, d:{ $gt:4 } } ).sort( { c:1 } )</td>
<td>true</td>
</tr>
<tr><td>db.sorting.find( { a:5, b:3, c:{ $lt:2 }, d:{ $gt:4 } } )</td>
<td>true</td>
</tr>
<tr><td>db.sorting.find().sort( { b:1 } )</td>
<td><tt class="docutils literal">false</tt></td>
</tr>
<tr><td>db.sorting.find( { b:5 } ).sort( { b:1 } )</td>
<td><tt class="docutils literal">false</tt></td>
</tr>
<tr><td>db.sorting.find({ a:{$lt:10, $gt:5} }).sort({ b:1, c:1 })</td>
<td><tt class="docutils literal">false</tt></td>
</tr>
</tbody>
</table>
<p>Two important rules to keep in mind for your queries.</p>
<ol class="arabic simple">
<li>If doing a simple equality match and not matching on the first field <tt class="docutils literal">a</tt> you need to include the fields previous to the field you are matching on to use the index. Example <tt class="docutils literal">db.sorting.find( { b:5 } ).sort( { a:1, b:1 } )</tt></li>
<li>If doing a ranged query you need to include the field you are performing the ranged query over as well as proceeding fields. Example <tt class="docutils literal">db.sorting.find({ <span class="pre">b:{$lt:10,</span> $gt:5} <span class="pre">}).sort({</span> a:1, b:1, c:1 })</tt></li>
</ol>
<p>That covers the basics for <tt class="docutils literal">compound indexes</tt>. Let's move onto something cool that we can do with <tt class="docutils literal">compound indexes</tt> namely <tt class="docutils literal">covered indexes</tt>.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">When sorting large results sets you want to make sure you are using the index as MongoDB will only sort up to 32MB of document at the moment meaning that if the result set is to big it will not be sorted.</p>
</div>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">In development I tend to use an option for <tt class="docutils literal">mongod</tt> that allows me to catch queries that don't use an index. When you start up the <tt class="docutils literal">mongod</tt> server add the option <tt class="docutils literal"><span class="pre">--notablescan</span></tt> to the <tt class="docutils literal">mongod</tt> command line. If you now attempt to run a query that does not use an index MongoDb will throw an error <tt class="docutils literal"><span class="pre">{&quot;$err&quot;</span> : &quot;table scans not allowed:test.salaries&quot;, &quot;code&quot; : 10111 }</tt></p>
</div>
</div>
<div class="section" id="i-ve-got-you-covered">
<h3><a class="toc-backref" href="#id88">I've Got You Covered</a></h3>
<p>So what if you could return results from a query without ever touching the actual documents. Incredible as this sounds it's possible because of <tt class="docutils literal">compound indexes</tt>. There is only one limitation and that is that we cannot return the <tt class="docutils literal">_id</tt> field.</p>
<p>Given the documents inserted into the database <tt class="docutils literal">test</tt> and collection <tt class="docutils literal">users</tt>.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
  <span class="nx">pid</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">'Steve'</span><span class="p">,</span>
  <span class="nx">salary</span><span class="o">:</span> <span class="mi">10000</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="nx">pid</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">'John'</span><span class="p">,</span>
  <span class="nx">salary</span><span class="o">:</span> <span class="mi">12000</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="nx">pid</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">'Peter'</span><span class="p">,</span>
  <span class="nx">salary</span><span class="o">:</span> <span class="mi">7000</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="nx">pid</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">'Arnold'</span><span class="p">,</span>
  <span class="nx">salary</span><span class="o">:</span> <span class="mi">32000</span>
<span class="p">}</span>
</pre>
<p>No let's create a compound index over the tree fields present.</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.users.dropIndexes<span class="o">()</span>
<span class="gp">&gt;</span> db.users.ensureIndex<span class="o">({</span>pid:1, name:1, salary:1<span class="o">})</span>
</pre>
<p>The index can be created in the following way with the driver.</p>
<pre class="code javascript literal-block">
<span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'employees'</span><span class="p">).</span><span class="nx">ensureIndex</span><span class="p">(</span><span class="p">{</span><span class="nx">pid</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">salary</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span><span class="p">});</span>
</pre>
<p>Let's perform a normal simple query to retrieve all the users.</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.users.find<span class="o">({</span>pid:<span class="o">{</span><span class="nv">$gt</span>: 1<span class="o">}})</span>
<span class="go">{   &quot;_id&quot; : ObjectId(&quot;51824040ae699e537241fcef&quot;)
  , &quot;pid&quot; : 2
  , &quot;name&quot; : &quot;John&quot;
  , &quot;salary&quot; : 12000 }
{   &quot;_id&quot; : ObjectId(&quot;51824040ae699e537241fcf0&quot;)
  , &quot;pid&quot; : 7
  , &quot;name&quot; : &quot;Peter&quot;
  , &quot;salary&quot; : 7000 }
{   &quot;_id&quot; : ObjectId(&quot;51824040ae699e537241fcf1&quot;)
  , &quot;pid&quot; : 18
  , &quot;name&quot; : &quot;Arnold&quot;
  , &quot;salary&quot; : 32000 }</span>
</pre>
<p>Sweet works fine and the explain method returns</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.users.find<span class="o">({</span>pid:<span class="o">{</span><span class="nv">$gt</span>: 1<span class="o">}})</span>.explain<span class="o">()</span>
<span class="go">{
  &quot;cursor&quot; : &quot;BtreeCursor pid_1_name_1_salary_1&quot;,
  &quot;isMultiKey&quot; : false,
  &quot;n&quot; : 3,
  &quot;nscannedObjects&quot; : 3,
  &quot;nscanned&quot; : 3,
  &quot;nscannedObjectsAllPlans&quot; : 3,
  &quot;nscannedAllPlans&quot; : 3,
  &quot;scanAndOrder&quot; : false,
  &quot;indexOnly&quot; : false,
  &quot;nYields&quot; : 0,
  &quot;nChunkSkips&quot; : 0,
  &quot;millis&quot; : 0,
  &quot;indexBounds&quot; : {
    &quot;pid&quot; : [
      [
        1,
        1.7976931348623157e+308
      ]
    ],
    &quot;name&quot; : [
      [
        {
          &quot;$minElement&quot; : 1
        },
        {
          &quot;$maxElement&quot; : 1
        }
      ]
    ],
    &quot;salary&quot; : [
      [
        {
          &quot;$minElement&quot; : 1
        },
        {
          &quot;$maxElement&quot; : 1
        }
      ]
    ]
  },
  &quot;server&quot; : &quot;localhost:27017&quot;
}</span>
</pre>
<p>Showing us that we are using the index during the query. Now let's modify the query slightly to get rid of the <tt class="docutils literal">_id</tt> field in the results and only return the values <tt class="docutils literal">pid</tt>, <tt class="docutils literal">name</tt> and <tt class="docutils literal">salary</tt>.</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.users.find<span class="o">({</span>pid:<span class="o">{</span><span class="nv">$gt</span>: 1<span class="o">}}</span>, <span class="o">{</span>_id:0, pid:1, name:1, salary:1<span class="o">})</span>
<span class="go">{ &quot;pid&quot; : 2, &quot;name&quot; : &quot;John&quot;, &quot;salary&quot; : 12000 }
{ &quot;pid&quot; : 7, &quot;name&quot; : &quot;Peter&quot;, &quot;salary&quot; : 7000 }
{ &quot;pid&quot; : 18, &quot;name&quot; : &quot;Arnold&quot;, &quot;salary&quot; : 32000 }</span>
</pre>
<p>And let's run the explain again</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.users.find<span class="o">({</span>pid:<span class="o">{</span><span class="nv">$gt</span>: 1<span class="o">}}</span>, <span class="o">{</span>_id:0, pid:1, name:1, salary:1<span class="o">})</span>.explain<span class="o">()</span>
<span class="go">{
  &quot;cursor&quot; : &quot;BtreeCursor pid_1_name_1_salary_1&quot;,
  &quot;isMultiKey&quot; : false,
  &quot;n&quot; : 3,
  &quot;nscannedObjects&quot; : 0,
  &quot;nscanned&quot; : 3,
  &quot;nscannedObjectsAllPlans&quot; : 0,
  &quot;nscannedAllPlans&quot; : 3,
  &quot;scanAndOrder&quot; : false,
  &quot;indexOnly&quot; : true,
  &quot;nYields&quot; : 0,
  &quot;nChunkSkips&quot; : 0,
  &quot;millis&quot; : 0,
  &quot;indexBounds&quot; : {
    &quot;pid&quot; : [
      [
        1,
        1.7976931348623157e+308
      ]
    ],
    &quot;name&quot; : [
      [
        {
          &quot;$minElement&quot; : 1
        },
        {
          &quot;$maxElement&quot; : 1
        }
      ]
    ],
    &quot;salary&quot; : [
      [
        {
          &quot;$minElement&quot; : 1
        },
        {
          &quot;$maxElement&quot; : 1
        }
      ]
    ]
  },
  &quot;server&quot; : &quot;localhost:27017&quot;
}</span>
</pre>
<p>Notice something different?. Take a look at the <tt class="docutils literal">indexOnly</tt> field. It's now set to <tt class="docutils literal">true</tt> because MongoDB is able to use the data stored in the index to answer the query instead of having to read documents. This can be a powerful feature that can speed up queries by leveraging the indexes and avoiding loading documents from disk. You don't have to return all three values, but can return any combination of the tree values. The only limitation is that you can only return fields that are in the index (in this case <tt class="docutils literal">pid</tt>, <tt class="docutils literal">name</tt> or <tt class="docutils literal">salary</tt>) and <tt class="docutils literal">_id</tt> can never be returned or MongoDB will have to access the actual documents.</p>
<p>That covers <tt class="docutils literal">covered indexes</tt>. Next we will have a look at what's called a <tt class="docutils literal">sparse</tt> index.</p>
</div>
<div class="section" id="sparse-indexes">
<h3><a class="toc-backref" href="#id89">Sparse Indexes</a></h3>
<p>Let's imagine that we have a set of document where only some of the documents have a specific field. If we index this field normally it will include an entry for each document even if they don't have the field. This is obviously not very efficient space wise as we are including empty documents in our index. This is where a <tt class="docutils literal">sparse index</tt> comes in. A <tt class="docutils literal">sparse index</tt> will only include the documents in the index where the field is actually present.</p>
<p>We assume that we have the following documents inserted in the <tt class="docutils literal">test</tt> database and <tt class="docutils literal">sparse</tt> collection.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
  <span class="nx">pid</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">'Steve'</span><span class="p">,</span>
  <span class="nx">salary</span><span class="o">:</span> <span class="mi">10000</span><span class="p">,</span>
  <span class="nx">city</span><span class="o">:</span> <span class="s1">'New York'</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="nx">pid</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">'John'</span><span class="p">,</span>
  <span class="nx">salary</span><span class="o">:</span> <span class="mi">12000</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="nx">pid</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">'Peter'</span><span class="p">,</span>
  <span class="nx">salary</span><span class="o">:</span> <span class="mi">7000</span><span class="p">,</span>
  <span class="nx">city</span><span class="o">:</span> <span class="s1">'New York'</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="nx">pid</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">'Arnold'</span><span class="p">,</span>
  <span class="nx">salary</span><span class="o">:</span> <span class="mi">32000</span>
<span class="p">}</span>
</pre>
<p>Let's create a sparse index on the field <tt class="docutils literal">city</tt></p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.sparse.ensureIndex<span class="o">({</span>city:1<span class="o">}</span>, <span class="o">{</span>sparse:true<span class="o">})</span>
</pre>
<p>The index can be created in the following way with the driver.</p>
<pre class="code javascript literal-block">
<span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'employees'</span><span class="p">).</span><span class="nx">ensureIndex</span><span class="p">(</span><span class="p">{</span><span class="nx">city</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">sparse</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span><span class="p">});</span>
</pre>
<p>When we query for the field <tt class="docutils literal">city</tt> we will not only query an index that contains documents that actually have the field populated. Imagine that the total number of documents that contain a city is <tt class="docutils literal">30%</tt> of the collection. This means we only have entries for <tt class="docutils literal">30%</tt> of the documents in the <tt class="docutils literal">sparse index</tt> versus all of the documents in a normal index, saving us lots of diskspace and memory to hold the index. Not much more to say about <tt class="docutils literal">sparse indexes</tt>.</p>
<p>Until now we have been talking about indexes that contain all documents for a given value (if we have an index on field <tt class="docutils literal">a</tt> and two documents that contain the field <tt class="docutils literal">a</tt> with the same value they are both stored in the index). But what if we want to ensure that only a single document can have a specific value for <tt class="docutils literal">a</tt>. Luckily we can do that with an unique index.</p>
</div>
<div class="section" id="i-m-an-unique-flower">
<h3><a class="toc-backref" href="#id90">I'm An Unique Flower</a></h3>
<p>Let's take the situation of a social security number. Only one person can have a specific social security number associated with them. To ensure this is the case we can create an <tt class="docutils literal">unique</tt> index. An <tt class="docutils literal">unique</tt> index is an index that rejects insertion of values that have duplicate values for the fields in the index. Let's get cracking with some examples. First insert an employee <tt class="docutils literal">Peter</tt> and then create the unique index on the field <tt class="docutils literal">ssid</tt>.</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.employees.insert<span class="o">({</span>ssid:<span class="s1">'123'</span>, name:<span class="s1">'Peter'</span><span class="o">})</span>
<span class="gp">&gt;</span> db.employees.ensureIndex<span class="o">({</span>ssid:1<span class="o">}</span>, <span class="o">{</span>unique:true<span class="o">})</span>
</pre>
<p>The index can be created in the following way with the driver.</p>
<pre class="code javascript literal-block">
<span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'employees'</span><span class="p">).</span><span class="nx">ensureIndex</span><span class="p">(</span><span class="p">{</span><span class="nx">ssid</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">unique</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span><span class="p">});</span>
</pre>
<p>Cool we have an <tt class="docutils literal">unique index</tt> specified for the field <tt class="docutils literal">ssid</tt>. Let's attempt to insert a duplicate record.</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.employees.insert<span class="o">({</span>ssid:<span class="s1">'123'</span>, name:<span class="s1">'Peter'</span><span class="o">})</span>
<span class="go">E11000 duplicate key error index: test.employees.$ssid_1  dup key: { : &quot;123&quot; }</span>
</pre>
<p>One more thing to note is that this also works for <tt class="docutils literal">compound indexes</tt>. Let's say the <tt class="docutils literal">ssid</tt> and <tt class="docutils literal">name</tt> combination must be unique. Let's try it out.</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.employees.dropIndexes<span class="o">()</span>
<span class="gp">&gt;</span> db.employees.insert<span class="o">({</span>ssid:<span class="s1">'123'</span>, name:<span class="s1">'Peter'</span><span class="o">})</span>
<span class="gp">&gt;</span> db.employees.ensureIndex<span class="o">({</span>ssid:1, name:1<span class="o">}</span>, <span class="o">{</span>unique:true<span class="o">})</span>
<span class="gp">&gt;</span> db.employees.insert<span class="o">({</span>ssid:<span class="s1">'123'</span>, name:<span class="s1">'Peter'</span><span class="o">})</span>
<span class="go">E11000 duplicate key error index: test.employees.$ssid_1_name_1
dup key: { : &quot;123&quot;, : &quot;Peter&quot; }
</span><span class="gp">&gt;</span> db.employees.insert<span class="o">({</span>ssid:<span class="s1">'123'</span>, name:<span class="s1">'Peter2'</span><span class="o">})</span>
</pre>
<p>The index can be created in the following way with the driver.</p>
<pre class="code javascript literal-block">
<span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'employees'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">ensureIndex</span><span class="p">(</span><span class="p">{</span><span class="nx">ssid</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">unique</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span><span class="p">});</span>
</pre>
<p>As you can see it works perfectly with a <tt class="docutils literal">compound index</tt> as well.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">All documents include the <tt class="docutils literal">_id</tt> field which a unique index. This is to ensure a document in a collection can be <tt class="docutils literal">uniquely</tt> identified.</p>
</div>
<p>So far we have been indexing single fields, but what if we want to index fields that are arrays or sub documents?</p>
</div>
<div class="section" id="indexing-arrays-and-sub-documents">
<h3><a class="toc-backref" href="#id91">Indexing Arrays and Sub Documents</a></h3>
<p>MongoDB can index both array field and sub documents. But how to go about it. Let's take an example document that contains tags.</p>
<p>We assume we have the following documents stored in the database <tt class="docutils literal">test</tt> and collection <tt class="docutils literal">docs</tt>.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
  <span class="nx">title</span><span class="o">:</span> <span class="s1">'Abgenders 2'</span><span class="p">,</span>
  <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s1">'comic'</span><span class="p">,</span> <span class="s1">'scifi'</span><span class="p">,</span> <span class="s1">'parody'</span><span class="p">],</span>
  <span class="nx">published</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">year</span><span class="o">:</span> <span class="mi">2012</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="nx">title</span><span class="o">:</span> <span class="s1">'Nerds 4'</span><span class="p">,</span>
  <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s1">'comic'</span><span class="p">,</span> <span class="s1">'scifi'</span><span class="p">,</span> <span class="s1">'serious'</span><span class="p">],</span>
  <span class="nx">published</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">year</span><span class="o">:</span> <span class="mi">2011</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>Let's create two indexes to allow us to query by tag and also by date.</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.docs.dropIndexes<span class="o">()</span>
<span class="gp">&gt;</span> db.docs.ensureIndex<span class="o">({</span>tags: 1<span class="o">})</span>
<span class="gp">&gt;</span> db.docs.ensureIndex<span class="o">({</span><span class="s1">'published.year'</span>: 1<span class="o">})</span>
</pre>
<p>The index can be created in the following way with the driver.</p>
<pre class="code javascript literal-block">
<span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'employees'</span><span class="p">).</span><span class="nx">ensureIndex</span><span class="p">(</span><span class="p">{</span><span class="nx">tags</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span><span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'employees'</span><span class="p">).</span><span class="nx">ensureIndex</span><span class="p">(</span><span class="p">{</span><span class="s1">'published.year'</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span><span class="p">});</span>
</pre>
<p>Let's execute a query using each of the indexes.</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.docs.find<span class="o">({</span>tags:<span class="s1">'scifi'</span><span class="o">})</span>.explain<span class="o">()</span>
<span class="go">{
  &quot;cursor&quot; : &quot;BtreeCursor tags_1&quot;,
  &quot;isMultiKey&quot; : true,
  &quot;n&quot; : 2,
  &quot;nscannedObjects&quot; : 2,
  &quot;nscanned&quot; : 2,
  &quot;nscannedObjectsAllPlans&quot; : 2,
  &quot;nscannedAllPlans&quot; : 2,
  &quot;scanAndOrder&quot; : false,
  &quot;indexOnly&quot; : false,
  &quot;nYields&quot; : 0,
  &quot;nChunkSkips&quot; : 0,
  &quot;millis&quot; : 0,
  &quot;indexBounds&quot; : {
    &quot;tags&quot; : [
      [
        &quot;scifi&quot;,
        &quot;scifi&quot;
      ]
    ]
  },
  &quot;server&quot; : &quot;localhost:27017&quot;
}</span>
</pre>
<p>and</p>
<pre class="code console literal-block">
<span class="gp">&gt;</span> use <span class="nb">test
</span><span class="gp">&gt;</span><span class="nb"> </span>db.docs.find<span class="o">({</span><span class="s1">'published.year'</span>:2012<span class="o">})</span>.explain<span class="o">()</span>
<span class="go">{
  &quot;cursor&quot; : &quot;BtreeCursor published.year_1&quot;,
  &quot;isMultiKey&quot; : false,
  &quot;n&quot; : 1,
  &quot;nscannedObjects&quot; : 1,
  &quot;nscanned&quot; : 1,
  &quot;nscannedObjectsAllPlans&quot; : 1,
  &quot;nscannedAllPlans&quot; : 1,
  &quot;scanAndOrder&quot; : false,
  &quot;indexOnly&quot; : false,
  &quot;nYields&quot; : 0,
  &quot;nChunkSkips&quot; : 0,
  &quot;millis&quot; : 0,
  &quot;indexBounds&quot; : {
    &quot;published.year&quot; : [
      [
        2012,
        2012
      ]
    ]
  },
  &quot;server&quot; : &quot;localhost:27017&quot;
}</span>
</pre>
<p>As we can see we both of the queries uses indexes to retrieve the values. One of the possibilities of being able to index arrays is that you can create a word index lookup. Imagine that you want to be able to look for documents that matches a specific word. You could do this using a <tt class="docutils literal">regular</tt> expression query but this would most likely force a table scan for your query. What if you instead split the text into words, add them to a field <tt class="docutils literal">words</tt> as an array and then <tt class="docutils literal">ensureIndex(words:1)</tt>. Now you can leverage the index to do a quick lookup.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">In 2.4 or later MongoDB includes an experimental <tt class="docutils literal">text index</tt> that we will talk more about in a later exercise.</p>
</div>
</div>
</div>
<div class="section" id="exercise-18-the-importance-of-schema-design">
<h2><a class="toc-backref" href="#id92">Exercise 18: The Importance of Schema Design</a></h2>
<p>The hardest part of starting to work with MongoDB is to unlearn most of the skills you have applied to data modeling when using a traditional Relational Database. That's not to say that the skills are wasted it's just that the emphasis is on on other factors than when creating a relational model.</p>
<p>One of the main goals of Relational Databases is to avoid duplication of information as well as the integrity of said data. This is usually accomplished by providing a Database Description Language that allows you to specify constraints and relationships between data items (including one to one, one to many and many to many relationships). The focus on demoralization of the data (avoid duplicated data) means we store the relationships in <tt class="docutils literal">join tables</tt> and merge the data together at query time to reconstitute the final result. There are a lot of fancy words here. Let's make it simpler by showing a model some very simple entities, namely a book and an author.</p>
<p>Let's write down some facts about the book (I studied at Swinburne in Melbourne the homestead of ORM, object relational modeling).</p>
<div class="section" id="facts">
<h3><a class="toc-backref" href="#id93">Facts</a></h3>
<div class="section" id="book-facts">
<h4><a class="toc-backref" href="#id94">Book Facts</a></h4>
<ul class="simple">
<li>A book has a title of <tt class="docutils literal">Moby Dick</tt></li>
<li>A book had a an unique ISBN number</li>
<li>A book has a published data</li>
<li>A book has a publisher</li>
<li>A book was written by one or more authors</li>
</ul>
</div>
<div class="section" id="author-facts">
<h4><a class="toc-backref" href="#id95">Author Facts</a></h4>
<ul class="simple">
<li>An author has a name</li>
<li>An author has written one or more books</li>
</ul>
</div>
<div class="section" id="publisher-facts">
<h4><a class="toc-backref" href="#id96">Publisher Facts</a></h4>
<ul class="simple">
<li>A publisher has a name</li>
<li>A publisher has published one or more books</li>
</ul>
</div>
</div>
<div class="section" id="entity-relational-modeling">
<h3><a class="toc-backref" href="#id97">Entity Relational Modeling</a></h3>
<p>So what would this look like if using an <tt class="docutils literal">Entity Relational Modeling Diagram</tt>. Let's have a look at what a normalized data model for this could look like.</p>
<img alt="code/ex18/ex8.png" src="code/ex18/ex8.png" />
<p>Let's translate this into a set of tables we could use in a relational database. First up are the basic entity tables for <tt class="docutils literal">book</tt>, <tt class="docutils literal">publisher</tt> and <tt class="docutils literal">author</tt>.</p>
<div class="section" id="book-table">
<h4><a class="toc-backref" href="#id98">Book Table</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="38%" />
<col width="62%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Field</th>
<th class="head">Type</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Id</td>
<td>autoincrement int</td>
</tr>
<tr><td>Title</td>
<td>varchar (255)</td>
</tr>
<tr><td>ISBN</td>
<td>varchar (25)</td>
</tr>
<tr><td>Published</td>
<td>datetime</td>
</tr>
<tr><td>Publisher_id</td>
<td><tt class="docutils literal">Foreign Key Id</tt> to table Publishers</td>
</tr>
</tbody>
</table>
<p>Since there is only a single <tt class="docutils literal">publisher</tt> we can include a reference to the publisher entity directly in the <tt class="docutils literal">book</tt> table.</p>
</div>
<div class="section" id="publisher-table">
<h4><a class="toc-backref" href="#id99">Publisher Table</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Field</th>
<th class="head">Type</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Id</td>
<td>autoincrement int</td>
</tr>
<tr><td>Name</td>
<td>varchar (255)</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="author-table">
<h4><a class="toc-backref" href="#id100">Author Table</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Field</th>
<th class="head">Type</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Id</td>
<td>autoincrement int</td>
</tr>
<tr><td>Name</td>
<td>varchar (255)</td>
</tr>
</tbody>
</table>
<p>Next up we need to define the relationships between the entities. Luckily for us the relationship between a <tt class="docutils literal">publisher</tt> and a <tt class="docutils literal">book</tt> is that a <tt class="docutils literal">publisher</tt> can publish many <tt class="docutils literal">books</tt> but a <tt class="docutils literal">book</tt> can only have one <tt class="docutils literal">publisher</tt>. This means we don't need a special join table to be able to retrieve both sides of the query. It's enough to just put the <tt class="docutils literal">publisher's id</tt> in the <tt class="docutils literal">book</tt> table.</p>
<p>On the other hand an <tt class="docutils literal">author</tt> can have written many books and a book can have more than one <tt class="docutils literal">author</tt>. We need to introduce a table to model this relation. This is called a <tt class="docutils literal">join table</tt>. This table well show the relationships between individual books and authors.</p>
</div>
<div class="section" id="authorbook-table">
<h4><a class="toc-backref" href="#id101">AuthorBook Table</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Field</th>
<th class="head">Type</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Book Id</td>
<td><tt class="docutils literal">Foreign Key Id</tt> to table Books</td>
</tr>
<tr><td>Author Id</td>
<td><tt class="docutils literal">Foreign Key Id</tt> to table Author</td>
</tr>
</tbody>
</table>
<p>Awesome we have an initial model for how to store a book. Now let's use this in our fancy OO language. Let's define a set of classes that allows us to represent a book, an author and a publisher.</p>
<div class="highlight"><pre><a name="code--ex18--ex1.js-pyg.html-1"></a><span class="c1">// Helper method to make simple getter / setter</span>
<a name="code--ex18--ex1.js-pyg.html-2"></a><span class="kd">var</span> <span class="nx">simple_setter_getter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex18--ex1.js-pyg.html-3"></a>  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
<a name="code--ex18--ex1.js-pyg.html-4"></a>    <span class="p">,</span> <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">fields</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span> <span class="p">}</span>
<a name="code--ex18--ex1.js-pyg.html-5"></a>    <span class="p">,</span> <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="nx">fields</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="p">}</span>
<a name="code--ex18--ex1.js-pyg.html-6"></a>  <span class="p">});</span>
<a name="code--ex18--ex1.js-pyg.html-7"></a><span class="p">}</span>
<a name="code--ex18--ex1.js-pyg.html-8"></a>
<a name="code--ex18--ex1.js-pyg.html-9"></a><span class="c1">// An Author entity</span>
<a name="code--ex18--ex1.js-pyg.html-10"></a><span class="kd">var</span> <span class="nx">Author</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_name</span><span class="p">,</span> <span class="nx">_books</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex18--ex1.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">fields</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex18--ex1.js-pyg.html-12"></a>      <span class="nx">name</span><span class="o">:</span> <span class="nx">_name</span>
<a name="code--ex18--ex1.js-pyg.html-13"></a>    <span class="p">,</span> <span class="nx">books</span><span class="o">:</span> <span class="nx">_books</span> <span class="o">||</span> <span class="p">[]</span>
<a name="code--ex18--ex1.js-pyg.html-14"></a>  <span class="p">}</span>
<a name="code--ex18--ex1.js-pyg.html-15"></a>
<a name="code--ex18--ex1.js-pyg.html-16"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">addBook</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">book</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex18--ex1.js-pyg.html-17"></a>    <span class="nx">fields</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">book</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-18"></a>  <span class="p">}</span>
<a name="code--ex18--ex1.js-pyg.html-19"></a>
<a name="code--ex18--ex1.js-pyg.html-20"></a>  <span class="nx">simple_setter_getter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-21"></a>  <span class="nx">simple_setter_getter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="s2">&quot;books&quot;</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-22"></a><span class="p">}</span>
<a name="code--ex18--ex1.js-pyg.html-23"></a>
<a name="code--ex18--ex1.js-pyg.html-24"></a><span class="c1">// A Published entity</span>
<a name="code--ex18--ex1.js-pyg.html-25"></a><span class="kd">var</span> <span class="nx">Publisher</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_name</span><span class="p">,</span> <span class="nx">_books</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex18--ex1.js-pyg.html-26"></a>  <span class="kd">var</span> <span class="nx">fields</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex18--ex1.js-pyg.html-27"></a>      <span class="nx">name</span><span class="o">:</span> <span class="nx">_name</span>
<a name="code--ex18--ex1.js-pyg.html-28"></a>    <span class="p">,</span> <span class="nx">books</span><span class="o">:</span> <span class="nx">_books</span> <span class="o">||</span> <span class="p">[]</span>
<a name="code--ex18--ex1.js-pyg.html-29"></a>  <span class="p">}</span>
<a name="code--ex18--ex1.js-pyg.html-30"></a>
<a name="code--ex18--ex1.js-pyg.html-31"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">addBook</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">book</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex18--ex1.js-pyg.html-32"></a>    <span class="nx">fields</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">book</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-33"></a>  <span class="p">}</span>
<a name="code--ex18--ex1.js-pyg.html-34"></a>
<a name="code--ex18--ex1.js-pyg.html-35"></a>  <span class="nx">simple_setter_getter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-36"></a>  <span class="nx">simple_setter_getter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="s2">&quot;books&quot;</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-37"></a><span class="p">}</span>
<a name="code--ex18--ex1.js-pyg.html-38"></a>
<a name="code--ex18--ex1.js-pyg.html-39"></a><span class="c1">// A Book entity</span>
<a name="code--ex18--ex1.js-pyg.html-40"></a><span class="kd">var</span> <span class="nx">Book</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_isbn</span><span class="p">,</span> <span class="nx">_title</span><span class="p">,</span> <span class="nx">_published_date</span><span class="p">,</span> <span class="nx">_authors</span><span class="p">,</span> <span class="nx">_publisher</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex18--ex1.js-pyg.html-41"></a>  <span class="kd">var</span> <span class="nx">fields</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex18--ex1.js-pyg.html-42"></a>      <span class="nx">isbn</span><span class="o">:</span> <span class="nx">_isbn</span>
<a name="code--ex18--ex1.js-pyg.html-43"></a>    <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">_title</span>
<a name="code--ex18--ex1.js-pyg.html-44"></a>    <span class="p">,</span> <span class="nx">published_date</span><span class="o">:</span> <span class="nx">_published_date</span>
<a name="code--ex18--ex1.js-pyg.html-45"></a>    <span class="p">,</span> <span class="nx">authors</span><span class="o">:</span> <span class="nx">_authors</span> <span class="o">||</span> <span class="p">[]</span>
<a name="code--ex18--ex1.js-pyg.html-46"></a>    <span class="p">,</span> <span class="nx">publisher</span><span class="o">:</span> <span class="nx">_publisher</span>
<a name="code--ex18--ex1.js-pyg.html-47"></a>  <span class="p">}</span>
<a name="code--ex18--ex1.js-pyg.html-48"></a>
<a name="code--ex18--ex1.js-pyg.html-49"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">addAuthor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">author</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex18--ex1.js-pyg.html-50"></a>    <span class="nx">fields</span><span class="p">.</span><span class="nx">authors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">author</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-51"></a>  <span class="p">}</span>
<a name="code--ex18--ex1.js-pyg.html-52"></a>
<a name="code--ex18--ex1.js-pyg.html-53"></a>  <span class="nx">simple_setter_getter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-54"></a>  <span class="nx">simple_setter_getter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="s2">&quot;isbn&quot;</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-55"></a>  <span class="nx">simple_setter_getter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="s2">&quot;authors&quot;</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-56"></a>  <span class="nx">simple_setter_getter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="s2">&quot;publisher&quot;</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-57"></a><span class="p">}</span>
<a name="code--ex18--ex1.js-pyg.html-58"></a>
<a name="code--ex18--ex1.js-pyg.html-59"></a><span class="c1">// Create a publisher</span>
<a name="code--ex18--ex1.js-pyg.html-60"></a><span class="kd">var</span> <span class="nx">publisher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Author</span><span class="p">(</span><span class="s2">&quot;Maxwell Books&quot;</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-61"></a><span class="c1">// Create the first author and book</span>
<a name="code--ex18--ex1.js-pyg.html-62"></a><span class="kd">var</span> <span class="nx">author1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Author</span><span class="p">(</span><span class="s2">&quot;James&quot;</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-63"></a><span class="kd">var</span> <span class="nx">book1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Book</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;Wizard&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">());</span>
<a name="code--ex18--ex1.js-pyg.html-64"></a>
<a name="code--ex18--ex1.js-pyg.html-65"></a><span class="c1">// Add the author to the book</span>
<a name="code--ex18--ex1.js-pyg.html-66"></a><span class="nx">book1</span><span class="p">.</span><span class="nx">addAuthor</span><span class="p">(</span><span class="nx">author1</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-67"></a><span class="c1">// Add the book to the author</span>
<a name="code--ex18--ex1.js-pyg.html-68"></a><span class="nx">author1</span><span class="p">.</span><span class="nx">addBook</span><span class="p">(</span><span class="nx">book1</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-69"></a><span class="c1">// Add the publisher to the book</span>
<a name="code--ex18--ex1.js-pyg.html-70"></a><span class="nx">book1</span><span class="p">.</span><span class="nx">publisher</span> <span class="o">=</span> <span class="nx">publisher</span><span class="p">;</span>
<a name="code--ex18--ex1.js-pyg.html-71"></a><span class="c1">// Add the book to the publisher</span>
<a name="code--ex18--ex1.js-pyg.html-72"></a><span class="nx">publisher</span><span class="p">.</span><span class="nx">addBook</span><span class="p">(</span><span class="nx">book1</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-73"></a>
<a name="code--ex18--ex1.js-pyg.html-74"></a><span class="c1">// Create second author and book</span>
<a name="code--ex18--ex1.js-pyg.html-75"></a><span class="kd">var</span> <span class="nx">author2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Author</span><span class="p">(</span><span class="s2">&quot;Peter&quot;</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-76"></a><span class="kd">var</span> <span class="nx">book2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Book</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;Space war&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span> <span class="p">[],</span> <span class="kc">null</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-77"></a>
<a name="code--ex18--ex1.js-pyg.html-78"></a><span class="c1">// Add the author to the book</span>
<a name="code--ex18--ex1.js-pyg.html-79"></a><span class="nx">book2</span><span class="p">.</span><span class="nx">addAuthor</span><span class="p">(</span><span class="nx">author2</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-80"></a><span class="c1">// Add the book to the author</span>
<a name="code--ex18--ex1.js-pyg.html-81"></a><span class="nx">author2</span><span class="p">.</span><span class="nx">addBook</span><span class="p">(</span><span class="nx">book1</span><span class="p">);</span>
<a name="code--ex18--ex1.js-pyg.html-82"></a><span class="c1">// Add the publisher to the book</span>
<a name="code--ex18--ex1.js-pyg.html-83"></a><span class="nx">book2</span><span class="p">.</span><span class="nx">publisher</span> <span class="o">=</span> <span class="nx">publisher</span><span class="p">;</span>
<a name="code--ex18--ex1.js-pyg.html-84"></a><span class="c1">// Add the book to the publisher</span>
<a name="code--ex18--ex1.js-pyg.html-85"></a><span class="nx">publisher</span><span class="p">.</span><span class="nx">addBook</span><span class="p">(</span><span class="nx">book2</span><span class="p">);</span>
</pre></div><p>One thing is clear mapping one of the objects to the underlying data store requires a set of co-ordinated inserts, queries and updates as the objects are very inter-dependent. F.ex for the <tt class="docutils literal">author</tt> object each <tt class="docutils literal">book</tt> must be stored in the <tt class="docutils literal">Book</tt> table before we can safely write to the <tt class="docutils literal">AuthorBook</tt> table.</p>
<p>This creates a fair bit of complexity. To avoid doing this over and over Object-Relational Mappers were developed to map from a class structure to a Relational database. This layers an additional level of abstraction on top of the relational model to make OO programming more natural and to hide the decomposition that needs to occur to fit the OO model to the relational model.</p>
<p>There are some pain point related to this, when it comes to changing the data model as you'll likely have to change your data model in 3 places in your code (first in your code, then in your ORM and lastly in the database itself). This incurs significant cognitive cost as you'll have to keep everything straight from top to bottom. Worse situation are if your entity model no longer fits the problem you are trying to solve in code and you need to evolve the schema. This can create a fairly substantial refactoring in your code base as you need to move relationships around and thus migrate data from a schema to another.</p>
<p>It gets worse when trying to describe tree like structures like objects as a single object might require a multitude of join tables making the mapping less than transparent between the <tt class="docutils literal">class</tt> and the storage layer below. When evolved over time the cost of change increases due to the implied complexity.</p>
<p>Thus one of the more important aspects of relational data modeling is to do better modeling up front to avoid the cost of mutating the schema later. It's harder to evolve the schema more naturally with the application itself.</p>
</div>
</div>
<div class="section" id="document-modeling">
<h3><a class="toc-backref" href="#id102">Document Modeling</a></h3>
<p>So why are document databases being em-brassed by developers. It's fairly simple. The mapping between an OO language and documents are much closer than between OO languages and relational models. Another aspect is the dynamic schema concept meaning that documents are not set in stone and can evolve without having to modify the underlying Schema definition.</p>
<p>Let's have a look at how we could model the Book class and it's relationships in a document database. Remember the definition of the Book class.</p>
<div class="highlight"><pre><a name="code--ex18--ex2.js-pyg.html-1"></a><span class="c1">// A Book entity</span>
<a name="code--ex18--ex2.js-pyg.html-2"></a><span class="kd">var</span> <span class="nx">Book</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_isbn</span><span class="p">,</span> <span class="nx">_title</span><span class="p">,</span> <span class="nx">_published_date</span><span class="p">,</span> <span class="nx">_authors</span><span class="p">,</span> <span class="nx">_publisher</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex18--ex2.js-pyg.html-3"></a>  <span class="kd">var</span> <span class="nx">fields</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex18--ex2.js-pyg.html-4"></a>      <span class="nx">isbn</span><span class="o">:</span> <span class="nx">_isbn</span>
<a name="code--ex18--ex2.js-pyg.html-5"></a>    <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">_title</span>
<a name="code--ex18--ex2.js-pyg.html-6"></a>    <span class="p">,</span> <span class="nx">published_date</span><span class="o">:</span> <span class="nx">_published_date</span>
<a name="code--ex18--ex2.js-pyg.html-7"></a>    <span class="p">,</span> <span class="nx">authors</span><span class="o">:</span> <span class="nx">_authors</span> <span class="o">||</span> <span class="p">[]</span>
<a name="code--ex18--ex2.js-pyg.html-8"></a>    <span class="p">,</span> <span class="nx">publisher</span><span class="o">:</span> <span class="nx">_publisher</span>
<a name="code--ex18--ex2.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex18--ex2.js-pyg.html-10"></a>
<a name="code--ex18--ex2.js-pyg.html-11"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">addAuthor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">author</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex18--ex2.js-pyg.html-12"></a>    <span class="nx">fields</span><span class="p">.</span><span class="nx">authors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">author</span><span class="p">);</span>
<a name="code--ex18--ex2.js-pyg.html-13"></a>  <span class="p">}</span>
<a name="code--ex18--ex2.js-pyg.html-14"></a>
<a name="code--ex18--ex2.js-pyg.html-15"></a>  <span class="nx">simple_setter_getter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">);</span>
<a name="code--ex18--ex2.js-pyg.html-16"></a>  <span class="nx">simple_setter_getter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="s2">&quot;isbn&quot;</span><span class="p">);</span>
<a name="code--ex18--ex2.js-pyg.html-17"></a>  <span class="nx">simple_setter_getter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="s2">&quot;authors&quot;</span><span class="p">);</span>
<a name="code--ex18--ex2.js-pyg.html-18"></a>  <span class="nx">simple_setter_getter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="s2">&quot;publisher&quot;</span><span class="p">);</span>
<a name="code--ex18--ex2.js-pyg.html-19"></a><span class="p">}</span>
</pre></div><p>How could this look as a document? Well let's create a JSON (JavaScript Object Notation) document to show a possible schema design. The first document represents a book, the second one an author and the third one a publisher.</p>
<div class="section" id="book">
<h4><a class="toc-backref" href="#id103">Book</a></h4>
<div class="highlight"><pre><a name="code--ex18--ex3.json-pyg.html-1"></a><span class="p">{</span>
<a name="code--ex18--ex3.json-pyg.html-2"></a>    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span>
<a name="code--ex18--ex3.json-pyg.html-3"></a>  <span class="p">,</span> <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Moby Dick&quot;</span>
<a name="code--ex18--ex3.json-pyg.html-4"></a>  <span class="p">,</span> <span class="nt">&quot;isbn&quot;</span><span class="p">:</span> <span class="s2">&quot;978-1853260087&quot;</span>
<a name="code--ex18--ex3.json-pyg.html-5"></a>  <span class="p">,</span> <span class="nt">&quot;published&quot;</span><span class="p">:</span> <span class="mi">1992</span>
<a name="code--ex18--ex3.json-pyg.html-6"></a>  <span class="p">,</span> <span class="nt">&quot;authors&quot;</span><span class="p">:</span> <span class="p">[{</span>
<a name="code--ex18--ex3.json-pyg.html-7"></a>        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span>
<a name="code--ex18--ex3.json-pyg.html-8"></a>      <span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Herman Melville&quot;</span>
<a name="code--ex18--ex3.json-pyg.html-9"></a>    <span class="p">}]</span>
<a name="code--ex18--ex3.json-pyg.html-10"></a>  <span class="p">,</span> <span class="nt">&quot;publisher&quot;</span><span class="p">:</span> <span class="p">{</span>
<a name="code--ex18--ex3.json-pyg.html-11"></a>      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span>
<a name="code--ex18--ex3.json-pyg.html-12"></a>    <span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Wordsworth Editions Ltd&quot;</span>
<a name="code--ex18--ex3.json-pyg.html-13"></a>  <span class="p">}</span>
<a name="code--ex18--ex3.json-pyg.html-14"></a><span class="p">}</span>
</pre></div></div>
<div class="section" id="author">
<h4><a class="toc-backref" href="#id104">Author</a></h4>
<div class="highlight"><pre><a name="code--ex18--ex4.json-pyg.html-1"></a><span class="p">{</span>
<a name="code--ex18--ex4.json-pyg.html-2"></a>    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span>
<a name="code--ex18--ex4.json-pyg.html-3"></a>  <span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Herman Melville&quot;</span>
<a name="code--ex18--ex4.json-pyg.html-4"></a>  <span class="p">,</span> <span class="nt">&quot;books&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a name="code--ex18--ex4.json-pyg.html-5"></a><span class="p">}</span>
</pre></div></div>
<div class="section" id="publisher">
<h4><a class="toc-backref" href="#id105">Publisher</a></h4>
<div class="highlight"><pre><a name="code--ex18--ex5.json-pyg.html-1"></a><span class="p">{</span>
<a name="code--ex18--ex5.json-pyg.html-2"></a>    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span>
<a name="code--ex18--ex5.json-pyg.html-3"></a>  <span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Wordsworth Editions Ltd&quot;</span>
<a name="code--ex18--ex5.json-pyg.html-4"></a>  <span class="p">,</span> <span class="nt">&quot;books&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a name="code--ex18--ex5.json-pyg.html-5"></a>  <span class="p">,</span> <span class="nt">&quot;authors&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a name="code--ex18--ex5.json-pyg.html-6"></a><span class="p">}</span>
</pre></div><p>Notice somethings? The data and context of the data is bundled together in the document making a document self descriptive. Also we have nested documents in the <tt class="docutils literal">Book</tt> document for the <tt class="docutils literal">authors</tt> and the <tt class="docutils literal">publisher</tt>. This matches very closely to how the actual <tt class="docutils literal">Book</tt> classes internal <tt class="docutils literal">fields</tt> are laid out. The level off abstraction between the model and the data in the database is lower.</p>
<p>This is especially evident if we decide to introduce a new concept like a review. Let's add the review concept to the <tt class="docutils literal">Book</tt> class.</p>
<div class="highlight"><pre><a name="code--ex18--ex6.js-pyg.html-1"></a><span class="c1">// A Book entity</span>
<a name="code--ex18--ex6.js-pyg.html-2"></a><span class="kd">var</span> <span class="nx">Book</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_isbn</span><span class="p">,</span> <span class="nx">_title</span><span class="p">,</span> <span class="nx">_published_date</span><span class="p">,</span> <span class="nx">_authors</span><span class="p">,</span> <span class="nx">_publisher</span><span class="p">,</span> <span class="nx">_reviews</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex18--ex6.js-pyg.html-3"></a>  <span class="kd">var</span> <span class="nx">fields</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex18--ex6.js-pyg.html-4"></a>      <span class="nx">isbn</span><span class="o">:</span> <span class="nx">_isbn</span>
<a name="code--ex18--ex6.js-pyg.html-5"></a>    <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">_title</span>
<a name="code--ex18--ex6.js-pyg.html-6"></a>    <span class="p">,</span> <span class="nx">published_date</span><span class="o">:</span> <span class="nx">_published_date</span>
<a name="code--ex18--ex6.js-pyg.html-7"></a>    <span class="p">,</span> <span class="nx">authors</span><span class="o">:</span> <span class="nx">_authors</span> <span class="o">||</span> <span class="p">[]</span>
<a name="code--ex18--ex6.js-pyg.html-8"></a>    <span class="p">,</span> <span class="nx">publisher</span><span class="o">:</span> <span class="nx">_publisher</span>
<a name="code--ex18--ex6.js-pyg.html-9"></a>    <span class="p">,</span> <span class="nx">reviews</span><span class="o">:</span> <span class="nx">_reviews</span>
<a name="code--ex18--ex6.js-pyg.html-10"></a>  <span class="p">}</span>
<a name="code--ex18--ex6.js-pyg.html-11"></a>
<a name="code--ex18--ex6.js-pyg.html-12"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">addAuthor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">author</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex18--ex6.js-pyg.html-13"></a>    <span class="nx">fields</span><span class="p">.</span><span class="nx">authors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">author</span><span class="p">);</span>
<a name="code--ex18--ex6.js-pyg.html-14"></a>  <span class="p">}</span>
<a name="code--ex18--ex6.js-pyg.html-15"></a>
<a name="code--ex18--ex6.js-pyg.html-16"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">addReview</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">review</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex18--ex6.js-pyg.html-17"></a>    <span class="nx">fields</span><span class="p">.</span><span class="nx">reviews</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">review</span><span class="p">);</span>
<a name="code--ex18--ex6.js-pyg.html-18"></a>  <span class="p">}</span>
<a name="code--ex18--ex6.js-pyg.html-19"></a>
<a name="code--ex18--ex6.js-pyg.html-20"></a>  <span class="nx">simple_setter_getter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">);</span>
<a name="code--ex18--ex6.js-pyg.html-21"></a>  <span class="nx">simple_setter_getter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="s2">&quot;isbn&quot;</span><span class="p">);</span>
<a name="code--ex18--ex6.js-pyg.html-22"></a>  <span class="nx">simple_setter_getter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="s2">&quot;authors&quot;</span><span class="p">);</span>
<a name="code--ex18--ex6.js-pyg.html-23"></a>  <span class="nx">simple_setter_getter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="s2">&quot;publisher&quot;</span><span class="p">);</span>
<a name="code--ex18--ex6.js-pyg.html-24"></a>  <span class="nx">simple_setter_getter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="s2">&quot;reviews&quot;</span><span class="p">);</span>
<a name="code--ex18--ex6.js-pyg.html-25"></a><span class="p">}</span>
</pre></div><p>Now let's see how that could be reflected in a the document for the <tt class="docutils literal">Book</tt>.</p>
<div class="highlight"><pre><a name="code--ex18--ex7.json-pyg.html-1"></a><span class="p">{</span>
<a name="code--ex18--ex7.json-pyg.html-2"></a>    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span>
<a name="code--ex18--ex7.json-pyg.html-3"></a>  <span class="p">,</span> <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Moby Dick&quot;</span>
<a name="code--ex18--ex7.json-pyg.html-4"></a>  <span class="p">,</span> <span class="nt">&quot;isbn&quot;</span><span class="p">:</span> <span class="s2">&quot; 978-1853260087&quot;</span>
<a name="code--ex18--ex7.json-pyg.html-5"></a>  <span class="p">,</span> <span class="nt">&quot;published&quot;</span><span class="p">:</span> <span class="mi">1992</span>
<a name="code--ex18--ex7.json-pyg.html-6"></a>  <span class="p">,</span> <span class="nt">&quot;authors&quot;</span><span class="p">:</span> <span class="p">[{</span>
<a name="code--ex18--ex7.json-pyg.html-7"></a>        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span>
<a name="code--ex18--ex7.json-pyg.html-8"></a>      <span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Herman Melville&quot;</span>
<a name="code--ex18--ex7.json-pyg.html-9"></a>    <span class="p">}]</span>
<a name="code--ex18--ex7.json-pyg.html-10"></a>  <span class="p">,</span> <span class="nt">&quot;publisher&quot;</span><span class="p">:</span> <span class="p">{</span>
<a name="code--ex18--ex7.json-pyg.html-11"></a>      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span>
<a name="code--ex18--ex7.json-pyg.html-12"></a>    <span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Wordsworth Editions Ltd&quot;</span>
<a name="code--ex18--ex7.json-pyg.html-13"></a>  <span class="p">}</span>
<a name="code--ex18--ex7.json-pyg.html-14"></a>  <span class="p">,</span> <span class="nt">&quot;reviews&quot;</span><span class="p">:</span> <span class="p">[{</span>
<a name="code--ex18--ex7.json-pyg.html-15"></a>      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span>
<a name="code--ex18--ex7.json-pyg.html-16"></a>    <span class="p">,</span> <span class="nt">&quot;review&quot;</span><span class="p">:</span> <span class="s2">&quot;Awesome book, loved the whale&quot;</span>
<a name="code--ex18--ex7.json-pyg.html-17"></a>    <span class="p">,</span> <span class="nt">&quot;stars&quot;</span><span class="p">:</span> <span class="mi">5</span>
<a name="code--ex18--ex7.json-pyg.html-18"></a>  <span class="p">}]</span>
<a name="code--ex18--ex7.json-pyg.html-19"></a><span class="p">}</span>
</pre></div><p>As you can see the mapping between the OO class and the data stored in the database is close to 1:1. In a relational database this would require an additional <tt class="docutils literal">Review</tt> table and a <tt class="docutils literal">BookReviews</tt> join table requiring additional logic to map back and forth between the OO class and the data model.</p>
</div>
</div>
<div class="section" id="things-to-note">
<h3><a class="toc-backref" href="#id106">Things To Note</a></h3>
<p>Our world is made up of data object that change structure over time. Document databases have become more and more popular as they embrace the concept of evolving data structures better than traditional relational databases and map better to the way computer programming languages model data. In later exercises we will go ahead and build our very own simple ODM (object document mapping) library to help us make the mapping more simple and get a feel on how to map data back and forth. We will also briefly introduce the Mongoose ODM as more full featured version of our simple attempt at abstraction. But first things first. We are going to explore different schema designs and the pros and cons of each.</p>
</div>
</div>
<div class="section" id="exercise-19-evolving-a-simple-schema">
<h2><a class="toc-backref" href="#id107">Exercise 19: Evolving A Simple Schema</a></h2>
<p>Let's put together some of the stuff we have covered including inserts, updates with atomic updates and removes to create a little book lending library application. We are going to focus on only the actual code around the book library itself in this chapter and then in the next chapter provide a very simple rest <tt class="docutils literal">API</tt> to out library application so we can integrate it into the next <tt class="docutils literal">facebook</tt> of library lending called <tt class="docutils literal">bookface</tt>.</p>
<p>Let's fact model our library model concepts.</p>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id108">Facts</a></h3>
<div class="section" id="id3">
<h4><a class="toc-backref" href="#id109">Book</a></h4>
<ul class="simple">
<li>A Book has the title <tt class="docutils literal">Fall of the Roman Empire</tt></li>
<li>The Book <tt class="docutils literal">Fall of the Roman Empire</tt> has the unique id 1</li>
<li>The Book <tt class="docutils literal">Fall of the Roman Empire</tt> has a 1973 Edition</li>
<li>The Book <tt class="docutils literal">Fall of the Roman Empire</tt> was published by <tt class="docutils literal">T Books</tt> in 1973</li>
<li>The Book <tt class="docutils literal">Fall of the Roman Empire</tt> is identified by the ISBN number <tt class="docutils literal"><span class="pre">978-1853260087</span></tt></li>
<li>The Book <tt class="docutils literal">Fall of the Roman Empire</tt> was written by the Author <tt class="docutils literal">James W Kirk</tt></li>
<li>The Book <tt class="docutils literal">Fall of the Roman Empire</tt> has the summary <tt class="docutils literal">The road to the fall of the Roman Empire</tt>, a comprehensive history of the greatest western empire's decline&quot;</li>
<li>The 1973 Edition of <tt class="docutils literal">Fall of the Roman Empire</tt> was loaned by the User <tt class="docutils literal">Peter Griffin</tt> on the 19th of June 1976.</li>
<li>The 1973 Edition of <tt class="docutils literal">Fall of the Roman Empire</tt> that was loaned by the User <tt class="docutils literal">Peter Griffin</tt> on the 1th of June 1986 should be returned on the 15th of June 1986.</li>
</ul>
</div>
<div class="section" id="edition">
<h4><a class="toc-backref" href="#id110">Edition</a></h4>
<ul class="simple">
<li>The Edition of <tt class="docutils literal">Fall of the Roman Empire</tt> is Published by <tt class="docutils literal">T Books</tt></li>
<li>The Edition of <tt class="docutils literal">Fall of the Roman Empire</tt> was Published in 1973</li>
<li>The Library has 4 copies of the 1973 Edition of the <tt class="docutils literal">Fall of the Roman Empire</tt></li>
</ul>
</div>
<div class="section" id="id4">
<h4><a class="toc-backref" href="#id111">Author</a></h4>
<ul class="simple">
<li>The Author <tt class="docutils literal">James W Kirk</tt> wrote the book <tt class="docutils literal">Fall of the Roman Empire</tt></li>
<li>The Author <tt class="docutils literal">James W Kirk</tt> wrote the book &quot;The Rise of the Roman Empire&quot;</li>
</ul>
</div>
<div class="section" id="id5">
<h4><a class="toc-backref" href="#id112">Publisher</a></h4>
<ul class="simple">
<li>The Publisher <tt class="docutils literal">T Books</tt> published the 1973 Edition of the Book <tt class="docutils literal">Fall of the Roman Empire</tt></li>
<li>The Publisher <tt class="docutils literal">T Books</tt> has published the 1967 Edition of the Book <tt class="docutils literal">Wizard of Oz</tt></li>
<li>The Publisher is names <tt class="docutils literal">T Books</tt></li>
</ul>
</div>
<div class="section" id="user">
<h4><a class="toc-backref" href="#id113">User</a></h4>
<ul class="simple">
<li>The User <tt class="docutils literal">Peter Griffin</tt> loaned the Book <tt class="docutils literal">Fall of the Roman Empire</tt> on the 1st of June 1986.</li>
<li>The User <tt class="docutils literal">Peter Griffin</tt> has to return the Book <tt class="docutils literal">Fall of the Roman Empire</tt> on the 15th of June 1986.</li>
<li>A User is named <tt class="docutils literal">Peter Griffin</tt></li>
</ul>
<p>Awesome we have a lot of facts to model around. Let's try to organize them in documents.</p>
</div>
</div>
<div class="section" id="document-representation">
<h3><a class="toc-backref" href="#id114">Document Representation</a></h3>
<p>We've identified 4 different entities that we can potentially model as documents. Let's start by roughly sketch them out.</p>
<p>Let's consider the <tt class="docutils literal">User</tt> entity described above. We know the user has a <tt class="docutils literal">name</tt> and can <tt class="docutils literal">loan</tt> books for a defined period of time. Let's model the data and see how we can interact with the model.</p>
<div class="section" id="user-document">
<h4><a class="toc-backref" href="#id115">User Document</a></h4>
<pre class="code javascript literal-block">
<span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Peter Griffin&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;loaned_books&quot;</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">{</span>
          <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">1</span>
        <span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;Fall of the Roman Empire&quot;</span>
        <span class="p">,</span> <span class="s2">&quot;loaned_on&quot;</span><span class="o">:</span> <span class="s2">&quot;1st of June 1986&quot;</span>
        <span class="p">,</span> <span class="s2">&quot;due_on&quot;</span><span class="o">:</span> <span class="s2">&quot;15th of June 1986&quot;</span>
      <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre>
<p>We added an embedded array of documents called <tt class="docutils literal">loaned_books</tt> that contain documents representing each loaned book &quot;Peter Griffin&quot; has checked out of the library. In this case it's the 1973 edition of the &quot;Fall of the Roman Empire&quot; <tt class="docutils literal">Book</tt>. What kind of operations would be performed on this document. For the <tt class="docutils literal">User</tt> have decided to embed <tt class="docutils literal">loaned</tt> books as an embedded array for each of retrieval and since the amount of books on loan is not likely to be very big for a given <tt class="docutils literal">User</tt>.</p>
<ol class="arabic simple">
<li>Add a new loan to the user document</li>
</ol>
<pre class="code javascript literal-block">
<span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
    <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span>
  <span class="p">,</span> <span class="p">{</span>
      <span class="nx">$push</span><span class="o">:</span> <span class="p">{</span><span class="nx">loaned_books</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span>
        <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Wizard of Oz&quot;</span>
        <span class="p">,</span> <span class="nx">loaned_on</span><span class="o">:</span> <span class="nx">start_date</span>
        <span class="p">,</span> <span class="nx">due_on</span><span class="o">:</span> <span class="nx">due_date</span>
      <span class="p">}}</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span><span class="p">})</span>
</pre>
<ol class="arabic simple" start="2">
<li>Remove a book from the user and return it to the library</li>
</ol>
<pre class="code javascript literal-block">
<span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
    <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span>
  <span class="p">,</span> <span class="p">{</span>
      <span class="nx">$pop</span><span class="o">:</span> <span class="p">{</span><span class="nx">loaned_books</span><span class="o">:</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span><span class="mi">2</span><span class="p">}}</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span><span class="p">})</span>
</pre>
<ol class="arabic simple" start="3">
<li>Extend a loan period (change the due date)</li>
</ol>
<pre class="code javascript literal-block">
<span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
    <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;loaned_on.id&quot;</span><span class="o">:</span> <span class="mi">2</span><span class="p">}</span>
  <span class="p">,</span> <span class="p">{</span>
      <span class="nx">$set</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;loaned_on.$.due_on&quot;</span><span class="o">:</span> <span class="nx">new_due_date</span>
      <span class="p">}</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span><span class="p">})</span>
</pre>
<p>Let's look at a possible Author document.</p>
</div>
<div class="section" id="author-document">
<h4><a class="toc-backref" href="#id116">Author Document</a></h4>
<pre class="code javascript literal-block">
<span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;James W Kirk&quot;</span>
<span class="p">}</span>
</pre>
<p>As you can see we don't include an array of authored <tt class="docutils literal">Book</tt> id's because we will be including the array of authors in the <tt class="docutils literal">Book</tt> document so we can easily browse books by author. This is similar to the traditional <tt class="docutils literal">1:N</tt> relational database relationship.</p>
<p>Similarly a publisher is represented as a separate document.</p>
</div>
<div class="section" id="publisher-document">
<h4><a class="toc-backref" href="#id117">Publisher Document</a></h4>
<pre class="code javascript literal-block">
<span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;T Books&quot;</span>
<span class="p">}</span>
</pre>
<p>As you can see we don't include an array of published <tt class="docutils literal">Book</tt> id's because we will be including the <tt class="docutils literal">publisher_id</tt> in the <tt class="docutils literal">Book</tt> document so we can easily browse books by publisher. This is similar to the traditional <tt class="docutils literal">1:N</tt> relational database relationship.</p>
<p>Let's Have a look at the central concept in our library, namely the <tt class="docutils literal">Book</tt>. Let's take a look at the document.</p>
</div>
<div class="section" id="book-document">
<h4><a class="toc-backref" href="#id118">Book Document</a></h4>
<pre class="code javascript literal-block">
<span class="p">{</span>
  <span class="c1">// Individual Edition id
</span>    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;Fall of the Roman Empire&quot;</span>

  <span class="c1">// Shared id for all &quot;Fall of the Roman Empire&quot; books
</span>  <span class="p">,</span> <span class="s2">&quot;origin_id&quot;</span><span class="o">:</span> <span class="mi">1</span>

  <span class="c1">// Information about the publisher
</span>  <span class="p">,</span> <span class="s2">&quot;publisher&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;published&quot;</span><span class="o">:</span> <span class="mi">1973</span>
    <span class="p">,</span> <span class="s2">&quot;edition&quot;</span><span class="o">:</span> <span class="mi">4</span>
    <span class="p">,</span> <span class="s2">&quot;publisher_id&quot;</span><span class="o">:</span> <span class="mi">1</span>
    <span class="p">,</span> <span class="s2">&quot;publisher&quot;</span><span class="o">:</span> <span class="s2">&quot;T Books&quot;</span>
  <span class="p">}</span>

  <span class="c1">// Book Authors
</span>  <span class="p">,</span> <span class="s2">&quot;authors&quot;</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">{</span>
          <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">1</span>
        <span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;James W Kirk&quot;</span>
      <span class="p">}</span>
    <span class="p">]</span>

  <span class="c1">// State of book
</span>  <span class="p">,</span> <span class="nx">loaned_out</span><span class="o">:</span> <span class="kc">true</span>

  <span class="c1">// Books lent out
</span>  <span class="p">,</span> <span class="s2">&quot;loaned_out_to&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;user_id&quot;</span><span class="o">:</span> <span class="mi">1</span>
      <span class="p">,</span> <span class="s2">&quot;loaned_on&quot;</span><span class="o">:</span> <span class="s2">&quot;1st of June 1986&quot;</span>
      <span class="p">,</span> <span class="s2">&quot;due_on&quot;</span><span class="o">:</span> <span class="s2">&quot;15th of June 1986&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>As you can see the schema for the <tt class="docutils literal">Book</tt> is quite a bit more complex than the other concepts in the database. Let's look at the some of the values and what they mean.</p>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="76%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>origin_id</td>
<td>This id is shared by all editions of a specific book</td>
</tr>
<tr><td>publisher</td>
<td>Embedded document with all the publisher information for easy access</td>
</tr>
<tr><td>authors</td>
<td>An array of embedded author documents</td>
</tr>
<tr><td>loaned_out</td>
<td>Embedded document containing information about the user who has borrowed the book</td>
</tr>
</tbody>
</table>
<p>So what kind of operation could we do on this document.</p>
<ol class="arabic simple">
<li>Locate a <tt class="docutils literal">Fall of the Roman Empire</tt> book that is not currently loaned out</li>
</ol>
<pre class="code javascript literal-block">
<span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">).</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span>
    <span class="nx">title</span><span class="o">:</span> <span class="sr">/^Fall of the Roman/</span>
  <span class="p">,</span> <span class="nx">loaned_out</span><span class="o">:</span><span class="kc">false</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span><span class="p">});</span>
</pre>
<ol class="arabic" start="2">
<li><p class="first">Locate all the books for <a href="#id6"><span class="problematic" id="id7">``</span></a>Fall of the Roman Empire currently out for loan.</p>
<div class="system-message" id="id6">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">learn-x-the-hard-way.rst</tt>, line 5739); <em><a href="#id7">backlink</a></em></p>
<p>Inline literal start-string without end-string.</p>
</div>
</li>
</ol>
<pre class="code javascript literal-block">
<span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">).</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span>
    <span class="nx">title</span><span class="o">:</span> <span class="sr">/^Fall of the Roman/</span>
  <span class="p">,</span> <span class="nx">loaned_out</span><span class="o">:</span><span class="kc">false</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span><span class="p">});</span>
</pre>
<ol class="arabic simple" start="3">
<li>Loan one of the <tt class="docutils literal">Fall of the Roman Empire</tt> books out</li>
</ol>
<pre class="code javascript literal-block">
<span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span>
  <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">loaned_out_to</span><span class="o">:</span> <span class="p">{</span><span class="nx">$exists</span><span class="o">:</span> <span class="kc">false</span><span class="p">}</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="nx">$set</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">loaned_out</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">,</span> <span class="nx">loaned_out_to</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">user_id</span><span class="o">:</span> <span class="mi">1</span>
        <span class="p">,</span> <span class="nx">loaned_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span>
        <span class="p">,</span> <span class="nx">due_on</span><span class="o">:</span> <span class="nx">due_date_variable</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span><span class="p">});</span>
</pre>
<p>The first thing to notice is that the <tt class="docutils literal">update selector</tt> contains not only the <tt class="docutils literal">_id</tt> of the <tt class="docutils literal">Book</tt> we are loaning out but also a requirement that the field <tt class="docutils literal">loaned_out</tt> should be false. This way we ensure the update fails if someone else checked out the book before our update got run. If we do correctly find the valid document where <tt class="docutils literal">loaned_out</tt> is still <tt class="docutils literal">false</tt> we set the the <tt class="docutils literal">loaned_out</tt> field to true and update the <tt class="docutils literal">loaned_out_to</tt> field to the user who is borrowing the book.</p>
<ol class="arabic simple" start="4">
<li>Return the <tt class="docutils literal">Fall of the Roman Empire</tt> book to the library</li>
</ol>
<pre class="code javascript literal-block">
<span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="s2">&quot;loaned_out_to.user_id&quot;</span><span class="o">:</span> <span class="mi">1</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="nx">$set</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">loaned_out</span><span class="o">:</span> <span class="kc">false</span>
    <span class="p">,</span> <span class="nx">loaned_out_to</span><span class="o">:</span> <span class="kc">null</span>
  <span class="p">}</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span><span class="p">});</span>
</pre>
<p>This concludes the schema design for our simple library application. In the next chapter we will implement a <tt class="docutils literal">REST</tt> api that allows you to write your frontend code for the library application.</p>
</div>
</div>
</div>
<div class="section" id="exercise-20-a-restful-programming-exercise">
<h2><a class="toc-backref" href="#id119">Exercise 20: A RESTFul Programming exercise</a></h2>
<p>Let's get cracking on the RESTful experience for our application. We are of course going to do this simply and from scratch so we won't be using such fancy things as express but instead keep it real with low level code (makes it easier to keep this exercise up to data aswell as we won't be tied to changes in Express.JS so much).</p>
<p>We are of course ignoring any sort of concept of user security sessions and such trivial real world important features.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">What's a <tt class="docutils literal">REST API</tt> you might ask. <tt class="docutils literal">HTTP</tt> contains several verbs that make up what we call <tt class="docutils literal">CRUD</tt> operations. These verbs are <tt class="docutils literal">GET</tt>, <tt class="docutils literal">POST</tt>, <tt class="docutils literal">PUT</tt> and <tt class="docutils literal">DELETE</tt>. Think off them as basic verbs of modifying a document. So <tt class="docutils literal">GET</tt> would be equivalent to a <tt class="docutils literal">MongoDB find</tt> operation, <tt class="docutils literal">POST</tt> would be an <tt class="docutils literal">insert</tt>, <tt class="docutils literal">PUT</tt> an <tt class="docutils literal">update</tt> and <tt class="docutils literal">DELETE</tt> a remove. Bare with us as we will cover them in more detail as we implement our <tt class="docutils literal">API</tt>.</p>
</div>
<div class="section" id="it-s-alive">
<h3><a class="toc-backref" href="#id120">It's alive</a></h3>
<p>Let's get the code up and running and let's print the most useless but also the most common greeting in all programming tutorial. I present the &quot;Hello World step&quot;.</p>
<p>Fire up the editor, open the file server.js and get cracking.</p>
<div class="highlight"><pre><a name="code--ex20--ex1.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
<a name="code--ex20--ex1.js-pyg.html-2"></a>
<a name="code--ex20--ex1.js-pyg.html-3"></a><span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex1.js-pyg.html-4"></a>  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s2">&quot;hello world!&quot;</span><span class="p">);</span>
<a name="code--ex20--ex1.js-pyg.html-5"></a><span class="p">});</span>
<a name="code--ex20--ex1.js-pyg.html-6"></a>
<a name="code--ex20--ex1.js-pyg.html-7"></a><span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">9090</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex20--ex1.js-pyg.html-8"></a>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;listening on &quot;</span><span class="p">,</span> <span class="mi">9090</span><span class="p">);</span>
<a name="code--ex20--ex1.js-pyg.html-9"></a><span class="p">});</span>
</pre></div><p>The code will fire up an <tt class="docutils literal">HTTP</tt> server and will listen to the <tt class="docutils literal">9090</tt> socket port. Let's validate that the server is up and running. You can boot up the browser and point it to <tt class="docutils literal"><span class="pre">http://localhost:9090</span></tt> and you should see a web page that says <tt class="docutils literal">Hello world!</tt>. We are going to use a tool that comes with unixes called <tt class="docutils literal">curl</tt> going forward for simplicities sake. But any <tt class="docutils literal">url</tt> used with curl can be used in the browser aswell.</p>
<pre class="code console literal-block">
<span class="go">curl http://localhost:9090
hello world!</span>
</pre>
<p>Sweet our website is up and running (not that it does anything yet). Next it's time to connect to mongodb.</p>
</div>
<div class="section" id="we-ve-got-power">
<h3><a class="toc-backref" href="#id121">We've got power</a></h3>
<p>It's time to add some <tt class="docutils literal">MongoDB</tt> to our little app. For simplicities sake we are going to just do a global <tt class="docutils literal">MongoDB</tt> <tt class="docutils literal">NPM</tt> install, later we will package up the code using a proper <tt class="docutils literal">package.json</tt> file. Let's execute the following on the console.</p>
<pre class="code console literal-block">
<span class="go">npm install -g mongodb</span>
</pre>
<p>Let's modify the code slightly so we boot up our HTTP server and also connect to our <tt class="docutils literal">MongoDB</tt> database.</p>
<div class="highlight"><pre><a name="code--ex20--ex2.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span>
<a name="code--ex20--ex2.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex20--ex2.js-pyg.html-3"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex20--ex2.js-pyg.html-4"></a>
<a name="code--ex20--ex2.js-pyg.html-5"></a><span class="kd">var</span> <span class="nx">dbInstance</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<a name="code--ex20--ex2.js-pyg.html-6"></a>
<a name="code--ex20--ex2.js-pyg.html-7"></a><span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex2.js-pyg.html-8"></a>  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s2">&quot;hello world!&quot;</span><span class="p">);</span>
<a name="code--ex20--ex2.js-pyg.html-9"></a><span class="p">});</span>
<a name="code--ex20--ex2.js-pyg.html-10"></a>
<a name="code--ex20--ex2.js-pyg.html-11"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/library&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex2.js-pyg.html-12"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
<a name="code--ex20--ex2.js-pyg.html-13"></a>  <span class="nx">dbInstance</span> <span class="o">=</span> <span class="nx">db</span><span class="p">;</span>
<a name="code--ex20--ex2.js-pyg.html-14"></a>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to mongodb&quot;</span><span class="p">)</span>
<a name="code--ex20--ex2.js-pyg.html-15"></a>
<a name="code--ex20--ex2.js-pyg.html-16"></a>  <span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">9090</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex20--ex2.js-pyg.html-17"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;listening on &quot;</span><span class="p">,</span> <span class="mi">9090</span><span class="p">);</span>
<a name="code--ex20--ex2.js-pyg.html-18"></a>  <span class="p">});</span>
<a name="code--ex20--ex2.js-pyg.html-19"></a><span class="p">});</span>
</pre></div><p>Booting up the application we should see</p>
<pre class="code console literal-block">
<span class="go">node server.js
connected to mongodb
listening on  9090</span>
</pre>
<p>This code ensures we have a live connection before we stat accepting any <tt class="docutils literal">HTTP</tt> requests from users. It's time to get cracking on our <tt class="docutils literal">REST API</tt>. Let's look at what kind of operations we are going to be supporting for our library application.</p>
<table border="1" class="docutils">
<colgroup>
<col width="49%" />
<col width="51%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Method Url</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>POST    /book</td>
<td>Add a new book to the library</td>
</tr>
<tr><td>GET     /book/:id</td>
<td>Get a specific book by id</td>
</tr>
<tr><td>REMOVE  /book/:id</td>
<td>Remove a specific book by id</td>
</tr>
<tr><td>PUT     /book/:id/publisher/:publisher_id</td>
<td>Associate a publisher with this book</td>
</tr>
<tr><td>GET     /book/search?query=?</td>
<td>Search for books by title</td>
</tr>
<tr><td>GET     /author/search?query=?</td>
<td>Search for author</td>
</tr>
<tr><td>GET     /author/:id</td>
<td>Get an author</td>
</tr>
<tr><td>POST    /author</td>
<td>Add a new author</td>
</tr>
<tr><td>DELETE  /author/:id</td>
<td>Remove an existing author</td>
</tr>
<tr><td>PUT     /book/:id/author/:author_id</td>
<td>Associate an author with this book</td>
</tr>
<tr><td>GET     /author/:id/books</td>
<td>Get books by author</td>
</tr>
<tr><td>GET     /publisher/search?query=?</td>
<td>Search for publisher</td>
</tr>
<tr><td>GET     /publisher/:id/books</td>
<td>Get the books by publisher</td>
</tr>
<tr><td>GET     /publisher/:id</td>
<td>Get a publisher</td>
</tr>
<tr><td>POST    /publisher</td>
<td>Add a new publisher</td>
</tr>
<tr><td>DELETE  /publisher/:id</td>
<td>Remove an existing publisher</td>
</tr>
<tr><td>POST    /user</td>
<td>Add a user to the library</td>
</tr>
<tr><td>GET     /user/:id</td>
<td>Get a user off the library</td>
</tr>
<tr><td>REMOVE  /user/:id</td>
<td>Remove a user from the library</td>
</tr>
<tr><td>GET     /user/:id/loans</td>
<td>Get all the books loaned by a specific user</td>
</tr>
<tr><td>POST    /user/:id/loan/:book_id</td>
<td>Borrow a book</td>
</tr>
<tr><td>DELETE  /user/:id/loan/:book_id</td>
<td>Return a book</td>
</tr>
<tr><td>PUT     /user/:id/loan/:book_id</td>
<td>Extend a loan period / modify a loan period</td>
</tr>
<tr><td>GET     /loan/overdue</td>
<td>Get a list of all overdue books</td>
</tr>
<tr><td>GET     /loan/overdue/:days</td>
<td>Get a list of all overdue books in ?days days</td>
</tr>
</tbody>
</table>
<p>Let's get cracking on adding the initial book API support. The first step is to write a simple router for our application. Let's write it to support the initial book URL's. Fire up the editor and let's get cracking.</p>
<div class="highlight"><pre><a name="code--ex20--ex3.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span>
<a name="code--ex20--ex3.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex20--ex3.js-pyg.html-3"></a>  <span class="p">,</span> <span class="nx">parse</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">).</span><span class="nx">parse</span>
<a name="code--ex20--ex3.js-pyg.html-4"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex20--ex3.js-pyg.html-5"></a>
<a name="code--ex20--ex3.js-pyg.html-6"></a><span class="kd">var</span> <span class="nx">dbInstance</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<a name="code--ex20--ex3.js-pyg.html-7"></a><span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-8"></a>  <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-9"></a>    <span class="nx">get</span><span class="o">:</span> <span class="p">[],</span> <span class="nx">post</span><span class="o">:</span> <span class="p">[],</span> <span class="k">delete</span><span class="o">:</span> <span class="p">[],</span> <span class="nx">put</span><span class="o">:</span> <span class="p">[]</span>
<a name="code--ex20--ex3.js-pyg.html-10"></a>  <span class="p">},</span>
<a name="code--ex20--ex3.js-pyg.html-11"></a>
<a name="code--ex20--ex3.js-pyg.html-12"></a>  <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-13"></a>    <span class="k">this</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">routes</span><span class="p">.</span><span class="nx">get</span><span class="p">,</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-14"></a>  <span class="p">},</span>
<a name="code--ex20--ex3.js-pyg.html-15"></a>
<a name="code--ex20--ex3.js-pyg.html-16"></a>  <span class="nx">post</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-17"></a>    <span class="k">this</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">routes</span><span class="p">.</span><span class="nx">post</span><span class="p">,</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-18"></a>  <span class="p">},</span>
<a name="code--ex20--ex3.js-pyg.html-19"></a>
<a name="code--ex20--ex3.js-pyg.html-20"></a>  <span class="nx">put</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-21"></a>    <span class="k">this</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">routes</span><span class="p">.</span><span class="nx">put</span><span class="p">,</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-22"></a>  <span class="p">},</span>
<a name="code--ex20--ex3.js-pyg.html-23"></a>
<a name="code--ex20--ex3.js-pyg.html-24"></a>  <span class="k">delete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-25"></a>    <span class="k">this</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">routes</span><span class="p">.</span><span class="k">delete</span><span class="p">,</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-26"></a>  <span class="p">},</span>
<a name="code--ex20--ex3.js-pyg.html-27"></a>
<a name="code--ex20--ex3.js-pyg.html-28"></a>  <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">routes</span><span class="p">,</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-29"></a>    <span class="c1">// Rewrite the route as regular expression</span>
<a name="code--ex20--ex3.js-pyg.html-30"></a>    <span class="kd">var</span> <span class="nx">urlParts</span> <span class="o">=</span> <span class="nx">route</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\//</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-31"></a>    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--ex20--ex3.js-pyg.html-32"></a>    <span class="kd">var</span> <span class="nx">regexp</span> <span class="o">=</span> <span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="nx">urlParts</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">part</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-33"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">part</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-34"></a>        <span class="nx">params</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">part</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<a name="code--ex20--ex3.js-pyg.html-35"></a>        <span class="k">return</span> <span class="s2">&quot;([0-9|a-z|A-Z|_]+)&quot;</span><span class="p">;</span>
<a name="code--ex20--ex3.js-pyg.html-36"></a>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-37"></a>        <span class="k">return</span> <span class="nx">part</span><span class="p">;</span>
<a name="code--ex20--ex3.js-pyg.html-38"></a>      <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-39"></a>    <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span><span class="p">;</span>
<a name="code--ex20--ex3.js-pyg.html-40"></a>    <span class="c1">// Final object</span>
<a name="code--ex20--ex3.js-pyg.html-41"></a>    <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="p">{</span><span class="nx">route</span><span class="o">:</span> <span class="p">{</span><span class="nx">regexp</span><span class="o">:</span> <span class="nx">regexp</span><span class="p">,</span> <span class="nx">params</span><span class="o">:</span> <span class="nx">params</span><span class="p">},</span> <span class="nx">fn</span><span class="o">:</span><span class="nx">fn</span><span class="p">};</span>
<a name="code--ex20--ex3.js-pyg.html-42"></a>    <span class="c1">// If we have no params we put it at the start</span>
<a name="code--ex20--ex3.js-pyg.html-43"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-44"></a>      <span class="nx">routes</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span>
<a name="code--ex20--ex3.js-pyg.html-45"></a>      <span class="c1">// routes.push(object);</span>
<a name="code--ex20--ex3.js-pyg.html-46"></a>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-47"></a>      <span class="nx">routes</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-48"></a>    <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-49"></a>  <span class="p">},</span>
<a name="code--ex20--ex3.js-pyg.html-50"></a>
<a name="code--ex20--ex3.js-pyg.html-51"></a>  <span class="nx">route</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-52"></a>    <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">;</span>
<a name="code--ex20--ex3.js-pyg.html-53"></a>    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-54"></a>    <span class="kd">var</span> <span class="nx">routes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">routes</span><span class="p">[</span><span class="nx">method</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()]</span>
<a name="code--ex20--ex3.js-pyg.html-55"></a>    <span class="c1">// Holds the route we match</span>
<a name="code--ex20--ex3.js-pyg.html-56"></a>    <span class="kd">var</span> <span class="nx">matching</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<a name="code--ex20--ex3.js-pyg.html-57"></a>    <span class="kd">var</span> <span class="nx">regexpMatch</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<a name="code--ex20--ex3.js-pyg.html-58"></a>
<a name="code--ex20--ex3.js-pyg.html-59"></a>    <span class="c1">// Locate the matching function</span>
<a name="code--ex20--ex3.js-pyg.html-60"></a>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">routes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-61"></a>      <span class="nx">regexpMatch</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">routes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">route</span><span class="p">.</span><span class="nx">regexp</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-62"></a>
<a name="code--ex20--ex3.js-pyg.html-63"></a>      <span class="c1">// We have a match</span>
<a name="code--ex20--ex3.js-pyg.html-64"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">regexpMatch</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-65"></a>        <span class="nx">matching</span> <span class="o">=</span> <span class="nx">routes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<a name="code--ex20--ex3.js-pyg.html-66"></a>        <span class="k">break</span><span class="p">;</span>
<a name="code--ex20--ex3.js-pyg.html-67"></a>      <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-68"></a>    <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-69"></a>
<a name="code--ex20--ex3.js-pyg.html-70"></a>    <span class="c1">// No route found just write to browser</span>
<a name="code--ex20--ex3.js-pyg.html-71"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">matching</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;no route found&#39;</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-72"></a>
<a name="code--ex20--ex3.js-pyg.html-73"></a>    <span class="c1">// Build params result</span>
<a name="code--ex20--ex3.js-pyg.html-74"></a>    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{};</span>
<a name="code--ex20--ex3.js-pyg.html-75"></a>    <span class="c1">// For each param let&#39;s setup the result</span>
<a name="code--ex20--ex3.js-pyg.html-76"></a>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">matching</span><span class="p">.</span><span class="nx">route</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-77"></a>      <span class="nx">params</span><span class="p">[</span><span class="nx">matching</span><span class="p">.</span><span class="nx">route</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">regexpMatch</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<a name="code--ex20--ex3.js-pyg.html-78"></a>    <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-79"></a>
<a name="code--ex20--ex3.js-pyg.html-80"></a>    <span class="c1">// Add to the request</span>
<a name="code--ex20--ex3.js-pyg.html-81"></a>    <span class="nx">req</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="nx">params</span><span class="p">;</span>
<a name="code--ex20--ex3.js-pyg.html-82"></a>
<a name="code--ex20--ex3.js-pyg.html-83"></a>    <span class="c1">// Let&#39;s execute the function</span>
<a name="code--ex20--ex3.js-pyg.html-84"></a>    <span class="nx">matching</span><span class="p">.</span><span class="nx">fn</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-85"></a>  <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-86"></a><span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-87"></a>
<a name="code--ex20--ex3.js-pyg.html-88"></a><span class="c1">// Methods</span>
<a name="code--ex20--ex3.js-pyg.html-89"></a><span class="kd">var</span> <span class="nx">createBook</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;createBook&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-90"></a><span class="kd">var</span> <span class="nx">getBook</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;getBook&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-91"></a><span class="kd">var</span> <span class="nx">deleteBook</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;deleteBook&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-92"></a><span class="kd">var</span> <span class="nx">searchByBook</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;searchByBook&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-93"></a><span class="kd">var</span> <span class="nx">searchByAuthor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;searchByAuthor&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-94"></a><span class="kd">var</span> <span class="nx">getBooksByAuthor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;getBooksByAuthor&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-95"></a><span class="kd">var</span> <span class="nx">searchByPublisher</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;searchByPublisher&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-96"></a><span class="kd">var</span> <span class="nx">getBooksByPublisher</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;getBooksByPublisher&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-97"></a><span class="kd">var</span> <span class="nx">getLoansByUser</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;getLoansByUser&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-98"></a><span class="kd">var</span> <span class="nx">borrowABook</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;borrowABook&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-99"></a><span class="kd">var</span> <span class="nx">returnAABook</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;returnAABook&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-100"></a><span class="kd">var</span> <span class="nx">modifyLoan</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;modifyLoan&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-101"></a><span class="kd">var</span> <span class="nx">overdueLoans</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;overdueLoans&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-102"></a><span class="kd">var</span> <span class="nx">overdueLoansByDays</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;overdueLoansByDays&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-103"></a><span class="kd">var</span> <span class="nx">getAuthor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;getAuthor&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-104"></a><span class="kd">var</span> <span class="nx">createAuthor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;createAuthor&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-105"></a><span class="kd">var</span> <span class="nx">deleteAuthor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;deleteAuthor&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-106"></a><span class="kd">var</span> <span class="nx">getPublisher</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;getPublisher&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-107"></a><span class="kd">var</span> <span class="nx">createPublisher</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;createPublisher&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-108"></a><span class="kd">var</span> <span class="nx">deletePublisher</span>  <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;deletePublisher&#39;</span><span class="p">);</span> <span class="p">}</span>
<a name="code--ex20--ex3.js-pyg.html-109"></a>
<a name="code--ex20--ex3.js-pyg.html-110"></a><span class="c1">// Routes for the book</span>
<a name="code--ex20--ex3.js-pyg.html-111"></a><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/book&quot;</span><span class="p">,</span> <span class="nx">createBook</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-112"></a><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/book/:id&quot;</span><span class="p">,</span> <span class="nx">getBook</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-113"></a><span class="nx">router</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s2">&quot;/book/:id&quot;</span><span class="p">,</span> <span class="nx">deleteBook</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-114"></a><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/book/search&quot;</span><span class="p">,</span> <span class="nx">searchByBook</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-115"></a>
<a name="code--ex20--ex3.js-pyg.html-116"></a><span class="c1">// Routes for the author</span>
<a name="code--ex20--ex3.js-pyg.html-117"></a><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/author/search&quot;</span><span class="p">,</span> <span class="nx">searchByAuthor</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-118"></a><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/author/:id/books&quot;</span><span class="p">,</span> <span class="nx">getBooksByAuthor</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-119"></a><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/author/:id&quot;</span><span class="p">,</span> <span class="nx">getAuthor</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-120"></a><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/author&quot;</span><span class="p">,</span> <span class="nx">createAuthor</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-121"></a><span class="nx">router</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s2">&quot;/author/:id&quot;</span><span class="p">,</span> <span class="nx">deleteAuthor</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-122"></a>
<a name="code--ex20--ex3.js-pyg.html-123"></a><span class="c1">// Routes for the publisher</span>
<a name="code--ex20--ex3.js-pyg.html-124"></a><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/publisher/search&quot;</span><span class="p">,</span> <span class="nx">searchByPublisher</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-125"></a><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/publisher/:id/books&quot;</span><span class="p">,</span> <span class="nx">getBooksByPublisher</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-126"></a><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/publisher/:id&quot;</span><span class="p">,</span> <span class="nx">getPublisher</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-127"></a><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/publisher&quot;</span><span class="p">,</span> <span class="nx">createPublisher</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-128"></a><span class="nx">router</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s2">&quot;/publisher/:id&quot;</span><span class="p">,</span> <span class="nx">deletePublisher</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-129"></a>
<a name="code--ex20--ex3.js-pyg.html-130"></a><span class="c1">// Routes for the user</span>
<a name="code--ex20--ex3.js-pyg.html-131"></a><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/user/:id/loans&quot;</span><span class="p">,</span> <span class="nx">getLoansByUser</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-132"></a><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/user/:id/loan&quot;</span><span class="p">,</span> <span class="nx">borrowABook</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-133"></a><span class="nx">router</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s2">&quot;/user/:id/loan&quot;</span><span class="p">,</span> <span class="nx">returnAABook</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-134"></a><span class="nx">router</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">&quot;/user/:id/loan&quot;</span><span class="p">,</span> <span class="nx">modifyLoan</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-135"></a>
<a name="code--ex20--ex3.js-pyg.html-136"></a><span class="c1">// Routes for handling loans</span>
<a name="code--ex20--ex3.js-pyg.html-137"></a><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/loan/overdue&quot;</span><span class="p">,</span> <span class="nx">overdueLoans</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-138"></a><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/loan/overdue/:days&quot;</span><span class="p">,</span> <span class="nx">overdueLoansByDays</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-139"></a>
<a name="code--ex20--ex3.js-pyg.html-140"></a><span class="c1">// Start a server instance</span>
<a name="code--ex20--ex3.js-pyg.html-141"></a><span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-142"></a>  <span class="nx">router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-143"></a><span class="p">});</span>
<a name="code--ex20--ex3.js-pyg.html-144"></a>
<a name="code--ex20--ex3.js-pyg.html-145"></a><span class="c1">// Connect to MongoDB</span>
<a name="code--ex20--ex3.js-pyg.html-146"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/library&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-147"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
<a name="code--ex20--ex3.js-pyg.html-148"></a>  <span class="nx">dbInstance</span> <span class="o">=</span> <span class="nx">db</span><span class="p">;</span>
<a name="code--ex20--ex3.js-pyg.html-149"></a>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to mongodb&quot;</span><span class="p">)</span>
<a name="code--ex20--ex3.js-pyg.html-150"></a>
<a name="code--ex20--ex3.js-pyg.html-151"></a>  <span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">9090</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex20--ex3.js-pyg.html-152"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;listening on &quot;</span><span class="p">,</span> <span class="mi">9090</span><span class="p">);</span>
<a name="code--ex20--ex3.js-pyg.html-153"></a>  <span class="p">});</span>
<a name="code--ex20--ex3.js-pyg.html-154"></a><span class="p">});</span>
</pre></div><p>So what's the point of the router. It simplifies our application by letting us use a string to match a <tt class="docutils literal">URL</tt> pattern and <tt class="docutils literal">route</tt> the request to the right function. The magic is in the <tt class="docutils literal">compile</tt> function. What the function does is to rewrite a string like <tt class="docutils literal"><span class="pre">/book/:id</span></tt> to a regular expression that matches on URL's like <tt class="docutils literal">/book/1</tt>. After the regular expression is created it's stored with the available parameters. in an object looking like this.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
  <span class="nx">route</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">regexp</span><span class="o">:</span> <span class="s2">&quot;/book/([0-9|a-z|A-Z|_]+)&quot;</span>
    <span class="p">,</span> <span class="nx">params</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
  <span class="p">}</span>
  <span class="p">,</span><span class="nx">fn</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span><span class="p">}</span>
<span class="p">}</span>
</pre>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">Notice if there is no <tt class="docutils literal">params</tt> for a <tt class="docutils literal">route</tt> we add it to the start of the list of routes. This is because we want to test the non parametrized <tt class="docutils literal">routes</tt> first as <tt class="docutils literal">routes</tt> that contain parameters could match fixed routes. That's to say <tt class="docutils literal"><span class="pre">/book/([0-9|a-z|A-Z|_]+</span></tt> will match on <tt class="docutils literal">/book/1</tt> as well as <tt class="docutils literal">/book/search</tt>. By putting <tt class="docutils literal">/book/search</tt> first we ensure we can match on specific version before falling back to the <tt class="docutils literal"><span class="pre">/book/([0-9|a-z|A-Z|_]+</span></tt> match.</p>
</div>
<p>Each time a new HTTP request happens the incoming <tt class="docutils literal">URL</tt> is decoded using the <tt class="docutils literal">route</tt> method and if it matches a registered <tt class="docutils literal">route</tt> any <tt class="docutils literal">params</tt> are extracted and added to the <tt class="docutils literal">request</tt> object under the <tt class="docutils literal">params</tt> field. So in other words if we register the following method.</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">getBook</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">'getBook'</span><span class="p">);</span> <span class="p">}</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/book/:id&quot;</span><span class="p">,</span> <span class="nx">getBook</span><span class="p">);</span>
</pre>
<p>The method <tt class="docutils literal">getBook</tt> will receive a <tt class="docutils literal">request</tt> object that will contain the <tt class="docutils literal">params</tt> object containing <tt class="docutils literal">id</tt> parameter. Let's say the we fetch <tt class="docutils literal"><span class="pre">http://localhost:9090/book/1</span></tt>. How can we get to the <tt class="docutils literal">id</tt> variable?.</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">getBook</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">'getBook'</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/book/:id&quot;</span><span class="p">,</span> <span class="nx">getBook</span><span class="p">);</span>
</pre>
<p>As you can see we have set up all the routes we mentioned above. So let's get started implementing them. Let's start with adding the author and publisher as books are depended on these entities.</p>
<div class="highlight"><pre><a name="code--ex20--ex4.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">writeError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex4.js-pyg.html-2"></a>  <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;content-type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>
<a name="code--ex20--ex4.js-pyg.html-3"></a>  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
<a name="code--ex20--ex4.js-pyg.html-4"></a><span class="p">}</span>
<a name="code--ex20--ex4.js-pyg.html-5"></a>
<a name="code--ex20--ex4.js-pyg.html-6"></a><span class="kd">var</span> <span class="nx">postJSONHelper</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex4.js-pyg.html-7"></a>  <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<a name="code--ex20--ex4.js-pyg.html-8"></a>
<a name="code--ex20--ex4.js-pyg.html-9"></a>  <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex4.js-pyg.html-10"></a>    <span class="nx">data</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">;</span>
<a name="code--ex20--ex4.js-pyg.html-11"></a>  <span class="p">})</span>
<a name="code--ex20--ex4.js-pyg.html-12"></a>
<a name="code--ex20--ex4.js-pyg.html-13"></a>  <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex20--ex4.js-pyg.html-14"></a>    <span class="k">try</span> <span class="p">{</span>
<a name="code--ex20--ex4.js-pyg.html-15"></a>      <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<a name="code--ex20--ex4.js-pyg.html-16"></a>      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
<a name="code--ex20--ex4.js-pyg.html-17"></a>    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex4.js-pyg.html-18"></a>      <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--ex20--ex4.js-pyg.html-19"></a>    <span class="p">}</span>
<a name="code--ex20--ex4.js-pyg.html-20"></a>  <span class="p">})</span>
<a name="code--ex20--ex4.js-pyg.html-21"></a><span class="p">}</span>
<a name="code--ex20--ex4.js-pyg.html-22"></a>
<a name="code--ex20--ex4.js-pyg.html-23"></a><span class="c1">// Methods for the author</span>
<a name="code--ex20--ex4.js-pyg.html-24"></a><span class="c1">// POST /author</span>
<a name="code--ex20--ex4.js-pyg.html-25"></a><span class="kd">var</span> <span class="nx">createAuthor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex4.js-pyg.html-26"></a>  <span class="nx">postJSONHelper</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex4.js-pyg.html-27"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<a name="code--ex20--ex4.js-pyg.html-28"></a>      <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="mi">406</span><span class="p">,</span> <span class="s1">&#39;Illegal JSON&#39;</span><span class="p">);</span>
<a name="code--ex20--ex4.js-pyg.html-29"></a>
<a name="code--ex20--ex4.js-pyg.html-30"></a>    <span class="c1">// Insert the user</span>
<a name="code--ex20--ex4.js-pyg.html-31"></a>    <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;authors&#39;</span><span class="p">).</span><span class="nx">insert</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex4.js-pyg.html-32"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<a name="code--ex20--ex4.js-pyg.html-33"></a>        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;Failed to insert document&#39;</span><span class="p">);</span>
<a name="code--ex20--ex4.js-pyg.html-34"></a>
<a name="code--ex20--ex4.js-pyg.html-35"></a>      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
<a name="code--ex20--ex4.js-pyg.html-36"></a>    <span class="p">});</span>
<a name="code--ex20--ex4.js-pyg.html-37"></a>  <span class="p">});</span>
<a name="code--ex20--ex4.js-pyg.html-38"></a><span class="p">}</span>
<a name="code--ex20--ex4.js-pyg.html-39"></a>
<a name="code--ex20--ex4.js-pyg.html-40"></a><span class="c1">// GET /author/:id</span>
<a name="code--ex20--ex4.js-pyg.html-41"></a><span class="kd">var</span> <span class="nx">getAuthor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex4.js-pyg.html-42"></a>  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;authors&#39;</span><span class="p">)</span>
<a name="code--ex20--ex4.js-pyg.html-43"></a>    <span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex4.js-pyg.html-44"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="nx">doc</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
<a name="code--ex20--ex4.js-pyg.html-45"></a>        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
<a name="code--ex20--ex4.js-pyg.html-46"></a>          <span class="p">,</span> <span class="mi">404</span>
<a name="code--ex20--ex4.js-pyg.html-47"></a>          <span class="p">,</span> <span class="s1">&#39;Failed to retrieve document from database for id &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<a name="code--ex20--ex4.js-pyg.html-48"></a>
<a name="code--ex20--ex4.js-pyg.html-49"></a>      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">doc</span><span class="p">));</span>
<a name="code--ex20--ex4.js-pyg.html-50"></a>  <span class="p">});</span>
<a name="code--ex20--ex4.js-pyg.html-51"></a><span class="p">}</span>
<a name="code--ex20--ex4.js-pyg.html-52"></a>
<a name="code--ex20--ex4.js-pyg.html-53"></a><span class="c1">// DELETE /author/:id</span>
<a name="code--ex20--ex4.js-pyg.html-54"></a><span class="kd">var</span> <span class="nx">deleteAuthor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex4.js-pyg.html-55"></a>  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;authors&#39;</span><span class="p">)</span>
<a name="code--ex20--ex4.js-pyg.html-56"></a>    <span class="p">.</span><span class="nx">remove</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">deleted</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex20--ex4.js-pyg.html-57"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<a name="code--ex20--ex4.js-pyg.html-58"></a>        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
<a name="code--ex20--ex4.js-pyg.html-59"></a>          <span class="p">,</span> <span class="mi">500</span>
<a name="code--ex20--ex4.js-pyg.html-60"></a>          <span class="p">,</span> <span class="s1">&#39;Failed to delete document from database for id &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<a name="code--ex20--ex4.js-pyg.html-61"></a>
<a name="code--ex20--ex4.js-pyg.html-62"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">deleted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--ex20--ex4.js-pyg.html-63"></a>        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
<a name="code--ex20--ex4.js-pyg.html-64"></a>          <span class="p">,</span> <span class="mi">404</span>
<a name="code--ex20--ex4.js-pyg.html-65"></a>          <span class="p">,</span> <span class="s1">&#39;No document with id &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39; found in database&#39;</span><span class="p">);</span>
<a name="code--ex20--ex4.js-pyg.html-66"></a>
<a name="code--ex20--ex4.js-pyg.html-67"></a>      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}));</span>
<a name="code--ex20--ex4.js-pyg.html-68"></a>  <span class="p">});</span>
<a name="code--ex20--ex4.js-pyg.html-69"></a><span class="p">}</span>
</pre></div><p>Let's try out to create a new book, fetch it and remove it. Notice that the <tt class="docutils literal">_id</tt> field will vary for you so make sure to modify the curl commands to use the correct id.</p>
<pre class="code console literal-block">
<span class="go">curl -X POST -d &quot;{\&quot;name\&quot;:\&quot;James Kirk\&quot;}&quot; http://localhost:9090/author
{&quot;name&quot;:&quot;James Kirk&quot;,&quot;_id&quot;:&quot;51921ef8b67cc57333000001&quot;}

curl -X GET http://localhost:9090/author/51921ef8b67cc57333000001
{&quot;name&quot;:&quot;James Kirk&quot;,&quot;_id&quot;:&quot;51921ef8b67cc57333000001&quot;}

curl -X DELETE http://localhost:9090/author/51921ef8b67cc57333000001
{&quot;_id&quot;:&quot;51921ef8b67cc57333000001&quot;}</span>
</pre>
<p>Awesome we now have a couple of CRUD operations that we can use to add an author, fetch an existing author by id and delete an author by id. So let's look at the methods we have added starting with the <tt class="docutils literal">createAuthor</tt> method.</p>
<pre class="code javascript literal-block">
<span class="c1">// Methods for the author
// POST /author
</span><span class="kd">var</span> <span class="nx">createAuthor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">postJSONHelper</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="mi">406</span><span class="p">,</span> <span class="s1">'Illegal JSON'</span><span class="p">);</span>

    <span class="c1">// Insert the user
</span>    <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'authors'</span><span class="p">).</span><span class="nx">insert</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">'Failed to insert document'</span><span class="p">);</span>

      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>Notice the two helper methods called <tt class="docutils literal">postJSONHelper</tt> and <tt class="docutils literal">writeError</tt>. Let's stop a moment and take a look at the code for those two methods.</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">writeError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="p">{</span><span class="s1">'content-type'</span><span class="o">:</span> <span class="s1">'text/plain'</span><span class="p">});</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">postJSONHelper</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

  <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">data</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">;</span>
  <span class="p">})</span>

  <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'end'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>
</pre>
<p>The <tt class="docutils literal">postJSONHelper</tt> method is a simple utility method to deal with <tt class="docutils literal">HTTP</tt> <tt class="docutils literal">POST</tt> events as node.js actually reads in the body of a <tt class="docutils literal">HTTP</tt> <tt class="docutils literal">POST</tt> as a stream meaning we have to read in data an concatenate it until we received the <tt class="docutils literal">end</tt> event. To avoid having to do this in each <tt class="docutils literal">POST</tt> route we make a very simple helper function to do it for us so we can reduce the duplicated code.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">The reason the <tt class="docutils literal">POST</tt> body is a stream is that it could be used to send a big file that you might not want to store in memory in it's entirety. An example could be if you wanted to save a large video file to <tt class="docutils literal">GridFS</tt>. In this case you would want to write the file into <tt class="docutils literal">GridFS</tt> in <tt class="docutils literal">chunks</tt> avoid having to store the entire file in memory while saving it.</p>
</div>
<p>The <tt class="docutils literal">writeError</tt> is a bit different. To understand why we decided to use it we have to understand what a <tt class="docutils literal">HTTP</tt> code is. Have a look at the web page <a class="reference external" href="http://en.wikipedia.org/wiki/List_of_HTTP_status_codes">http://en.wikipedia.org/wiki/List_of_HTTP_status_codes</a>. <tt class="docutils literal">HTTP</tt> codes are numeric values that inform the calling application about the state of the http call. For example if an author does not exist we would use a <tt class="docutils literal">404</tt> status code. Let's take a look at the ones we have used and what they mean.</p>
<table border="1" class="docutils">
<colgroup>
<col width="27%" />
<col width="73%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">CODE</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>404</td>
<td>Not Found</td>
</tr>
<tr><td>406</td>
<td>Not Acceptable</td>
</tr>
<tr><td>500</td>
<td>Internal Server Error</td>
</tr>
</tbody>
</table>
<p>As we can see we are using the <tt class="docutils literal">404</tt> when we cannot find the document identified by the passed in <tt class="docutils literal">id</tt>. We use the <tt class="docutils literal">406</tt> code to signal that the <tt class="docutils literal">JSON</tt> document could not be parsed and <tt class="docutils literal">500</tt> when there is a MongoDB error that is not related to the application logic. The codes lets us tell calling clients that an error has occurred in a more standardized way making it easy for the calling application to reason about the results being returned from our <tt class="docutils literal">REST API</tt>.</p>
<p>Returning to the <tt class="docutils literal">createAuthor</tt> method we see that if we have a successful insert we return the document as JSON to the client with the newly added <tt class="docutils literal">_id</tt> field that contains the unique identifier for this document.</p>
<p>Let's look at the <tt class="docutils literal">getAuthor</tt> method next.</p>
<pre class="code javascript literal-block">
<span class="c1">// GET /author/:id
</span><span class="kd">var</span> <span class="nx">getAuthor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'authors'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="nx">doc</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">404</span>
          <span class="p">,</span> <span class="s1">'Failed to retrieve document from database for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">doc</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>The main thing here is that we take the incoming <tt class="docutils literal">id</tt> field that's returned in the <tt class="docutils literal">param</tt> object by the router and wrap it in an <tt class="docutils literal">ObjectID</tt>. This is because an <tt class="docutils literal">ObjectID</tt> is a 12 byte binary value while the passed in id is a 24 byte hex decimal string representation. By creating a new ObjectID <tt class="docutils literal">new ObjectID(req.params.id)</tt> we let the <tt class="docutils literal">MongoDB</tt> driver parse the hex decimal string and convert it to a proper 12 byte <tt class="docutils literal">ObjectID</tt> matching the ones we have in our documents.</p>
<p>We then use the <tt class="docutils literal">collection.findOne</tt> method to return the document or if none is available a <tt class="docutils literal">404</tt> code response alerting the calling application that we have no such document.</p>
<p>Finally let's have a look at how we allow for removing authors.</p>
<pre class="code javascript literal-block">
<span class="c1">// DELETE /author/:id
</span><span class="kd">var</span> <span class="nx">deleteAuthor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dbInstance</span>
    <span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'authors'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">deleted</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">500</span>
          <span class="p">,</span> <span class="s1">'Failed to delete document from database for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">deleted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">404</span>
          <span class="p">,</span> <span class="s1">'No document with id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">' found in database'</span><span class="p">);</span>

      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}));</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>Just as for <tt class="docutils literal">getAuthor</tt> we convert the <tt class="docutils literal">id</tt> value to a proper <tt class="docutils literal">ObjectID</tt> and then use the <tt class="docutils literal">collection.remove</tt> function to attempt to remove it. If the <tt class="docutils literal">deleted</tt> value is <tt class="docutils literal">1</tt> we know we removed the document and return a JSON object with the <tt class="docutils literal">_id</tt> we just removed. Otherwise we notify the user setting code <tt class="docutils literal">404</tt> that the document does not exist.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">You might have a question. What if the author already has books entered into the system? Won't this leave Book records that don't have an author in the system associated with them ? The answer is yes. This would usually be solved in a relational database by creating foreign key relationship that would make it impossible to delete an <tt class="docutils literal">Author</tt> if he had associated books. In <tt class="docutils literal">MongoDB</tt> this integrity checking is left to the application itself. It's worth to notice however that most applications avoid foreign key relationship for the reason that they make the schema to rigid.</p>
</div>
<p>So let's change the <tt class="docutils literal">deleteAuthor</tt> method to ensure we can only delete <tt class="docutils literal">Authors</tt> that do not have books associated with them yet.</p>
<pre class="code javascript literal-block">
<span class="c1">// DELETE /author/:id
</span><span class="kd">var</span> <span class="nx">deleteAuthor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">count</span><span class="p">(</span><span class="p">{</span><span class="s2">&quot;authors.id&quot;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">500</span>
          <span class="p">,</span> <span class="s1">'Failed to delete document from database for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">406</span>
          <span class="p">,</span> <span class="s1">'Author with '</span>
            <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
            <span class="o">+</span> <span class="s2">&quot; cannot be deleted as it's associated with existing books&quot;</span><span class="p">);</span>

      <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'authors'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">deleted</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">500</span>
              <span class="p">,</span> <span class="s1">'Failed to delete document from database for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

          <span class="k">if</span><span class="p">(</span><span class="nx">deleted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">404</span>
              <span class="p">,</span> <span class="s1">'No document with id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">' found in database'</span><span class="p">);</span>

          <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}));</span>
      <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>The main difference is that we <tt class="docutils literal">count</tt> the number of books that have the author with the passed in <tt class="docutils literal">id</tt>. If the <tt class="docutils literal">count</tt> is larger than <tt class="docutils literal">0</tt> it means we cannot delete the <tt class="docutils literal">Author</tt> as it would break the data integrity.</p>
<p>Next up is the publisher <tt class="docutils literal">CRUD</tt> methods <tt class="docutils literal">createPublisher</tt>, <tt class="docutils literal">getPublisher</tt> and <tt class="docutils literal">deletePublisher</tt>. These methods are very similar to the get authors. Let's start with the <tt class="docutils literal">createPublisher</tt> method.</p>
<pre class="code javascript literal-block">
<span class="c1">// POST /publisher
</span><span class="kd">var</span> <span class="nx">createPublisher</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">postJSONHelper</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="mi">406</span><span class="p">,</span> <span class="s1">'Illegal JSON'</span><span class="p">);</span>

    <span class="c1">// Insert the user
</span>    <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'publishers'</span><span class="p">).</span><span class="nx">insert</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">'Failed to insert document'</span><span class="p">);</span>

      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>The only main difference here is changing the collection we are using to the publisher one. Similarly the <tt class="docutils literal">getPublisher</tt> method looks a lot like the <tt class="docutils literal">getAuthor</tt> method.</p>
<pre class="code javascript literal-block">
<span class="c1">// GET /publisher/:id
</span><span class="kd">var</span> <span class="nx">getPublisher</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'publishers'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="nx">doc</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">404</span>
          <span class="p">,</span> <span class="s1">'Failed to retrieve document from database for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">doc</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>The only main difference being that we are retrieving the documents from the <tt class="docutils literal">publishers</tt> collection not the <tt class="docutils literal">authors</tt> collection. Just as in the <tt class="docutils literal">deleteAuthors</tt> method the <tt class="docutils literal">deletePublisher</tt> method needs to enforce that we are not actually deleting a publisher that has books associated with it.</p>
<pre class="code javascript literal-block">
<span class="c1">// DELETE /publisher/:id
</span><span class="kd">var</span> <span class="nx">deletePublisher</span>  <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">count</span><span class="p">(</span><span class="p">{</span><span class="s2">&quot;publisher_id&quot;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">500</span>
          <span class="p">,</span> <span class="s1">'Failed to delete document from database for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">406</span>
          <span class="p">,</span> <span class="s1">'Publisher with '</span>
            <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
            <span class="o">+</span> <span class="s2">&quot; cannot be deleted as it's associated with existing books&quot;</span><span class="p">);</span>

      <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'publishers'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">deleted</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">500</span>
              <span class="p">,</span> <span class="s1">'Failed to delete document from database for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

          <span class="k">if</span><span class="p">(</span><span class="nx">deleted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">404</span>
              <span class="p">,</span> <span class="s1">'No document with id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">' found in database'</span><span class="p">);</span>

          <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}));</span>
      <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>Let's make sure the methods correctly by testing it from the command line using curl. <tt class="docutils literal">Note</tt> that the id returned will vary on your system so make sure you change <tt class="docutils literal">51921ef8b67cc57333000001</tt> where appropriate to your own id.</p>
<pre class="code console literal-block">
<span class="go">curl -X POST -d &quot;{\&quot;name\&quot;:\&quot;T Books\&quot;}&quot; http://localhost:9090/publisher
{&quot;name&quot;:&quot;T Books&quot;,&quot;_id&quot;:&quot;51921ef8b67cc57333000001&quot;}

curl -X GET http://localhost:9090/publisher/51921ef8b67cc57333000001
{&quot;name&quot;:&quot;T Books&quot;,&quot;_id&quot;:&quot;51921ef8b67cc57333000001&quot;}

curl -X DELETE http://localhost:9090/publisher/51921ef8b67cc57333000001
{&quot;_id&quot;:&quot;51921ef8b67cc57333000001&quot;}</span>
</pre>
<p>Awesome we only have two more sets of CRUD operations to implement, namely the <tt class="docutils literal">User</tt> and <tt class="docutils literal">Book</tt> related <tt class="docutils literal">CRUD</tt> operations before we move on in the next chapter to the more advanced REST API method of managing the books.</p>
<p>Let's do the user ones first. They consist off the <tt class="docutils literal">createUser</tt>, <tt class="docutils literal">getUser</tt> and <tt class="docutils literal">deleteUser</tt> methods and are very similar to the previous <tt class="docutils literal">Author</tt> and <tt class="docutils literal">Publisher</tt> methods. Let's look at them in turn starting with the <tt class="docutils literal">createUser</tt> method.</p>
<pre class="code javascript literal-block">
<span class="c1">// POST /user
</span><span class="kd">var</span> <span class="nx">createUser</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">postJSONHelper</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="mi">406</span><span class="p">,</span> <span class="s1">'Illegal JSON'</span><span class="p">);</span>

    <span class="c1">// Insert the user
</span>    <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">).</span><span class="nx">insert</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">'Failed to insert document'</span><span class="p">);</span>

      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>Just as in <tt class="docutils literal">getAuthor</tt> and <tt class="docutils literal">getPublisher</tt> the <tt class="docutils literal">getUser</tt> method is very simple and just return the document from the collection if it finds it.</p>
<pre class="code javascript literal-block">
<span class="c1">// GET /user/:id
</span><span class="kd">var</span> <span class="nx">getUser</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="nx">doc</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">404</span>
          <span class="p">,</span> <span class="s1">'Failed to retrieve document from database for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">doc</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>The main difference in the <tt class="docutils literal">deleteUser</tt> method vs <tt class="docutils literal">deleteAuthor</tt> or <tt class="docutils literal">deletePublisher</tt> is that we can only remove a user if he has no outstanding books in the system. To ensure that we do a count of books in the library where the book is registered as loaned_out to the user with the <tt class="docutils literal">id</tt> we wish to delete. If there are any books outstanding the <tt class="docutils literal">API</tt> will fail and report that the user still has books out for loan.</p>
<pre class="code javascript literal-block">
<span class="c1">// DELETE /user/:id
</span><span class="kd">var</span> <span class="nx">deleteUser</span>  <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">count</span><span class="p">(</span><span class="p">{</span><span class="s2">&quot;loaned_out_to.user_id&quot;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">500</span>
          <span class="p">,</span> <span class="s1">'Failed to delete document from database for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">406</span>
          <span class="p">,</span> <span class="s1">'User with '</span>
            <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
            <span class="o">+</span> <span class="s2">&quot; cannot be deleted as it's associated with existing books&quot;</span><span class="p">);</span>

      <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">deleted</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">500</span>
              <span class="p">,</span> <span class="s1">'Failed to delete document from database for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

          <span class="k">if</span><span class="p">(</span><span class="nx">deleted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">404</span>
              <span class="p">,</span> <span class="s1">'No document with id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">' found in database'</span><span class="p">);</span>

          <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}));</span>
      <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>As before let's verify that the <tt class="docutils literal">API</tt> work correctly by using <tt class="docutils literal">curl</tt>.</p>
<pre class="code console literal-block">
<span class="go">curl -X POST -d &quot;{\&quot;name\&quot;:\&quot;James Bond\&quot;}&quot; http://localhost:9090/user
{&quot;name&quot;:&quot;James Bond&quot;,&quot;_id&quot;:&quot;51921ef8b67cc57333000001&quot;}

curl -X GET http://localhost:9090/user/51921ef8b67cc57333000001
{&quot;name&quot;:&quot;James Bond&quot;,&quot;_id&quot;:&quot;51921ef8b67cc57333000001&quot;}

curl -X DELETE http://localhost:9090/user/51921ef8b67cc57333000001
{&quot;_id&quot;:&quot;51921ef8b67cc57333000001&quot;}</span>
</pre>
<p>We are nearly done. Let's look at the final <tt class="docutils literal">Book</tt> <tt class="docutils literal">CRUD</tt> operations <tt class="docutils literal">createBook</tt>, <tt class="docutils literal">getBook</tt> and <tt class="docutils literal">deleteBook</tt>. If you've noticed there is a pattern to the CRUD operations and they look very similar with the exception being the <tt class="docutils literal">deleteXXX</tt> methods. Let's take a quick look at the <tt class="docutils literal">createBook</tt> method.</p>
<pre class="code javascript literal-block">
<span class="c1">// POST /book
</span><span class="kd">var</span> <span class="nx">createBook</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">postJSONHelper</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="mi">406</span><span class="p">,</span> <span class="s1">'Illegal JSON'</span><span class="p">);</span>

    <span class="c1">// Insert the user
</span>    <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">).</span><span class="nx">insert</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">'Failed to insert document'</span><span class="p">);</span>

      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>Looks very similar to the previous <tt class="docutils literal">createXXX</tt> methods for <tt class="docutils literal">Author</tt>, <tt class="docutils literal">Publisher</tt> and <tt class="docutils literal">User</tt>. Let's look at the <tt class="docutils literal">getBook</tt> method.</p>
<pre class="code javascript literal-block">
<span class="c1">// GET /book/:id
</span><span class="kd">var</span> <span class="nx">getBook</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="nx">doc</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">404</span>
          <span class="p">,</span> <span class="s1">'Failed to retrieve document from database for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">doc</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>Again very similar to the previous <tt class="docutils literal">getXXX</tt> methods. How about the <tt class="docutils literal">deleteBook</tt> method ?</p>
<pre class="code javascript literal-block">
<span class="c1">// DELETE /book/:id
</span><span class="kd">var</span> <span class="nx">deleteBook</span>  <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">book</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">500</span>
          <span class="p">,</span> <span class="s1">'Failed to delete document from database for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">book</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">406</span>
          <span class="p">,</span> <span class="s1">'Book with '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; was not found&quot;</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">book</span><span class="p">.</span><span class="nx">loaned_out_to</span> <span class="o">&amp;&amp;</span> <span class="nx">book</span><span class="p">.</span><span class="nx">loaned_out_to</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">500</span>
          <span class="p">,</span> <span class="s1">'Book with '</span>
            <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
            <span class="o">+</span> <span class="s2">&quot; was not deleted as copies are currently loaned out&quot;</span><span class="p">);</span>

      <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">deleted</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">500</span>
              <span class="p">,</span> <span class="s1">'Failed to delete document from database for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

          <span class="k">if</span><span class="p">(</span><span class="nx">deleted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">404</span>
              <span class="p">,</span> <span class="s1">'No document with id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">' found in database'</span><span class="p">);</span>

          <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}));</span>
      <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>As we can see the main difference here is that we don't let the book be deleted if there are any copies out for loan. This is ensured by checking the <tt class="docutils literal">loaned_out_to</tt> array on the returned <tt class="docutils literal">Book</tt>. If it's empty we can go ahead and delete the <tt class="docutils literal">Book</tt> as nobody is in possession of it. Notice that we are not checking the <tt class="docutils literal">Authors</tt> or <tt class="docutils literal">Publishers</tt> collections as they do not store any information directly associated with the <tt class="docutils literal">Book</tt> so removing a Book does not cause <tt class="docutils literal">Authors</tt> and <tt class="docutils literal">Pulishers</tt> to link to non-existing books.</p>
<p>Let's verify the correct behavior off the <tt class="docutils literal">API</tt> by using <tt class="docutils literal">Curl</tt> again to test the <tt class="docutils literal">REST</tt> endpoints.</p>
<pre class="code console literal-block">
<span class="go">curl -X POST -d &quot;{\&quot;name\&quot;:\&quot;Wizard of Oz\&quot;}&quot; http://localhost:9090/book
{&quot;name&quot;:&quot;Wizard of Oz&quot;,&quot;_id&quot;:&quot;51921ef8b67cc57333000001&quot;}

curl -X GET http://localhost:9090/book/51921ef8b67cc57333000001
{&quot;name&quot;:&quot;Wizard of Oz&quot;,&quot;_id&quot;:&quot;51921ef8b67cc57333000001&quot;}

curl -X DELETE http://localhost:9090/book/51921ef8b67cc57333000001
{&quot;_id&quot;:&quot;51921ef8b67cc57333000001&quot;}</span>
</pre>
<p>We are now ready to move forward and add the remaining methods for our library API.</p>
<table border="1" class="docutils">
<colgroup>
<col width="49%" />
<col width="51%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Method Url</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>PUT     /book/:id/publisher/:publisher_id</td>
<td>Associate a publisher with this book</td>
</tr>
<tr><td>PUT     /book/:id/author/:author_id</td>
<td>Associate an author with this book</td>
</tr>
<tr><td>GET     /book/search?query=?</td>
<td>Search for books by title</td>
</tr>
<tr><td>GET     /author/search?query=?</td>
<td>Search for author</td>
</tr>
<tr><td>GET     /author/:id/books</td>
<td>Get books by author</td>
</tr>
<tr><td>GET     /publisher/search?query=?</td>
<td>Search for publisher</td>
</tr>
<tr><td>GET     /publisher/:id/books</td>
<td>Get the books by publisher</td>
</tr>
<tr><td>GET     /user/:id/loans</td>
<td>Get all the books loaned by a specific user</td>
</tr>
<tr><td>POST    /user/:id/loan/:book_id</td>
<td>Borrow a book</td>
</tr>
<tr><td>DELETE  /user/:id/loan/:book_id</td>
<td>Return a book</td>
</tr>
<tr><td>PUT     /user/:id/loan/:book_id</td>
<td>Extend a loan period / modify a loan period</td>
</tr>
<tr><td>GET     /loan/overdue</td>
<td>Get a list of all overdue books</td>
</tr>
<tr><td>GET     /loan/overdue/:days</td>
<td>Get a list of all overdue books in ?days days</td>
</tr>
</tbody>
</table>
<p>So let's move on and finish up our API.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">You might have noticed that we are not doing any validation on the documents as in checking if they have the minimum number of expected fields. We will touch on this briefly later but have chosen not to include it yet as it would complicate our example more than necessary.</p>
</div>
</div>
</div>
<div class="section" id="exercise-21-let-s-loan-out-some-books">
<h2><a class="toc-backref" href="#id122">Exercise 21: Let's Loan Out Some Books</a></h2>
<p>In the last Exercise we looked at how to establish the basic <tt class="docutils literal">routing</tt> infrastructure in our application as well as looking at writing the <tt class="docutils literal">CRUD</tt> operations for the <tt class="docutils literal">Author</tt>, <tt class="docutils literal">Publisher</tt>, <tt class="docutils literal">User</tt> and <tt class="docutils literal">Book</tt> entities for our <tt class="docutils literal">REST</tt> <tt class="docutils literal">API</tt>. It's now time to actually add the business functionality to our <tt class="docutils literal">API</tt> that lets a user borrow some books as well as to look for a specific book. Let's look at the remaining <tt class="docutils literal">API</tt> calls.</p>
<table border="1" class="docutils">
<colgroup>
<col width="49%" />
<col width="51%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Method Url</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>PUT     /book/:id/publisher/:publisher_id</td>
<td>Associate a publisher with this book</td>
</tr>
<tr><td>PUT     /book/:id/author/:author_id</td>
<td>Associate an author with this book</td>
</tr>
<tr><td>GET     /author/:id/books</td>
<td>Get books by author</td>
</tr>
<tr><td>GET     /publisher/:id/books</td>
<td>Get the books by publisher</td>
</tr>
<tr><td>GET     /book/search?query=?</td>
<td>Search for books by title</td>
</tr>
<tr><td>GET     /author/search?query=?</td>
<td>Search for author</td>
</tr>
<tr><td>GET     /publisher/search?query=?</td>
<td>Search for publisher</td>
</tr>
<tr><td>GET     /user/:id/loans</td>
<td>Get all the books loaned by a specific user</td>
</tr>
<tr><td>POST    /user/:id/loan/:book_id</td>
<td>Borrow a book</td>
</tr>
<tr><td>DELETE  /user/:id/loan/:book_id</td>
<td>Return a book</td>
</tr>
<tr><td>PUT     /user/:id/loan/:book_id</td>
<td>Extend a loan period / modify a loan period</td>
</tr>
<tr><td>GET     /loan/overdue</td>
<td>Get a list of all overdue books</td>
</tr>
<tr><td>GET     /loan/overdue/:days</td>
<td>Get a list of all overdue books in ?days days</td>
</tr>
</tbody>
</table>
<p>The two first API calls we need to implement is the ability to <tt class="docutils literal">associate</tt> a <tt class="docutils literal">Publisher</tt> or <tt class="docutils literal">Author</tt> to a specific book. Let's take a look at the method <tt class="docutils literal">associatePublisher</tt> first.</p>
<pre class="code javascript literal-block">
<span class="c1">// PUT /book/:id/publisher/:publisher_id
</span><span class="kd">var</span> <span class="nx">associatePublisher</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">book</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">500</span>
          <span class="p">,</span> <span class="s1">'Failed to retrieve book with id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">book</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">406</span>
          <span class="p">,</span> <span class="s1">'Book with '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; was not found&quot;</span><span class="p">);</span>

      <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'publishers'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">publisher_id</span><span class="p">)}</span>
          <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">publisher</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
              <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
                <span class="p">,</span> <span class="mi">500</span>
                <span class="p">,</span> <span class="s1">'Failed to retrieve publisher with id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">publisher_id</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">publisher</span><span class="p">)</span>
              <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
                <span class="p">,</span> <span class="mi">406</span>
                <span class="p">,</span> <span class="s1">'Publisher with '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">publisher_id</span> <span class="o">+</span> <span class="s2">&quot; was not found&quot;</span><span class="p">);</span>

            <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)}</span>
                <span class="p">,</span> <span class="p">{</span>
                  <span class="nx">$set</span><span class="o">:</span> <span class="p">{</span>
                    <span class="s2">&quot;publisher.publisher_id&quot;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">publisher_id</span><span class="p">)</span>
                  <span class="p">}</span>
                <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">updated</span><span class="p">)</span> <span class="p">{</span>

                  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
                    <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
                      <span class="p">,</span> <span class="mi">500</span>
                      <span class="p">,</span> <span class="s1">'Failed to update publisher for book with id '</span>
                        <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

                  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}));</span>
            <span class="p">});</span>
        <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>Notice a couple of things. First off all we verify that both the indicated <tt class="docutils literal">Book</tt> and <tt class="docutils literal">Publisher</tt> exists in the system. Once we established that we update the field <tt class="docutils literal">publisher.publisher_id</tt> to set it with the value of the associated <tt class="docutils literal">Publisher</tt>. Notice that we are not adding the other specifics of the <tt class="docutils literal">Published</tt> edition of the <tt class="docutils literal">Book</tt>. We are assuming this was stored as part of the actual original storing of the <tt class="docutils literal">Book</tt> information. What we are ensuring is that this <tt class="docutils literal">Book</tt> is now correctly associated with a <tt class="docutils literal">Publisher</tt> entity in our system. If the field <tt class="docutils literal">publisher.publisher_id</tt> does not exist it will automatically be created and added to the document by <tt class="docutils literal">MongoDB</tt>. Now let's look at how the <tt class="docutils literal">associateAuthor</tt> method works in comparison considering a book can have <tt class="docutils literal">one</tt> or <tt class="docutils literal">more</tt> authors associated with it.</p>
<pre class="code javascript literal-block">
<span class="c1">// PUT /book/:id/author/:publisher_id
</span><span class="kd">var</span> <span class="nx">associateAuthor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">book</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">500</span>
          <span class="p">,</span> <span class="s1">'Failed to retrieve book with id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">book</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">406</span>
          <span class="p">,</span> <span class="s1">'Book with '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; was not found&quot;</span><span class="p">);</span>

      <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'authors'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">author_id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">author</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">500</span>
              <span class="p">,</span> <span class="s1">'Failed to retrieve publisher with id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">author_id</span><span class="p">);</span>

          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">author</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">406</span>
              <span class="p">,</span> <span class="s1">'Author with '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">author_id</span> <span class="o">+</span> <span class="s2">&quot; was not found&quot;</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">author</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">author_id</span><span class="p">)</span>
            <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">author</span><span class="p">.</span><span class="nx">name</span>
          <span class="p">}</span>

          <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)}</span>
              <span class="p">,</span> <span class="p">{</span><span class="nx">$addToSet</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;authors&quot;</span><span class="o">:</span> <span class="nx">author</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">updated</span><span class="p">)</span> <span class="p">{</span>

              <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
                <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
                  <span class="p">,</span> <span class="mi">500</span>
                  <span class="p">,</span> <span class="s1">'Failed to update publisher for book with id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

              <span class="k">if</span><span class="p">(</span><span class="nx">updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
                  <span class="p">,</span> <span class="mi">500</span>
                  <span class="p">,</span> <span class="s1">'Author already associated with the book with id '</span>
                    <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

              <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}));</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">The <tt class="docutils literal">$addToSet</tt> only adds a value to an array if the value does not already exist. Let's see how we can use this in practice. Remember the meeting. Well let's use <tt class="docutils literal">$addToSet</tt> and attempt to add a duplicate document. Open up your editor and type in.</p>
</div>
<p>It looks very similar to the previous <tt class="docutils literal">associatePublisher</tt> method but with one important difference. As we have an array of <tt class="docutils literal">authors</tt> for a book we want to ensure that we do not have duplicate <tt class="docutils literal">Author</tt> entries. Luckily <tt class="docutils literal">MongoDB</tt> provides an <tt class="docutils literal">update</tt> operated called <tt class="docutils literal">$addToSet</tt>. Let's go look at what the operator does briefly.</p>
<div class="highlight"><pre><a name="code--ex10--ex4.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex10--ex4.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex10--ex4.js-pyg.html-3"></a>
<a name="code--ex10--ex4.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex10--ex4.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex10--ex4.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex10--ex4.js-pyg.html-10"></a>
<a name="code--ex10--ex4.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">meeting</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-12"></a>      <span class="nx">_id</span> <span class="o">:</span> <span class="mi">1</span>
<a name="code--ex10--ex4.js-pyg.html-13"></a>    <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Let&#39;s buy a widget&quot;</span>
<a name="code--ex10--ex4.js-pyg.html-14"></a>    <span class="p">,</span> <span class="nx">description</span><span class="o">:</span> <span class="s2">&quot;We need to buy the ACME widget and need budget approval&quot;</span>
<a name="code--ex10--ex4.js-pyg.html-15"></a>    <span class="p">,</span> <span class="nx">startTime</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
<a name="code--ex10--ex4.js-pyg.html-16"></a>    <span class="p">,</span> <span class="nx">endTime</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
<a name="code--ex10--ex4.js-pyg.html-17"></a>  <span class="p">}</span>
<a name="code--ex10--ex4.js-pyg.html-18"></a>
<a name="code--ex10--ex4.js-pyg.html-19"></a>  <span class="kd">var</span> <span class="nx">users</span> <span class="o">=</span> <span class="p">[</span>
<a name="code--ex10--ex4.js-pyg.html-20"></a>      <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;April&#39;</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;april@inc.com&#39;</span><span class="p">}</span>
<a name="code--ex10--ex4.js-pyg.html-21"></a>    <span class="p">,</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;john@inc.com&#39;</span><span class="p">}</span>
<a name="code--ex10--ex4.js-pyg.html-22"></a>  <span class="p">]</span>
<a name="code--ex10--ex4.js-pyg.html-23"></a>
<a name="code--ex10--ex4.js-pyg.html-24"></a>  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;meetings&#39;</span><span class="p">);</span>
<a name="code--ex10--ex4.js-pyg.html-25"></a>
<a name="code--ex10--ex4.js-pyg.html-26"></a>  <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-27"></a>
<a name="code--ex10--ex4.js-pyg.html-28"></a>    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">meeting</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-29"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-30"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;write concern on collection caught duplicate key error&quot;</span><span class="p">);</span>
<a name="code--ex10--ex4.js-pyg.html-31"></a>      <span class="p">}</span>
<a name="code--ex10--ex4.js-pyg.html-32"></a>
<a name="code--ex10--ex4.js-pyg.html-33"></a>      <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">_id</span> <span class="p">}</span>
<a name="code--ex10--ex4.js-pyg.html-34"></a>        <span class="p">,</span> <span class="p">{</span><span class="nx">$pushAll</span><span class="o">:</span> <span class="p">{</span><span class="nx">participants</span><span class="o">:</span> <span class="nx">users</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">full_result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-35"></a>
<a name="code--ex10--ex4.js-pyg.html-36"></a>          <span class="kd">var</span> <span class="nx">april</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;April&#39;</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;april@inc.com&#39;</span><span class="p">};</span>
<a name="code--ex10--ex4.js-pyg.html-37"></a>
<a name="code--ex10--ex4.js-pyg.html-38"></a>          <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">_id</span><span class="p">}</span>
<a name="code--ex10--ex4.js-pyg.html-39"></a>            <span class="p">,</span> <span class="p">{</span><span class="nx">$addToSet</span><span class="o">:</span> <span class="p">{</span><span class="nx">participants</span><span class="o">:</span> <span class="nx">april</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">full_result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-40"></a>
<a name="code--ex10--ex4.js-pyg.html-41"></a>            <span class="nx">collection</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">meeting</span><span class="p">.</span><span class="nx">_id</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex10--ex4.js-pyg.html-42"></a>
<a name="code--ex10--ex4.js-pyg.html-43"></a>              <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
<a name="code--ex10--ex4.js-pyg.html-44"></a>
<a name="code--ex10--ex4.js-pyg.html-45"></a>              <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex10--ex4.js-pyg.html-46"></a>            <span class="p">});</span>
<a name="code--ex10--ex4.js-pyg.html-47"></a>        <span class="p">});</span>
<a name="code--ex10--ex4.js-pyg.html-48"></a>      <span class="p">});</span>
<a name="code--ex10--ex4.js-pyg.html-49"></a>    <span class="p">});</span>
<a name="code--ex10--ex4.js-pyg.html-50"></a>  <span class="p">});</span>
<a name="code--ex10--ex4.js-pyg.html-51"></a><span class="p">});</span>
</pre></div><p>Your output should look like the following.</p>
<pre class="code console literal-block">
<span class="go">connected to database
{ _id: 1,
  description: 'We need to buy the ACME widget and need budget approval',
  endTime: Wed Jan 23 2013 15:35:03 GMT+0100 (CET),
  participants:
   [ { name: 'April', email: 'april&#64;inc.com' },
     { name: 'John', email: 'john&#64;inc.com' } ],
  startTime: Wed Jan 23 2013 15:35:03 GMT+0100 (CET),
  title: 'Let\'s buy a widget' }</span>
</pre>
<p>As you can see there was no duplicate entries of the user <tt class="docutils literal">April</tt> in the participants field when using <tt class="docutils literal">$addToSet</tt>. But what if we want to modify a document inside an array, not remove it from the array but set a value on it. Luckily there are a couple of ways we can go about doing this.</p>
<p>This is perfect for our method. We create a new embedded document.</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">author</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">author_id</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">author</span><span class="p">.</span><span class="nx">name</span>
<span class="p">}</span>
</pre>
<p>and then perform an update using <tt class="docutils literal">{$addToSet: {&quot;authors&quot;: author}}</tt>. As we read about the <tt class="docutils literal">$addToSet</tt> operator the new <tt class="docutils literal">author</tt> document will only be added to the <tt class="docutils literal">authors</tt> array if it does not already exists thus neatly avoiding duplicated entries.</p>
<p>Now let's test our new methods using <tt class="docutils literal">Curl</tt> from the command line.</p>
<pre class="code console literal-block">
<span class="go">curl -X POST -d &quot;{\&quot;name\&quot;:\&quot;L. Frank Baum\&quot;}&quot; http://localhost:9090/author
{&quot;name&quot;:&quot;L. Frank Baum&quot;,&quot;_id&quot;:&quot;51921ef8b67cc57333000001&quot;}

curl -X POST -d &quot;{\&quot;name\&quot;:\&quot;Penguin Books\&quot;}&quot; http://localhost:9090/publisher
{&quot;name&quot;:&quot;Penguin Books&quot;,&quot;_id&quot;:&quot;51921ef8b67cc57333000002&quot;}

curl -X POST -d &quot;{\&quot;title\&quot;:\&quot;Wizard of Oz\&quot;}&quot; http://localhost:9090/book
{&quot;name&quot;:&quot;Wizard of Oz&quot;,&quot;_id&quot;:&quot;51921ef8b67cc57333000003&quot;}

curl -X POST -d &quot;{\&quot;name\&quot;:\&quot;James Bond\&quot;}&quot; http://localhost:9090/user
{&quot;name&quot;:&quot;James Bond&quot;,&quot;_id&quot;:&quot;51921ef8b67cc57333000004&quot;}

curl -X PUT http://localhost:9090/book/51921ef8b67cc57333000003/publisher
/51921ef8b67cc57333000002
{&quot;name&quot;:&quot;Wizard of Oz&quot;,&quot;_id&quot;:&quot;51921ef8b67cc57333000004&quot;}

curl -X PUT http://localhost:9090/book/51921ef8b67cc57333000003/author
/51921ef8b67cc57333000001
{&quot;name&quot;:&quot;Wizard of Oz&quot;,&quot;_id&quot;:&quot;51921ef8b67cc57333000004&quot;}</span>
</pre>
<p>What if we want to look up books by a <tt class="docutils literal">Publisher</tt> or <tt class="docutils literal">Author</tt>. Now that we have books associated with both a <tt class="docutils literal">Publisher</tt> or <tt class="docutils literal">Author</tt> we can implement the two methods that let us do exactly this, namely <tt class="docutils literal">getBooksByPublisher</tt> and <tt class="docutils literal">getBooksByAuthor</tt>.</p>
<pre class="code javascript literal-block">
<span class="c1">// GET /publisher/:id/books
</span><span class="kd">var</span> <span class="nx">getBooksByPublisher</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'publishers'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">publisher</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">500</span>
          <span class="p">,</span> <span class="s1">'Failed to retrieve publisher with id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">publisher</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">406</span>
          <span class="p">,</span> <span class="s1">'Publisher with '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; was not found&quot;</span><span class="p">);</span>

      <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="p">{</span><span class="s2">&quot;publisher.publisher_id&quot;</span><span class="o">:</span> <span class="nx">publisher</span><span class="p">.</span><span class="nx">_id</span><span class="p">},</span> <span class="p">{</span><span class="nx">loaned_out_to</span><span class="o">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="p">.</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">books</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">500</span>
              <span class="p">,</span> <span class="s1">'Failed to retrieve books for publisher with id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

          <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">books</span><span class="p">));</span>
      <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>As a <tt class="docutils literal">Book</tt> is now associated to a <tt class="docutils literal">Publisher</tt> through the <tt class="docutils literal">publisher.publisher_id</tt> field we can now easily look up all <tt class="docutils literal">Books</tt> for a particular known <tt class="docutils literal">Publisher</tt>. The <tt class="docutils literal">getBooksByAuthor</tt> method perform the same action but for looking up books by a known system <tt class="docutils literal">Author</tt> instead.</p>
<pre class="code javascript literal-block">
<span class="c1">// GET /author/:id/books
</span><span class="kd">var</span> <span class="nx">getBooksByAuthor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'authors'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">author</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">500</span>
          <span class="p">,</span> <span class="s1">'Failed to retrieve author with id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">author</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">406</span>
          <span class="p">,</span> <span class="s1">'Author with '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; was not found&quot;</span><span class="p">);</span>

      <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="p">{</span><span class="s2">&quot;authors.id&quot;</span><span class="o">:</span> <span class="nx">author</span><span class="p">.</span><span class="nx">_id</span><span class="p">},</span> <span class="p">{</span><span class="nx">loaned_out_to</span><span class="o">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="p">.</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">books</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">500</span>
              <span class="p">,</span> <span class="s1">'Failed to retrieve books for author with id '</span>
                <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

          <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">books</span><span class="p">));</span>
      <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>In <tt class="docutils literal">getBooksByAuthor</tt> we look up any book where there is an embedded document in the array off <tt class="docutils literal">authors</tt> that contains the <tt class="docutils literal">id</tt> equivalent to the given <tt class="docutils literal">Author</tt> id. Did you maybe notice the <tt class="docutils literal">{loaned_out_to: 0}</tt> part of the <tt class="docutils literal">find</tt> and wonder what that means. <tt class="docutils literal">{loaned_out_to: 0}</tt> is what's called a <tt class="docutils literal">projection</tt> in <tt class="docutils literal">MongoDB</tt>. Basically it means we are filtering out the field <tt class="docutils literal">loaned_out_to</tt> from the documents returned from the database as this is non-needed information. <tt class="docutils literal">Projection</tt> let's you avoid returning all the document when it's not strictly needed, when you want to reduce the size of the document results sent to your application from the server or there are parts that needs to be filtered out as in this case where the <tt class="docutils literal">loaned_out_to</tt> is an internal state of the <tt class="docutils literal">API</tt>.</p>
<p>Let's try out the new search methods by firing up <tt class="docutils literal">Curl</tt> and retrieving the <tt class="docutils literal">Books</tt> by <tt class="docutils literal">Publisher</tt> and <tt class="docutils literal">Author</tt>.</p>
<pre class="code console literal-block">
<span class="go">curl -X GET http://localhost:9090/publisher/51921ef8b67cc57333000002/books
[{&quot;_id&quot;:&quot;51921ef8b67cc57333000003&quot;,&quot;authors&quot;:[{&quot;id&quot;:&quot;51921ef8b67cc57333000001&quot;
,&quot;name&quot;:&quot;L. Frank Baum&quot;}],&quot;name&quot;:&quot;Wizard of Oz&quot;
,&quot;publisher&quot;:{&quot;publisher_id&quot;:&quot;51921ef8b67cc57333000002&quot;}}]

curl -X GET http://localhost:9090/author/51921ef8b67cc57333000001/books
[{&quot;_id&quot;:&quot;51921ef8b67cc57333000003&quot;,&quot;authors&quot;:[{&quot;id&quot;:&quot;51921ef8b67cc57333000001&quot;
,&quot;name&quot;:&quot;L. Frank Baum&quot;}],&quot;name&quot;:&quot;Wizard of Oz&quot;
,&quot;publisher&quot;:{&quot;publisher_id&quot;:&quot;51921ef8b67cc57333000002&quot;}}]</span>
</pre>
<p>We need to provide a couple of ways for the users of our <tt class="docutils literal">API</tt> to search for <tt class="docutils literal">Books</tt>. These are embodied in the methods <tt class="docutils literal">searchByAuthor</tt>, <tt class="docutils literal">searchByPublisher</tt> and <tt class="docutils literal">searchByBook</tt>. We are going to use a new experimental index introduced in <tt class="docutils literal">MongoDB</tt> 2.4 to allow us to perform full text search on documents.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">Full text search is a beta feature in <tt class="docutils literal">MongoDB</tt> 2.4 and will most likely change a lot in forthcoming versions as it get moved from beta into a fully supported feature.</p>
</div>
<p>Let's start with a slight modification to the connection code to create our index.</p>
<pre class="code javascript literal-block">
<span class="c1">// Connect to MongoDB
</span><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/library&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
  <span class="nx">dbInstance</span> <span class="o">=</span> <span class="nx">db</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to mongodb&quot;</span><span class="p">)</span>

  <span class="nx">db</span><span class="p">.</span><span class="nx">admin</span><span class="p">(</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">command</span><span class="p">(</span><span class="p">{</span> <span class="nx">setParameter</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">textSearchEnabled</span> <span class="o">:</span> <span class="kc">true</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">).</span><span class="nx">ensureIndex</span><span class="p">(</span><span class="p">{</span><span class="nx">title</span><span class="o">:</span><span class="s2">&quot;text&quot;</span><span class="p">},</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span><span class="mi">0</span><span class="p">});</span>
      <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'authors'</span><span class="p">).</span><span class="nx">ensureIndex</span><span class="p">(</span><span class="p">{</span><span class="nx">name</span><span class="o">:</span><span class="s2">&quot;text&quot;</span><span class="p">},</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span><span class="mi">0</span><span class="p">});</span>
      <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'publishers'</span><span class="p">).</span><span class="nx">ensureIndex</span><span class="p">(</span><span class="p">{</span><span class="nx">name</span><span class="o">:</span><span class="s2">&quot;text&quot;</span><span class="p">},</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span><span class="mi">0</span><span class="p">});</span>

      <span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">9090</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;listening on &quot;</span><span class="p">,</span> <span class="mi">9090</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre>
<p>The first part of the change is to execute a command against the <tt class="docutils literal">admin</tt> database to enable the <tt class="docutils literal">BETA</tt> text search capabilities in <tt class="docutils literal">MongoDB</tt> 2.4. We then create a text index for each of the collections <tt class="docutils literal">books</tt>, <tt class="docutils literal">authors</tt> and <tt class="docutils literal">publishers</tt>. The only difference between the three indexes is that the <tt class="docutils literal">books</tt> index is on the <tt class="docutils literal">title</tt> field of books.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p>You might want to extend the book model with a <tt class="docutils literal">description</tt> or <tt class="docutils literal">summary</tt> field in the future. To index this field you might want to drop the existing text index and then reindex by changing the book index creation command to db.``collection('books').ensureIndex({title:&quot;text&quot;, summary:&quot;text&quot;}, {w:0})``</p>
<p class="last">More indepth information about the text index is available in a future exercise.</p>
</div>
<p>Now when we reboot our <tt class="docutils literal">API</tt> it will automatically create the right text indexes. It's now time to implement the first search method <tt class="docutils literal">searchByAuthor</tt>. But first let's create a little helper method to be able to access the <tt class="docutils literal">query</tt> parameter at the end of the <tt class="docutils literal">url</tt>.</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">queryHelper</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">url_parts</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">url_parts</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p>Also ensure you add the <tt class="docutils literal">var url = <span class="pre">require('url');</span></tt> line at the top of your script. So what does <tt class="docutils literal">queryHelper</tt> do?. It's fairly simple it takes the <tt class="docutils literal"><span class="pre">?query=xxx</span></tt> and parses it into form we can more easily work with. If you pass it a request for the url <tt class="docutils literal"><span class="pre">http://localhost:9090/author/search?query=test</span></tt> it will return an object that looks like <tt class="docutils literal">{query: &quot;test&quot;}</tt> making it easy for us to get hold of the query the user is performing. Now that we have this method it's time to write the <tt class="docutils literal">searchByAuthor</tt> method.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">What if you want to use more than a single word?. Well you have to <tt class="docutils literal">URL</tt> encode your query. What does that mean? Well there are certain characters that are not allowed in a query string such as a blank space. If you wanted to encode the query <tt class="docutils literal">oz wizard</tt> you would need to convert the space so that the query looked like <tt class="docutils literal">oz%20wizard</tt>. So a query for a book would look like <tt class="docutils literal"><span class="pre">http://localhost:9090/author/search?query=oz%20wizard</span></tt>.</p>
</div>
<pre class="code javascript literal-block">
<span class="c1">// GET /author/search?query=?
</span><span class="kd">var</span> <span class="nx">searchByAuthor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">queryStringParams</span> <span class="o">=</span> <span class="nx">queryHelper</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">queryStringParams</span><span class="p">.</span><span class="nx">query</span> <span class="o">||</span> <span class="s1">''</span><span class="p">;</span>

  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">command</span><span class="p">(</span><span class="p">{</span><span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;authors&quot;</span><span class="p">,</span> <span class="nx">search</span><span class="o">:</span> <span class="nx">query</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
        <span class="p">,</span> <span class="mi">500</span>
        <span class="p">,</span> <span class="s1">'Failed to search by author with search '</span> <span class="o">+</span> <span class="nx">query</span><span class="p">);</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">results</span><span class="p">.</span><span class="nx">results</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>The code is not very difficult to understand, we execute the <tt class="docutils literal">text</tt> search command and it returns a document.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
  <span class="s2">&quot;queryDebugString&quot;</span> <span class="o">:</span> <span class="s2">&quot;oz||||||&quot;</span><span class="p">,</span>
  <span class="s2">&quot;language&quot;</span> <span class="o">:</span> <span class="s2">&quot;english&quot;</span><span class="p">,</span>
  <span class="s2">&quot;results&quot;</span> <span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;score&quot;</span> <span class="o">:</span> <span class="mf">0.75</span><span class="p">,</span>
      <span class="s2">&quot;obj&quot;</span> <span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;51921ef8b67cc57333000003&quot;</span><span class="p">),</span>
        <span class="s2">&quot;authors&quot;</span> <span class="o">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span> <span class="o">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;51921ef8b67cc57333000001&quot;</span><span class="p">),</span>
            <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;L. Frank Baum&quot;</span>
          <span class="p">}</span>
        <span class="p">],</span>
        <span class="s2">&quot;publisher&quot;</span> <span class="o">:</span> <span class="p">{</span>
          <span class="s2">&quot;publisher_id&quot;</span> <span class="o">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;51921ef8b67cc57333000002&quot;</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Wizard of Oz&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="s2">&quot;stats&quot;</span> <span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;nscanned&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;nscannedObjects&quot;</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;n&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;nfound&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;timeMicros&quot;</span> <span class="o">:</span> <span class="mi">107</span>
  <span class="p">},</span>
  <span class="s2">&quot;ok&quot;</span> <span class="o">:</span> <span class="mi">1</span>
<span class="p">}</span>
</pre>
<p>The actual search results are in the <tt class="docutils literal">results</tt> field and the code turns the results into <tt class="docutils literal">JSON</tt> and returns it. Due to text search being a <tt class="docutils literal">command</tt> in <tt class="docutils literal">MongoDB</tt> 2.4 it's limited to a maximum result set of <tt class="docutils literal">16 MB</tt>. It's very likely this will change going forward with the text search returning a cursor that lets you iterate over the returned results. Nice not very hard right. Let's take a look at the <tt class="docutils literal">searchByPublisher</tt> method.</p>
<pre class="code javascript literal-block">
<span class="c1">// GET /publisher/search?query=?
</span><span class="kd">var</span> <span class="nx">searchByPublisher</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">queryStringParams</span> <span class="o">=</span> <span class="nx">queryHelper</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">queryStringParams</span><span class="p">.</span><span class="nx">query</span> <span class="o">||</span> <span class="s1">''</span><span class="p">;</span>

  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">command</span><span class="p">(</span><span class="p">{</span><span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;publishers&quot;</span><span class="p">,</span> <span class="nx">search</span><span class="o">:</span> <span class="nx">query</span><span class="p">}</span>
    <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">500</span>
          <span class="p">,</span> <span class="s1">'Failed to search by author with search '</span> <span class="o">+</span> <span class="nx">query</span><span class="p">);</span>

      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">results</span><span class="p">.</span><span class="nx">results</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>Pretty much the same as the <tt class="docutils literal">searchByAuthor</tt> method with the difference being that we are searching the <tt class="docutils literal">publishers</tt> pages. Finally let's allow to search for books using the method <tt class="docutils literal">searchByBook</tt>.</p>
<pre class="code javascript literal-block">
<span class="c1">// GET /book/search?query=?
</span><span class="kd">var</span> <span class="nx">searchByBook</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">queryStringParams</span> <span class="o">=</span> <span class="nx">queryHelper</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">queryStringParams</span><span class="p">.</span><span class="nx">query</span> <span class="o">||</span> <span class="s1">''</span><span class="p">;</span>

  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">command</span><span class="p">(</span><span class="p">{</span><span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;books&quot;</span>
    <span class="p">,</span> <span class="nx">search</span><span class="o">:</span> <span class="nx">query</span>
    <span class="p">,</span> <span class="nx">project</span><span class="o">:</span> <span class="p">{</span><span class="nx">loaned_out_to</span><span class="o">:</span> <span class="mi">0</span><span class="p">}}</span>
    <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">500</span>
          <span class="p">,</span> <span class="s1">'Failed to search by author with search '</span> <span class="o">+</span> <span class="nx">query</span><span class="p">);</span>

      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">results</span><span class="p">.</span><span class="nx">results</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>Notice the single difference? Yeah you are right it's the <tt class="docutils literal">project: {loaned_out_to: 0}</tt> field we passed into the command. This works exactly the same as the field projection parameter in a normal <tt class="docutils literal">find</tt> allowing you to filter out fields that you do not want to return. In our case we don't want to return the <tt class="docutils literal">loaned_out_to</tt> field as it's internal state for the <tt class="docutils literal">API</tt> and should not be available outside. So let's test out the new <tt class="docutils literal">API's</tt> using the <tt class="docutils literal">curl</tt> commands.</p>
<pre class="code console literal-block">
<span class="go">curl -X GET http://localhost:9090/author/search?query=james
[{&quot;score&quot;:0.75,&quot;obj&quot;:{&quot;name&quot;:&quot;James Kirk&quot;,&quot;_id&quot;:&quot;51921ef8b67cc57333000001&quot;}}]

curl -X GET http://localhost:9090/publisher/search?query=books
[{&quot;score&quot;:0.75,&quot;obj&quot;:{&quot;name&quot;:&quot;Penguin Books&quot;,&quot;_id&quot;:&quot;51921ef8b67cc57333000002&quot;}}]

http://localhost:9090/book/search?query=oz
[{&quot;score&quot;:0.75,&quot;obj&quot;:{&quot;_id&quot;:&quot;51921ef8b67cc57333000003&quot;
,&quot;authors&quot;:[{&quot;id&quot;:&quot;51921ef8b67cc57333000001&quot;,&quot;name&quot;:&quot;L. Frank Baum&quot;}]
,&quot;name&quot;:&quot;Wizard of Oz&quot;,&quot;publisher&quot;:{&quot;publisher_id&quot;:&quot;51921ef8b67cc57333000002&quot;}
,&quot;title&quot;:&quot;Wizard of Oz&quot;}}]</span>
</pre>
<p>Alright it's time to add the ability to borrow books from our library. Let's look at the <tt class="docutils literal">borrowABook</tt> function.</p>
<pre class="code javascript literal-block">
<span class="c1">// POST /user/:id/loan/:book_id
</span><span class="kd">var</span> <span class="nx">borrowABook</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">book</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">500</span>
          <span class="p">,</span> <span class="s1">'Failed to retrieve Book for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">book</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">406</span>
          <span class="p">,</span> <span class="s1">'Book with '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span> <span class="o">+</span> <span class="s2">&quot; was not found&quot;</span><span class="p">);</span>

      <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">500</span>
              <span class="p">,</span> <span class="s1">'Failed to retrieve User for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">406</span>
              <span class="p">,</span> <span class="s1">'User with '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; was not found&quot;</span><span class="p">);</span>

          <span class="k">if</span><span class="p">(</span><span class="nx">book</span><span class="p">.</span><span class="nx">loaned_out_to</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">406</span>
              <span class="p">,</span> <span class="s1">'Book with '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span> <span class="o">+</span> <span class="s2">&quot; already loaned out&quot;</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">currentDate</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">dueOn</span> <span class="o">=</span> <span class="nx">currentDate</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">dueOnTime</span> <span class="o">=</span> <span class="nx">currentDate</span><span class="p">.</span><span class="nx">getTime</span><span class="p">(</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">14</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
          <span class="nx">dueOn</span><span class="p">.</span><span class="nx">setTime</span><span class="p">(</span><span class="nx">dueOnTime</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">loanedOutTo</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">user_id</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span>
            <span class="p">,</span> <span class="nx">loaned_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span>
            <span class="p">,</span> <span class="nx">due_on</span><span class="o">:</span> <span class="nx">dueOn</span>
          <span class="p">}</span>

          <span class="kd">var</span> <span class="nx">loanedBook</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">id</span><span class="o">:</span> <span class="nx">book</span><span class="p">.</span><span class="nx">_id</span>
            <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">book</span><span class="p">.</span><span class="nx">title</span>
            <span class="p">,</span> <span class="nx">loaned_out</span><span class="o">:</span> <span class="nx">loanedOutTo</span><span class="p">.</span><span class="nx">loaned_on</span>
            <span class="p">,</span> <span class="nx">due_on</span><span class="o">:</span> <span class="nx">loanedOutTo</span><span class="p">.</span><span class="nx">due_on</span>
          <span class="p">}</span>

          <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span><span class="p">)</span>
              <span class="p">,</span> <span class="nx">loaned_out_to</span><span class="o">:</span> <span class="p">{</span><span class="nx">$exists</span><span class="o">:</span> <span class="kc">false</span><span class="p">}}</span>
              <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span>
                  <span class="p">{</span>
                      <span class="nx">loaned_out</span><span class="o">:</span><span class="kc">true</span>
                    <span class="p">,</span> <span class="nx">loaned_out_to</span><span class="o">:</span> <span class="nx">loanedOutTo</span> <span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">updated</span><span class="p">)</span> <span class="p">{</span>

                <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="nx">updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                  <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
                    <span class="p">,</span> <span class="mi">500</span>
                    <span class="p">,</span> <span class="s1">'Failed to loan Book with id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span><span class="p">);</span>

                <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)}</span>
                  <span class="p">,</span> <span class="p">{</span><span class="nx">$push</span><span class="o">:</span>
                      <span class="p">{</span> <span class="nx">loaned_books</span><span class="o">:</span> <span class="nx">loanedBook</span> <span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">updated</span><span class="p">)</span> <span class="p">{</span>

                    <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="nx">updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                      <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
                        <span class="p">,</span> <span class="mi">500</span>
                        <span class="p">,</span> <span class="s1">'Failed to update User with id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

                    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">loanedBook</span><span class="p">));</span>
                  <span class="p">});</span>
              <span class="p">});</span>
      <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>Alright we got quite a bit more code than the other methods we have implemented so far, but not to worry it's much simpler than what it looks. Remember two exercises ago we defined the operations we needed to perform when borrowing a book? Let's take a look.</p>
<ol class="arabic simple">
<li>Add a new loan to the user document</li>
</ol>
<pre class="code javascript literal-block">
<span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
    <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span>
  <span class="p">,</span> <span class="p">{</span>
      <span class="nx">$push</span><span class="o">:</span> <span class="p">{</span><span class="nx">loaned_books</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span>
        <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Wizard of Oz&quot;</span>
        <span class="p">,</span> <span class="nx">loaned_on</span><span class="o">:</span> <span class="nx">start_date</span>
        <span class="p">,</span> <span class="nx">due_on</span><span class="o">:</span> <span class="nx">due_date</span>
      <span class="p">}}</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span><span class="p">})</span>
</pre>
<ol class="arabic simple" start="2">
<li>Mark the <tt class="docutils literal">Wizard of Oz</tt> book as borrowed.</li>
</ol>
<pre class="code javascript literal-block">
<span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span>
  <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">loaned_out_to</span><span class="o">:</span> <span class="p">{</span><span class="nx">$exists</span><span class="o">:</span> <span class="kc">false</span><span class="p">}</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="nx">$set</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">loaned_out</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">,</span> <span class="nx">loaned_out_to</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">user_id</span><span class="o">:</span> <span class="mi">1</span>
        <span class="p">,</span> <span class="nx">loaned_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span>
        <span class="p">,</span> <span class="nx">due_on</span><span class="o">:</span> <span class="nx">due_date_variable</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span><span class="p">});</span>
</pre>
<p>With this in mind the first part of the <tt class="docutils literal">borrowABook</tt> method is just to ensure the passed in <tt class="docutils literal">User</tt> and <tt class="docutils literal">Book</tt> exist in our library. The next line is.</p>
<pre class="code javascript literal-block">
<span class="k">if</span><span class="p">(</span><span class="nx">book</span><span class="p">.</span><span class="nx">loaned_out_to</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="mi">406</span><span class="p">,</span> <span class="s1">'Book with '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span> <span class="o">+</span> <span class="s2">&quot; already loaned out&quot;</span><span class="p">);</span>
</pre>
<p>We check if the returned <tt class="docutils literal">Book</tt> document is already loaned to another <tt class="docutils literal">User</tt>. If the field <tt class="docutils literal">loaned_out_to</tt> exists it's been marked as loaned out.</p>
<p>Next wee need to calculate the due date that in this library is hardcoded to 14 days and then build the embedded documents for the loan.</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">currentDate</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">dueOn</span> <span class="o">=</span> <span class="nx">currentDate</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">dueOnTime</span> <span class="o">=</span> <span class="nx">currentDate</span><span class="p">.</span><span class="nx">getTime</span><span class="p">(</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">14</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
<span class="nx">dueOn</span><span class="p">.</span><span class="nx">setTime</span><span class="p">(</span><span class="nx">dueOnTime</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">loanedOutTo</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">user_id</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span>
  <span class="p">,</span> <span class="nx">loaned_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">due_on</span><span class="o">:</span> <span class="nx">dueOn</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">loanedBook</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">id</span><span class="o">:</span> <span class="nx">book</span><span class="p">.</span><span class="nx">_id</span>
  <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">book</span><span class="p">.</span><span class="nx">title</span>
  <span class="p">,</span> <span class="nx">loaned_out</span><span class="o">:</span> <span class="nx">loanedOutTo</span><span class="p">.</span><span class="nx">loaned_on</span>
  <span class="p">,</span> <span class="nx">due_on</span><span class="o">:</span> <span class="nx">loanedOutTo</span><span class="p">.</span><span class="nx">due_on</span>
<span class="p">}</span>
</pre>
<p>To calculate a due date <tt class="docutils literal">14</tt> days in the future we take the current time in <tt class="docutils literal">milliseconds</tt> and add (14 days * 24 hours * 60 minutes * 60 seconds * 1000 miliseconds in a second) to the date. We then prepare the <tt class="docutils literal">loaned_out_to</tt> document that will set on the <tt class="docutils literal">Book</tt> document indicating that it's loaned out. Likewise we set up the <tt class="docutils literal">loanedBook</tt> document that will be added to the list of books borrowed by a specific <tt class="docutils literal">User</tt>.</p>
<p>Now comes the trick. We need to ensure we only loan out the book if nobody has borrowed while we were setting up our loan details. We do this by only updating the <tt class="docutils literal">Book</tt> <tt class="docutils literal">loaned_out_to</tt> field if it does not exist when the <tt class="docutils literal">update</tt> is performed. This is done with.</p>
<pre class="code javascript literal-block">
<span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">loaned_out_to</span><span class="o">:</span> <span class="p">{</span><span class="nx">$exists</span><span class="o">:</span> <span class="kc">false</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">updated</span><span class="p">)</span> <span class="p">{</span>
<span class="p">});</span>
</pre>
<p>notice the <tt class="docutils literal">loaned_out_to: {$exists:false}</tt>. This part of the <tt class="docutils literal">find</tt> part of the <tt class="docutils literal">update</tt> operation ensure that we will only match on a <tt class="docutils literal">Book</tt> that has not been loaned out (meaning the <tt class="docutils literal">loaned_out_to</tt> is not set).</p>
<p>Awesome so if the first <tt class="docutils literal">update</tt> succeeds we now need to add the book to the <tt class="docutils literal">User</tt> documents under the array in the field <tt class="docutils literal">loaned_books</tt>. That's simpler than the previous update as we don't need to worry about concurrent updates adding the book multiple times. Let's look at the <tt class="docutils literal">update</tt> statement.</p>
<pre class="code javascript literal-block">
<span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)}</span>
        <span class="p">,</span> <span class="p">{</span><span class="nx">$push</span><span class="o">:</span> <span class="p">{</span> <span class="nx">loaned_books</span><span class="o">:</span> <span class="nx">loanedBook</span> <span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">updated</span><span class="p">)</span> <span class="p">{</span>
<span class="p">});</span>
</pre>
<p>Notice how we use the <tt class="docutils literal">$push</tt> operator. It will create the array field <tt class="docutils literal">loaned_books</tt> if none already exists. Test out the ability to borrow a book using <tt class="docutils literal">curl</tt>.</p>
<pre class="code console literal-block">
<span class="go">curl -X POST http://localhost:9090/user/51921ef8b67cc57333000004/loan
/51921ef8b67cc57333000003
{&quot;id&quot;:&quot;51921ef8b67cc57333000003&quot;,&quot;title&quot;:&quot;Wizard of Oz&quot;
,&quot;loaned_out&quot;:&quot;2013-05-28T11:18:02.795Z&quot;,&quot;due_on&quot;:&quot;2013-06-11T11:18:02.795Z&quot;}</span>
</pre>
<p>Now let's get to the other important aspect of a library, namely being able to return a borrowed book. In our case this is the <tt class="docutils literal">returnAABook</tt> method. Let's have a look at the code</p>
<pre class="code javascript literal-block">
<span class="c1">// DELETE  /user/:id/loan/:book_id
</span><span class="kd">var</span> <span class="nx">returnAABook</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">book</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">500</span>
          <span class="p">,</span> <span class="s1">'Failed to retrieve Book for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">book</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">406</span>
          <span class="p">,</span> <span class="s1">'Book with '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span> <span class="o">+</span> <span class="s2">&quot; was not found&quot;</span><span class="p">);</span>

      <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">500</span>
              <span class="p">,</span> <span class="s1">'Failed to retrieve User for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">406</span>
              <span class="p">,</span> <span class="s1">'User with '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; was not found&quot;</span><span class="p">);</span>

          <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span>
                <span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span><span class="p">)</span>
              <span class="p">,</span> <span class="nx">loaned_out</span><span class="o">:</span> <span class="kc">true</span><span class="p">}</span>
            <span class="p">,</span> <span class="p">{</span>   <span class="nx">$set</span><span class="o">:</span> <span class="p">{</span> <span class="nx">loaned_out</span><span class="o">:</span><span class="kc">false</span><span class="p">}</span>
                <span class="p">,</span> <span class="nx">$unset</span><span class="o">:</span> <span class="p">{</span><span class="nx">loaned_out_to</span><span class="o">:</span> <span class="kc">null</span><span class="p">}</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">updated</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="nx">updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
              <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
                <span class="p">,</span> <span class="mi">500</span>
                <span class="p">,</span> <span class="s1">'Failed to return Book with id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span><span class="p">);</span>

            <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)}</span>
              <span class="p">,</span> <span class="p">{</span><span class="nx">$pop</span><span class="o">:</span> <span class="p">{</span> <span class="nx">loaned_books</span><span class="o">:</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span><span class="p">)</span> <span class="p">}}}</span>
              <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">updated</span><span class="p">)</span> <span class="p">{</span>

                <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="nx">updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                  <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
                    <span class="p">,</span> <span class="mi">500</span>
                    <span class="p">,</span> <span class="s1">'Failed to update User with id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

                <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">book</span><span class="p">.</span><span class="nx">loaned_out_to</span><span class="p">));</span>
            <span class="p">});</span>
          <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>Just as in the previous method we first check if the <tt class="docutils literal">User</tt> and <tt class="docutils literal">Book</tt> are valid before we update the state. Since race conditions don't matter in this case we can do a much simpler update scheme. Let's look at the two <tt class="docutils literal">update</tt> statements.</p>
<pre class="code javascript literal-block">
<span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span><span class="p">),</span> <span class="nx">loaned_out</span><span class="o">:</span> <span class="kc">true</span><span class="p">}</span>
    <span class="p">,</span> <span class="p">{</span>   <span class="nx">$set</span><span class="o">:</span> <span class="p">{</span> <span class="nx">loaned_out</span><span class="o">:</span><span class="kc">false</span><span class="p">}</span>
        <span class="p">,</span> <span class="nx">$unset</span><span class="o">:</span> <span class="p">{</span><span class="nx">loaned_out_to</span><span class="o">:</span> <span class="kc">null</span><span class="p">}</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">updated</span><span class="p">)</span> <span class="p">{</span><span class="p">});</span>
</pre>
<p>The first update statement takes the passed in boko and removes the <tt class="docutils literal">loaned_out_to</tt> field using <tt class="docutils literal">$unset</tt>. This makes the <tt class="docutils literal">Book</tt> available for borrowing again.</p>
<pre class="code javascript literal-block">
<span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)}</span>
  <span class="p">,</span> <span class="p">{</span><span class="nx">$pop</span><span class="o">:</span> <span class="p">{</span> <span class="nx">loaned_books</span><span class="o">:</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span><span class="p">)</span> <span class="p">}}}</span>
  <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">updated</span><span class="p">)</span> <span class="p">{</span><span class="p">});</span>
</pre>
<p>The second update statement removed the borrowed book from the list of <tt class="docutils literal">loaned_books</tt> in the <tt class="docutils literal">User</tt> document using the <tt class="docutils literal">$pop</tt> operator matching on the document in the <tt class="docutils literal">loaned_books</tt> array that has the <tt class="docutils literal">id</tt> field equivalent to the Book that was returned to the library. Let's exercise the new <tt class="docutils literal">API</tt> using <tt class="docutils literal">curl</tt>.</p>
<pre class="code console literal-block">
<span class="go">curl -X DELETE http://localhost:9090/user/51921ef8b67cc57333000004/loan
/51921ef8b67cc57333000003
{&quot;id&quot;:&quot;51921ef8b67cc57333000003&quot;,&quot;title&quot;:&quot;Wizard of Oz&quot;
,&quot;loaned_out&quot;:&quot;2013-05-28T11:18:02.795Z&quot;,&quot;due_on&quot;:&quot;2013-06-11T11:18:02.795Z&quot;}</span>
</pre>
<p>Awesome we now have the ability to borrow and return books. We just have a couple of more features for our <tt class="docutils literal">API</tt> before we wrap it up in our next exercise with some refactorings (changing the code to make it simpler) as well as adding some validation.</p>
<table border="1" class="docutils">
<colgroup>
<col width="49%" />
<col width="51%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Method Url</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>GET     /user/:id/loans</td>
<td>Get all the books loaned by a specific user</td>
</tr>
<tr><td>PUT     /user/:id/loan/:book_id</td>
<td>Extend a loan period / modify a loan period</td>
</tr>
<tr><td>GET     /loan/overdue</td>
<td>Get a list of all overdue books</td>
</tr>
<tr><td>GET     /loan/overdue/:days</td>
<td>Get a list of all overdue books in ?days days</td>
</tr>
</tbody>
</table>
<p>Let's look at the first method which allows the <tt class="docutils literal">API</tt> to return the list of books borrowed by a specific user <tt class="docutils literal">getLoansByUser</tt>.</p>
<pre class="code javascript literal-block">
<span class="c1">// GET /user/:id/loans
</span><span class="kd">var</span> <span class="nx">getLoansByUser</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">500</span>
          <span class="p">,</span> <span class="s1">'Failed to retrieve User for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">406</span>
          <span class="p">,</span> <span class="s1">'User with '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; was not found&quot;</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">loaned_books</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">loaned_books</span> <span class="o">||</span> <span class="p">[</span><span class="p">];</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">loaned_books</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>It's a very simple method all we do is return the books the <tt class="docutils literal">User</tt> has currently lent (notice the <tt class="docutils literal">||</tt>, that makes sure we return an empty array if the <tt class="docutils literal">User</tt> has not borrowed any books). Let's try it using <tt class="docutils literal">curl</tt>. The first <tt class="docutils literal">curl</tt> command is to ensure the <tt class="docutils literal">User</tt> has borrowed a book so we can get a result.</p>
<pre class="code console literal-block">
<span class="go">curl -X POST http://localhost:9090/user/51921ef8b67cc57333000004/loan
/51921ef8b67cc57333000003
{&quot;id&quot;:&quot;51921ef8b67cc57333000003&quot;,&quot;title&quot;:&quot;Wizard of Oz&quot;
,&quot;loaned_out&quot;:&quot;2013-05-28T11:18:02.795Z&quot;,&quot;due_on&quot;:&quot;2013-06-11T11:18:02.795Z&quot;}

curl -X GET http://localhost:9090/user/51921ef8b67cc57333000004/loans
[{&quot;id&quot;:&quot;51921ef8b67cc57333000003&quot;,&quot;title&quot;:&quot;Wizard of Oz&quot;
,&quot;loaned_out&quot;:&quot;2013-05-28T12:35:52.330Z&quot;,&quot;due_on&quot;:&quot;2013-06-11T12:35:52.330Z&quot;}]</span>
</pre>
<p>So what if the user wants to renew the book for another 14 day period. For this we have the method <tt class="docutils literal">modifyLoan</tt>. Let's take a look.</p>
<pre class="code javascript literal-block">
<span class="c1">// PUT /user/:id/loan/:book_id
</span><span class="kd">var</span> <span class="nx">modifyLoan</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">book</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">500</span>
          <span class="p">,</span> <span class="s1">'Failed to retrieve Book for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">book</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
          <span class="p">,</span> <span class="mi">406</span>
          <span class="p">,</span> <span class="s1">'Book with '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span> <span class="o">+</span> <span class="s2">&quot; was not found&quot;</span><span class="p">);</span>

      <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">500</span>
              <span class="p">,</span> <span class="s1">'Failed to retrieve User for id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">406</span>
              <span class="p">,</span> <span class="s1">'User with '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; was not found&quot;</span><span class="p">);</span>

          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">.</span><span class="nx">loaned_books</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">406</span>
              <span class="p">,</span> <span class="s1">'User with '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; has not borrowed any books&quot;</span><span class="p">);</span>

          <span class="c1">// Let's locate the book
</span>          <span class="kd">var</span> <span class="nx">loaned_book</span><span class="p">;</span>

          <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">loaned_books</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">loaned_books</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="p">)</span> <span class="o">==</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">loaned_book</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">loaned_books</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>

          <span class="k">if</span><span class="p">(</span><span class="nx">loaned_book</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
              <span class="p">,</span> <span class="mi">406</span>
              <span class="p">,</span> <span class="s1">'User with '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
                <span class="o">+</span> <span class="s2">&quot; has not borrowed the book with id &quot;</span>
                <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">currentDate</span> <span class="o">=</span> <span class="nx">loaned_book</span><span class="p">.</span><span class="nx">due_on</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">dueOn</span> <span class="o">=</span> <span class="nx">currentDate</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">dueOnTime</span> <span class="o">=</span> <span class="nx">currentDate</span><span class="p">.</span><span class="nx">getTime</span><span class="p">(</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">14</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
          <span class="nx">dueOn</span><span class="p">.</span><span class="nx">setTime</span><span class="p">(</span><span class="nx">dueOnTime</span><span class="p">);</span>

          <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
              <span class="p">,</span> <span class="s2">&quot;loaned_books.id&quot;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span><span class="p">)}</span>
              <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;loaned_books.$.due_on&quot;</span><span class="o">:</span> <span class="nx">dueOn</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">updated</span><span class="p">)</span> <span class="p">{</span>

                <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="nx">updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                  <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span>
                    <span class="p">,</span> <span class="mi">500</span>
                    <span class="p">,</span> <span class="s1">'Failed to update User with id '</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

                <span class="nx">loaned_book</span><span class="p">.</span><span class="nx">due_on</span> <span class="o">=</span> <span class="nx">dueOn</span><span class="p">;</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">loaned_book</span><span class="p">));</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>Quite a mouthful right. But not to worry it's not as hard as it seems. Let's break it down. Just as in previous methods we ensure that the passed in <tt class="docutils literal">User</tt> and <tt class="docutils literal">Book</tt> exists before getting to the meat of the method. The first thing you might notice is that we check if the <tt class="docutils literal">User</tt> has the field <tt class="docutils literal">loaned_books</tt> set. If it does not then obviously we cannot renew the loan as the user never borrowed the book. If they have books out we iterate over the list of <tt class="docutils literal">loaned_books</tt> and attempt to locate the <tt class="docutils literal">Book</tt> we wish to renew. If no <tt class="docutils literal">Book</tt> is found <tt class="docutils literal">loaned_book == null</tt> we return an error as the <tt class="docutils literal">User</tt> has not borrowed this <tt class="docutils literal">Book</tt> and we cannot renew a non existing <tt class="docutils literal">Book</tt>. If he has borrowed the <tt class="docutils literal">Book</tt> we calculate a new due date 14 days in the future from the existing due date. We then update the <tt class="docutils literal">loan</tt> due date. Let's have a look at the update statement.</p>
<pre class="code javascript literal-block">
<span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
      <span class="p">,</span> <span class="s2">&quot;loaned_books.id&quot;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">book_id</span><span class="p">)}</span>
      <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;loaned_books.$.due_on&quot;</span><span class="o">:</span> <span class="nx">dueOn</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">updated</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">});</span>
</pre>
<p>The <tt class="docutils literal">{_id: new ObjectID(req.params.id), &quot;loaned_books.id&quot;: new ObjectID(req.params.book_id)</tt> selector will match on the right <tt class="docutils literal">User</tt> and then the correct borrowed <tt class="docutils literal">Book</tt> in the <tt class="docutils literal">loaned_books</tt> array. The <tt class="docutils literal">{$set: <span class="pre">{&quot;loaned_books.$.due_on&quot;:</span> dueOn}}</tt> update statement used the positional operator <tt class="docutils literal">$</tt> to change the <tt class="docutils literal">due_on</tt> field in the first matched embedded document in the <tt class="docutils literal">loaned_books</tt> array which will be the <tt class="docutils literal">Book</tt> we want to renew.</p>
<p>Great now we have a possibility to renew a <tt class="docutils literal">Book</tt>. We now need to be able to discover what <tt class="docutils literal">Books</tt> are passed their due date and also what <tt class="docutils literal">Books</tt> are due in the next <tt class="docutils literal">X</tt> days so we can send reminders to <tt class="docutils literal">Users</tt> that their <tt class="docutils literal">Books</tt> are due soon. Let's start with the list of <tt class="docutils literal">Books</tt> that are due, namely the method <tt class="docutils literal">overdueLoans</tt>.</p>
<pre class="code javascript literal-block">
<span class="c1">// GET /loan/overdue
</span><span class="kd">var</span> <span class="nx">overdueLoans</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">).</span><span class="nx">aggregate</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">{</span> <span class="nx">$match</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;loaned_books.due_on&quot;</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$lte</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
      <span class="p">,</span> <span class="p">{</span> <span class="nx">$unwind</span><span class="o">:</span> <span class="s2">&quot;$loaned_books&quot;</span> <span class="p">}</span>
      <span class="p">,</span> <span class="p">{</span> <span class="nx">$project</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">_id</span><span class="o">:</span> <span class="s2">&quot;$loaned_books.id&quot;</span>
            <span class="p">,</span> <span class="nx">user_id</span><span class="o">:</span> <span class="s2">&quot;$_id&quot;</span>
            <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;$loaned_books.title&quot;</span>
            <span class="p">,</span> <span class="nx">loaned_out</span><span class="o">:</span> <span class="s2">&quot;$loaned_books.loaned_out&quot;</span>
            <span class="p">,</span> <span class="nx">due_on</span><span class="o">:</span> <span class="s2">&quot;$loaned_books.due_on&quot;</span>
          <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">'Failed to locate overdue books'</span><span class="p">);</span>

      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">results</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>Remember how the borrowed <tt class="docutils literal">Books</tt> are inside the <tt class="docutils literal">User</tt> document?. We want to just return the matching <tt class="docutils literal">Books</tt> for all users that are overdue as a single list of <tt class="docutils literal">Books</tt> that are overdue with the <tt class="docutils literal">user_id</tt> of the user who borrowed that particular overdue <tt class="docutils literal">Book</tt>; For this we will use the <tt class="docutils literal">Aggregation Framework</tt> introduced in <tt class="docutils literal">MongoDB</tt> 2.2. In a later exercise we will into all the intricacies of the Application Framework for now we will skim and just look at the little subset off operations we are using.</p>
<p>The Aggregation Framework works as a set of transformations where each stage does some action on the data provided. In this case it's broken up into 3 different stages.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="nx">$match</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;loaned_books.due_on&quot;</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$lte</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
</pre>
<p>The <tt class="docutils literal">$match</tt> operator is the equivalent to the <tt class="docutils literal">find</tt> operation in that it will look for a set of documents in the collection that matches the passed in operators. Fairly simple and straight forward. The next operator is.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="nx">$unwind</span><span class="o">:</span> <span class="s2">&quot;$loaned_books&quot;</span> <span class="p">}</span>
</pre>
<p>The <tt class="docutils literal">$unwind</tt> operator is a little harder to grasp but what it does is simple. It takes the array in the <tt class="docutils literal">User</tt> document <tt class="docutils literal">loaned_books</tt> and <tt class="docutils literal">unwinds</tt> it by creating an individual document for each item in the array. Better to show by example. Lets take the following document.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
  <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="nx">loaned_books</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre>
<p>After we do <tt class="docutils literal">{ $unwind: &quot;$loaned_books&quot; }</tt> we get the following documents.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
  <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="nx">loaned_books</span><span class="o">:</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span>
  <span class="nx">loaned_books</span><span class="o">:</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">}</span>
<span class="p">}</span>
</pre>
<p>So as we can see we have expanded the array into a set of documents where each element in the array is mapped to a copy of the original document under the <tt class="docutils literal">loaned_books</tt> field. Finally we want to make the embedded document under <tt class="docutils literal">loaned_books</tt> be at the top level of the document. We execute the last step in our aggregation.</p>
<pre class="code javascript literal-block">
<span class="p">{</span> <span class="nx">$project</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">_id</span><span class="o">:</span> <span class="s2">&quot;$loaned_books.id&quot;</span>
    <span class="p">,</span> <span class="nx">user_id</span><span class="o">:</span> <span class="s2">&quot;$_id&quot;</span>
    <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;$loaned_books.title&quot;</span>
    <span class="p">,</span> <span class="nx">loaned_out</span><span class="o">:</span> <span class="s2">&quot;$loaned_books.loaned_out&quot;</span>
    <span class="p">,</span> <span class="nx">due_on</span><span class="o">:</span> <span class="s2">&quot;$loaned_books.due_on&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>What we actually are doing is transforming (or rewriting) the documents from the <tt class="docutils literal">$unwind</tt> step. <tt class="docutils literal">user_id: &quot;$_id&quot;</tt> moves the <tt class="docutils literal">_id</tt> field into the new field <tt class="docutils literal">user_id</tt> while the field <tt class="docutils literal">$loaned_books.id</tt> becomes the new <tt class="docutils literal">_id</tt> field. Similarly we move the <tt class="docutils literal">title</tt>, <tt class="docutils literal">`loaned_out</tt> and <tt class="docutils literal">due_on</tt> up from <tt class="docutils literal">loaned_books</tt>. The result is a brand new document. Given that we have a book passed it's due date (creating or modifying a <tt class="docutils literal">User</tt> document for this is left to you as an exercise. A hint is to look at the update code above and use the mongo console).</p>
<pre class="code console literal-block">
<span class="go">curl -X GET http://localhost:9090/loan/overdue
[{&quot;_id&quot;:&quot;51921ef8b67cc57333000003&quot;,&quot;user_id&quot;:&quot;51921ef8b67cc57333000004&quot;
,&quot;title&quot;:&quot;Wizard of Oz&quot;,&quot;loaned_out&quot;:&quot;2013-05-28T12:35:52.330Z&quot;
,&quot;due_on&quot;:&quot;2013-05-23T13:22:15.568Z&quot;}]</span>
</pre>
<p>We will get deeper into the Aggregation framework in a later exercise but it's quite useful as you can see and a lot more powerful. At the moment however it's limited as it's a command thus limiting it to a maximum result size of 16MB.</p>
<p>We only have one more method to implement <tt class="docutils literal">overdueLoansByDays</tt>. Let's have a look at the code.</p>
<pre class="code javascript literal-block">
<span class="c1">// GET /loan/overdue/:days
</span><span class="kd">var</span> <span class="nx">overdueLoansByDays</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">days</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">days</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">currentDate</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">time</span> <span class="o">=</span> <span class="nx">currentDate</span><span class="p">.</span><span class="nx">getTime</span><span class="p">(</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
  <span class="nx">currentDate</span><span class="p">.</span><span class="nx">setTime</span><span class="p">(</span><span class="nx">time</span><span class="p">);</span>

  <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'users'</span><span class="p">).</span><span class="nx">aggregate</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">{</span> <span class="nx">$match</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;loaned_books.due_on&quot;</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$lte</span><span class="o">:</span> <span class="nx">currentDate</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
      <span class="p">,</span> <span class="p">{</span> <span class="nx">$unwind</span><span class="o">:</span> <span class="s2">&quot;$loaned_books&quot;</span> <span class="p">}</span>
      <span class="p">,</span> <span class="p">{</span> <span class="nx">$project</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">_id</span><span class="o">:</span> <span class="s2">&quot;$loaned_books.id&quot;</span>
            <span class="p">,</span> <span class="nx">user_id</span><span class="o">:</span> <span class="s2">&quot;$_id&quot;</span>
            <span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;$loaned_books.title&quot;</span>
            <span class="p">,</span> <span class="nx">loaned_out</span><span class="o">:</span> <span class="s2">&quot;$loaned_books.loaned_out&quot;</span>
            <span class="p">,</span> <span class="nx">due_on</span><span class="o">:</span> <span class="s2">&quot;$loaned_books.due_on&quot;</span>
          <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">writeError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">'Failed to locate overdue books'</span><span class="p">);</span>

      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">results</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>As we can see the only difference is in the date we pass in <tt class="docutils literal">days</tt> that lets us check for books that validate <tt class="docutils literal">x</tt> days in the future. Let's try it out using <tt class="docutils literal">curl</tt>.</p>
<pre class="code console literal-block">
<span class="go">curl -X GET http://localhost:9090/loan/overdue/1
[{&quot;_id&quot;:&quot;51921ef8b67cc57333000003&quot;,&quot;user_id&quot;:&quot;51921ef8b67cc57333000004&quot;
,&quot;title&quot;:&quot;Wizard of Oz&quot;,&quot;loaned_out&quot;:&quot;2013-05-28T12:35:52.330Z&quot;
,&quot;due_on&quot;:&quot;2013-05-23T13:22:15.568Z&quot;}]</span>
</pre>
<p>Awesome that wraps up the <tt class="docutils literal">API</tt> methods.</p>
<p>There are several improvements you could do to this code. This is left as an exercise for you. But to point you in the right direction I'll make some observations.</p>
<ol class="arabic simple">
<li>There is a fair bit of duplicated code for validating the existence of Documents for <tt class="docutils literal">User</tt>, <tt class="docutils literal">Author</tt> and <tt class="docutils literal">Publisher</tt> that you might be able to simplify by extracting some new methods.</li>
<li>There is no document validation for the <tt class="docutils literal">POST</tt> methods. It would be useful if the <tt class="docutils literal">User</tt>, <tt class="docutils literal">Author</tt>, <tt class="docutils literal">Publisher</tt> and <tt class="docutils literal">Book</tt> creation methods contained validation of the new documents to ensure no illegal documents are inserted.</li>
<li>You might consider breaking the application up into modules, moving the router into a separate file for example.</li>
<li>What indexes are missing? Add any missing indexes to ensure you don't force MongoDB to scan entire collections.</li>
</ol>
<p>That wraps up the exercise.</p>
</div>
<div class="section" id="exercise-22-mongodb-topologies">
<h2><a class="toc-backref" href="#id123">Exercise 22: MongoDB Topologies</a></h2>
<p>It's time to talk a little about the deployment Topologies of MongoDB. They are split into three distinct setups.</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Topology</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Single Server</td>
<td>A single MongoDB instance handles all reads and writes</td>
</tr>
<tr><td>Replicaset</td>
<td>A cluster of MongoDB servers handle reads and writes and provide fault tolerance with automatic failover.</td>
</tr>
<tr><td>Sharded System</td>
<td>A collection of replicasets handles horizontal scaling using sharding</td>
</tr>
</tbody>
</table>
<p>In the next couple of exercises we will dig into the Three categories and go into how it works and how the driver supports each of the categories.</p>
<div class="section" id="the-single-server">
<h3><a class="toc-backref" href="#id124">The Single Server</a></h3>
<p>The single server will most people's first experience with MongoDB. It's pretty straight forwards as all reads and writes from your application will be going to the same single server. Let's take a look at how we can set up a single server and connect to it using the driver. Let's start with booting up the <tt class="docutils literal">mongod</tt> process.</p>
<pre class="code console literal-block">
<span class="go">mkdir ./data
mongod --dbpath=./data --port 27017</span>
</pre>
<p>Boot up your text editor and enter the needed connection code.</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to the database&quot;</span><span class="p">);</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="p">);</span>
<span class="p">});</span>
</pre>
<p>That pretty much covers a single server. Not very hard to get started right. But what if we want to ensure that our application still runs if the MongoDB server goes down? That's where Replicasets come in and what is next.</p>
</div>
<div class="section" id="the-replicaset">
<h3><a class="toc-backref" href="#id125">The Replicaset</a></h3>
<p>The replicaset is the way MongoDB handles fault tolerance. It consists of 3 types of server instances (why 3 you might ask, we will get into that shortly).</p>
<table border="1" class="docutils">
<colgroup>
<col width="23%" />
<col width="77%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Server type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Primary</td>
<td>The current master of the replicaset that accepts writes</td>
</tr>
<tr><td>Secondary</td>
<td>The slaves of the replicaset, accepts reads but no writes. Can be elected as primary if the current primary goes down.</td>
</tr>
<tr><td>Arbiter</td>
<td>A special type of server that accepts no reads or writes and only partake in the election of a new primary server if the current one goes down.</td>
</tr>
</tbody>
</table>
<p>As you can see the only server that accepts writes is the primary but the secondaries allow for an intriguing possibility of scaling reads. Let's get a replicaset up and running.</p>
<pre class="code console literal-block">
<span class="go">~ $ mkdir ./data
~ $ mkdir ./data/30000
~ $ mkdir ./data/30001
~ $ mkdir ./data/30002
~ $ mkdir ./data/logs

~ $ mongod --dbpath=./data/30000 --logpath=./data/logs/30000.log
--replSet test --port 30000 --fork
about to fork child process, waiting until server is ready for connections.
forked process: 69559
~ $ mongod --dbpath=./data/30001 --logpath=./data/logs/30001.log
--replSet test --port 30001 --fork
about to fork child process, waiting until server is ready for connections.
forked process: 69560
~ $ mongod --dbpath=./data/30002 --logpath=./data/logs/30002.log
--replSet test --port 30002 --fork
about to fork child process, waiting until server is ready for connections.
forked process: 69561</span>
</pre>
<p>The next step is to configure the servers so they will connect to each other and form a working replicaset. A configuration is a simple <tt class="docutils literal">JSON</tt> document. Let's look at the a simple configuration for a replicaset where we have a single primary, one secondary and one arbiter</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;test&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="s2">&quot;members&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="mi">0</span>
      <span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="o">:</span> <span class="s2">&quot;localhost:30000&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="mi">1</span>
      <span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="o">:</span> <span class="s2">&quot;localhost:30001&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="mi">2</span>
      <span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="o">:</span> <span class="s2">&quot;localhost:30002&quot;</span>
      <span class="p">,</span> <span class="s2">&quot;arbiterOnly&quot;</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre>
<p>So let's have a look at what this configuration means. The top level <tt class="docutils literal">_id</tt> field is the <tt class="docutils literal">name</tt> of the replicaset. When we started the <tt class="docutils literal">mongod</tt> processes earlier we passed in an argument <tt class="docutils literal"><span class="pre">--replSet</span> test</tt>. This marks the <tt class="docutils literal">mongod</tt> process as being a part of a replicaset named <tt class="docutils literal">test</tt>. Our configuration's <tt class="docutils literal">_id</tt> field needs to match this name so we set it to <tt class="docutils literal">test</tt> aswell. The <tt class="docutils literal">version</tt> field is the version of this document. The reason this exists is that we can change the configuration of a replicaset at runtime and MongoDB uses the version number to ensure that we cannot revert to an older version (each new configuration needs to have an increasing version number).</p>
<p>The last part is a field called <tt class="docutils literal">members</tt> that contains an array of documents, one for each of the servers in the replicaset. Let's look at them.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="mi">0</span>
  <span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="o">:</span> <span class="s2">&quot;localhost:30000&quot;</span>
<span class="p">}</span>

<span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="o">:</span> <span class="s2">&quot;localhost:30001&quot;</span>
<span class="p">}</span>
</pre>
<p>The two first documents each have a <tt class="docutils literal">_id</tt> and <tt class="docutils literal">host</tt> field. The <tt class="docutils literal">_id</tt> field is a unique identifier inside the replicaset for that specific server. The <tt class="docutils literal">host</tt> field contains the host and port for the server.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
      <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="mi">2</span>
    <span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="o">:</span> <span class="s2">&quot;localhost:30002&quot;</span>
    <span class="p">,</span> <span class="s2">&quot;arbiterOnly&quot;</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre>
<p>Notice that the last document has an <tt class="docutils literal">arbiterOnly</tt> tag? That is because this last server is only going to be running as an arbiter for server elections (we will cover what elections are in a little bit) and will not service any reads or writes.</p>
<p>So as you obviously have figured out there are some potential parameters that can be added to this configuration file. Let's go through all of the available ones as of MongoDB 2.4.</p>
<div class="section" id="top-level-fields">
<h4><a class="toc-backref" href="#id126">Top Level Fields</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="20%" />
<col width="57%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Value</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>_id</td>
<td>string</td>
<td>The name of the replicaset</td>
</tr>
<tr><td>members</td>
<td>array</td>
<td>The array of members that are in the replicaset</td>
</tr>
<tr><td>settings</td>
<td>doc</td>
<td>Settings that apply to all servers in the replicaset</td>
</tr>
</tbody>
</table>
<p>Let's look at the fields we can define in a member document.</p>
</div>
<div class="section" id="member-fields">
<h4><a class="toc-backref" href="#id127">Member Fields</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="7%" />
<col width="6%" />
<col width="87%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Value (Default)</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>chainingAllowed</td>
<td>boolean (true)</td>
<td>If true let's secondary to replicate from other secondaries instead of just the primary</td>
</tr>
<tr><td>getLastErrorDefaults</td>
<td>doc</td>
<td>Default behavior for getLastError command if none are provided from the driver</td>
</tr>
<tr><td>getLastErrorModes</td>
<td>doc</td>
<td>Let's you set up getLastError shortnames that move the configuration details of a write concern to the server configuration. One example might be a <tt class="docutils literal">MultipleDC</tt> write concern that means different things in different server environment or might change over time.</td>
</tr>
</tbody>
</table>
<p>Similarly the settings field can have several different options</p>
</div>
<div class="section" id="settings-fields">
<h4><a class="toc-backref" href="#id128">Settings Fields</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="7%" />
<col width="6%" />
<col width="87%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Value (Default)</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>_id</td>
<td>ordinal</td>
<td>The zero-indexed identifier of every member in the replicaset</td>
</tr>
<tr><td>host</td>
<td>host:port</td>
<td>The host/port location of the member (ex: &quot;localhost:30000&quot;)</td>
</tr>
<tr><td>arbiterOnly</td>
<td>boolean (false)</td>
<td>Sets if the server is an arbiter</td>
</tr>
<tr><td>buildIndexes</td>
<td>boolean (true)</td>
<td>Determines if <tt class="docutils literal">mongod</tt> builds indexes on this member</td>
</tr>
<tr><td>hidden</td>
<td>boolean (false)</td>
<td>If set the server is hidden and not included in the command <tt class="docutils literal">isMaster</tt> meaning no reads or writes will go to this server</td>
</tr>
<tr><td>priority</td>
<td>integer (1)</td>
<td>The server with the highest priority becomes more eligible to become primary in a replicaset. If you set the priority to <tt class="docutils literal">0</tt> the node can never become a primary.</td>
</tr>
<tr><td>tags</td>
<td>doc</td>
<td>Allows you to tag a specific server with arbitrary tags that can be used to mark servers f.ex with geographical location. The tags can be used from the driver to f.ex direct reads to closer servers (only read from tags tagged with Germany from German application servers)</td>
</tr>
<tr><td>slaveDelay</td>
<td>integer (0)</td>
<td>Allows you to tell the server to lag <tt class="docutils literal">X</tt> seconds behind the primary. Can be used to ensure you have a window of recovery if data is corrupted on the primary.</td>
</tr>
</tbody>
</table>
<p>Alright let's get connected and configure the replicaset so it will be up and running.</p>
<pre class="code javascript literal-block">
<span class="o">~</span> <span class="nx">$</span> <span class="nx">mongo</span> <span class="o">--</span><span class="nx">port</span> <span class="mi">30000</span>
<span class="nx">MongoDB</span> <span class="nx">shell</span> <span class="nx">version</span><span class="o">:</span> <span class="mf">2.4</span><span class="p">.</span><span class="mi">3</span>
<span class="nx">connecting</span> <span class="nx">to</span><span class="o">:</span> <span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">30000</span><span class="o">/</span><span class="nx">test</span>
<span class="o">&gt;</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="mi">1</span>
<span class="p">,</span> <span class="s2">&quot;members&quot;</span><span class="o">:</span> <span class="p">[</span><span class="p">{</span> <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="o">:</span> <span class="s2">&quot;localhost:30000&quot;</span><span class="p">}</span>
<span class="p">,</span><span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="o">:</span> <span class="s2">&quot;localhost:30001&quot;</span><span class="p">}</span>
<span class="p">,</span><span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="o">:</span> <span class="s2">&quot;localhost:30002&quot;</span><span class="p">,</span> <span class="s2">&quot;arbiterOnly&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">}]}</span>
<span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
  <span class="s2">&quot;version&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;members&quot;</span> <span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;host&quot;</span> <span class="o">:</span> <span class="s2">&quot;localhost:30000&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">&quot;host&quot;</span> <span class="o">:</span> <span class="s2">&quot;localhost:30001&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">&quot;host&quot;</span> <span class="o">:</span> <span class="s2">&quot;localhost:30002&quot;</span><span class="p">,</span>
      <span class="s2">&quot;arbiterOnly&quot;</span> <span class="o">:</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
<span class="o">&gt;</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">initiate</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
<span class="p">{</span>
  <span class="s2">&quot;info&quot;</span> <span class="o">:</span> <span class="s2">&quot;Config now saved locally.  Should come online in about a minute.&quot;</span><span class="p">,</span>
  <span class="s2">&quot;ok&quot;</span> <span class="o">:</span> <span class="mi">1</span>
<span class="p">}</span>
<span class="nx">test</span><span class="o">:</span><span class="nx">STARTUP2</span><span class="o">&gt;</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="p">)</span>
<span class="p">{</span>
  <span class="s2">&quot;set&quot;</span> <span class="o">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
  <span class="s2">&quot;date&quot;</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2013-05-29T12:51:48Z&quot;</span><span class="p">),</span>
  <span class="s2">&quot;myState&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;members&quot;</span> <span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;localhost:30000&quot;</span><span class="p">,</span>
      <span class="s2">&quot;health&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">&quot;state&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">&quot;stateStr&quot;</span> <span class="o">:</span> <span class="s2">&quot;PRIMARY&quot;</span><span class="p">,</span>
      <span class="s2">&quot;uptime&quot;</span> <span class="o">:</span> <span class="mi">2573</span><span class="p">,</span>
      <span class="s2">&quot;optime&quot;</span> <span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;t&quot;</span> <span class="o">:</span> <span class="mi">1369831875</span><span class="p">,</span>
        <span class="s2">&quot;i&quot;</span> <span class="o">:</span> <span class="mi">1</span>
      <span class="p">},</span>
      <span class="s2">&quot;optimeDate&quot;</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2013-05-29T12:51:15Z&quot;</span><span class="p">),</span>
      <span class="s2">&quot;self&quot;</span> <span class="o">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;localhost:30001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;health&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">&quot;state&quot;</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">&quot;stateStr&quot;</span> <span class="o">:</span> <span class="s2">&quot;SECONDARY&quot;</span><span class="p">,</span>
      <span class="s2">&quot;uptime&quot;</span> <span class="o">:</span> <span class="mi">33</span><span class="p">,</span>
      <span class="s2">&quot;optime&quot;</span> <span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;t&quot;</span> <span class="o">:</span> <span class="mi">1369831875</span><span class="p">,</span>
        <span class="s2">&quot;i&quot;</span> <span class="o">:</span> <span class="mi">1</span>
      <span class="p">},</span>
      <span class="s2">&quot;optimeDate&quot;</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2013-05-29T12:51:15Z&quot;</span><span class="p">),</span>
      <span class="s2">&quot;lastHeartbeat&quot;</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2013-05-29T12:51:47Z&quot;</span><span class="p">),</span>
      <span class="s2">&quot;lastHeartbeatRecv&quot;</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;1970-01-01T00:00:00Z&quot;</span><span class="p">),</span>
      <span class="s2">&quot;pingMs&quot;</span> <span class="o">:</span> <span class="mi">0</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;localhost:30002&quot;</span><span class="p">,</span>
      <span class="s2">&quot;health&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">&quot;state&quot;</span> <span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
      <span class="s2">&quot;stateStr&quot;</span> <span class="o">:</span> <span class="s2">&quot;ARBITER&quot;</span><span class="p">,</span>
      <span class="s2">&quot;uptime&quot;</span> <span class="o">:</span> <span class="mi">31</span><span class="p">,</span>
      <span class="s2">&quot;lastHeartbeat&quot;</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2013-05-29T12:51:47Z&quot;</span><span class="p">),</span>
      <span class="s2">&quot;lastHeartbeatRecv&quot;</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;1970-01-01T00:00:00Z&quot;</span><span class="p">),</span>
      <span class="s2">&quot;pingMs&quot;</span> <span class="o">:</span> <span class="mi">0</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="s2">&quot;ok&quot;</span> <span class="o">:</span> <span class="mi">1</span>
<span class="p">}</span>
</pre>
<p>I might take a little while before <tt class="docutils literal">rs.status()</tt> returns with a result similar to the one above. Just be patient it will eventually finish starting up and get to a stable state. You should see one <tt class="docutils literal">primary</tt> server, one <tt class="docutils literal">secondary</tt> server and an <tt class="docutils literal">arbiter</tt>.</p>
<p>We are now up and running let's fire up our editor and get connected.</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:30000/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to the database&quot;</span><span class="p">);</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="p">);</span>
<span class="p">});</span>
</pre>
<p>Only a single address in the <tt class="docutils literal">connect</tt> function you might ask? The reason is because the replicaset is self discovering. You need only point to a single member of the replicaset for it to discover the other members. Obviously more than on address is better as the connection will fail if that single <tt class="docutils literal">seed</tt> server it not up when the application tries to connect. Let's change it slightly to reflect this.</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:30000,localhost:30001/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to the database&quot;</span><span class="p">);</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="p">);</span>
<span class="p">});</span>
</pre>
<p>That's it when it comes to connecting to the Replicaset from your application. Now let's discover one of the more powerful aspects of the replicasets, namely read preferences.</p>
</div>
</div>
<div class="section" id="read-preferences">
<h3><a class="toc-backref" href="#id129">Read Preferences</a></h3>
<p>One of the things introduces in 2.2 or higher is the concept of read preferences. The reason was to allow more flexibility to the application developer in where their application reads from. Say you don't need up to the millisecond updated data (say a content management system where you publish articles). Since you have a replicaset it would be useful to read from one of the <tt class="docutils literal">secondaries</tt> instead of from the <tt class="docutils literal">primary</tt> so you could scale your reads by leveraging the multiple <tt class="docutils literal">secondaries</tt> you have in your replicaset. Or maybe you need the application reads only to go against local data center <tt class="docutils literal">secondaries</tt> that are replicated across from another datacenter. That's where read preferences and tags come in. Let's quickly look at an overview of the possible read preference concepts the driver has.</p>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="84%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Read Preference</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Primary</td>
<td>The read should only go to the primary</td>
</tr>
<tr><td>Primary Preferred</td>
<td>The read should go to the primary if available but two a secondary if not available</td>
</tr>
<tr><td>Secondary</td>
<td>The read should go to a secondary only</td>
</tr>
<tr><td>Secondary Preferred</td>
<td>The read should go to the primary only if a secondary is not available</td>
</tr>
<tr><td>Nearest</td>
<td>The read should go to the nearest server (including secondaries and primary) within an acceptable latency period</td>
</tr>
</tbody>
</table>
<p>As you can see the read preferences give you control over how your read's should behave. The second part of the read preferences are the tags.</p>
<p>As we saw above you can add a field called <tt class="docutils literal">tags</tt> for a <tt class="docutils literal">member</tt> document in the replicaset configuration. Tags can be used to identify a server as having some specific location or anything else you can think off. Let's look at an example configuration with tags.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;test&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="s2">&quot;members&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="mi">0</span>
      <span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="o">:</span> <span class="s2">&quot;localhost:30000&quot;</span>
      <span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;dc&quot;</span><span class="o">:</span> <span class="s2">&quot;ny&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="mi">1</span>
      <span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="o">:</span> <span class="s2">&quot;localhost:30001&quot;</span>
      <span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;dc&quot;</span><span class="o">:</span> <span class="s2">&quot;ny&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="mi">2</span>
      <span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="o">:</span> <span class="s2">&quot;localhost:30002&quot;</span>
      <span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;dc&quot;</span><span class="o">:</span> <span class="s2">&quot;sf&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre>
<p>In this configuration we have one <tt class="docutils literal">primary</tt> and two <tt class="docutils literal">secondaries</tt>. Notice how we have added the <tt class="docutils literal">&quot;dc&quot;: &quot;ny&quot;</tt> tag to the two first servers indicating that they are physically located in New York. The last one has the tag <tt class="docutils literal">&quot;dc&quot;: &quot;sf&quot;</tt> indicating it's located in San Francisco. In a bit we will see how we can use the tags to direct our reads to a server with a specific tag.</p>
<p>So how do we use read preference with the driver? It's fairly simple as we will see, but first we need to understand the inheritance of read preferences in the driver. Let's have a look at our connection example from above but this time we will set a read preference.</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:30000/test?readPreference=primaryPreferred&quot;</span>
  <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to the database&quot;</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">articles</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'articles'</span><span class="p">);</span>

      <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="p">);</span>
  <span class="p">});</span>
</pre>
<p>The <tt class="docutils literal">db</tt> instance returned will have it's read preference set to <tt class="docutils literal">primaryPreferred</tt> and the <tt class="docutils literal">articles</tt> collection instance will inherit the read preference settings from the <tt class="docutils literal">db</tt>, meaning all read operations using the <tt class="docutils literal">articles</tt> collection will use <tt class="docutils literal">primaryPreferred</tt>. But what if we need to override the collections <tt class="docutils literal">read preference</tt> as we intend reads to happen from a <tt class="docutils literal">secondary</tt> not from a <tt class="docutils literal">primary</tt>. Luckily this is fairly easy. Let's see how.</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">MongoClient</span>
  <span class="p">,</span> <span class="nx">ReadPreference</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">ReadPreference</span><span class="p">;</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:30000/test?readPreference=primaryPreferred&quot;</span>
  <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to the database&quot;</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">articles</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'articles'</span>
        <span class="p">,</span> <span class="p">{</span><span class="nx">readPreference</span><span class="o">:</span> <span class="nx">ReadPreference</span><span class="p">.</span><span class="nx">SECONDARY_PREFERRED</span><span class="p">});</span>

      <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="p">);</span>
  <span class="p">});</span>
</pre>
<p>Any read operations on the <tt class="docutils literal">articles</tt> collection will now be executed with the <tt class="docutils literal">secondaryPreferred</tt> read preference instead of the default one for the database <tt class="docutils literal">primaryPreferred</tt>. Even then imagine that there is a particular query we want to ensure is run against the <tt class="docutils literal">primary</tt> instead of a secondary. Luckily that's possible as well. Let's see how.</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">MongoClient</span>
  <span class="p">,</span> <span class="nx">ReadPreference</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">ReadPreference</span><span class="p">;</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:30000/test?readPreference=primaryPreferred&quot;</span>
  <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to the database&quot;</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">articles</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'articles'</span>
        <span class="p">,</span> <span class="p">{</span><span class="nx">readPreference</span><span class="o">:</span> <span class="nx">ReadPreference</span><span class="p">.</span><span class="nx">SECONDARY_PREFERRED</span><span class="p">});</span>

      <span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">articles</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="p">{</span><span class="p">},</span> <span class="p">{</span><span class="nx">readPreference</span><span class="o">:</span> <span class="nx">ReadPreference</span><span class="p">.</span><span class="nx">PRIMARY</span><span class="p">});</span>

      <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="p">);</span>
  <span class="p">});</span>
</pre>
<p>The <tt class="docutils literal">cursor</tt> returned from the <tt class="docutils literal">find</tt> method will now have the <tt class="docutils literal">primary</tt> read preference instead of the <tt class="docutils literal">secondaryPreferred</tt> specified in it's collection instance. So as you can see you can read preferences down to the individual query issues against the replicaset. Most of the read preferences are fairly simple but the <tt class="docutils literal">nearest</tt> one require a bit more explanation. The idea of the <tt class="docutils literal">nearest</tt> read preference is to attempt to steer the queries to the server that's the closest. This might sound like it's always the closest one but in fact it's not always true. The definition is actually the closest inside an acceptable latency window from the server with the lowest current pingtime. There is an optional parameter that can be passed into <tt class="docutils literal">MongoClient.connect</tt> that lets you change the value, but the default is <tt class="docutils literal">15ms</tt>. So how does it work.</p>
<p>The driver will ping all <tt class="docutils literal">secondaries</tt> and the <tt class="docutils literal">primary</tt> at a regular interval. Saw we get the following results.</p>
<table border="1" class="docutils">
<colgroup>
<col width="57%" />
<col width="43%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Server</th>
<th class="head">Ping Time</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>localhost:30000</td>
<td>1 ms</td>
</tr>
<tr><td>localhost:30001</td>
<td>10 ms</td>
</tr>
<tr><td>localhost:30001</td>
<td>50 ms</td>
</tr>
</tbody>
</table>
<p>The driver establishes the lowest ping time to be <tt class="docutils literal">1 ms</tt> and since the <tt class="docutils literal">acceptable</tt> latency window is <tt class="docutils literal">15 ms</tt> only servers with a ping time less than <tt class="docutils literal">16 ms</tt> will be candidates for reads.</p>
<table border="1" class="docutils">
<colgroup>
<col width="57%" />
<col width="43%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Server</th>
<th class="head">Ping Time</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>localhost:30000</td>
<td>1 ms</td>
</tr>
<tr><td>localhost:30001</td>
<td>10 ms</td>
</tr>
</tbody>
</table>
<p>In our case that will be servers <tt class="docutils literal">localhost:30000</tt> and <tt class="docutils literal">localhost:30001</tt>. So how can you change the acceptable latency window? Let's take a quick look.</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:30000/test?readPreference=nearest&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">replSet</span><span class="o">:</span> <span class="p">{</span><span class="nx">secondaryAcceptableLatencyMS</span><span class="o">:</span> <span class="mi">50</span><span class="p">}</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="p">);</span>
<span class="p">});</span>
</pre>
<p>We changed the acceptable latency window to <tt class="docutils literal">50ms</tt> which in our example above would not include all tree servers as possible candidates for reads.</p>
<p>But what if our application should only read from the San Francisco <tt class="docutils literal">secondary</tt>. Let's see how that is accomplished.</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">MongoClient</span>
  <span class="p">,</span> <span class="nx">ReadPreference</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">ReadPreference</span><span class="p">;</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:30000/test?&quot;</span>
  <span class="o">+</span> <span class="s2">&quot;readPreference=secondaryPreferred&quot;</span>
  <span class="o">+</span> <span class="s2">&quot;&amp;readPreferenceTags=dc:sf&quot;</span>
  <span class="o">+</span> <span class="s2">&quot;&amp;readPreferenceTags=dc:ny&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to the database&quot;</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">articles</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'articles'</span>
      <span class="p">,</span> <span class="p">{</span><span class="nx">readPreference</span><span class="o">:</span> <span class="nx">ReadPreference</span><span class="p">.</span><span class="nx">SECONDARY_PREFERRED</span><span class="p">});</span>

    <span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">articles</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="p">{</span><span class="p">},</span> <span class="p">{</span><span class="nx">readPreference</span><span class="o">:</span> <span class="nx">ReadPreference</span><span class="p">.</span><span class="nx">PRIMARY</span><span class="p">});</span>

    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="p">);</span>
  <span class="p">});</span>
</pre>
<p>Let's have a look at the connection string. Notice <tt class="docutils literal">readPreferenceTags=dc:sf</tt> and <tt class="docutils literal">readPreferenceTags=dc:ny</tt>. These tells the driver to prefer servers that are tagged with <tt class="docutils literal"><span class="pre">&quot;dc&quot;:&quot;df&quot;</span></tt> before any tagged with <tt class="docutils literal"><span class="pre">&quot;dc&quot;:&quot;ny&quot;</span></tt>. The order of the <tt class="docutils literal">readPreferenceTags=dc:ny</tt> matter as the first one will be the most important one. Just as in the previous example tags can be overridden at a <tt class="docutils literal">collection</tt> and individual <tt class="docutils literal">query</tt> level. Let's see how.</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">MongoClient</span>
  <span class="p">,</span> <span class="nx">ReadPreference</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">ReadPreference</span><span class="p">;</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:30000/test?&quot;</span>
  <span class="o">+</span> <span class="s2">&quot;readPreference=secondaryPreferred&quot;</span>
  <span class="o">+</span> <span class="s2">&quot;&amp;readPreferenceTags=dc:sf&quot;</span>
  <span class="o">+</span> <span class="s2">&quot;&amp;readPreferenceTags=dc:ny&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to the database&quot;</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">articles</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'articles'</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">articles</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="p">{</span><span class="p">}</span>
      <span class="p">,</span> <span class="p">{</span><span class="nx">readPreference</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ReadPreference</span><span class="p">(</span><span class="nx">ReadPreference</span><span class="p">.</span><span class="nx">PRIMARY</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;dc&quot;</span><span class="o">:</span> <span class="s2">&quot;ny&quot;</span><span class="p">}});</span>

    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="p">);</span>
  <span class="p">});</span>
</pre>
<p>We create an instance of the <tt class="docutils literal">ReadPreference</tt> class pass in the desired tags as the second parameter of the constructor. The <tt class="docutils literal">cursor</tt> from the <tt class="docutils literal">articles.find</tt> will now attempt to read from the New York tagged server instead of the San Francisco one.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">Tags can be used to create some fairly sophisticated read topologies in your application such as allowing the application to be aware of the geographical location of your servers. When we look at sharding we will see the tags put to some fairly sophisticated uses.</p>
</div>
</div>
</div>
<div class="section" id="tic-tac-toe-exercise-1">
<h2><a class="toc-backref" href="#id130">Tic-Tac-Toe: Exercise 1</a></h2>
<p>We are going to build ourselves a brand new super high-tech multiplayer Tic-Tac-Toe game (and the crowd goes wild). During these exercises we will learn about exiting technologies such as <tt class="docutils literal">SocketIO</tt> and <tt class="docutils literal">Express JS`, two of the most popular ``NPM</tt> modules, as well as <tt class="docutils literal">MongoDB</tt>, of course. The application is built slightly differently than what you might be used to if you've written other classic web applications. It's 100% client driven and dynamic. Yes, you read that right. It's Javascript powered all the way down. A single controller renders HTML and only a single template. The rest is all rendered in the client using <tt class="docutils literal">Mustache</tt> to create an awesome next generation Tic-Tac-Toe worthy of the title of the best multiplayer Tic-Tac-Toe game ever (irony noted).</p>
<div class="section" id="where-is-the-code">
<h3><a class="toc-backref" href="#id131">Where Is The Code</a></h3>
<p>The code for this exercise is located at</p>
<p><a class="reference external" href="https://github.com/christkv/tic-tac-toe-steps/tree/step0">https://github.com/christkv/tic-tac-toe-steps/tree/step0</a></p>
</div>
<div class="section" id="architecture">
<h3><a class="toc-backref" href="#id132">Architecture</a></h3>
<p>Let's look at why we picked <tt class="docutils literal">SocketIO</tt> for communication. <tt class="docutils literal">SocketIO</tt> is an abstraction library for message passing between the client and server. It's got full support for websockets but also has fallback mechanisms if Websockets is not available in the browser. This makes it a great choice for games like Tic-Tac-Toe that do not have strong realtime requirements which need to be able to reliably deliver 25 messages a second.</p>
<p>The main goal is to build our application as a set of API methods that model the interactions between the front (client side javascript) and the server code. This makes the interactions between the client and the server a defined set and gives us some structure for our application so we can extend it in the future.</p>
<p>The first realization is that there are two types of interactions in our application: those initiated by the client (ex: get a list of all available gamers) and those initiated by either the server or another client via the server (ex: player one invites player two to play a game). That means a calling <tt class="docutils literal">API</tt> as well as event handling. Having this in mind, let's look at what kind of actions we need in our fancy Tic-Tac-Toe game.</p>
<p>From the client (browser) there are several actions that we need to consider in relation to the game such as finding the list of available gamers, logging in, inviting a player to a game and actually playing the game by putting down markers.</p>
<table border="1" class="docutils">
<colgroup>
<col width="34%" />
<col width="66%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Action</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>register</td>
<td>Attempt to register a new user</td>
</tr>
<tr><td>login</td>
<td>Attempt to perform a login of an existing user</td>
</tr>
<tr><td>find_all_available_gamers</td>
<td>Locate all logged on gamers</td>
</tr>
<tr><td>invite_gamer</td>
<td>Invite another gamer to participate in a new game</td>
</tr>
<tr><td>decline_game</td>
<td>Decline an invitation to participate in a game</td>
</tr>
<tr><td>accept_game</td>
<td>Accept an invitation to participate in a game</td>
</tr>
<tr><td>place_marker</td>
<td>Attempt to place a new marker on a board</td>
</tr>
<tr><td>send_message</td>
<td>Send a chat message to another player during a game</td>
</tr>
<tr><td>leave_game</td>
<td>The player wishes to leave a game in progress</td>
</tr>
</tbody>
</table>
<p>We've outlined the actions a client can perform to interact with the server or other players. However, what are the types of messages the client needs to listen to? Let's list them out.</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="82%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Event</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>init</td>
<td>Server calls back with initial state information when <tt class="docutils literal">SocketIO</tt> connects</td>
</tr>
<tr><td>game_move</td>
<td>A valid placement of a marker on the board was performed by the other player</td>
</tr>
<tr><td>game_over</td>
<td>The game is over, returns the state of the game (who won or if it's a draw)</td>
</tr>
<tr><td>game_invite</td>
<td>Another user invites the player to a game</td>
</tr>
<tr><td>chat_message</td>
<td>A chat message is received by the gamer</td>
</tr>
<tr><td>gamer_joined</td>
<td>A new gamer joins the system (lets us update the list of gamers we can play)</td>
</tr>
<tr><td>disconnected</td>
<td>A player leaves a game currently in progress</td>
</tr>
</tbody>
</table>
<p>The simple idea is to model the application interactions as an <tt class="docutils literal">API</tt> where the calls go over <tt class="docutils literal">SocketIO</tt>. This allows us to write the application in a more thick client style without having to rely on server logic and define the boundary between the server and the client. Some of you might point out that there are libraries to help do this already but the core idea of this exercise is to show the basic principals behind such libraries so that you can understand them better and make a more enlightened choice for your own future applications.</p>
<p>So let's get started with the first steps.</p>
</div>
<div class="section" id="mac-osx-and-linux">
<h3><a class="toc-backref" href="#id133">Mac OSX and Linux</a></h3>
<p>Go to the directory where you want to store your application and let's set up the basics.</p>
<pre class="code console literal-block">
<span class="go">mkdir tic-tac-toe
cd tic-tac-toe
npm init</span>
</pre>
<p><tt class="docutils literal">NPM</tt> will ask you a lot of questions. Fill them in as you see fit. Once you're done, you need to edit the newly created <tt class="docutils literal">package.json</tt> file. So, open it in your editor and add the <tt class="docutils literal">dependencies</tt> part. The repository version looks like this.</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;tic-tac-toe-steps&quot;</span><span class="p">,</span>
  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.1&quot;</span><span class="p">,</span>
  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;ERROR: No README.md file found!&quot;</span><span class="p">,</span>
  <span class="nt">&quot;main&quot;</span><span class="p">:</span> <span class="s2">&quot;app.js&quot;</span><span class="p">,</span>
  <span class="nt">&quot;scripts&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;test&quot;</span><span class="p">:</span> <span class="s2">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;mongodb&quot;</span><span class="p">:</span> <span class="s2">&quot;1.2.9&quot;</span><span class="p">,</span>
    <span class="nt">&quot;express&quot;</span><span class="p">:</span> <span class="s2">&quot;3.0.4&quot;</span><span class="p">,</span>
    <span class="nt">&quot;cookie&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.5&quot;</span><span class="p">,</span>
    <span class="nt">&quot;socket.io&quot;</span><span class="p">:</span> <span class="s2">&quot;0.9.13&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;repository&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="nt">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="nt">&quot;license&quot;</span><span class="p">:</span> <span class="s2">&quot;BSD&quot;</span>
<span class="p">}</span>
</pre>
<p>Notice the part called <tt class="docutils literal">dependencies</tt>. This tells NPM that the application needs to use the <tt class="docutils literal">MongoDB</tt> driver as well as <tt class="docutils literal">Express JS</tt>, <tt class="docutils literal">SocketIO</tt> and an utility module called <tt class="docutils literal">cookie</tt>.</p>
<pre class="code console literal-block">
<span class="go">npm install</span>
</pre>
<p><tt class="docutils literal">NPM</tt> will now download the declared dependencies. Once <tt class="docutils literal">NPM</tt> finishes we need to <tt class="docutils literal">bootstrap</tt> the application or in other words set up the initial structure. Let's boot up the console and create our directory structure as well as grab the libraries like <tt class="docutils literal">bootstrap</tt>, <tt class="docutils literal">jquery</tt>, <tt class="docutils literal">mustache</tt> and the images we need for the board.</p>
<pre class="code console literal-block">
<span class="go">mkdir public
mkdir public/javascripts
mkdir public/css
mkdir public/templates
mkdir public/img
mkdir lib
mkdir lib/controllers
mkdir lib/handlers
mkdir lib/models
mkdir lib/views
touch app.js
touch env.js
touch public/javascripts/app.js
touch public/javascripts/api.js
touch public/javascripts/template_handler.js
touch public/css/app.css
curl http://www.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js &gt;
public/javascripts/bootstrap.min.js
curl http://www.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap.css &gt;
public/css/bootstrap.css
curl http://www.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-responsive.css &gt;
public/css/bootstrap-responsive.css
curl http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js &gt;
public/javascripts/jquery.js
curl http://cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.0/mustache.min.js &gt;
public/javascripts/mustache.js
curl https://raw.github.com/christkv/tic-tac-toe/master/public/img/board_background_img.
png &gt; public/img/board_background_img.png
curl https://raw.github.com/christkv/tic-tac-toe/master/public/img/circle.png &gt;
public/img/circle.png
curl https://raw.github.com/christkv/tic-tac-toe/master/public/img/cross.png &gt;
public/img/cross.png
curl https://raw.github.com/christkv/tic-tac-toe/master/public/img/glyphicons-halflings-
white.png &gt; public/img/glyphicons-halflings-white.png
curl https://raw.github.com/christkv/tic-tac-toe/master/public/img/glyphicons-halflings.
png &gt; public/img/glyphicons-halflings.png</span>
</pre>
<p>Right we are set for the basic structure of the application. Let's get cracking on the first part of the application. The places to start are the <tt class="docutils literal">app.js</tt> and the <tt class="docutils literal">env.js</tt> files.</p>
</div>
<div class="section" id="app-js">
<h3><a class="toc-backref" href="#id134">App.js</a></h3>
<p>First, let's have a look at the <tt class="docutils literal">app.js</tt> file. Fire up your preferred code editor and type in the code.</p>
<div class="highlight"><pre><a name="code--tic--tic1--tic1.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">env</span>                               <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./env&#39;</span><span class="p">)</span>
<a name="code--tic--tic1--tic1.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">main_controller</span>                   <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/controllers/main_controller&#39;</span><span class="p">);</span>
<a name="code--tic--tic1--tic1.js-pyg.html-3"></a>
<a name="code--tic--tic1--tic1.js-pyg.html-4"></a><span class="nx">env</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic1.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
<a name="code--tic--tic1--tic1.js-pyg.html-6"></a>
<a name="code--tic--tic1--tic1.js-pyg.html-7"></a>  <span class="c1">//</span>
<a name="code--tic--tic1--tic1.js-pyg.html-8"></a>  <span class="c1">// http routes</span>
<a name="code--tic--tic1--tic1.js-pyg.html-9"></a>  <span class="c1">//</span>
<a name="code--tic--tic1--tic1.js-pyg.html-10"></a>  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">main_controller</span><span class="p">.</span><span class="nx">index</span><span class="p">());</span>
<a name="code--tic--tic1--tic1.js-pyg.html-11"></a>
<a name="code--tic--tic1--tic1.js-pyg.html-12"></a>  <span class="c1">//</span>
<a name="code--tic--tic1--tic1.js-pyg.html-13"></a>  <span class="c1">// websocket api end point handlers (our API)</span>
<a name="code--tic--tic1--tic1.js-pyg.html-14"></a>  <span class="c1">//</span>
<a name="code--tic--tic1--tic1.js-pyg.html-15"></a>  <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic1.js-pyg.html-16"></a>
<a name="code--tic--tic1--tic1.js-pyg.html-17"></a>    <span class="c1">// Fire the init message to setup the game</span>
<a name="code--tic--tic1--tic1.js-pyg.html-18"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">event</span><span class="o">:</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="nx">ok</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">});</span>
<a name="code--tic--tic1--tic1.js-pyg.html-19"></a>  <span class="p">});</span>
<a name="code--tic--tic1--tic1.js-pyg.html-20"></a>
<a name="code--tic--tic1--tic1.js-pyg.html-21"></a>  <span class="c1">//</span>
<a name="code--tic--tic1--tic1.js-pyg.html-22"></a>  <span class="c1">// fire up the server</span>
<a name="code--tic--tic1--tic1.js-pyg.html-23"></a>  <span class="c1">//  </span>
<a name="code--tic--tic1--tic1.js-pyg.html-24"></a>  <span class="nx">env</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic1.js-pyg.html-25"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
<a name="code--tic--tic1--tic1.js-pyg.html-26"></a>
<a name="code--tic--tic1--tic1.js-pyg.html-27"></a>    <span class="c1">//</span>
<a name="code--tic--tic1--tic1.js-pyg.html-28"></a>    <span class="c1">// nothing to do</span>
<a name="code--tic--tic1--tic1.js-pyg.html-29"></a>    <span class="c1">//</span>
<a name="code--tic--tic1--tic1.js-pyg.html-30"></a>  <span class="p">});</span>
<a name="code--tic--tic1--tic1.js-pyg.html-31"></a><span class="p">});</span>
</pre></div><p>Something to notice here is that we have hidden most of the plumbing of the application in the <tt class="docutils literal">env.js</tt> file but that we are setting up the <tt class="docutils literal">controllers</tt> and <tt class="docutils literal">SocketIO</tt> in the <tt class="docutils literal">app.js</tt> file. The function <tt class="docutils literal"><span class="pre">app.get('/',</span> <span class="pre">....)</span></tt> maps the handler <tt class="docutils literal">main_controller.index()</tt> to the root of the web address (if the server is running on <tt class="docutils literal">localhost</tt> and port <tt class="docutils literal">3000</tt> it would map to <tt class="docutils literal"><span class="pre">http://localhost:3000</span></tt>). Let's have a quick look at <tt class="docutils literal">main_controller.js</tt></p>
<div class="highlight"><pre><a name="code--tic--tic1--tic2.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
<a name="code--tic--tic1--tic2.js-pyg.html-2"></a>
<a name="code--tic--tic1--tic2.js-pyg.html-3"></a><span class="cm">/**</span>
<a name="code--tic--tic1--tic2.js-pyg.html-4"></a><span class="cm"> * Returns the actual starting page of the game</span>
<a name="code--tic--tic1--tic2.js-pyg.html-5"></a><span class="cm"> */</span>
<a name="code--tic--tic1--tic2.js-pyg.html-6"></a><span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic1--tic2.js-pyg.html-7"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic2.js-pyg.html-8"></a>    <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/../views/index.html&#39;</span><span class="p">);</span>
<a name="code--tic--tic1--tic2.js-pyg.html-9"></a>    <span class="nx">response</span><span class="p">.</span><span class="nx">sendfile</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
<a name="code--tic--tic1--tic2.js-pyg.html-10"></a>  <span class="p">}</span>
<a name="code--tic--tic1--tic2.js-pyg.html-11"></a><span class="p">}</span>
<a name="code--tic--tic1--tic2.js-pyg.html-12"></a>
<a name="code--tic--tic1--tic2.js-pyg.html-13"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">index</span><span class="p">;</span>
</pre></div><p>Notice how the <tt class="docutils literal">index</tt> function returns a function that takes a request and a response parameter. Returning a function lets us do things like <tt class="docutils literal">index(db)</tt> and create a function that knows about a shared <tt class="docutils literal">MongoDB</tt> database object (we are creating a function in a scope where the db object exists). In the next exercise we will see how this is used to create handlers for the <tt class="docutils literal">SocketIO</tt> based <tt class="docutils literal">API</tt>. The <tt class="docutils literal">index</tt> controller reads the file <tt class="docutils literal">lib/views/index.html</tt> and sends it to the browser. The <tt class="docutils literal">index.html</tt> file contains the start screen of our Tic-Tac-Toe application. Fire up your editor and enter it.</p>
<div class="highlight"><pre><a name="code--tic--tic1--tic3.html-pyg.html-1"></a><span class="cp">&lt;!DOCTYPE html&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-2"></a><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span> <span class="na">ng-app=</span><span class="s">&quot;app&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-3"></a>  <span class="nt">&lt;head&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-4"></a>    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-5"></a>    <span class="nt">&lt;title&gt;</span>Tic-Tac-Toe<span class="nt">&lt;/title&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-6"></a>
<a name="code--tic--tic1--tic3.html-pyg.html-7"></a>    <span class="c">&lt;!-- Le styles --&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-8"></a>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/css/bootstrap.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-9"></a>    <span class="nt">&lt;style </span><span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-10"></a>      <span class="nt">body</span> <span class="p">{</span>
<a name="code--tic--tic1--tic3.html-pyg.html-11"></a>        <span class="k">padding-top</span><span class="o">:</span> <span class="m">60px</span><span class="p">;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-12"></a>        <span class="k">padding-bottom</span><span class="o">:</span> <span class="m">40px</span><span class="p">;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-13"></a>      <span class="p">}</span>
<a name="code--tic--tic1--tic3.html-pyg.html-14"></a>    <span class="nt">&lt;/style&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-15"></a>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/css/bootstrap-responsive.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-16"></a>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/css/app.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-17"></a>  <span class="nt">&lt;/head&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-18"></a>  <span class="nt">&lt;body&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-19"></a>    <span class="nt">&lt;div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-20"></a>      <span class="nt">&lt;ng</span><span class="na">-view</span><span class="nt">&gt;</span><span class="err">&lt;</span>/ng-view&gt;
<a name="code--tic--tic1--tic3.html-pyg.html-21"></a>    <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-22"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/jquery.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-23"></a>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/socket.io/socket.io.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-24"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/api.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-25"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/template_handler.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-26"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/mustache.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-27"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/bootstrap.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-28"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/app.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-29"></a>
<a name="code--tic--tic1--tic3.html-pyg.html-30"></a>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-31"></a>
<a name="code--tic--tic1--tic3.html-pyg.html-32"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-inverse navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-33"></a>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-34"></a>          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-35"></a>            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-navbar&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;collapse&quot;</span> <span class="na">data-target=</span><span class="s">&quot;.nav-collapse&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-36"></a>              <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-37"></a>              <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-38"></a>              <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-39"></a>            <span class="nt">&lt;/a&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-40"></a>            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;brand&quot;</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Tic-Tac-Toe<span class="nt">&lt;/a&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-41"></a>          <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-42"></a>        <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-43"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-44"></a>
<a name="code--tic--tic1--tic3.html-pyg.html-45"></a>      <span class="c">&lt;!-- Main hero unit for a primary marketing message or call to action --&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-46"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;hero-unit&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-47"></a>        <span class="nt">&lt;h1&gt;</span>Tic Tac Toe!<span class="nt">&lt;/h1&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-48"></a>        <span class="nt">&lt;p&gt;</span>Play Tic Tac Toe against your friends in this multiplayer demo.<span class="nt">&lt;/p&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-49"></a>        <span class="nt">&lt;p&gt;&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary btn-large&quot;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-50"></a>          <span class="na">href=</span><span class="s">&quot;https://github.com/christkv/tic-tac-toe&quot;</span><span class="nt">&gt;</span>Github <span class="ni">&amp;raquo;</span><span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-51"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-52"></a>
<a name="code--tic--tic1--tic3.html-pyg.html-53"></a>      <span class="c">&lt;!-- Example row of columns --&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-54"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span> <span class="na">id=</span><span class="s">&quot;view&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-55"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-56"></a>
<a name="code--tic--tic1--tic3.html-pyg.html-57"></a>      <span class="nt">&lt;hr&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-58"></a>
<a name="code--tic--tic1--tic3.html-pyg.html-59"></a>      <span class="nt">&lt;footer&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-60"></a>        <span class="nt">&lt;p&gt;</span><span class="ni">&amp;copy;</span> Christian Kvalheim 2012<span class="nt">&lt;/p&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-61"></a>      <span class="nt">&lt;/footer&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-62"></a>
<a name="code--tic--tic1--tic3.html-pyg.html-63"></a>    <span class="nt">&lt;/div&gt;</span> <span class="c">&lt;!-- /container --&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-64"></a>    <span class="c">&lt;!-- Modal --&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-65"></a>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;status_box&quot;</span> <span class="na">class=</span><span class="s">&quot;modal hide fade&quot;</span> <span class="na">tabindex=</span><span class="s">&quot;-1&quot;</span> <span class="na">role=</span><span class="s">&quot;dialog&quot;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-66"></a>    <span class="na">aria-labelledby=</span><span class="s">&quot;status_box&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-67"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-header&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-68"></a>        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;button&quot;</span> <span class="na">class=</span><span class="s">&quot;close&quot;</span> <span class="na">data-dismiss=</span><span class="s">&quot;modal&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-69"></a>          ×
<a name="code--tic--tic1--tic3.html-pyg.html-70"></a>        <span class="nt">&lt;/button&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-71"></a>        <span class="nt">&lt;h3</span> <span class="na">id=</span><span class="s">&quot;status_box_header&quot;</span><span class="nt">&gt;</span>Modal header<span class="nt">&lt;/h3&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-72"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-73"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-body&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-74"></a>        <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;status_box_body&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-75"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-76"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-footer&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-77"></a>        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">&quot;btn&quot;</span> <span class="na">data-dismiss=</span><span class="s">&quot;modal&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>Close<span class="nt">&lt;/button&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-78"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-79"></a>    <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-80"></a>  <span class="nt">&lt;/body&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-81"></a><span class="nt">&lt;/html&gt;</span>
</pre></div><p>If you are wondering how this HTML works I suggest you have a look at <a class="reference external" href="http://twitter.github.com/bootstrap/index.html">http://twitter.github.com/bootstrap/index.html</a> for documentation. In short, it lets people like me with lesser well developed design abilities create websites that are not complete eyesores. Also, notice that we are including the javascript files for <tt class="docutils literal">api.js</tt>, <tt class="docutils literal">app.js</tt> and <tt class="docutils literal">template_handler.js</tt> that we <tt class="docutils literal">touched</tt> when we created the initial directory structure. These will include the actual logic for the client side part of the game and their secrets will be revealed in due time.</p>
</div>
<div class="section" id="env-js">
<h3><a class="toc-backref" href="#id135">Env.js</a></h3>
<p>Let's take a quick look at <tt class="docutils literal">env.js</tt> file. If you remember the <tt class="docutils literal">app.js</tt> file you would have noticed that it contained two methods that did not exist in the <tt class="docutils literal">app.js</tt> file. The first one was <tt class="docutils literal">initialize</tt> and the second one was <tt class="docutils literal">run</tt>. Open up your editor and bring up the <tt class="docutils literal">env.js</tt> file and get coding.</p>
<div class="highlight"><pre><a name="code--tic--tic1--tic4.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)</span>
<a name="code--tic--tic1--tic4.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">).</span><span class="nx">MongoClient</span>
<a name="code--tic--tic1--tic4.js-pyg.html-3"></a>  <span class="p">,</span> <span class="nx">format</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">).</span><span class="nx">format</span>
<a name="code--tic--tic1--tic4.js-pyg.html-4"></a>  <span class="p">,</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>
<a name="code--tic--tic1--tic4.js-pyg.html-5"></a>  <span class="p">,</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">).</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
<a name="code--tic--tic1--tic4.js-pyg.html-6"></a>  <span class="p">,</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
<a name="code--tic--tic1--tic4.js-pyg.html-7"></a>  <span class="p">,</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cookie&#39;</span><span class="p">);</span>
<a name="code--tic--tic1--tic4.js-pyg.html-8"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-9"></a><span class="cm">/** </span>
<a name="code--tic--tic1--tic4.js-pyg.html-10"></a><span class="cm"> * Setting for the application</span>
<a name="code--tic--tic1--tic4.js-pyg.html-11"></a><span class="cm"> */</span>
<a name="code--tic--tic1--tic4.js-pyg.html-12"></a><span class="kd">var</span> <span class="nx">MONGO_DB_URL</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MONGO_DB</span> <span class="o">||</span> <span class="s1">&#39;mongodb://localhost:27017/tic-tac-toe&#39;</span><span class="p">;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-13"></a><span class="kd">var</span> <span class="nx">APP_HOST</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">APP_HOST</span> <span class="o">||</span> <span class="s1">&#39;localhost&#39;</span><span class="p">;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-14"></a><span class="kd">var</span> <span class="nx">APP_PORT</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">APP_PORT</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-15"></a><span class="kd">var</span> <span class="nx">SESSION_SECRET</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SESSION_SECRET</span> <span class="o">||</span> <span class="s1">&#39;CHANGE_ME&#39;</span><span class="p">;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-16"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-17"></a><span class="cm">/** </span>
<a name="code--tic--tic1--tic4.js-pyg.html-18"></a><span class="cm"> * Keeps the db connection</span>
<a name="code--tic--tic1--tic4.js-pyg.html-19"></a><span class="cm"> */</span>
<a name="code--tic--tic1--tic4.js-pyg.html-20"></a><span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-21"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-22"></a><span class="cm">/**</span>
<a name="code--tic--tic1--tic4.js-pyg.html-23"></a><span class="cm"> * Session store, for production use mongo</span>
<a name="code--tic--tic1--tic4.js-pyg.html-24"></a><span class="cm"> */</span>
<a name="code--tic--tic1--tic4.js-pyg.html-25"></a><span class="kd">var</span> <span class="nx">session_store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">express</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">MemoryStore</span><span class="p">();</span>
<a name="code--tic--tic1--tic4.js-pyg.html-26"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-27"></a><span class="cm">/**</span>
<a name="code--tic--tic1--tic4.js-pyg.html-28"></a><span class="cm"> * Set up the environment for the application</span>
<a name="code--tic--tic1--tic4.js-pyg.html-29"></a><span class="cm"> */</span>
<a name="code--tic--tic1--tic4.js-pyg.html-30"></a><span class="kd">var</span> <span class="nx">initialize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-31"></a>  <span class="cm">/**</span>
<a name="code--tic--tic1--tic4.js-pyg.html-32"></a><span class="cm">   * configure express</span>
<a name="code--tic--tic1--tic4.js-pyg.html-33"></a><span class="cm">   */</span>
<a name="code--tic--tic1--tic4.js-pyg.html-34"></a>  <span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="s1">&#39;development&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-35"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">());</span>
<a name="code--tic--tic1--tic4.js-pyg.html-36"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">cookieParser</span><span class="p">());</span>
<a name="code--tic--tic1--tic4.js-pyg.html-37"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/public&#39;</span><span class="p">));</span>
<a name="code--tic--tic1--tic4.js-pyg.html-38"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">errorHandler</span><span class="p">({</span> <span class="nx">dumpExceptions</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">showStack</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}));</span>
<a name="code--tic--tic1--tic4.js-pyg.html-39"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">session</span><span class="p">({</span>
<a name="code--tic--tic1--tic4.js-pyg.html-40"></a>      <span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;sid&#39;</span><span class="p">,</span>
<a name="code--tic--tic1--tic4.js-pyg.html-41"></a>      <span class="nx">secret</span><span class="o">:</span> <span class="nx">SESSION_SECRET</span><span class="p">,</span>
<a name="code--tic--tic1--tic4.js-pyg.html-42"></a>      <span class="nx">store</span><span class="o">:</span> <span class="nx">session_store</span>
<a name="code--tic--tic1--tic4.js-pyg.html-43"></a>    <span class="p">}));</span>
<a name="code--tic--tic1--tic4.js-pyg.html-44"></a>  <span class="p">});</span>
<a name="code--tic--tic1--tic4.js-pyg.html-45"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-46"></a>  <span class="cm">/**</span>
<a name="code--tic--tic1--tic4.js-pyg.html-47"></a><span class="cm">   * Capture the session id and make it available</span>
<a name="code--tic--tic1--tic4.js-pyg.html-48"></a><span class="cm">   */</span>
<a name="code--tic--tic1--tic4.js-pyg.html-49"></a>  <span class="nx">io</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;authorization&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">accept</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-50"></a>    <span class="c1">// check if there&#39;s a cookie header</span>
<a name="code--tic--tic1--tic4.js-pyg.html-51"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;cookie&#39;</span><span class="p">])</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-52"></a>      <span class="c1">// if there is, parse the cookie</span>
<a name="code--tic--tic1--tic4.js-pyg.html-53"></a>      <span class="nx">data</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span><span class="p">);</span>
<a name="code--tic--tic1--tic4.js-pyg.html-54"></a>      <span class="c1">// note that you will need to use the same key to grad the</span>
<a name="code--tic--tic1--tic4.js-pyg.html-55"></a>      <span class="c1">// session id, as you specified in the Express setup.</span>
<a name="code--tic--tic1--tic4.js-pyg.html-56"></a>      <span class="nx">data</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">cookie</span><span class="p">[</span><span class="s1">&#39;sid&#39;</span><span class="p">];</span>
<a name="code--tic--tic1--tic4.js-pyg.html-57"></a>      <span class="c1">// Set the user as authenticated in on the express session</span>
<a name="code--tic--tic1--tic4.js-pyg.html-58"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-59"></a>        <span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a name="code--tic--tic1--tic4.js-pyg.html-60"></a>      <span class="p">}</span>
<a name="code--tic--tic1--tic4.js-pyg.html-61"></a>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-62"></a>     <span class="c1">// if there isn&#39;t, turn down the connection with a message</span>
<a name="code--tic--tic1--tic4.js-pyg.html-63"></a>     <span class="c1">// and leave the function.</span>
<a name="code--tic--tic1--tic4.js-pyg.html-64"></a>     <span class="k">return</span> <span class="nx">accept</span><span class="p">(</span><span class="s1">&#39;No cookie transmitted.&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<a name="code--tic--tic1--tic4.js-pyg.html-65"></a>    <span class="p">}</span>
<a name="code--tic--tic1--tic4.js-pyg.html-66"></a>    <span class="c1">// accept the incoming connection</span>
<a name="code--tic--tic1--tic4.js-pyg.html-67"></a>    <span class="nx">accept</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<a name="code--tic--tic1--tic4.js-pyg.html-68"></a>  <span class="p">});</span>
<a name="code--tic--tic1--tic4.js-pyg.html-69"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-70"></a>  <span class="cm">/**</span>
<a name="code--tic--tic1--tic4.js-pyg.html-71"></a><span class="cm">   * Connect to MongoDB and start the server</span>
<a name="code--tic--tic1--tic4.js-pyg.html-72"></a><span class="cm">   */</span>
<a name="code--tic--tic1--tic4.js-pyg.html-73"></a>  <span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">MONGO_DB_URL</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">_db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-74"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--tic--tic1--tic4.js-pyg.html-75"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-76"></a>    <span class="c1">// Save the db reference</span>
<a name="code--tic--tic1--tic4.js-pyg.html-77"></a>    <span class="nx">db</span> <span class="o">=</span> <span class="nx">_db</span><span class="p">;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-78"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-79"></a>    <span class="c1">// Return the callback</span>
<a name="code--tic--tic1--tic4.js-pyg.html-80"></a>    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">);</span>
<a name="code--tic--tic1--tic4.js-pyg.html-81"></a>  <span class="p">});</span>
<a name="code--tic--tic1--tic4.js-pyg.html-82"></a><span class="p">};</span>
<a name="code--tic--tic1--tic4.js-pyg.html-83"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-84"></a><span class="kd">var</span> <span class="nx">run</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-85"></a>  <span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">APP_PORT</span><span class="p">,</span> <span class="nx">APP_HOST</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-86"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-87"></a>      <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--tic--tic1--tic4.js-pyg.html-88"></a>      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--tic--tic1--tic4.js-pyg.html-89"></a>    <span class="p">}</span>
<a name="code--tic--tic1--tic4.js-pyg.html-90"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-91"></a>    <span class="c1">// Print out a nice message to the console</span>
<a name="code--tic--tic1--tic4.js-pyg.html-92"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
<a name="code--tic--tic1--tic4.js-pyg.html-93"></a>        <span class="p">[</span> <span class="s2">&quot;&quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-94"></a>        <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-95"></a>        <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-96"></a>        <span class="p">,</span> <span class="s2">&quot;  — — — | — — — | — — — &quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-97"></a>        <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-98"></a>        <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-99"></a>        <span class="p">,</span> <span class="s2">&quot;  — — — | — — — | — — — &quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-100"></a>        <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-101"></a>        <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-102"></a>        <span class="p">,</span> <span class="s2">&quot;&quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-103"></a>        <span class="p">,</span> <span class="s2">&quot;tic-tac-toe server v&quot;</span> <span class="o">+</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./package.json&#39;</span><span class="p">).</span><span class="nx">version</span>
<a name="code--tic--tic1--tic4.js-pyg.html-104"></a>        <span class="p">,</span> <span class="s2">&quot;listening on port &quot;</span> <span class="o">+</span> <span class="nx">APP_PORT</span> <span class="o">+</span> <span class="s2">&quot; and host &quot;</span> <span class="o">+</span> <span class="nx">APP_HOST</span>
<a name="code--tic--tic1--tic4.js-pyg.html-105"></a>      <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">));</span>
<a name="code--tic--tic1--tic4.js-pyg.html-106"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-107"></a>    <span class="c1">// Return successful start of server</span>
<a name="code--tic--tic1--tic4.js-pyg.html-108"></a>    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a name="code--tic--tic1--tic4.js-pyg.html-109"></a>  <span class="p">});</span>
<a name="code--tic--tic1--tic4.js-pyg.html-110"></a><span class="p">}</span>
<a name="code--tic--tic1--tic4.js-pyg.html-111"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-112"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">initialize</span> <span class="o">=</span> <span class="nx">initialize</span><span class="p">;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-113"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">run</span> <span class="o">=</span> <span class="nx">run</span><span class="p">;</span>
</pre></div><p>So, what do the methods do? Well, the <tt class="docutils literal">intialize</tt> function sets up the <tt class="docutils literal">Express JS</tt> web framework with a <tt class="docutils literal">session</tt> store and a location for static file serving of all files under the <tt class="docutils literal">/public</tt> directory which lets us access the javascripts, css and image files from the browser. At the top of the file, you'll notice the three core lines.</p>
<pre class="code javascript literal-block">
<span class="p">,</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">(</span><span class="p">)</span>
<span class="p">,</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">).</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
<span class="p">,</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'socket.io'</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
</pre>
<p>This sets up an <tt class="docutils literal">Express JS</tt> instance and maps <tt class="docutils literal">SocketIO</tt> to the same socket so they can work together. The <tt class="docutils literal">SocketIO</tt> instance is stored in the variable <tt class="docutils literal">io</tt>. One of the things we need to ensure is that our <tt class="docutils literal">SocketIO</tt> instance can be associated with the initial web page the user loaded through a <tt class="docutils literal">Session Cookie</tt>. To do this, we need to do some mapping between the <tt class="docutils literal">SocketIO</tt> instance and the server session using our <tt class="docutils literal">Session</tt> Store. Luckily <tt class="docutils literal">SocketIO</tt> has thought about this.</p>
<p>The <tt class="docutils literal"><span class="pre">io.set('authorization',</span> <span class="pre">...)</span></tt> event occurs when the web page is first loaded and a <tt class="docutils literal">SocketIO</tt> connection is made. When the connection happens, the code looks up the <tt class="docutils literal">Session Cookie</tt> set by <tt class="docutils literal">Express JS</tt> and adds it to the <tt class="docutils literal">SocketIO</tt> connection. This makes it possible for the application to identify which user is associated with which <tt class="docutils literal">SocketIO</tt> connection and future exercises will show how we use this to communicate between two specific users.</p>
<p>Lastly, we call <tt class="docutils literal">MongoClient.connect</tt> to connect to the <tt class="docutils literal">MongoDB</tt> server and if all works well, we'll return to the calling code in <tt class="docutils literal">app.js</tt>. When <tt class="docutils literal">app.js</tt> calls the <tt class="docutils literal">run</tt> method in <tt class="docutils literal">env.js</tt>, the <tt class="docutils literal">Express JS</tt> server starts up and we print the welcome message to the console. Before we can boot up, we need a <tt class="docutils literal">MongoDB</tt> server. Open another terminal and go to the project directory. Let's start a new server.</p>
<pre class="code console literal-block">
<span class="go">mkdir data
mongod --dbpath=./data</span>
</pre>
<p>In your previous terminal, start the application (make sure your node.js executable is in your path).</p>
<pre class="code console literal-block">
<span class="go">node app.js</span>
</pre>
<p>You can now go to <tt class="docutils literal"><span class="pre">http://localhost:3000</span></tt> and see the initial page running in your browser. Awesome, right? Now that we have the basic scaffolding in place, we can move on to the next exercise where we will create the <tt class="docutils literal">login</tt> and <tt class="docutils literal">registration</tt> API's.</p>
</div>
</div>
<div class="section" id="tic-tac-toe-exercise-2">
<h2><a class="toc-backref" href="#id136">Tic-Tac-Toe: Exercise 2</a></h2>
<p>Welcome back it's time to start implementing the first parts of our game. In this exercise we will focus on the registration and login process for the game allowing our marks (I mean potential tic-tac-toe players) to register as players and to return to wet their addiction in the future with a user and password. Since we want to keep the registration process as simple as possible we are going to just remove such fancy things as email verification or captchas (feel free to add this if you fear an avalanche of 419 scammers).</p>
<p>As we touched on in the last exercise we decided to go with an API over <tt class="docutils literal">SocketIO</tt> as it's all the rage (at least in 2013 when this was written) and we've forgone any fancy frameworks like <tt class="docutils literal">meteor</tt>, <tt class="docutils literal">geddy</tt> or <tt class="docutils literal">socketstream</tt> to make it very clear what's going on (I hope).</p>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id137">Where Is The Code</a></h3>
<p>The code for this exercise is located at</p>
<p><a class="reference external" href="https://github.com/christkv/tic-tac-toe-steps/tree/step1">https://github.com/christkv/tic-tac-toe-steps/tree/step1</a></p>
</div>
<div class="section" id="it-s-like-lego-but-with-code">
<h3><a class="toc-backref" href="#id138">It's Like LEGO But With Code</a></h3>
<p>Let's create the files we are going to be using in our exercise.</p>
<pre class="code console literal-block">
<span class="go">touch lib/handlers/login_handler.js
touch lib/models/shared.js
touch lib/models/user.js
touch lib/models/gamer.js</span>
</pre>
<p>We are going to need two API calls for our registration and login process. The first method one is to <tt class="docutils literal">register</tt> a new user and the second method, is to allow an existing user to <tt class="docutils literal">login</tt>. Open the <tt class="docutils literal">app.js</tt> file and add the new handlers for our API calls.</p>
<div class="highlight"><pre><a name="code--tic--tic2--tic1.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">env</span>                      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./env&#39;</span><span class="p">)</span>
<a name="code--tic--tic2--tic1.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">main_controller</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/controllers/main_controller&#39;</span><span class="p">);</span>
<a name="code--tic--tic2--tic1.js-pyg.html-3"></a>
<a name="code--tic--tic2--tic1.js-pyg.html-4"></a><span class="kd">var</span> <span class="nx">register_handler</span>         <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/login_handler&#39;</span><span class="p">).</span><span class="nx">register_handler</span>
<a name="code--tic--tic2--tic1.js-pyg.html-5"></a>  <span class="p">,</span> <span class="nx">login_handler</span>            <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/login_handler&#39;</span><span class="p">).</span><span class="nx">login_handler</span>
<a name="code--tic--tic2--tic1.js-pyg.html-6"></a>
<a name="code--tic--tic2--tic1.js-pyg.html-7"></a>
<a name="code--tic--tic2--tic1.js-pyg.html-8"></a><span class="nx">env</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic1.js-pyg.html-9"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
<a name="code--tic--tic2--tic1.js-pyg.html-10"></a>
<a name="code--tic--tic2--tic1.js-pyg.html-11"></a>  <span class="c1">//</span>
<a name="code--tic--tic2--tic1.js-pyg.html-12"></a>  <span class="c1">// http routes</span>
<a name="code--tic--tic2--tic1.js-pyg.html-13"></a>  <span class="c1">//</span>
<a name="code--tic--tic2--tic1.js-pyg.html-14"></a>  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">main_controller</span><span class="p">.</span><span class="nx">index</span><span class="p">());</span>
<a name="code--tic--tic2--tic1.js-pyg.html-15"></a>
<a name="code--tic--tic2--tic1.js-pyg.html-16"></a>  <span class="c1">//</span>
<a name="code--tic--tic2--tic1.js-pyg.html-17"></a>  <span class="c1">// websocket api end point handlers (our API)</span>
<a name="code--tic--tic2--tic1.js-pyg.html-18"></a>  <span class="c1">//</span>
<a name="code--tic--tic2--tic1.js-pyg.html-19"></a>  <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic1.js-pyg.html-20"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;register&#39;</span><span class="p">,</span> <span class="nx">register_handler</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
<a name="code--tic--tic2--tic1.js-pyg.html-21"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="nx">login_handler</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
<a name="code--tic--tic2--tic1.js-pyg.html-22"></a>
<a name="code--tic--tic2--tic1.js-pyg.html-23"></a>    <span class="c1">// Fire the init message to setup the game</span>
<a name="code--tic--tic2--tic1.js-pyg.html-24"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">event</span><span class="o">:</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="nx">ok</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">});</span>
<a name="code--tic--tic2--tic1.js-pyg.html-25"></a>  <span class="p">});</span>
<a name="code--tic--tic2--tic1.js-pyg.html-26"></a>
<a name="code--tic--tic2--tic1.js-pyg.html-27"></a>  <span class="c1">//</span>
<a name="code--tic--tic2--tic1.js-pyg.html-28"></a>  <span class="c1">// fire up the server</span>
<a name="code--tic--tic2--tic1.js-pyg.html-29"></a>  <span class="c1">//  </span>
<a name="code--tic--tic2--tic1.js-pyg.html-30"></a>  <span class="nx">env</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic1.js-pyg.html-31"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
<a name="code--tic--tic2--tic1.js-pyg.html-32"></a>
<a name="code--tic--tic2--tic1.js-pyg.html-33"></a>    <span class="c1">//</span>
<a name="code--tic--tic2--tic1.js-pyg.html-34"></a>    <span class="c1">// nothing to do</span>
<a name="code--tic--tic2--tic1.js-pyg.html-35"></a>    <span class="c1">//</span>
<a name="code--tic--tic2--tic1.js-pyg.html-36"></a>  <span class="p">});</span>
<a name="code--tic--tic2--tic1.js-pyg.html-37"></a><span class="p">});</span>
</pre></div><p>Notice that we are adding the handlers as events to the socket connection. This is because we are using the custom event functionality of <tt class="docutils literal">SocketIO</tt> to map our messages from the <tt class="docutils literal">frontend</tt> javascript to the backend API.</p>
<pre class="code javascript literal-block">
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'register'</span><span class="p">,</span> <span class="nx">register_handler</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'login'</span><span class="p">,</span> <span class="nx">login_handler</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
</pre>
<p>We pass in the <tt class="docutils literal">io</tt> variable that represents our <tt class="docutils literal">SocketIO</tt> instance allowing us to interact with all of the other <tt class="docutils literal">SocketIO</tt> connections. Next is the current <tt class="docutils literal">socket</tt> representing the current user, then the <tt class="docutils literal">session store</tt> so we can do such stuff as registering if the user is currently logged on or not and finally the <tt class="docutils literal">db</tt> instance so we can interact with <tt class="docutils literal">MongoDB</tt>.</p>
<p>We are defining both of these <tt class="docutils literal">handler</tt> functions in the <tt class="docutils literal">lib/handlers/login_handler.js</tt> file and then including them at the top of the file using <tt class="docutils literal">require</tt>.</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">register_handler</span>     <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./lib/handlers/login_handler'</span><span class="p">).</span><span class="nx">register_handler</span>
  <span class="p">,</span> <span class="nx">login_handler</span>        <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./lib/handlers/login_handler'</span><span class="p">).</span><span class="nx">login_handler</span>
</pre>
<p>Don't worry how these handlers look we will get back to them in a minute. First we need to talk a bit about how our data structures look.</p>
</div>
<div class="section" id="modeling-that-data">
<h3><a class="toc-backref" href="#id139">Modeling That Data</a></h3>
<p>It's quite obvious that we need some sort of entities (data structures) in our game. In this game we've decided to use the two terms <tt class="docutils literal">user</tt> and <tt class="docutils literal">gamer</tt> where <tt class="docutils literal">user</tt> is the login and user information for a particular mark(user) and gamer is the current <tt class="docutils literal">session</tt> relationship between a <tt class="docutils literal">user</tt> in <tt class="docutils literal">MongoDB</tt> and the browser the user is playing on.</p>
<p>For the user we will need a couple of functions to allow us to correctly implement a <tt class="docutils literal">registration</tt> and <a href="#id9"><span class="problematic" id="id10">``</span></a>login process`.</p>
<div class="system-message" id="id9">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">learn-x-the-hard-way.rst</tt>, line 8695); <em><a href="#id10">backlink</a></em></p>
Inline literal start-string without end-string.</div>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="76%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Function</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>findByUser</td>
<td>Locate a user object by user name</td>
</tr>
<tr><td>findByUserAndPassword</td>
<td>Locate a user by username and password, used for login verification</td>
</tr>
<tr><td>createUser</td>
<td>Create a user with his full name, user name and elected password</td>
</tr>
</tbody>
</table>
<p>Let's Implement the user module, fire up the editor again and enter.</p>
<div class="highlight"><pre><a name="code--tic--tic2--tic2.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;crypto&#39;</span><span class="p">);</span>
<a name="code--tic--tic2--tic2.js-pyg.html-2"></a>
<a name="code--tic--tic2--tic2.js-pyg.html-3"></a><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic2.js-pyg.html-4"></a>  <span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>
<a name="code--tic--tic2--tic2.js-pyg.html-5"></a>
<a name="code--tic--tic2--tic2.js-pyg.html-6"></a>  <span class="c1">//</span>
<a name="code--tic--tic2--tic2.js-pyg.html-7"></a>  <span class="c1">// Locate a user by a user name</span>
<a name="code--tic--tic2--tic2.js-pyg.html-8"></a>  <span class="c1">//</span>
<a name="code--tic--tic2--tic2.js-pyg.html-9"></a>  <span class="nx">User</span><span class="p">.</span><span class="nx">findByUser</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic2.js-pyg.html-10"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic2--tic2.js-pyg.html-11"></a>  <span class="p">}</span>
<a name="code--tic--tic2--tic2.js-pyg.html-12"></a>
<a name="code--tic--tic2--tic2.js-pyg.html-13"></a>  <span class="c1">//</span>
<a name="code--tic--tic2--tic2.js-pyg.html-14"></a>  <span class="c1">// Locate a user by user name and password</span>
<a name="code--tic--tic2--tic2.js-pyg.html-15"></a>  <span class="c1">//</span>
<a name="code--tic--tic2--tic2.js-pyg.html-16"></a>  <span class="nx">User</span><span class="p">.</span><span class="nx">findByUserAndPassword</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic2.js-pyg.html-17"></a>    <span class="c1">// Hash password</span>
<a name="code--tic--tic2--tic2.js-pyg.html-18"></a>    <span class="kd">var</span> <span class="nx">sha1</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;sha1&#39;</span><span class="p">);</span>
<a name="code--tic--tic2--tic2.js-pyg.html-19"></a>    <span class="nx">sha1</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">password</span><span class="p">);</span>
<a name="code--tic--tic2--tic2.js-pyg.html-20"></a>    <span class="c1">// Get digest</span>
<a name="code--tic--tic2--tic2.js-pyg.html-21"></a>    <span class="kd">var</span> <span class="nx">hashed_password</span> <span class="o">=</span> <span class="nx">sha1</span><span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span>
<a name="code--tic--tic2--tic2.js-pyg.html-22"></a>    <span class="c1">// Locate user</span>
<a name="code--tic--tic2--tic2.js-pyg.html-23"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">findOne</span><span class="p">(</span>
<a name="code--tic--tic2--tic2.js-pyg.html-24"></a>      <span class="p">{</span>   <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
<a name="code--tic--tic2--tic2.js-pyg.html-25"></a>        <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">hashed_password</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic2--tic2.js-pyg.html-26"></a>  <span class="p">}</span>
<a name="code--tic--tic2--tic2.js-pyg.html-27"></a>
<a name="code--tic--tic2--tic2.js-pyg.html-28"></a>  <span class="c1">//</span>
<a name="code--tic--tic2--tic2.js-pyg.html-29"></a>  <span class="c1">// Create a new user with full name and password</span>
<a name="code--tic--tic2--tic2.js-pyg.html-30"></a>  <span class="c1">//</span>
<a name="code--tic--tic2--tic2.js-pyg.html-31"></a>  <span class="nx">User</span><span class="p">.</span><span class="nx">createUser</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic2.js-pyg.html-32"></a>    <span class="c1">// Hash password</span>
<a name="code--tic--tic2--tic2.js-pyg.html-33"></a>    <span class="kd">var</span> <span class="nx">sha1</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;sha1&#39;</span><span class="p">);</span>
<a name="code--tic--tic2--tic2.js-pyg.html-34"></a>    <span class="nx">sha1</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">password</span><span class="p">);</span>
<a name="code--tic--tic2--tic2.js-pyg.html-35"></a>    <span class="c1">// Get digest</span>
<a name="code--tic--tic2--tic2.js-pyg.html-36"></a>    <span class="kd">var</span> <span class="nx">hashed_password</span> <span class="o">=</span> <span class="nx">sha1</span><span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span>
<a name="code--tic--tic2--tic2.js-pyg.html-37"></a>    <span class="c1">// Insert user</span>
<a name="code--tic--tic2--tic2.js-pyg.html-38"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">insert</span><span class="p">(</span>
<a name="code--tic--tic2--tic2.js-pyg.html-39"></a>      <span class="p">{</span>   <span class="nx">full_name</span><span class="o">:</span> <span class="nx">full_name</span>
<a name="code--tic--tic2--tic2.js-pyg.html-40"></a>        <span class="p">,</span> <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
<a name="code--tic--tic2--tic2.js-pyg.html-41"></a>        <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">hashed_password</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic2--tic2.js-pyg.html-42"></a>  <span class="p">}</span>
<a name="code--tic--tic2--tic2.js-pyg.html-43"></a>
<a name="code--tic--tic2--tic2.js-pyg.html-44"></a>  <span class="k">return</span> <span class="nx">User</span><span class="p">;</span>
<a name="code--tic--tic2--tic2.js-pyg.html-45"></a><span class="p">}</span>
</pre></div><p>There are a couple of things to notice here. The first one is the <tt class="docutils literal">module.exports = function(db)</tt>. This lets us do <tt class="docutils literal"><span class="pre">user(db).findByUser</span></tt> and apply the method <tt class="docutils literal">findByUser</tt> to the selected <tt class="docutils literal">db</tt>. Remember that in <tt class="docutils literal">Javascript</tt> a constructor is just a function so in this case <tt class="docutils literal">User</tt> which is a function is returned but since it's created inside the function <tt class="docutils literal">module.exports = function(db)</tt> <tt class="docutils literal">db</tt> is in the scope of the returned <tt class="docutils literal">User</tt> function. A useful pattern to remember.</p>
<p>Let's move on and have a look at <tt class="docutils literal">findByUserAndPassword</tt> method. We are using the <tt class="docutils literal">crypto</tt> library in <tt class="docutils literal">Node.js</tt> to encrypt the passed in password. Always remember to do this in your application. <tt class="docutils literal">NEVER</tt> store the clean word password in your database as it's a huge security risk. In this case I've picked a hashing method called <tt class="docutils literal">sha1</tt> but feel free to pick something like <tt class="docutils literal">sha256</tt> if you really want to avoid the chance of people being able to crack the password. We then turn the <tt class="docutils literal">sha'ed</tt> password into a <tt class="docutils literal">hex</tt> string and attempt to lookup a user by the user name and the <tt class="docutils literal">hex</tt> digest of the password. If no user is returned, there either is no user or the password does not match.</p>
<p>The <tt class="docutils literal">createUser</tt> method is quite similar to the <tt class="docutils literal">findByUserAndPassword</tt>, the main difference being that we are adding a user to the db instead of checking if it exists or has a valid password.</p>
<p>Let's move on to the <tt class="docutils literal">gamer</tt> model we are using to map the users browser <tt class="docutils literal">session</tt> to his database <tt class="docutils literal">user</tt>. For this one we are going to need a couple of things. First off all we are defining the <tt class="docutils literal">collection</tt> for the data as <tt class="docutils literal">time to live or TTL</tt> collection meaning that the seesions will timeout after a certain period of time (in this case 60 seconds times 60 minutes or 1 hour). The other two methods we will need is to look up a user by a <tt class="docutils literal">session</tt> and to update an existing gamer <tt class="docutils literal">session</tt>.</p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Function</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>findGamerBySid</td>
<td>Locate a gamer by his session id</td>
</tr>
<tr><td>updateGamer</td>
<td>Updates a given user with a live session id</td>
</tr>
<tr><td>init</td>
<td>Sets up the TTL collection</td>
</tr>
</tbody>
</table>
<p>Fire up the editor and implement the code below.</p>
<div class="highlight"><pre><a name="code--tic--tic2--tic3.js-pyg.html-1"></a><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic3.js-pyg.html-2"></a>  <span class="kd">var</span> <span class="nx">Gamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>
<a name="code--tic--tic2--tic3.js-pyg.html-3"></a>
<a name="code--tic--tic2--tic3.js-pyg.html-4"></a>  <span class="c1">//</span>
<a name="code--tic--tic2--tic3.js-pyg.html-5"></a>  <span class="c1">// Locate a gamer by his session id</span>
<a name="code--tic--tic2--tic3.js-pyg.html-6"></a>  <span class="c1">//</span>
<a name="code--tic--tic2--tic3.js-pyg.html-7"></a>  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">findGamerBySid</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic3.js-pyg.html-8"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">).</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">sid</span><span class="o">:</span> <span class="nx">sid</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic2--tic3.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--tic--tic2--tic3.js-pyg.html-10"></a>
<a name="code--tic--tic2--tic3.js-pyg.html-11"></a>  <span class="c1">//</span>
<a name="code--tic--tic2--tic3.js-pyg.html-12"></a>  <span class="c1">// Update a gamers current activity time and session id</span>
<a name="code--tic--tic2--tic3.js-pyg.html-13"></a>  <span class="c1">// when they come back after some time away</span>
<a name="code--tic--tic2--tic3.js-pyg.html-14"></a>  <span class="c1">//</span>
<a name="code--tic--tic2--tic3.js-pyg.html-15"></a>  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">updateGamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">sid</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic3.js-pyg.html-16"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">({</span><span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span><span class="p">}</span>
<a name="code--tic--tic2--tic3.js-pyg.html-17"></a>      <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">updated_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span> <span class="nx">sid</span><span class="o">:</span><span class="nx">sid</span><span class="p">}}</span>
<a name="code--tic--tic2--tic3.js-pyg.html-18"></a>      <span class="p">,</span> <span class="p">{</span><span class="nx">upsert</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic2--tic3.js-pyg.html-19"></a>  <span class="p">}</span>
<a name="code--tic--tic2--tic3.js-pyg.html-20"></a>
<a name="code--tic--tic2--tic3.js-pyg.html-21"></a>  <span class="c1">//</span>
<a name="code--tic--tic2--tic3.js-pyg.html-22"></a>  <span class="c1">// Initialize the gamer collection, by adding indexes etc</span>
<a name="code--tic--tic2--tic3.js-pyg.html-23"></a>  <span class="c1">//</span>
<a name="code--tic--tic2--tic3.js-pyg.html-24"></a>  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic3.js-pyg.html-25"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">).</span><span class="nx">ensureIndex</span><span class="p">({</span><span class="nx">updated_on</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span>
<a name="code--tic--tic2--tic3.js-pyg.html-26"></a>      <span class="p">,</span> <span class="p">{</span><span class="nx">expireAfterSeconds</span><span class="o">:</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)},</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic2--tic3.js-pyg.html-27"></a>  <span class="p">}</span>
<a name="code--tic--tic2--tic3.js-pyg.html-28"></a>
<a name="code--tic--tic2--tic3.js-pyg.html-29"></a>  <span class="k">return</span> <span class="nx">Gamer</span><span class="p">;</span>
<a name="code--tic--tic2--tic3.js-pyg.html-30"></a><span class="p">}</span>
</pre></div><p>Two things to notice are the <tt class="docutils literal">Gamer.init</tt> and the <tt class="docutils literal">Gamer.updateGamer</tt> methods. The first <tt class="docutils literal">Gamer.init</tt> should be run only once when we are setting up the server to ensure we have the <tt class="docutils literal">TTL</tt> index all set up on the <tt class="docutils literal">gamers</tt> collection. Let's modify the <tt class="docutils literal">env.js</tt> file.</p>
<div class="highlight"><pre><a name="code--tic--tic2--tic4.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">run</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic4.js-pyg.html-2"></a>  <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">init</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic4.js-pyg.html-3"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--tic--tic2--tic4.js-pyg.html-4"></a>
<a name="code--tic--tic2--tic4.js-pyg.html-5"></a>    <span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">APP_PORT</span><span class="p">,</span> <span class="nx">APP_HOST</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic4.js-pyg.html-6"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic4.js-pyg.html-7"></a>        <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--tic--tic2--tic4.js-pyg.html-8"></a>        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--tic--tic2--tic4.js-pyg.html-9"></a>      <span class="p">}</span>
<a name="code--tic--tic2--tic4.js-pyg.html-10"></a>
<a name="code--tic--tic2--tic4.js-pyg.html-11"></a>      <span class="c1">// Print out a nice message to the console</span>
<a name="code--tic--tic2--tic4.js-pyg.html-12"></a>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
<a name="code--tic--tic2--tic4.js-pyg.html-13"></a>          <span class="p">[</span> <span class="s2">&quot;&quot;</span>
<a name="code--tic--tic2--tic4.js-pyg.html-14"></a>          <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
<a name="code--tic--tic2--tic4.js-pyg.html-15"></a>          <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
<a name="code--tic--tic2--tic4.js-pyg.html-16"></a>          <span class="p">,</span> <span class="s2">&quot;  — — — | — — — | — — — &quot;</span>
<a name="code--tic--tic2--tic4.js-pyg.html-17"></a>          <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
<a name="code--tic--tic2--tic4.js-pyg.html-18"></a>          <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
<a name="code--tic--tic2--tic4.js-pyg.html-19"></a>          <span class="p">,</span> <span class="s2">&quot;  — — — | — — — | — — — &quot;</span>
<a name="code--tic--tic2--tic4.js-pyg.html-20"></a>          <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
<a name="code--tic--tic2--tic4.js-pyg.html-21"></a>          <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
<a name="code--tic--tic2--tic4.js-pyg.html-22"></a>          <span class="p">,</span> <span class="s2">&quot;&quot;</span>
<a name="code--tic--tic2--tic4.js-pyg.html-23"></a>          <span class="p">,</span> <span class="s2">&quot;tic-tac-toe server v&quot;</span> <span class="o">+</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./package.json&#39;</span><span class="p">).</span><span class="nx">version</span>
<a name="code--tic--tic2--tic4.js-pyg.html-24"></a>          <span class="p">,</span> <span class="s2">&quot;listening on port &quot;</span> <span class="o">+</span> <span class="nx">APP_PORT</span> <span class="o">+</span> <span class="s2">&quot; and host &quot;</span> <span class="o">+</span> <span class="nx">APP_HOST</span>
<a name="code--tic--tic2--tic4.js-pyg.html-25"></a>        <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">));</span>
<a name="code--tic--tic2--tic4.js-pyg.html-26"></a>
<a name="code--tic--tic2--tic4.js-pyg.html-27"></a>      <span class="c1">// Return successful start of server</span>
<a name="code--tic--tic2--tic4.js-pyg.html-28"></a>      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a name="code--tic--tic2--tic4.js-pyg.html-29"></a>    <span class="p">});</span>
<a name="code--tic--tic2--tic4.js-pyg.html-30"></a>  <span class="p">});</span>
<a name="code--tic--tic2--tic4.js-pyg.html-31"></a><span class="p">}</span>
</pre></div><p>Notice that we added the line <tt class="docutils literal"><span class="pre">gamer(db).init(...)</span></tt> to the <tt class="docutils literal">env.js</tt> file. This means the initialization of the <tt class="docutils literal">TTL</tt> index on the <tt class="docutils literal">gamers</tt> collection will only happen at startup and only once. We've now set up the models, let's get cracking on the backend API's for our game.</p>
</div>
<div class="section" id="handlers-for-the-win">
<h3><a class="toc-backref" href="#id140">Handlers For The Win</a></h3>
<p>We have two handlers we need to define on the server side, to allow a new user to <tt class="docutils literal">register</tt> and an existing user to <tt class="docutils literal">login</tt>. These are the <tt class="docutils literal">register_handler</tt> and <tt class="docutils literal">login_handler</tt> methods.</p>
<p>Fire up the text editor, open <tt class="docutils literal">lib/handlers/login_handler.js</tt> and get cracking on the code for the handlers by entering the following code.</p>
<div class="highlight"><pre><a name="code--tic--tic2--tic5.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">emit_message</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_message</span>
<a name="code--tic--tic2--tic5.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">emit_message_all</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_message_all</span>
<a name="code--tic--tic2--tic5.js-pyg.html-3"></a>  <span class="p">,</span> <span class="nx">emit_error</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_error</span><span class="p">;</span>
<a name="code--tic--tic2--tic5.js-pyg.html-4"></a>
<a name="code--tic--tic2--tic5.js-pyg.html-5"></a><span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/user&#39;</span><span class="p">)</span>
<a name="code--tic--tic2--tic5.js-pyg.html-6"></a>  <span class="p">,</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/gamer&#39;</span><span class="p">);</span>
<a name="code--tic--tic2--tic5.js-pyg.html-7"></a>
<a name="code--tic--tic2--tic5.js-pyg.html-8"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic5.js-pyg.html-9"></a><span class="cm"> * Register a new user</span>
<a name="code--tic--tic2--tic5.js-pyg.html-10"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic5.js-pyg.html-11"></a><span class="kd">var</span> <span class="nx">register_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic5.js-pyg.html-12"></a>  <span class="c1">// Easier to keep track of where we emitting messages</span>
<a name="code--tic--tic2--tic5.js-pyg.html-13"></a>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;register&quot;</span><span class="p">;</span>
<a name="code--tic--tic2--tic5.js-pyg.html-14"></a>
<a name="code--tic--tic2--tic5.js-pyg.html-15"></a>  <span class="c1">// Function we return that accepts the data from SocketIO</span>
<a name="code--tic--tic2--tic5.js-pyg.html-16"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic5.js-pyg.html-17"></a>    <span class="c1">// Unpack the parameters</span>
<a name="code--tic--tic2--tic5.js-pyg.html-18"></a>    <span class="kd">var</span> <span class="nx">full_name</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">full_name</span><span class="p">;</span>
<a name="code--tic--tic2--tic5.js-pyg.html-19"></a>    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">user_name</span><span class="p">;</span>
<a name="code--tic--tic2--tic5.js-pyg.html-20"></a>    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
<a name="code--tic--tic2--tic5.js-pyg.html-21"></a>
<a name="code--tic--tic2--tic5.js-pyg.html-22"></a>    <span class="c1">// Check if the user already exists</span>
<a name="code--tic--tic2--tic5.js-pyg.html-23"></a>    <span class="nx">user</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findByUser</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">_user</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic5.js-pyg.html-24"></a>      <span class="c1">// If there is there is an error when attempting to find the user</span>
<a name="code--tic--tic2--tic5.js-pyg.html-25"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic2--tic5.js-pyg.html-26"></a>
<a name="code--tic--tic2--tic5.js-pyg.html-27"></a>      <span class="c1">// The user already exists notify the client function</span>
<a name="code--tic--tic2--tic5.js-pyg.html-28"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">_user</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
<a name="code--tic--tic2--tic5.js-pyg.html-29"></a>        <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span>
<a name="code--tic--tic2--tic5.js-pyg.html-30"></a>            <span class="p">,</span> <span class="s2">&quot;User with user name &quot;</span> <span class="o">+</span> <span class="nx">user_name</span> <span class="o">+</span> <span class="s2">&quot; already exists&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic2--tic5.js-pyg.html-31"></a>
<a name="code--tic--tic2--tic5.js-pyg.html-32"></a>      <span class="c1">// The user does not exist, let&#39;s create it</span>
<a name="code--tic--tic2--tic5.js-pyg.html-33"></a>      <span class="nx">user</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">createUser</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">_user</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic5.js-pyg.html-34"></a>        <span class="c1">// There was an error during the creation of the user, emit an error message</span>
<a name="code--tic--tic2--tic5.js-pyg.html-35"></a>        <span class="c1">// to the calling client</span>
<a name="code--tic--tic2--tic5.js-pyg.html-36"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic2--tic5.js-pyg.html-37"></a>
<a name="code--tic--tic2--tic5.js-pyg.html-38"></a>        <span class="c1">// We have a legal registration, lets set up the state needed</span>
<a name="code--tic--tic2--tic5.js-pyg.html-39"></a>        <span class="c1">// and log the user in</span>
<a name="code--tic--tic2--tic5.js-pyg.html-40"></a>        <span class="nx">emit_login_or_registration_ok</span><span class="p">(</span><span class="nx">io</span>
<a name="code--tic--tic2--tic5.js-pyg.html-41"></a>          <span class="p">,</span> <span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">db</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic2--tic5.js-pyg.html-42"></a>      <span class="p">});</span>
<a name="code--tic--tic2--tic5.js-pyg.html-43"></a>    <span class="p">})</span>
<a name="code--tic--tic2--tic5.js-pyg.html-44"></a>  <span class="p">}</span>
<a name="code--tic--tic2--tic5.js-pyg.html-45"></a><span class="p">}</span>
<a name="code--tic--tic2--tic5.js-pyg.html-46"></a>
<a name="code--tic--tic2--tic5.js-pyg.html-47"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic5.js-pyg.html-48"></a><span class="cm"> * Attempt to login user</span>
<a name="code--tic--tic2--tic5.js-pyg.html-49"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic5.js-pyg.html-50"></a><span class="kd">var</span> <span class="nx">login_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic5.js-pyg.html-51"></a>  <span class="c1">// Easier to keep track of where we emitting messages</span>
<a name="code--tic--tic2--tic5.js-pyg.html-52"></a>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;login&quot;</span><span class="p">;</span>
<a name="code--tic--tic2--tic5.js-pyg.html-53"></a>
<a name="code--tic--tic2--tic5.js-pyg.html-54"></a>  <span class="c1">// Function we return that accepts the data from SocketIO</span>
<a name="code--tic--tic2--tic5.js-pyg.html-55"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic5.js-pyg.html-56"></a>    <span class="c1">// Unpack the parameters</span>
<a name="code--tic--tic2--tic5.js-pyg.html-57"></a>    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">user_name</span><span class="p">;</span>
<a name="code--tic--tic2--tic5.js-pyg.html-58"></a>    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
<a name="code--tic--tic2--tic5.js-pyg.html-59"></a>
<a name="code--tic--tic2--tic5.js-pyg.html-60"></a>    <span class="c1">// Locate the user by user name and password</span>
<a name="code--tic--tic2--tic5.js-pyg.html-61"></a>    <span class="nx">user</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findByUserAndPassword</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic5.js-pyg.html-62"></a>      <span class="c1">// If there is there is an error when attempting to find the user      </span>
<a name="code--tic--tic2--tic5.js-pyg.html-63"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic2--tic5.js-pyg.html-64"></a>      <span class="c1">// There was no user returned, meaning the user either does not exist or the</span>
<a name="code--tic--tic2--tic5.js-pyg.html-65"></a>      <span class="c1">// password is incorrect</span>
<a name="code--tic--tic2--tic5.js-pyg.html-66"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">user</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span>
<a name="code--tic--tic2--tic5.js-pyg.html-67"></a>          <span class="p">,</span> <span class="s2">&quot;User or Password is incorrect&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic2--tic5.js-pyg.html-68"></a>
<a name="code--tic--tic2--tic5.js-pyg.html-69"></a>      <span class="c1">// We have a legal login, lets set up the state needed</span>
<a name="code--tic--tic2--tic5.js-pyg.html-70"></a>      <span class="c1">// and log the user in</span>
<a name="code--tic--tic2--tic5.js-pyg.html-71"></a>      <span class="nx">emit_login_or_registration_ok</span><span class="p">(</span><span class="nx">io</span>
<a name="code--tic--tic2--tic5.js-pyg.html-72"></a>        <span class="p">,</span> <span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">db</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic2--tic5.js-pyg.html-73"></a>    <span class="p">});</span>
<a name="code--tic--tic2--tic5.js-pyg.html-74"></a>  <span class="p">}</span>
<a name="code--tic--tic2--tic5.js-pyg.html-75"></a><span class="p">}</span>
<a name="code--tic--tic2--tic5.js-pyg.html-76"></a>
<a name="code--tic--tic2--tic5.js-pyg.html-77"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic5.js-pyg.html-78"></a><span class="cm"> * Updates the gamer status and sets up the session as being authenticated, finally</span>
<a name="code--tic--tic2--tic5.js-pyg.html-79"></a><span class="cm"> * returns the gamer data to all other clients that are connected signaling a new</span>
<a name="code--tic--tic2--tic5.js-pyg.html-80"></a><span class="cm"> * player is available</span>
<a name="code--tic--tic2--tic5.js-pyg.html-81"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic5.js-pyg.html-82"></a><span class="kd">var</span> <span class="nx">emit_login_or_registration_ok</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span><span class="nx">event</span><span class="p">,</span><span class="nx">db</span><span class="p">,</span><span class="nx">session_store</span><span class="p">,</span><span class="nx">user_name</span><span class="p">,</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic5.js-pyg.html-83"></a>  <span class="c1">// Easier to keep track of where we emitting messages</span>
<a name="code--tic--tic2--tic5.js-pyg.html-84"></a>  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;gamer_joined&quot;</span><span class="p">;</span>
<a name="code--tic--tic2--tic5.js-pyg.html-85"></a>
<a name="code--tic--tic2--tic5.js-pyg.html-86"></a>  <span class="c1">// Update the current gamer with the new session id and update the last updated date time</span>
<a name="code--tic--tic2--tic5.js-pyg.html-87"></a>  <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">updateGamer</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic5.js-pyg.html-88"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic2--tic5.js-pyg.html-89"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="s2">&quot;Failed to Save user as active&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic2--tic5.js-pyg.html-90"></a>
<a name="code--tic--tic2--tic5.js-pyg.html-91"></a>    <span class="c1">// Set authenticated on the session</span>
<a name="code--tic--tic2--tic5.js-pyg.html-92"></a>    <span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">].</span><span class="nx">user_name</span> <span class="o">=</span> <span class="nx">user_name</span><span class="p">;</span>
<a name="code--tic--tic2--tic5.js-pyg.html-93"></a>
<a name="code--tic--tic2--tic5.js-pyg.html-94"></a>    <span class="c1">// Return succesful login (including setting up user as logged in)</span>
<a name="code--tic--tic2--tic5.js-pyg.html-95"></a>    <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic2--tic5.js-pyg.html-96"></a>      <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
<a name="code--tic--tic2--tic5.js-pyg.html-97"></a>    <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic2--tic5.js-pyg.html-98"></a>
<a name="code--tic--tic2--tic5.js-pyg.html-99"></a>    <span class="c1">// Find the gamer so we can send the info</span>
<a name="code--tic--tic2--tic5.js-pyg.html-100"></a>    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findGamerBySid</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic5.js-pyg.html-101"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<a name="code--tic--tic2--tic5.js-pyg.html-102"></a>
<a name="code--tic--tic2--tic5.js-pyg.html-103"></a>      <span class="c1">// Fire off gamer joined to all connections minus our own</span>
<a name="code--tic--tic2--tic5.js-pyg.html-104"></a>      <span class="nx">emit_message_all</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">event_name</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic2--tic5.js-pyg.html-105"></a>          <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
<a name="code--tic--tic2--tic5.js-pyg.html-106"></a>        <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">gamer</span>
<a name="code--tic--tic2--tic5.js-pyg.html-107"></a>      <span class="p">},</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">);</span>
<a name="code--tic--tic2--tic5.js-pyg.html-108"></a>    <span class="p">});</span>
<a name="code--tic--tic2--tic5.js-pyg.html-109"></a>  <span class="p">});</span>
<a name="code--tic--tic2--tic5.js-pyg.html-110"></a><span class="p">}</span>
<a name="code--tic--tic2--tic5.js-pyg.html-111"></a>
<a name="code--tic--tic2--tic5.js-pyg.html-112"></a><span class="c1">// Export functions</span>
<a name="code--tic--tic2--tic5.js-pyg.html-113"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">register_handler</span> <span class="o">=</span> <span class="nx">register_handler</span><span class="p">;</span>
<a name="code--tic--tic2--tic5.js-pyg.html-114"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">login_handler</span> <span class="o">=</span> <span class="nx">login_handler</span><span class="p">;</span>
</pre></div></div>
<div class="section" id="the-register-handler-function">
<h3><a class="toc-backref" href="#id141">The register_handler Function</a></h3>
<p>Let's have a look at the <tt class="docutils literal">register_handler</tt> method that handles the registration of a new user to the game. The first thing you'll notice is that we return a <tt class="docutils literal">function</tt>. This is used to create a unique function tied to the specific connection's socket. The returned function responds to any messages sent via <tt class="docutils literal">SocketIO</tt> with the event <tt class="docutils literal">register</tt>.</p>
<p><tt class="docutils literal">SocketIO</tt> will return a <tt class="docutils literal">data</tt> object that contains <tt class="docutils literal">full_name</tt>, <tt class="docutils literal">user_name</tt> and <tt class="docutils literal">password</tt>. The first step is to check if the user already exists by calling the <tt class="docutils literal">findByUser</tt> method on the <tt class="docutils literal">User</tt> model we have. If there is one we call a method called <tt class="docutils literal">emit_error</tt> that is defined in the file <tt class="docutils literal">lib/models/shared.js</tt>. Let's have a quick look at <tt class="docutils literal">emit_error</tt> in <tt class="docutils literal">lib/models/shared.js</tt></p>
<div class="highlight"><pre><a name="code--tic--tic2--tic6.js-pyg.html-1"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic6.js-pyg.html-2"></a><span class="cm"> * Emit the standard error message across the SocketIO connection</span>
<a name="code--tic--tic2--tic6.js-pyg.html-3"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic6.js-pyg.html-4"></a><span class="kd">var</span> <span class="nx">emit_error</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic6.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">socket</span><span class="p">))</span> <span class="p">{</span>
<a name="code--tic--tic2--tic6.js-pyg.html-6"></a>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic6.js-pyg.html-7"></a>      <span class="nx">socket</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic2--tic6.js-pyg.html-8"></a>          <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
<a name="code--tic--tic2--tic6.js-pyg.html-9"></a>        <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--tic--tic2--tic6.js-pyg.html-10"></a>        <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span><span class="kc">true</span>
<a name="code--tic--tic2--tic6.js-pyg.html-11"></a>        <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
<a name="code--tic--tic2--tic6.js-pyg.html-12"></a>      <span class="p">});</span>
<a name="code--tic--tic2--tic6.js-pyg.html-13"></a>    <span class="p">}</span>
<a name="code--tic--tic2--tic6.js-pyg.html-14"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--tic--tic2--tic6.js-pyg.html-15"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic2--tic6.js-pyg.html-16"></a>        <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
<a name="code--tic--tic2--tic6.js-pyg.html-17"></a>      <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--tic--tic2--tic6.js-pyg.html-18"></a>      <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span><span class="kc">true</span>
<a name="code--tic--tic2--tic6.js-pyg.html-19"></a>      <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
<a name="code--tic--tic2--tic6.js-pyg.html-20"></a>    <span class="p">});</span>
<a name="code--tic--tic2--tic6.js-pyg.html-21"></a>  <span class="p">}</span>
<a name="code--tic--tic2--tic6.js-pyg.html-22"></a><span class="p">}</span>
<a name="code--tic--tic2--tic6.js-pyg.html-23"></a>
<a name="code--tic--tic2--tic6.js-pyg.html-24"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic6.js-pyg.html-25"></a><span class="cm"> * Emit the standard message across the SocketIO connection</span>
<a name="code--tic--tic2--tic6.js-pyg.html-26"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic6.js-pyg.html-27"></a><span class="kd">var</span> <span class="nx">emit_message</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic6.js-pyg.html-28"></a>  <span class="c1">// Add event</span>
<a name="code--tic--tic2--tic6.js-pyg.html-29"></a>  <span class="nx">message</span><span class="p">.</span><span class="nx">event</span> <span class="o">=</span> <span class="nx">event</span><span class="p">;</span>
<a name="code--tic--tic2--tic6.js-pyg.html-30"></a>  <span class="c1">// Emit</span>
<a name="code--tic--tic2--tic6.js-pyg.html-31"></a>  <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
<a name="code--tic--tic2--tic6.js-pyg.html-32"></a><span class="p">}</span>
<a name="code--tic--tic2--tic6.js-pyg.html-33"></a>
<a name="code--tic--tic2--tic6.js-pyg.html-34"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic6.js-pyg.html-35"></a><span class="cm"> * Emit a message to all clients minus the excluded session id connection</span>
<a name="code--tic--tic2--tic6.js-pyg.html-36"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic6.js-pyg.html-37"></a><span class="kd">var</span> <span class="nx">emit_message_all</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">exclude_sid</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic6.js-pyg.html-38"></a>  <span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">clients</span><span class="p">();</span>
<a name="code--tic--tic2--tic6.js-pyg.html-39"></a>
<a name="code--tic--tic2--tic6.js-pyg.html-40"></a>  <span class="c1">// Locate our session id</span>
<a name="code--tic--tic2--tic6.js-pyg.html-41"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic6.js-pyg.html-42"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">!=</span> <span class="nx">exclude_sid</span>
<a name="code--tic--tic2--tic6.js-pyg.html-43"></a>      <span class="o">&amp;&amp;</span> <span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span>
<a name="code--tic--tic2--tic6.js-pyg.html-44"></a>      <span class="o">&amp;&amp;</span> <span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">].</span><span class="nx">user_name</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic6.js-pyg.html-45"></a>      <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<a name="code--tic--tic2--tic6.js-pyg.html-46"></a>    <span class="p">}</span>
<a name="code--tic--tic2--tic6.js-pyg.html-47"></a>  <span class="p">}</span>
<a name="code--tic--tic2--tic6.js-pyg.html-48"></a><span class="p">}</span>
<a name="code--tic--tic2--tic6.js-pyg.html-49"></a>
<a name="code--tic--tic2--tic6.js-pyg.html-50"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">emit_error</span>                      <span class="o">=</span> <span class="nx">emit_error</span><span class="p">;</span>
<a name="code--tic--tic2--tic6.js-pyg.html-51"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">emit_message</span>                    <span class="o">=</span> <span class="nx">emit_message</span><span class="p">;</span>
<a name="code--tic--tic2--tic6.js-pyg.html-52"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">emit_message_all</span>                <span class="o">=</span> <span class="nx">emit_message_all</span><span class="p">;</span>
</pre></div><p>As we can see the method <tt class="docutils literal">emit_error</tt> will emit an object to one or more <tt class="docutils literal">SocketIO</tt> sockets (if it detects that the socket parameter is an Array it will loop through all the sockets and emit the error). The message is <tt class="docutils literal">standardized</tt> for the application so we can handle all the errors the same way in the browser. Standardizing your messaging protocol is quite useful to avoid complexity and unnecessary duplicated code.</p>
<pre class="code javascript literal-block">
<span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
  <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span><span class="kc">true</span>
  <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
<span class="p">});</span>
</pre>
<p>The other two functions in the <tt class="docutils literal">shared.js</tt> file is the <tt class="docutils literal">emit_message</tt> and <tt class="docutils literal">emit_message_all</tt>. The <tt class="docutils literal">emit_message</tt> is fairly simple it just emits a message over the provided <tt class="docutils literal">SocketIO</tt> with a given socket, event and message. The <tt class="docutils literal">emit_message_all</tt> uses the <tt class="docutils literal">io.socket.clients()</tt> method to get a list of all connected <tt class="docutils literal">SocketIO</tt> clients and then loops through all of them with the exception being the <tt class="docutils literal">socket</tt> that called the method. The exclusion is done using the <tt class="docutils literal"><span class="pre">clients[i].handshake.sessionID</span></tt> that is set in the <tt class="docutils literal">env.js</tt> file when a user first visits the game and a <tt class="docutils literal">SocketIO</tt> connection is made from the browser to the server.</p>
<p>If no user exists we create a new user using the <tt class="docutils literal">User.createUser</tt> method we wrote earlier and use the shared method <tt class="docutils literal">emit_login_or_registration_ok</tt> to login the user and notify the browser about a successful login.</p>
<p>The first thing the function <tt class="docutils literal">emit_login_or_registration_ok</tt> does is to update the current gamers session and last active time, using the passed in user name. It then sets the sessions value <tt class="docutils literal"><span class="pre">session_store.sessions[socket.handshake.sessionID].user_name</span></tt> that is used to ensure the user is authenticated (in later exercises we will use this to lock down API calls to make sure there is a valid authenticated user calling the method). Once this is done we send a message back over the user <tt class="docutils literal">socket</tt> with the event <tt class="docutils literal">register</tt> and the object <tt class="docutils literal">{ok:true}</tt> that notifies the browser that the user was registered successfully and is now logged in.</p>
<p>At the end of the handler we look up our <tt class="docutils literal">gamer</tt> document by our <tt class="docutils literal">session</tt> id and send a message with the event <tt class="docutils literal">gamer_joined</tt> to all the other gamers currently connected via SocketIO. This lets us update things such as the list of available players when other people log in. Since we are iterating over all the live <tt class="docutils literal">SocketIO</tt> connections, only players that are still active will receive the message of the newly joined gamer.</p>
<p>That end the the backend part of the registration/login process. Let's move on to the frontend part of the application and implement the user facing part of the game.</p>
</div>
<div class="section" id="fronting-it">
<h3><a class="toc-backref" href="#id142">Fronting It</a></h3>
<p>One of the things we touched upon earlier was a common error message. We want to have a common error box for all errors on the frontend and we are going to add it as a <tt class="docutils literal">modal</tt> dialog using <tt class="docutils literal">bootstrap</tt>. Let's bring up the editor and add it to our <tt class="docutils literal">index.html</tt> file.</p>
<div class="highlight"><pre><a name="code--tic--tic2--tic1.html-pyg.html-1"></a><span class="cp">&lt;!DOCTYPE html&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-2"></a><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span> <span class="na">ng-app=</span><span class="s">&quot;app&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-3"></a>  <span class="nt">&lt;head&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-4"></a>    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-5"></a>    <span class="nt">&lt;title&gt;</span>Tic-Tac-Toe<span class="nt">&lt;/title&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-6"></a>
<a name="code--tic--tic2--tic1.html-pyg.html-7"></a>    <span class="c">&lt;!-- Le styles --&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-8"></a>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/css/bootstrap.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-9"></a>    <span class="nt">&lt;style </span><span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-10"></a>      <span class="nt">body</span> <span class="p">{</span>
<a name="code--tic--tic2--tic1.html-pyg.html-11"></a>        <span class="k">padding-top</span><span class="o">:</span> <span class="m">60px</span><span class="p">;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-12"></a>        <span class="k">padding-bottom</span><span class="o">:</span> <span class="m">40px</span><span class="p">;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-13"></a>      <span class="p">}</span>
<a name="code--tic--tic2--tic1.html-pyg.html-14"></a>    <span class="nt">&lt;/style&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-15"></a>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/css/bootstrap-responsive.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-16"></a>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/css/app.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-17"></a>  <span class="nt">&lt;/head&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-18"></a>  <span class="nt">&lt;body&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-19"></a>    <span class="nt">&lt;div&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-20"></a>      <span class="nt">&lt;ng</span><span class="na">-view</span><span class="nt">&gt;</span><span class="err">&lt;</span>/ng-view&gt;
<a name="code--tic--tic2--tic1.html-pyg.html-21"></a>    <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-22"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/jquery.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-23"></a>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/socket.io/socket.io.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-24"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/api.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-25"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/template_handler.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-26"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/mustache.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-27"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/bootstrap.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-28"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/app.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-29"></a>
<a name="code--tic--tic2--tic1.html-pyg.html-30"></a>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-31"></a>
<a name="code--tic--tic2--tic1.html-pyg.html-32"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-inverse navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-33"></a>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-34"></a>          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-35"></a>            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-navbar&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;collapse&quot;</span> <span class="na">data-target=</span><span class="s">&quot;.nav-collapse&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-36"></a>              <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-37"></a>              <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-38"></a>              <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-39"></a>            <span class="nt">&lt;/a&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-40"></a>            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;brand&quot;</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Tic-Tac-Toe<span class="nt">&lt;/a&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-41"></a>          <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-42"></a>        <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-43"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-44"></a>
<a name="code--tic--tic2--tic1.html-pyg.html-45"></a>      <span class="c">&lt;!-- Main hero unit for a primary marketing message or call to action --&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-46"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;hero-unit&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-47"></a>        <span class="nt">&lt;h1&gt;</span>Tic Tac Toe!<span class="nt">&lt;/h1&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-48"></a>        <span class="nt">&lt;p&gt;</span>Play Tic Tac Toe against your friends in this multiplayer demo.<span class="nt">&lt;/p&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-49"></a>        <span class="nt">&lt;p&gt;&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary btn-large&quot;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-50"></a>          <span class="na">href=</span><span class="s">&quot;https://github.com/christkv/tic-tac-toe&quot;</span><span class="nt">&gt;</span>Github <span class="ni">&amp;raquo;</span><span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-51"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-52"></a>
<a name="code--tic--tic2--tic1.html-pyg.html-53"></a>      <span class="c">&lt;!-- Example row of columns --&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-54"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span> <span class="na">id=</span><span class="s">&quot;view&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-55"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-56"></a>
<a name="code--tic--tic2--tic1.html-pyg.html-57"></a>      <span class="nt">&lt;hr&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-58"></a>
<a name="code--tic--tic2--tic1.html-pyg.html-59"></a>      <span class="nt">&lt;footer&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-60"></a>        <span class="nt">&lt;p&gt;</span><span class="ni">&amp;copy;</span> Christian Kvalheim 2012<span class="nt">&lt;/p&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-61"></a>      <span class="nt">&lt;/footer&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-62"></a>
<a name="code--tic--tic2--tic1.html-pyg.html-63"></a>    <span class="nt">&lt;/div&gt;</span> <span class="c">&lt;!-- /container --&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-64"></a>    <span class="c">&lt;!-- Modal --&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-65"></a>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;status_box&quot;</span> <span class="na">class=</span><span class="s">&quot;modal hide fade&quot;</span> <span class="na">tabindex=</span><span class="s">&quot;-1&quot;</span> <span class="na">role=</span><span class="s">&quot;dialog&quot;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-66"></a>    <span class="na">aria-labelledby=</span><span class="s">&quot;status_box&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-67"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-header&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-68"></a>        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;button&quot;</span> <span class="na">class=</span><span class="s">&quot;close&quot;</span> <span class="na">data-dismiss=</span><span class="s">&quot;modal&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-69"></a>          ×
<a name="code--tic--tic2--tic1.html-pyg.html-70"></a>        <span class="nt">&lt;/button&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-71"></a>        <span class="nt">&lt;h3</span> <span class="na">id=</span><span class="s">&quot;status_box_header&quot;</span><span class="nt">&gt;</span>Modal header<span class="nt">&lt;/h3&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-72"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-73"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-body&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-74"></a>        <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;status_box_body&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-75"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-76"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-footer&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-77"></a>        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">&quot;btn&quot;</span> <span class="na">data-dismiss=</span><span class="s">&quot;modal&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>Close<span class="nt">&lt;/button&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-78"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-79"></a>    <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-80"></a>  <span class="nt">&lt;/body&gt;</span>
<a name="code--tic--tic2--tic1.html-pyg.html-81"></a><span class="nt">&lt;/html&gt;</span>
</pre></div><p>Awesome let's look at the core of the frontend interface to our backend. This is the <tt class="docutils literal">public/javascript/api.js</tt> file. Open the file and enter the following code.</p>
<div class="highlight"><pre><a name="code--tic--tic2--tic7.js-pyg.html-1"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic7.js-pyg.html-2"></a><span class="cm"> * Wraps the API used for the game and handles the socketIO connection</span>
<a name="code--tic--tic2--tic7.js-pyg.html-3"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic7.js-pyg.html-4"></a><span class="kd">var</span> <span class="nx">API</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic2--tic7.js-pyg.html-5"></a>  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
<a name="code--tic--tic2--tic7.js-pyg.html-6"></a>
<a name="code--tic--tic2--tic7.js-pyg.html-7"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">domain</span><span class="p">);</span>
<a name="code--tic--tic2--tic7.js-pyg.html-8"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">=</span> <span class="p">{};</span>
<a name="code--tic--tic2--tic7.js-pyg.html-9"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span> <span class="o">=</span> <span class="p">{};</span>
<a name="code--tic--tic2--tic7.js-pyg.html-10"></a>
<a name="code--tic--tic2--tic7.js-pyg.html-11"></a>  <span class="c1">// Handle the data returned over the SocketIO</span>
<a name="code--tic--tic2--tic7.js-pyg.html-12"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic7.js-pyg.html-13"></a>
<a name="code--tic--tic2--tic7.js-pyg.html-14"></a>    <span class="c1">// If the data object has an event member we have</span>
<a name="code--tic--tic2--tic7.js-pyg.html-15"></a>    <span class="c1">// a valid event message from the server</span>
<a name="code--tic--tic2--tic7.js-pyg.html-16"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic7.js-pyg.html-17"></a>      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
<a name="code--tic--tic2--tic7.js-pyg.html-18"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic7.js-pyg.html-19"></a>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic7.js-pyg.html-20"></a>          <span class="nx">data</span><span class="p">.</span><span class="nx">is_error</span> <span class="o">?</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">data</span><span class="p">)</span> <span class="o">:</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
<a name="code--tic--tic2--tic7.js-pyg.html-21"></a>        <span class="p">}</span>
<a name="code--tic--tic2--tic7.js-pyg.html-22"></a>      <span class="p">}</span>
<a name="code--tic--tic2--tic7.js-pyg.html-23"></a>
<a name="code--tic--tic2--tic7.js-pyg.html-24"></a>      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
<a name="code--tic--tic2--tic7.js-pyg.html-25"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic7.js-pyg.html-26"></a>        <span class="k">while</span><span class="p">(</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic7.js-pyg.html-27"></a>          <span class="nx">data</span><span class="p">.</span><span class="nx">is_error</span> <span class="o">?</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">pop</span><span class="p">()(</span><span class="nx">data</span><span class="p">)</span> <span class="o">:</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">pop</span><span class="p">()(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
<a name="code--tic--tic2--tic7.js-pyg.html-28"></a>        <span class="p">}</span>
<a name="code--tic--tic2--tic7.js-pyg.html-29"></a>
<a name="code--tic--tic2--tic7.js-pyg.html-30"></a>        <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
<a name="code--tic--tic2--tic7.js-pyg.html-31"></a>      <span class="p">}</span>
<a name="code--tic--tic2--tic7.js-pyg.html-32"></a>    <span class="p">}</span>
<a name="code--tic--tic2--tic7.js-pyg.html-33"></a>  <span class="p">});</span>
<a name="code--tic--tic2--tic7.js-pyg.html-34"></a><span class="p">}</span>
<a name="code--tic--tic2--tic7.js-pyg.html-35"></a>
<a name="code--tic--tic2--tic7.js-pyg.html-36"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic7.js-pyg.html-37"></a><span class="cm"> * Register an event listener callback (will keep receiving messages)</span>
<a name="code--tic--tic2--tic7.js-pyg.html-38"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic7.js-pyg.html-39"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic7.js-pyg.html-40"></a>  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--tic--tic2--tic7.js-pyg.html-41"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic2--tic7.js-pyg.html-42"></a><span class="p">}</span>
<a name="code--tic--tic2--tic7.js-pyg.html-43"></a>
<a name="code--tic--tic2--tic7.js-pyg.html-44"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic7.js-pyg.html-45"></a><span class="cm"> * Register an event listener callback for a single instance of the event</span>
<a name="code--tic--tic2--tic7.js-pyg.html-46"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic7.js-pyg.html-47"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">once</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic7.js-pyg.html-48"></a>  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--tic--tic2--tic7.js-pyg.html-49"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic2--tic7.js-pyg.html-50"></a><span class="p">}</span>
<a name="code--tic--tic2--tic7.js-pyg.html-51"></a>
<a name="code--tic--tic2--tic7.js-pyg.html-52"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic7.js-pyg.html-53"></a><span class="cm"> * Register a new user</span>
<a name="code--tic--tic2--tic7.js-pyg.html-54"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic7.js-pyg.html-55"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic7.js-pyg.html-56"></a>  <span class="c1">// Do basic validation</span>
<a name="code--tic--tic2--tic7.js-pyg.html-57"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">full_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">full_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic2--tic7.js-pyg.html-58"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;Full name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic2--tic7.js-pyg.html-59"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic2--tic7.js-pyg.html-60"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;User name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic2--tic7.js-pyg.html-61"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic2--tic7.js-pyg.html-62"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;Password name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic2--tic7.js-pyg.html-63"></a>  <span class="c1">// Register callback</span>
<a name="code--tic--tic2--tic7.js-pyg.html-64"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic2--tic7.js-pyg.html-65"></a>  <span class="c1">// Fire message</span>
<a name="code--tic--tic2--tic7.js-pyg.html-66"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic2--tic7.js-pyg.html-67"></a>      <span class="nx">full_name</span><span class="o">:</span> <span class="nx">full_name</span>
<a name="code--tic--tic2--tic7.js-pyg.html-68"></a>    <span class="p">,</span> <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
<a name="code--tic--tic2--tic7.js-pyg.html-69"></a>    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
<a name="code--tic--tic2--tic7.js-pyg.html-70"></a>  <span class="p">});</span>
<a name="code--tic--tic2--tic7.js-pyg.html-71"></a><span class="p">}</span>
<a name="code--tic--tic2--tic7.js-pyg.html-72"></a>
<a name="code--tic--tic2--tic7.js-pyg.html-73"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic7.js-pyg.html-74"></a><span class="cm"> * Login a user</span>
<a name="code--tic--tic2--tic7.js-pyg.html-75"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic7.js-pyg.html-76"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">login</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic7.js-pyg.html-77"></a>  <span class="c1">// Do basic validation</span>
<a name="code--tic--tic2--tic7.js-pyg.html-78"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic2--tic7.js-pyg.html-79"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;User name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic2--tic7.js-pyg.html-80"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic2--tic7.js-pyg.html-81"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;Password name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic2--tic7.js-pyg.html-82"></a>  <span class="c1">// Register callback</span>
<a name="code--tic--tic2--tic7.js-pyg.html-83"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic2--tic7.js-pyg.html-84"></a>  <span class="c1">// Fire message</span>
<a name="code--tic--tic2--tic7.js-pyg.html-85"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic2--tic7.js-pyg.html-86"></a>      <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
<a name="code--tic--tic2--tic7.js-pyg.html-87"></a>    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
<a name="code--tic--tic2--tic7.js-pyg.html-88"></a>  <span class="p">});</span>
<a name="code--tic--tic2--tic7.js-pyg.html-89"></a><span class="p">}</span>
<a name="code--tic--tic2--tic7.js-pyg.html-90"></a>
<a name="code--tic--tic2--tic7.js-pyg.html-91"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic7.js-pyg.html-92"></a><span class="cm"> * Simple method to create a formated error message that fits the</span>
<a name="code--tic--tic2--tic7.js-pyg.html-93"></a><span class="cm"> * format returned from the server</span>
<a name="code--tic--tic2--tic7.js-pyg.html-94"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic7.js-pyg.html-95"></a><span class="kd">var</span> <span class="nx">create_error</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic7.js-pyg.html-96"></a>  <span class="k">return</span> <span class="p">{</span>
<a name="code--tic--tic2--tic7.js-pyg.html-97"></a>      <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
<a name="code--tic--tic2--tic7.js-pyg.html-98"></a>    <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--tic--tic2--tic7.js-pyg.html-99"></a>    <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span> <span class="kc">true</span>
<a name="code--tic--tic2--tic7.js-pyg.html-100"></a>    <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
<a name="code--tic--tic2--tic7.js-pyg.html-101"></a>  <span class="p">}</span>
<a name="code--tic--tic2--tic7.js-pyg.html-102"></a><span class="p">}</span>
</pre></div><p>Let's start with the actual API creation function.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Wraps the API used for the game and handles the socketIO connection
 */</span>
<span class="kd">var</span> <span class="nx">API</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">domain</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">=</span> <span class="p">{</span><span class="p">};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span> <span class="o">=</span> <span class="p">{</span><span class="p">};</span>

  <span class="c1">// Handle the data returned over the SocketIO
</span>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// If the data object has an event member we have
</span>    <span class="c1">// a valid event message from the server
</span>    <span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">data</span><span class="p">.</span><span class="nx">is_error</span> <span class="o">?</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">data</span><span class="p">)</span> <span class="o">:</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">data</span><span class="p">.</span><span class="nx">is_error</span> <span class="o">?</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">pop</span><span class="p">(</span><span class="p">)(</span><span class="nx">data</span><span class="p">)</span> <span class="o">:</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">pop</span><span class="p">(</span><span class="p">)(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>The first thing you'll notice is that we use the <tt class="docutils literal">docuemnt.domain</tt> as the identifier for the <tt class="docutils literal">SocketIO</tt> connection. This is to ensure we are not doing cross-domain websockets and to avoid any authentication issues. Once the connection has been created we add an event listener to the event <tt class="docutils literal">data</tt>. Notice that we don't handle any <tt class="docutils literal">errors</tt> on the socket. We leave it as an exercise to handle how to reconnect if the socket closes.</p>
<p>The handler for the <tt class="docutils literal">data</tt> event takes the object returned by <tt class="docutils literal">SocketIO</tt> and determines what kind of event it is by looking at the <tt class="docutils literal">data.event</tt> value that is always present in our messages (hence the importance of standardizing your messaging protocol messages so they always look the same). After having determined what kind of <tt class="docutils literal">event</tt> we received we locate all the handlers that are interested in the event and call their functions notifying all interested parties.</p>
<p>There are two types of handlers we can set up.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Register an event listener callback (will keep receiving messages)
 */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="p">];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**
 * Register an event listener callback for a single instance of the event
 */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">once</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="p">];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p>A <tt class="docutils literal">on</tt> and <tt class="docutils literal">once</tt> handler (blatant ripoff from Node.js EventEmitter). The <tt class="docutils literal">on</tt> registers a function to an <tt class="docutils literal">event</tt> that gets called each time that event is detected in a <tt class="docutils literal">SocketIO</tt> message. The <tt class="docutils literal">once</tt> registers a function that will only fire once when a message of the event type is detected in a <tt class="docutils literal">SocketIO</tt> message.</p>
<p>Why do we do this. Well simply put. When we do a single call to the backend we don't want the callback to be executed more than once and since all messaging is driven by events we register a callback for only a single <tt class="docutils literal">execution</tt>. But for some other things like when a new player joins the game we might want to get messaged each time it happens using the same function. That's when <tt class="docutils literal">on</tt> comes into force. Don't worry it will make more sense when we show you the next piece of code. The more astute of you might have noticed that this could cause an issue if you have multiple messages being fired on the same event (how would it know what callback to send the message to). A solution for this would be to extend our protocol to contain a callback identifier so a message would contain some sort of identification of what the originating callback was. However this is not needed for our simple Tic-Tac-Toe game and is left for you as an exercise. Let's look at the handlers.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Register a new user
 */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Do basic validation
</span>  <span class="k">if</span><span class="p">(</span><span class="nx">full_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">full_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;Full name cannot be empty&quot;</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;User name cannot be empty&quot;</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;Password name cannot be empty&quot;</span><span class="p">));</span>
  <span class="c1">// Register callback
</span>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="c1">// Fire message
</span>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">full_name</span><span class="o">:</span> <span class="nx">full_name</span>
    <span class="p">,</span> <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**
 * Login a user
 */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">login</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Do basic validation
</span>  <span class="k">if</span><span class="p">(</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;User name cannot be empty&quot;</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;Password name cannot be empty&quot;</span><span class="p">));</span>
  <span class="c1">// Register callback
</span>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="c1">// Fire message
</span>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**
 * Send a message to a specific gamer on a specific game
 */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">send_message</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;send_message&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;send_message&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">game_id</span><span class="o">:</span> <span class="nx">game_id</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">message</span><span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**
 * Simple method to create a formated error message that fits the
 * format returned from the server
 */</span>
<span class="kd">var</span> <span class="nx">create_error</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
      <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
    <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
    <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>Let's have a look at the <tt class="docutils literal">API.prototype.register</tt> function in the <tt class="docutils literal">API</tt>. It first does a couple of validations checking that <tt class="docutils literal">full_name</tt>, <tt class="docutils literal">user_name</tt> and <tt class="docutils literal">password</tt> are not empty strings and if anyone of them are it returns a <tt class="docutils literal">standardized</tt> error message (same format as we send from the server) using the <tt class="docutils literal">create_error</tt> function. If all the validations pass we use the <tt class="docutils literal">once</tt> method mentioned above to register the calling function's <tt class="docutils literal">callback</tt> function to the event <tt class="docutils literal">register</tt>. This means that when the frontend receives an event of type <tt class="docutils literal">register</tt> it will locate that callback and execute it returning the results to the code originally calling the <tt class="docutils literal">register</tt> <tt class="docutils literal">API</tt> method. After registering the <tt class="docutils literal">callback</tt> the method sends a message down to the backend with the event <tt class="docutils literal">register</tt> that gets processed by our backend handler in the <tt class="docutils literal">lib/handlers/login_handler.js</tt> file called <tt class="docutils literal">register_handler</tt>.</p>
<p>The same applies for the <tt class="docutils literal">API.prototype.login</tt> method. The difference being that the message sent is handled by the <tt class="docutils literal">login_handler</tt> function in the <tt class="docutils literal">lib/handlers/login_handler.js</tt> file.</p>
</div>
<div class="section" id="wiring-up-the-code">
<h3><a class="toc-backref" href="#id143">Wiring Up The Code</a></h3>
<p>We've defined the <tt class="docutils literal">API</tt> for the game, now let's wire it all up so we can actually perform a registration or login from the browser. Open the file <tt class="docutils literal">public/javascript/app.js</tt> in your editor.</p>
<div class="highlight"><pre><a name="code--tic--tic2--tic8.js-pyg.html-1"></a><span class="c1">// Contains the application state</span>
<a name="code--tic--tic2--tic8.js-pyg.html-2"></a><span class="kd">var</span> <span class="nx">application_state</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--tic--tic2--tic8.js-pyg.html-3"></a>  <span class="nx">session_id</span><span class="o">:</span> <span class="kc">null</span>
<a name="code--tic--tic2--tic8.js-pyg.html-4"></a><span class="p">}</span>
<a name="code--tic--tic2--tic8.js-pyg.html-5"></a>
<a name="code--tic--tic2--tic8.js-pyg.html-6"></a><span class="c1">// Create an instance of the API class</span>
<a name="code--tic--tic2--tic8.js-pyg.html-7"></a><span class="kd">var</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">API</span><span class="p">();</span>
<a name="code--tic--tic2--tic8.js-pyg.html-8"></a>
<a name="code--tic--tic2--tic8.js-pyg.html-9"></a><span class="c1">// Create a template handler with all the templates</span>
<a name="code--tic--tic2--tic8.js-pyg.html-10"></a><span class="c1">// used in the application</span>
<a name="code--tic--tic2--tic8.js-pyg.html-11"></a><span class="kd">var</span> <span class="nx">template_handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TemplateHandler</span><span class="p">({</span>
<a name="code--tic--tic2--tic8.js-pyg.html-12"></a>    <span class="s2">&quot;main&quot;</span><span class="o">:</span> <span class="s2">&quot;/templates/main.ms&quot;</span>
<a name="code--tic--tic2--tic8.js-pyg.html-13"></a>  <span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="o">:</span> <span class="s2">&quot;/templates/dashboard.ms&quot;</span>
<a name="code--tic--tic2--tic8.js-pyg.html-14"></a><span class="p">});</span>
<a name="code--tic--tic2--tic8.js-pyg.html-15"></a>
<a name="code--tic--tic2--tic8.js-pyg.html-16"></a><span class="c1">// Load all the templates and once it&#39;s done</span>
<a name="code--tic--tic2--tic8.js-pyg.html-17"></a><span class="c1">// register up all the initial button handlers</span>
<a name="code--tic--tic2--tic8.js-pyg.html-18"></a><span class="nx">template_handler</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic8.js-pyg.html-19"></a>
<a name="code--tic--tic2--tic8.js-pyg.html-20"></a>  <span class="c1">// Render the main view in the #view div</span>
<a name="code--tic--tic2--tic8.js-pyg.html-21"></a>  <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="p">{});</span>
<a name="code--tic--tic2--tic8.js-pyg.html-22"></a>
<a name="code--tic--tic2--tic8.js-pyg.html-23"></a>  <span class="c1">// Wire up the buttons for the main view</span>
<a name="code--tic--tic2--tic8.js-pyg.html-24"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#register_button&#39;</span><span class="p">)</span>
<a name="code--tic--tic2--tic8.js-pyg.html-25"></a>    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">register_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<a name="code--tic--tic2--tic8.js-pyg.html-26"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#login_button&#39;</span><span class="p">)</span>
<a name="code--tic--tic2--tic8.js-pyg.html-27"></a>    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">login_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<a name="code--tic--tic2--tic8.js-pyg.html-28"></a><span class="p">})</span>
<a name="code--tic--tic2--tic8.js-pyg.html-29"></a>
<a name="code--tic--tic2--tic8.js-pyg.html-30"></a><span class="cm">/****************************************************************************************</span>
<a name="code--tic--tic2--tic8.js-pyg.html-31"></a><span class="cm"> * Application events we listen to</span>
<a name="code--tic--tic2--tic8.js-pyg.html-32"></a><span class="cm"> ****************************************************************************************/</span>
<a name="code--tic--tic2--tic8.js-pyg.html-33"></a>
<a name="code--tic--tic2--tic8.js-pyg.html-34"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic8.js-pyg.html-35"></a><span class="cm"> * The init event, the server has set up everything an assigned us</span>
<a name="code--tic--tic2--tic8.js-pyg.html-36"></a><span class="cm"> * a session id that we can use in the application</span>
<a name="code--tic--tic2--tic8.js-pyg.html-37"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic8.js-pyg.html-38"></a><span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic8.js-pyg.html-39"></a>  <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
<a name="code--tic--tic2--tic8.js-pyg.html-40"></a><span class="p">});</span>
<a name="code--tic--tic2--tic8.js-pyg.html-41"></a>
<a name="code--tic--tic2--tic8.js-pyg.html-42"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic8.js-pyg.html-43"></a><span class="cm"> * A new gamer logged on, display the new user in the list of available gamers</span>
<a name="code--tic--tic2--tic8.js-pyg.html-44"></a><span class="cm"> * to play</span>
<a name="code--tic--tic2--tic8.js-pyg.html-45"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic8.js-pyg.html-46"></a><span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;gamer_joined&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic8.js-pyg.html-47"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<a name="code--tic--tic2--tic8.js-pyg.html-48"></a><span class="p">});</span>
<a name="code--tic--tic2--tic8.js-pyg.html-49"></a>
<a name="code--tic--tic2--tic8.js-pyg.html-50"></a><span class="cm">/****************************************************************************************</span>
<a name="code--tic--tic2--tic8.js-pyg.html-51"></a><span class="cm"> * Handlers</span>
<a name="code--tic--tic2--tic8.js-pyg.html-52"></a><span class="cm"> ****************************************************************************************/</span>
<a name="code--tic--tic2--tic8.js-pyg.html-53"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic8.js-pyg.html-54"></a><span class="cm"> * Handles the attempt to register a new user</span>
<a name="code--tic--tic2--tic8.js-pyg.html-55"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic8.js-pyg.html-56"></a><span class="kd">var</span> <span class="nx">register_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic8.js-pyg.html-57"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic2--tic8.js-pyg.html-58"></a>    <span class="c1">// Lets get the values for the registration</span>
<a name="code--tic--tic2--tic8.js-pyg.html-59"></a>    <span class="kd">var</span> <span class="nx">full_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputFullNameRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<a name="code--tic--tic2--tic8.js-pyg.html-60"></a>    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputUserNameRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<a name="code--tic--tic2--tic8.js-pyg.html-61"></a>    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputPasswordRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<a name="code--tic--tic2--tic8.js-pyg.html-62"></a>
<a name="code--tic--tic2--tic8.js-pyg.html-63"></a>    <span class="c1">// Attempt to register a new user</span>
<a name="code--tic--tic2--tic8.js-pyg.html-64"></a>    <span class="nx">api</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic8.js-pyg.html-65"></a>      <span class="c1">// If we have an error show the error message to the user</span>
<a name="code--tic--tic2--tic8.js-pyg.html-66"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic2--tic8.js-pyg.html-67"></a>
<a name="code--tic--tic2--tic8.js-pyg.html-68"></a>      <span class="c1">// Show the main dashboard view and render with all the available players</span>
<a name="code--tic--tic2--tic8.js-pyg.html-69"></a>      <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span> <span class="p">[]});</span>
<a name="code--tic--tic2--tic8.js-pyg.html-70"></a>    <span class="p">});</span>
<a name="code--tic--tic2--tic8.js-pyg.html-71"></a>  <span class="p">}</span>
<a name="code--tic--tic2--tic8.js-pyg.html-72"></a><span class="p">}</span>
<a name="code--tic--tic2--tic8.js-pyg.html-73"></a>
<a name="code--tic--tic2--tic8.js-pyg.html-74"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic8.js-pyg.html-75"></a><span class="cm"> * Handles the attempt to login</span>
<a name="code--tic--tic2--tic8.js-pyg.html-76"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic8.js-pyg.html-77"></a><span class="kd">var</span> <span class="nx">login_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic8.js-pyg.html-78"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic2--tic8.js-pyg.html-79"></a>    <span class="c1">// Lets get the values for the login</span>
<a name="code--tic--tic2--tic8.js-pyg.html-80"></a>    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputUserNameLogin&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<a name="code--tic--tic2--tic8.js-pyg.html-81"></a>    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputPasswordLogin&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<a name="code--tic--tic2--tic8.js-pyg.html-82"></a>
<a name="code--tic--tic2--tic8.js-pyg.html-83"></a>    <span class="c1">// Attempt to login the user</span>
<a name="code--tic--tic2--tic8.js-pyg.html-84"></a>    <span class="nx">api</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic8.js-pyg.html-85"></a>      <span class="c1">// If we have an error show the error message to the user</span>
<a name="code--tic--tic2--tic8.js-pyg.html-86"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic2--tic8.js-pyg.html-87"></a>
<a name="code--tic--tic2--tic8.js-pyg.html-88"></a>      <span class="c1">// Show the main dashboard view and render with all the available players</span>
<a name="code--tic--tic2--tic8.js-pyg.html-89"></a>      <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span> <span class="p">[]});</span>
<a name="code--tic--tic2--tic8.js-pyg.html-90"></a>    <span class="p">});</span>
<a name="code--tic--tic2--tic8.js-pyg.html-91"></a>  <span class="p">}</span>
<a name="code--tic--tic2--tic8.js-pyg.html-92"></a><span class="p">}</span>
<a name="code--tic--tic2--tic8.js-pyg.html-93"></a>
<a name="code--tic--tic2--tic8.js-pyg.html-94"></a><span class="cm">/****************************************************************************************</span>
<a name="code--tic--tic2--tic8.js-pyg.html-95"></a><span class="cm"> * Helper methods</span>
<a name="code--tic--tic2--tic8.js-pyg.html-96"></a><span class="cm"> ****************************************************************************************/</span>
<a name="code--tic--tic2--tic8.js-pyg.html-97"></a>
<a name="code--tic--tic2--tic8.js-pyg.html-98"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic8.js-pyg.html-99"></a><span class="cm"> * Show an error message box</span>
<a name="code--tic--tic2--tic8.js-pyg.html-100"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic8.js-pyg.html-101"></a><span class="kd">var</span> <span class="nx">error_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic8.js-pyg.html-102"></a>  <span class="c1">// Set fields for the error</span>
<a name="code--tic--tic2--tic8.js-pyg.html-103"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_header&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;Registration Error&quot;</span><span class="p">);</span>
<a name="code--tic--tic2--tic8.js-pyg.html-104"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_body&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic2--tic8.js-pyg.html-105"></a>  <span class="c1">// Show the modal box</span>
<a name="code--tic--tic2--tic8.js-pyg.html-106"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">({</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
<a name="code--tic--tic2--tic8.js-pyg.html-107"></a><span class="p">}</span>
</pre></div><p>The first part of the file is the <tt class="docutils literal">application_state</tt>. This object keeps track of all application specific information needed across the lifetime of the application such as the current session id associated with the current user. The <tt class="docutils literal">var api = new API()</tt> statement keeps an instance of the api around for the application to use and initiates contact with the server backend over <tt class="docutils literal">SocketIO</tt>.</p>
<p>Let's take a look at the class we use to handle the rendering of all our templates in the application. Lets open the <tt class="docutils literal">public/javascripts/template_handler.js</tt> and add the following code.</p>
<div class="highlight"><pre><a name="code--tic--tic2--tic9.js-pyg.html-1"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic9.js-pyg.html-2"></a><span class="cm"> * The template handler just keeps our mustache templates</span>
<a name="code--tic--tic2--tic9.js-pyg.html-3"></a><span class="cm"> * and wraps basic things like loading the templates and rendering them</span>
<a name="code--tic--tic2--tic9.js-pyg.html-4"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic9.js-pyg.html-5"></a><span class="kd">var</span> <span class="nx">TemplateHandler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">templates</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic9.js-pyg.html-6"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">templates</span> <span class="o">=</span> <span class="nx">templates</span><span class="p">;</span>
<a name="code--tic--tic2--tic9.js-pyg.html-7"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">template_file_content</span> <span class="o">=</span> <span class="p">{};</span>
<a name="code--tic--tic2--tic9.js-pyg.html-8"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">numberOfTemplates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="code--tic--tic2--tic9.js-pyg.html-9"></a>  <span class="c1">// Get templates count</span>
<a name="code--tic--tic2--tic9.js-pyg.html-10"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">name</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">templates</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic9.js-pyg.html-11"></a>    <span class="k">this</span><span class="p">.</span><span class="nx">numberOfTemplates</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">numberOfTemplates</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="code--tic--tic2--tic9.js-pyg.html-12"></a>  <span class="p">}</span>
<a name="code--tic--tic2--tic9.js-pyg.html-13"></a><span class="p">}</span>
<a name="code--tic--tic2--tic9.js-pyg.html-14"></a>
<a name="code--tic--tic2--tic9.js-pyg.html-15"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic9.js-pyg.html-16"></a><span class="cm"> * Load all the templates using jquery and save them in our internal</span>
<a name="code--tic--tic2--tic9.js-pyg.html-17"></a><span class="cm"> * cache</span>
<a name="code--tic--tic2--tic9.js-pyg.html-18"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic9.js-pyg.html-19"></a><span class="nx">TemplateHandler</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic9.js-pyg.html-20"></a>  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">numberOfTemplates</span><span class="p">;</span>
<a name="code--tic--tic2--tic9.js-pyg.html-21"></a>  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
<a name="code--tic--tic2--tic9.js-pyg.html-22"></a>
<a name="code--tic--tic2--tic9.js-pyg.html-23"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">name</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">templates</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic9.js-pyg.html-24"></a>    <span class="c1">// Execute each get in it&#39;s own context</span>
<a name="code--tic--tic2--tic9.js-pyg.html-25"></a>    <span class="kd">var</span> <span class="nx">wrapper_function</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template_name</span><span class="p">,</span> <span class="nx">template_location</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic9.js-pyg.html-26"></a>
<a name="code--tic--tic2--tic9.js-pyg.html-27"></a>      <span class="c1">// Load the initial mustache template</span>
<a name="code--tic--tic2--tic9.js-pyg.html-28"></a>      <span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">templates</span><span class="p">[</span><span class="nx">name</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic9.js-pyg.html-29"></a>        <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="code--tic--tic2--tic9.js-pyg.html-30"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;loaded template: &quot;</span> <span class="o">+</span> <span class="nx">template_name</span> <span class="o">+</span> <span class="s2">&quot; at &quot;</span> <span class="o">+</span> <span class="nx">template_location</span><span class="p">);</span>
<a name="code--tic--tic2--tic9.js-pyg.html-31"></a>
<a name="code--tic--tic2--tic9.js-pyg.html-32"></a>        <span class="c1">// Store the template in the file content cache</span>
<a name="code--tic--tic2--tic9.js-pyg.html-33"></a>        <span class="nx">self</span><span class="p">.</span><span class="nx">template_file_content</span><span class="p">[</span><span class="nx">template_name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">template</span><span class="p">;</span>
<a name="code--tic--tic2--tic9.js-pyg.html-34"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">callback</span><span class="p">();</span>
<a name="code--tic--tic2--tic9.js-pyg.html-35"></a>      <span class="p">})</span>
<a name="code--tic--tic2--tic9.js-pyg.html-36"></a>    <span class="p">}</span>
<a name="code--tic--tic2--tic9.js-pyg.html-37"></a>
<a name="code--tic--tic2--tic9.js-pyg.html-38"></a>    <span class="c1">// Wrap the load to ensure we keep the scope local to the function</span>
<a name="code--tic--tic2--tic9.js-pyg.html-39"></a>    <span class="nx">wrapper_function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">templates</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span>
<a name="code--tic--tic2--tic9.js-pyg.html-40"></a>  <span class="p">}</span>
<a name="code--tic--tic2--tic9.js-pyg.html-41"></a><span class="p">}</span>
<a name="code--tic--tic2--tic9.js-pyg.html-42"></a>
<a name="code--tic--tic2--tic9.js-pyg.html-43"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic9.js-pyg.html-44"></a><span class="cm"> * Render a template by the template name and then set a div with the rendered template, </span>
<a name="code--tic--tic2--tic9.js-pyg.html-45"></a><span class="cm"> * the context is an object of values used in the template</span>
<a name="code--tic--tic2--tic9.js-pyg.html-46"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic9.js-pyg.html-47"></a><span class="nx">TemplateHandler</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setTemplate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">template_name</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic9.js-pyg.html-48"></a>  <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
<a name="code--tic--tic2--tic9.js-pyg.html-49"></a>  <span class="c1">// If there is no such HTML container throw an error</span>
<a name="code--tic--tic2--tic9.js-pyg.html-50"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">container</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">container</span><span class="p">.</span><span class="nx">html</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
<a name="code--tic--tic2--tic9.js-pyg.html-51"></a>    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;no container &quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
<a name="code--tic--tic2--tic9.js-pyg.html-52"></a>  <span class="c1">// If the template does not exist throw an error</span>
<a name="code--tic--tic2--tic9.js-pyg.html-53"></a>  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template_file_content</span><span class="p">[</span><span class="nx">template_name</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
<a name="code--tic--tic2--tic9.js-pyg.html-54"></a>    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;no template name &quot;</span> <span class="o">+</span> <span class="nx">template_name</span> <span class="o">+</span> <span class="s2">&quot; loaded&quot;</span><span class="p">);</span>
<a name="code--tic--tic2--tic9.js-pyg.html-55"></a>  <span class="c1">// Ensure at least empty context</span>
<a name="code--tic--tic2--tic9.js-pyg.html-56"></a>  <span class="nx">context</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="p">{}</span> <span class="o">:</span> <span class="nx">context</span><span class="p">;</span>
<a name="code--tic--tic2--tic9.js-pyg.html-57"></a>  <span class="c1">// Render template</span>
<a name="code--tic--tic2--tic9.js-pyg.html-58"></a>  <span class="kd">var</span> <span class="nx">rendered_template</span> <span class="o">=</span> <span class="nx">Mustache</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template_file_content</span><span class="p">[</span><span class="nx">template_name</span><span class="p">]</span>
<a name="code--tic--tic2--tic9.js-pyg.html-59"></a>    <span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
<a name="code--tic--tic2--tic9.js-pyg.html-60"></a>  <span class="c1">// No error render the template</span>
<a name="code--tic--tic2--tic9.js-pyg.html-61"></a>  <span class="nx">container</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">rendered_template</span><span class="p">);</span>
<a name="code--tic--tic2--tic9.js-pyg.html-62"></a><span class="p">}</span>
<a name="code--tic--tic2--tic9.js-pyg.html-63"></a>
<a name="code--tic--tic2--tic9.js-pyg.html-64"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic9.js-pyg.html-65"></a><span class="cm"> * Verify if a template exists</span>
<a name="code--tic--tic2--tic9.js-pyg.html-66"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic9.js-pyg.html-67"></a><span class="nx">TemplateHandler</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isTemplate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template_name</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic9.js-pyg.html-68"></a>  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">template_file_content</span><span class="p">[</span><span class="nx">template_name</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
<a name="code--tic--tic2--tic9.js-pyg.html-69"></a><span class="p">}</span>
<a name="code--tic--tic2--tic9.js-pyg.html-70"></a>
<a name="code--tic--tic2--tic9.js-pyg.html-71"></a><span class="cm">/**</span>
<a name="code--tic--tic2--tic9.js-pyg.html-72"></a><span class="cm"> * Just render a template and return the text</span>
<a name="code--tic--tic2--tic9.js-pyg.html-73"></a><span class="cm"> */</span>
<a name="code--tic--tic2--tic9.js-pyg.html-74"></a><span class="nx">TemplateHandler</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template_name</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic2--tic9.js-pyg.html-75"></a>  <span class="c1">// If the template does not exist throw an error</span>
<a name="code--tic--tic2--tic9.js-pyg.html-76"></a>  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template_file_content</span><span class="p">[</span><span class="nx">template_name</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
<a name="code--tic--tic2--tic9.js-pyg.html-77"></a>    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;no template name &quot;</span> <span class="o">+</span> <span class="nx">template_name</span> <span class="o">+</span> <span class="s2">&quot; loaded&quot;</span><span class="p">);</span>
<a name="code--tic--tic2--tic9.js-pyg.html-78"></a>  <span class="c1">// Ensure at least empty context</span>
<a name="code--tic--tic2--tic9.js-pyg.html-79"></a>  <span class="nx">context</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="p">{}</span> <span class="o">:</span> <span class="nx">context</span><span class="p">;</span>
<a name="code--tic--tic2--tic9.js-pyg.html-80"></a>  <span class="c1">// Render template</span>
<a name="code--tic--tic2--tic9.js-pyg.html-81"></a>  <span class="k">return</span> <span class="nx">Mustache</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template_file_content</span><span class="p">[</span><span class="nx">template_name</span><span class="p">],</span> <span class="nx">context</span><span class="p">);</span>
<a name="code--tic--tic2--tic9.js-pyg.html-82"></a><span class="p">}</span>
</pre></div><p>The <tt class="docutils literal">TemplateHandler</tt> class takes care of loading, caching and rendering our templates used in the application using the <tt class="docutils literal">Mustache</tt> template rendering engine.</p>
<table border="1" class="docutils">
<colgroup>
<col width="28%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Function</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>start</td>
<td>Loads all the templates provided in the constructor</td>
</tr>
<tr><td>setTemplate</td>
<td>Renders a template and sets a div</td>
</tr>
<tr><td>isTemplate</td>
<td>Checks if a named template exists</td>
</tr>
<tr><td>render</td>
<td>Render a named template and return the rendered result</td>
</tr>
</tbody>
</table>
<p>All templates passed into the <tt class="docutils literal">TemplateHandler</tt> constructor are passed as an object like this.</p>
<pre class="code json literal-block">
<span class="p">{</span>
    <span class="nt">&quot;main&quot;</span><span class="p">:</span> <span class="s2">&quot;/templates/main.ms&quot;</span>
  <span class="p">,</span> <span class="nt">&quot;dashboard&quot;</span><span class="p">:</span> <span class="s2">&quot;/templates/dashboard.ms&quot;</span>
<span class="p">}</span>
</pre>
<p>Each template has an unique name and an url pointing to the location where the template itself is stored. All the templates are written in a template language called <tt class="docutils literal">Mustache</tt> <a class="reference external" href="http://mustache.github.com/">http://mustache.github.com/</a>.</p>
<p>The benefit of <tt class="docutils literal">Mustache</tt> is that it keeps a very sharp divider between your code and the rendering avoiding silly string concatenations to generate HTML for your application. You can read more up on <tt class="docutils literal">Mustache</tt> on the link above but safe to say it's a very very simple and limited little template language which fits the needs of our application well.</p>
<p>Open up your editor and enter the two templates. The first one is at <tt class="docutils literal">public/templates/main.ms</tt></p>
<div class="highlight"><pre><a name="code--tic--tic2--tic1.ms-pyg.html-1"></a>&lt;div class=&quot;span6&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-2"></a>  &lt;h2&gt;Register&lt;/h2&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-3"></a>  &lt;p&gt;Pick a user name and enter your full name to be able to play games,
<a name="code--tic--tic2--tic1.ms-pyg.html-4"></a>  you can reuse the user name as many times as you wish.&lt;/p&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-5"></a>  &lt;form class=&quot;form-horizontal&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-6"></a>    &lt;div class=&quot;control-group&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-7"></a>      &lt;label class=&quot;control-label&quot; for=&quot;inputFullNameRegister&quot;&gt;Full Name&lt;/label&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-8"></a>      &lt;div class=&quot;controls&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-9"></a>        &lt;input type=&quot;text&quot; id=&quot;inputFullNameRegister&quot; placeholder=&quot;Full Name&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-10"></a>      &lt;/div&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-11"></a>    &lt;/div&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-12"></a>    &lt;div class=&quot;control-group&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-13"></a>      &lt;label class=&quot;control-label&quot; for=&quot;inputUserNameRegister&quot;&gt;User Name&lt;/label&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-14"></a>      &lt;div class=&quot;controls&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-15"></a>        &lt;input type=&quot;text&quot; id=&quot;inputUserNameRegister&quot; placeholder=&quot;User Name&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-16"></a>      &lt;/div&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-17"></a>    &lt;/div&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-18"></a>    &lt;div class=&quot;control-group&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-19"></a>      &lt;label class=&quot;control-label&quot; for=&quot;inputPasswordRegister&quot;&gt;Password&lt;/label&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-20"></a>      &lt;div class=&quot;controls&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-21"></a>        &lt;input type=&quot;password&quot; id=&quot;inputPasswordRegister&quot; placeholder=&quot;Password&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-22"></a>      &lt;/div&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-23"></a>    &lt;/div&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-24"></a>    &lt;div class=&quot;control-group&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-25"></a>      &lt;div class=&quot;controls&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-26"></a>        &lt;button type=&quot;button&quot; class=&quot;btn&quot; id=&quot;register_button&quot;&gt;Register&lt;/button&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-27"></a>      &lt;/div&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-28"></a>    &lt;/div&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-29"></a>  &lt;/form&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-30"></a>&lt;/div&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-31"></a>&lt;div class=&quot;span6&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-32"></a>  &lt;h2&gt;Log in&lt;/h2&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-33"></a>  &lt;form class=&quot;form-horizontal&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-34"></a>    &lt;div class=&quot;control-group&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-35"></a>      &lt;label class=&quot;control-label&quot; for=&quot;inputUserNameLogin&quot;&gt;User Name&lt;/label&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-36"></a>      &lt;div class=&quot;controls&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-37"></a>        &lt;input type=&quot;text&quot; id=&quot;inputUserNameLogin&quot; placeholder=&quot;User Name&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-38"></a>      &lt;/div&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-39"></a>    &lt;/div&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-40"></a>    &lt;div class=&quot;control-group&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-41"></a>      &lt;label class=&quot;control-label&quot; for=&quot;inputPasswordLogin&quot;&gt;Password&lt;/label&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-42"></a>      &lt;div class=&quot;controls&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-43"></a>        &lt;input type=&quot;password&quot; id=&quot;inputPasswordLogin&quot; placeholder=&quot;Password&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-44"></a>      &lt;/div&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-45"></a>    &lt;/div&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-46"></a>    &lt;div class=&quot;control-group&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-47"></a>      &lt;div class=&quot;controls&quot;&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-48"></a>        &lt;button type=&quot;button&quot; class=&quot;btn&quot; id=&quot;login_button&quot;&gt;Login&lt;/button&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-49"></a>      &lt;/div&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-50"></a>    &lt;/div&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-51"></a>  &lt;/form&gt;
<a name="code--tic--tic2--tic1.ms-pyg.html-52"></a>&lt;/div&gt;
</pre></div><p>The second one is at <tt class="docutils literal">public/templates/dashboard.ms</tt></p>
<div class="highlight"><pre><a name="code--tic--tic2--tic2.ms-pyg.html-1"></a>Dashboard
</pre></div><p>The <tt class="docutils literal">TemplateHandler.prototype.start</tt> method will use <tt class="docutils literal">JQuery</tt> to load the templates specified in the constructor and store them in an internal object. The application uses the method <tt class="docutils literal">TemplateHandler.prototype.setTemplate</tt> to overwrite an HTML element's contents identified by <tt class="docutils literal">id</tt> with the content of the rendered template identified by <tt class="docutils literal">template_name</tt> and the value in the passed in <tt class="docutils literal">context</tt> object.</p>
<p><tt class="docutils literal">TemplateHandler.prototype.render</tt> is similar to the <tt class="docutils literal">TemplateHandler.prototype.setTemplate</tt> method but only returns the rendered template result instead of overwriting the content of a HTML element.</p>
<p>That covers how the <tt class="docutils literal">TemplateHandler</tt> class works. It's time to get back to the <tt class="docutils literal">public/javascript/app.js</tt> file and write some of the code for the application.</p>
<pre class="code javascript literal-block">
<span class="c1">// Load all the templates and once it's done
// register up all the initial button handlers
</span><span class="nx">template_handler</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Render the main view in the #view div
</span>  <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="p">{</span><span class="p">});</span>

  <span class="c1">// Wire up the buttons for the main view
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#register_button'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">register_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#login_button'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">login_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<span class="p">})</span>
</pre>
<p>When the user first goes to <tt class="docutils literal"><span class="pre">http://localhost:3000</span></tt> a <tt class="docutils literal">TemplateHandler</tt> instance gets created and the method <tt class="docutils literal">start</tt> is called that loads all the templates. The code then sets the initial template view overwriting the HTML element identified by the id <tt class="docutils literal">view</tt> with the starting application view. After rendering and replacing the HTML the method wires up the <tt class="docutils literal">register_button</tt> and the <tt class="docutils literal">login_button</tt> to listen for <tt class="docutils literal">click</tt> events. If a user clicks the <tt class="docutils literal">register_button</tt> the <tt class="docutils literal">register_button_handler</tt> function is called and if the user clicks the <tt class="docutils literal">login_button</tt> the <tt class="docutils literal">login_button_handler</tt> function is called. That takes care of wiring up the buttons. Let's look at the wiring up of <tt class="docutils literal">event</tt> handlers in <tt class="docutils literal">public/javascript/app.js</tt>.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * The init event, the server has set up everything an assigned us
 * a session id that we can use in the application
 */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">});</span>

<span class="cm">/**
 * A new gamer logged on, display the new user in the list of available gamers
 * to play
 */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'gamer_joined'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<span class="p">});</span>
</pre>
<p>Here we are using the <tt class="docutils literal">on</tt> method from the <tt class="docutils literal">API</tt> class to listen to the events <tt class="docutils literal">init</tt> and <tt class="docutils literal">gamer_joined</tt>.</p>
<p>Looking at the <tt class="docutils literal"><span class="pre">api.on('init',</span> ..)</tt> event handler we see that we are storing the returned data in the <tt class="docutils literal">application_state</tt>. The returned data is the current users session id returned from the server and is used to identify the current user by the server. Don't worry to much about the <tt class="docutils literal"><span class="pre">api.on('gamer_joined',</span> ..)</tt> event handler as we will flesh it out more in the next exercise.</p>
<p>Let's look at the handlers for the <tt class="docutils literal">register_button</tt> and the <tt class="docutils literal">login_button</tt> buttons.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Handles the attempt to register a new user
 */</span>
<span class="kd">var</span> <span class="nx">register_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Lets get the values for the registration
</span>    <span class="kd">var</span> <span class="nx">full_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#inputFullNameRegister'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#inputUserNameRegister'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#inputPasswordRegister'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="p">);</span>

    <span class="c1">// Attempt to register a new user
</span>    <span class="nx">api</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Show the main dashboard view and render with all the available players
</span>      <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span> <span class="p">[</span><span class="p">]});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The first part of the method grabs the content of the three fields <tt class="docutils literal">inputFullNameRegister</tt>, <tt class="docutils literal">inputUserNameRegister</tt> and <tt class="docutils literal">inputPasswordRegister</tt> then attempts to register the user using the <tt class="docutils literal">api.register</tt> method. When the method returns the passed in callback function gets called with two parameters <tt class="docutils literal">err</tt> and <tt class="docutils literal">data</tt> (Standard Node.js callback). If the <tt class="docutils literal">err</tt> parameter is not equal to <tt class="docutils literal">null</tt> the <tt class="docutils literal">register</tt> function failed and we use the method <tt class="docutils literal">error_box_show</tt> to present the user with an error message dialog. Since all our error messages follow the same standard this makes it easy to create a more generalized error message box. If we have no errors the user was successfully created and logged in. We then set the HTML element to the <tt class="docutils literal">dashboard.ms</tt> template and render it. That completes the registration process.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Handles the attempt to login
 */</span>
<span class="kd">var</span> <span class="nx">login_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Lets get the values for the login
</span>    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#inputUserNameLogin'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#inputPasswordLogin'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="p">);</span>

    <span class="c1">// Attempt to login the user
</span>    <span class="nx">api</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Show the main dashboard view and render with all the available players
</span>      <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="p">[</span><span class="p">]});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The login code is very similar to the registration code, the difference being that we are calling the <tt class="docutils literal">api.login</tt> function instead of the <tt class="docutils literal">api.register</tt> function.</p>
<p>That the code for this exercise, lets fire up the server and play around with our application.</p>
<pre class="code console literal-block">
<span class="go">node app</span>
</pre>
<p>Try out a couple of the scenarios below to test out the application and see how it works.</p>
<ol class="arabic simple">
<li>Attempt a login with non existing user.</li>
<li>Attempt to register a new user with the full name field empty.</li>
<li>Fill in all the fields correctly for a registered user.</li>
<li>Login in using a registered user.</li>
</ol>
<p>That finished step two in the tutorial. Join us for the next tutorial step where we implement the actual game play aspect of the application.</p>
</div>
<div class="section" id="notes">
<h3><a class="toc-backref" href="#id144">Notes</a></h3>
<p>This is a very simplified <tt class="docutils literal">registration</tt> and <tt class="docutils literal">login</tt> process. You might want to do things like extend the validations on the client and server side for password strength, and maybe add an email verification process to make sure the new player enters a valid email. This is left as an exercise for you to do.</p>
</div>
</div>
<div class="section" id="tic-tac-toe-exercise-3">
<h2><a class="toc-backref" href="#id145">Tic-Tac-Toe: Exercise 3</a></h2>
<p>In this exercise we are going to start implementing the process of selecting a player to play against, and playing the game itself. This is where the code gets really interesting. The first step is to display a list of available gamers that we can invite to a game. Next for the invitation to a game we need to handle the invite and accept/reject game mechanics for the game.</p>
<p>The final functionality we are going to implement in this exercise is to actually create the game board and handle the playing of the game.</p>
<div class="section" id="id11">
<h3><a class="toc-backref" href="#id146">Where Is The Code</a></h3>
<p>The code for this exercise is located at</p>
<p><a class="reference external" href="https://github.com/christkv/tic-tac-toe-steps/tree/step2">https://github.com/christkv/tic-tac-toe-steps/tree/step2</a></p>
</div>
<div class="section" id="the-glue-of-it-all">
<h3><a class="toc-backref" href="#id147">The Glue Of It All</a></h3>
<p>The first thing we need to do is to be able to retrieve a list of all the available gamers. To do this we are going to create a new set of API calls for the gamer as well as extend our current <tt class="docutils literal">Gamer</tt> model class with some more methods. Let's start with the <tt class="docutils literal">Gamer</tt> model. Bring up the file <tt class="docutils literal">lib/models/gamer.js</tt> with an editor and let's add the missing <tt class="docutils literal">API</tt> calls.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic1.js-pyg.html-1"></a><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.js-pyg.html-2"></a>  <span class="kd">var</span> <span class="nx">Gamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>
<a name="code--tic--tic3--tic1.js-pyg.html-3"></a>
<a name="code--tic--tic3--tic1.js-pyg.html-4"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-5"></a>  <span class="c1">// Locate a gamer by his session id</span>
<a name="code--tic--tic3--tic1.js-pyg.html-6"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-7"></a>  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">findGamerBySid</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.js-pyg.html-8"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">).</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">sid</span><span class="o">:</span> <span class="nx">sid</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic1.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic1.js-pyg.html-10"></a>
<a name="code--tic--tic3--tic1.js-pyg.html-11"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-12"></a>  <span class="c1">// Locate a list of gamers by their session ids</span>
<a name="code--tic--tic3--tic1.js-pyg.html-13"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-14"></a>  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">findAllGamersBySids</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sids</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.js-pyg.html-15"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">({</span><span class="nx">sid</span><span class="o">:</span> <span class="p">{</span><span class="nx">$in</span><span class="o">:</span> <span class="nx">sids</span><span class="p">}}).</span><span class="nx">toArray</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic1.js-pyg.html-16"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic1.js-pyg.html-17"></a>
<a name="code--tic--tic3--tic1.js-pyg.html-18"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-19"></a>  <span class="c1">// Update the last active time for a list of gamers by their session ids</span>
<a name="code--tic--tic3--tic1.js-pyg.html-20"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-21"></a>  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">updateGamersUpdatedDateBySids</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sids</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.js-pyg.html-22"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic1.js-pyg.html-23"></a>      <span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">sid</span><span class="o">:</span><span class="p">{</span><span class="nx">$in</span><span class="o">:</span> <span class="nx">sids</span><span class="p">}},</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">updated_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()}},</span> <span class="p">{</span><span class="nx">multi</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic1.js-pyg.html-24"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic1.js-pyg.html-25"></a>
<a name="code--tic--tic3--tic1.js-pyg.html-26"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-27"></a>  <span class="c1">// Update a gamers current activity time and session id</span>
<a name="code--tic--tic3--tic1.js-pyg.html-28"></a>  <span class="c1">// when they come back after some time away</span>
<a name="code--tic--tic3--tic1.js-pyg.html-29"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-30"></a>  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">updateGamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">sid</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.js-pyg.html-31"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">({</span><span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span><span class="p">}</span>
<a name="code--tic--tic3--tic1.js-pyg.html-32"></a>      <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">updated_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span> <span class="nx">sid</span><span class="o">:</span><span class="nx">sid</span><span class="p">}}</span>
<a name="code--tic--tic3--tic1.js-pyg.html-33"></a>      <span class="p">,</span> <span class="p">{</span><span class="nx">upsert</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic1.js-pyg.html-34"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic1.js-pyg.html-35"></a>
<a name="code--tic--tic3--tic1.js-pyg.html-36"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-37"></a>  <span class="c1">// Initialize the gamer collection, by adding indexes etc</span>
<a name="code--tic--tic3--tic1.js-pyg.html-38"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-39"></a>  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.js-pyg.html-40"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic1.js-pyg.html-41"></a>      <span class="p">.</span><span class="nx">ensureIndex</span><span class="p">({</span><span class="nx">updated_on</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">expireAfterSeconds</span><span class="o">:</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)},</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic1.js-pyg.html-42"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic1.js-pyg.html-43"></a>
<a name="code--tic--tic3--tic1.js-pyg.html-44"></a>  <span class="k">return</span> <span class="nx">Gamer</span><span class="p">;</span>
<a name="code--tic--tic3--tic1.js-pyg.html-45"></a><span class="p">}</span>
</pre></div><p>The first method <tt class="docutils literal">Gamer.findAllGamersBySids</tt> lets us locate all the gamers associated with a list of <tt class="docutils literal">SocketIO</tt> session ids. This method is used to get the list of all currently active users. The second method <tt class="docutils literal">Gamer.updateGamersUpdatedDateBySids</tt> is used to update the last active time on a set of users identified by their session ids (remember that the <tt class="docutils literal">gamers</tt> collection is a <tt class="docutils literal">TTL</tt> collection that times out active gamers after 1 hour).</p>
</div>
<div class="section" id="the-game-model">
<h3><a class="toc-backref" href="#id148">The Game Model</a></h3>
<p>We are going to introduce a concept of a <tt class="docutils literal">Game</tt>. A <tt class="docutils literal">Game</tt> keeps track of a specific game between two players in the application. We need to implement a set of functions to handle the transitions of the game over time.</p>
<table border="1" class="docutils">
<colgroup>
<col width="32%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Function</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>create_gamer</td>
<td>Create a brand new game for two players</td>
</tr>
<tr><td>find_name</td>
<td>Locate an existing game by the game id</td>
</tr>
<tr><td>update_board</td>
<td>Update an existing board with the board state</td>
</tr>
<tr><td>finalize_board</td>
<td>Sets the final state of the board (won/draw)</td>
</tr>
</tbody>
</table>
<p>Let's create the files we need.</p>
<pre class="code console literal-block">
<span class="go">touch lib/handlers/gamer_handler.js
touch lib/models/game.js</span>
</pre>
<p>Open the <tt class="docutils literal">lib/models/game.js</tt> file and lets enter the code for the methods we need for the application <tt class="docutils literal">Game.create_gamer</tt>, <tt class="docutils literal">Game.find_name</tt>, <tt class="docutils literal">Game.update_board</tt> and <tt class="docutils literal">Game.finalize_board</tt>.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic2.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">ObjectID</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">).</span><span class="nx">ObjectID</span><span class="p">;</span>
<a name="code--tic--tic3--tic2.js-pyg.html-2"></a>
<a name="code--tic--tic3--tic2.js-pyg.html-3"></a><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic2.js-pyg.html-4"></a>  <span class="kd">var</span> <span class="nx">Game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>
<a name="code--tic--tic3--tic2.js-pyg.html-5"></a>
<a name="code--tic--tic3--tic2.js-pyg.html-6"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic2.js-pyg.html-7"></a>  <span class="c1">// Create a new game, it contains all the information about the two players, </span>
<a name="code--tic--tic3--tic2.js-pyg.html-8"></a>  <span class="c1">// the empty board, the whole game chat record, who is starting the game and </span>
<a name="code--tic--tic3--tic2.js-pyg.html-9"></a>  <span class="c1">// who is the current player.</span>
<a name="code--tic--tic3--tic2.js-pyg.html-10"></a>  <span class="c1">// </span>
<a name="code--tic--tic3--tic2.js-pyg.html-11"></a>  <span class="nx">Game</span><span class="p">.</span><span class="nx">create_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p1_sid</span><span class="p">,</span> <span class="nx">p1_user_name</span>
<a name="code--tic--tic3--tic2.js-pyg.html-12"></a>    <span class="p">,</span> <span class="nx">p1_full_name</span><span class="p">,</span> <span class="nx">p2_sid</span><span class="p">,</span> <span class="nx">p2_user_name</span><span class="p">,</span> <span class="nx">p2_full_name</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic2.js-pyg.html-13"></a>      <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">insert</span><span class="p">({</span>
<a name="code--tic--tic3--tic2.js-pyg.html-14"></a>          <span class="nx">player1_sid</span><span class="o">:</span> <span class="nx">p1_sid</span>
<a name="code--tic--tic3--tic2.js-pyg.html-15"></a>        <span class="p">,</span> <span class="nx">player1_user_name</span><span class="o">:</span> <span class="nx">p1_user_name</span>
<a name="code--tic--tic3--tic2.js-pyg.html-16"></a>        <span class="p">,</span> <span class="nx">player1_full_name</span><span class="o">:</span> <span class="nx">p1_full_name</span>
<a name="code--tic--tic3--tic2.js-pyg.html-17"></a>        <span class="p">,</span> <span class="nx">player2_sid</span><span class="o">:</span> <span class="nx">p2_sid</span>
<a name="code--tic--tic3--tic2.js-pyg.html-18"></a>        <span class="p">,</span> <span class="nx">player2_user_name</span><span class="o">:</span> <span class="nx">p2_user_name</span>
<a name="code--tic--tic3--tic2.js-pyg.html-19"></a>        <span class="p">,</span> <span class="nx">player2_full_name</span><span class="o">:</span> <span class="nx">p2_full_name</span>
<a name="code--tic--tic3--tic2.js-pyg.html-20"></a>        <span class="p">,</span> <span class="nx">board</span><span class="o">:</span> <span class="p">[</span>
<a name="code--tic--tic3--tic2.js-pyg.html-21"></a>            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a name="code--tic--tic3--tic2.js-pyg.html-22"></a>          <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a name="code--tic--tic3--tic2.js-pyg.html-23"></a>          <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a name="code--tic--tic3--tic2.js-pyg.html-24"></a>          <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a name="code--tic--tic3--tic2.js-pyg.html-25"></a>        <span class="p">]</span>
<a name="code--tic--tic3--tic2.js-pyg.html-26"></a>        <span class="p">,</span> <span class="nx">created_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
<a name="code--tic--tic3--tic2.js-pyg.html-27"></a>        <span class="p">,</span> <span class="nx">starting_player</span><span class="o">:</span> <span class="nx">p1_sid</span>
<a name="code--tic--tic3--tic2.js-pyg.html-28"></a>        <span class="p">,</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">p1_sid</span>
<a name="code--tic--tic3--tic2.js-pyg.html-29"></a>      <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic2.js-pyg.html-30"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--tic--tic3--tic2.js-pyg.html-31"></a>        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">?</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">result</span><span class="p">);</span>
<a name="code--tic--tic3--tic2.js-pyg.html-32"></a>      <span class="p">})</span>
<a name="code--tic--tic3--tic2.js-pyg.html-33"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic2.js-pyg.html-34"></a>
<a name="code--tic--tic3--tic2.js-pyg.html-35"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic2.js-pyg.html-36"></a>  <span class="c1">// Locate an existing game by it&#39;s game id</span>
<a name="code--tic--tic3--tic2.js-pyg.html-37"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic2.js-pyg.html-38"></a>  <span class="nx">Game</span><span class="p">.</span><span class="nx">find_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic2.js-pyg.html-39"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic2.js-pyg.html-40"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--tic--tic3--tic2.js-pyg.html-41"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">doc</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
<a name="code--tic--tic3--tic2.js-pyg.html-42"></a>        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;could not find the game with id &quot;</span> <span class="o">+</span> <span class="nx">game_id</span><span class="p">));</span>
<a name="code--tic--tic3--tic2.js-pyg.html-43"></a>      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">doc</span><span class="p">);</span>
<a name="code--tic--tic3--tic2.js-pyg.html-44"></a>    <span class="p">})</span>
<a name="code--tic--tic3--tic2.js-pyg.html-45"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic2.js-pyg.html-46"></a>
<a name="code--tic--tic3--tic2.js-pyg.html-47"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic2.js-pyg.html-48"></a>  <span class="c1">// Attempt to update the board for a specific game and player</span>
<a name="code--tic--tic3--tic2.js-pyg.html-49"></a>  <span class="c1">// the update fails if the current players is not the player attempting to </span>
<a name="code--tic--tic3--tic2.js-pyg.html-50"></a>  <span class="c1">// update the board notice that since we are doing multiple sets we are </span>
<a name="code--tic--tic3--tic2.js-pyg.html-51"></a>  <span class="c1">// using the $atomic operation to ensure we don&#39;t get any interleaved updates </span>
<a name="code--tic--tic3--tic2.js-pyg.html-52"></a>  <span class="c1">// in between the two sets</span>
<a name="code--tic--tic3--tic2.js-pyg.html-53"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic2.js-pyg.html-54"></a>  <span class="nx">Game</span><span class="p">.</span><span class="nx">update_board</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">game_id</span><span class="p">,</span> <span class="nx">next_sid</span><span class="p">,</span> <span class="nx">board</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic2.js-pyg.html-55"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
<a name="code--tic--tic3--tic2.js-pyg.html-56"></a>        <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">),</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">sid</span><span class="p">,</span> <span class="nx">$atomic</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
<a name="code--tic--tic3--tic2.js-pyg.html-57"></a>      <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">board</span><span class="o">:</span> <span class="nx">board</span><span class="p">,</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">next_sid</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic2.js-pyg.html-58"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--tic--tic3--tic2.js-pyg.html-59"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;It is not your turn&quot;</span><span class="p">));</span>
<a name="code--tic--tic3--tic2.js-pyg.html-60"></a>        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
<a name="code--tic--tic3--tic2.js-pyg.html-61"></a>      <span class="p">});</span>
<a name="code--tic--tic3--tic2.js-pyg.html-62"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic2.js-pyg.html-63"></a>
<a name="code--tic--tic3--tic2.js-pyg.html-64"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic2.js-pyg.html-65"></a>  <span class="c1">// Set the winner on the board if sid == null it&#39;s a draw</span>
<a name="code--tic--tic3--tic2.js-pyg.html-66"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic2.js-pyg.html-67"></a>  <span class="nx">Game</span><span class="p">.</span><span class="nx">finalize_board</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">game_id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic2.js-pyg.html-68"></a>    <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">sid</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s1">&#39;draw&#39;</span> <span class="o">:</span> <span class="s1">&#39;win&#39;</span><span class="p">;</span>
<a name="code--tic--tic3--tic2.js-pyg.html-69"></a>
<a name="code--tic--tic3--tic2.js-pyg.html-70"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
<a name="code--tic--tic3--tic2.js-pyg.html-71"></a>        <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">)}</span>
<a name="code--tic--tic3--tic2.js-pyg.html-72"></a>      <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">final_state</span><span class="o">:</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">winner</span><span class="o">:</span> <span class="nx">sid</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic2.js-pyg.html-73"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--tic--tic3--tic2.js-pyg.html-74"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic3--tic2.js-pyg.html-75"></a>          <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Failed to finalize the board with a winner or draw&quot;</span><span class="p">));</span>
<a name="code--tic--tic3--tic2.js-pyg.html-76"></a>        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
<a name="code--tic--tic3--tic2.js-pyg.html-77"></a>      <span class="p">});</span>
<a name="code--tic--tic3--tic2.js-pyg.html-78"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic2.js-pyg.html-79"></a>
<a name="code--tic--tic3--tic2.js-pyg.html-80"></a>  <span class="c1">// Return Game object class</span>
<a name="code--tic--tic3--tic2.js-pyg.html-81"></a>  <span class="k">return</span> <span class="nx">Game</span><span class="p">;</span>
<a name="code--tic--tic3--tic2.js-pyg.html-82"></a><span class="p">}</span>
</pre></div><p>Let's start off with the <tt class="docutils literal">Game.create_game</tt> function. As we can see it takes quite a bit of parameters.</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>p1_sid</td>
<td>The session id for player 1</td>
</tr>
<tr><td>p1_user_name</td>
<td>The user name of player 1</td>
</tr>
<tr><td>p1_full_name</td>
<td>The full name of player 1</td>
</tr>
<tr><td>p2_sid</td>
<td>The session id for player 2</td>
</tr>
<tr><td>p2_user_name</td>
<td>The user name of player 2</td>
</tr>
<tr><td>p2_full_name</td>
<td>The full name of player 2</td>
</tr>
</tbody>
</table>
<p>The <tt class="docutils literal">Game.create_game</tt> method creates a new game document representing the starting state of a game between two players.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
    <span class="nx">player1_sid</span><span class="o">:</span> <span class="s2">&quot;some session id 1&quot;</span>
  <span class="p">,</span> <span class="nx">player1_user_name</span><span class="o">:</span> <span class="s2">&quot;player1&quot;</span>
  <span class="p">,</span> <span class="nx">player1_full_name</span><span class="o">:</span> <span class="s2">&quot;Joe Player 1&quot;</span>
  <span class="p">,</span> <span class="nx">player2_sid</span><span class="o">:</span> <span class="s2">&quot;some session id 2&quot;</span>
  <span class="p">,</span> <span class="nx">player2_user_name</span><span class="o">:</span> <span class="s2">&quot;player2&quot;</span>
  <span class="p">,</span> <span class="nx">player2_full_name</span><span class="o">:</span> <span class="s2">&quot;Joe Player 2&quot;</span>
  <span class="p">,</span> <span class="nx">board</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
  <span class="p">]</span>
  <span class="p">,</span> <span class="nx">created_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">starting_player</span><span class="o">:</span> <span class="s2">&quot;some session id 1&quot;</span>
  <span class="p">,</span> <span class="nx">current_player</span><span class="o">:</span> <span class="s2">&quot;some session id 1&quot;</span>
<span class="p">}</span>
</pre>
<p>The first six values in the document (<tt class="docutils literal">player1_sid</tt>, <tt class="docutils literal">player1_user_name</tt>, <tt class="docutils literal">player1_full_name</tt>, <tt class="docutils literal">player2_sid</tt>, <tt class="docutils literal">player2_user_name</tt> and <tt class="docutils literal">player2_full_name</tt>) are the ones passed to the function and define who the two players are. The next field down is the <tt class="docutils literal">board</tt> field that contains A <tt class="docutils literal">2D</tt> representation of the <tt class="docutils literal"><span class="pre">Tic-Tac-Toe</span></tt> board where we will store the state of the game.</p>
<p>The <tt class="docutils literal">created_on</tt> field contains the date of when the game was created. The <tt class="docutils literal">starting_player</tt> field is the session id of the player that gets the first move and the <tt class="docutils literal">current_player</tt> field is the session id of player who has the next move. This field is used to make sure only the player who has the next move can update the state of the board.</p>
<p>Next, let's look at the <tt class="docutils literal">Game.find_game</tt> method. Not much to say here. Each <tt class="docutils literal">Game</tt> document has a <tt class="docutils literal">_id</tt> field containing an <tt class="docutils literal">ObjectID</tt> assigned to it by <tt class="docutils literal">MongoDB</tt> and this method lets us locate a board using that <tt class="docutils literal">ObjectID</tt>.</p>
<p>The <tt class="docutils literal">Game.update_board</tt> method handles the updating of a game between two players.</p>
<pre class="code javascript literal-block">
<span class="nx">Game</span><span class="p">.</span><span class="nx">update_board</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">game_id</span><span class="p">,</span> <span class="nx">next_sid</span><span class="p">,</span> <span class="nx">board</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'games'</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
      <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">),</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">sid</span><span class="p">,</span> <span class="nx">$atomic</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">board</span><span class="o">:</span> <span class="nx">board</span><span class="p">,</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">next_sid</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;It is not your turn&quot;</span><span class="p">));</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>The parameters passed passed into <tt class="docutils literal">Game.update_board</tt> are used to locate a board where the <tt class="docutils literal">game_id</tt> and <tt class="docutils literal">current_player</tt> match. This will only happen when the caller attempting to update the board is the current player allowed to make a move. If it's not the current player the number of documents that were updated will be 0 and the method returns an error explaining that it's not that users turn to place a marker on the board.</p>
<p>If it is the callers turn to place a marker the function updates the <tt class="docutils literal">board</tt> field of the document with the new document state and sets the <tt class="docutils literal">current_player</tt> to the session id of the other player allowing the other player to play his turn next.</p>
<p>Finally let's look at the <tt class="docutils literal">Game.finalize_board</tt> where we set the final state of a game after the game is done.</p>
<pre class="code javascript literal-block">
<span class="c1">//
// Set the winner on the board if sid == null it's a draw
//
</span><span class="nx">Game</span><span class="p">.</span><span class="nx">finalize_board</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">game_id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">sid</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s1">'draw'</span> <span class="o">:</span> <span class="s1">'win'</span><span class="p">;</span>

  <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'games'</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
      <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">)}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">final_state</span><span class="o">:</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">winner</span><span class="o">:</span> <span class="nx">sid</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Failed to finalize the board with a winner or draw&quot;</span><span class="p">));</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>If the session id passed in is a <tt class="docutils literal">null</tt> value it's a draw and the <tt class="docutils literal">final_state</tt> field is set to <tt class="docutils literal">draw</tt> and the winner field to <tt class="docutils literal">null</tt>. Otherwise the <tt class="docutils literal">final_state</tt> field is set to <tt class="docutils literal">win</tt> and the <tt class="docutils literal">winner field</tt> to the winners session id.</p>
<p>We can now create, locate and update as well as finalize a game correctly and also ensure that a board is never updated by a user who's not currently allowed to.</p>
</div>
<div class="section" id="the-game-handler">
<h3><a class="toc-backref" href="#id149">The Game Handler</a></h3>
<p>Some of the things we need to ensure is that we should not be able to call functions unless we are correctly logged in as a gamer. We also need to have a way to locate a given <tt class="docutils literal">SocketIO</tt> socket given only another users session id.</p>
<p>For the first part we will implement a method called <tt class="docutils literal">is_authenticated</tt> and for the second part a method called <tt class="docutils literal">locate_connection_with_session</tt>. Bring up the file <tt class="docutils literal">lib/models/shared.js</tt> and add the methods as shown below.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic3.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">is_authenticated</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-2"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<a name="code--tic--tic3--tic3.js-pyg.html-3"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">].</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<a name="code--tic--tic3--tic3.js-pyg.html-4"></a>  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic3.js-pyg.html-5"></a><span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-6"></a>
<a name="code--tic--tic3--tic3.js-pyg.html-7"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic3.js-pyg.html-8"></a><span class="cm"> * Emit the standard error message across the SocketIO connection</span>
<a name="code--tic--tic3--tic3.js-pyg.html-9"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic3.js-pyg.html-10"></a><span class="kd">var</span> <span class="nx">emit_error</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-11"></a>  <span class="k">if</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">socket</span><span class="p">))</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-12"></a>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-13"></a>      <span class="nx">socket</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-14"></a>          <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
<a name="code--tic--tic3--tic3.js-pyg.html-15"></a>        <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--tic--tic3--tic3.js-pyg.html-16"></a>        <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span><span class="kc">true</span>
<a name="code--tic--tic3--tic3.js-pyg.html-17"></a>        <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
<a name="code--tic--tic3--tic3.js-pyg.html-18"></a>      <span class="p">});</span>
<a name="code--tic--tic3--tic3.js-pyg.html-19"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-20"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-21"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-22"></a>        <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
<a name="code--tic--tic3--tic3.js-pyg.html-23"></a>      <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--tic--tic3--tic3.js-pyg.html-24"></a>      <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span><span class="kc">true</span>
<a name="code--tic--tic3--tic3.js-pyg.html-25"></a>      <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
<a name="code--tic--tic3--tic3.js-pyg.html-26"></a>    <span class="p">});</span>
<a name="code--tic--tic3--tic3.js-pyg.html-27"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-28"></a><span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-29"></a>
<a name="code--tic--tic3--tic3.js-pyg.html-30"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic3.js-pyg.html-31"></a><span class="cm"> * Emit the standard message across the SocketIO connection</span>
<a name="code--tic--tic3--tic3.js-pyg.html-32"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic3.js-pyg.html-33"></a><span class="kd">var</span> <span class="nx">emit_message</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-34"></a>  <span class="c1">// Add event</span>
<a name="code--tic--tic3--tic3.js-pyg.html-35"></a>  <span class="nx">message</span><span class="p">.</span><span class="nx">event</span> <span class="o">=</span> <span class="nx">event</span><span class="p">;</span>
<a name="code--tic--tic3--tic3.js-pyg.html-36"></a>  <span class="c1">// Emit</span>
<a name="code--tic--tic3--tic3.js-pyg.html-37"></a>  <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
<a name="code--tic--tic3--tic3.js-pyg.html-38"></a><span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-39"></a>
<a name="code--tic--tic3--tic3.js-pyg.html-40"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic3.js-pyg.html-41"></a><span class="cm"> * Locate a specific connection by it&#39;s session id of all connections available</span>
<a name="code--tic--tic3--tic3.js-pyg.html-42"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic3.js-pyg.html-43"></a><span class="kd">var</span> <span class="nx">locate_connection_with_session</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">sid</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-44"></a>  <span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">clients</span><span class="p">();</span>
<a name="code--tic--tic3--tic3.js-pyg.html-45"></a>
<a name="code--tic--tic3--tic3.js-pyg.html-46"></a>  <span class="c1">// Locate our session id</span>
<a name="code--tic--tic3--tic3.js-pyg.html-47"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-48"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">==</span> <span class="nx">sid</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-49"></a>      <span class="k">return</span> <span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<a name="code--tic--tic3--tic3.js-pyg.html-50"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-51"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-52"></a>
<a name="code--tic--tic3--tic3.js-pyg.html-53"></a>  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<a name="code--tic--tic3--tic3.js-pyg.html-54"></a><span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-55"></a>
<a name="code--tic--tic3--tic3.js-pyg.html-56"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic3.js-pyg.html-57"></a><span class="cm"> * Emit a message to all clients minus the excluded session id connection</span>
<a name="code--tic--tic3--tic3.js-pyg.html-58"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic3.js-pyg.html-59"></a><span class="kd">var</span> <span class="nx">emit_message_all</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">exclude_sid</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-60"></a>  <span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">clients</span><span class="p">();</span>
<a name="code--tic--tic3--tic3.js-pyg.html-61"></a>
<a name="code--tic--tic3--tic3.js-pyg.html-62"></a>  <span class="c1">// Locate our session id</span>
<a name="code--tic--tic3--tic3.js-pyg.html-63"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-64"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">!=</span> <span class="nx">exclude_sid</span>
<a name="code--tic--tic3--tic3.js-pyg.html-65"></a>      <span class="o">&amp;&amp;</span> <span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span>
<a name="code--tic--tic3--tic3.js-pyg.html-66"></a>      <span class="o">&amp;&amp;</span> <span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">].</span><span class="nx">user_name</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-67"></a>      <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<a name="code--tic--tic3--tic3.js-pyg.html-68"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-69"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-70"></a><span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-71"></a>
<a name="code--tic--tic3--tic3.js-pyg.html-72"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">is_authenticated</span>                <span class="o">=</span> <span class="nx">is_authenticated</span><span class="p">;</span>
<a name="code--tic--tic3--tic3.js-pyg.html-73"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">emit_error</span>                      <span class="o">=</span> <span class="nx">emit_error</span><span class="p">;</span>
<a name="code--tic--tic3--tic3.js-pyg.html-74"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">emit_message</span>                    <span class="o">=</span> <span class="nx">emit_message</span><span class="p">;</span>
<a name="code--tic--tic3--tic3.js-pyg.html-75"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">locate_connection_with_session</span>  <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">;</span>
<a name="code--tic--tic3--tic3.js-pyg.html-76"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">emit_message_all</span>                <span class="o">=</span> <span class="nx">emit_message_all</span><span class="p">;</span>
</pre></div><p>Alright we have the plumbing we need. It's time to implement the logic we need for the game on the backend. Let's open up the <tt class="docutils literal">lib/handlers/gamer_handler.js</tt> file and get typing.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic4.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">emit_message</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_message</span>
<a name="code--tic--tic3--tic4.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">is_authenticated</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">is_authenticated</span>
<a name="code--tic--tic3--tic4.js-pyg.html-3"></a>  <span class="p">,</span> <span class="nx">locate_connection_with_session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-4"></a>                                        <span class="p">.</span><span class="nx">locate_connection_with_session</span>
<a name="code--tic--tic3--tic4.js-pyg.html-5"></a>  <span class="p">,</span> <span class="nx">emit_error</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_error</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-6"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-7"></a><span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/user&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-8"></a>  <span class="p">,</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/gamer&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-9"></a>  <span class="p">,</span> <span class="nx">game</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/game&#39;</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-10"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-11"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic4.js-pyg.html-12"></a><span class="cm"> * Locate all the available gamers by their session IDs. We do this by introspecting</span>
<a name="code--tic--tic3--tic4.js-pyg.html-13"></a><span class="cm"> * all available connections for SocketIO. However note that if we wanted to use</span>
<a name="code--tic--tic3--tic4.js-pyg.html-14"></a><span class="cm"> * the cluster functionality in Node.JS we would probably have to rewrite this as</span>
<a name="code--tic--tic3--tic4.js-pyg.html-15"></a><span class="cm"> * a lot of the users might be living in different processes and by default SocketIO</span>
<a name="code--tic--tic3--tic4.js-pyg.html-16"></a><span class="cm"> * is only single process aware.</span>
<a name="code--tic--tic3--tic4.js-pyg.html-17"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic4.js-pyg.html-18"></a><span class="kd">var</span> <span class="nx">find_all_available_gamers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-19"></a>  <span class="c1">// Easier to keep track of where we emitting messages</span>
<a name="code--tic--tic3--tic4.js-pyg.html-20"></a>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;find_all_available_gamers&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-21"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-22"></a>  <span class="c1">// Function we return that accepts the data from SocketIO</span>
<a name="code--tic--tic3--tic4.js-pyg.html-23"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-24"></a>    <span class="c1">// Ensure the user is logged on and emit an error to the </span>
<a name="code--tic--tic3--tic4.js-pyg.html-25"></a>    <span class="c1">// calling function if it&#39;s not the case</span>
<a name="code--tic--tic3--tic4.js-pyg.html-26"></a>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
<a name="code--tic--tic3--tic4.js-pyg.html-27"></a>      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-28"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-29"></a>    <span class="c1">// Locate all active socket connections</span>
<a name="code--tic--tic3--tic4.js-pyg.html-30"></a>    <span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">clients</span><span class="p">();</span>
<a name="code--tic--tic3--tic4.js-pyg.html-31"></a>    <span class="kd">var</span> <span class="nx">sids</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--tic--tic3--tic4.js-pyg.html-32"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-33"></a>    <span class="c1">// Find all the users session ids excluding the calling functions</span>
<a name="code--tic--tic3--tic4.js-pyg.html-34"></a>    <span class="c1">// this makes up all current active gamers</span>
<a name="code--tic--tic3--tic4.js-pyg.html-35"></a>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-36"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">!=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-37"></a>        <span class="nx">sids</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-38"></a>      <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-39"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-40"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-41"></a>    <span class="c1">// Locate all the gamers by their session ids</span>
<a name="code--tic--tic3--tic4.js-pyg.html-42"></a>    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findAllGamersBySids</span><span class="p">(</span><span class="nx">sids</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-43"></a>      <span class="c1">// If there is an error during the query return it to the calling function</span>
<a name="code--tic--tic3--tic4.js-pyg.html-44"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-45"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-46"></a>      <span class="c1">// Update All the gamers last active time</span>
<a name="code--tic--tic3--tic4.js-pyg.html-47"></a>      <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">updateGamersUpdatedDateBySids</span><span class="p">(</span><span class="nx">sids</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-48"></a>        <span class="c1">// If there is an error during the update return it to the calling function</span>
<a name="code--tic--tic3--tic4.js-pyg.html-49"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-50"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-51"></a>        <span class="c1">// Emit the list of gamers to the calling function on the client</span>
<a name="code--tic--tic3--tic4.js-pyg.html-52"></a>        <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-53"></a>            <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
<a name="code--tic--tic3--tic4.js-pyg.html-54"></a>          <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">gamers</span>
<a name="code--tic--tic3--tic4.js-pyg.html-55"></a>        <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-56"></a>      <span class="p">});</span>
<a name="code--tic--tic3--tic4.js-pyg.html-57"></a>    <span class="p">});</span>
<a name="code--tic--tic3--tic4.js-pyg.html-58"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-59"></a><span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-60"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-61"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic4.js-pyg.html-62"></a><span class="cm"> * Invite a gamer to play a game</span>
<a name="code--tic--tic3--tic4.js-pyg.html-63"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic4.js-pyg.html-64"></a><span class="kd">var</span> <span class="nx">invite_gamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-65"></a>  <span class="c1">// Easier to keep track of where we emitting messages</span>
<a name="code--tic--tic3--tic4.js-pyg.html-66"></a>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;invite_gamer&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-67"></a>  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;game_invite&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-68"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-69"></a>  <span class="c1">// Function we return that accepts the data from SocketIO</span>
<a name="code--tic--tic3--tic4.js-pyg.html-70"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-71"></a>    <span class="c1">// Ensure the user is logged on and emit an error to </span>
<a name="code--tic--tic3--tic4.js-pyg.html-72"></a>    <span class="c1">// the calling function if it&#39;s not the case</span>
<a name="code--tic--tic3--tic4.js-pyg.html-73"></a>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
<a name="code--tic--tic3--tic4.js-pyg.html-74"></a>      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-75"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-76"></a>    <span class="c1">// Locate the destination connection</span>
<a name="code--tic--tic3--tic4.js-pyg.html-77"></a>    <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-78"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-79"></a>    <span class="c1">// If there is no connection it means the other player went away, send an error message</span>
<a name="code--tic--tic3--tic4.js-pyg.html-80"></a>    <span class="c1">// to the calling function on the client</span>
<a name="code--tic--tic3--tic4.js-pyg.html-81"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-82"></a>      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Invited user is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-83"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-84"></a>    <span class="c1">// Grab our session id</span>
<a name="code--tic--tic3--tic4.js-pyg.html-85"></a>    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-86"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-87"></a>    <span class="c1">// Locate our gamer object using our session id</span>
<a name="code--tic--tic3--tic4.js-pyg.html-88"></a>    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findGamerBySid</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamer_doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-89"></a>      <span class="c1">// If there is an error during the query return it to the calling function</span>
<a name="code--tic--tic3--tic4.js-pyg.html-90"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-91"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-92"></a>      <span class="c1">// Invite the other player to play a game with the</span>
<a name="code--tic--tic3--tic4.js-pyg.html-93"></a>      <span class="c1">// calling player, we send the calling players session id and his gamer information</span>
<a name="code--tic--tic3--tic4.js-pyg.html-94"></a>      <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-95"></a>          <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
<a name="code--tic--tic3--tic4.js-pyg.html-96"></a>        <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-97"></a>            <span class="nx">sid</span><span class="o">:</span> <span class="nx">our_sid</span>
<a name="code--tic--tic3--tic4.js-pyg.html-98"></a>          <span class="p">,</span> <span class="nx">gamer</span><span class="o">:</span> <span class="nx">gamer_doc</span>
<a name="code--tic--tic3--tic4.js-pyg.html-99"></a>        <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-100"></a>      <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-101"></a>    <span class="p">});</span>
<a name="code--tic--tic3--tic4.js-pyg.html-102"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-103"></a><span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-104"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-105"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic4.js-pyg.html-106"></a><span class="cm"> * Handles the users decision to decline an invitation to a game</span>
<a name="code--tic--tic3--tic4.js-pyg.html-107"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic4.js-pyg.html-108"></a><span class="kd">var</span> <span class="nx">decline_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-109"></a>  <span class="c1">// Easier to keep track of where we emitting messages</span>
<a name="code--tic--tic3--tic4.js-pyg.html-110"></a>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;decline_game&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-111"></a>  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;invite_gamer&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-112"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-113"></a>  <span class="c1">// Function we return that accepts the data from SocketIO</span>
<a name="code--tic--tic3--tic4.js-pyg.html-114"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-115"></a>    <span class="c1">// Ensure the user is logged on and emit an error to the </span>
<a name="code--tic--tic3--tic4.js-pyg.html-116"></a>    <span class="c1">// calling function if it&#39;s not the case</span>
<a name="code--tic--tic3--tic4.js-pyg.html-117"></a>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
<a name="code--tic--tic3--tic4.js-pyg.html-118"></a>      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-119"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-120"></a>    <span class="c1">// Grab our session id</span>
<a name="code--tic--tic3--tic4.js-pyg.html-121"></a>    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-122"></a>    <span class="c1">// Locate the destination connection</span>
<a name="code--tic--tic3--tic4.js-pyg.html-123"></a>    <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-124"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-125"></a>    <span class="c1">// If there is no connection it means the other player went away, send an error message</span>
<a name="code--tic--tic3--tic4.js-pyg.html-126"></a>    <span class="c1">// to the calling function on the client</span>
<a name="code--tic--tic3--tic4.js-pyg.html-127"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-128"></a>      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-129"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-130"></a>    <span class="c1">// Send an error to the player who sent the invite, outlining the decline of the offer</span>
<a name="code--tic--tic3--tic4.js-pyg.html-131"></a>    <span class="c1">// to play a game</span>
<a name="code--tic--tic3--tic4.js-pyg.html-132"></a>    <span class="nx">emit_error</span><span class="p">(</span><span class="nx">invite_gamer</span><span class="p">,</span> <span class="s2">&quot;User declined game&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-133"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-134"></a><span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-135"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-136"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic4.js-pyg.html-137"></a><span class="cm"> * Handles the users decision to accept an invitation to play a game</span>
<a name="code--tic--tic3--tic4.js-pyg.html-138"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic4.js-pyg.html-139"></a><span class="kd">var</span> <span class="nx">accept_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-140"></a>  <span class="c1">// Easier to keep track of where we emitting messages</span>
<a name="code--tic--tic3--tic4.js-pyg.html-141"></a>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;accept_game&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-142"></a>  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;invite_gamer&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-143"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-144"></a>  <span class="c1">// Function we return that accepts the data from SocketIO</span>
<a name="code--tic--tic3--tic4.js-pyg.html-145"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-146"></a>    <span class="c1">// Ensure the user is logged on and emit an error to the calling </span>
<a name="code--tic--tic3--tic4.js-pyg.html-147"></a>    <span class="c1">// function if it&#39;s not the case</span>
<a name="code--tic--tic3--tic4.js-pyg.html-148"></a>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
<a name="code--tic--tic3--tic4.js-pyg.html-149"></a>      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-150"></a>    <span class="c1">// Our session id</span>
<a name="code--tic--tic3--tic4.js-pyg.html-151"></a>    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-152"></a>    <span class="c1">// Locate the destination connection</span>
<a name="code--tic--tic3--tic4.js-pyg.html-153"></a>    <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-154"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-155"></a>    <span class="c1">// If there is no connection it means the other player went away, send an error message</span>
<a name="code--tic--tic3--tic4.js-pyg.html-156"></a>    <span class="c1">// to the calling function on the client</span>
<a name="code--tic--tic3--tic4.js-pyg.html-157"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-158"></a>      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-159"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-160"></a>    <span class="c1">// Locate both the calling player and the destination player by their session ids</span>
<a name="code--tic--tic3--tic4.js-pyg.html-161"></a>    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findAllGamersBySids</span><span class="p">([</span><span class="nx">our_sid</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">players</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-162"></a>      <span class="c1">// If we have an error notify both the inviter and </span>
<a name="code--tic--tic3--tic4.js-pyg.html-163"></a>      <span class="c1">// the invited player about an error</span>
<a name="code--tic--tic3--tic4.js-pyg.html-164"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="nx">players</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-165"></a>        <span class="nx">emit_error</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="s2">&quot;Failed to locate players for game acceptance&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-166"></a>        <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span>
<a name="code--tic--tic3--tic4.js-pyg.html-167"></a>          <span class="p">,</span> <span class="s2">&quot;Failed to locate players for game acceptance&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-168"></a>      <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-169"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-170"></a>      <span class="c1">// Grab player 1 and player 2 from the results</span>
<a name="code--tic--tic3--tic4.js-pyg.html-171"></a>      <span class="kd">var</span> <span class="nx">p1</span> <span class="o">=</span> <span class="nx">players</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a name="code--tic--tic3--tic4.js-pyg.html-172"></a>      <span class="kd">var</span> <span class="nx">p2</span> <span class="o">=</span> <span class="nx">players</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a name="code--tic--tic3--tic4.js-pyg.html-173"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-174"></a>      <span class="c1">// Create a new game with player 1 and player 2</span>
<a name="code--tic--tic3--tic4.js-pyg.html-175"></a>      <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">create_game</span><span class="p">(</span><span class="nx">p1</span><span class="p">.</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">p1</span><span class="p">.</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">p1</span><span class="p">.</span><span class="nx">full_name</span>
<a name="code--tic--tic3--tic4.js-pyg.html-176"></a>        <span class="p">,</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">full_name</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game_doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-177"></a>          <span class="c1">// If we have an error notify both the inviter and the invited player about an error</span>
<a name="code--tic--tic3--tic4.js-pyg.html-178"></a>          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-179"></a>            <span class="nx">emit_error</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="s2">&quot;Failed to create a new game&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-180"></a>            <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Failed to create a new game&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-181"></a>          <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-182"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-183"></a>          <span class="c1">// We have a new game, notify both players about the new game information</span>
<a name="code--tic--tic3--tic4.js-pyg.html-184"></a>          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">game_doc</span> <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-185"></a>          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">game_doc</span> <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-186"></a>      <span class="p">});</span>
<a name="code--tic--tic3--tic4.js-pyg.html-187"></a>    <span class="p">});</span>
<a name="code--tic--tic3--tic4.js-pyg.html-188"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-189"></a><span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-190"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-191"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic4.js-pyg.html-192"></a><span class="cm"> * Handles the users decision to accept an invitation to play a game</span>
<a name="code--tic--tic3--tic4.js-pyg.html-193"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic4.js-pyg.html-194"></a><span class="kd">var</span> <span class="nx">place_marker</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-195"></a>  <span class="c1">// Easier to keep track of where we emitting messages</span>
<a name="code--tic--tic3--tic4.js-pyg.html-196"></a>  <span class="kd">var</span> <span class="nx">calling_method_name</span>      <span class="o">=</span> <span class="s2">&quot;place_marker&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-197"></a>  <span class="kd">var</span> <span class="nx">event_name_move</span>          <span class="o">=</span> <span class="s2">&quot;game_move&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-198"></a>  <span class="kd">var</span> <span class="nx">event_name_game_over</span>     <span class="o">=</span> <span class="s2">&quot;game_over&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-199"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-200"></a>  <span class="c1">// Function we return that accepts the data from SocketIO</span>
<a name="code--tic--tic3--tic4.js-pyg.html-201"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-202"></a>    <span class="c1">// Ensure the user is logged on and emit an error to the </span>
<a name="code--tic--tic3--tic4.js-pyg.html-203"></a>    <span class="c1">// calling function if it&#39;s not the case</span>
<a name="code--tic--tic3--tic4.js-pyg.html-204"></a>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
<a name="code--tic--tic3--tic4.js-pyg.html-205"></a>      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-206"></a>    <span class="c1">// Grab our session id</span>
<a name="code--tic--tic3--tic4.js-pyg.html-207"></a>    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-208"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-209"></a>    <span class="c1">// Locate the game we want to place a marker on</span>
<a name="code--tic--tic3--tic4.js-pyg.html-210"></a>    <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">find_game</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game_doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-211"></a>      <span class="c1">// If there is an error during the query return it to the calling function</span>
<a name="code--tic--tic3--tic4.js-pyg.html-212"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Could not find the game&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-213"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-214"></a>      <span class="c1">// Let&#39;s get the current board in play</span>
<a name="code--tic--tic3--tic4.js-pyg.html-215"></a>      <span class="kd">var</span> <span class="nx">board</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">board</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-216"></a>      <span class="c1">// Get the marker for the calling player (if we are the starting player we are X)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-217"></a>      <span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">starting_player</span> <span class="o">==</span> <span class="nx">our_sid</span> <span class="o">?</span> <span class="s2">&quot;x&quot;</span> <span class="o">:</span> <span class="s2">&quot;o&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-218"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-219"></a>      <span class="c1">// Locate other players session id</span>
<a name="code--tic--tic3--tic4.js-pyg.html-220"></a>      <span class="kd">var</span> <span class="nx">other_player_sid</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span> <span class="o">==</span> <span class="nx">our_sid</span>
<a name="code--tic--tic3--tic4.js-pyg.html-221"></a>        <span class="o">?</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player2_sid</span>
<a name="code--tic--tic3--tic4.js-pyg.html-222"></a>        <span class="o">:</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-223"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-224"></a>      <span class="c1">// If we are trying to set a cell that&#39;s already set emit </span>
<a name="code--tic--tic3--tic4.js-pyg.html-225"></a>      <span class="c1">// an error to the calling function</span>
<a name="code--tic--tic3--tic4.js-pyg.html-226"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span> <span class="o">||</span> <span class="nx">board</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-227"></a>        <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Cell already selected&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-228"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-229"></a>      <span class="c1">// Mark the cell with our marker</span>
<a name="code--tic--tic3--tic4.js-pyg.html-230"></a>      <span class="nx">board</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="nx">marker</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-231"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-232"></a>      <span class="c1">// Attempt to update the board</span>
<a name="code--tic--tic3--tic4.js-pyg.html-233"></a>      <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">update_board</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">other_player_sid</span><span class="p">,</span> <span class="nx">board</span>
<a name="code--tic--tic3--tic4.js-pyg.html-234"></a>        <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-235"></a>          <span class="c1">// If we have an error it was not our turn</span>
<a name="code--tic--tic3--tic4.js-pyg.html-236"></a>          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-237"></a>            <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Not your turn&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-238"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-239"></a>          <span class="c1">// Locate the destination connection</span>
<a name="code--tic--tic3--tic4.js-pyg.html-240"></a>          <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">other_player_sid</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-241"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-242"></a>          <span class="c1">// If there is no connection it means the other player went away, </span>
<a name="code--tic--tic3--tic4.js-pyg.html-243"></a>          <span class="c1">// send an error message to the calling function on the client</span>
<a name="code--tic--tic3--tic4.js-pyg.html-244"></a>          <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-245"></a>            <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-246"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-247"></a>          <span class="c1">// Emit valid move message to caller and the other player</span>
<a name="code--tic--tic3--tic4.js-pyg.html-248"></a>          <span class="c1">// this notifies the clients that they can draw the marker on the board</span>
<a name="code--tic--tic3--tic4.js-pyg.html-249"></a>          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
<a name="code--tic--tic3--tic4.js-pyg.html-250"></a>            <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">y</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="o">:</span> <span class="nx">marker</span><span class="p">}</span> <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-251"></a>            <span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-252"></a>          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_move</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
<a name="code--tic--tic3--tic4.js-pyg.html-253"></a>            <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">y</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="o">:</span> <span class="nx">marker</span><span class="p">}</span> <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-254"></a>            <span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-255"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-256"></a>          <span class="c1">// If there was no winner this turn</span>
<a name="code--tic--tic3--tic4.js-pyg.html-257"></a>          <span class="k">if</span><span class="p">(</span><span class="nx">is_game_over</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="p">)</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-258"></a>            <span class="c1">// If there are still fields left on the board, let&#39;s keep playing</span>
<a name="code--tic--tic3--tic4.js-pyg.html-259"></a>            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_game_draw</span><span class="p">(</span><span class="nx">board</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-260"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-261"></a>            <span class="c1">// Set the winner</span>
<a name="code--tic--tic3--tic4.js-pyg.html-262"></a>            <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">finalize_board</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-263"></a>              <span class="c1">// If we have an error it was not our turn</span>
<a name="code--tic--tic3--tic4.js-pyg.html-264"></a>              <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-265"></a>                <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span>
<a name="code--tic--tic3--tic4.js-pyg.html-266"></a>                  <span class="p">,</span> <span class="s2">&quot;Failed to set winner on table&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-267"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-268"></a>              <span class="c1">// If there are no open spots left on the board the game</span>
<a name="code--tic--tic3--tic4.js-pyg.html-269"></a>              <span class="c1">// is a draw</span>
<a name="code--tic--tic3--tic4.js-pyg.html-270"></a>              <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span>
<a name="code--tic--tic3--tic4.js-pyg.html-271"></a>                <span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">draw</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span> <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-272"></a>              <span class="k">return</span> <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span>
<a name="code--tic--tic3--tic4.js-pyg.html-273"></a>                <span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">draw</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span> <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-274"></a>            <span class="p">});</span>
<a name="code--tic--tic3--tic4.js-pyg.html-275"></a>          <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-276"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-277"></a>          <span class="c1">// Set the winner</span>
<a name="code--tic--tic3--tic4.js-pyg.html-278"></a>          <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">finalize_board</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-279"></a>            <span class="c1">// If we have an error it was not our turn</span>
<a name="code--tic--tic3--tic4.js-pyg.html-280"></a>            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-281"></a>              <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span>
<a name="code--tic--tic3--tic4.js-pyg.html-282"></a>                <span class="p">,</span> <span class="s2">&quot;Failed to set winner on table&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-283"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-284"></a>            <span class="c1">// There was a winner and it was the last user to place a </span>
<a name="code--tic--tic3--tic4.js-pyg.html-285"></a>            <span class="c1">// marker (the calling client) signal both players who won the game</span>
<a name="code--tic--tic3--tic4.js-pyg.html-286"></a>            <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span>
<a name="code--tic--tic3--tic4.js-pyg.html-287"></a>              <span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">winner</span><span class="o">:</span> <span class="nx">our_sid</span><span class="p">}</span> <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-288"></a>            <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span>
<a name="code--tic--tic3--tic4.js-pyg.html-289"></a>              <span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">winner</span><span class="o">:</span> <span class="nx">our_sid</span><span class="p">}</span> <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-290"></a>          <span class="p">});</span>
<a name="code--tic--tic3--tic4.js-pyg.html-291"></a>      <span class="p">})</span>
<a name="code--tic--tic3--tic4.js-pyg.html-292"></a>    <span class="p">});</span>
<a name="code--tic--tic3--tic4.js-pyg.html-293"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-294"></a><span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-295"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-296"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic4.js-pyg.html-297"></a><span class="cm"> * Checks if all the spaces in the board have been used</span>
<a name="code--tic--tic3--tic4.js-pyg.html-298"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic4.js-pyg.html-299"></a><span class="kd">var</span> <span class="nx">is_game_draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">board</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-300"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-301"></a>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-302"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-303"></a>        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-304"></a>      <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-305"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-306"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-307"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-308"></a>  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-309"></a><span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-310"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-311"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic4.js-pyg.html-312"></a><span class="cm"> * Checks from a given marker position if it&#39;s a winner</span>
<a name="code--tic--tic3--tic4.js-pyg.html-313"></a><span class="cm"> * on the horizontal, vertical or diagonal</span>
<a name="code--tic--tic3--tic4.js-pyg.html-314"></a><span class="cm"> *</span>
<a name="code--tic--tic3--tic4.js-pyg.html-315"></a><span class="cm"> * [0, 0, 0] [0, 1, 0] [1, 0, 0] [0, 0, 1]</span>
<a name="code--tic--tic3--tic4.js-pyg.html-316"></a><span class="cm"> * [1, 1, 1] [0, 1, 0] [0, 1, 0] [0, 1, 0]</span>
<a name="code--tic--tic3--tic4.js-pyg.html-317"></a><span class="cm"> * [0, 0, 0] [0, 1, 0] [0, 0, 1] [1, 0, 0]</span>
<a name="code--tic--tic3--tic4.js-pyg.html-318"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic4.js-pyg.html-319"></a><span class="kd">var</span> <span class="nx">is_game_over</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-320"></a>  <span class="c1">// Check the x and y for the following ranges</span>
<a name="code--tic--tic3--tic4.js-pyg.html-321"></a>  <span class="kd">var</span> <span class="nx">found_vertical</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-322"></a>  <span class="kd">var</span> <span class="nx">found_horizontal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-323"></a>  <span class="kd">var</span> <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-324"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-325"></a>  <span class="c1">// y and x = 0 to x = n</span>
<a name="code--tic--tic3--tic4.js-pyg.html-326"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-327"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-328"></a>      <span class="nx">found_horizontal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-329"></a>      <span class="k">break</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-330"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-331"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-332"></a>  <span class="c1">// Found a winning position</span>
<a name="code--tic--tic3--tic4.js-pyg.html-333"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">found_horizontal</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-334"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-335"></a>  <span class="c1">// x and y = 0 to y = n</span>
<a name="code--tic--tic3--tic4.js-pyg.html-336"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-337"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-338"></a>      <span class="nx">found_vertical</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-339"></a>      <span class="k">break</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-340"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-341"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-342"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-343"></a>  <span class="c1">// Found a winning position</span>
<a name="code--tic--tic3--tic4.js-pyg.html-344"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">found_vertical</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-345"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-346"></a>  <span class="c1">// 0, 0 to n, n along the diagonal</span>
<a name="code--tic--tic3--tic4.js-pyg.html-347"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-348"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-349"></a>      <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-350"></a>      <span class="k">break</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-351"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-352"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-353"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-354"></a>  <span class="c1">// Found a winning position</span>
<a name="code--tic--tic3--tic4.js-pyg.html-355"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">found_diagonal</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-356"></a>  <span class="c1">// Reset found diagonal</span>
<a name="code--tic--tic3--tic4.js-pyg.html-357"></a>  <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-358"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-359"></a>  <span class="c1">// n, 0 to 0, n along the diagonal</span>
<a name="code--tic--tic3--tic4.js-pyg.html-360"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-361"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-362"></a>      <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-363"></a>      <span class="k">break</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-364"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-365"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-366"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-367"></a>  <span class="c1">// Return result of looking in the diagonal</span>
<a name="code--tic--tic3--tic4.js-pyg.html-368"></a>  <span class="k">return</span> <span class="nx">found_diagonal</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-369"></a><span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-370"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-371"></a><span class="c1">// Export functions</span>
<a name="code--tic--tic3--tic4.js-pyg.html-372"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">find_all_available_gamers</span> <span class="o">=</span> <span class="nx">find_all_available_gamers</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-373"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">invite_gamer</span>              <span class="o">=</span> <span class="nx">invite_gamer</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-374"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">accept_game</span>               <span class="o">=</span> <span class="nx">accept_game</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-375"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">decline_game</span>              <span class="o">=</span> <span class="nx">decline_game</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-376"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">place_marker</span>              <span class="o">=</span> <span class="nx">place_marker</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-377"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">is_game_over</span>              <span class="o">=</span> <span class="nx">is_game_over</span><span class="p">;</span>
</pre></div></div>
<div class="section" id="the-find-all-available-gamers-handler">
<h3><a class="toc-backref" href="#id150">The find_all_available_gamers Handler</a></h3>
<p>You might have noticed that the file is fairly big so we will go through each method in turn to make it more manageable. Let's start with the <tt class="docutils literal">find_all_available_gamers</tt> method. This method retrieves a list of all <tt class="docutils literal">Gamer</tt> documents for gamers who are currently active (as in connected to the server using <tt class="docutils literal">SocketIO</tt>)</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Locate all the available gamers by their session ids. We do this by introspecting
 * all available connections for SocketIO. However note that if we wanted to use
 * the cluster functionality in Node.JS we would probably have to rewrite this as
 * a lot of the users might be living in different processes and by default SocketIO
 * is only single process aware.
 */</span>
<span class="kd">var</span> <span class="nx">find_all_available_gamers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages
</span>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;find_all_available_gamers&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO
</span>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling
</span>    <span class="c1">// function if it's not the case
</span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Locate all active socket connections
</span>    <span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">clients</span><span class="p">(</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">sids</span> <span class="o">=</span> <span class="p">[</span><span class="p">];</span>

    <span class="c1">// Find all the users session ids excluding the calling functions
</span>    <span class="c1">// this makes up all current active gamers
</span>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">!=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sids</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Locate all the gamers by their session ids
</span>    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findAllGamersBySids</span><span class="p">(</span><span class="nx">sids</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If there is an error during the query return it to the calling function
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

      <span class="c1">// Update All the gamers last active time
</span>      <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">updateGamersUpdatedDateBySids</span><span class="p">(</span><span class="nx">sids</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If there is an error during the update return it to the calling function
</span>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

        <span class="c1">// Emit the list of gamers to the calling function on the client
</span>        <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
          <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">gamers</span>
        <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The very start of the method performs an <tt class="docutils literal">is_authenticated</tt> verifying that the socket passed in is an authenticated session. If it's not valid we return an error notifying the user that they are not authenticated and unable to call this method. If the caller is authenticated we get all active <tt class="docutils literal">SocketIO</tt> clients and get a list of all session ids for active players. Once we have the list of active players we retrieve all the <tt class="docutils literal">Gamer</tt> documents associated with those session ids, and finally update the last active time stamp for those players before returning the list to the caller.</p>
</div>
<div class="section" id="the-invite-gamer-handler">
<h3><a class="toc-backref" href="#id151">The invite_gamer Handler</a></h3>
<p>The next method concerns the act of inviting another player to play a game. Let's have a look at the code.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Invite a gamer to play a game
 */</span>
<span class="kd">var</span> <span class="nx">invite_gamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages
</span>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;invite_gamer&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;game_invite&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO
</span>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling
</span>    <span class="c1">// function if it's not the case
</span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Locate the destination connection
</span>    <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>

    <span class="c1">// If there is no connection it means the other player went away, send an error message
</span>    <span class="c1">// to the calling function on the client
</span>    <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span>
        <span class="p">,</span> <span class="s2">&quot;Invited user is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Grab our session id
</span>    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>

    <span class="c1">// Locate our gamer object using our session id
</span>    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findGamerBySid</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamer_doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If there is an error during the query return it to the calling function
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

      <span class="c1">// Invite the other player to play a game with the
</span>      <span class="c1">// calling player, we send the calling players session id and
</span>      <span class="c1">// his gamer information
</span>      <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">sid</span><span class="o">:</span> <span class="nx">our_sid</span>
          <span class="p">,</span> <span class="nx">gamer</span><span class="o">:</span> <span class="nx">gamer_doc</span>
        <span class="p">}</span>
      <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>So just as in the <tt class="docutils literal">find_all_available_gamers</tt> method this method can only be called if the caller is authenticated correctly. Notice how we are calling the <tt class="docutils literal">locate_connection_with_session</tt> method. We only have the session id of the player we wish to invite to a game, so we use this function to locate their <tt class="docutils literal">SocketIO</tt> socket allowing us to communicate with them.</p>
<p>If no connection is found we notify the caller about the missing player, otherwise we locate the <tt class="docutils literal">Gamer</tt> instance for the player and send them a <tt class="docutils literal">game_invite</tt> message so they get notified about the invitation. The <tt class="docutils literal">game_invite</tt> message includes the session id of the gamer making the invitation and the <tt class="docutils literal">Gamer</tt> document of the inviting player allowing the invited player to know who sent the invite.</p>
</div>
<div class="section" id="the-decline-game-handler">
<h3><a class="toc-backref" href="#id152">The decline_game Handler</a></h3>
<p>The next method covers the case where the invited gamer decides to decline the invitation to play a game. Let's take a look at the code for the <tt class="docutils literal">decline_game</tt> method.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Handles the users decision to decline an invitation to a game
 */</span>
<span class="kd">var</span> <span class="nx">decline_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages
</span>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;decline_game&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;invite_gamer&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO
</span>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling
</span>    <span class="c1">// function if it's not the case
</span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Grab our session id
</span>    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
    <span class="c1">// Locate the destination connection
</span>    <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>

    <span class="c1">// If there is no connection it means the other player went away,
</span>    <span class="c1">// send an error message to the calling function on the client
</span>    <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Send an error to the player who sent the invite, outlining the
</span>    <span class="c1">// decline of the offer to play a game
</span>    <span class="nx">emit_error</span><span class="p">(</span><span class="nx">invite_gamer</span><span class="p">,</span> <span class="s2">&quot;User declined game&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The premise for this method is that the player that received the game invitation decides to decline the invitation. Since the invitation contains the inviting users session id we can locate the connection associated with this session id and if it's present, issue the decline as an error to that users <tt class="docutils literal">SocketIO</tt> socket.</p>
<p>Remember how an <tt class="docutils literal">API</tt> method in the frontend registers a callback with an event waiting for a return message from <tt class="docutils literal">SocketIO</tt> containing that event. In the <tt class="docutils literal">invite_gamer</tt> handler we did not actually issue a message with the event <tt class="docutils literal">invite_gamer</tt>. This left the calling method on the frontend waiting for a message with the <tt class="docutils literal">invite_gamer</tt> event. We now notify the original inviter that the game invitation was declined. This usage of events lets us decouple the server processing from the frontend as we only need to notify the frontend by sending events when we are done. This let's us orchestrate interactions between multiple browsers.</p>
</div>
<div class="section" id="the-accept-game-handler">
<h3><a class="toc-backref" href="#id153">The accept_game Handler</a></h3>
<p>The last method that is part of the invite game cycle is the <tt class="docutils literal">accept_game</tt> method. This method lets a player accept an invitation to play a game. Let's take a look at the code.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Handles the users decision to accept an invitation to play a game
 */</span>
<span class="kd">var</span> <span class="nx">accept_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages
</span>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;accept_game&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;invite_gamer&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO
</span>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling
</span>    <span class="c1">// function if it's not the case
</span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
    <span class="c1">// Our session id
</span>    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
    <span class="c1">// Locate the destination connection
</span>    <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>

    <span class="c1">// If there is no connection it means the other player went away, send an error message
</span>    <span class="c1">// to the calling function on the client
</span>    <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Locate both the calling player and the destination player by their session ids
</span>    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findAllGamersBySids</span><span class="p">(</span><span class="p">[</span><span class="nx">our_sid</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">players</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error notify both the inviter and the invited player about an error
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="nx">players</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">emit_error</span><span class="p">(</span><span class="nx">event_name</span>
          <span class="p">,</span> <span class="s2">&quot;Failed to locate players for game acceptance&quot;</span>
          <span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span>
                  <span class="p">,</span> <span class="s2">&quot;Failed to locate players for game acceptance&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// Grab player 1 and player 2 from the results
</span>      <span class="kd">var</span> <span class="nx">p1</span> <span class="o">=</span> <span class="nx">players</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">p2</span> <span class="o">=</span> <span class="nx">players</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

      <span class="c1">// Create a new game with player 1 and player 2
</span>      <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">create_game</span><span class="p">(</span><span class="nx">p1</span><span class="p">.</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">p1</span><span class="p">.</span><span class="nx">user_name</span>
        <span class="p">,</span> <span class="nx">p1</span><span class="p">.</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">full_name</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game_doc</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// If we have an error notify both the inviter and the invited player
</span>          <span class="c1">// about an error
</span>          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">emit_error</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="s2">&quot;Failed to create a new game&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Failed to create a new game&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
          <span class="p">}</span>

          <span class="c1">// We have a new game, notify both players about the new game information
</span>          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">game_doc</span> <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">game_doc</span> <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The <tt class="docutils literal">accept_game</tt> method is slightly more complicated than the previous <tt class="docutils literal">reject_game</tt> method but take heart it's not as bad as it looks.</p>
<p>First we check if the other player is still available and if he is, we locate both of the player's <tt class="docutils literal">Gamer</tt> information by using the <tt class="docutils literal">Gamer.findAllGamersBySids</tt> method. If we don't get back two documents we return an error to both players telling them we could not find the two players (the emphasis is we notify both of the players at the same time emitting an error on each players socket).</p>
<p>If we do find two <tt class="docutils literal">Gamer</tt> object we create a new <tt class="docutils literal">Game</tt> for the two players. If there is no error during the creation of the game we notify both players (the calling player and the other player that originally sent the invitation) about the successful acceptance of the game invitation.</p>
<p>That's the whole invite and accept/decline and invitation part of the application. Next up is the actual game play. This contains changes both for the backend and the frontend of our application.</p>
</div>
<div class="section" id="the-place-marker-handler">
<h3><a class="toc-backref" href="#id154">The place_marker Handler</a></h3>
<p>The <tt class="docutils literal">place_marker</tt> method handles the actual game play between two players. It checks if the game has been won by one of the players or if it ended in a draw. It also updates the board to reflect the last move. Let's have a look at the code.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Handles the users decision to accept an invitation to play a game
 */</span>
<span class="kd">var</span> <span class="nx">place_marker</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages
</span>  <span class="kd">var</span> <span class="nx">calling_method_name</span>      <span class="o">=</span> <span class="s2">&quot;place_marker&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name_move</span>          <span class="o">=</span> <span class="s2">&quot;game_move&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name_game_over</span>     <span class="o">=</span> <span class="s2">&quot;game_over&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO
</span>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling
</span>    <span class="c1">// function if it's not the case
</span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
    <span class="c1">// Grab our session id
</span>    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>

    <span class="c1">// Locate the game we want to place a marker on
</span>    <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">find_game</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game_doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If there is an error during the query return it to the calling function
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Could not find the game&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

      <span class="c1">// Let's get the current board in play
</span>      <span class="kd">var</span> <span class="nx">board</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">board</span><span class="p">;</span>
      <span class="c1">// Get the marker for the calling player (if we are the starting player we are X)
</span>      <span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">starting_player</span> <span class="o">==</span> <span class="nx">our_sid</span> <span class="o">?</span> <span class="s2">&quot;x&quot;</span> <span class="o">:</span> <span class="s2">&quot;o&quot;</span><span class="p">;</span>

      <span class="c1">// Locate other players session id
</span>      <span class="kd">var</span> <span class="nx">other_player_sid</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span> <span class="o">==</span> <span class="nx">our_sid</span>
        <span class="o">?</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player2_sid</span>
        <span class="o">:</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span><span class="p">;</span>

      <span class="c1">// If we are trying to set a cell that's already set emit an error
</span>      <span class="c1">// to the calling function
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span> <span class="o">||</span> <span class="nx">board</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Cell already selected&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span><span class="p">;</span>

      <span class="c1">// Mark the cell with our marker
</span>      <span class="nx">board</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="nx">marker</span><span class="p">;</span>

      <span class="c1">// Attempt to update the board
</span>      <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">update_board</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">other_player_sid</span><span class="p">,</span> <span class="nx">board</span>
        <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// If we have an error it was not our turn
</span>          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Not your turn&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

          <span class="c1">// Locate the destination connection
</span>          <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">other_player_sid</span><span class="p">);</span>

          <span class="c1">// If there is no connection it means the other player went
</span>          <span class="c1">// away, send an error message to the calling function on the client
</span>          <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span>
              <span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

          <span class="c1">// Emit valid move message to caller and the other player
</span>          <span class="c1">// this notifies the clients that they can draw the marker on the board
</span>          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
            <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">y</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="o">:</span> <span class="nx">marker</span><span class="p">}</span> <span class="p">}</span>
            <span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_move</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
            <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">y</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="o">:</span> <span class="nx">marker</span><span class="p">}</span> <span class="p">}</span>
            <span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>

          <span class="c1">// If there was no winner this turn
</span>          <span class="k">if</span><span class="p">(</span><span class="nx">is_game_over</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="p">)</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If there are still fields left on the board, let's keep playing
</span>            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_game_draw</span><span class="p">(</span><span class="nx">board</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

            <span class="c1">// Set the winner
</span>            <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">finalize_board</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
              <span class="c1">// If we have an error it was not our turn
</span>              <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
                <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span>
                  <span class="p">,</span> <span class="s2">&quot;Failed to set winner on table&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

              <span class="c1">// If there are no open spots left on the board the game
</span>              <span class="c1">// is a draw
</span>              <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span>
                <span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">draw</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span> <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
              <span class="k">return</span> <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span>
                <span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">draw</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span> <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
            <span class="p">});</span>
          <span class="p">}</span>

          <span class="c1">// Set the winner
</span>          <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">finalize_board</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If we have an error it was not our turn
</span>            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
              <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span>
                <span class="p">,</span> <span class="s2">&quot;Failed to set winner on table&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

            <span class="c1">// There was a winner and it was the last user to place a
</span>            <span class="c1">// marker (the calling client) signal both players who won the game
</span>            <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span>
              <span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">winner</span><span class="o">:</span> <span class="nx">our_sid</span><span class="p">}</span> <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
            <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span>
              <span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">winner</span><span class="o">:</span> <span class="nx">our_sid</span><span class="p">}</span> <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">})</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The first thing we attempt is to locate the game by the <tt class="docutils literal">game_id</tt> passed in over the <tt class="docutils literal">SocketIO</tt> connection. If we locate a game we grab the game board and assign the calling player a marker.</p>
<p>If the calling player is the same as the <tt class="docutils literal">starting_player</tt> off the game we get the marker <tt class="docutils literal">x</tt> otherwise we get the marker <tt class="docutils literal">o</tt>. We then establish the other players session id by looking at the board (if the called is <tt class="docutils literal">player_1</tt> then the other player is <tt class="docutils literal">player_2</tt>).</p>
<p>It's then time to verify that the co-ordinates passed to the <tt class="docutils literal">player_marker</tt> function point to an empty board position. If it's not empty we return an error to the caller informing them that the cell is already selected. If the board position is empty we place the marker on the board and attempt to update the <tt class="docutils literal">Game</tt> with the new <tt class="docutils literal">board</tt>.</p>
<p>As we discussed earlier this will only succeed if it's the player that is calling this method's turn. Once the update is performed it's time to inform both of the players about the new state of the board by emitting a message with the board position that was changed and what kind of marker was put down.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>   <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">y</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span>
      <span class="p">,</span> <span class="nx">x</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span>
      <span class="p">,</span> <span class="nx">marker</span><span class="o">:</span> <span class="nx">marker</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>After we have emitted the new board state to the frontend, so they can render the board, we try to determine if the game was won by the method's calling player. This is done using the method <tt class="docutils literal">is_game_over</tt>. Let's have a look at the logic in this method.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Checks from a given marker position if it's a winner
 * on the horizontal, vertical or diagonal
 *
 * [0, 0, 0] [0, 1, 0] [1, 0, 0] [0, 0, 1]
 * [1, 1, 1] [0, 1, 0] [0, 1, 0] [0, 1, 0]
 * [0, 0, 0] [0, 1, 0] [0, 0, 1] [1, 0, 0]
 */</span>
<span class="kd">var</span> <span class="nx">is_game_over</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Check the x and y for the following ranges
</span>  <span class="kd">var</span> <span class="nx">found_vertical</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">found_horizontal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c1">// y and x = 0 to x = n
</span>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found_horizontal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// Found a winning position
</span>  <span class="k">if</span><span class="p">(</span><span class="nx">found_horizontal</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c1">// x and y = 0 to y = n
</span>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found_vertical</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Found a winning position
</span>  <span class="k">if</span><span class="p">(</span><span class="nx">found_vertical</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c1">// 0, 0 to n, n along the diagonal
</span>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Found a winning position
</span>  <span class="k">if</span><span class="p">(</span><span class="nx">found_diagonal</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="c1">// Reset found diagonal
</span>  <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c1">// n, 0 to 0, n along the diagonal
</span>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Return result of looking in the diagonal
</span>  <span class="k">return</span> <span class="nx">found_diagonal</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p>This method checks for the four possible conditions of winning, a <tt class="docutils literal">diagonal</tt>, <tt class="docutils literal">horizontal</tt> or <tt class="docutils literal">vertical</tt> win. There are probably some shorter and smarter versions of this code, but this is left as an exercise to you the reader if you think it's important.</p>
<p>If we determine that the board is not won by the placement of the marker we check if the board is a draw, meaning all positions in the board are marked. This code is very simple and is in the <tt class="docutils literal">is_game_draw</tt> method.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Checks if all the spaces in the board have been used
 */</span>
<span class="kd">var</span> <span class="nx">is_game_draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">board</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p>We just simply check if all of the fields are marked. If they are it's a draw. A single empty field means we are not in a draw position yet and the game can continue. If we have a draw we signal the players that the game ended in a draw, sending them the following message below. We then call the <tt class="docutils literal">Game.finalize_board</tt> method passing in a null for the session id signaling a <tt class="docutils literal">draw</tt>. This updates the board to it's final state.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
    <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">draw</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
<span class="p">}</span>
</pre>
<p>If the board was won by the calling player we send the players a message containing the winners session id and then call the <tt class="docutils literal">Game.finalize_board</tt> method to finalize the board with the winning session id.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
    <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">winner</span><span class="o">:</span> <span class="nx">our_sid</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>That covers the backend API's. Before we move on to the frontend code let's wire up the handlers correctly. Open the file <tt class="docutils literal">app.js</tt> and add the new handlers.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic5.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">env</span>                        <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./env&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic5.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">main_controller</span>            <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/controllers/main_controller&#39;</span><span class="p">);</span>
<a name="code--tic--tic3--tic5.js-pyg.html-3"></a>
<a name="code--tic--tic3--tic5.js-pyg.html-4"></a><span class="kd">var</span> <span class="nx">register_handler</span>           <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/login_handler&#39;</span><span class="p">).</span><span class="nx">register_handler</span>
<a name="code--tic--tic3--tic5.js-pyg.html-5"></a>  <span class="p">,</span> <span class="nx">login_handler</span>              <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/login_handler&#39;</span><span class="p">).</span><span class="nx">login_handler</span>
<a name="code--tic--tic3--tic5.js-pyg.html-6"></a>  <span class="p">,</span> <span class="nx">find_all_available_gamers</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic5.js-pyg.html-7"></a>                                    <span class="p">.</span><span class="nx">find_all_available_gamers</span>
<a name="code--tic--tic3--tic5.js-pyg.html-8"></a>  <span class="p">,</span> <span class="nx">invite_gamer</span>               <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">).</span><span class="nx">invite_gamer</span>
<a name="code--tic--tic3--tic5.js-pyg.html-9"></a>  <span class="p">,</span> <span class="nx">decline_game</span>               <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">).</span><span class="nx">decline_game</span>
<a name="code--tic--tic3--tic5.js-pyg.html-10"></a>  <span class="p">,</span> <span class="nx">accept_game</span>                <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">).</span><span class="nx">accept_game</span>
<a name="code--tic--tic3--tic5.js-pyg.html-11"></a>  <span class="p">,</span> <span class="nx">place_marker</span>               <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">).</span><span class="nx">place_marker</span><span class="p">;</span>
<a name="code--tic--tic3--tic5.js-pyg.html-12"></a>
<a name="code--tic--tic3--tic5.js-pyg.html-13"></a><span class="nx">env</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic5.js-pyg.html-14"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
<a name="code--tic--tic3--tic5.js-pyg.html-15"></a>
<a name="code--tic--tic3--tic5.js-pyg.html-16"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic5.js-pyg.html-17"></a>  <span class="c1">// http routes</span>
<a name="code--tic--tic3--tic5.js-pyg.html-18"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic5.js-pyg.html-19"></a>  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">main_controller</span><span class="p">.</span><span class="nx">index</span><span class="p">());</span>
<a name="code--tic--tic3--tic5.js-pyg.html-20"></a>
<a name="code--tic--tic3--tic5.js-pyg.html-21"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic5.js-pyg.html-22"></a>  <span class="c1">// websocket api end point handlers (our API)</span>
<a name="code--tic--tic3--tic5.js-pyg.html-23"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic5.js-pyg.html-24"></a>  <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic5.js-pyg.html-25"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;register&#39;</span><span class="p">,</span> <span class="nx">register_handler</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
<a name="code--tic--tic3--tic5.js-pyg.html-26"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="nx">login_handler</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
<a name="code--tic--tic3--tic5.js-pyg.html-27"></a>
<a name="code--tic--tic3--tic5.js-pyg.html-28"></a>    <span class="c1">// The game invite and play methods</span>
<a name="code--tic--tic3--tic5.js-pyg.html-29"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;find_all_available_gamers&#39;</span>
<a name="code--tic--tic3--tic5.js-pyg.html-30"></a>        <span class="p">,</span> <span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
<a name="code--tic--tic3--tic5.js-pyg.html-31"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;invite_gamer&#39;</span><span class="p">,</span> <span class="nx">invite_gamer</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
<a name="code--tic--tic3--tic5.js-pyg.html-32"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;decline_game&#39;</span><span class="p">,</span> <span class="nx">decline_game</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
<a name="code--tic--tic3--tic5.js-pyg.html-33"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;accept_game&#39;</span><span class="p">,</span> <span class="nx">accept_game</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
<a name="code--tic--tic3--tic5.js-pyg.html-34"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;place_marker&#39;</span><span class="p">,</span> <span class="nx">place_marker</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
<a name="code--tic--tic3--tic5.js-pyg.html-35"></a>
<a name="code--tic--tic3--tic5.js-pyg.html-36"></a>    <span class="c1">// Fire the init message to setup the game</span>
<a name="code--tic--tic3--tic5.js-pyg.html-37"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">event</span><span class="o">:</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="nx">ok</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">});</span>
<a name="code--tic--tic3--tic5.js-pyg.html-38"></a>  <span class="p">});</span>
<a name="code--tic--tic3--tic5.js-pyg.html-39"></a>
<a name="code--tic--tic3--tic5.js-pyg.html-40"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic5.js-pyg.html-41"></a>  <span class="c1">// fire up the server</span>
<a name="code--tic--tic3--tic5.js-pyg.html-42"></a>  <span class="c1">//  </span>
<a name="code--tic--tic3--tic5.js-pyg.html-43"></a>  <span class="nx">env</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic5.js-pyg.html-44"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
<a name="code--tic--tic3--tic5.js-pyg.html-45"></a>
<a name="code--tic--tic3--tic5.js-pyg.html-46"></a>    <span class="c1">//</span>
<a name="code--tic--tic3--tic5.js-pyg.html-47"></a>    <span class="c1">// nothing to do</span>
<a name="code--tic--tic3--tic5.js-pyg.html-48"></a>    <span class="c1">//</span>
<a name="code--tic--tic3--tic5.js-pyg.html-49"></a>  <span class="p">});</span>
<a name="code--tic--tic3--tic5.js-pyg.html-50"></a><span class="p">});</span>
</pre></div><p>That's the backend taken care off and all wired up. It's time to turn our attention to the frontend part of the game.</p>
</div>
<div class="section" id="the-front-end">
<h3><a class="toc-backref" href="#id155">The Front End</a></h3>
<p>Let's get cracking on integrating our awesome backend API's on the frontend so we can play a game of Tic-Tac-Toe. Let's start by implementing the missing API calls on the frontend. Open up the <tt class="docutils literal">public/javascripts/api.js</tt> file in your editor and get typing.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic6.js-pyg.html-1"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-2"></a><span class="cm"> * Wraps the API used for the game and handles the socketIO connection</span>
<a name="code--tic--tic3--tic6.js-pyg.html-3"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-4"></a><span class="kd">var</span> <span class="nx">API</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-5"></a>  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
<a name="code--tic--tic3--tic6.js-pyg.html-6"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-7"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">domain</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-8"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">=</span> <span class="p">{};</span>
<a name="code--tic--tic3--tic6.js-pyg.html-9"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span> <span class="o">=</span> <span class="p">{};</span>
<a name="code--tic--tic3--tic6.js-pyg.html-10"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-11"></a>  <span class="c1">// Handle the data returned over the SocketIO</span>
<a name="code--tic--tic3--tic6.js-pyg.html-12"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-13"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-14"></a>    <span class="c1">// If the data object has an event member we have</span>
<a name="code--tic--tic3--tic6.js-pyg.html-15"></a>    <span class="c1">// a valid event message from the server</span>
<a name="code--tic--tic3--tic6.js-pyg.html-16"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-17"></a>      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
<a name="code--tic--tic3--tic6.js-pyg.html-18"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-19"></a>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-20"></a>          <span class="nx">data</span><span class="p">.</span><span class="nx">is_error</span> <span class="o">?</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">data</span><span class="p">)</span> <span class="o">:</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-21"></a>        <span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-22"></a>      <span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-23"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-24"></a>      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
<a name="code--tic--tic3--tic6.js-pyg.html-25"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-26"></a>        <span class="k">while</span><span class="p">(</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-27"></a>          <span class="nx">data</span><span class="p">.</span><span class="nx">is_error</span> <span class="o">?</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">pop</span><span class="p">()(</span><span class="nx">data</span><span class="p">)</span> <span class="o">:</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">pop</span><span class="p">()(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-28"></a>        <span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-29"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-30"></a>        <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
<a name="code--tic--tic3--tic6.js-pyg.html-31"></a>      <span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-32"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-33"></a>  <span class="p">});</span>
<a name="code--tic--tic3--tic6.js-pyg.html-34"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-35"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-36"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-37"></a><span class="cm"> * Register an event listener callback (will keep receiving messages)</span>
<a name="code--tic--tic3--tic6.js-pyg.html-38"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-39"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-40"></a>  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--tic--tic3--tic6.js-pyg.html-41"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-42"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-43"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-44"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-45"></a><span class="cm"> * Register an event listener callback for a single instance of the event</span>
<a name="code--tic--tic3--tic6.js-pyg.html-46"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-47"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">once</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-48"></a>  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--tic--tic3--tic6.js-pyg.html-49"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-50"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-51"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-52"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-53"></a><span class="cm"> * Register a new user</span>
<a name="code--tic--tic3--tic6.js-pyg.html-54"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-55"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-56"></a>  <span class="c1">// Do basic validation</span>
<a name="code--tic--tic3--tic6.js-pyg.html-57"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">full_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">full_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic3--tic6.js-pyg.html-58"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;Full name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic3--tic6.js-pyg.html-59"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic3--tic6.js-pyg.html-60"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;User name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic3--tic6.js-pyg.html-61"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic3--tic6.js-pyg.html-62"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;Password name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic3--tic6.js-pyg.html-63"></a>  <span class="c1">// Register callback</span>
<a name="code--tic--tic3--tic6.js-pyg.html-64"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-65"></a>  <span class="c1">// Fire message</span>
<a name="code--tic--tic3--tic6.js-pyg.html-66"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-67"></a>      <span class="nx">full_name</span><span class="o">:</span> <span class="nx">full_name</span>
<a name="code--tic--tic3--tic6.js-pyg.html-68"></a>    <span class="p">,</span> <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
<a name="code--tic--tic3--tic6.js-pyg.html-69"></a>    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
<a name="code--tic--tic3--tic6.js-pyg.html-70"></a>  <span class="p">});</span>
<a name="code--tic--tic3--tic6.js-pyg.html-71"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-72"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-73"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-74"></a><span class="cm"> * Login a user</span>
<a name="code--tic--tic3--tic6.js-pyg.html-75"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-76"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">login</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-77"></a>  <span class="c1">// Do basic validation</span>
<a name="code--tic--tic3--tic6.js-pyg.html-78"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic3--tic6.js-pyg.html-79"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;User name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic3--tic6.js-pyg.html-80"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic3--tic6.js-pyg.html-81"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;Password name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic3--tic6.js-pyg.html-82"></a>  <span class="c1">// Register callback</span>
<a name="code--tic--tic3--tic6.js-pyg.html-83"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-84"></a>  <span class="c1">// Fire message</span>
<a name="code--tic--tic3--tic6.js-pyg.html-85"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-86"></a>      <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
<a name="code--tic--tic3--tic6.js-pyg.html-87"></a>    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
<a name="code--tic--tic3--tic6.js-pyg.html-88"></a>  <span class="p">});</span>
<a name="code--tic--tic3--tic6.js-pyg.html-89"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-90"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-91"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-92"></a><span class="cm"> * Find all available gamers that are active</span>
<a name="code--tic--tic3--tic6.js-pyg.html-93"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-94"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">find_all_available_gamers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-95"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;find_all_available_gamers&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-96"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;find_all_available_gamers&quot;</span><span class="p">,</span> <span class="p">{});</span>
<a name="code--tic--tic3--tic6.js-pyg.html-97"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-98"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-99"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-100"></a><span class="cm"> * Invite a gamer to a new game</span>
<a name="code--tic--tic3--tic6.js-pyg.html-101"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-102"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">invite_gamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gamer</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-103"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;invite_gamer&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-104"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;invite_gamer&quot;</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-105"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-106"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-107"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-108"></a><span class="cm"> * Decline an invite to play a game</span>
<a name="code--tic--tic3--tic6.js-pyg.html-109"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-110"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">decline_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">invite</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-111"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;decline_game&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-112"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;decline_game&quot;</span><span class="p">,</span> <span class="nx">invite</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-113"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-114"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-115"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-116"></a><span class="cm"> * Accept an invite to play a game</span>
<a name="code--tic--tic3--tic6.js-pyg.html-117"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-118"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">accept_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">invite</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-119"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;accept_game&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-120"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;accept_game&quot;</span><span class="p">,</span> <span class="nx">invite</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-121"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-122"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-123"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-124"></a><span class="cm"> * Place a marker on a specific game at a specific location</span>
<a name="code--tic--tic3--tic6.js-pyg.html-125"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-126"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">place_marker</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-127"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;place_marker&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-128"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;place_marker&quot;</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-129"></a>      <span class="nx">game_id</span><span class="o">:</span> <span class="nx">game_id</span>
<a name="code--tic--tic3--tic6.js-pyg.html-130"></a>    <span class="p">,</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">x</span>
<a name="code--tic--tic3--tic6.js-pyg.html-131"></a>    <span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">y</span>
<a name="code--tic--tic3--tic6.js-pyg.html-132"></a>  <span class="p">});</span>
<a name="code--tic--tic3--tic6.js-pyg.html-133"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-134"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-135"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-136"></a><span class="cm"> * Simple method to create a formated error message that fits the</span>
<a name="code--tic--tic3--tic6.js-pyg.html-137"></a><span class="cm"> * format returned from the server</span>
<a name="code--tic--tic3--tic6.js-pyg.html-138"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-139"></a><span class="kd">var</span> <span class="nx">create_error</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-140"></a>  <span class="k">return</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-141"></a>      <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
<a name="code--tic--tic3--tic6.js-pyg.html-142"></a>    <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--tic--tic3--tic6.js-pyg.html-143"></a>    <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span> <span class="kc">true</span>
<a name="code--tic--tic3--tic6.js-pyg.html-144"></a>    <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
<a name="code--tic--tic3--tic6.js-pyg.html-145"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-146"></a><span class="p">}</span>
</pre></div><p>You might see that we are using two new templates one called <tt class="docutils literal">board.ms</tt> and the other called <tt class="docutils literal">decline_game.ms</tt>. Let's create the two files for now and we will get back to the contents later in the exercise.</p>
<pre class="code console literal-block">
<span class="go">touch public/templates/board.ms
touch public/templates/decline_game.ms</span>
</pre>
<p>So what kind of API calls are we missing on the frontend. Well basically we need to wire up the backend functions we created. Let's look at what those methods are.</p>
<table border="1" class="docutils">
<colgroup>
<col width="34%" />
<col width="66%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Function</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>find_all_available_gamers</td>
<td>Locate all currently active gamers in the system</td>
</tr>
<tr><td>invite_gamer</td>
<td>Invite a player to a game using their session id</td>
</tr>
<tr><td>decline_game</td>
<td>Decline an incoming invitation from another player</td>
</tr>
<tr><td>accept_game</td>
<td>Accept the invitation to a game from another player</td>
</tr>
<tr><td>place_marker</td>
<td>Attempt to place a marker on the Tic-Tac-Toe game</td>
</tr>
</tbody>
</table>
<p>As we can see the methods all map to the backend <tt class="docutils literal">API</tt> nice and cleanly. So let's start writing the frontend application code to make usage of them.</p>
<p>The first thing we want to do is to add a new dialog for the game invitations to our <tt class="docutils literal">lib/views/index.html</tt> file. Let's open up the file and add the <tt class="docutils literal">invite_box</tt> div.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic1.html-pyg.html-1"></a><span class="cp">&lt;!DOCTYPE html&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-2"></a><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span> <span class="na">ng-app=</span><span class="s">&quot;app&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-3"></a>  <span class="nt">&lt;head&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-4"></a>    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-5"></a>    <span class="nt">&lt;title&gt;</span>Tic-Tac-Toe<span class="nt">&lt;/title&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-6"></a>
<a name="code--tic--tic3--tic1.html-pyg.html-7"></a>    <span class="c">&lt;!-- Le styles --&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-8"></a>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/css/bootstrap.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-9"></a>    <span class="nt">&lt;style </span><span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-10"></a>      <span class="nt">body</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.html-pyg.html-11"></a>        <span class="k">padding-top</span><span class="o">:</span> <span class="m">60px</span><span class="p">;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-12"></a>        <span class="k">padding-bottom</span><span class="o">:</span> <span class="m">40px</span><span class="p">;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-13"></a>      <span class="p">}</span>
<a name="code--tic--tic3--tic1.html-pyg.html-14"></a>    <span class="nt">&lt;/style&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-15"></a>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/css/bootstrap-responsive.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-16"></a>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/css/app.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-17"></a>  <span class="nt">&lt;/head&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-18"></a>  <span class="nt">&lt;body&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-19"></a>    <span class="nt">&lt;div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-20"></a>      <span class="nt">&lt;ng</span><span class="na">-view</span><span class="nt">&gt;</span><span class="err">&lt;</span>/ng-view&gt;
<a name="code--tic--tic3--tic1.html-pyg.html-21"></a>    <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-22"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/jquery.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-23"></a>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/socket.io/socket.io.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-24"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/api.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-25"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/mustache.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-26"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/bootstrap.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-27"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/template_handler.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-28"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/app.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-29"></a>
<a name="code--tic--tic3--tic1.html-pyg.html-30"></a>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-31"></a>
<a name="code--tic--tic3--tic1.html-pyg.html-32"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-inverse navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-33"></a>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-34"></a>          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-35"></a>            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-navbar&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;collapse&quot;</span> <span class="na">data-target=</span><span class="s">&quot;.nav-collapse&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-36"></a>              <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-37"></a>              <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-38"></a>              <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-39"></a>            <span class="nt">&lt;/a&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-40"></a>            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;brand&quot;</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Tic-Tac-Toe<span class="nt">&lt;/a&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-41"></a>          <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-42"></a>        <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-43"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-44"></a>
<a name="code--tic--tic3--tic1.html-pyg.html-45"></a>      <span class="c">&lt;!-- Main hero unit for a primary marketing message or call to action --&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-46"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;hero-unit&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-47"></a>        <span class="nt">&lt;h1&gt;</span>Tic Tac Toe!<span class="nt">&lt;/h1&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-48"></a>        <span class="nt">&lt;p&gt;</span>Play Tic Tac Toe against your friends in this multiplayer demo.<span class="nt">&lt;/p&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-49"></a>        <span class="nt">&lt;p&gt;&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary btn-large&quot;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-50"></a>          <span class="na">href=</span><span class="s">&quot;https://github.com/christkv/tic-tac-toe&quot;</span><span class="nt">&gt;</span>Github <span class="ni">&amp;raquo;</span><span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-51"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-52"></a>
<a name="code--tic--tic3--tic1.html-pyg.html-53"></a>      <span class="c">&lt;!-- Example row of columns --&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-54"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span> <span class="na">id=</span><span class="s">&quot;view&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-55"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-56"></a>
<a name="code--tic--tic3--tic1.html-pyg.html-57"></a>      <span class="nt">&lt;hr&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-58"></a>
<a name="code--tic--tic3--tic1.html-pyg.html-59"></a>      <span class="nt">&lt;footer&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-60"></a>        <span class="nt">&lt;p&gt;</span><span class="ni">&amp;copy;</span> Christian Kvalheim 2012<span class="nt">&lt;/p&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-61"></a>      <span class="nt">&lt;/footer&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-62"></a>
<a name="code--tic--tic3--tic1.html-pyg.html-63"></a>    <span class="nt">&lt;/div&gt;</span> <span class="c">&lt;!-- /container --&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-64"></a>    <span class="c">&lt;!-- Modal --&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-65"></a>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;status_box&quot;</span> <span class="na">class=</span><span class="s">&quot;modal hide fade&quot;</span> <span class="na">tabindex=</span><span class="s">&quot;-1&quot;</span> <span class="na">role=</span><span class="s">&quot;dialog&quot;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-66"></a>    <span class="na">aria-labelledby=</span><span class="s">&quot;status_box&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-67"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-header&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-68"></a>        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;button&quot;</span> <span class="na">class=</span><span class="s">&quot;close&quot;</span> <span class="na">data-dismiss=</span><span class="s">&quot;modal&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-69"></a>          ×
<a name="code--tic--tic3--tic1.html-pyg.html-70"></a>        <span class="nt">&lt;/button&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-71"></a>        <span class="nt">&lt;h3</span> <span class="na">id=</span><span class="s">&quot;status_box_header&quot;</span><span class="nt">&gt;</span>Modal header<span class="nt">&lt;/h3&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-72"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-73"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-body&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-74"></a>        <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;status_box_body&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-75"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-76"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-footer&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-77"></a>        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">&quot;btn&quot;</span> <span class="na">data-dismiss=</span><span class="s">&quot;modal&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>Close<span class="nt">&lt;/button&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-78"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-79"></a>    <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-80"></a>
<a name="code--tic--tic3--tic1.html-pyg.html-81"></a>    <span class="c">&lt;!-- Modal --&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-82"></a>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;invite_box&quot;</span> <span class="na">class=</span><span class="s">&quot;modal hide fade&quot;</span> <span class="na">tabindex=</span><span class="s">&quot;-1&quot;</span> <span class="na">role=</span><span class="s">&quot;dialog&quot;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-83"></a>    <span class="na">aria-labelledby=</span><span class="s">&quot;invite_box&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-84"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-header&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-85"></a>        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;button&quot;</span> <span class="na">class=</span><span class="s">&quot;close&quot;</span> <span class="na">data-dismiss=</span><span class="s">&quot;modal&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-86"></a>          ×
<a name="code--tic--tic3--tic1.html-pyg.html-87"></a>        <span class="nt">&lt;/button&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-88"></a>        <span class="nt">&lt;h3</span> <span class="na">id=</span><span class="s">&quot;invite_box_header&quot;</span><span class="nt">&gt;</span>Modal header<span class="nt">&lt;/h3&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-89"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-90"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-body&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-91"></a>        <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;invite_box_body&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-92"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-93"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-footer&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-94"></a>        <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;invite_box_accept&quot;</span> <span class="na">class=</span><span class="s">&quot;btn&quot;</span> <span class="na">data-dismiss=</span><span class="s">&quot;modal&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-95"></a>          Accept
<a name="code--tic--tic3--tic1.html-pyg.html-96"></a>        <span class="nt">&lt;/button&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-97"></a>        <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;invite_box_decline&quot;</span> <span class="na">class=</span><span class="s">&quot;btn&quot;</span> <span class="na">data-dismiss=</span><span class="s">&quot;modal&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-98"></a>          Decline
<a name="code--tic--tic3--tic1.html-pyg.html-99"></a>        <span class="nt">&lt;/button&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-100"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-101"></a>    <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-102"></a>  <span class="nt">&lt;/body&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-103"></a><span class="nt">&lt;/html&gt;</span>
</pre></div><p>The <tt class="docutils literal">invite_box</tt> div adds the dialog we will present to the user when they get invited to a new game allowing them to accept/decline the invitation.</p>
<p>After adding the new dialog we need to finish writing the template for our dashboard to include the list of available players the user can play. The template is in the file <tt class="docutils literal">public/templates/dashboard.ms</tt>. Open it up and add the following code.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic1.ms-pyg.html-1"></a>&lt;div class=&quot;span8&quot;&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-2"></a>  &lt;h2&gt;All Active Users&lt;/h2&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-3"></a>  &lt;p&gt;All users currently on the system, invite them to play a game.&lt;/p&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-4"></a>  &lt;table class=&quot;table table-striped&quot;&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-5"></a>    &lt;thead&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-6"></a>      &lt;th&gt;Player&lt;/th&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-7"></a>      &lt;th&gt;&lt;/th&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-8"></a>    &lt;/thead&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-9"></a>    &lt;tbody&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-10"></a>      {{#gamers}}
<a name="code--tic--tic3--tic1.ms-pyg.html-11"></a>      &lt;tr&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-12"></a>        &lt;td width=&quot;100%&quot;&gt;{{user_name}}&lt;/td&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-13"></a>        &lt;td&gt;&lt;a href=&quot;#&quot; id=&quot;gamer_{{_id}}&quot;&gt;Play&lt;/a&gt;&lt;/td&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-14"></a>      &lt;/tr&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-15"></a>      {{/gamers}}
<a name="code--tic--tic3--tic1.ms-pyg.html-16"></a>    &lt;/tbody&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-17"></a>  &lt;/table&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-18"></a>&lt;/div&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-19"></a>&lt;div class=&quot;span4&quot;&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-20"></a>  &lt;h2&gt;The Dashboard&lt;/h2&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-21"></a>  &lt;p&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-22"></a>    The list on the left side shows all the active players (connected via socket.io)
<a name="code--tic--tic3--tic1.ms-pyg.html-23"></a>    and lets you challenge one of them to a game. Click on the play link to give it a go.
<a name="code--tic--tic3--tic1.ms-pyg.html-24"></a>  &lt;/p&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-25"></a>&lt;/div&gt;
</pre></div><p>Notice the <tt class="docutils literal"><span class="pre">{{#gamers}}</span></tt> tag that iterates through the <tt class="docutils literal">gamers</tt> array in the <tt class="docutils literal">context</tt> parameter we pass in when using the <tt class="docutils literal">TemplateHandler.prototype.setTemplate</tt> or <tt class="docutils literal">TemplateHandler.prototype.render</tt> method.</p>
<p>For each gamer we add a new row in a table with a link that has the <tt class="docutils literal">gamer_ + session id</tt> as an identifier. Later we will see how we wire up this link to be able to invite the player identified by it.</p>
<p>That's the dashboard taken care off. Let's move on and wire it up so that when you log on you can see the list of available players. Let's open up <tt class="docutils literal">public/javascripts/app.js</tt> in the editor.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic7.js-pyg.html-1"></a><span class="c1">// Contains the application state</span>
<a name="code--tic--tic3--tic7.js-pyg.html-2"></a><span class="kd">var</span> <span class="nx">application_state</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-3"></a>    <span class="nx">session_id</span><span class="o">:</span> <span class="kc">null</span>
<a name="code--tic--tic3--tic7.js-pyg.html-4"></a>  <span class="p">,</span> <span class="nx">modal</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--tic--tic3--tic7.js-pyg.html-5"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-6"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-7"></a><span class="c1">// Create an instance of the API class</span>
<a name="code--tic--tic3--tic7.js-pyg.html-8"></a><span class="kd">var</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">API</span><span class="p">();</span>
<a name="code--tic--tic3--tic7.js-pyg.html-9"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-10"></a><span class="c1">// Create a template handler with all the templates</span>
<a name="code--tic--tic3--tic7.js-pyg.html-11"></a><span class="c1">// used in the application</span>
<a name="code--tic--tic3--tic7.js-pyg.html-12"></a><span class="kd">var</span> <span class="nx">template_handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TemplateHandler</span><span class="p">({</span>
<a name="code--tic--tic3--tic7.js-pyg.html-13"></a>    <span class="s2">&quot;main&quot;</span><span class="o">:</span> <span class="s2">&quot;/templates/main.ms&quot;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-14"></a>  <span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="o">:</span> <span class="s2">&quot;/templates/dashboard.ms&quot;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-15"></a>  <span class="p">,</span> <span class="s2">&quot;board&quot;</span><span class="o">:</span> <span class="s2">&quot;/templates/board.ms&quot;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-16"></a>  <span class="p">,</span> <span class="s2">&quot;decline_game&quot;</span><span class="o">:</span> <span class="s2">&quot;/templates/decline_game.ms&quot;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-17"></a><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-18"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-19"></a><span class="c1">// Load all the templates and once it&#39;s done</span>
<a name="code--tic--tic3--tic7.js-pyg.html-20"></a><span class="c1">// register up all the initial button handlers</span>
<a name="code--tic--tic3--tic7.js-pyg.html-21"></a><span class="nx">template_handler</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-22"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-23"></a>  <span class="c1">// Render the main view in the #view div</span>
<a name="code--tic--tic3--tic7.js-pyg.html-24"></a>  <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="p">{});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-25"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-26"></a>  <span class="c1">// Wire up the buttons for the main view</span>
<a name="code--tic--tic3--tic7.js-pyg.html-27"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#register_button&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-28"></a>    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">register_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-29"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#login_button&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-30"></a>    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">login_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-31"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-32"></a>  <span class="c1">// Wire up invite box buttons (this is in the main view)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-33"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box_accept&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-34"></a>    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_accept_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-35"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box_decline&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-36"></a>    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_decline_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-37"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-38"></a>  <span class="c1">// Ensure we have the right state for the modal dialog</span>
<a name="code--tic--tic3--tic7.js-pyg.html-39"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-40"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;hide&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-41"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-42"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;hide&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-43"></a><span class="p">})</span>
<a name="code--tic--tic3--tic7.js-pyg.html-44"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-45"></a><span class="cm">/***************************************************************************************</span>
<a name="code--tic--tic3--tic7.js-pyg.html-46"></a><span class="cm"> * Application events we listen to</span>
<a name="code--tic--tic3--tic7.js-pyg.html-47"></a><span class="cm"> ***************************************************************************************/</span>
<a name="code--tic--tic3--tic7.js-pyg.html-48"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-49"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-50"></a><span class="cm"> * The init event, the server has set up everything an assigned us</span>
<a name="code--tic--tic3--tic7.js-pyg.html-51"></a><span class="cm"> * a session id that we can use in the application</span>
<a name="code--tic--tic3--tic7.js-pyg.html-52"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-53"></a><span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-54"></a>  <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-55"></a><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-56"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-57"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-58"></a><span class="cm"> * A new gamer logged on, display the new user in the list of available gamers</span>
<a name="code--tic--tic3--tic7.js-pyg.html-59"></a><span class="cm"> * to play</span>
<a name="code--tic--tic3--tic7.js-pyg.html-60"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-61"></a><span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;gamer_joined&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-62"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-63"></a>  <span class="c1">// Get the gamer</span>
<a name="code--tic--tic3--tic7.js-pyg.html-64"></a>  <span class="kd">var</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-65"></a>  <span class="c1">// Check if we have the gamer already</span>
<a name="code--tic--tic3--tic7.js-pyg.html-66"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--tic--tic3--tic7.js-pyg.html-67"></a>  <span class="c1">// Check if the gamer already exists and if it does </span>
<a name="code--tic--tic3--tic7.js-pyg.html-68"></a>  <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-69"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-70"></a>  <span class="c1">// replace it with the new reference</span>
<a name="code--tic--tic3--tic7.js-pyg.html-71"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-72"></a>    <span class="kd">var</span> <span class="nx">_gamer</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<a name="code--tic--tic3--tic7.js-pyg.html-73"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-74"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">_gamer</span><span class="p">.</span><span class="nx">user_name</span> <span class="o">==</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">user_name</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-75"></a>      <span class="nx">found</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-76"></a>      <span class="c1">// Update the sid and update on</span>
<a name="code--tic--tic3--tic7.js-pyg.html-77"></a>      <span class="nx">_gamer</span><span class="p">.</span><span class="nx">sid</span> <span class="o">=</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">sid</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-78"></a>      <span class="nx">_gamer</span><span class="p">.</span><span class="nx">updated_on</span> <span class="o">=</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">updated_on</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-79"></a>      <span class="k">break</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-80"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-81"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-82"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-83"></a>  <span class="c1">// If not found let&#39;s add it to the list</span>
<a name="code--tic--tic3--tic7.js-pyg.html-84"></a>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">found</span><span class="p">)</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">gamer</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-85"></a>  <span class="c1">// If we currently have the dashboard</span>
<a name="code--tic--tic3--tic7.js-pyg.html-86"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">.</span><span class="nx">isTemplate</span><span class="p">(</span><span class="s2">&quot;dashboard&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-87"></a>    <span class="kd">var</span> <span class="nx">gamers</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-88"></a>    <span class="c1">// Let&#39;s go to the dashboard of the game</span>
<a name="code--tic--tic3--tic7.js-pyg.html-89"></a>    <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-90"></a>    <span class="c1">// Add handlers to the event</span>
<a name="code--tic--tic3--tic7.js-pyg.html-91"></a>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-92"></a>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-93"></a>        <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-94"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-95"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-96"></a><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-97"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-98"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-99"></a><span class="cm"> * The opponent made a valid move, render the move on the board</span>
<a name="code--tic--tic3--tic7.js-pyg.html-100"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-101"></a><span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;game_move&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-102"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-103"></a>  <span class="c1">// Get the move data</span>
<a name="code--tic--tic3--tic7.js-pyg.html-104"></a>  <span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">marker</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-105"></a>  <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-106"></a>  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-107"></a>  <span class="c1">// Select the right box and mark it</span>
<a name="code--tic--tic3--tic7.js-pyg.html-108"></a>  <span class="kd">var</span> <span class="nx">cell_id_image</span> <span class="o">=</span> <span class="s2">&quot;#row&quot;</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">+</span> <span class="s2">&quot;cell&quot;</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot; img&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-109"></a>  <span class="c1">// It was our turn, let&#39;s show the mark we set down</span>
<a name="code--tic--tic3--tic7.js-pyg.html-110"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">marker</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-111"></a>    <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/cross.png&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-112"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-113"></a>    <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/circle.png&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-114"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-115"></a><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-116"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-117"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-118"></a><span class="cm"> * The game was won, display victory / defeat / draw dialog</span>
<a name="code--tic--tic3--tic7.js-pyg.html-119"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-120"></a><span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;game_over&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-121"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">draw</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-122"></a>    <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;It was a draw&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;Your equally good, it&#39;s a draw&lt;/p&gt;&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-123"></a>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">==</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-124"></a>    <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;Congratulations&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;You won&lt;/p&gt;&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-125"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-126"></a>    <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;You lost&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;You got beaten buddy&lt;/p&gt;&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-127"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-128"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-129"></a>  <span class="c1">// Let&#39;s load the first 100 public available games</span>
<a name="code--tic--tic3--tic7.js-pyg.html-130"></a>  <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-131"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-132"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-133"></a>    <span class="c1">// Save the list of games in our game state</span>
<a name="code--tic--tic3--tic7.js-pyg.html-134"></a>    <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-135"></a>    <span class="c1">// Let&#39;s go to the dashboard of the game</span>
<a name="code--tic--tic3--tic7.js-pyg.html-136"></a>    <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-137"></a>    <span class="c1">// Add handlers to the event</span>
<a name="code--tic--tic3--tic7.js-pyg.html-138"></a>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-139"></a>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-140"></a>        <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-141"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-142"></a>  <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-143"></a><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-144"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-145"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-146"></a><span class="cm"> * The user was invited to play a game, show the invitation acceptance / decline box</span>
<a name="code--tic--tic3--tic7.js-pyg.html-147"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-148"></a><span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;game_invite&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-149"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-150"></a>  <span class="c1">// Save the invitation in our application state</span>
<a name="code--tic--tic3--tic7.js-pyg.html-151"></a>  <span class="nx">application_state</span><span class="p">.</span><span class="nx">invite</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-152"></a>  <span class="c1">// Open the invite box</span>
<a name="code--tic--tic3--tic7.js-pyg.html-153"></a>  <span class="nx">game_invite_box_show</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">gamer</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-154"></a><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-155"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-156"></a><span class="cm">/***************************************************************************************</span>
<a name="code--tic--tic3--tic7.js-pyg.html-157"></a><span class="cm"> * Handlers</span>
<a name="code--tic--tic3--tic7.js-pyg.html-158"></a><span class="cm"> ***************************************************************************************/</span>
<a name="code--tic--tic3--tic7.js-pyg.html-159"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-160"></a><span class="cm"> * Handles the attempt to register a new user</span>
<a name="code--tic--tic3--tic7.js-pyg.html-161"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-162"></a><span class="kd">var</span> <span class="nx">register_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-163"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-164"></a>    <span class="c1">// Lets get the values for the registration</span>
<a name="code--tic--tic3--tic7.js-pyg.html-165"></a>    <span class="kd">var</span> <span class="nx">full_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputFullNameRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<a name="code--tic--tic3--tic7.js-pyg.html-166"></a>    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputUserNameRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<a name="code--tic--tic3--tic7.js-pyg.html-167"></a>    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputPasswordRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<a name="code--tic--tic3--tic7.js-pyg.html-168"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-169"></a>    <span class="c1">// Attempt to register a new user</span>
<a name="code--tic--tic3--tic7.js-pyg.html-170"></a>    <span class="nx">api</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-171"></a>      <span class="c1">// If we have an error show the error message to the user</span>
<a name="code--tic--tic3--tic7.js-pyg.html-172"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-173"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-174"></a>      <span class="c1">// Load all the available gamers</span>
<a name="code--tic--tic3--tic7.js-pyg.html-175"></a>      <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-176"></a>        <span class="c1">// If we have an error show the error message to the user        </span>
<a name="code--tic--tic3--tic7.js-pyg.html-177"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-178"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-179"></a>        <span class="c1">// Save the list of games in our game state</span>
<a name="code--tic--tic3--tic7.js-pyg.html-180"></a>        <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-181"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-182"></a>        <span class="c1">// Show the main dashboard view and render with all the available players</span>
<a name="code--tic--tic3--tic7.js-pyg.html-183"></a>        <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-184"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-185"></a>        <span class="c1">// Add handlers for each new player so we can play them</span>
<a name="code--tic--tic3--tic7.js-pyg.html-186"></a>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-187"></a>          <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-188"></a>            <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-189"></a>        <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-190"></a>      <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-191"></a>    <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-192"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-193"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-194"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-195"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-196"></a><span class="cm"> * Handles the attempt to login</span>
<a name="code--tic--tic3--tic7.js-pyg.html-197"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-198"></a><span class="kd">var</span> <span class="nx">login_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-199"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-200"></a>    <span class="c1">// Lets get the values for the login</span>
<a name="code--tic--tic3--tic7.js-pyg.html-201"></a>    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputUserNameLogin&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<a name="code--tic--tic3--tic7.js-pyg.html-202"></a>    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputPasswordLogin&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<a name="code--tic--tic3--tic7.js-pyg.html-203"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-204"></a>    <span class="c1">// Attempt to login the user</span>
<a name="code--tic--tic3--tic7.js-pyg.html-205"></a>    <span class="nx">api</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-206"></a>      <span class="c1">// If we have an error show the error message to the user</span>
<a name="code--tic--tic3--tic7.js-pyg.html-207"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-208"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-209"></a>      <span class="c1">// Load all the available gamers</span>
<a name="code--tic--tic3--tic7.js-pyg.html-210"></a>      <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-211"></a>        <span class="c1">// If we have an error show the error message to the user        </span>
<a name="code--tic--tic3--tic7.js-pyg.html-212"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-213"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-214"></a>        <span class="c1">// Save the list of games in our game state</span>
<a name="code--tic--tic3--tic7.js-pyg.html-215"></a>        <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-216"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-217"></a>        <span class="c1">// Show the main dashboard view and render with all the available players</span>
<a name="code--tic--tic3--tic7.js-pyg.html-218"></a>        <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-219"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-220"></a>        <span class="c1">// Add handlers for each new player so we can play them</span>
<a name="code--tic--tic3--tic7.js-pyg.html-221"></a>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-222"></a>          <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-223"></a>            <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-224"></a>        <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-225"></a>      <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-226"></a>    <span class="p">})</span>
<a name="code--tic--tic3--tic7.js-pyg.html-227"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-228"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-229"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-230"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-231"></a><span class="cm"> * Send an invitation to a player to pay a game</span>
<a name="code--tic--tic3--tic7.js-pyg.html-232"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-233"></a><span class="kd">var</span> <span class="nx">invite_gamer_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-234"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-235"></a>    <span class="kd">var</span> <span class="nx">gamer_id</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-236"></a>    <span class="c1">// Get the id</span>
<a name="code--tic--tic3--tic7.js-pyg.html-237"></a>    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">gamer_id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\_/</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
<a name="code--tic--tic3--tic7.js-pyg.html-238"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-239"></a>    <span class="c1">// Locate the gamer object</span>
<a name="code--tic--tic3--tic7.js-pyg.html-240"></a>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-241"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span> <span class="o">==</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-242"></a>        <span class="kd">var</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<a name="code--tic--tic3--tic7.js-pyg.html-243"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-244"></a>        <span class="c1">// Attempt to invite the gamer to play</span>
<a name="code--tic--tic3--tic7.js-pyg.html-245"></a>        <span class="nx">api</span><span class="p">.</span><span class="nx">invite_gamer</span><span class="p">(</span><span class="nx">gamer</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-246"></a>          <span class="c1">// If we have an error show the declined game to the user</span>
<a name="code--tic--tic3--tic7.js-pyg.html-247"></a>          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">decline_box_show</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-248"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-249"></a>          <span class="c1">// Set up the board for a game</span>
<a name="code--tic--tic3--tic7.js-pyg.html-250"></a>          <span class="nx">setupBoardGame</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-251"></a>        <span class="p">})</span>
<a name="code--tic--tic3--tic7.js-pyg.html-252"></a>      <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-253"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-254"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-255"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-256"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-257"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-258"></a><span class="cm"> * Accept an invitation to play a game</span>
<a name="code--tic--tic3--tic7.js-pyg.html-259"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-260"></a><span class="kd">var</span> <span class="nx">invite_accept_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-261"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-262"></a>    <span class="c1">// Accept the game invite</span>
<a name="code--tic--tic3--tic7.js-pyg.html-263"></a>    <span class="nx">api</span><span class="p">.</span><span class="nx">accept_game</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">invite</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-264"></a>      <span class="c1">// If we have an error show the error message to the user        </span>
<a name="code--tic--tic3--tic7.js-pyg.html-265"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-266"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-267"></a>      <span class="c1">// Set up the board for a game</span>
<a name="code--tic--tic3--tic7.js-pyg.html-268"></a>      <span class="nx">setupBoardGame</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-269"></a>    <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-270"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-271"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-272"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-273"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-274"></a><span class="cm"> * Accept an invitation to play a game</span>
<a name="code--tic--tic3--tic7.js-pyg.html-275"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-276"></a><span class="kd">var</span> <span class="nx">invite_decline_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-277"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-278"></a>    <span class="c1">// Decline the game invite</span>
<a name="code--tic--tic3--tic7.js-pyg.html-279"></a>    <span class="nx">api</span><span class="p">.</span><span class="nx">decline_game</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">invite</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-280"></a>      <span class="c1">// If we have an error show the error message to the user        </span>
<a name="code--tic--tic3--tic7.js-pyg.html-281"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-282"></a>      <span class="c1">// No need to do anything as we declined the game and we are still </span>
<a name="code--tic--tic3--tic7.js-pyg.html-283"></a>      <span class="c1">// showing the dashboard</span>
<a name="code--tic--tic3--tic7.js-pyg.html-284"></a>    <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-285"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-286"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-287"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-288"></a><span class="cm">/****************************************************************************************</span>
<a name="code--tic--tic3--tic7.js-pyg.html-289"></a><span class="cm"> * Setup methods</span>
<a name="code--tic--tic3--tic7.js-pyg.html-290"></a><span class="cm"> ****************************************************************************************/</span>
<a name="code--tic--tic3--tic7.js-pyg.html-291"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-292"></a><span class="cm"> * Set up a new game board and add handlers to all the cells of the board</span>
<a name="code--tic--tic3--tic7.js-pyg.html-293"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-294"></a><span class="kd">var</span> <span class="nx">setupBoardGame</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-295"></a>  <span class="c1">// Save current game to state</span>
<a name="code--tic--tic3--tic7.js-pyg.html-296"></a>  <span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span> <span class="o">=</span> <span class="nx">game</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-297"></a>  <span class="c1">// Let&#39;s render the board game</span>
<a name="code--tic--tic3--tic7.js-pyg.html-298"></a>  <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;board&quot;</span><span class="p">,</span> <span class="p">{});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-299"></a>  <span class="c1">// Set the marker for our player (X if we are the starting player)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-300"></a>  <span class="nx">application_state</span><span class="p">.</span><span class="nx">marker</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span> <span class="o">==</span> <span class="nx">game</span><span class="p">.</span><span class="nx">current_player</span>
<a name="code--tic--tic3--tic7.js-pyg.html-301"></a>    <span class="o">?</span> <span class="s2">&quot;x&quot;</span> <span class="o">:</span> <span class="s2">&quot;o&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-302"></a>  <span class="c1">// Get all the rows</span>
<a name="code--tic--tic3--tic7.js-pyg.html-303"></a>  <span class="kd">var</span> <span class="nx">rows</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#board div&#39;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-304"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-305"></a>  <span class="c1">// Add an event handler to each cell</span>
<a name="code--tic--tic3--tic7.js-pyg.html-306"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-307"></a>    <span class="kd">var</span> <span class="nx">cells</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; span&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-308"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-309"></a>    <span class="c1">// For each cell create and add the handler</span>
<a name="code--tic--tic3--tic7.js-pyg.html-310"></a>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">cells</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-311"></a>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">cells</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">id</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-312"></a>        <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">game_board_cell_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-313"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-314"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-315"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-316"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-317"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-318"></a><span class="cm"> * Create a cell click handler that will send the events to the server when </span>
<a name="code--tic--tic3--tic7.js-pyg.html-319"></a><span class="cm"> * the user clicks on an event, and also show the result</span>
<a name="code--tic--tic3--tic7.js-pyg.html-320"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-321"></a><span class="kd">var</span> <span class="nx">game_board_cell_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-322"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-323"></a>    <span class="c1">// Split up the id to get the cell position</span>
<a name="code--tic--tic3--tic7.js-pyg.html-324"></a>    <span class="kd">var</span> <span class="nx">row_number</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;row&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-325"></a>    <span class="kd">var</span> <span class="nx">cell_number</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-326"></a>    <span class="kd">var</span> <span class="nx">cell_id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-327"></a>    <span class="kd">var</span> <span class="nx">cell_id_image</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">cell_id</span> <span class="o">+</span> <span class="s2">&quot; img&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-328"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-329"></a>    <span class="c1">// Let&#39;s attempt to do a move</span>
<a name="code--tic--tic3--tic7.js-pyg.html-330"></a>    <span class="nx">api</span><span class="p">.</span><span class="nx">place_marker</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nx">cell_number</span><span class="p">,</span> <span class="nx">row_number</span>
<a name="code--tic--tic3--tic7.js-pyg.html-331"></a>      <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-332"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-333"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-334"></a>        <span class="c1">// If we won</span>
<a name="code--tic--tic3--tic7.js-pyg.html-335"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">==</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-336"></a>          <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;Congratulations&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;You won&lt;/p&gt;&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-337"></a>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-338"></a>          <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;You lost&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;You got beaten buddy&lt;/p&gt;&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-339"></a>        <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-340"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-341"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">marker</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-342"></a>          <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/cross.png&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-343"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-344"></a>          <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/circle.png&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-345"></a>        <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-346"></a>      <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-347"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-348"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-349"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-350"></a><span class="cm">/***************************************************************************************</span>
<a name="code--tic--tic3--tic7.js-pyg.html-351"></a><span class="cm"> * Helper methods</span>
<a name="code--tic--tic3--tic7.js-pyg.html-352"></a><span class="cm"> ***************************************************************************************/</span>
<a name="code--tic--tic3--tic7.js-pyg.html-353"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-354"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-355"></a><span class="cm"> * Show an error message box</span>
<a name="code--tic--tic3--tic7.js-pyg.html-356"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-357"></a><span class="kd">var</span> <span class="nx">error_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-358"></a>  <span class="c1">// Set fields for the error</span>
<a name="code--tic--tic3--tic7.js-pyg.html-359"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_header&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;Registration Error&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-360"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_body&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-361"></a>  <span class="c1">// Show the modal box</span>
<a name="code--tic--tic3--tic7.js-pyg.html-362"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">({</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-363"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-364"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-365"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-366"></a><span class="cm"> * General message box with configurable title and body content</span>
<a name="code--tic--tic3--tic7.js-pyg.html-367"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-368"></a><span class="kd">var</span> <span class="nx">general_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-369"></a>  <span class="c1">// Set fields for the error</span>
<a name="code--tic--tic3--tic7.js-pyg.html-370"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_header&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-371"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_body&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-372"></a>  <span class="c1">// Show the modal box</span>
<a name="code--tic--tic3--tic7.js-pyg.html-373"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">({</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
<a name="code--tic--tic3--tic7.js-pyg.html-374"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-375"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-376"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-377"></a><span class="cm"> * Show a game decline message box</span>
<a name="code--tic--tic3--tic7.js-pyg.html-378"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-379"></a><span class="kd">var</span> <span class="nx">decline_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-380"></a>  <span class="c1">// Set fields for the error</span>
<a name="code--tic--tic3--tic7.js-pyg.html-381"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_header&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;Invitation to game was declined&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-382"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_body&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s2">&quot;decline_game&quot;</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-383"></a>  <span class="c1">// Show the modal box</span>
<a name="code--tic--tic3--tic7.js-pyg.html-384"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">({</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
<a name="code--tic--tic3--tic7.js-pyg.html-385"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-386"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-387"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-388"></a><span class="cm"> * Show a game invite message box</span>
<a name="code--tic--tic3--tic7.js-pyg.html-389"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-390"></a><span class="kd">var</span> <span class="nx">game_invite_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gamer</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-391"></a>  <span class="c1">// Set fields for the error</span>
<a name="code--tic--tic3--tic7.js-pyg.html-392"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box_header&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;You have been invited to a game&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-393"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box_body&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-394"></a>    <span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;The user &lt;strong&gt;&quot;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-395"></a>      <span class="o">+</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">user_name</span> <span class="o">+</span> <span class="s2">&quot;&lt;/strong&gt; has challenged you to a game&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-396"></a>  <span class="c1">// Show the modal box</span>
<a name="code--tic--tic3--tic7.js-pyg.html-397"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">({</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
<a name="code--tic--tic3--tic7.js-pyg.html-398"></a><span class="p">}</span>
</pre></div><p>We need to add several event handlers as well as several utility methods in <tt class="docutils literal">public/javascripts/app.js</tt>. Let's first look at what we are adding in terms of event handlers.</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="86%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Event</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>gamer_joined</td>
<td>When a new player logs in the list of available players should get updated.</td>
</tr>
<tr><td>game_move</td>
<td>When a valid move board move was performed update the board graphical display</td>
</tr>
<tr><td>game_over</td>
<td>A move lead to the game finishing, determine what the outcome was and display the appropriate message to the player then return to the dashboard to start again</td>
</tr>
<tr><td>game_invite</td>
<td>Another player invited you to join them in a game in Tic-Tac-Toe. Display the dialog to the player to allow them to accept/decline the invitation</td>
</tr>
</tbody>
</table>
<p>Secondly lets look at what other handlers we are adding for user interactions with the application as well as methods to render a board, handle the invite process and the game itself.</p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="81%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>register_button_handler</td>
<td>When the player registers we now need to render the initial list of available players as well as the dashboard</td>
</tr>
<tr><td>login_button_handler</td>
<td>When the player logs in we now need to render the initial list of available players as well as the dashboard</td>
</tr>
<tr><td>invite_gamer_button_handler</td>
<td>When the player clicks on another player to invite them to a game</td>
</tr>
<tr><td>invite_accept_button_handler</td>
<td>Handle the user clicking to accept a game invitation</td>
</tr>
<tr><td>invite_decline_button_handler</td>
<td>Handle the user clicking on decline a game invitation</td>
</tr>
<tr><td>setupBoardGame</td>
<td>Render a new clean Tic-Tac-Toe board and set up all the handlers for the placement of markers on it</td>
</tr>
<tr><td>game_board_cell_handler</td>
<td>Handle the user clicking on a board cell to place a marker</td>
</tr>
<tr><td>general_box_show</td>
<td>Show a general message box dialog</td>
</tr>
<tr><td>decline_box_show</td>
<td>Show a dialog where the other player declined a game invitation</td>
</tr>
<tr><td>game_invite_box_show</td>
<td>Show a dialog when the player gets invited to a new game by another player allowing them to accept/decline the invitation</td>
</tr>
</tbody>
</table>
<p>Let's start with picking apart the code event handlers we listed above.</p>
</div>
<div class="section" id="the-gamer-joined-event-handler">
<h3><a class="toc-backref" href="#id156">The gamer_joined Event Handler</a></h3>
<pre class="code javascript literal-block">
<span class="cm">/**
 * A new gamer logged on, display the new user in the list of available gamers
 * to play
 */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'gamer_joined'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="c1">// Get the gamer
</span>  <span class="kd">var</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
  <span class="c1">// Check if we have the gamer already
</span>  <span class="k">if</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="p">[</span><span class="p">];</span>
  <span class="c1">// Check if the gamer already exists and if it does
</span>  <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="c1">// replace it with the new reference
</span>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_gamer</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">_gamer</span><span class="p">.</span><span class="nx">user_name</span> <span class="o">==</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">user_name</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="c1">// Update the sid and update on
</span>      <span class="nx">_gamer</span><span class="p">.</span><span class="nx">sid</span> <span class="o">=</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">sid</span><span class="p">;</span>
      <span class="nx">_gamer</span><span class="p">.</span><span class="nx">updated_on</span> <span class="o">=</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">updated_on</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// If not found let's add it to the list
</span>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">found</span><span class="p">)</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">gamer</span><span class="p">);</span>
  <span class="c1">// If we currently have the dashboard
</span>  <span class="k">if</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">.</span><span class="nx">isTemplate</span><span class="p">(</span><span class="s2">&quot;dashboard&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">gamers</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">;</span>
    <span class="c1">// Let's go to the dashboard of the game
</span>    <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>
    <span class="c1">// Add handlers to the event
</span>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre>
<p>The <tt class="docutils literal">gamer_joined</tt> event handler gets called every time a new player logs in. If the player already exists in our list we update the players session id and last active time to make sure we can talk to the correct player. If it does not exist we push it to the list of our users.</p>
<p>In the case where are currently showing the <tt class="docutils literal">dashboard</tt> view we re-render the list so we can show the newly added player. We don't re-render the dashboard if a modal dialog is currently being shown to the player.</p>
<p>It's left as an exercise to the user on how to handle the rendering if the modal dialog is showing. One possible solution is to defer the rendering until the modal dialog is closed.</p>
</div>
<div class="section" id="the-game-move-event-handler">
<h3><a class="toc-backref" href="#id157">The game_move Event Handler</a></h3>
<pre class="code javascript literal-block">
<span class="cm">/**
 * The opponent made a valid move, render the move on the board
 */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'game_move'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="c1">// Get the move data
</span>  <span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">marker</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
  <span class="c1">// Select the right box and mark it
</span>  <span class="kd">var</span> <span class="nx">cell_id_image</span> <span class="o">=</span> <span class="s2">&quot;#row&quot;</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">+</span> <span class="s2">&quot;cell&quot;</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot; img&quot;</span><span class="p">;</span>
  <span class="c1">// It was our turn, let's show the mark we set down
</span>  <span class="k">if</span><span class="p">(</span><span class="nx">marker</span> <span class="o">==</span> <span class="s1">'x'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/cross.png&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/circle.png&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre>
<p>The <tt class="docutils literal">game_move</tt> event handler gets called each time a valid marker placement was done on the board. We then figure out if the marker is a <tt class="docutils literal">x</tt> or a <tt class="docutils literal">o</tt> and update the board position to show the image representing the marker placed on the board.</p>
</div>
<div class="section" id="the-game-invite-event-handler">
<h3><a class="toc-backref" href="#id158">The game_invite Event Handler</a></h3>
<pre class="code javascript literal-block">
<span class="cm">/**
 * The user was invited to play a game, show the invitation acceptance / decline box
 */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'game_invite'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="c1">// Save the invitation in our application state
</span>  <span class="nx">application_state</span><span class="p">.</span><span class="nx">invite</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
  <span class="c1">// Open the invite box
</span>  <span class="nx">game_invite_box_show</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">gamer</span><span class="p">);</span>
<span class="p">});</span>
</pre>
<p>The <tt class="docutils literal">game_invite</tt> event handler will save the invite in progress in the <tt class="docutils literal">application_state</tt> and then display the invite accept/decline dialog box so the player can accept/decline the invitation.</p>
</div>
<div class="section" id="the-register-button-handler-handler">
<h3><a class="toc-backref" href="#id159">The register_button_handler Handler</a></h3>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Handles the attempt to register a new user
 */</span>
<span class="kd">var</span> <span class="nx">register_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Lets get the values for the registration
</span>    <span class="kd">var</span> <span class="nx">full_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#inputFullNameRegister'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#inputUserNameRegister'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#inputPasswordRegister'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="p">);</span>

    <span class="c1">// Attempt to register a new user
</span>    <span class="nx">api</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Load all the available gamers
</span>      <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If we have an error show the error message to the user
</span>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

        <span class="c1">// Save the list of games in our game state
</span>        <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>

        <span class="c1">// Show the main dashboard view and render with all the available players
</span>        <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>

        <span class="c1">// Add handlers for each new player so we can play them
</span>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span>
              <span class="p">,</span> <span class="nx">api</span>
              <span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>We've modified the <tt class="docutils literal">register_button_handler</tt> method to fetch the available players and render the <tt class="docutils literal">dashboard</tt> view showing all of them. After finishing rendering the <tt class="docutils literal">dashboard</tt>, we wire up all the links to the players so we can click on them and trigger an invite to be sent.</p>
</div>
<div class="section" id="the-login-button-handler-handler">
<h3><a class="toc-backref" href="#id160">The login_button_handler Handler</a></h3>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Handles the attempt to login
 */</span>
<span class="kd">var</span> <span class="nx">login_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Lets get the values for the login
</span>    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#inputUserNameLogin'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#inputPasswordLogin'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="p">);</span>

    <span class="c1">// Attempt to login the user
</span>    <span class="nx">api</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Load all the available gamers
</span>      <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If we have an error show the error message to the user
</span>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

        <span class="c1">// Save the list of games in our game state
</span>        <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>

        <span class="c1">// Show the main dashboard view and render with all the available players
</span>        <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>

        <span class="c1">// Add handlers for each new player so we can play them
</span>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span>
              <span class="p">,</span> <span class="nx">api</span>
              <span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>We've modified the <tt class="docutils literal">login_button_handler</tt> method to fetch the available players and render the <tt class="docutils literal">dashboard</tt> view showing all of them. After finishing rendering the <tt class="docutils literal">dashboard</tt>, we wire up all the links to the players so we can click on them and trigger an invite to be sent.</p>
</div>
<div class="section" id="the-invite-gamer-button-handler-handler">
<h3><a class="toc-backref" href="#id161">The invite_gamer_button_handler Handler</a></h3>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Send an invitation to a player to pay a game
 */</span>
<span class="kd">var</span> <span class="nx">invite_gamer_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">gamer_id</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="c1">// Get the id
</span>    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">gamer_id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\_/</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>

    <span class="c1">// Locate the gamer object
</span>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span> <span class="o">==</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

        <span class="c1">// Attempt to invite the gamer to play
</span>        <span class="nx">api</span><span class="p">.</span><span class="nx">invite_gamer</span><span class="p">(</span><span class="nx">gamer</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// If we have an error show the declined game to the user
</span>          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">decline_box_show</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">);</span>

          <span class="c1">// Set up the board for a game
</span>          <span class="nx">setupBoardGame</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
        <span class="p">})</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The <tt class="docutils literal">invite_gamer_button_handler</tt> method triggers when you click on one of the users available to invite. It will first locate the <tt class="docutils literal">Gamer</tt> object for the player and use the <tt class="docutils literal">api.invite_gamer</tt> to attempt to invite the user to a new game. If the other user accepts we call the <tt class="docutils literal">setupBoardGame</tt> function to show the new board and set up all the handlers otherwise we shoe the decline dialog telling the player that the invite was declined.</p>
</div>
<div class="section" id="the-invite-accept-button-handler-handler">
<h3><a class="toc-backref" href="#id162">The invite_accept_button_handler Handler</a></h3>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Accept an invitation to play a game
 */</span>
<span class="kd">var</span> <span class="nx">invite_accept_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Accept the game invite
</span>    <span class="nx">api</span><span class="p">.</span><span class="nx">accept_game</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">invite</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Set up the board for a game
</span>      <span class="nx">setupBoardGame</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The <tt class="docutils literal">invite_accept_button_handler</tt> method handles the user clicking the accept button on the invite dialog. It calls the <tt class="docutils literal">api.accept_game</tt> with the existing invite and if the successful it will set up the board using the <tt class="docutils literal">setupBoardGame</tt> function. If unsuccessful we show an error dialog with the relevant error message. Let's see how we wire up those handlers.</p>
<pre class="code javascript literal-block">
<span class="c1">// Load all the templates and once it's done
// register up all the initial button handlers
</span><span class="nx">template_handler</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Render the main view in the #view div
</span>  <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="p">{</span><span class="p">});</span>

  <span class="c1">// Wire up the buttons for the main view
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#register_button'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">register_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#login_button'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">login_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>

  <span class="c1">// Wire up invite box buttons (this is in the main view)
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#invite_box_accept'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_accept_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#invite_box_decline'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_decline_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>

  <span class="c1">// Ensure we have the right state for the modal dialog
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#status_box'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">});</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#status_box'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;hide&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="p">});</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#invite_box'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">});</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#invite_box'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;hide&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="p">});</span>
<span class="p">})</span>
</pre>
<p>Notice how we wire it up in the <tt class="docutils literal">template_handler.start</tt> callback. This goes for both the <tt class="docutils literal">invite_accept_button_handler</tt> and <tt class="docutils literal">invite_decline_button_handler</tt>. We only need to wire up these handlers once as the HTML elements they are wired up to will exist during the entire duration of the applications life. This is in contrast to the <tt class="docutils literal">Gamer</tt> invite links that we need to rewire each time we show the list of <tt class="docutils literal">Gamers</tt> available (Not optimal of course but this is left to you as an exercise to improve on).</p>
</div>
<div class="section" id="the-invite-decline-button-handler-handler">
<h3><a class="toc-backref" href="#id163">The invite_decline_button_handler Handler</a></h3>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Accept an invitation to play a game
 */</span>
<span class="kd">var</span> <span class="nx">invite_decline_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Decline the game invite
</span>    <span class="nx">api</span><span class="p">.</span><span class="nx">decline_game</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">invite</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
      <span class="c1">// No need to do anything as we declined the game and we
</span>      <span class="c1">// are still showing the dashboard
</span>    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The <tt class="docutils literal">invite_decline_button_handler</tt> handles the user clicking the decline button on invitation dialog. It calls the <tt class="docutils literal">api.decline_game</tt> with the existing invite to cancel the invite and notify the inviting player about the player declining the invitation.</p>
</div>
<div class="section" id="the-setupboardgame-function">
<h3><a class="toc-backref" href="#id164">The setupBoardGame Function</a></h3>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Set up a new game board and add handlers to all the cells of the board
 */</span>
<span class="kd">var</span> <span class="nx">setupBoardGame</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Save current game to state
</span>  <span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span> <span class="o">=</span> <span class="nx">game</span><span class="p">;</span>
  <span class="c1">// Let's render the board game
</span>  <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;board&quot;</span><span class="p">,</span> <span class="p">{</span><span class="p">});</span>
  <span class="c1">// Set the marker for our player (X if we are the starting player)
</span>  <span class="nx">application_state</span><span class="p">.</span><span class="nx">marker</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span> <span class="o">==</span> <span class="nx">game</span><span class="p">.</span><span class="nx">current_player</span>
    <span class="o">?</span> <span class="s2">&quot;x&quot;</span> <span class="o">:</span> <span class="s2">&quot;o&quot;</span><span class="p">;</span>
  <span class="c1">// Get all the rows
</span>  <span class="kd">var</span> <span class="nx">rows</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#board div'</span><span class="p">);</span>

  <span class="c1">// Add an event handler to each cell
</span>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cells</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#'</span> <span class="o">+</span> <span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; span&quot;</span><span class="p">);</span>

    <span class="c1">// For each cell create and add the handler
</span>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">cells</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">cells</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">id</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">game_board_cell_handler</span><span class="p">(</span><span class="nx">application_state</span>
          <span class="p">,</span> <span class="nx">api</span>
          <span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The <tt class="docutils literal">setupBoardGame</tt> function generates a new Tic-Tac-Toe game and renders the board in the browser and then attaches a handler <tt class="docutils literal">game_board_cell_handler</tt> for each cell in the board that will handle the click of the user on that cell.</p>
<p>We created the <tt class="docutils literal">public/templates/board.ms</tt> earlier and it's time to fill in the template with the layout of the board game.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic2.ms-pyg.html-1"></a>&lt;div class=&quot;span8&quot;&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-2"></a>  &lt;div id=&quot;board&quot; class=&quot;board&quot;&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-3"></a>    &lt;div id=&quot;row0&quot; class=&quot;board_row&quot;&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-4"></a>      &lt;span id=&quot;row0cell0&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-5"></a>      &lt;span id=&quot;row0cell1&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-6"></a>      &lt;span id=&quot;row0cell2&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-7"></a>      &lt;span id=&quot;row0cell3&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-8"></a>    &lt;/div&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-9"></a>    &lt;div id=&quot;row1&quot; class=&quot;board_row&quot;&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-10"></a>      &lt;span id=&quot;row1cell0&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-11"></a>      &lt;span id=&quot;row1cell1&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-12"></a>      &lt;span id=&quot;row1cell2&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-13"></a>      &lt;span id=&quot;row1cell3&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-14"></a>    &lt;/div&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-15"></a>    &lt;div id=&quot;row2&quot; class=&quot;board_row&quot;&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-16"></a>      &lt;span id=&quot;row2cell0&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-17"></a>      &lt;span id=&quot;row2cell1&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-18"></a>      &lt;span id=&quot;row2cell2&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-19"></a>      &lt;span id=&quot;row2cell3&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-20"></a>    &lt;/div&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-21"></a>    &lt;div id=&quot;row3&quot; class=&quot;board_row&quot;&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-22"></a>      &lt;span id=&quot;row3cell0&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-23"></a>      &lt;span id=&quot;row3cell1&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-24"></a>      &lt;span id=&quot;row3cell2&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-25"></a>      &lt;span id=&quot;row3cell3&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-26"></a>    &lt;/div&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-27"></a>  &lt;/div&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-28"></a>&lt;/div&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-29"></a>&lt;div class=&quot;span4&quot;&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-30"></a>&lt;/div&gt;
</pre></div><p>Nothing special here just a table with 4 rows and 4 columns containing a default background image as a placeholder.</p>
</div>
<div class="section" id="the-game-board-cell-handler-function">
<h3><a class="toc-backref" href="#id165">The game_board_cell_handler Function</a></h3>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Create a cell click handler that will send the events to the server when the user clicks
 * on an event, and also show the result
 */</span>
<span class="kd">var</span> <span class="nx">game_board_cell_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Split up the id to get the cell position
</span>    <span class="kd">var</span> <span class="nx">row_number</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;row&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">cell_number</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">cell_id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">cell_id_image</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">cell_id</span> <span class="o">+</span> <span class="s2">&quot; img&quot;</span><span class="p">;</span>

    <span class="c1">// Let's attempt to do a move
</span>    <span class="nx">api</span><span class="p">.</span><span class="nx">place_marker</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">_id</span>
      <span class="p">,</span> <span class="nx">cell_number</span>
      <span class="p">,</span> <span class="nx">row_number</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

        <span class="c1">// If we won
</span>        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">==</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;Congratulations&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;You won&lt;/p&gt;&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;You lost&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;You got beaten buddy&lt;/p&gt;&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">marker</span> <span class="o">==</span> <span class="s1">'x'</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/cross.png&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/circle.png&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The <tt class="docutils literal">game_board_cell_handler</tt> is attached to each cell in the Tic-Tac-Toe board and detects the player clicking on it. When its fired, it will attempt to place a marker in that cell calling the <tt class="docutils literal">api.place_marker</tt> method.</p>
<p>If the placement of the marker leads to victory the player will receive a message back with the field <tt class="docutils literal">winner</tt> set to the session id of the winning player. If that session id matches the calling player he won and we show the winning dialog. If it does not match we show the loser dialog. If we don't have a winner or loser we set the cell with the marker to show the move.</p>
</div>
<div class="section" id="the-general-box-show-function">
<h3><a class="toc-backref" href="#id166">The general_box_show Function</a></h3>
<pre class="code javascript literal-block">
<span class="cm">/**
 * General message box with configurable title and body content
 */</span>
<span class="kd">var</span> <span class="nx">general_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Set fields for the error
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#status_box_header'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#status_box_body'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
  <span class="c1">// Show the modal box
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#status_box'</span><span class="p">).</span><span class="nx">modal</span><span class="p">(</span><span class="p">{</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
<span class="p">}</span>
</pre>
<p>Generates a general box dialog with a provided title and body. Used to allow us to show a dialog with a custom title and body.</p>
</div>
<div class="section" id="the-decline-box-show-function">
<h3><a class="toc-backref" href="#id167">The decline_box_show Function</a></h3>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Show a game decline message box
 */</span>
<span class="kd">var</span> <span class="nx">decline_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Set fields for the error
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#status_box_header'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;Invitation to game was declined&quot;</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#status_box_body'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s2">&quot;decline_game&quot;</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">));</span>
  <span class="c1">// Show the modal box
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#status_box'</span><span class="p">).</span><span class="nx">modal</span><span class="p">(</span><span class="p">{</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
<span class="p">}</span>
</pre>
<p>Generates a decline box dialog with the information about the gamer who declined the invite.</p>
<p>We use a <tt class="docutils literal">decline_game</tt> template here that we created earlier. Let's fill in the template.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic3.ms-pyg.html-1"></a>&lt;p&gt;The invitation to play a game was declined by &lt;strong&gt;{{user_name}}&lt;/strong&gt;&lt;/p&gt;
</pre></div><p>As we can see it just renders the decline message using the passed in player information.</p>
</div>
<div class="section" id="the-game-invite-box-show-function">
<h3><a class="toc-backref" href="#id168">The game_invite_box_show Function</a></h3>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Show a game invite message box
 */</span>
<span class="kd">var</span> <span class="nx">game_invite_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gamer</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Set fields for the error
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#invite_box_header'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;You have been invited to a game&quot;</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#invite_box_body'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;The user &lt;strong&gt;&quot;</span>
      <span class="o">+</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">user_name</span>
      <span class="o">+</span> <span class="s2">&quot;&lt;/strong&gt; has challenged you to a game&quot;</span><span class="p">);</span>
  <span class="c1">// Show the modal box
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#invite_box'</span><span class="p">).</span><span class="nx">modal</span><span class="p">(</span><span class="p">{</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
<span class="p">}</span>
</pre>
<p>Generates a accept/decline dialog box populated with the information of the inviting player.</p>
</div>
<div class="section" id="styling-that-game">
<h3><a class="toc-backref" href="#id169">Styling That Game</a></h3>
<p>Alright we are all wired up just one more thing to fix. Let's pretty up the board a little by adjusting the css for the board. Open the file <tt class="docutils literal">public/css/app.css</tt> and enter the css.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic1.css-pyg.html-1"></a><span class="nc">.board</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.css-pyg.html-2"></a>  <span class="k">margin-left</span><span class="o">:</span><span class="m">20px</span><span class="p">;</span>
<a name="code--tic--tic3--tic1.css-pyg.html-3"></a><span class="p">}</span>
<a name="code--tic--tic3--tic1.css-pyg.html-4"></a>
<a name="code--tic--tic3--tic1.css-pyg.html-5"></a><span class="nc">.board_row</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.css-pyg.html-6"></a>  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
<a name="code--tic--tic3--tic1.css-pyg.html-7"></a><span class="p">}</span>
<a name="code--tic--tic3--tic1.css-pyg.html-8"></a>
<a name="code--tic--tic3--tic1.css-pyg.html-9"></a><span class="nc">.board_row</span> <span class="nt">span</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.css-pyg.html-10"></a>  <span class="k">margin-right</span><span class="o">:</span> <span class="m">5px</span>
<a name="code--tic--tic3--tic1.css-pyg.html-11"></a><span class="p">}</span>
</pre></div></div>
<div class="section" id="wrapping-up">
<h3><a class="toc-backref" href="#id170">Wrapping Up</a></h3>
<p>Awesome we just finished <tt class="docutils literal">Exercise 3</tt> and we have a fully working Tic-Tac-Toe game. In <tt class="docutils literal">Exercise 4</tt> we will add some bonus features to the game and also handle a user closing the browser window in the middle of a game or deciding to quit a game in progress.</p>
</div>
<div class="section" id="id12">
<h3><a class="toc-backref" href="#id171">Notes</a></h3>
<p>There is lots of room for improvement in the code that you can do. Deferring the rendering of available players when a dialog is showing is one such thing. Rendering the board once only and clearing it instead of re-rendering might be another possible avenue.</p>
</div>
</div>
<div class="section" id="tic-tac-toe-exercise-4">
<h2><a class="toc-backref" href="#id172">Tic-Tac-Toe: Exercise 4</a></h2>
<p>In the last Exercise we will be adding chat functionality to the game and a button to allow a player to quit a game in progress. As part of allowing a player to quit a game in progress we also are going to handle the situation where they close the browser in the middle of a game, thus disconnecting.</p>
<div class="section" id="id13">
<h3><a class="toc-backref" href="#id173">Where Is The Code</a></h3>
<p>The code for this exercise is located at</p>
<p><a class="reference external" href="https://github.com/christkv/tic-tac-toe-steps/tree/step3">https://github.com/christkv/tic-tac-toe-steps/tree/step3</a></p>
</div>
<div class="section" id="chatting-it-up">
<h3><a class="toc-backref" href="#id174">Chatting It Up</a></h3>
<p>Let's start with the chat functionality. Chat is defined as a text instant message conversation between two players over a game to be used for taunting and distracting you opponent so you can clinch victory. We have decided to add the chat messages themselves as an array on the board document in play. So let's open the <tt class="docutils literal">lib/models/game.js</tt> file and modify the <tt class="docutils literal">Game.create_game</tt> function to add the <tt class="docutils literal"><span class="pre">chat:[]</span></tt> field.</p>
<pre class="code javascript literal-block">
<span class="c1">//
// Create a new game, it contains all the information about the two players,
// the empty board, the whole game chat record, who is starting the
// game and who is the current player.
//
</span><span class="nx">Game</span><span class="p">.</span><span class="nx">create_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p1_sid</span>
  <span class="p">,</span> <span class="nx">p1_user_name</span>
  <span class="p">,</span> <span class="nx">p1_full_name</span>
  <span class="p">,</span> <span class="nx">p2_sid</span><span class="p">,</span> <span class="nx">p2_user_name</span><span class="p">,</span> <span class="nx">p2_full_name</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'games'</span><span class="p">).</span><span class="nx">insert</span><span class="p">(</span><span class="p">{</span>
        <span class="nx">player1_sid</span><span class="o">:</span> <span class="nx">p1_sid</span>
      <span class="p">,</span> <span class="nx">player1_user_name</span><span class="o">:</span> <span class="nx">p1_user_name</span>
      <span class="p">,</span> <span class="nx">player1_full_name</span><span class="o">:</span> <span class="nx">p1_full_name</span>
      <span class="p">,</span> <span class="nx">player2_sid</span><span class="o">:</span> <span class="nx">p2_sid</span>
      <span class="p">,</span> <span class="nx">player2_user_name</span><span class="o">:</span> <span class="nx">p2_user_name</span>
      <span class="p">,</span> <span class="nx">player2_full_name</span><span class="o">:</span> <span class="nx">p2_full_name</span>
      <span class="p">,</span> <span class="nx">board</span><span class="o">:</span> <span class="p">[</span>
          <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
      <span class="p">]</span>
      <span class="p">,</span> <span class="nx">chat</span><span class="o">:</span> <span class="p">[</span><span class="p">]</span>
      <span class="p">,</span> <span class="nx">created_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span>
      <span class="p">,</span> <span class="nx">starting_player</span><span class="o">:</span> <span class="nx">p1_sid</span>
      <span class="p">,</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">p1_sid</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">?</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">result</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>Now let's create a handler for the chat messages. Create the file <tt class="docutils literal">lib/handlers/chat_handler.js</tt> and open it with your editor.</p>
<pre class="code console literal-block">
<span class="go">touch lib/handlers/chat_handler.js</span>
</pre>
<p>enter</p>
<div class="highlight"><pre><a name="code--tic--tic4--tic1.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">emit_message</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_message</span>
<a name="code--tic--tic4--tic1.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">is_authenticated</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">is_authenticated</span>
<a name="code--tic--tic4--tic1.js-pyg.html-3"></a>  <span class="p">,</span> <span class="nx">locate_connection_with_session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">)</span>
<a name="code--tic--tic4--tic1.js-pyg.html-4"></a>                                        <span class="p">.</span><span class="nx">locate_connection_with_session</span>
<a name="code--tic--tic4--tic1.js-pyg.html-5"></a>  <span class="p">,</span> <span class="nx">emit_error</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_error</span><span class="p">;</span>
<a name="code--tic--tic4--tic1.js-pyg.html-6"></a>
<a name="code--tic--tic4--tic1.js-pyg.html-7"></a><span class="kd">var</span> <span class="nx">game</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/game&#39;</span><span class="p">);</span>
<a name="code--tic--tic4--tic1.js-pyg.html-8"></a>
<a name="code--tic--tic4--tic1.js-pyg.html-9"></a><span class="cm">/**</span>
<a name="code--tic--tic4--tic1.js-pyg.html-10"></a><span class="cm"> * This function handles the sending of a chat message between two players in a specific</span>
<a name="code--tic--tic4--tic1.js-pyg.html-11"></a><span class="cm"> * game</span>
<a name="code--tic--tic4--tic1.js-pyg.html-12"></a><span class="cm"> */</span>
<a name="code--tic--tic4--tic1.js-pyg.html-13"></a><span class="kd">var</span> <span class="nx">send_message</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic1.js-pyg.html-14"></a>  <span class="c1">// Easier to keep track of where we emitting messages</span>
<a name="code--tic--tic4--tic1.js-pyg.html-15"></a>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;send_message&quot;</span><span class="p">;</span>
<a name="code--tic--tic4--tic1.js-pyg.html-16"></a>  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;chat_message&quot;</span><span class="p">;</span>
<a name="code--tic--tic4--tic1.js-pyg.html-17"></a>
<a name="code--tic--tic4--tic1.js-pyg.html-18"></a>  <span class="c1">// Function we return that accepts the data from SocketIO</span>
<a name="code--tic--tic4--tic1.js-pyg.html-19"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic1.js-pyg.html-20"></a>    <span class="c1">// Verify that we are logged in</span>
<a name="code--tic--tic4--tic1.js-pyg.html-21"></a>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
<a name="code--tic--tic4--tic1.js-pyg.html-22"></a>      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic4--tic1.js-pyg.html-23"></a>
<a name="code--tic--tic4--tic1.js-pyg.html-24"></a>    <span class="c1">// Let&#39;s our session id, the game id and the message we </span>
<a name="code--tic--tic4--tic1.js-pyg.html-25"></a>    <span class="c1">// want to save</span>
<a name="code--tic--tic4--tic1.js-pyg.html-26"></a>    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
<a name="code--tic--tic4--tic1.js-pyg.html-27"></a>    <span class="kd">var</span> <span class="nx">game_id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">;</span>
<a name="code--tic--tic4--tic1.js-pyg.html-28"></a>    <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
<a name="code--tic--tic4--tic1.js-pyg.html-29"></a>
<a name="code--tic--tic4--tic1.js-pyg.html-30"></a>    <span class="c1">// Use the game id to locate the game</span>
<a name="code--tic--tic4--tic1.js-pyg.html-31"></a>    <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">find_game</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game_doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic1.js-pyg.html-32"></a>      <span class="c1">// If there is no game return an error message to the calling function on the client</span>
<a name="code--tic--tic4--tic1.js-pyg.html-33"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic4--tic1.js-pyg.html-34"></a>
<a name="code--tic--tic4--tic1.js-pyg.html-35"></a>      <span class="c1">// Get the session id of the player we are sending the message to</span>
<a name="code--tic--tic4--tic1.js-pyg.html-36"></a>      <span class="c1">// that is simply the other player or the other side in the game</span>
<a name="code--tic--tic4--tic1.js-pyg.html-37"></a>      <span class="kd">var</span> <span class="nx">destination_sid</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span> <span class="o">==</span> <span class="nx">our_sid</span>
<a name="code--tic--tic4--tic1.js-pyg.html-38"></a>                                <span class="o">?</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player2_sid</span> <span class="o">:</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span><span class="p">;</span>
<a name="code--tic--tic4--tic1.js-pyg.html-39"></a>
<a name="code--tic--tic4--tic1.js-pyg.html-40"></a>      <span class="c1">// Locate the destination connection</span>
<a name="code--tic--tic4--tic1.js-pyg.html-41"></a>      <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">destination_sid</span><span class="p">);</span>
<a name="code--tic--tic4--tic1.js-pyg.html-42"></a>
<a name="code--tic--tic4--tic1.js-pyg.html-43"></a>      <span class="c1">// If there is no connection it means the other player went away, </span>
<a name="code--tic--tic4--tic1.js-pyg.html-44"></a>      <span class="c1">// send an error message to the calling function on the client</span>
<a name="code--tic--tic4--tic1.js-pyg.html-45"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
<a name="code--tic--tic4--tic1.js-pyg.html-46"></a>        <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic4--tic1.js-pyg.html-47"></a>
<a name="code--tic--tic4--tic1.js-pyg.html-48"></a>      <span class="c1">// Let&#39;s get the calling functions user name</span>
<a name="code--tic--tic4--tic1.js-pyg.html-49"></a>      <span class="c1">// and the destination user&#39;s user name</span>
<a name="code--tic--tic4--tic1.js-pyg.html-50"></a>      <span class="kd">var</span> <span class="nx">our_user_id</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span> <span class="o">==</span> <span class="nx">our_sid</span>
<a name="code--tic--tic4--tic1.js-pyg.html-51"></a>                            <span class="o">?</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_user_name</span> <span class="o">:</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player2_user_name</span><span class="p">;</span>
<a name="code--tic--tic4--tic1.js-pyg.html-52"></a>      <span class="kd">var</span> <span class="nx">their_user_id</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span> <span class="o">==</span> <span class="nx">destination_sid</span>
<a name="code--tic--tic4--tic1.js-pyg.html-53"></a>                            <span class="o">?</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_user_name</span> <span class="o">:</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player2_user_name</span><span class="p">;</span>
<a name="code--tic--tic4--tic1.js-pyg.html-54"></a>
<a name="code--tic--tic4--tic1.js-pyg.html-55"></a>      <span class="c1">// Save the message to the list of chat messages for the game</span>
<a name="code--tic--tic4--tic1.js-pyg.html-56"></a>      <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">save_chat_message</span><span class="p">(</span><span class="nx">game_id</span>
<a name="code--tic--tic4--tic1.js-pyg.html-57"></a>        <span class="p">,</span> <span class="nx">our_user_id</span><span class="p">,</span> <span class="nx">their_user_id</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic1.js-pyg.html-58"></a>          <span class="c1">// Failed to save the chat message, notify the calling function on the </span>
<a name="code--tic--tic4--tic1.js-pyg.html-59"></a>          <span class="c1">// client about the error</span>
<a name="code--tic--tic4--tic1.js-pyg.html-60"></a>          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<a name="code--tic--tic4--tic1.js-pyg.html-61"></a>            <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic4--tic1.js-pyg.html-62"></a>
<a name="code--tic--tic4--tic1.js-pyg.html-63"></a>          <span class="c1">// Notify the destination user about the new chat message</span>
<a name="code--tic--tic4--tic1.js-pyg.html-64"></a>          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic4--tic1.js-pyg.html-65"></a>              <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
<a name="code--tic--tic4--tic1.js-pyg.html-66"></a>            <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span> <span class="nx">from_sid</span><span class="o">:</span> <span class="nx">our_sid</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">message</span> <span class="p">}</span>
<a name="code--tic--tic4--tic1.js-pyg.html-67"></a>          <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
<a name="code--tic--tic4--tic1.js-pyg.html-68"></a>
<a name="code--tic--tic4--tic1.js-pyg.html-69"></a>          <span class="c1">// Notify the calling function that the message delivery was successful</span>
<a name="code--tic--tic4--tic1.js-pyg.html-70"></a>          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic4--tic1.js-pyg.html-71"></a>              <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
<a name="code--tic--tic4--tic1.js-pyg.html-72"></a>            <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{}</span>
<a name="code--tic--tic4--tic1.js-pyg.html-73"></a>          <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic4--tic1.js-pyg.html-74"></a>      <span class="p">});</span>
<a name="code--tic--tic4--tic1.js-pyg.html-75"></a>    <span class="p">});</span>
<a name="code--tic--tic4--tic1.js-pyg.html-76"></a>  <span class="p">}</span>
<a name="code--tic--tic4--tic1.js-pyg.html-77"></a><span class="p">}</span>
<a name="code--tic--tic4--tic1.js-pyg.html-78"></a>
<a name="code--tic--tic4--tic1.js-pyg.html-79"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">send_message</span> <span class="o">=</span> <span class="nx">send_message</span><span class="p">;</span>
</pre></div><p>The <tt class="docutils literal">chat_handler.js</tt> file only includes a single method called <tt class="docutils literal">send_message</tt> that takes a <tt class="docutils literal">SocketIO</tt> message that includes the fields <tt class="docutils literal">game_id</tt> and <tt class="docutils literal">message</tt>. Using the <tt class="docutils literal">Game.find_game</tt> method we retrieve the game and knowing the caller session id from the <tt class="docutils literal">SocketIO</tt> socket we determine the recipients session id before calling the new method <tt class="docutils literal">Game.save_chat</tt> in the <tt class="docutils literal">lib/models/game.js</tt> file.</p>
<div class="highlight"><pre><a name="code--tic--tic4--tic2.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">ObjectID</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">).</span><span class="nx">ObjectID</span><span class="p">;</span>
<a name="code--tic--tic4--tic2.js-pyg.html-2"></a>
<a name="code--tic--tic4--tic2.js-pyg.html-3"></a><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic2.js-pyg.html-4"></a>  <span class="kd">var</span> <span class="nx">Game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>
<a name="code--tic--tic4--tic2.js-pyg.html-5"></a>
<a name="code--tic--tic4--tic2.js-pyg.html-6"></a>  <span class="c1">//</span>
<a name="code--tic--tic4--tic2.js-pyg.html-7"></a>  <span class="c1">// Create a new game, it contains all the information about the two players, </span>
<a name="code--tic--tic4--tic2.js-pyg.html-8"></a>  <span class="c1">// the empty board, the whole game chat record, who is starting the game </span>
<a name="code--tic--tic4--tic2.js-pyg.html-9"></a>  <span class="c1">// and who is the current player.</span>
<a name="code--tic--tic4--tic2.js-pyg.html-10"></a>  <span class="c1">// </span>
<a name="code--tic--tic4--tic2.js-pyg.html-11"></a>  <span class="nx">Game</span><span class="p">.</span><span class="nx">create_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p1_sid</span>
<a name="code--tic--tic4--tic2.js-pyg.html-12"></a>    <span class="p">,</span> <span class="nx">p1_user_name</span><span class="p">,</span> <span class="nx">p1_full_name</span>
<a name="code--tic--tic4--tic2.js-pyg.html-13"></a>    <span class="p">,</span> <span class="nx">p2_sid</span><span class="p">,</span> <span class="nx">p2_user_name</span><span class="p">,</span> <span class="nx">p2_full_name</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic2.js-pyg.html-14"></a>
<a name="code--tic--tic4--tic2.js-pyg.html-15"></a>      <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">insert</span><span class="p">({</span>
<a name="code--tic--tic4--tic2.js-pyg.html-16"></a>          <span class="nx">player1_sid</span><span class="o">:</span> <span class="nx">p1_sid</span>
<a name="code--tic--tic4--tic2.js-pyg.html-17"></a>        <span class="p">,</span> <span class="nx">player1_user_name</span><span class="o">:</span> <span class="nx">p1_user_name</span>
<a name="code--tic--tic4--tic2.js-pyg.html-18"></a>        <span class="p">,</span> <span class="nx">player1_full_name</span><span class="o">:</span> <span class="nx">p1_full_name</span>
<a name="code--tic--tic4--tic2.js-pyg.html-19"></a>        <span class="p">,</span> <span class="nx">player2_sid</span><span class="o">:</span> <span class="nx">p2_sid</span>
<a name="code--tic--tic4--tic2.js-pyg.html-20"></a>        <span class="p">,</span> <span class="nx">player2_user_name</span><span class="o">:</span> <span class="nx">p2_user_name</span>
<a name="code--tic--tic4--tic2.js-pyg.html-21"></a>        <span class="p">,</span> <span class="nx">player2_full_name</span><span class="o">:</span> <span class="nx">p2_full_name</span>
<a name="code--tic--tic4--tic2.js-pyg.html-22"></a>        <span class="p">,</span> <span class="nx">board</span><span class="o">:</span> <span class="p">[</span>
<a name="code--tic--tic4--tic2.js-pyg.html-23"></a>            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a name="code--tic--tic4--tic2.js-pyg.html-24"></a>          <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a name="code--tic--tic4--tic2.js-pyg.html-25"></a>          <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a name="code--tic--tic4--tic2.js-pyg.html-26"></a>          <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a name="code--tic--tic4--tic2.js-pyg.html-27"></a>        <span class="p">]</span>
<a name="code--tic--tic4--tic2.js-pyg.html-28"></a>        <span class="p">,</span> <span class="nx">created_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
<a name="code--tic--tic4--tic2.js-pyg.html-29"></a>        <span class="p">,</span> <span class="nx">starting_player</span><span class="o">:</span> <span class="nx">p1_sid</span>
<a name="code--tic--tic4--tic2.js-pyg.html-30"></a>        <span class="p">,</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">p1_sid</span>
<a name="code--tic--tic4--tic2.js-pyg.html-31"></a>      <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic2.js-pyg.html-32"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--tic--tic4--tic2.js-pyg.html-33"></a>        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">?</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">result</span><span class="p">);</span>
<a name="code--tic--tic4--tic2.js-pyg.html-34"></a>      <span class="p">})</span>
<a name="code--tic--tic4--tic2.js-pyg.html-35"></a>  <span class="p">}</span>
<a name="code--tic--tic4--tic2.js-pyg.html-36"></a>
<a name="code--tic--tic4--tic2.js-pyg.html-37"></a>  <span class="c1">//</span>
<a name="code--tic--tic4--tic2.js-pyg.html-38"></a>  <span class="c1">// Locate an existing game by it&#39;s game id</span>
<a name="code--tic--tic4--tic2.js-pyg.html-39"></a>  <span class="c1">//</span>
<a name="code--tic--tic4--tic2.js-pyg.html-40"></a>  <span class="nx">Game</span><span class="p">.</span><span class="nx">find_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic2.js-pyg.html-41"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic2.js-pyg.html-42"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--tic--tic4--tic2.js-pyg.html-43"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">doc</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
<a name="code--tic--tic4--tic2.js-pyg.html-44"></a>        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;could not find the game with id &quot;</span> <span class="o">+</span> <span class="nx">game_id</span><span class="p">));</span>
<a name="code--tic--tic4--tic2.js-pyg.html-45"></a>      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">doc</span><span class="p">);</span>
<a name="code--tic--tic4--tic2.js-pyg.html-46"></a>    <span class="p">})</span>
<a name="code--tic--tic4--tic2.js-pyg.html-47"></a>  <span class="p">}</span>
<a name="code--tic--tic4--tic2.js-pyg.html-48"></a>
<a name="code--tic--tic4--tic2.js-pyg.html-49"></a>  <span class="c1">//</span>
<a name="code--tic--tic4--tic2.js-pyg.html-50"></a>  <span class="c1">// Attempt to update the board for a specific game and player the update fails </span>
<a name="code--tic--tic4--tic2.js-pyg.html-51"></a>  <span class="c1">// if the current players is not the player attempting to update the board notice </span>
<a name="code--tic--tic4--tic2.js-pyg.html-52"></a>  <span class="c1">// that since we are doing multiple sets we are using the $atomic operation to ensure</span>
<a name="code--tic--tic4--tic2.js-pyg.html-53"></a>  <span class="c1">// we don&#39;t get any interleaved updates in between the two sets</span>
<a name="code--tic--tic4--tic2.js-pyg.html-54"></a>  <span class="c1">//</span>
<a name="code--tic--tic4--tic2.js-pyg.html-55"></a>  <span class="nx">Game</span><span class="p">.</span><span class="nx">update_board</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">game_id</span><span class="p">,</span> <span class="nx">next_sid</span><span class="p">,</span> <span class="nx">board</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic2.js-pyg.html-56"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
<a name="code--tic--tic4--tic2.js-pyg.html-57"></a>        <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">),</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">sid</span><span class="p">,</span> <span class="nx">$atomic</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
<a name="code--tic--tic4--tic2.js-pyg.html-58"></a>      <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">board</span><span class="o">:</span> <span class="nx">board</span><span class="p">,</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">next_sid</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic2.js-pyg.html-59"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--tic--tic4--tic2.js-pyg.html-60"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;It is not your turn&quot;</span><span class="p">));</span>
<a name="code--tic--tic4--tic2.js-pyg.html-61"></a>        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
<a name="code--tic--tic4--tic2.js-pyg.html-62"></a>      <span class="p">});</span>
<a name="code--tic--tic4--tic2.js-pyg.html-63"></a>  <span class="p">}</span>
<a name="code--tic--tic4--tic2.js-pyg.html-64"></a>
<a name="code--tic--tic4--tic2.js-pyg.html-65"></a>  <span class="c1">//</span>
<a name="code--tic--tic4--tic2.js-pyg.html-66"></a>  <span class="c1">// Save a chat message to it&#39;s corresponding game </span>
<a name="code--tic--tic4--tic2.js-pyg.html-67"></a>  <span class="c1">// we also save the user names for the sender and the receiver</span>
<a name="code--tic--tic4--tic2.js-pyg.html-68"></a>  <span class="c1">//</span>
<a name="code--tic--tic4--tic2.js-pyg.html-69"></a>  <span class="nx">Game</span><span class="p">.</span><span class="nx">save_chat_message</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">from_user_id</span><span class="p">,</span> <span class="nx">to_user_id</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic2.js-pyg.html-70"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
<a name="code--tic--tic4--tic2.js-pyg.html-71"></a>        <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">)}</span>
<a name="code--tic--tic4--tic2.js-pyg.html-72"></a>      <span class="p">,</span> <span class="p">{</span><span class="nx">$push</span><span class="o">:</span> <span class="p">{</span><span class="nx">chat</span><span class="o">:</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">from_user_id</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">to_user_id</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">message</span><span class="p">}}}</span>
<a name="code--tic--tic4--tic2.js-pyg.html-73"></a>      <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic2.js-pyg.html-74"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--tic--tic4--tic2.js-pyg.html-75"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;No game found to update&quot;</span><span class="p">));</span>
<a name="code--tic--tic4--tic2.js-pyg.html-76"></a>        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
<a name="code--tic--tic4--tic2.js-pyg.html-77"></a>      <span class="p">}</span>
<a name="code--tic--tic4--tic2.js-pyg.html-78"></a>    <span class="p">)</span>
<a name="code--tic--tic4--tic2.js-pyg.html-79"></a>  <span class="p">}</span>
<a name="code--tic--tic4--tic2.js-pyg.html-80"></a>
<a name="code--tic--tic4--tic2.js-pyg.html-81"></a>  <span class="c1">// Return Game object class</span>
<a name="code--tic--tic4--tic2.js-pyg.html-82"></a>  <span class="k">return</span> <span class="nx">Game</span><span class="p">;</span>
<a name="code--tic--tic4--tic2.js-pyg.html-83"></a><span class="p">}</span>
</pre></div><p>The <tt class="docutils literal">Game.save_chat</tt> method performs a <tt class="docutils literal">$push</tt> update operation to push a message object containing a <tt class="docutils literal">from</tt>, <tt class="docutils literal">to</tt> and <tt class="docutils literal">message</tt> field to the back of the <tt class="docutils literal">chat</tt> field array contained in the game document.</p>
<p>If the update is successful <tt class="docutils literal">send_message</tt> notifies both players that the message was successfully transmitted.</p>
<p>Last but not least, lets wire up the <tt class="docutils literal">send_message</tt> handler by opening the <tt class="docutils literal">app.js</tt> file in our editor and adding the lines shown below under the <tt class="docutils literal"><span class="pre">socket.on('place_marker'...</span></tt> line.</p>
<pre class="code javascript literal-block">
<span class="c1">// Accepts chat messages
</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'send_message'</span><span class="p">,</span> <span class="nx">send_message</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
</pre>
<p>Let's not forget to add the <tt class="docutils literal">send_message</tt> handler to the <tt class="docutils literal">require</tt> section at the top.</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">register_handler</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./lib/handlers/login_handler'</span><span class="p">).</span><span class="nx">register_handler</span>
  <span class="p">,</span> <span class="nx">login_handler</span>             <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./lib/handlers/login_handler'</span><span class="p">).</span><span class="nx">login_handler</span>
  <span class="p">,</span> <span class="nx">find_all_available_gamers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./lib/handlers/gamer_handler'</span><span class="p">)</span>
                                    <span class="p">.</span><span class="nx">find_all_available_gamers</span>
  <span class="p">,</span> <span class="nx">invite_gamer</span>              <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./lib/handlers/gamer_handler'</span><span class="p">).</span><span class="nx">invite_gamer</span>
  <span class="p">,</span> <span class="nx">decline_game</span>              <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./lib/handlers/gamer_handler'</span><span class="p">).</span><span class="nx">decline_game</span>
  <span class="p">,</span> <span class="nx">accept_game</span>               <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./lib/handlers/gamer_handler'</span><span class="p">).</span><span class="nx">accept_game</span>
  <span class="p">,</span> <span class="nx">place_marker</span>              <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./lib/handlers/gamer_handler'</span><span class="p">).</span><span class="nx">place_marker</span>
  <span class="p">,</span> <span class="nx">send_message</span>              <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./lib/handlers/chat_handler'</span><span class="p">).</span><span class="nx">send_message</span><span class="p">;</span>
</pre>
</div>
<div class="section" id="front-end">
<h3><a class="toc-backref" href="#id175">Front End</a></h3>
<p>We have to do some simle modifications to the frontend. Let's start by opening the <tt class="docutils literal">public/javascript/api.js</tt> file and adding a method <tt class="docutils literal">API.prototype.send_message</tt>.</p>
<div class="highlight"><pre><a name="code--tic--tic4--tic3.js-pyg.html-1"></a><span class="cm">/**</span>
<a name="code--tic--tic4--tic3.js-pyg.html-2"></a><span class="cm"> * Wraps the API used for the game and handles the socketIO connection</span>
<a name="code--tic--tic4--tic3.js-pyg.html-3"></a><span class="cm"> */</span>
<a name="code--tic--tic4--tic3.js-pyg.html-4"></a><span class="kd">var</span> <span class="nx">API</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-5"></a>  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
<a name="code--tic--tic4--tic3.js-pyg.html-6"></a>
<a name="code--tic--tic4--tic3.js-pyg.html-7"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">domain</span><span class="p">);</span>
<a name="code--tic--tic4--tic3.js-pyg.html-8"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">=</span> <span class="p">{};</span>
<a name="code--tic--tic4--tic3.js-pyg.html-9"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span> <span class="o">=</span> <span class="p">{};</span>
<a name="code--tic--tic4--tic3.js-pyg.html-10"></a>
<a name="code--tic--tic4--tic3.js-pyg.html-11"></a>  <span class="c1">// Handle the data returned over the SocketIO</span>
<a name="code--tic--tic4--tic3.js-pyg.html-12"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-13"></a>    <span class="c1">// If the data object has an event member we have</span>
<a name="code--tic--tic4--tic3.js-pyg.html-14"></a>    <span class="c1">// a valid event message from the server</span>
<a name="code--tic--tic4--tic3.js-pyg.html-15"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-16"></a>      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
<a name="code--tic--tic4--tic3.js-pyg.html-17"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-18"></a>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-19"></a>          <span class="nx">data</span><span class="p">.</span><span class="nx">is_error</span> <span class="o">?</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">data</span><span class="p">)</span> <span class="o">:</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
<a name="code--tic--tic4--tic3.js-pyg.html-20"></a>        <span class="p">}</span>
<a name="code--tic--tic4--tic3.js-pyg.html-21"></a>      <span class="p">}</span>
<a name="code--tic--tic4--tic3.js-pyg.html-22"></a>
<a name="code--tic--tic4--tic3.js-pyg.html-23"></a>      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
<a name="code--tic--tic4--tic3.js-pyg.html-24"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-25"></a>        <span class="k">while</span><span class="p">(</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-26"></a>          <span class="nx">data</span><span class="p">.</span><span class="nx">is_error</span> <span class="o">?</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">pop</span><span class="p">()(</span><span class="nx">data</span><span class="p">)</span> <span class="o">:</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">pop</span><span class="p">()(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
<a name="code--tic--tic4--tic3.js-pyg.html-27"></a>        <span class="p">}</span>
<a name="code--tic--tic4--tic3.js-pyg.html-28"></a>
<a name="code--tic--tic4--tic3.js-pyg.html-29"></a>        <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
<a name="code--tic--tic4--tic3.js-pyg.html-30"></a>      <span class="p">}</span>
<a name="code--tic--tic4--tic3.js-pyg.html-31"></a>    <span class="p">}</span>
<a name="code--tic--tic4--tic3.js-pyg.html-32"></a>  <span class="p">});</span>
<a name="code--tic--tic4--tic3.js-pyg.html-33"></a><span class="p">}</span>
<a name="code--tic--tic4--tic3.js-pyg.html-34"></a>
<a name="code--tic--tic4--tic3.js-pyg.html-35"></a><span class="cm">/**</span>
<a name="code--tic--tic4--tic3.js-pyg.html-36"></a><span class="cm"> * Register an event listener callback (will keep receiving messages)</span>
<a name="code--tic--tic4--tic3.js-pyg.html-37"></a><span class="cm"> */</span>
<a name="code--tic--tic4--tic3.js-pyg.html-38"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-39"></a>  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--tic--tic4--tic3.js-pyg.html-40"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic4--tic3.js-pyg.html-41"></a><span class="p">}</span>
<a name="code--tic--tic4--tic3.js-pyg.html-42"></a>
<a name="code--tic--tic4--tic3.js-pyg.html-43"></a><span class="cm">/**</span>
<a name="code--tic--tic4--tic3.js-pyg.html-44"></a><span class="cm"> * Register an event listener callback for a single instance of the event</span>
<a name="code--tic--tic4--tic3.js-pyg.html-45"></a><span class="cm"> */</span>
<a name="code--tic--tic4--tic3.js-pyg.html-46"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">once</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-47"></a>  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--tic--tic4--tic3.js-pyg.html-48"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic4--tic3.js-pyg.html-49"></a><span class="p">}</span>
<a name="code--tic--tic4--tic3.js-pyg.html-50"></a>
<a name="code--tic--tic4--tic3.js-pyg.html-51"></a><span class="cm">/**</span>
<a name="code--tic--tic4--tic3.js-pyg.html-52"></a><span class="cm"> * Register a new user</span>
<a name="code--tic--tic4--tic3.js-pyg.html-53"></a><span class="cm"> */</span>
<a name="code--tic--tic4--tic3.js-pyg.html-54"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-55"></a>  <span class="c1">// Do basic validation</span>
<a name="code--tic--tic4--tic3.js-pyg.html-56"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">full_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">full_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic4--tic3.js-pyg.html-57"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;Full name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic4--tic3.js-pyg.html-58"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic4--tic3.js-pyg.html-59"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;User name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic4--tic3.js-pyg.html-60"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic4--tic3.js-pyg.html-61"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;Password name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic4--tic3.js-pyg.html-62"></a>
<a name="code--tic--tic4--tic3.js-pyg.html-63"></a>  <span class="c1">// Register callback</span>
<a name="code--tic--tic4--tic3.js-pyg.html-64"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic4--tic3.js-pyg.html-65"></a>  <span class="c1">// Fire message</span>
<a name="code--tic--tic4--tic3.js-pyg.html-66"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-67"></a>      <span class="nx">full_name</span><span class="o">:</span> <span class="nx">full_name</span>
<a name="code--tic--tic4--tic3.js-pyg.html-68"></a>    <span class="p">,</span> <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
<a name="code--tic--tic4--tic3.js-pyg.html-69"></a>    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
<a name="code--tic--tic4--tic3.js-pyg.html-70"></a>  <span class="p">});</span>
<a name="code--tic--tic4--tic3.js-pyg.html-71"></a><span class="p">}</span>
<a name="code--tic--tic4--tic3.js-pyg.html-72"></a>
<a name="code--tic--tic4--tic3.js-pyg.html-73"></a><span class="cm">/**</span>
<a name="code--tic--tic4--tic3.js-pyg.html-74"></a><span class="cm"> * Login a user</span>
<a name="code--tic--tic4--tic3.js-pyg.html-75"></a><span class="cm"> */</span>
<a name="code--tic--tic4--tic3.js-pyg.html-76"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">login</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-77"></a>  <span class="c1">// Do basic validation</span>
<a name="code--tic--tic4--tic3.js-pyg.html-78"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic4--tic3.js-pyg.html-79"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;User name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic4--tic3.js-pyg.html-80"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic4--tic3.js-pyg.html-81"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;Password name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic4--tic3.js-pyg.html-82"></a>  <span class="c1">// Register callback</span>
<a name="code--tic--tic4--tic3.js-pyg.html-83"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic4--tic3.js-pyg.html-84"></a>  <span class="c1">// Fire message</span>
<a name="code--tic--tic4--tic3.js-pyg.html-85"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-86"></a>      <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
<a name="code--tic--tic4--tic3.js-pyg.html-87"></a>    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
<a name="code--tic--tic4--tic3.js-pyg.html-88"></a>  <span class="p">});</span>
<a name="code--tic--tic4--tic3.js-pyg.html-89"></a><span class="p">}</span>
<a name="code--tic--tic4--tic3.js-pyg.html-90"></a>
<a name="code--tic--tic4--tic3.js-pyg.html-91"></a><span class="cm">/**</span>
<a name="code--tic--tic4--tic3.js-pyg.html-92"></a><span class="cm"> * Find all available gamers that are active</span>
<a name="code--tic--tic4--tic3.js-pyg.html-93"></a><span class="cm"> */</span>
<a name="code--tic--tic4--tic3.js-pyg.html-94"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">find_all_available_gamers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-95"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;find_all_available_gamers&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic4--tic3.js-pyg.html-96"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;find_all_available_gamers&quot;</span><span class="p">,</span> <span class="p">{});</span>
<a name="code--tic--tic4--tic3.js-pyg.html-97"></a><span class="p">}</span>
<a name="code--tic--tic4--tic3.js-pyg.html-98"></a>
<a name="code--tic--tic4--tic3.js-pyg.html-99"></a><span class="cm">/**</span>
<a name="code--tic--tic4--tic3.js-pyg.html-100"></a><span class="cm"> * Invite a gamer to a new game</span>
<a name="code--tic--tic4--tic3.js-pyg.html-101"></a><span class="cm"> */</span>
<a name="code--tic--tic4--tic3.js-pyg.html-102"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">invite_gamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gamer</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-103"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;invite_gamer&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic4--tic3.js-pyg.html-104"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;invite_gamer&quot;</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">);</span>
<a name="code--tic--tic4--tic3.js-pyg.html-105"></a><span class="p">}</span>
<a name="code--tic--tic4--tic3.js-pyg.html-106"></a>
<a name="code--tic--tic4--tic3.js-pyg.html-107"></a><span class="cm">/**</span>
<a name="code--tic--tic4--tic3.js-pyg.html-108"></a><span class="cm"> * Decline an invite to play a game</span>
<a name="code--tic--tic4--tic3.js-pyg.html-109"></a><span class="cm"> */</span>
<a name="code--tic--tic4--tic3.js-pyg.html-110"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">decline_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">invite</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-111"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;decline_game&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic4--tic3.js-pyg.html-112"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;decline_game&quot;</span><span class="p">,</span> <span class="nx">invite</span><span class="p">);</span>
<a name="code--tic--tic4--tic3.js-pyg.html-113"></a><span class="p">}</span>
<a name="code--tic--tic4--tic3.js-pyg.html-114"></a>
<a name="code--tic--tic4--tic3.js-pyg.html-115"></a><span class="cm">/**</span>
<a name="code--tic--tic4--tic3.js-pyg.html-116"></a><span class="cm"> * Accept an invite to play a game</span>
<a name="code--tic--tic4--tic3.js-pyg.html-117"></a><span class="cm"> */</span>
<a name="code--tic--tic4--tic3.js-pyg.html-118"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">accept_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">invite</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-119"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;accept_game&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic4--tic3.js-pyg.html-120"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;accept_game&quot;</span><span class="p">,</span> <span class="nx">invite</span><span class="p">);</span>
<a name="code--tic--tic4--tic3.js-pyg.html-121"></a><span class="p">}</span>
<a name="code--tic--tic4--tic3.js-pyg.html-122"></a>
<a name="code--tic--tic4--tic3.js-pyg.html-123"></a><span class="cm">/**</span>
<a name="code--tic--tic4--tic3.js-pyg.html-124"></a><span class="cm"> * Place a marker on a specific game at a specific location</span>
<a name="code--tic--tic4--tic3.js-pyg.html-125"></a><span class="cm"> */</span>
<a name="code--tic--tic4--tic3.js-pyg.html-126"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">place_marker</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-127"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;place_marker&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic4--tic3.js-pyg.html-128"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;place_marker&quot;</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-129"></a>      <span class="nx">game_id</span><span class="o">:</span> <span class="nx">game_id</span>
<a name="code--tic--tic4--tic3.js-pyg.html-130"></a>    <span class="p">,</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">x</span>
<a name="code--tic--tic4--tic3.js-pyg.html-131"></a>    <span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">y</span>
<a name="code--tic--tic4--tic3.js-pyg.html-132"></a>  <span class="p">});</span>
<a name="code--tic--tic4--tic3.js-pyg.html-133"></a><span class="p">}</span>
<a name="code--tic--tic4--tic3.js-pyg.html-134"></a>
<a name="code--tic--tic4--tic3.js-pyg.html-135"></a><span class="cm">/**</span>
<a name="code--tic--tic4--tic3.js-pyg.html-136"></a><span class="cm"> * Send a message to a specific gamer on a specific game</span>
<a name="code--tic--tic4--tic3.js-pyg.html-137"></a><span class="cm"> */</span>
<a name="code--tic--tic4--tic3.js-pyg.html-138"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">send_message</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-139"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;send_message&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic4--tic3.js-pyg.html-140"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;send_message&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">game_id</span><span class="o">:</span> <span class="nx">game_id</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">message</span><span class="p">});</span>
<a name="code--tic--tic4--tic3.js-pyg.html-141"></a><span class="p">}</span>
<a name="code--tic--tic4--tic3.js-pyg.html-142"></a>
<a name="code--tic--tic4--tic3.js-pyg.html-143"></a><span class="cm">/**</span>
<a name="code--tic--tic4--tic3.js-pyg.html-144"></a><span class="cm"> * Simple method to create a formated error message that fits the</span>
<a name="code--tic--tic4--tic3.js-pyg.html-145"></a><span class="cm"> * format returned from the server</span>
<a name="code--tic--tic4--tic3.js-pyg.html-146"></a><span class="cm"> */</span>
<a name="code--tic--tic4--tic3.js-pyg.html-147"></a><span class="kd">var</span> <span class="nx">create_error</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-148"></a>  <span class="k">return</span> <span class="p">{</span>
<a name="code--tic--tic4--tic3.js-pyg.html-149"></a>      <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
<a name="code--tic--tic4--tic3.js-pyg.html-150"></a>    <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--tic--tic4--tic3.js-pyg.html-151"></a>    <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span> <span class="kc">true</span>
<a name="code--tic--tic4--tic3.js-pyg.html-152"></a>    <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
<a name="code--tic--tic4--tic3.js-pyg.html-153"></a>  <span class="p">}</span>
<a name="code--tic--tic4--tic3.js-pyg.html-154"></a><span class="p">}</span>
</pre></div><p>Next we need to add the HTML markup for that makes up the chat interface on the frontend. Open the file <tt class="docutils literal">public/templates/board.ms</tt> and add add the following to it, in the area marked <tt class="docutils literal">&lt;div <span class="pre">class=&quot;span4&quot;&gt;</span></tt></p>
<pre class="code html literal-block">
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span4&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;chat&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">&quot;input-block-level&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;chat message&quot;</span>
    <span class="na">id=</span><span class="s">&quot;chat_message&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre>
<p>Let's pretty it up a bit, by adding some css styling. Open the <tt class="docutils literal">public/css/app.css</tt> file and add the following to the end of it.</p>
<pre class="code css literal-block">
<span class="nf">#chat</span> <span class="nt">p</span> <span class="p">{</span>
  <span class="k">margin</span><span class="o">:</span> <span class="m">0px</span> <span class="m">0px</span> <span class="m">0px</span> <span class="m">0px</span><span class="p">;</span>
  <span class="k">padding</span><span class="o">:</span> <span class="m">0px</span> <span class="m">0px</span> <span class="m">0px</span> <span class="m">0px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#chat</span> <span class="p">{</span>
  <span class="k">border</span><span class="o">:</span> <span class="m">1px</span> <span class="k">solid</span> <span class="nb">gray</span><span class="p">;</span>
  <span class="k">height</span><span class="o">:</span> <span class="m">400px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.chat_msg_other</span> <span class="p">{</span>
  <span class="k">font-size</span><span class="o">:</span> <span class="m">14px</span><span class="p">;</span>
  <span class="k">margin-left</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
  <span class="k">margin-right</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
  <span class="k">color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.chat_msg_current</span> <span class="p">{</span>
  <span class="k">font-size</span><span class="o">:</span> <span class="m">14px</span><span class="p">;</span>
  <span class="k">margin-left</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
  <span class="k">margin-right</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
  <span class="k">color</span><span class="o">:</span> <span class="nb">blue</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p>That's formating take care off. It's time to wire up the chat functionality to your application. First open up the <tt class="docutils literal">public/javascripts/app.js</tt> file and add the <tt class="docutils literal">chat_handler</tt> function to it.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Handle chat messages from the user, (activates on the return key)
 */</span>
<span class="kd">var</span> <span class="nx">chat_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">which</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">chat_input</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#chat_message'</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">chat_window</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#chat'</span><span class="p">);</span>
      <span class="c1">// Fetch the message the user entered
</span>      <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">chat_input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

      <span class="c1">// Send the message to the other player
</span>      <span class="nx">api</span><span class="p">.</span><span class="nx">send_message</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If we have an error show the error message to the user
</span>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

        <span class="c1">// Push the current message to the bottom
</span>        <span class="nx">chat_window</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;p class=&quot;chat_msg_current&quot;&gt;'</span>
          <span class="o">+</span> <span class="nx">get_date_time_string</span><span class="p">(</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'&amp;#62; '</span> <span class="o">+</span> <span class="nx">message</span> <span class="o">+</span> <span class="s2">&quot;&lt;/p&gt;&quot;</span><span class="p">);</span>
        <span class="c1">// Clear out the messages
</span>        <span class="nx">chat_input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>Wire it up by adding the line shown below to the end of the <tt class="docutils literal">setupBoardGame</tt> function in the same <tt class="docutils literal">public/javascripts/app.js</tt> file.</p>
<pre class="code javascript literal-block">
<span class="c1">// Map up the chat handler
</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#chat_message'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">keypress</span><span class="p">(</span><span class="nx">chat_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">));</span>
</pre>
<p>The <tt class="docutils literal">chat_handler</tt> will listen for keyboard key presses and if it detects the <tt class="docutils literal">return</tt> key it will take the content of the chat input box and send it to the server using the <tt class="docutils literal">api.send_message</tt> method and append it to the chat window if the sending of the message succeeded.</p>
<p>The item we need to add is an event handler for <tt class="docutils literal">chat_message</tt> events sent from the server. This event is fired when the server relays a message from the other player. Open up the <tt class="docutils literal">public/javascripts/app.js</tt> and add the event handler shown below.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * The other player sent a message, render the message in the chat box
 */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'chat_message'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="c1">// Get the message
</span>  <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
  <span class="c1">// Get the chat window
</span>  <span class="kd">var</span> <span class="nx">chat_window</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#chat'</span><span class="p">);</span>
  <span class="c1">// Push the current message to the bottom
</span>  <span class="nx">chat_window</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;p class=&quot;chat_msg_other&quot;&gt;'</span>
    <span class="o">+</span> <span class="nx">get_date_time_string</span><span class="p">(</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'&amp;#62; '</span> <span class="o">+</span> <span class="nx">message</span> <span class="o">+</span> <span class="s1">'&lt;/p&gt;'</span><span class="p">);</span>
<span class="p">});</span>
</pre>
<p>Notice that we use a method called <tt class="docutils literal">get_date_time_string</tt>. This is a helper method to format a date-time stamp for the chat message. Add the implementation under the <tt class="docutils literal">Helper</tt> section of the <tt class="docutils literal">public/javascripts/app.js</tt> file.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Get a date time string
 */</span>
<span class="kd">var</span> <span class="nx">get_date_time_string</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">string</span> <span class="o">=</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getHours</span><span class="p">(</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">?</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getHours</span><span class="p">(</span><span class="p">)</span> <span class="o">:</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getHours</span><span class="p">(</span><span class="p">);</span>
  <span class="nx">string</span> <span class="o">+=</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">(</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">?</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">(</span><span class="p">)</span> <span class="o">:</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">(</span><span class="p">));</span>
  <span class="nx">string</span> <span class="o">+=</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getSeconds</span><span class="p">(</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">?</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getSeconds</span><span class="p">(</span><span class="p">)</span> <span class="o">:</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getSeconds</span><span class="p">(</span><span class="p">));</span>
  <span class="k">return</span> <span class="nx">string</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p>We've now finished adding the functionality for two players to perform a chat during a game. The only thing that's left to implement is the two ways to leave a game in progress. The first one is if one of the two players closes the browser window containing the game in progress, and the second one is a button on the board for the player to leave the game.</p>
</div>
<div class="section" id="reddit-is-more-interesting-i-m-out-of-here">
<h3><a class="toc-backref" href="#id176">Reddit Is More Interesting I'm Out Of Here</a></h3>
<p>The first scenario happens when one of the players close their browser window. In this case we should terminate all the current games they are participating in by sending a user went away message to all the opposing players.</p>
<p>Lets start by creating a new handler that handles socket disconnects by messaging the still active players about them. First let's create the empty handler file.</p>
<pre class="code javascript literal-block">
<span class="nx">touch</span> <span class="nx">lib</span><span class="o">/</span><span class="nx">handlers</span><span class="o">/</span><span class="nx">user_handler</span><span class="p">.</span><span class="nx">js</span>
</pre>
<p>Then it's time to fire up your editor and edit the newly created file <tt class="docutils literal">lib/handlers/user_handler.js</tt>.</p>
<div class="highlight"><pre><a name="code--tic--tic4--tic4.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">emit_message</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_message</span>
<a name="code--tic--tic4--tic4.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">is_authenticated</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">is_authenticated</span>
<a name="code--tic--tic4--tic4.js-pyg.html-3"></a>  <span class="p">,</span> <span class="nx">emit_message_all</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_message_all</span><span class="p">;</span>
<a name="code--tic--tic4--tic4.js-pyg.html-4"></a>
<a name="code--tic--tic4--tic4.js-pyg.html-5"></a><span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/user&#39;</span><span class="p">)</span>
<a name="code--tic--tic4--tic4.js-pyg.html-6"></a>  <span class="p">,</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/gamer&#39;</span><span class="p">)</span>
<a name="code--tic--tic4--tic4.js-pyg.html-7"></a>  <span class="p">,</span> <span class="nx">game</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/game&#39;</span><span class="p">);</span>
<a name="code--tic--tic4--tic4.js-pyg.html-8"></a>
<a name="code--tic--tic4--tic4.js-pyg.html-9"></a><span class="cm">/**</span>
<a name="code--tic--tic4--tic4.js-pyg.html-10"></a><span class="cm"> * Handle the disconnect event from ``SocketIO``</span>
<a name="code--tic--tic4--tic4.js-pyg.html-11"></a><span class="cm"> */</span>
<a name="code--tic--tic4--tic4.js-pyg.html-12"></a><span class="kd">var</span> <span class="nx">disconnected</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic4.js-pyg.html-13"></a>  <span class="c1">// Easier to keep track of where we emitting messages</span>
<a name="code--tic--tic4--tic4.js-pyg.html-14"></a>  <span class="kd">var</span> <span class="nx">event_name</span> <span class="o">=</span> <span class="s2">&quot;disconnected&quot;</span><span class="p">;</span>
<a name="code--tic--tic4--tic4.js-pyg.html-15"></a>
<a name="code--tic--tic4--tic4.js-pyg.html-16"></a>  <span class="c1">// Function we return that accepts the data from SocketIO</span>
<a name="code--tic--tic4--tic4.js-pyg.html-17"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic4.js-pyg.html-18"></a>    <span class="c1">// If we are not authenticated we don&#39;t care about signaling anyone</span>
<a name="code--tic--tic4--tic4.js-pyg.html-19"></a>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
<a name="code--tic--tic4--tic4.js-pyg.html-20"></a>    <span class="c1">// Grab our session id</span>
<a name="code--tic--tic4--tic4.js-pyg.html-21"></a>    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
<a name="code--tic--tic4--tic4.js-pyg.html-22"></a>
<a name="code--tic--tic4--tic4.js-pyg.html-23"></a>    <span class="c1">// Locate any games we are in that are not finalized</span>
<a name="code--tic--tic4--tic4.js-pyg.html-24"></a>    <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">finalize_all_boards_as_draws</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic4--tic4.js-pyg.html-25"></a>
<a name="code--tic--tic4--tic4.js-pyg.html-26"></a>      <span class="c1">// Emit disconnect message to everyone</span>
<a name="code--tic--tic4--tic4.js-pyg.html-27"></a>      <span class="k">return</span> <span class="nx">emit_message_all</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">event_name</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic4--tic4.js-pyg.html-28"></a>          <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
<a name="code--tic--tic4--tic4.js-pyg.html-29"></a>        <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">our_sid</span>
<a name="code--tic--tic4--tic4.js-pyg.html-30"></a>      <span class="p">},</span> <span class="nx">our_sid</span><span class="p">);</span>
<a name="code--tic--tic4--tic4.js-pyg.html-31"></a>    <span class="p">});</span>
<a name="code--tic--tic4--tic4.js-pyg.html-32"></a>  <span class="p">}</span>
<a name="code--tic--tic4--tic4.js-pyg.html-33"></a><span class="p">}</span>
<a name="code--tic--tic4--tic4.js-pyg.html-34"></a>
<a name="code--tic--tic4--tic4.js-pyg.html-35"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">disconnected</span> <span class="o">=</span> <span class="nx">disconnected</span><span class="p">;</span>
</pre></div><p>We need to locate all games that are still active for this player and then set them to the status of a <tt class="docutils literal">draw</tt> (it might not be the players fault as his internet connection might have dropped). First add the <tt class="docutils literal">Gamer.finalize_all_boards_as_draws</tt> method to the <tt class="docutils literal">lib/models/game.js</tt> file.</p>
<pre class="code javascript literal-block">
<span class="c1">//
// Finalizes all the boards as a draw
//
</span><span class="nx">Game</span><span class="p">.</span><span class="nx">finalize_all_boards_as_draws</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'games'</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
      <span class="p">{</span><span class="nx">$or</span><span class="o">:</span> <span class="p">[</span><span class="p">{</span><span class="nx">player1_sid</span><span class="o">:</span> <span class="nx">sid</span><span class="p">},</span> <span class="p">{</span><span class="nx">player2_sid</span><span class="o">:</span> <span class="nx">sid</span><span class="p">}],</span> <span class="nx">winner</span><span class="o">:</span> <span class="p">{</span><span class="nx">$exists</span><span class="o">:</span> <span class="kc">false</span><span class="p">}}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">final_state</span><span class="o">:</span> <span class="s1">'draw'</span><span class="p">,</span> <span class="nx">winner</span><span class="o">:</span> <span class="kc">null</span><span class="p">}},</span> <span class="p">{</span><span class="nx">multi</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Failed to finalize the boards with a draw&quot;</span><span class="p">));</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>If you remember from the last exercise an active game is a game without the <tt class="docutils literal">winner</tt> field set. This method locates all the games that the player closing the socket is currently in and sets them to a <tt class="docutils literal">draw</tt> state. It then messages all active players that we have experienced a disconnect event enabling them to recover from a game in progress.</p>
<p>Before we jump to the frontend let's make sure we wire up the new handler. Open the <tt class="docutils literal">app.js</tt> file and add.</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">disconnected</span>      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./lib/handlers/user_handler'</span><span class="p">).</span><span class="nx">disconnected</span><span class="p">;</span>
</pre>
<p>at the top and the handler below the <tt class="docutils literal">send_message</tt> handler</p>
<pre class="code javascript literal-block">
<span class="c1">// On disconnect
</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'disconnect'</span><span class="p">,</span> <span class="nx">disconnected</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
</pre>
<p>Now let's move to the frontend and get the event wired up correctly so the interface can respond to it.</p>
</div>
<div class="section" id="frontend-handling">
<h3><a class="toc-backref" href="#id177">Frontend Handling</a></h3>
<p>Open the <tt class="docutils literal">public/javascripts/app.js</tt> file and add an event handler for the <tt class="docutils literal">disconnect</tt> event.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * A player disconnect from the game, ensure we cancel any games we are playing
 * with them
 */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'disconnected'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="c1">// Get the sid
</span>  <span class="kd">var</span> <span class="nx">sid</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
  <span class="c1">// Check if the current game is being played with this user
</span>  <span class="k">if</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span>
    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">player1_sid</span> <span class="o">==</span> <span class="nx">sid</span>
          <span class="o">||</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">player2_sid</span> <span class="o">==</span> <span class="nx">sid</span><span class="p">))</span> <span class="p">{</span>

    <span class="c1">// Load all the available gamers
</span>    <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Save the list of games in our game state
</span>      <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>

      <span class="c1">// Show the main dashboard view and render with all the available players
</span>      <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>

      <span class="c1">// Add handlers for each new player so we can play them
</span>      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span>
            <span class="p">,</span> <span class="nx">api</span>
            <span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
      <span class="p">}</span>

      <span class="c1">// Reset the game state
</span>      <span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

      <span class="c1">// If we have an error show the error message to the user
</span>      <span class="nx">error_box_show</span><span class="p">(</span><span class="s2">&quot;User disconnected&quot;</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre>
<p>This handler will trigger on the <tt class="docutils literal">disconnected</tt> event and if the game we are currently playing is with the disconnected player we render the dashboard and display the disconnect error (this effectively puts the player back in a position where they can challenge another player).</p>
<p>We are nearly there but we need to let the gamer have a way to leave a game at their leisure as well. To allow this we are going to add a button to leave a game in progress. Let's modify the <tt class="docutils literal">public/templates/board.ms</tt> file to the button. Modify the <tt class="docutils literal">&lt;div <span class="pre">class=&quot;span&quot;&gt;</span></tt> with the HTML below adding the <tt class="docutils literal">Quit Game</tt> button.</p>
<pre class="code html literal-block">
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span4&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div&gt;&lt;button</span> <span class="na">id=</span><span class="s">&quot;quit_game&quot;</span><span class="nt">&gt;</span>Quit Game<span class="nt">&lt;/button&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;chat&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">&quot;input-block-level&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span>
    <span class="na">placeholder=</span><span class="s">&quot;chat message&quot;</span> <span class="na">id=</span><span class="s">&quot;chat_message&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre>
<p>We then need to add a handler for the <tt class="docutils literal">Quit Game</tt> button. Open up the <tt class="docutils literal">public/javascripts/app.js</tt> file and modify the <tt class="docutils literal">setupBoardGame</tt> to add a handler called <tt class="docutils literal">quit_game_handler</tt> below the <tt class="docutils literal"><span class="pre">$('#chat_message').keypress(chat_handler(application_state,</span> api, template_handler, <span class="pre">game));</span></tt> line.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Set up a new game board and add handlers to all the cells of the board
 */</span>
<span class="kd">var</span> <span class="nx">setupBoardGame</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Save current game to state
</span>  <span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span> <span class="o">=</span> <span class="nx">game</span><span class="p">;</span>
  <span class="c1">// Let's render the board game
</span>  <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;board&quot;</span><span class="p">,</span> <span class="p">{</span><span class="p">});</span>
  <span class="c1">// Set the marker for our player (X if we are the starting player)
</span>  <span class="nx">application_state</span><span class="p">.</span><span class="nx">marker</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span> <span class="o">==</span> <span class="nx">game</span><span class="p">.</span><span class="nx">current_player</span>
                                                                <span class="o">?</span> <span class="s2">&quot;x&quot;</span> <span class="o">:</span> <span class="s2">&quot;o&quot;</span><span class="p">;</span>
  <span class="c1">// Get all the rows
</span>  <span class="kd">var</span> <span class="nx">rows</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#board div'</span><span class="p">);</span>

  <span class="c1">// Add an event handler to each cell
</span>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cells</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#'</span> <span class="o">+</span> <span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; span&quot;</span><span class="p">);</span>

    <span class="c1">// For each cell create and add the handler
</span>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">cells</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">cells</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">id</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">game_board_cell_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Map up the chat handler
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#chat_message'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">keypress</span><span class="p">(</span><span class="nx">chat_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">));</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#quit_game'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">quit_game_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">));</span>
<span class="p">}</span>
</pre>
<p>Now we need to complete the <tt class="docutils literal">quit_game_handler</tt> method and add it to the <tt class="docutils literal">public/javascripts/app.js</tt> file.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Create a handler for the quit game button on the board, sending a disconnect message
 * to the server and bringing the player back to the dashboard
 */</span>
<span class="kd">var</span> <span class="nx">quit_game_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Execute a disconnect
</span>    <span class="nx">api</span><span class="p">.</span><span class="nx">leave_game</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Load all the available gamers
</span>      <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// If we have an error show the error message to the user
</span>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

        <span class="c1">// Save the list of games in our game state
</span>        <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>

        <span class="c1">// Show the main dashboard view and render with all the available players
</span>        <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>

        <span class="c1">// Add handlers for each new player so we can play them
</span>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span>
                <span class="p">,</span> <span class="nx">api</span>
                <span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>To make it all work we need to define a new <tt class="docutils literal">API</tt> call called <tt class="docutils literal">leave_game</tt> that will send a message to the server signaling that the player has left the game. Open up <tt class="docutils literal">public/javascripts/api.js</tt> and add the <tt class="docutils literal">API</tt> call.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Send a disconnect message to the server
 */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">leave_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;leave_game&quot;</span><span class="p">,</span> <span class="p">{</span><span class="p">});</span>
  <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p>Notice that we not expecting a callback as we are in fact reusing the <tt class="docutils literal">disconnected</tt> handler in the <tt class="docutils literal">lib/handlers/user_handler.js</tt> file. We do need to define a new server <tt class="docutils literal">API</tt> call named <tt class="docutils literal">leave_game</tt> but we can reuse the same <tt class="docutils literal">disconnected</tt> handler. Let's go ahead and wire up the <tt class="docutils literal">disconnect</tt> handler in the <tt class="docutils literal">app.js</tt> file.</p>
<pre class="code javascript literal-block">
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'leave_game'</span><span class="p">,</span> <span class="nx">disconnected</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
</pre>
</div>
<div class="section" id="we-did-it">
<h3><a class="toc-backref" href="#id178">We Did It</a></h3>
<p>That ends the Tic-Tac-Toe tutorial. It's been a long winding road of code and editor usage but you now have your basic Tic-Tac-Toe multi-player game. There are lots of possible improvements that be implemented in the game of course. You could extend the game to be able to run multiple games at the same time against multiple players. Maybe introduce a friend relationship with players ?. Your imagination is the limit. Go forth and expand it as much as you want.</p>
</div>
</div>
</div>
<div class="section" id="next-steps">
<h1><a class="toc-backref" href="#id179">Next Steps</a></h1>
<p>What should they do after reading your book to learn more on the subject.</p>
</div>
    </div>

    <div class="one columns" id="right-nav">
        <center>
        <p><a href="/book/"><img src="images/48_structure.png"></a></p>
        <p><a href="#"><img src="images/48_email.png"></a></p>
        <p><a href="#faq"><img src="images/48_faq.png"></a></p>
        <p>
        </p>
        </center>
    </div>

  <!-- Included JS Files (Compressed) -->
  <script src="javascripts/jquery.js"></script>
  <script src="javascripts/foundation.min.js"></script>
  
  <!-- Initialize JS Plugins -->
  <script src="javascripts/app.js"></script>

</body>
</html>