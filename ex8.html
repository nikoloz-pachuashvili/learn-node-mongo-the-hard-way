
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Exercise 8: Write Concerns &mdash; Learn MongoDB And Node.js The Hard Way</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Learn MongoDB And Node.js The Hard Way" href="index.html" />
    <link rel="next" title="Exercise 9: Update Basics" href="ex9.html" />
    <link rel="prev" title="Exercise 7: Inserting documents" href="ex7.html" /> 
  </head>
  <body>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="ex9.html" title="Exercise 9: Update Basics"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="ex7.html" title="Exercise 7: Inserting documents"
             accesskey="P">previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>



    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="exercise-8-write-concerns">
<h1>Exercise 8: Write Concerns<a class="headerlink" href="#exercise-8-write-concerns" title="Permalink to this headline">Â¶</a></h1>
<p>Remember we briefly mentioned something called <tt class="docutils literal"><span class="pre">write</span> <span class="pre">concerns</span></tt> earlier when we introduced the option <tt class="docutils literal"><span class="pre">w:0</span></tt> on the insert. Write concerns is one of the more crucial concepts to understand when using MongoDB. They allow you to set the guarantee of persitance that you want for your documents. This means you can set your app to wait for MongoDB to save the document to memory, disk or send it over to other members in a cluster (more on clusters later). At one end of the spectrum is <tt class="docutils literal"><span class="pre">w:0</span></tt> which means no <tt class="docutils literal"><span class="pre">acknowledgement</span></tt> from MongoDB. This means the driver does not ask MongoDB if the write succeded or not (fire and forget). You application will never know if the data was correctly written to MongoDB unless you attempt to retrieve the data later. This might now sound like a good idea but it comes with one good upside, namely raw insert performance. Let's say you are inserting analytical data from a mouse tracking application. The analytics might be all about aggregation so a single missing data point does not matter but the insert speed does. So to avoid that the application has to wait for an acknowledgement from MongoDB you set <tt class="docutils literal"><span class="pre">w:0</span></tt> and don't incur the cost of the acknowledgement.</p>
<p>So what kind of values can write concerns be and what do they mean. Below is a table outlining the write concerns and what they mean.</p>
<table border="1" class="docutils">
<colgroup>
<col width="6%" />
<col width="94%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">WriteConcern</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>w:0</td>
<td>No acknowlegement of the write from MongoDB</td>
</tr>
<tr class="row-odd"><td>w:1</td>
<td>MongoDB acknowleges when the document has been safely written to memory</td>
</tr>
<tr class="row-even"><td>w:2 or larger</td>
<td>MongoDB acknowleges when the document has been safely written to memory in N servers</td>
</tr>
<tr class="row-odd"><td>w:'majority'</td>
<td>MongoDB acknowleges when the document has been safely written to memory in a majority of servers (f.ex if you have 1 primary and 4 secondaries this would be 3 servers as 3 out of 5 is a majority of servers)</td>
</tr>
<tr class="row-even"><td>j:true</td>
<td>MongoDB acknowleges when the document has been safely written to the MongoDB journal</td>
</tr>
<tr class="row-odd"><td>fsync:true</td>
<td>MongoDB acknowleges when the document has been safely written to disk</td>
</tr>
</tbody>
</table>
<p>Quite a bit of new terminology. Let's look through the different write concerns and explain what they mean. I will introduce the concept of a <tt class="docutils literal"><span class="pre">replicaset</span></tt> here but only as a concept as we will go more indepth in later exercises. In short a <tt class="docutils literal"><span class="pre">replicaset</span></tt> is a MongoDB cluster that in the simplest form concists of a <tt class="docutils literal"><span class="pre">primary</span></tt> which accepts writes (inserts/update/removes) and one or more <tt class="docutils literal"><span class="pre">secondaries</span></tt> that only accept reads (queries).</p>
<p>Let's look at how MongoDB actually works under the cover when you want to ackowledge an insert. The first thing we need to understand is that MongoDB seperates the writing of the data from the ackowledgement. They are in fact two different commands. So when the driver does a non ackowledge write using <tt class="docutils literal"><span class="pre">w:0</span></tt> it only sends the write command. If your application needs written to memory ackowledgement with <tt class="docutils literal"><span class="pre">w:1</span></tt> it will send a write command and a <tt class="docutils literal"><span class="pre">getLastError</span></tt> command together.</p>
<p>The <tt class="docutils literal"><span class="pre">getLastError</span></tt> command is the command that returns the the status of the last executed operation on a specific socket. It will wait until the specified write concern is fulfilled. Let's try it ourselves. Let's fire up the <tt class="docutils literal"><span class="pre">mongo</span></tt> console.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">~ $ mongo</span>
<span class="go">MongoDB shell version: 2.2</span>
<span class="go">connecting to: test</span>
<span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test</span>
<span class="gp">&gt;</span> db.getlasterrortest.insert<span class="o">({</span>_id: 1<span class="o">})</span>
<span class="gp">&gt;</span> db.getlasterrortest.insert<span class="o">({</span>_id: 1<span class="o">})</span>
<span class="go">E11000 duplicate key error index: test.getlasterrortest.$_id_  dup key: { : 1.0 }</span>
<span class="gp">&gt;</span> db.getLastError<span class="o">()</span>
<span class="go">E11000 duplicate key error index: test.getlasterrortest.$_id_  dup key: { : 1.0 }</span>
<span class="gp">&gt;</span> db.getlasterrortest.insert<span class="o">({</span>_id: 2<span class="o">})</span>
<span class="gp">&gt;</span> db.getLastError<span class="o">()</span>
<span class="go">null</span>
</pre></div>
</div>
<p>As we can see the <tt class="docutils literal"><span class="pre">getLastError</span></tt> returns the last command status for our connection. Once we insert a new record with no error <tt class="docutils literal"><span class="pre">getLastError</span></tt> returns <tt class="docutils literal"><span class="pre">null</span></tt>.</p>
<p>So let's play with the write concerns in a bit of code. Get your editor and start typing.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>    
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;playing_with_write_concerns&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>

  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;time w:0 ~ &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">start</span><span class="p">))</span>

    <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>      
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Duplicate document&quot;</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>      
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Duplicate document&quot;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>      

        <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>      
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;time w:1 ~ &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">start</span><span class="p">))</span>

          <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>      

          <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="nx">j</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>      
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;time j:true ~ &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">start</span><span class="p">))</span>

            <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="nx">j</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>      
              <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Duplicate document&quot;</span><span class="p">)</span>
              <span class="p">}</span>

              <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>      

              <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="nx">fsync</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>      
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;time fsync:true ~ &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">start</span><span class="p">))</span>

                <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="nx">fsync</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>      
                  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Duplicate document&quot;</span><span class="p">)</span>
                  <span class="p">}</span>

                  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
                <span class="p">});</span>
              <span class="p">});</span>
            <span class="p">});</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>When I run it on my local machine the output looks something like.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">connected to database</span>
<span class="go">time w:0 ~ 0</span>
<span class="go">Duplicate document</span>
<span class="go">time w:1 ~ 0</span>
<span class="go">time j:true ~ 31</span>
<span class="go">Duplicate document</span>
<span class="go">time fsync:true ~ 35</span>
<span class="go">Duplicate document</span>
</pre></div>
</div>
<p>Let's look at the usage of the write concerns. We are doing 4 different types in this code. The first one is <tt class="docutils literal"><span class="pre">w:0</span></tt>, the second one is <tt class="docutils literal"><span class="pre">w:1</span></tt> the third <tt class="docutils literal"><span class="pre">j:true</span></tt> and the last one <tt class="docutils literal"><span class="pre">fsync:true</span></tt>. Note that when we try to insert a duplicate document using <tt class="docutils literal"><span class="pre">w:0</span></tt> we don't recieve any error message back as we are not sending the <tt class="docutils literal"><span class="pre">getLastError</span></tt> command to the MongoDB server. Once we use <tt class="docutils literal"><span class="pre">w:1,</span> <span class="pre">j:true</span> <span class="pre">or</span> <span class="pre">fsync:true</span></tt> we get an error message back when we try to insert a duplicate document. The example also calculates the time it took to insert a document when using <tt class="docutils literal"><span class="pre">w:0,</span> <span class="pre">w:1,</span> <span class="pre">j:true,</span> <span class="pre">fsync:true</span></tt> and as we can see there is a marked jump in time take from <tt class="docutils literal"><span class="pre">w:1</span></tt> to <tt class="docutils literal"><span class="pre">j:true</span></tt> and <tt class="docutils literal"><span class="pre">fsync:true</span></tt>. This is because when you put <tt class="docutils literal"><span class="pre">j:true</span></tt> <tt class="docutils literal"><span class="pre">getLastError</span></tt> waits for the document to be written to the MongoDB <tt class="docutils literal"><span class="pre">journal</span></tt>. The <tt class="docutils literal"><span class="pre">journal</span></tt> flushes to disk every <tt class="docutils literal"><span class="pre">100</span></tt> ms so in the worst case it will take <tt class="docutils literal"><span class="pre">100</span></tt> miliseconds before you get an acknowledgement but most likely it will be less than <tt class="docutils literal"><span class="pre">100</span></tt> miliseconds. However if you wait for <tt class="docutils literal"><span class="pre">j:true</span></tt> you have a guarantee that you can recover the data if the MongoDB database should crash.</p>
<p>For <tt class="docutils literal"><span class="pre">fsync:true</span></tt> the server needs to write the document to memory and then write that memory to disk which can be quite slow depending on how much data MongoDB has to write and what kind of disk you have (SSD or HD). Safe to say you should avoid <tt class="docutils literal"><span class="pre">fsync:true</span></tt> if possible.</p>
<p>We can see that <tt class="docutils literal"><span class="pre">w:1</span></tt> is close to <tt class="docutils literal"><span class="pre">w:0</span></tt> and this will for the most part be true. There are some corner cases where this is not true and that is if MongoDB has to make some space in memory before it can write the document. In this case it might take longer as it needs to be shuffle memory around to make some space for the new document. Some of the more observant might point out that <tt class="docutils literal"><span class="pre">w:0</span></tt> cannot be measures as it does not perform a <tt class="docutils literal"><span class="pre">getLastError</span></tt>. That's very true but it still shows that there is little difference between <tt class="docutils literal"><span class="pre">w:0</span></tt> and <tt class="docutils literal"><span class="pre">w:1</span></tt> when it comes to general performance.</p>
<div class="section" id="problems-in-paradise">
<h2>Problems In Paradise<a class="headerlink" href="#problems-in-paradise" title="Permalink to this headline">Â¶</a></h2>
<p>So one of the traps you can fall into is that you decide to do all the inserts using <tt class="docutils literal"><span class="pre">w:0</span></tt> only to discover that you run out of memory on huge inserts of documents. This happens because Node.js is capable of processing more documents for insert than MongoDB and your network can handle so they back up in the socket buffers until you run out of memory. Or you find that you are writing so much to MongoDB that is has problems responding to other operations.</p>
<p>Luckily there is a way to control the flow of the inserts and the clue lies in <tt class="docutils literal"><span class="pre">getLastError</span></tt>. Let's type in the example below and have a look at how the flow control works.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">batch</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">documents</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="nx">documents</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">documents</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">writeConcern</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">==</span> <span class="nx">documents</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span><span class="mi">1</span><span class="p">}</span> <span class="o">:</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span><span class="mi">0</span><span class="p">};</span>

    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">writeConcern</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">runBatches</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">batchSize</span><span class="p">,</span> <span class="nx">numberOfBatches</span><span class="p">,</span> <span class="nx">documents</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">numberOfBatches</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">();</span>  
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;number of batches left = &quot;</span> <span class="o">+</span> <span class="nx">numberOfBatches</span><span class="p">);</span>

  <span class="nx">batch</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">documents</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">batchSize</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">runBatches</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">batchSize</span><span class="p">,</span> <span class="nx">numberOfBatches</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">documents</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>    
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mybatchdocs&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">var</span> <span class="nx">batchSize</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">numberOfDocuments</span> <span class="o">=</span> <span class="mi">100005</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">numberOfBatches</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">numberOfDocuments</span> <span class="o">/</span> <span class="nx">batchSize</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">leftOverDocuments</span> <span class="o">=</span> <span class="nx">numberOfDocuments</span> <span class="o">%</span> <span class="nx">batchSize</span><span class="p">;</span>

  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">numberOfDocuments</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">documents</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">i</span><span class="o">:</span><span class="nx">i</span><span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">runBatches</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">batchSize</span><span class="p">,</span> <span class="nx">numberOfBatches</span><span class="p">,</span> <span class="nx">documents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">leftOverDocuments</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>

    <span class="nx">batch</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">documents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>The first part of the code after the <tt class="docutils literal"><span class="pre">MongoClient.connect</span></tt> is to generate an array of documents (in this case <tt class="docutils literal"><span class="pre">100005</span></tt> documents). After creating the documents we calculate the number of batches needed when the batchsize is <tt class="docutils literal"><span class="pre">1000</span></tt>. And after getting the right number of batches we use the <tt class="docutils literal"><span class="pre">modulo</span> <span class="pre">operator</span> <span class="pre">%</span></tt> in the statement <tt class="docutils literal"><span class="pre">var</span> <span class="pre">leftOverDocuments</span> <span class="pre">=</span> <span class="pre">numberOfDocuments</span> <span class="pre">%</span> <span class="pre">batchSize;</span></tt> to determine how many documents are left outside the batches. In this case the number of batches are <tt class="docutils literal"><span class="pre">100</span></tt> and the left over number of documents <tt class="docutils literal"><span class="pre">5</span></tt></p>
<p>We then call the <tt class="docutils literal"><span class="pre">runBatches</span></tt> function with the collection, batchSize, numberOfBatches and documents. The <tt class="docutils literal"><span class="pre">runBatches</span></tt> function calls the <tt class="docutils literal"><span class="pre">batch</span></tt> function that inserts <tt class="docutils literal"><span class="pre">999</span></tt> with the write concern <tt class="docutils literal"><span class="pre">w:0</span></tt> and then the last one of the <tt class="docutils literal"><span class="pre">1000</span></tt> with the write concern <tt class="docutils literal"><span class="pre">w:1</span></tt>. Once the <tt class="docutils literal"><span class="pre">batch</span></tt> function finishes we call <tt class="docutils literal"><span class="pre">runBatches</span></tt> again with <tt class="docutils literal"><span class="pre">numberOfBatches</span> <span class="pre">-</span> <span class="pre">1</span></tt> until <tt class="docutils literal"><span class="pre">numberOfBatches</span></tt> equals <tt class="docutils literal"><span class="pre">0</span></tt> (notice that we call <tt class="docutils literal"><span class="pre">numberOfBatches</span></tt> using <tt class="docutils literal"><span class="pre">process.nextTick()</span></tt> to make sure we don't run out of stack space). After the batch inserts are done we check if we have any left over documents and do a final <tt class="docutils literal"><span class="pre">batch</span></tt> insert with any leftover documents.</p>
<p>The benefit of this is that we are inserting <tt class="docutils literal"><span class="pre">1000</span></tt> documents and for each <tt class="docutils literal"><span class="pre">1000</span></tt> documents we are doing a write concern of <tt class="docutils literal"><span class="pre">w:1</span></tt> to let MongoDB catch up. This lets us throttle the insert rate, get the benefit of no ackowledgement using <tt class="docutils literal"><span class="pre">w:0</span></tt> but at the same time avoiding overflowing the socket buffers.</p>
</div>
<div class="section" id="setting-default-write-concern">
<h2>Setting Default Write Concern<a class="headerlink" href="#setting-default-write-concern" title="Permalink to this headline">Â¶</a></h2>
<p>The Node.js driver lets you set the default write concern at different levels. <tt class="docutils literal"><span class="pre">MongoClient</span></tt> already comes with the default write concern set to <tt class="docutils literal"><span class="pre">w:1</span></tt> but your application can set it at the <tt class="docutils literal"><span class="pre">Db</span></tt>, <tt class="docutils literal"><span class="pre">Collection</span></tt> or individual operation. Let's enter some example code showing how to set it at different levels.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test?w=0&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>    
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;my_write_concern_docs&#39;</span><span class="p">);</span>

  <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">});</span>

  <span class="kd">var</span> <span class="nx">collectionWithWriteConcernSet</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;my_write_concern_docs&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span><span class="mi">1</span><span class="p">});</span>

  <span class="nx">collectionWithWriteConcernSet</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;write concern on collection caught duplicate key error&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">j</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;write concern on collection caught duplicate key error&quot;</span><span class="p">);</span>
      <span class="p">}</span>      

      <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>When you run the script the output should look something like this.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">connected to database</span>
<span class="go">write concern on collection caught duplicate key error</span>
<span class="go">write concern on collection caught duplicate key error</span>
</pre></div>
</div>
<p>Let's dissect the code and look at how it works. The first insert is the <tt class="docutils literal"><span class="pre">collection.insert({_id:1})</span></tt> when we connected to the db we used the connection string <tt class="docutils literal"><span class="pre">mongodb://localhost:27017/test?w=0</span></tt> where <tt class="docutils literal"><span class="pre">w=0</span></tt> means no ackowledgement by default. This is inherited by the collection when we do <tt class="docutils literal"><span class="pre">var</span> <span class="pre">collection</span> <span class="pre">=</span> <span class="pre">db.collection('my_write_concern_docs');</span></tt> meaning that the first insert is done with <tt class="docutils literal"><span class="pre">w:0</span></tt>. The second insert shows how we can override the default write concern set for the database for a collection. <tt class="docutils literal"><span class="pre">var</span> <span class="pre">collectionWithWriteConcernSet</span> <span class="pre">=</span> <span class="pre">db.collection('my_write_concern_docs',</span> <span class="pre">{w:1});</span></tt> creates a new collection object where all operations will default to <tt class="docutils literal"><span class="pre">w:1</span></tt>. This causes the insert to fail as we try to insert a duplicate document. The last insert shows how we can override the write concern on an individual insert operation. In this case we take the <tt class="docutils literal"><span class="pre">collection</span></tt> variable which has the default write concern <tt class="docutils literal"><span class="pre">w:0</span></tt> and override it for the insert to be <tt class="docutils literal"><span class="pre">j:true</span></tt> by doing <tt class="docutils literal"><span class="pre">collection.insert({_id:1},</span> <span class="pre">{j:true},</span> <span class="pre">.......</span></tt>.</p>
<p>As we can see write concerns can be specified at the <tt class="docutils literal"><span class="pre">Db</span></tt>, <tt class="docutils literal"><span class="pre">Collection</span></tt> and the individual operation level and if not set the individual operation inherits from the <tt class="docutils literal"><span class="pre">Collection</span></tt> settings while the <tt class="docutils literal"><span class="pre">Collection</span></tt> inherits the write concern from the <tt class="docutils literal"><span class="pre">Db</span></tt> if not set.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal"><span class="pre">Replicasets</span></tt> and write concerns will be covered in later exercises. One of the things to keep in mind about write concerns is that the cost of higher guarantees of durability comes with an insert performance cost. So think carefully if you need your documents to be replicated across multiple <tt class="docutils literal"><span class="pre">secondaries</span></tt> or if you are good enough with them being ackowledged as written to the memory of the <tt class="docutils literal"><span class="pre">primary</span></tt> server. A typical mistake is to be to paranoid about losing data and setting the highest possible durability you can do and getting very bad insert performance as a consequence.</p>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="ex9.html" title="Exercise 9: Update Basics"
             >next</a></li>
        <li class="right" >
          <a href="ex7.html" title="Exercise 7: Inserting documents"
             >previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>
    <a name="comments"><hr/></a>

<div sytle="text-align: left">
    <div style="background: white; padding: 10px" id="disqus_thread"></div>
</div>
    <script type="text/javascript">
        var dow = new Date().getDay();

        if(dow == 5 || dow == 6) {
            $("#disqus_thread").html("<h1>Today Is Christians's Day Off</h1><p>I take Saturday and Sunday off.  Comments open again on Monday-Friday.</p>")
        } else {
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'learn-code-the-hard-way'; // required: replace example with your forum shortname


            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        }
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <div class="footer">
      &copy; Copyright 2012, Christian Amor Kvalheim.
      Last updated on Jan 31, 2013.
</div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24168052-9']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </body>
</html>