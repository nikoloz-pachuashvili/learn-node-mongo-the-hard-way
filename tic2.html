
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tic-Tac-Toe: Exercise 2 &mdash; Learn MongoDB And Node.js The Hard Way</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Learn MongoDB And Node.js The Hard Way" href="index.html" />
    <link rel="next" title="Tic-Tac-Toe: Exercise 3" href="tic3.html" />
    <link rel="prev" title="Tic-Tac-Toe: Exercise 1" href="tic1.html" /> 
  </head>
  <body>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="tic3.html" title="Tic-Tac-Toe: Exercise 3"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="tic1.html" title="Tic-Tac-Toe: Exercise 1"
             accesskey="P">previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>



    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="tic-tac-toe-exercise-2">
<h1>Tic-Tac-Toe: Exercise 2<a class="headerlink" href="#tic-tac-toe-exercise-2" title="Permalink to this headline">¶</a></h1>
<p>Welcome back it's time to start implementing the first parts of our game. In this exercise we will focus on the registration and login process for the game allowing our marks (I mean potential tic-tac-toe players) to register as players and to return to wet their addiction in the future with a user and password. Since we want to keep the registration process as simple as possible we are going to just remove such fancy things as email verification or captchas (feel free to add this if you fear an avalanche of 419 scammers).</p>
<p>As we touched on in the last exercise we decided to go with an API over <tt class="docutils literal"><span class="pre">SocketIO</span></tt> as it's all the rage (at least in 2013 when this was written) and we've forgone any fancy frameworks like <tt class="docutils literal"><span class="pre">meteor</span></tt>, <tt class="docutils literal"><span class="pre">geddy</span></tt> or <tt class="docutils literal"><span class="pre">socketstream</span></tt> to make it very clear what's going on (I hope).</p>
<div class="section" id="where-is-the-code">
<h2>Where Is The Code<a class="headerlink" href="#where-is-the-code" title="Permalink to this headline">¶</a></h2>
<p>The code for this exercise is located at</p>
<p><a class="reference external" href="https://github.com/christkv/tic-tac-toe-steps/tree/step1">https://github.com/christkv/tic-tac-toe-steps/tree/step1</a></p>
</div>
<div class="section" id="it-s-like-lego-but-with-code">
<h2>It's Like LEGO But With Code<a class="headerlink" href="#it-s-like-lego-but-with-code" title="Permalink to this headline">¶</a></h2>
<p>Let's create the files we are going to be using in our exercise.</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">touch lib/handlers/login_handler.js</span>
<span class="go">touch lib/models/shared.js</span>
<span class="go">touch lib/models/user.js</span>
<span class="go">touch lib/models/gamer.js</span>
</pre></div>
</td></tr></table></div>
<p>We are going to need two API calls for our registration and login process. The first method one is to <tt class="docutils literal"><span class="pre">register</span></tt> a new user and the second method, is to allow an existing user to <tt class="docutils literal"><span class="pre">login</span></tt>. Open the <tt class="docutils literal"><span class="pre">app.js</span></tt> file and add the new handlers for our API calls.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">env</span>                               <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./env&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">main_controller</span>                   <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/controllers/main_controller&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">register_handler</span>                  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/login_handler&#39;</span><span class="p">).</span><span class="nx">register_handler</span>
  <span class="p">,</span> <span class="nx">login_handler</span>                     <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/login_handler&#39;</span><span class="p">).</span><span class="nx">login_handler</span>


<span class="nx">env</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>  
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

  <span class="c1">//</span>
  <span class="c1">// http routes</span>
  <span class="c1">//</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">main_controller</span><span class="p">.</span><span class="nx">index</span><span class="p">());</span>

  <span class="c1">//</span>
  <span class="c1">// websocket api end point handlers (our API)</span>
  <span class="c1">//</span>
  <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;register&#39;</span><span class="p">,</span> <span class="nx">register_handler</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="nx">login_handler</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
    
    <span class="c1">// Fire the init message to setup the game</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">event</span><span class="o">:</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="nx">ok</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">});</span>
  <span class="p">});</span>

  <span class="c1">//</span>
  <span class="c1">// fire up the server</span>
  <span class="c1">//  </span>
  <span class="nx">env</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    
    <span class="c1">//</span>
    <span class="c1">// nothing to do</span>
    <span class="c1">//</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>Notice that we are adding the handlers as events to the socket connection. This is because we are using the custom event functionality of <tt class="docutils literal"><span class="pre">SocketIO</span></tt> to map our messages from the <tt class="docutils literal"><span class="pre">frontend</span></tt> javascript to the backend API.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;register&#39;</span><span class="p">,</span> <span class="nx">register_handler</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="nx">login_handler</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
</pre></div>
</td></tr></table></div>
<p>We pass in the <tt class="docutils literal"><span class="pre">io</span></tt> variable that represents our <tt class="docutils literal"><span class="pre">SocketIO</span></tt> instance allowing us to interact with all of the other <tt class="docutils literal"><span class="pre">SocketIO</span></tt> connections. Next is the current <tt class="docutils literal"><span class="pre">socket</span></tt> representing the current user, then the <tt class="docutils literal"><span class="pre">session</span> <span class="pre">store</span></tt> so we can do such stuff as registering if the user is currently logged on or not and finally the <tt class="docutils literal"><span class="pre">db</span></tt> instance so we can interact with <tt class="docutils literal"><span class="pre">MongoDB</span></tt>.</p>
<p>We are defining both of these <tt class="docutils literal"><span class="pre">handler</span></tt> functions in the <tt class="docutils literal"><span class="pre">lib/handlers/login_handler.js</span></tt> file and then including them at the top of the file using <tt class="docutils literal"><span class="pre">require</span></tt>.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">register_handler</span>                  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/login_handler&#39;</span><span class="p">).</span><span class="nx">register_handler</span>
  <span class="p">,</span> <span class="nx">login_handler</span>                     <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/login_handler&#39;</span><span class="p">).</span><span class="nx">login_handler</span>
</pre></div>
</td></tr></table></div>
<p>Don't worry how these handlers look we will get back to them in a minute. First we need to talk a bit about how our data structures look.</p>
</div>
<div class="section" id="modeling-that-data">
<h2>Modeling That Data<a class="headerlink" href="#modeling-that-data" title="Permalink to this headline">¶</a></h2>
<p>It's quite obvious that we need some sort of entities (data structures) in our game. In this game we've decided to use the two terms <tt class="docutils literal"><span class="pre">user</span></tt> and <tt class="docutils literal"><span class="pre">gamer</span></tt> where <tt class="docutils literal"><span class="pre">user</span></tt> is the login and user information for a particular mark(user) and gamer is the current <tt class="docutils literal"><span class="pre">session</span></tt> relationship between a <tt class="docutils literal"><span class="pre">user</span></tt> in <tt class="docutils literal"><span class="pre">MongoDB</span></tt> and the browser the user is playing on.</p>
<p>For the user we will need a couple of functions to allow us to correctly implement a <tt class="docutils literal"><span class="pre">registration</span></tt> and <a href="#id1"><span class="problematic" id="id2">``</span></a>login process`.</p>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="76%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Function</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>findByUser</td>
<td>Locate a user object by user name</td>
</tr>
<tr class="row-odd"><td>findByUserAndPassword</td>
<td>Locate a user by username and password, used for login verification</td>
</tr>
<tr class="row-even"><td>createUser</td>
<td>Create a user with his full name, user name and elected password</td>
</tr>
</tbody>
</table>
<p>Let's Implement the user module, fire up the editor again and enter.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;crypto&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>

  <span class="c1">//</span>
  <span class="c1">// Locate a user by a user name</span>
  <span class="c1">//</span>
  <span class="nx">User</span><span class="p">.</span><span class="nx">findByUser</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">//</span>
  <span class="c1">// Locate a user by user name and password</span>
  <span class="c1">//</span>
  <span class="nx">User</span><span class="p">.</span><span class="nx">findByUserAndPassword</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Hash password</span>
    <span class="kd">var</span> <span class="nx">sha1</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;sha1&#39;</span><span class="p">);</span>
    <span class="nx">sha1</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">password</span><span class="p">);</span>
    <span class="c1">// Get digest</span>
    <span class="kd">var</span> <span class="nx">hashed_password</span> <span class="o">=</span> <span class="nx">sha1</span><span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span>
    <span class="c1">// Locate user</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">findOne</span><span class="p">(</span>
      <span class="p">{</span>   <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
        <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">hashed_password</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">//</span>
  <span class="c1">// Create a new user with full name and password</span>
  <span class="c1">//</span>
  <span class="nx">User</span><span class="p">.</span><span class="nx">createUser</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Hash password</span>
    <span class="kd">var</span> <span class="nx">sha1</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;sha1&#39;</span><span class="p">);</span>
    <span class="nx">sha1</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">password</span><span class="p">);</span>
    <span class="c1">// Get digest</span>
    <span class="kd">var</span> <span class="nx">hashed_password</span> <span class="o">=</span> <span class="nx">sha1</span><span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span>
    <span class="c1">// Insert user</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">insert</span><span class="p">(</span>
      <span class="p">{</span>   <span class="nx">full_name</span><span class="o">:</span> <span class="nx">full_name</span>
        <span class="p">,</span> <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
        <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">hashed_password</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">User</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>There are a couple of things to notice here. The first one is the <tt class="docutils literal"><span class="pre">module.exports</span> <span class="pre">=</span> <span class="pre">function(db)</span></tt>. This lets us do <tt class="docutils literal"><span class="pre">user(db).findByUser</span></tt> and apply the method <tt class="docutils literal"><span class="pre">findByUser</span></tt> to the selected <tt class="docutils literal"><span class="pre">db</span></tt>. Remember that in <tt class="docutils literal"><span class="pre">Javascript</span></tt> a constructor is just a function so in this case <tt class="docutils literal"><span class="pre">User</span></tt> which is a function is returned but since it's created inside the function <tt class="docutils literal"><span class="pre">module.exports</span> <span class="pre">=</span> <span class="pre">function(db)</span></tt> <tt class="docutils literal"><span class="pre">db</span></tt> is in the scope of the returned <tt class="docutils literal"><span class="pre">User</span></tt> function. A useful pattern to remember.</p>
<p>Let's move on and have a look at <tt class="docutils literal"><span class="pre">findByUserAndPassword</span></tt> method. We are using the <tt class="docutils literal"><span class="pre">crypto</span></tt> library in <tt class="docutils literal"><span class="pre">Node.js</span></tt> to encrypt the passed in password. Always remember to do this in your application. <tt class="docutils literal"><span class="pre">NEVER</span></tt> store the clean word password in your database as it's a huge security risk. In this case I've picked a hashing method called <tt class="docutils literal"><span class="pre">sha1</span></tt> but feel free to pick something like <tt class="docutils literal"><span class="pre">sha256</span></tt> if you really want to avoid the chance of people being able to crack the password. We then turn the <tt class="docutils literal"><span class="pre">sha'ed</span></tt> password into a <tt class="docutils literal"><span class="pre">hex</span></tt> string and attempt to lookup a user by the user name and the <tt class="docutils literal"><span class="pre">hex</span></tt> digest of the password. If no user is returned, there either is no user or the password does not match.</p>
<p>The <tt class="docutils literal"><span class="pre">createUser</span></tt> method is quite similar to the <tt class="docutils literal"><span class="pre">findByUserAndPassword</span></tt>, the main difference being that we are adding a user to the db instead of checking if it exists or has a valid password.</p>
<p>Let's move on to the <tt class="docutils literal"><span class="pre">gamer</span></tt> model we are using to map the users browser <tt class="docutils literal"><span class="pre">session</span></tt> to his database <tt class="docutils literal"><span class="pre">user</span></tt>. For this one we are going to need a couple of things. First off all we are defining the <tt class="docutils literal"><span class="pre">collection</span></tt> for the data as <tt class="docutils literal"><span class="pre">time</span> <span class="pre">to</span> <span class="pre">live</span> <span class="pre">or</span> <span class="pre">TTL</span></tt> collection meaning that the seesions will timeout after a certain period of time (in this case 60 seconds times 60 minutes or 1 hour). The other two methods we will need is to look up a user by a <tt class="docutils literal"><span class="pre">session</span></tt> and to update an existing gamer <tt class="docutils literal"><span class="pre">session</span></tt>.</p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Function</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>findGamerBySid</td>
<td>Locate a gamer by his session id</td>
</tr>
<tr class="row-odd"><td>updateGamer</td>
<td>Updates a given user with a live session id</td>
</tr>
<tr class="row-even"><td>init</td>
<td>Sets up the TTL collection</td>
</tr>
</tbody>
</table>
<p>Fire up the editor and implement the code below.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Gamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>

  <span class="c1">//</span>
  <span class="c1">// Locate a gamer by his session id</span>
  <span class="c1">//</span>
  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">findGamerBySid</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">).</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">sid</span><span class="o">:</span> <span class="nx">sid</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">//</span>
  <span class="c1">// Update a gamers current activity time and session id</span>
  <span class="c1">// when they come back after some time away</span>
  <span class="c1">//</span>
  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">updateGamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">sid</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">({</span><span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span><span class="p">}</span>
      <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">updated_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span> <span class="nx">sid</span><span class="o">:</span><span class="nx">sid</span><span class="p">}}</span>
      <span class="p">,</span> <span class="p">{</span><span class="nx">upsert</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">//</span>
  <span class="c1">// Initialize the gamer collection, by adding indexes etc</span>
  <span class="c1">//</span>
  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">).</span><span class="nx">ensureIndex</span><span class="p">({</span><span class="nx">updated_on</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">expireAfterSeconds</span><span class="o">:</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)},</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">Gamer</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Two things to notice are the <tt class="docutils literal"><span class="pre">Gamer.init</span></tt> and the <tt class="docutils literal"><span class="pre">Gamer.updateGamer</span></tt> methods. The first <tt class="docutils literal"><span class="pre">Gamer.init</span></tt> should be run only once when we are setting up the server to ensure we have the <tt class="docutils literal"><span class="pre">TTL</span></tt> index all set up on the <tt class="docutils literal"><span class="pre">gamers</span></tt> collection. Let's modify the <tt class="docutils literal"><span class="pre">env.js</span></tt> file.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">run</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">init</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

    <span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">APP_PORT</span><span class="p">,</span> <span class="nx">APP_HOST</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// Print out a nice message to the console</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
          <span class="p">[</span> <span class="s2">&quot;&quot;</span>
          <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
          <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
          <span class="p">,</span> <span class="s2">&quot;  — — — | — — — | — — — &quot;</span>
          <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
          <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
          <span class="p">,</span> <span class="s2">&quot;  — — — | — — — | — — — &quot;</span>
          <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
          <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
          <span class="p">,</span> <span class="s2">&quot;&quot;</span>
          <span class="p">,</span> <span class="s2">&quot;tic-tac-toe server v&quot;</span> <span class="o">+</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./package.json&#39;</span><span class="p">).</span><span class="nx">version</span>
          <span class="p">,</span> <span class="s2">&quot;listening on port &quot;</span> <span class="o">+</span> <span class="nx">APP_PORT</span> <span class="o">+</span> <span class="s2">&quot; and host &quot;</span> <span class="o">+</span> <span class="nx">APP_HOST</span>
        <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">));</span>

      <span class="c1">// Return successful start of server</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>  
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Notice that we added the line <tt class="docutils literal"><span class="pre">gamer(db).init(...)</span></tt> to the <tt class="docutils literal"><span class="pre">env.js</span></tt> file. This means the initialization of the <tt class="docutils literal"><span class="pre">TTL</span></tt> index on the <tt class="docutils literal"><span class="pre">gamers</span></tt> collection will only happen at startup and only once. We've now set up the models, let's get cracking on the backend API's for our game.</p>
</div>
<div class="section" id="handlers-for-the-win">
<h2>Handlers For The Win<a class="headerlink" href="#handlers-for-the-win" title="Permalink to this headline">¶</a></h2>
<p>We have two handlers we need to define on the server side, to allow a new user to <tt class="docutils literal"><span class="pre">register</span></tt> and an existing user to <tt class="docutils literal"><span class="pre">login</span></tt>. These are the <tt class="docutils literal"><span class="pre">register_handler</span></tt> and <tt class="docutils literal"><span class="pre">login_handler</span></tt> methods.</p>
<p>Fire up the text editor, open <tt class="docutils literal"><span class="pre">lib/handlers/login_handler.js</span></tt> and get cracking on the code for the handlers by entering the following code.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">emit_message</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_message</span>
  <span class="p">,</span> <span class="nx">emit_message_all</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_message_all</span>
  <span class="p">,</span> <span class="nx">emit_error</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_error</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/user&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/gamer&#39;</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Register a new user</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">register_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages</span>
  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;register&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Unpack the parameters</span>
    <span class="kd">var</span> <span class="nx">full_name</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">full_name</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">user_name</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>

    <span class="c1">// Check if the user already exists</span>
    <span class="nx">user</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findByUser</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">_user</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If there is there is an error when attempting to find the user</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
      
      <span class="c1">// The user already exists notify the client function</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">_user</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> 
        <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User with user name &quot;</span> <span class="o">+</span> <span class="nx">user_name</span> <span class="o">+</span> <span class="s2">&quot; already exists&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

      <span class="c1">// The user does not exist, let&#39;s create it</span>
      <span class="nx">user</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">createUser</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">_user</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// There was an error during the creation of the user, emit an error message</span>
        <span class="c1">// to the calling client</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
        
        <span class="c1">// We have a legal registration, lets set up the state needed</span>
        <span class="c1">// and log the user in</span>
        <span class="nx">emit_login_or_registration_ok</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">db</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>        
      <span class="p">});</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Attempt to login user</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">login_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages</span>
  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;login&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Unpack the parameters</span>
    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">user_name</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
    
    <span class="c1">// Locate the user by user name and password</span>
    <span class="nx">user</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findByUserAndPassword</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If there is there is an error when attempting to find the user      </span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
      <span class="c1">// There was no user returned, meaning the user either does not exist or the</span>
      <span class="c1">// password is incorrect</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">user</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User or Password is incorrect&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
      
      <span class="c1">// We have a legal login, lets set up the state needed</span>
      <span class="c1">// and log the user in</span>
      <span class="nx">emit_login_or_registration_ok</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">db</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Updates the gamer status and sets up the session as being authenticated, finally</span>
<span class="cm"> * returns the gamer data to all other clients that are connected signaling a new</span>
<span class="cm"> * player is available</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">emit_login_or_registration_ok</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">db</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages</span>
  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;gamer_joined&quot;</span><span class="p">;</span>

  <span class="c1">// Update the current gamer with the new session id and update the last updated date time</span>
  <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">updateGamer</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="s2">&quot;Failed to Save user as active&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Set authenticated on the session</span>
    <span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">].</span><span class="nx">user_name</span> <span class="o">=</span> <span class="nx">user_name</span><span class="p">;</span>
    
    <span class="c1">// Return succesful login (including setting up user as logged in)</span>
    <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Find the gamer so we can send the info</span>
    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findGamerBySid</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

      <span class="c1">// Fire off gamer joined to all connections minus our own</span>
      <span class="nx">emit_message_all</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">event_name</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">gamer</span>
      <span class="p">},</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>  
<span class="p">}</span>

<span class="c1">// Export functions</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">register_handler</span> <span class="o">=</span> <span class="nx">register_handler</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">login_handler</span> <span class="o">=</span> <span class="nx">login_handler</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="the-register-handler-function">
<h2>The register_handler Function<a class="headerlink" href="#the-register-handler-function" title="Permalink to this headline">¶</a></h2>
<p>Let's have a look at the <tt class="docutils literal"><span class="pre">register_handler</span></tt> method that handles the registration of a new user to the game. The first thing you'll notice is that we return a <tt class="docutils literal"><span class="pre">function</span></tt>. This is used to create a unique function tied to the specific connection's socket. The returned function responds to any messages sent via <tt class="docutils literal"><span class="pre">SocketIO</span></tt> with the event <tt class="docutils literal"><span class="pre">register</span></tt>.</p>
<p><tt class="docutils literal"><span class="pre">SocketIO</span></tt> will return a <tt class="docutils literal"><span class="pre">data</span></tt> object that contains <tt class="docutils literal"><span class="pre">full_name</span></tt>, <tt class="docutils literal"><span class="pre">user_name</span></tt> and <tt class="docutils literal"><span class="pre">password</span></tt>. The first step is to check if the user already exists by calling the <tt class="docutils literal"><span class="pre">findByUser</span></tt> method on the <tt class="docutils literal"><span class="pre">User</span></tt> model we have. If there is one we call a method called <tt class="docutils literal"><span class="pre">emit_error</span></tt> that is defined in the file <tt class="docutils literal"><span class="pre">lib/models/shared.js</span></tt>. Let's have a quick look at <tt class="docutils literal"><span class="pre">emit_error</span></tt> in <tt class="docutils literal"><span class="pre">lib/models/shared.js</span></tt></p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Emit the standard error message across the SocketIO connection</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">emit_error</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">socket</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">socket</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
        <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span><span class="kc">true</span>
        <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
      <span class="p">});</span>          
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
      <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
      <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span><span class="kc">true</span>
      <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
    <span class="p">});</span>    
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Emit the standard message across the SocketIO connection</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">emit_message</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Add event</span>
  <span class="nx">message</span><span class="p">.</span><span class="nx">event</span> <span class="o">=</span> <span class="nx">event</span><span class="p">;</span>
  <span class="c1">// Emit</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Emit a message to all clients minus the excluded session id connection</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">emit_message_all</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">exclude_sid</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">clients</span><span class="p">();</span>

  <span class="c1">// Locate our session id</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">!=</span> <span class="nx">exclude_sid</span> 
      <span class="o">&amp;&amp;</span> <span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span>
      <span class="o">&amp;&amp;</span> <span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">].</span><span class="nx">user_name</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span> 

<span class="nx">exports</span><span class="p">.</span><span class="nx">emit_error</span>                      <span class="o">=</span> <span class="nx">emit_error</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">emit_message</span>                    <span class="o">=</span> <span class="nx">emit_message</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">emit_message_all</span>                <span class="o">=</span> <span class="nx">emit_message_all</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>As we can see the method <tt class="docutils literal"><span class="pre">emit_error</span></tt> will emit an object to one or more <tt class="docutils literal"><span class="pre">SocketIO</span></tt> sockets (if it detects that the socket parameter is an Array it will loop through all the sockets and emit the error). The message is <tt class="docutils literal"><span class="pre">standardized</span></tt> for the application so we can handle all the errors the same way in the browser. Standardizing your messaging protocol is quite useful to avoid complexity and unnecessary duplicated code.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
  <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span><span class="kc">true</span>
  <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>The other two functions in the <tt class="docutils literal"><span class="pre">shared.js</span></tt> file is the <tt class="docutils literal"><span class="pre">emit_message</span></tt> and <tt class="docutils literal"><span class="pre">emit_message_all</span></tt>. The <tt class="docutils literal"><span class="pre">emit_message</span></tt> is fairly simple it just emits a message over the provided <tt class="docutils literal"><span class="pre">SocketIO</span></tt> with a given socket, event and message. The <tt class="docutils literal"><span class="pre">emit_message_all</span></tt> uses the <tt class="docutils literal"><span class="pre">io.socket.clients()</span></tt> method to get a list of all connected <tt class="docutils literal"><span class="pre">SocketIO</span></tt> clients and then loops through all of them with the exception being the <tt class="docutils literal"><span class="pre">socket</span></tt> that called the method. The exclusion is done using the <tt class="docutils literal"><span class="pre">clients[i].handshake.sessionID</span></tt> that is set in the <tt class="docutils literal"><span class="pre">env.js</span></tt> file when a user first visits the game and a <tt class="docutils literal"><span class="pre">SocketIO</span></tt> connection is made from the browser to the server.</p>
<p>If no user exists we create a new user using the <tt class="docutils literal"><span class="pre">User.createUser</span></tt> method we wrote earlier and use the shared method <tt class="docutils literal"><span class="pre">emit_login_or_registration_ok</span></tt> to login the user and notify the browser about a successful login.</p>
<p>The first thing the function <tt class="docutils literal"><span class="pre">emit_login_or_registration_ok</span></tt> does is to update the current gamers session and last active time, using the passed in user name. It then sets the sessions value <tt class="docutils literal"><span class="pre">session_store.sessions[socket.handshake.sessionID].user_name</span></tt> that is used to ensure the user is authenticated (in later exercises we will use this to lock down API calls to make sure there is a valid authenticated user calling the method). Once this is done we send a message back over the user <tt class="docutils literal"><span class="pre">socket</span></tt> with the event <tt class="docutils literal"><span class="pre">register</span></tt> and the object <tt class="docutils literal"><span class="pre">{ok:true}</span></tt> that notifies the browser that the user was registered successfully and is now logged in.</p>
<p>At the end of the handler we look up our <tt class="docutils literal"><span class="pre">gamer</span></tt> document by our <tt class="docutils literal"><span class="pre">session</span></tt> id and send a message with the event <tt class="docutils literal"><span class="pre">gamer_joined</span></tt> to all the other gamers currently connected via SocketIO. This lets us update things such as the list of available players when other people log in. Since we are iterating over all the live <tt class="docutils literal"><span class="pre">SocketIO</span></tt> connections, only players that are still active will receive the message of the newly joined gamer.</p>
<p>That end the the backend part of the registration/login process. Let's move on to the frontend part of the application and implement the user facing part of the game.</p>
</div>
<div class="section" id="fronting-it">
<h2>Fronting It<a class="headerlink" href="#fronting-it" title="Permalink to this headline">¶</a></h2>
<p>One of the things we touched upon earlier was a common error message. We want to have a common error box for all errors on the frontend and we are going to add it as a <tt class="docutils literal"><span class="pre">modal</span></tt> dialog using <tt class="docutils literal"><span class="pre">bootstrap</span></tt>. Let's bring up the editor and add it to our <tt class="docutils literal"><span class="pre">index.html</span></tt> file.</p>
<div class="highlight-html"><pre>&lt;!DOCTYPE html&gt;
&lt;html lang="en" ng-app="app"&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;title&gt;Tic-Tac-Toe&lt;/title&gt;

    &lt;!-- Le styles --&gt;
    &lt;link href="/css/bootstrap.css" rel="stylesheet"&gt;
    &lt;style type="text/css"&gt;
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
    &lt;/style&gt;
    &lt;link href="/css/bootstrap-responsive.css" rel="stylesheet"&gt;
    &lt;link href="/css/app.css" rel="stylesheet"&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div&gt;
      &lt;ng-view&gt;&lt;/ng-view&gt;
    &lt;/div&gt;
    &lt;script type="text/javascript" src="javascripts/jquery.js"&gt;&lt;/script&gt;
    &lt;script src="/socket.io/socket.io.js"&gt;&lt;/script&gt;
    &lt;script type="text/javascript" src="javascripts/api.js"&gt;&lt;/script&gt;
    &lt;script type="text/javascript" src="javascripts/template_handler.js"&gt;&lt;/script    
    &lt;script type="text/javascript" src="javascripts/mustache.js"&gt;&lt;/script&gt;
    &lt;script type="text/javascript" src="javascripts/bootstrap.min.js"&gt;&lt;/script&gt;
    &lt;script type="text/javascript" src="javascripts/app.js"&gt;&lt;/script&gt;

    &lt;div class="container"&gt;

      &lt;div class="navbar navbar-inverse navbar-fixed-top"&gt;
        &lt;div class="navbar-inner"&gt;
          &lt;div class="container"&gt;
            &lt;a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"&gt;
              &lt;span class="icon-bar"&gt;&lt;/span&gt;
              &lt;span class="icon-bar"&gt;&lt;/span&gt;
              &lt;span class="icon-bar"&gt;&lt;/span&gt;
            &lt;/a&gt;
            &lt;a class="brand" href="#"&gt;Tic-Tac-Toe&lt;/a&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;!-- Main hero unit for a primary marketing message or call to action --&gt;
      &lt;div class="hero-unit"&gt;
        &lt;h1&gt;Tic Tac Toe!&lt;/h1&gt;
        &lt;p&gt;Play Tic Tac Toe against your friends in this multiplayer demo.&lt;/p&gt;
        &lt;p&gt;&lt;a class="btn btn-primary btn-large" href="https://github.com/christkv/tic-tac-toe"&gt;Github &amp;raquo;&lt;/a&gt;&lt;/p&gt;
      &lt;/div&gt;

      &lt;!-- Example row of columns --&gt;
      &lt;div class="row" id="view"&gt;
      &lt;/div&gt;

      &lt;hr&gt;

      &lt;footer&gt;
        &lt;p&gt;&amp;copy; Christian Kvalheim 2012&lt;/p&gt;
      &lt;/footer&gt;

    &lt;/div&gt; &lt;!-- /container --&gt;
    &lt;!-- Modal --&gt;
    &lt;div id="status_box" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="status_box" aria-hidden="true"&gt;
      &lt;div class="modal-header"&gt;
        &lt;button type="button" class="close" data-dismiss="modal" aria-hidden="true"&gt;×&lt;/button&gt;
        &lt;h3 id="status_box_header"&gt;Modal header&lt;/h3&gt;
      &lt;/div&gt;
      &lt;div class="modal-body"&gt;
        &lt;p id="status_box_body"&gt;&lt;/p&gt;
      &lt;/div&gt;
      &lt;div class="modal-footer"&gt;
        &lt;button class="btn" data-dismiss="modal" aria-hidden="true"&gt;Close&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;    
  &lt;/body&gt;
&lt;/html&gt;</pre>
</div>
<p>Awesome let's look at the core of the frontend interface to our backend. This is the <tt class="docutils literal"><span class="pre">public/javascript/api.js</span></tt> file. Open the file and enter the following code.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Wraps the API used for the game and handles the socketIO connection</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">API</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">domain</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="c1">// Handle the data returned over the SocketIO</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// If the data object has an event member we have</span>
    <span class="c1">// a valid event message from the server</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">data</span><span class="p">.</span><span class="nx">is_error</span> <span class="o">?</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">data</span><span class="p">)</span> <span class="o">:</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">data</span><span class="p">.</span><span class="nx">is_error</span> <span class="o">?</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">pop</span><span class="p">()(</span><span class="nx">data</span><span class="p">)</span> <span class="o">:</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">pop</span><span class="p">()(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Register an event listener callback (will keep receiving messages)</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Register an event listener callback for a single instance of the event</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">once</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Register a new user</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>  
  <span class="c1">// Do basic validation</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">full_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">full_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;Full name cannot be empty&quot;</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;User name cannot be empty&quot;</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;Password name cannot be empty&quot;</span><span class="p">));</span>
  <span class="c1">// Register callback</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="c1">// Fire message</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">full_name</span><span class="o">:</span> <span class="nx">full_name</span>
    <span class="p">,</span> <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Login a user</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">login</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>  
  <span class="c1">// Do basic validation</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;User name cannot be empty&quot;</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;Password name cannot be empty&quot;</span><span class="p">));</span>
  <span class="c1">// Register callback</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="c1">// Fire message</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Simple method to create a formated error message that fits the</span>
<span class="cm"> * format returned from the server</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">create_error</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
      <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
    <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
    <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Let's start with the actual API creation function.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Wraps the API used for the game and handles the socketIO connection</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">API</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">domain</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="c1">// Handle the data returned over the SocketIO</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// If the data object has an event member we have</span>
    <span class="c1">// a valid event message from the server</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">data</span><span class="p">.</span><span class="nx">is_error</span> <span class="o">?</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">data</span><span class="p">)</span> <span class="o">:</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">data</span><span class="p">.</span><span class="nx">is_error</span> <span class="o">?</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">pop</span><span class="p">()(</span><span class="nx">data</span><span class="p">)</span> <span class="o">:</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">pop</span><span class="p">()(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The first thing you'll notice is that we use the <tt class="docutils literal"><span class="pre">docuemnt.domain</span></tt> as the identifier for the <tt class="docutils literal"><span class="pre">SocketIO</span></tt> connection. This is to ensure we are not doing cross-domain websockets and to avoid any authentication issues. Once the connection has been created we add an event listener to the event <tt class="docutils literal"><span class="pre">data</span></tt>. Notice that we don't handle any <tt class="docutils literal"><span class="pre">errors</span></tt> on the socket. We leave it as an exercise to handle how to reconnect if the socket closes.</p>
<p>The handler for the <tt class="docutils literal"><span class="pre">data</span></tt> event takes the object returned by <tt class="docutils literal"><span class="pre">SocketIO</span></tt> and determines what kind of event it is by looking at the <tt class="docutils literal"><span class="pre">data.event</span></tt> value that is always present in our messages (hence the importance of standardizing your messaging protocol messages so they always look the same). After having determined what kind of <tt class="docutils literal"><span class="pre">event</span></tt> we received we locate all the handlers that are interested in the event and call their functions notifying all interested parties.</p>
<p>There are two types of handlers we can set up.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Register an event listener callback (will keep receiving messages)</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Register an event listener callback for a single instance of the event</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">once</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>A <tt class="docutils literal"><span class="pre">on</span></tt> and <tt class="docutils literal"><span class="pre">once</span></tt> handler (blatant ripoff from Node.js EventEmitter). The <tt class="docutils literal"><span class="pre">on</span></tt> registers a function to an <tt class="docutils literal"><span class="pre">event</span></tt> that gets called each time that event is detected in a <tt class="docutils literal"><span class="pre">SocketIO</span></tt> message. The <tt class="docutils literal"><span class="pre">once</span></tt> registers a function that will only fire once when a message of the event type is detected in a <tt class="docutils literal"><span class="pre">SocketIO</span></tt> message.</p>
<p>Why do we do this. Well simply put. When we do a single call to the backend we don't want the callback to be executed more than once and since all messaging is driven by events we register a callback for only a single <tt class="docutils literal"><span class="pre">execution</span></tt>. But for some other things like when a new player joins the game we might want to get messaged each time it happens using the same function. That's when <tt class="docutils literal"><span class="pre">on</span></tt> comes into force. Don't worry it will make more sense when we show you the next piece of code. The more astute of you might have noticed that this could cause an issue if you have multiple messages being fired on the same event (how would it know what callback to send the message to). A solution for this would be to extend our protocol to contain a callback identifier so a message would contain some sort of identification of what the originating callback was. However this is not needed for our simple Tic-Tac-Toe game and is left for you as an exercise. Let's look at the handlers.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Register a new user</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Do basic validation</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">full_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">full_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;Full name cannot be empty&quot;</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;User name cannot be empty&quot;</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;Password name cannot be empty&quot;</span><span class="p">));</span>
  <span class="c1">// Register callback</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="c1">// Fire message</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">full_name</span><span class="o">:</span> <span class="nx">full_name</span>
    <span class="p">,</span> <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Login a user</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">login</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Do basic validation</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;User name cannot be empty&quot;</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;Password name cannot be empty&quot;</span><span class="p">));</span>
  <span class="c1">// Register callback</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="c1">// Fire message</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Send a message to a specific gamer on a specific game</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">send_message</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;send_message&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;send_message&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">game_id</span><span class="o">:</span> <span class="nx">game_id</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">message</span><span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Simple method to create a formated error message that fits the</span>
<span class="cm"> * format returned from the server</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">create_error</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
      <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
    <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
    <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Let's have a look at the <tt class="docutils literal"><span class="pre">API.prototype.register</span></tt> function in the <tt class="docutils literal"><span class="pre">API</span></tt>. It first does a couple of validations checking that <tt class="docutils literal"><span class="pre">full_name</span></tt>, <tt class="docutils literal"><span class="pre">user_name</span></tt> and <tt class="docutils literal"><span class="pre">password</span></tt> are not empty strings and if anyone of them are it returns a <tt class="docutils literal"><span class="pre">standardized</span></tt> error message (same format as we send from the server) using the <tt class="docutils literal"><span class="pre">create_error</span></tt> function. If all the validations pass we use the <tt class="docutils literal"><span class="pre">once</span></tt> method mentioned above to register the calling function's <tt class="docutils literal"><span class="pre">callback</span></tt> function to the event <tt class="docutils literal"><span class="pre">register</span></tt>. This means that when the frontend receives an event of type <tt class="docutils literal"><span class="pre">register</span></tt> it will locate that callback and execute it returning the results to the code originally calling the <tt class="docutils literal"><span class="pre">register</span></tt> <tt class="docutils literal"><span class="pre">API</span></tt> method. After registering the <tt class="docutils literal"><span class="pre">callback</span></tt> the method sends a message down to the backend with the event <tt class="docutils literal"><span class="pre">register</span></tt> that gets processed by our backend handler in the <tt class="docutils literal"><span class="pre">lib/handlers/login_handler.js</span></tt> file called <tt class="docutils literal"><span class="pre">register_handler</span></tt>.</p>
<p>The same applies for the <tt class="docutils literal"><span class="pre">API.prototype.login</span></tt> method. The difference being that the message sent is handled by the <tt class="docutils literal"><span class="pre">login_handler</span></tt> function in the <tt class="docutils literal"><span class="pre">lib/handlers/login_handler.js</span></tt> file.</p>
</div>
<div class="section" id="wiring-up-the-code">
<h2>Wiring Up The Code<a class="headerlink" href="#wiring-up-the-code" title="Permalink to this headline">¶</a></h2>
<p>We've defined the <tt class="docutils literal"><span class="pre">API</span></tt> for the game, now let's wire it all up so we can actually perform a registration or login from the browser. Open the file <tt class="docutils literal"><span class="pre">public/javascript/app.js</span></tt> in your editor.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1">// Contains the application state</span>
<span class="kd">var</span> <span class="nx">application_state</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">session_id</span><span class="o">:</span> <span class="kc">null</span>
<span class="p">}</span>

<span class="c1">// Create an instance of the API class</span>
<span class="kd">var</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">API</span><span class="p">();</span>

<span class="c1">// Create a template handler with all the templates</span>
<span class="c1">// used in the application</span>
<span class="kd">var</span> <span class="nx">template_handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TemplateHandler</span><span class="p">({</span>
    <span class="s2">&quot;main&quot;</span><span class="o">:</span> <span class="s2">&quot;/templates/main.ms&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="o">:</span> <span class="s2">&quot;/templates/dashboard.ms&quot;</span>
<span class="p">});</span>

<span class="c1">// Load all the templates and once it&#39;s done</span>
<span class="c1">// register up all the initial button handlers</span>
<span class="nx">template_handler</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Render the main view in the #view div</span>
  <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="p">{});</span>

  <span class="c1">// Wire up the buttons for the main view</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#register_button&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">register_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#login_button&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">login_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<span class="p">})</span>

<span class="cm">/*********************************************************************************************</span>
<span class="cm"> * Application events we listen to</span>
<span class="cm"> ********************************************************************************************/</span>

<span class="cm">/**</span>
<span class="cm"> * The init event, the server has set up everything an assigned us</span>
<span class="cm"> * a session id that we can use in the application</span>
<span class="cm"> */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">});</span>

<span class="cm">/**</span>
<span class="cm"> * A new gamer logged on, display the new user in the list of available gamers</span>
<span class="cm"> * to play</span>
<span class="cm"> */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;gamer_joined&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<span class="p">});</span>

<span class="cm">/*********************************************************************************************</span>
<span class="cm"> * Handlers</span>
<span class="cm"> ********************************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm"> * Handles the attempt to register a new user</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">register_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>    
    <span class="c1">// Lets get the values for the registration</span>
    <span class="kd">var</span> <span class="nx">full_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputFullNameRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputUserNameRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputPasswordRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>

    <span class="c1">// Attempt to register a new user</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Show the main dashboard view and render with all the available players</span>
      <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span> <span class="p">[]});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Handles the attempt to login</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">login_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Lets get the values for the login</span>
    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputUserNameLogin&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputPasswordLogin&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>

    <span class="c1">// Attempt to login the user</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Show the main dashboard view and render with all the available players</span>
      <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span> <span class="p">[]});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************************************************************</span>
<span class="cm"> * Helper methods</span>
<span class="cm"> ********************************************************************************************/</span>

<span class="cm">/**</span>
<span class="cm"> * Show an error message box</span>
<span class="cm"> */</span> 
<span class="kd">var</span> <span class="nx">error_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Set fields for the error</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_header&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;Registration Error&quot;</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_body&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="c1">// Show the modal box</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">({</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>    
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The first part of the file is the <tt class="docutils literal"><span class="pre">application_state</span></tt>. This object keeps track of all application specific information needed across the lifetime of the application such as the current session id associated with the current user. The <tt class="docutils literal"><span class="pre">var</span> <span class="pre">api</span> <span class="pre">=</span> <span class="pre">new</span> <span class="pre">API()</span></tt> statement keeps an instance of the api around for the application to use and initiates contact with the server backend over <tt class="docutils literal"><span class="pre">SocketIO</span></tt>.</p>
<p>Let's take a look at the class we use to handle the rendering of all our templates in the application. Lets open the <tt class="docutils literal"><span class="pre">public/javascripts/template_handler.js</span></tt> and add the following code.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * The template handler just keeps our mustache templates</span>
<span class="cm"> * and wraps basic things like loading the templates and rendering them</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">TemplateHandler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">templates</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">templates</span> <span class="o">=</span> <span class="nx">templates</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">template_file_content</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">numberOfTemplates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="c1">// Get templates count</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">name</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">templates</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">numberOfTemplates</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">numberOfTemplates</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Load all the templates using jquery and save them in our internal</span>
<span class="cm"> * cache</span>
<span class="cm"> */</span>
<span class="nx">TemplateHandler</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>  
  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">numberOfTemplates</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">name</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">templates</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Execute each get in it&#39;s own context</span>
    <span class="kd">var</span> <span class="nx">wrapper_function</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template_name</span><span class="p">,</span> <span class="nx">template_location</span><span class="p">)</span> <span class="p">{</span>
      
      <span class="c1">// Load the initial mustache template</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">templates</span><span class="p">[</span><span class="nx">name</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;loaded template: &quot;</span> <span class="o">+</span> <span class="nx">template_name</span> <span class="o">+</span> <span class="s2">&quot; at &quot;</span> <span class="o">+</span> <span class="nx">template_location</span><span class="p">);</span>

        <span class="c1">// Store the template in the file content cache</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">template_file_content</span><span class="p">[</span><span class="nx">template_name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">template</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">callback</span><span class="p">();</span>
      <span class="p">})</span>
    <span class="p">}</span>

    <span class="c1">// Wrap the load to ensure we keep the scope local to the function</span>
    <span class="nx">wrapper_function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">templates</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Render a template by the template name and then set a div with the rendered template, the context is an</span>
<span class="cm"> * object of values used in the template</span>
<span class="cm"> */</span>
<span class="nx">TemplateHandler</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setTemplate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">template_name</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>  
  <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
  <span class="c1">// If there is no such HTML container throw an error</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">container</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">container</span><span class="p">.</span><span class="nx">html</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;no container &quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
  <span class="c1">// If the template does not exist throw an error</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template_file_content</span><span class="p">[</span><span class="nx">template_name</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;no template name &quot;</span> <span class="o">+</span> <span class="nx">template_name</span> <span class="o">+</span> <span class="s2">&quot; loaded&quot;</span><span class="p">);</span>
  <span class="c1">// Ensure at least empty context</span>
  <span class="nx">context</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="p">{}</span> <span class="o">:</span> <span class="nx">context</span><span class="p">;</span>
  <span class="c1">// Render template</span>
  <span class="kd">var</span> <span class="nx">rendered_template</span> <span class="o">=</span> <span class="nx">Mustache</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template_file_content</span><span class="p">[</span><span class="nx">template_name</span><span class="p">],</span> <span class="nx">context</span><span class="p">);</span>
  <span class="c1">// No error render the template</span>
  <span class="nx">container</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">rendered_template</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Verify if a template exists</span>
<span class="cm"> */</span>
<span class="nx">TemplateHandler</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isTemplate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template_name</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">template_file_content</span><span class="p">[</span><span class="nx">template_name</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Just render a template and return the text</span>
<span class="cm"> */</span>
<span class="nx">TemplateHandler</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template_name</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// If the template does not exist throw an error</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template_file_content</span><span class="p">[</span><span class="nx">template_name</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;no template name &quot;</span> <span class="o">+</span> <span class="nx">template_name</span> <span class="o">+</span> <span class="s2">&quot; loaded&quot;</span><span class="p">);</span>
  <span class="c1">// Ensure at least empty context</span>
  <span class="nx">context</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="p">{}</span> <span class="o">:</span> <span class="nx">context</span><span class="p">;</span>
  <span class="c1">// Render template</span>
  <span class="k">return</span> <span class="nx">Mustache</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template_file_content</span><span class="p">[</span><span class="nx">template_name</span><span class="p">],</span> <span class="nx">context</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The <tt class="docutils literal"><span class="pre">TemplateHandler</span></tt> class takes care of loading, caching and rendering our templates used in the application using the <tt class="docutils literal"><span class="pre">Mustache</span></tt> template rendering engine.</p>
<table border="1" class="docutils">
<colgroup>
<col width="28%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Function</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>start</td>
<td>Loads all the templates provided in the constructor</td>
</tr>
<tr class="row-odd"><td>setTemplate</td>
<td>Renders a template and sets a div</td>
</tr>
<tr class="row-even"><td>isTemplate</td>
<td>Checks if a named template exists</td>
</tr>
<tr class="row-odd"><td>render</td>
<td>Render a named template and return the rendered result</td>
</tr>
</tbody>
</table>
<p>All templates passed into the <tt class="docutils literal"><span class="pre">TemplateHandler</span></tt> constructor are passed as an object like this.</p>
<div class="highlight-json"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="p">{</span>
    <span class="nt">&quot;main&quot;</span><span class="p">:</span> <span class="s2">&quot;/templates/main.ms&quot;</span>
  <span class="p">,</span> <span class="nt">&quot;dashboard&quot;</span><span class="p">:</span> <span class="s2">&quot;/templates/dashboard.ms&quot;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Each template has an unique name and an url pointing to the location where the template itself is stored. All the templates are written in a template language called <tt class="docutils literal"><span class="pre">Mustache</span></tt> <a class="reference external" href="http://mustache.github.com/">http://mustache.github.com/</a>.</p>
<p>The benefit of <tt class="docutils literal"><span class="pre">Mustache</span></tt> is that it keeps a very sharp divider between your code and the rendering avoiding silly string concatenations to generate HTML for your application. You can read more up on <tt class="docutils literal"><span class="pre">Mustache</span></tt> on the link above but safe to say it's a very very simple and limited little template language which fits the needs of our application well.</p>
<p>Open up your editor and enter the two templates. The first one is at <tt class="docutils literal"><span class="pre">public/templates/main.ms</span></tt></p>
<div class="highlight-mustache"><pre>&lt;div class="span6"&gt;
  &lt;h2&gt;Register&lt;/h2&gt;
  &lt;p&gt;Pick a user name and enter your full name to be able to play games, you can reuse the user name as many times as you wish.&lt;/p&gt;
  &lt;form class="form-horizontal"&gt;
    &lt;div class="control-group"&gt;
      &lt;label class="control-label" for="inputFullNameRegister"&gt;Full Name&lt;/label&gt;
      &lt;div class="controls"&gt;
        &lt;input type="text" id="inputFullNameRegister" placeholder="Full Name"&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="control-group"&gt;
      &lt;label class="control-label" for="inputUserNameRegister"&gt;User Name&lt;/label&gt;
      &lt;div class="controls"&gt;
        &lt;input type="text" id="inputUserNameRegister" placeholder="User Name"&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="control-group"&gt;
      &lt;label class="control-label" for="inputPasswordRegister"&gt;Password&lt;/label&gt;
      &lt;div class="controls"&gt;
        &lt;input type="password" id="inputPasswordRegister" placeholder="Password"&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="control-group"&gt;
      &lt;div class="controls"&gt;
        &lt;button type="button" class="btn" id="register_button"&gt;Register&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/form&gt;
&lt;/div&gt;
&lt;div class="span6"&gt;
  &lt;h2&gt;Log in&lt;/h2&gt;
  &lt;form class="form-horizontal"&gt;
    &lt;div class="control-group"&gt;
      &lt;label class="control-label" for="inputUserNameLogin"&gt;User Name&lt;/label&gt;
      &lt;div class="controls"&gt;
        &lt;input type="text" id="inputUserNameLogin" placeholder="User Name"&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="control-group"&gt;
      &lt;label class="control-label" for="inputPasswordLogin"&gt;Password&lt;/label&gt;
      &lt;div class="controls"&gt;
        &lt;input type="password" id="inputPasswordLogin" placeholder="Password"&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="control-group"&gt;
      &lt;div class="controls"&gt;
        &lt;button type="button" class="btn" id="login_button"&gt;Login&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/form&gt;
&lt;/div&gt;</pre>
</div>
<p>The second one is at <tt class="docutils literal"><span class="pre">public/templates/dashboard.ms</span></tt></p>
<div class="highlight-mustache"><pre>Dashboard</pre>
</div>
<p>The <tt class="docutils literal"><span class="pre">TemplateHandler.prototype.start</span></tt> method will use <tt class="docutils literal"><span class="pre">JQuery</span></tt> to load the templates specified in the constructor and store them in an internal object. The application uses the method <tt class="docutils literal"><span class="pre">TemplateHandler.prototype.setTemplate</span></tt> to overwrite an HTML element's contents identified by <tt class="docutils literal"><span class="pre">id</span></tt> with the content of the rendered template identified by <tt class="docutils literal"><span class="pre">template_name</span></tt> and the value in the passed in <tt class="docutils literal"><span class="pre">context</span></tt> object.</p>
<p><tt class="docutils literal"><span class="pre">TemplateHandler.prototype.render</span></tt> is similar to the <tt class="docutils literal"><span class="pre">TemplateHandler.prototype.setTemplate</span></tt> method but only returns the rendered template result instead of overwriting the content of a HTML element.</p>
<p>That covers how the <tt class="docutils literal"><span class="pre">TemplateHandler</span></tt> class works. It's time to get back to the <tt class="docutils literal"><span class="pre">public/javascript/app.js</span></tt> file and write some of the code for the application.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1">// Load all the templates and once it&#39;s done</span>
<span class="c1">// register up all the initial button handlers</span>
<span class="nx">template_handler</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Render the main view in the #view div</span>
  <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="p">{});</span>

  <span class="c1">// Wire up the buttons for the main view</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#register_button&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">register_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#login_button&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">login_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<span class="p">})</span>
</pre></div>
</td></tr></table></div>
<p>When the user first goes to <tt class="docutils literal"><span class="pre">http://localhost:3000</span></tt> a <tt class="docutils literal"><span class="pre">TemplateHandler</span></tt> instance gets created and the method <tt class="docutils literal"><span class="pre">start</span></tt> is called that loads all the templates. The code then sets the initial template view overwriting the HTML element identified by the id <tt class="docutils literal"><span class="pre">view</span></tt> with the starting application view. After rendering and replacing the HTML the method wires up the <tt class="docutils literal"><span class="pre">register_button</span></tt> and the <tt class="docutils literal"><span class="pre">login_button</span></tt> to listen for <tt class="docutils literal"><span class="pre">click</span></tt> events. If a user clicks the <tt class="docutils literal"><span class="pre">register_button</span></tt> the <tt class="docutils literal"><span class="pre">register_button_handler</span></tt> function is called and if the user clicks the <tt class="docutils literal"><span class="pre">login_button</span></tt> the <tt class="docutils literal"><span class="pre">login_button_handler</span></tt> function is called. That takes care of wiring up the buttons. Let's look at the wiring up of <tt class="docutils literal"><span class="pre">event</span></tt> handlers in <tt class="docutils literal"><span class="pre">public/javascript/app.js</span></tt>.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * The init event, the server has set up everything an assigned us</span>
<span class="cm"> * a session id that we can use in the application</span>
<span class="cm"> */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">});</span>

<span class="cm">/**</span>
<span class="cm"> * A new gamer logged on, display the new user in the list of available gamers</span>
<span class="cm"> * to play</span>
<span class="cm"> */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;gamer_joined&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>Here we are using the <tt class="docutils literal"><span class="pre">on</span></tt> method from the <tt class="docutils literal"><span class="pre">API</span></tt> class to listen to the events <tt class="docutils literal"><span class="pre">init</span></tt> and <tt class="docutils literal"><span class="pre">gamer_joined</span></tt>.</p>
<p>Looking at the <tt class="docutils literal"><span class="pre">api.on('init',</span> <span class="pre">..)</span></tt> event handler we see that we are storing the returned data in the <tt class="docutils literal"><span class="pre">application_state</span></tt>. The returned data is the current users session id returned from the server and is used to identify the current user by the server. Don't worry to much about the <tt class="docutils literal"><span class="pre">api.on('gamer_joined',</span> <span class="pre">..)</span></tt> event handler as we will flesh it out more in the next exercise.</p>
<p>Let's look at the handlers for the <tt class="docutils literal"><span class="pre">register_button</span></tt> and the <tt class="docutils literal"><span class="pre">login_button</span></tt> buttons.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Handles the attempt to register a new user</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">register_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Lets get the values for the registration</span>
    <span class="kd">var</span> <span class="nx">full_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputFullNameRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputUserNameRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputPasswordRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>

    <span class="c1">// Attempt to register a new user</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Show the main dashboard view and render with all the available players</span>
      <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span> <span class="p">[]});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The first part of the method grabs the content of the three fields <tt class="docutils literal"><span class="pre">inputFullNameRegister</span></tt>, <tt class="docutils literal"><span class="pre">inputUserNameRegister</span></tt> and <tt class="docutils literal"><span class="pre">inputPasswordRegister</span></tt> then attempts to register the user using the <tt class="docutils literal"><span class="pre">api.register</span></tt> method. When the method returns the passed in callback function gets called with two parameters <tt class="docutils literal"><span class="pre">err</span></tt> and <tt class="docutils literal"><span class="pre">data</span></tt> (Standard Node.js callback). If the <tt class="docutils literal"><span class="pre">err</span></tt> parameter is not equal to <tt class="docutils literal"><span class="pre">null</span></tt> the <tt class="docutils literal"><span class="pre">register</span></tt> function failed and we use the method <tt class="docutils literal"><span class="pre">error_box_show</span></tt> to present the user with an error message dialog. Since all our error messages follow the same standard this makes it easy to create a more generalized error message box. If we have no errors the user was successfully created and logged in. We then set the HTML element to the <tt class="docutils literal"><span class="pre">dashboard.ms</span></tt> template and render it. That completes the registration process.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Handles the attempt to login</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">login_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Lets get the values for the login</span>
    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputUserNameLogin&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputPasswordLogin&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>

    <span class="c1">// Attempt to login the user</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Show the main dashboard view and render with all the available players</span>
      <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="p">[]});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The login code is very similar to the registration code, the difference being that we are calling the <tt class="docutils literal"><span class="pre">api.login</span></tt> function instead of the <tt class="docutils literal"><span class="pre">api.register</span></tt> function.</p>
<p>That the code for this exercise, lets fire up the server and play around with our application.</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">node app</span>
</pre></div>
</td></tr></table></div>
<p>Try out a couple of the scenarios below to test out the application and see how it works.</p>
<ol class="arabic simple">
<li>Attempt a login with non existing user.</li>
<li>Attempt to register a new user with the full name field empty.</li>
<li>Fill in all the fields correctly for a registered user.</li>
<li>Login in using a registered user.</li>
</ol>
<p>That finished step two in the tutorial. Join us for the next tutorial step where we implement the actual game play aspect of the application.</p>
</div>
<div class="section" id="notes">
<h2>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<p>This is a very simplified <tt class="docutils literal"><span class="pre">registration</span></tt> and <tt class="docutils literal"><span class="pre">login</span></tt> process. You might want to do things like extend the validations on the client and server side for password strength, and maybe add an email verification process to make sure the new player enters a valid email. This is left as an exercise for you to do.</p>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="tic3.html" title="Tic-Tac-Toe: Exercise 3"
             >next</a></li>
        <li class="right" >
          <a href="tic1.html" title="Tic-Tac-Toe: Exercise 1"
             >previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>
    <a name="comments"><hr/></a>

<div sytle="text-align: left">
    <div style="background: white; padding: 10px" id="disqus_thread"></div>
</div>
    <script type="text/javascript">
        var dow = new Date().getDay();

        if(dow == 5 || dow == 6) {
            $("#disqus_thread").html("<h1>Today Is Christians's Day Off</h1><p>I take Saturday and Sunday off.  Comments open again on Monday-Friday.</p>")
        } else {
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'learn-code-the-hard-way'; // required: replace example with your forum shortname


            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        }
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <div class="footer">
      &copy; Copyright 2012, Christian Amor Kvalheim.
      Last updated on Jan 31, 2013.
</div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24168052-9']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </body>
</html>