
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Exercise 6: Databases and Collections &mdash; Learn MongoDB And Node.js The Hard Way</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Learn MongoDB And Node.js The Hard Way" href="index.html" />
    <link rel="next" title="Exercise 7: Inserting documents" href="ex7.html" />
    <link rel="prev" title="Exercise 5: Document documents everywhere" href="ex5.html" /> 
  </head>
  <body>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="ex7.html" title="Exercise 7: Inserting documents"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="ex5.html" title="Exercise 5: Document documents everywhere"
             accesskey="P">previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>



    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="exercise-6-databases-and-collections">
<h1>Exercise 6: Databases and Collections<a class="headerlink" href="#exercise-6-databases-and-collections" title="Permalink to this headline">¶</a></h1>
<p>MongoDB has is build around 3 main concepts. One or more <tt class="docutils literal"><span class="pre">db's</span></tt> that contain one or more <tt class="docutils literal"><span class="pre">collections</span></tt> that contain one or more <tt class="docutils literal"><span class="pre">documents</span></tt>. So how do we get hold of a <tt class="docutils literal"><span class="pre">collection</span></tt>? Time for some code entry.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>    
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">myotherdb</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">&#39;myotherdb&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">admin</span><span class="p">();</span>
  
  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mydocuments&#39;</span><span class="p">);</span>
  
  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>The example shows how to use the <tt class="docutils literal"><span class="pre">MongoClient.connect</span></tt> method to fetch a connection to a database directly. The <tt class="docutils literal"><span class="pre">connect</span></tt> method actually returns a database object. If we want to use other databases we can call the <tt class="docutils literal"><span class="pre">.db()</span></tt> method on the <tt class="docutils literal"><span class="pre">db</span></tt> object returned by the <tt class="docutils literal"><span class="pre">MongoClient.connect</span></tt> method. Notice that we don't need a new callback, this is because the <tt class="docutils literal"><span class="pre">.db()</span></tt> method does not open a new connection but reuses the existing connections that was created during the <tt class="docutils literal"><span class="pre">MongoClient.connect</span></tt> call.</p>
<p>So what is the <tt class="docutils literal"><span class="pre">.admin()</span></tt> method. Some administrative commands must be run against a special database called <tt class="docutils literal"><span class="pre">admin</span></tt>. To make the it a little bit easier I created an <tt class="docutils literal"><span class="pre">.admin()</span></tt> method that returns an instance of the <tt class="docutils literal"><span class="pre">Admin</span></tt> class with helper methods to make it easier to use the administrative commands available.</p>
<p>The other main usage of the <tt class="docutils literal"><span class="pre">admin()</span></tt> database is for storing user credentials as a server level. Don't worry we will touch on this later as for now it's a more advanced topic than we need to be concerned about.</p>
<p>After having fetched the new dbs <tt class="docutils literal"><span class="pre">myotherdb</span></tt> and <tt class="docutils literal"><span class="pre">admin</span></tt> we want to grab some collections to do some work on. This is done by calling <tt class="docutils literal"><span class="pre">db.collection()</span></tt> that returns a <tt class="docutils literal"><span class="pre">Collection</span></tt> object helper methods to help us do work on the collection. The reason we don't need to use a callback function here is that <tt class="docutils literal"><span class="pre">.collection()</span></tt> does not actually call out to the database to create a collection. This happens automatically when we save the first document to MongoDB. MongoDB will create a default collection with the name we passed into the <tt class="docutils literal"><span class="pre">.collection()</span></tt> method and save the document to it.</p>
<div class="section" id="capped-collections">
<h2>Capped Collections<a class="headerlink" href="#capped-collections" title="Permalink to this headline">¶</a></h2>
<p>However this might not always be what we want. MongoDB has two types of collection types available. The first one we will refer to as the <tt class="docutils literal"><span class="pre">standard</span></tt> collection type and the second as the <tt class="docutils literal"><span class="pre">capped</span> <span class="pre">collection</span></tt> type. The <tt class="docutils literal"><span class="pre">capped</span> <span class="pre">collection</span></tt> type is quite a different beast from the <tt class="docutils literal"><span class="pre">standard</span></tt> collection type. It's of a fixed size (you have to specify the size of the intial collection in bytes) and you can set a max number of documents it can store. It's als a FIFO (First in first out) queue which means that when it reaches the end of the space it will wrap around. Other limitiations are that you cannot add fields to an existing document and you cannot delete them.</p>
<p>This might sound like a lot of limitiations but the FIFO property and the semantics of operations are actually really good if you want to limit the amount of data stored or don't care if data is overwritten after awhile.</p>
<p>So how do we create a <tt class="docutils literal"><span class="pre">capped</span> <span class="pre">collection</span></tt> instead of a <tt class="docutils literal"><span class="pre">standard</span></tt> collection ? Let's explore some code, typing it up in your editor.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;hello&#39;</span><span class="o">:</span> <span class="s1">&#39;world&#39;</span>
<span class="p">}</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>    
  <span class="p">}</span>

  <span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="s2">&quot;mycappedcollection&quot;</span><span class="p">,</span> 
    <span class="p">{</span> <span class="nx">capped</span><span class="o">:</span><span class="kc">true</span>
      <span class="p">,</span> <span class="nx">size</span><span class="o">:</span><span class="mi">100000</span>
      <span class="p">,</span> <span class="nx">max</span><span class="o">:</span> <span class="mi">100</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span> <span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>Notice the <tt class="docutils literal"><span class="pre">db.createCollection()</span></tt> method we are using. This is a method specifically made to allow us to create collections that are not <tt class="docutils literal"><span class="pre">standard</span></tt> collections. In this code example we are creating a <tt class="docutils literal"><span class="pre">capped</span> <span class="pre">collection</span></tt> with a size of <tt class="docutils literal"><span class="pre">100000</span></tt> bytes and holding a maximum of <tt class="docutils literal"><span class="pre">100</span></tt> documents before it starts overwritting them. The options we can pass in to the <tt class="docutils literal"><span class="pre">db.createCollection</span></tt> for a capped collection are.</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">capped</span></tt>: (true/false), specified that this is a capped (FIFO) collection</li>
<li><tt class="docutils literal"><span class="pre">size</span></tt>: (a number of bytes larger than 0), specifies the maximum size in bytes of the capped collection.</li>
<li><tt class="docutils literal"><span class="pre">max</span></tt>: (a number larger than 0), specifies the maximum number of documents that can be stored in the collection before the collection starts overwritten old documents.</li>
</ul>
</div>
<div class="section" id="time-to-live-collections-ttl">
<h2>Time to live collections (TTL)<a class="headerlink" href="#time-to-live-collections-ttl" title="Permalink to this headline">¶</a></h2>
<p>From MongoDB 2.2 onwards there is a new type of collection called a <tt class="docutils literal"><span class="pre">TTL</span></tt> collection. It's a bit of a misdemeaner to call it a type of collections as it's actually a <tt class="docutils literal"><span class="pre">standard</span></tt> collection with a special type to live <tt class="docutils literal"><span class="pre">index</span></tt> on a date fields that automatically removes documents that are older than the time specified for the <tt class="docutils literal"><span class="pre">TTL</span> <span class="pre">index</span></tt>. It's a very useful when want only to store data for a specified time period. Say we only want to keep 48 hours of log data in a collection. With <tt class="docutils literal"><span class="pre">TTL</span></tt> you can set the time of expiry to be 48 hours and documents will be removed when they are older than 48 hours. Code is a thousand words so fire up your editor and enter the code below.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;hello&#39;</span><span class="o">:</span> <span class="s1">&#39;world&#39;</span>
<span class="p">}</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>    
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;myttlcollection&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">fortyeighthours</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">48</span><span class="p">;</span>

  <span class="nx">collection</span><span class="p">.</span><span class="nx">ensureIndex</span><span class="p">(</span>
      <span class="p">{</span><span class="nx">created_on</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">expireAfterSeconds</span><span class="o">:</span> <span class="nx">fortyeighthours</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>Notice the <tt class="docutils literal"><span class="pre">collection.ensureIndex()</span></tt> method. We will go deeper into how indexes work and how the Node.js driver can create them in a later exercise. The point to notice here is that the <tt class="docutils literal"><span class="pre">TTL</span></tt> collection needs an index on a data field to work correctly and that the <tt class="docutils literal"><span class="pre">expireAfterSeconds</span></tt> parameter is in seconds.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">One particular note to be made about <tt class="docutils literal"><span class="pre">TTL</span></tt> collections is that the expiry time is not a hard expiry time. What's meant by hard. Well it means that even if a document is exactly 48 hours old it might not be removed at exactly 48 hours but some time after that when MongoDB has free resources to remove the document. Also due to the fact that <tt class="docutils literal"><span class="pre">TTL</span></tt> collections need to remove documents from a collection <tt class="docutils literal"><span class="pre">TTL</span></tt> does not work with <tt class="docutils literal"><span class="pre">capped</span> <span class="pre">collections</span></tt> so keep that in mind.</p>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="ex7.html" title="Exercise 7: Inserting documents"
             >next</a></li>
        <li class="right" >
          <a href="ex5.html" title="Exercise 5: Document documents everywhere"
             >previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>
    <a name="comments"><hr/></a>

<div sytle="text-align: left">
    <div style="background: white; padding: 10px" id="disqus_thread"></div>
</div>
    <script type="text/javascript">
        var dow = new Date().getDay();

        if(dow == 5 || dow == 6) {
            $("#disqus_thread").html("<h1>Today Is Christians's Day Off</h1><p>I take Saturday and Sunday off.  Comments open again on Monday-Friday.</p>")
        } else {
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'learn-code-the-hard-way'; // required: replace example with your forum shortname


            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        }
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <div class="footer">
      &copy; Copyright 2012, Christian Amor Kvalheim.
      Last updated on Jan 31, 2013.
</div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24168052-9']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </body>
</html>