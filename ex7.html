<!DOCTYPE html>

<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
    <!--[if gt IE 8]><!-->
<html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />

  <!-- Set the viewport width to device width for mobile -->
  <meta name="viewport" content="width=device-width" />

  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.9.1: http://docutils.sourceforge.net/" />
<title>Exercise 7: Inserting documents</title>

  <!-- Included CSS Files (Compressed) -->
  <link rel="stylesheet" href="stylesheets/foundation.min.css">
  <link rel="stylesheet" href="stylesheets/pygments.css">
  <link rel="stylesheet" href="stylesheets/app.css">

  <script src="javascripts/modernizr.foundation.js"></script>

  <!-- IE Fix for HTML5 Tags -->
  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

</head>
<body>

  <div class="row">
          <h1 class="title">Exercise 7: Inserting documents</h1>
      </div>
  </div>

  <div class="row">
    <div class="eleven columns">
        <p>The first and most important feature of a database is to be able to store data in it. Let's get cracking on inserting documents into MongoDB. There are 3 main things you need to know about inserting documents in MongoDB using the Node.js driver. These are single inserts, bulk inserts and write concerns. Before hitting the details let's do a single document insert to get us moving and explain the basic concept. Fire up your text editor and enter the following code.</p>
<div class="highlight"><pre><a name="code--ex7--ex1.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex7--ex1.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex7--ex1.js-pyg.html-3"></a>
<a name="code--ex7--ex1.js-pyg.html-4"></a><span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex7--ex1.js-pyg.html-5"></a>  <span class="s1">&#39;hello&#39;</span><span class="o">:</span> <span class="s1">&#39;world&#39;</span>
<a name="code--ex7--ex1.js-pyg.html-6"></a><span class="p">}</span>
<a name="code--ex7--ex1.js-pyg.html-7"></a>
<a name="code--ex7--ex1.js-pyg.html-8"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex1.js-pyg.html-9"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex1.js-pyg.html-10"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex1.js-pyg.html-11"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex7--ex1.js-pyg.html-12"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex1.js-pyg.html-13"></a>  <span class="p">}</span>
<a name="code--ex7--ex1.js-pyg.html-14"></a>
<a name="code--ex7--ex1.js-pyg.html-15"></a>  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mydocuments&#39;</span><span class="p">);</span>
<a name="code--ex7--ex1.js-pyg.html-16"></a>
<a name="code--ex7--ex1.js-pyg.html-17"></a>  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span><span class="mi">0</span><span class="p">});</span>
<a name="code--ex7--ex1.js-pyg.html-18"></a>
<a name="code--ex7--ex1.js-pyg.html-19"></a>  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex7--ex1.js-pyg.html-20"></a><span class="p">});</span>
</pre></div><p>Let's digest the code example. The first thing we notice after connecting to the database is that we create a document containing <tt class="docutils literal">'hello': 'world'</tt>. After that we grab the collection <tt class="docutils literal">mydocuments</tt> and we call the method on the collection called <tt class="docutils literal">.insert()</tt>. The first parameter is the document we wish to store and the second is an object with the parameter <tt class="docutils literal">w</tt> set to 0. Notice that we have not provided any callback function. We will touch on the concept of <tt class="docutils literal">write concerns</tt> a bit down the line. Sufficient for now is to know that if we set <tt class="docutils literal">w:0</tt> we are not asking MongoDB to acknowledge that the write was correctly recieved by the database server. Rather it's a <tt class="docutils literal">fire and forget</tt> write of the document to MongoDB.</p>
<p>What happens under the cover is that the driver takes your document and converts it into a <tt class="docutils literal">BSON</tt> document that is then sent over the socket to MongoDB. Let's boot up the MongoDB console and verify that the document made it to the console (we are assuming you have the executable <tt class="docutils literal">mongodb</tt> in your path for your terminal/shell/windows prompt).</p>
<pre class="code console literal-block">
<span class="go">~ $ mongo
MongoDB shell version: 2.2
connecting to: test
</span><span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test
</span><span class="gp">&gt;</span> show collections
<span class="go">mydocuments
system.indexes
</span><span class="gp">&gt;</span> db.mydocuments.findOne<span class="o">()</span>
<span class="go">{ &quot;hello&quot; : &quot;world&quot;, &quot;_id&quot; : ObjectId(&quot;50c5f63780ebe8585f000001&quot;) }</span>
</pre>
<p>Notice that our document is correctly stored in our <tt class="docutils literal">test</tt> database. But also notice that we have an additional field called <tt class="docutils literal">_id</tt> that seems to be of a type known as <tt class="docutils literal">ObjectId</tt>. The first thing to understand is that all documents in a collection in MongoDB has what is termed a <tt class="docutils literal">primary key</tt> called <tt class="docutils literal">_id</tt>. A <tt class="docutils literal">primary key</tt> is a unqiue identifier for that specific document that is unique for the whole collection. There is a guarante from MongoDB's side that there cannot be more than one document using a specific <tt class="docutils literal">ObjectId</tt> for the field <tt class="docutils literal">_id</tt> in a collection. You can use the same <tt class="docutils literal">ObjectId</tt> in other collections of course or in other field names. The driver actually generates these for you when you insert if they don't exist from before. Also notice that the number inside the <tt class="docutils literal"><span class="pre">ObjectId(...)</span></tt> will vary on your computer in comparision to the example as it's a generated value.</p>
<p>But you can also override the <tt class="docutils literal">_id</tt> field yourself and set it to application generated id. This might be useful if you are generating your own globally unique numbers for example. Let's do this and also see what happens if we try to insert the same document with the same id twice. Enter the following code in your editor.</p>
<div class="highlight"><pre><a name="code--ex7--ex2.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex7--ex2.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex7--ex2.js-pyg.html-3"></a>
<a name="code--ex7--ex2.js-pyg.html-4"></a><span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex7--ex2.js-pyg.html-5"></a>    <span class="s1">&#39;_id&#39;</span><span class="o">:</span> <span class="mi">1</span>
<a name="code--ex7--ex2.js-pyg.html-6"></a>  <span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="o">:</span> <span class="s1">&#39;world&#39;</span>
<a name="code--ex7--ex2.js-pyg.html-7"></a><span class="p">}</span>
<a name="code--ex7--ex2.js-pyg.html-8"></a>
<a name="code--ex7--ex2.js-pyg.html-9"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex2.js-pyg.html-10"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex2.js-pyg.html-11"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex2.js-pyg.html-12"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex7--ex2.js-pyg.html-13"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex2.js-pyg.html-14"></a>  <span class="p">}</span>
<a name="code--ex7--ex2.js-pyg.html-15"></a>
<a name="code--ex7--ex2.js-pyg.html-16"></a>  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mydocuments&#39;</span><span class="p">);</span>
<a name="code--ex7--ex2.js-pyg.html-17"></a>
<a name="code--ex7--ex2.js-pyg.html-18"></a>  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex2.js-pyg.html-19"></a>
<a name="code--ex7--ex2.js-pyg.html-20"></a>    <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex2.js-pyg.html-21"></a>
<a name="code--ex7--ex2.js-pyg.html-22"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex2.js-pyg.html-23"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;document with _id already exists&quot;</span><span class="p">);</span>
<a name="code--ex7--ex2.js-pyg.html-24"></a>      <span class="p">}</span>
<a name="code--ex7--ex2.js-pyg.html-25"></a>
<a name="code--ex7--ex2.js-pyg.html-26"></a>      <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex7--ex2.js-pyg.html-27"></a>    <span class="p">});</span>
<a name="code--ex7--ex2.js-pyg.html-28"></a>  <span class="p">});</span>
<a name="code--ex7--ex2.js-pyg.html-29"></a><span class="p">});</span>
</pre></div><p>When you run this you should see the following output</p>
<pre class="code console literal-block">
<span class="go">connected to database
document with _id already exists</span>
</pre>
<p>Let's check what's in the database after we ran our script.</p>
<pre class="code console literal-block">
<span class="go">~ $ mongo
MongoDB shell version: 2.2
connecting to: test
</span><span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test
</span><span class="gp">&gt;</span> show collections
<span class="go">mydocuments
system.indexes
</span><span class="gp">&gt;</span> db.mydocuments.find<span class="o">()</span>.pretty<span class="o">()</span>
<span class="go">{ &quot;hello&quot; : &quot;world&quot;, &quot;_id&quot; : ObjectId(&quot;50c5f63780ebe8585f000001&quot;) }
{ &quot;_id&quot; : 1, &quot;hello&quot; : &quot;world&quot; }</span>
</pre>
<p>So what happened here. The first insert command worked as expected and our document was saved in the database with the <tt class="docutils literal">_id</tt> set to <tt class="docutils literal">1</tt> as we expected. When the second insert was tried however it failed and we got the message that the document with that <tt class="docutils literal">_id</tt> already exists. Since <tt class="docutils literal">_id</tt> needs to be unique that is as expected.</p>
<p>One thing to remember is that the <tt class="docutils literal">_id</tt> can be any <tt class="docutils literal">BSON</tt> type including a binary which is used to for example use global unique identifiers called <tt class="docutils literal">UUID's</tt> (read more at <a class="reference external" href="http://en.wikipedia.org/wiki/Universally_unique_identifier">http://en.wikipedia.org/wiki/Universally_unique_identifier</a> about UUID). This can be quite useful as we mentioned above for some specific scenarios. But for this book we will stick to the plain vanilla <tt class="docutils literal">ObjectId</tt> or <tt class="docutils literal">ObjectID</tt> as its nown in the Node.js driver.</p>
<div class="section" id="bulk-inserts">
<h1>Bulk Inserts</h1>
<p>So this is quite good, we can easily insert a document. So what if we want to insert 100 documents. The first thought might be something like the code below. Enter it an run it.</p>
<div class="highlight"><pre><a name="code--ex7--ex3.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex7--ex3.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex7--ex3.js-pyg.html-3"></a>
<a name="code--ex7--ex3.js-pyg.html-4"></a><span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex7--ex3.js-pyg.html-5"></a>    <span class="s1">&#39;_id&#39;</span><span class="o">:</span> <span class="mi">1</span>
<a name="code--ex7--ex3.js-pyg.html-6"></a>  <span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="o">:</span> <span class="s1">&#39;world&#39;</span>
<a name="code--ex7--ex3.js-pyg.html-7"></a><span class="p">}</span>
<a name="code--ex7--ex3.js-pyg.html-8"></a>
<a name="code--ex7--ex3.js-pyg.html-9"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex3.js-pyg.html-10"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex3.js-pyg.html-11"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex3.js-pyg.html-12"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex7--ex3.js-pyg.html-13"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex3.js-pyg.html-14"></a>  <span class="p">}</span>
<a name="code--ex7--ex3.js-pyg.html-15"></a>
<a name="code--ex7--ex3.js-pyg.html-16"></a>  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mycountingdocuments&#39;</span><span class="p">);</span>
<a name="code--ex7--ex3.js-pyg.html-17"></a>  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<a name="code--ex7--ex3.js-pyg.html-18"></a>
<a name="code--ex7--ex3.js-pyg.html-19"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex3.js-pyg.html-20"></a>    <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">i</span><span class="o">:</span><span class="nx">i</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex3.js-pyg.html-21"></a>      <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="code--ex7--ex3.js-pyg.html-22"></a>
<a name="code--ex7--ex3.js-pyg.html-23"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex3.js-pyg.html-24"></a>        <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex7--ex3.js-pyg.html-25"></a>      <span class="p">}</span>
<a name="code--ex7--ex3.js-pyg.html-26"></a>    <span class="p">});</span>
<a name="code--ex7--ex3.js-pyg.html-27"></a>  <span class="p">}</span>
<a name="code--ex7--ex3.js-pyg.html-28"></a><span class="p">});</span>
</pre></div><p>Let's check that the documents made it to the database. Notice that we changed the name of the collection.</p>
<pre class="code console literal-block">
<span class="go">~ $ mongo
MongoDB shell version: 2.2
connecting to: test
</span><span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test
</span><span class="gp">&gt;</span> show collections
<span class="go">mycountingdocuments
mydocuments
system.indexes
</span><span class="gp">&gt;</span> db.mycountingdocuments.find<span class="o">()</span>.pretty<span class="o">()</span>
<span class="go">{ &quot;i&quot; : 0, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000001&quot;) }
{ &quot;i&quot; : 1, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000002&quot;) }
{ &quot;i&quot; : 5, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000006&quot;) }
{ &quot;i&quot; : 3, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000004&quot;) }
{ &quot;i&quot; : 4, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000005&quot;) }
{ &quot;i&quot; : 2, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000003&quot;) }
{ &quot;i&quot; : 9, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000a&quot;) }
{ &quot;i&quot; : 8, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000009&quot;) }
{ &quot;i&quot; : 6, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000007&quot;) }
{ &quot;i&quot; : 7, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000008&quot;) }
{ &quot;i&quot; : 10, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000b&quot;) }
{ &quot;i&quot; : 11, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000c&quot;) }
{ &quot;i&quot; : 12, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000d&quot;) }
{ &quot;i&quot; : 13, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000e&quot;) }
{ &quot;i&quot; : 14, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000f&quot;) }
{ &quot;i&quot; : 15, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000010&quot;) }
{ &quot;i&quot; : 16, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000011&quot;) }
{ &quot;i&quot; : 17, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000012&quot;) }
{ &quot;i&quot; : 18, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000013&quot;) }
{ &quot;i&quot; : 19, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000014&quot;) }
Type &quot;it&quot; for more
</span><span class="gp">&gt;</span> db.mycountingdocuments.count<span class="o">()</span>
<span class="go">100</span>
</pre>
<p>As you can see we have inserted 100 documents into the database as expected. But surely there must be a better way to bulk insert documents than issuing 100 seperate insert commands. Luckily there is. MongoDB support bulk inserts. In fact the bulk insert command sent to the server is a single message. There is a limit on how much data you can send in a single bulk insert. For now the drivers enforce a 16MB limit. With this information let's rewrite the example to do the insert as a bulk insert.</p>
<div class="highlight"><pre><a name="code--ex7--ex4.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex7--ex4.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex7--ex4.js-pyg.html-3"></a>
<a name="code--ex7--ex4.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex4.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex4.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex4.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex7--ex4.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex4.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex7--ex4.js-pyg.html-10"></a>
<a name="code--ex7--ex4.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mycountingdocuments&#39;</span><span class="p">);</span>
<a name="code--ex7--ex4.js-pyg.html-12"></a>  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<a name="code--ex7--ex4.js-pyg.html-13"></a>  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--ex7--ex4.js-pyg.html-14"></a>
<a name="code--ex7--ex4.js-pyg.html-15"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex4.js-pyg.html-16"></a>    <span class="nx">documents</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">i</span><span class="o">:</span><span class="nx">i</span><span class="p">});</span>
<a name="code--ex7--ex4.js-pyg.html-17"></a>  <span class="p">}</span>
<a name="code--ex7--ex4.js-pyg.html-18"></a>
<a name="code--ex7--ex4.js-pyg.html-19"></a>  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex4.js-pyg.html-20"></a>
<a name="code--ex7--ex4.js-pyg.html-21"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex7--ex4.js-pyg.html-22"></a>  <span class="p">});</span>
<a name="code--ex7--ex4.js-pyg.html-23"></a><span class="p">});</span>
</pre></div><p>Before running the code let's cleanup the collection to ensure we don't have any existing documents in the collection. Fire up the console and do the following to remove all the documents.</p>
<pre class="code console literal-block">
<span class="go">~ $ mongo
MongoDB shell version: 2.2
connecting to: test
</span><span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test
</span><span class="gp">&gt;</span> show collections
<span class="go">mycountingdocuments
mydocuments
system.indexes
</span><span class="gp">&gt;</span> db.mycountingdocuments.remove<span class="o">()</span>
<span class="gp">&gt;</span> db.mycountingdocuments.count<span class="o">()</span>
<span class="go">0</span>
</pre>
<p>Run the example above and verify that all the documents made it to the collection on MongoDB.</p>
<pre class="code console literal-block">
<span class="go">~ $ mongo
MongoDB shell version: 2.2
connecting to: test
</span><span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test
</span><span class="gp">&gt;</span> show collections
<span class="go">mycountingdocuments
mydocuments
system.indexes
</span><span class="gp">&gt;</span> db.mycountingdocuments.find<span class="o">()</span>.pretty<span class="o">()</span>
<span class="go">{ &quot;i&quot; : 0, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000001&quot;) }
{ &quot;i&quot; : 1, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000002&quot;) }
{ &quot;i&quot; : 5, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000006&quot;) }
{ &quot;i&quot; : 3, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000004&quot;) }
{ &quot;i&quot; : 4, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000005&quot;) }
{ &quot;i&quot; : 2, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000003&quot;) }
{ &quot;i&quot; : 9, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000a&quot;) }
{ &quot;i&quot; : 8, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000009&quot;) }
{ &quot;i&quot; : 6, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000007&quot;) }
{ &quot;i&quot; : 7, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000008&quot;) }
{ &quot;i&quot; : 10, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000b&quot;) }
{ &quot;i&quot; : 11, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000c&quot;) }
{ &quot;i&quot; : 12, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000d&quot;) }
{ &quot;i&quot; : 13, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000e&quot;) }
{ &quot;i&quot; : 14, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000f&quot;) }
{ &quot;i&quot; : 15, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000010&quot;) }
{ &quot;i&quot; : 16, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000011&quot;) }
{ &quot;i&quot; : 17, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000012&quot;) }
{ &quot;i&quot; : 18, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000013&quot;) }
{ &quot;i&quot; : 19, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000014&quot;) }
Type &quot;it&quot; for more
</span><span class="gp">&gt;</span> db.mycountingdocuments.count<span class="o">()</span>
<span class="go">100</span>
</pre>
<p>Awesome not hard right. Well what happens if there is a document with an error inbetween the <tt class="docutils literal">100</tt> documents we plan to insert. Well let's try it and see what happens. Enter the example below. Before running it clear out the collection as previously shown. When you run it you should see the following output.</p>
<pre class="code console literal-block">
<span class="go">connected to database
failed to perform bulk insert due to multiple documents havin the same _id field</span>
</pre>
<div class="highlight"><pre><a name="code--ex7--ex5.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex7--ex5.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex7--ex5.js-pyg.html-3"></a>
<a name="code--ex7--ex5.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex5.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex5.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex5.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex7--ex5.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex5.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex7--ex5.js-pyg.html-10"></a>
<a name="code--ex7--ex5.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mycountingdocuments&#39;</span><span class="p">);</span>
<a name="code--ex7--ex5.js-pyg.html-12"></a>  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[</span>
<a name="code--ex7--ex5.js-pyg.html-13"></a>      <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1000</span><span class="p">}</span>
<a name="code--ex7--ex5.js-pyg.html-14"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1001</span><span class="p">}</span>
<a name="code--ex7--ex5.js-pyg.html-15"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1000</span><span class="p">}</span>
<a name="code--ex7--ex5.js-pyg.html-16"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1002</span><span class="p">}</span>
<a name="code--ex7--ex5.js-pyg.html-17"></a>  <span class="p">];</span>
<a name="code--ex7--ex5.js-pyg.html-18"></a>
<a name="code--ex7--ex5.js-pyg.html-19"></a>  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex5.js-pyg.html-20"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex5.js-pyg.html-21"></a>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to perform bulk insert due to duplicate _id field&quot;</span><span class="p">)</span>
<a name="code--ex7--ex5.js-pyg.html-22"></a>    <span class="p">}</span>
<a name="code--ex7--ex5.js-pyg.html-23"></a>
<a name="code--ex7--ex5.js-pyg.html-24"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex7--ex5.js-pyg.html-25"></a>  <span class="p">});</span>
<a name="code--ex7--ex5.js-pyg.html-26"></a><span class="p">});</span>
</pre></div><p>Ok we got an error from MongoDB but what happened in the database. Did it finish inserting the documents or did it stop. Let's have a look in the db.</p>
<pre class="code console literal-block">
<span class="go">~ $ mongo
MongoDB shell version: 2.2
connecting to: test
</span><span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test
</span><span class="gp">&gt;</span> show collections
<span class="go">mycountingdocuments
mydocuments
system.indexes
</span><span class="gp">&gt;</span> db.mycountingdocuments.find<span class="o">()</span>.pretty<span class="o">()</span>
<span class="go">{ &quot;_id&quot; : 1000 }
{ &quot;_id&quot; : 1001 }</span>
</pre>
<p>As we can see MongoDB kept accepting the documents until we hit the document with the duplicate <tt class="docutils literal">_id</tt> value and then stopped and returned an error. But what if we want to make the inserts continue even if there is an error. Well it's also possible. Clear out the db, enter the code below and run it.</p>
<div class="highlight"><pre><a name="code--ex7--ex6.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex7--ex6.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex7--ex6.js-pyg.html-3"></a>
<a name="code--ex7--ex6.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex6.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex6.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex6.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex7--ex6.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex6.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex7--ex6.js-pyg.html-10"></a>
<a name="code--ex7--ex6.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mycountingdocuments&#39;</span><span class="p">);</span>
<a name="code--ex7--ex6.js-pyg.html-12"></a>  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[</span>
<a name="code--ex7--ex6.js-pyg.html-13"></a>      <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1000</span><span class="p">}</span>
<a name="code--ex7--ex6.js-pyg.html-14"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1001</span><span class="p">}</span>
<a name="code--ex7--ex6.js-pyg.html-15"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1000</span><span class="p">}</span>
<a name="code--ex7--ex6.js-pyg.html-16"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1002</span><span class="p">}</span>
<a name="code--ex7--ex6.js-pyg.html-17"></a>  <span class="p">];</span>
<a name="code--ex7--ex6.js-pyg.html-18"></a>
<a name="code--ex7--ex6.js-pyg.html-19"></a>  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="p">{</span><span class="nx">continueOnError</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex6.js-pyg.html-20"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex6.js-pyg.html-21"></a>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to perform bulk insert due to duplicate _id field&quot;</span><span class="p">)</span>
<a name="code--ex7--ex6.js-pyg.html-22"></a>    <span class="p">}</span>
<a name="code--ex7--ex6.js-pyg.html-23"></a>
<a name="code--ex7--ex6.js-pyg.html-24"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex7--ex6.js-pyg.html-25"></a>  <span class="p">});</span>
<a name="code--ex7--ex6.js-pyg.html-26"></a><span class="p">});</span>
</pre></div><p>Notice that we get the same ouput as the following example but let's have a look at what's in MongoDB now.</p>
<pre class="code console literal-block">
<span class="go">~ $ mongo
MongoDB shell version: 2.2
connecting to: test
</span><span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test
</span><span class="gp">&gt;</span> show collections
<span class="go">mycountingdocuments
mydocuments
system.indexes
</span><span class="gp">&gt;</span> db.mycountingdocuments.find<span class="o">()</span>.pretty<span class="o">()</span>
<span class="go">{ &quot;_id&quot; : 1000 }
{ &quot;_id&quot; : 1001 }
{ &quot;_id&quot; : 1002 }</span>
</pre>
<p>As we can see MongoDB did not stop inserting on the error but kept going inserting all the valid documents it could find. However one problem is that MongoDB is not currently able to tell us what specific document failed to insert so we need to programatically in our code. Let's see how we can identify what documents had the same <tt class="docutils literal">_id</tt> variable below. Clean out the collection, then enter and run the code below.</p>
<div class="highlight"><pre><a name="code--ex7--ex7.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
<a name="code--ex7--ex7.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>
<a name="code--ex7--ex7.js-pyg.html-3"></a>
<a name="code--ex7--ex7.js-pyg.html-4"></a><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-6"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex7.js-pyg.html-7"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-8"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>
<a name="code--ex7--ex7.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-10"></a>
<a name="code--ex7--ex7.js-pyg.html-11"></a>  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mycountingdocuments&#39;</span><span class="p">);</span>
<a name="code--ex7--ex7.js-pyg.html-12"></a>  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<a name="code--ex7--ex7.js-pyg.html-13"></a>  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[</span>
<a name="code--ex7--ex7.js-pyg.html-14"></a>      <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1000</span><span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-15"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1001</span><span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-16"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1000</span><span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-17"></a>    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1002</span><span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-18"></a>  <span class="p">];</span>
<a name="code--ex7--ex7.js-pyg.html-19"></a>
<a name="code--ex7--ex7.js-pyg.html-20"></a>  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="p">{</span><span class="nx">continueOnError</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-21"></a>
<a name="code--ex7--ex7.js-pyg.html-22"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-23"></a>      <span class="kd">var</span> <span class="nx">ids</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--ex7--ex7.js-pyg.html-24"></a>      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">documents</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-25"></a>        <span class="nx">ids</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">documents</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">);</span>
<a name="code--ex7--ex7.js-pyg.html-26"></a>      <span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-27"></a>
<a name="code--ex7--ex7.js-pyg.html-28"></a>      <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="p">{</span><span class="nx">$in</span><span class="o">:</span> <span class="nx">ids</span><span class="p">}},</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">}).</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-29"></a>        <span class="kd">var</span> <span class="nx">docHash</span> <span class="o">=</span> <span class="p">{};</span>
<a name="code--ex7--ex7.js-pyg.html-30"></a>        <span class="kd">var</span> <span class="nx">docsNotFound</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--ex7--ex7.js-pyg.html-31"></a>
<a name="code--ex7--ex7.js-pyg.html-32"></a>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">docs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-33"></a>          <span class="nx">docHash</span><span class="p">[</span><span class="nx">docs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--ex7--ex7.js-pyg.html-34"></a>        <span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-35"></a>
<a name="code--ex7--ex7.js-pyg.html-36"></a>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">documents</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-37"></a>          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">docHash</span><span class="p">[</span><span class="nx">documents</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">])</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-38"></a>            <span class="nx">docsNotFound</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
<a name="code--ex7--ex7.js-pyg.html-39"></a>          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--ex7--ex7.js-pyg.html-40"></a>            <span class="nx">docHash</span><span class="p">[</span><span class="nx">documents</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<a name="code--ex7--ex7.js-pyg.html-41"></a>          <span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-42"></a>        <span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-43"></a>
<a name="code--ex7--ex7.js-pyg.html-44"></a>        <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">docsNotFound</span><span class="p">);</span>
<a name="code--ex7--ex7.js-pyg.html-45"></a>      <span class="p">});</span>
<a name="code--ex7--ex7.js-pyg.html-46"></a>    <span class="p">}</span>
<a name="code--ex7--ex7.js-pyg.html-47"></a>
<a name="code--ex7--ex7.js-pyg.html-48"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--ex7--ex7.js-pyg.html-49"></a>  <span class="p">});</span>
<a name="code--ex7--ex7.js-pyg.html-50"></a><span class="p">});</span>
</pre></div><p>This code is a bit complicated but the basic explanation is that after we try to do the bulk insert and it fails we retrieve all documents which has a <tt class="docutils literal">_id</tt> value equal to the documents we were trying to insert. We then create a hashmap of the <tt class="docutils literal">_id</tt> where each value is set to true. Iterating through our original documents if we find it in the hashmap we set the hashmap value to false indicating it's been seen by the application. Any other document in the <tt class="docutils literal">documents</tt> array will then trigger the condition <tt class="docutils literal"><span class="pre">!docHash[documents[i]._id]</span></tt> that will save the index in the <tt class="docutils literal">documents</tt> array to the <tt class="docutils literal">docsNotFound</tt> array. The <tt class="docutils literal">docsNotFound</tt> array will contain all the indexes of the documents that failed to insert during the bulk insert.</p>
<p>You might wonder what the <tt class="docutils literal">$in</tt> means and we will get into that in a later exercise. Sufficient to say for now that it's a asking MongoDB to return all documents where <tt class="docutils literal">_id</tt> is in the list of <tt class="docutils literal">_id's</tt> in the <tt class="docutils literal">ids</tt> array.</p>
<p>One thing to note is that you might get a duplicate key error on another field in your document, how to resolve this issue I leave as an exercise for you to figure out.</p>
</div>
<div class="section" id="save">
<h1>Save</h1>
<p>If you've looked at the documentation for the driver you might have noticed there is a <tt class="docutils literal">save</tt> function on the <tt class="docutils literal">collection</tt> object. From the beginning this might look like a resonable method to use to save your document. If this document already exists (it matches it by the <tt class="docutils literal">_id</tt>) it will replace the entire document. We will go through why this is non optimial later when we talk about updates but I'll give you a hint. Why replace the whole document if you only want to change a single field ? There are some other side effects of full document replacement that we will highlight later.</p>
<p>But for now let's move on to the next exercise which is about one of the most interesting features of MongoDB the ability to specify the durability concern for your application.</p>
</div>
    </div>

    <div class="one columns" id="right-nav">
        <center>
        <p><a href="/book/"><img src="images/48_structure.png"></a></p>
        <p><a href="#"><img src="images/48_email.png"></a></p>
        <p><a href="#faq"><img src="images/48_faq.png"></a></p>
        <p>
        </p>
        </center>
    </div>

  <!-- Included JS Files (Compressed) -->
  <script src="javascripts/jquery.js"></script>
  <script src="javascripts/foundation.min.js"></script>
  
  <!-- Initialize JS Plugins -->
  <script src="javascripts/app.js"></script>

</body>
</html>