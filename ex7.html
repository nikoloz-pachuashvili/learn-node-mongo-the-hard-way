
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Exercise 7: Inserting documents &mdash; Learn MongoDB And Node.js The Hard Way</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Learn MongoDB And Node.js The Hard Way" href="index.html" />
    <link rel="next" title="Exercise 8: Write Concerns" href="ex8.html" />
    <link rel="prev" title="Exercise 6: Databases and Collections" href="ex6.html" /> 
  </head>
  <body>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="ex8.html" title="Exercise 8: Write Concerns"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="ex6.html" title="Exercise 6: Databases and Collections"
             accesskey="P">previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>



    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="exercise-7-inserting-documents">
<h1>Exercise 7: Inserting documents<a class="headerlink" href="#exercise-7-inserting-documents" title="Permalink to this headline">Â¶</a></h1>
<p>The first and most important feature of a database is to be able to store data in it. Let's get cracking on inserting documents into MongoDB. There are 3 main things you need to know about inserting documents in MongoDB using the Node.js driver. These are single inserts, bulk inserts and write concerns. Before hitting the details let's do a single document insert to get us moving and explain the basic concept. Fire up your text editor and enter the following code.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;hello&#39;</span><span class="o">:</span> <span class="s1">&#39;world&#39;</span>
<span class="p">}</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>    
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mydocuments&#39;</span><span class="p">);</span>
  
  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span><span class="mi">0</span><span class="p">});</span>
  
  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>Let's digest the code example. The first thing we notice after connecting to the database is that we create a document containing <tt class="docutils literal"><span class="pre">'hello':</span> <span class="pre">'world'</span></tt>. After that we grab the collection <tt class="docutils literal"><span class="pre">mydocuments</span></tt> and we call the method on the collection called <tt class="docutils literal"><span class="pre">.insert()</span></tt>. The first parameter is the document we wish to store and the second is an object with the parameter <tt class="docutils literal"><span class="pre">w</span></tt> set to 0. Notice that we have not provided any callback function. We will touch on the concept of <tt class="docutils literal"><span class="pre">write</span> <span class="pre">concerns</span></tt> a bit down the line. Sufficient for now is to know that if we set <tt class="docutils literal"><span class="pre">w:0</span></tt> we are not asking MongoDB to acknowledge that the write was correctly recieved by the database server. Rather it's a <tt class="docutils literal"><span class="pre">fire</span> <span class="pre">and</span> <span class="pre">forget</span></tt> write of the document to MongoDB.</p>
<p>What happens under the cover is that the driver takes your document and converts it into a <tt class="docutils literal"><span class="pre">BSON</span></tt> document that is then sent over the socket to MongoDB. Let's boot up the MongoDB console and verify that the document made it to the console (we are assuming you have the executable <tt class="docutils literal"><span class="pre">mongodb</span></tt> in your path for your terminal/shell/windows prompt).</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">~ $ mongo</span>
<span class="go">MongoDB shell version: 2.2</span>
<span class="go">connecting to: test</span>
<span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test</span>
<span class="gp">&gt;</span> show collections
<span class="go">mydocuments</span>
<span class="go">system.indexes</span>
<span class="gp">&gt;</span> db.mydocuments.findOne<span class="o">()</span>
<span class="go">{ &quot;hello&quot; : &quot;world&quot;, &quot;_id&quot; : ObjectId(&quot;50c5f63780ebe8585f000001&quot;) }</span>
</pre></div>
</div>
<p>Notice that our document is correctly stored in our <tt class="docutils literal"><span class="pre">test</span></tt> database. But also notice that we have an additional field called <tt class="docutils literal"><span class="pre">_id</span></tt> that seems to be of a type known as <tt class="docutils literal"><span class="pre">ObjectId</span></tt>. The first thing to understand is that all documents in a collection in MongoDB has what is termed a <tt class="docutils literal"><span class="pre">primary</span> <span class="pre">key</span></tt> called <tt class="docutils literal"><span class="pre">_id</span></tt>. A <tt class="docutils literal"><span class="pre">primary</span> <span class="pre">key</span></tt> is a unqiue identifier for that specific document that is unique for the whole collection. There is a guarante from MongoDB's side that there cannot be more than one document using a specific <tt class="docutils literal"><span class="pre">ObjectId</span></tt> for the field <tt class="docutils literal"><span class="pre">_id</span></tt> in a collection. You can use the same <tt class="docutils literal"><span class="pre">ObjectId</span></tt> in other collections of course or in other field names. The driver actually generates these for you when you insert if they don't exist from before. Also notice that the number inside the <tt class="docutils literal"><span class="pre">ObjectId(...)</span></tt> will vary on your computer in comparision to the example as it's a generated value.</p>
<p>But you can also override the <tt class="docutils literal"><span class="pre">_id</span></tt> field yourself and set it to application generated id. This might be useful if you are generating your own globally unique numbers for example. Let's do this and also see what happens if we try to insert the same document with the same id twice. Enter the following code in your editor.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;_id&#39;</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="o">:</span> <span class="s1">&#39;world&#39;</span>
<span class="p">}</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>    
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mydocuments&#39;</span><span class="p">);</span>
  
  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;document with _id already exists&quot;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>  
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>When you run this you should see the following output</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">connected to database</span>
<span class="go">document with _id already exists</span>
</pre></div>
</div>
<p>Let's check what's in the database after we ran our script.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">~ $ mongo</span>
<span class="go">MongoDB shell version: 2.2</span>
<span class="go">connecting to: test</span>
<span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test</span>
<span class="gp">&gt;</span> show collections
<span class="go">mydocuments</span>
<span class="go">system.indexes</span>
<span class="gp">&gt;</span> db.mydocuments.find<span class="o">()</span>.pretty<span class="o">()</span>
<span class="go">{ &quot;hello&quot; : &quot;world&quot;, &quot;_id&quot; : ObjectId(&quot;50c5f63780ebe8585f000001&quot;) }</span>
<span class="go">{ &quot;_id&quot; : 1, &quot;hello&quot; : &quot;world&quot; }</span>
</pre></div>
</div>
<p>So what happened here. The first insert command worked as expected and our document was saved in the database with the <tt class="docutils literal"><span class="pre">_id</span></tt> set to <tt class="docutils literal"><span class="pre">1</span></tt> as we expected. When the second insert was tried however it failed and we got the message that the document with that <tt class="docutils literal"><span class="pre">_id</span></tt> already exists. Since <tt class="docutils literal"><span class="pre">_id</span></tt> needs to be unique that is as expected.</p>
<p>One thing to remember is that the <tt class="docutils literal"><span class="pre">_id</span></tt> can be any <tt class="docutils literal"><span class="pre">BSON</span></tt> type including a binary which is used to for example use global unique identifiers called <tt class="docutils literal"><span class="pre">UUID's</span></tt> (read more at <a class="reference external" href="http://en.wikipedia.org/wiki/Universally_unique_identifier">http://en.wikipedia.org/wiki/Universally_unique_identifier</a> about UUID). This can be quite useful as we mentioned above for some specific scenarios. But for this book we will stick to the plain vanilla <tt class="docutils literal"><span class="pre">ObjectId</span></tt> or <tt class="docutils literal"><span class="pre">ObjectID</span></tt> as its nown in the Node.js driver.</p>
<div class="section" id="bulk-inserts">
<h2>Bulk Inserts<a class="headerlink" href="#bulk-inserts" title="Permalink to this headline">Â¶</a></h2>
<p>So this is quite good, we can easily insert a document. So what if we want to insert 100 documents. The first thought might be something like the code below. Enter it an run it.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;_id&#39;</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="o">:</span> <span class="s1">&#39;world&#39;</span>
<span class="p">}</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>    
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mycountingdocuments&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">i</span><span class="o">:</span><span class="nx">i</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>  
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>Let's check that the documents made it to the database. Notice that we changed the name of the collection.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">~ $ mongo</span>
<span class="go">MongoDB shell version: 2.2</span>
<span class="go">connecting to: test</span>
<span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test</span>
<span class="gp">&gt;</span> show collections
<span class="go">mycountingdocuments</span>
<span class="go">mydocuments</span>
<span class="go">system.indexes</span>
<span class="gp">&gt;</span> db.mycountingdocuments.find<span class="o">()</span>.pretty<span class="o">()</span>
<span class="go">{ &quot;i&quot; : 0, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000001&quot;) }</span>
<span class="go">{ &quot;i&quot; : 1, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000002&quot;) }</span>
<span class="go">{ &quot;i&quot; : 5, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000006&quot;) }</span>
<span class="go">{ &quot;i&quot; : 3, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000004&quot;) }</span>
<span class="go">{ &quot;i&quot; : 4, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000005&quot;) }</span>
<span class="go">{ &quot;i&quot; : 2, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000003&quot;) }</span>
<span class="go">{ &quot;i&quot; : 9, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000a&quot;) }</span>
<span class="go">{ &quot;i&quot; : 8, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000009&quot;) }</span>
<span class="go">{ &quot;i&quot; : 6, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000007&quot;) }</span>
<span class="go">{ &quot;i&quot; : 7, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000008&quot;) }</span>
<span class="go">{ &quot;i&quot; : 10, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000b&quot;) }</span>
<span class="go">{ &quot;i&quot; : 11, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000c&quot;) }</span>
<span class="go">{ &quot;i&quot; : 12, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000d&quot;) }</span>
<span class="go">{ &quot;i&quot; : 13, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000e&quot;) }</span>
<span class="go">{ &quot;i&quot; : 14, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000f&quot;) }</span>
<span class="go">{ &quot;i&quot; : 15, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000010&quot;) }</span>
<span class="go">{ &quot;i&quot; : 16, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000011&quot;) }</span>
<span class="go">{ &quot;i&quot; : 17, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000012&quot;) }</span>
<span class="go">{ &quot;i&quot; : 18, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000013&quot;) }</span>
<span class="go">{ &quot;i&quot; : 19, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000014&quot;) }</span>
<span class="go">Type &quot;it&quot; for more</span>
<span class="gp">&gt;</span> db.mycountingdocuments.count<span class="o">()</span>
<span class="go">100</span>
</pre></div>
</div>
<p>As you can see we have inserted 100 documents into the database as expected. But surely there must be a better way to bulk insert documents than issuing 100 seperate insert commands. Luckily there is. MongoDB support bulk inserts. In fact the bulk insert command sent to the server is a single message. There is a limit on how much data you can send in a single bulk insert. For now the drivers enforce a 16MB limit. With this information let's rewrite the example to do the insert as a bulk insert.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>    
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mycountingdocuments&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">documents</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">i</span><span class="o">:</span><span class="nx">i</span><span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>Before running the code let's cleanup the collection to ensure we don't have any existing documents in the collection. Fire up the console and do the following to remove all the documents.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">~ $ mongo</span>
<span class="go">MongoDB shell version: 2.2</span>
<span class="go">connecting to: test</span>
<span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test</span>
<span class="gp">&gt;</span> show collections
<span class="go">mycountingdocuments</span>
<span class="go">mydocuments</span>
<span class="go">system.indexes</span>
<span class="gp">&gt;</span> db.mycountingdocuments.remove<span class="o">()</span>
<span class="gp">&gt;</span> db.mycountingdocuments.count<span class="o">()</span>
<span class="go">0</span>
</pre></div>
</div>
<p>Run the example above and verify that all the documents made it to the collection on MongoDB.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">~ $ mongo</span>
<span class="go">MongoDB shell version: 2.2</span>
<span class="go">connecting to: test</span>
<span class="gp">&gt;</span> use <span class="nb">test</span>
<span class="go">switched to db test</span>
<span class="gp">&gt;</span> show collections
<span class="go">mycountingdocuments</span>
<span class="go">mydocuments</span>
<span class="go">system.indexes</span>
<span class="gp">&gt;</span> db.mycountingdocuments.find<span class="o">()</span>.pretty<span class="o">()</span>
<span class="go">{ &quot;i&quot; : 0, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000001&quot;) }</span>
<span class="go">{ &quot;i&quot; : 1, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000002&quot;) }</span>
<span class="go">{ &quot;i&quot; : 5, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000006&quot;) }</span>
<span class="go">{ &quot;i&quot; : 3, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000004&quot;) }</span>
<span class="go">{ &quot;i&quot; : 4, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000005&quot;) }</span>
<span class="go">{ &quot;i&quot; : 2, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000003&quot;) }</span>
<span class="go">{ &quot;i&quot; : 9, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000a&quot;) }</span>
<span class="go">{ &quot;i&quot; : 8, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000009&quot;) }</span>
<span class="go">{ &quot;i&quot; : 6, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000007&quot;) }</span>
<span class="go">{ &quot;i&quot; : 7, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000008&quot;) }</span>
<span class="go">{ &quot;i&quot; : 10, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000b&quot;) }</span>
<span class="go">{ &quot;i&quot; : 11, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000c&quot;) }</span>
<span class="go">{ &quot;i&quot; : 12, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000d&quot;) }</span>
<span class="go">{ &quot;i&quot; : 13, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000e&quot;) }</span>
<span class="go">{ &quot;i&quot; : 14, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f00000f&quot;) }</span>
<span class="go">{ &quot;i&quot; : 15, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000010&quot;) }</span>
<span class="go">{ &quot;i&quot; : 16, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000011&quot;) }</span>
<span class="go">{ &quot;i&quot; : 17, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000012&quot;) }</span>
<span class="go">{ &quot;i&quot; : 18, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000013&quot;) }</span>
<span class="go">{ &quot;i&quot; : 19, &quot;_id&quot; : ObjectId(&quot;50c5fb4ad2950cbd5f000014&quot;) }</span>
<span class="go">Type &quot;it&quot; for more</span>
<span class="gp">&gt;</span> db.mycountingdocuments.count<span class="o">()</span>
<span class="go">100</span>
</pre></div>
</div>
<p>Awesome not hard right. Well what happens if there is a document with an error inbetween the <tt class="docutils literal"><span class="pre">100</span></tt> documents we plan to insert. Well let's try it and see what happens. Enter the example below. Before running it clear out the collection as previously shown. When you run it you should see the following output.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">connected to database</span>
<span class="go">failed to perform bulk insert due to multiple documents havin the same _id field</span>
</pre></div>
</div>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>    
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mycountingdocuments&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1000</span><span class="p">}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1001</span><span class="p">}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1000</span><span class="p">}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1002</span><span class="p">}</span>
  <span class="p">];</span>

  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to perform bulk insert due to multiple documents having the same _id field&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>Ok we got an error from MongoDB but what happened in the database. Did it finish inserting the documents or did it stop. Let's have a look in the db.</p>
<blockquote>
<div>~ $ mongo
MongoDB shell version: 2.2
connecting to: test
&gt; use test
switched to db test
&gt; show collections
mycountingdocuments
mydocuments
system.indexes
&gt; db.mycountingdocuments.find().pretty()
{ &quot;_id&quot; : 1000 }
{ &quot;_id&quot; : 1001 }</div></blockquote>
<p>As we can see MongoDB kept accepting the documents until we hit the document with the duplicate <tt class="docutils literal"><span class="pre">_id</span></tt> value and then stopped and returned an error. But what if we want to make the inserts continue even if there is an error. Well it's also possible. Clear out the db, enter the code below and run it.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>    
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mycountingdocuments&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1000</span><span class="p">}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1001</span><span class="p">}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1000</span><span class="p">}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1002</span><span class="p">}</span>
  <span class="p">];</span>

  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="p">{</span><span class="nx">continueOnError</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to perform bulk insert due to multiple documents having the same _id field&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>Notice that we get the same ouput as the following example but let's have a look at what's in MongoDB now.</p>
<blockquote>
<div>~ $ mongo
MongoDB shell version: 2.2
connecting to: test
&gt; use test
switched to db test
&gt; show collections
mycountingdocuments
mydocuments
system.indexes
&gt; db.mycountingdocuments.find().pretty()
{ &quot;_id&quot; : 1000 }
{ &quot;_id&quot; : 1001 }
{ &quot;_id&quot; : 1002 }</div></blockquote>
<p>As we can see MongoDB did not stop inserting on the error but kept going inserting all the valid documents it could find. However one problem is that MongoDB is not currently able to tell us what specific document failed to insert so we need to programatically in our code. Let's see how we can identify what documents had the same <tt class="docutils literal"><span class="pre">_id</span></tt> variable below. Clean out the collection, then enter and run the code below.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">MongoClient</span><span class="p">;</span>

<span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;failed to connect to the database&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected to database&quot;</span><span class="p">);</span>    
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">mydocuments</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;mycountingdocuments&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">documents</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1000</span><span class="p">}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1001</span><span class="p">}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1000</span><span class="p">}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1002</span><span class="p">}</span>
  <span class="p">];</span>

  <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="p">{</span><span class="nx">continueOnError</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ids</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">documents</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ids</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">documents</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">mydocuments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="p">{</span><span class="nx">$in</span><span class="o">:</span> <span class="nx">ids</span><span class="p">}},</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">}).</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">docHash</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="kd">var</span> <span class="nx">docsNotFound</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">docs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">docHash</span><span class="p">[</span><span class="nx">docs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">documents</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">docHash</span><span class="p">[</span><span class="nx">documents</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">docsNotFound</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">docHash</span><span class="p">[</span><span class="nx">documents</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>            
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">docsNotFound</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>

    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>This code is a bit complicated but the basic explanation is that after we try to do the bulk insert and it fails we retrieve all documents which has a <tt class="docutils literal"><span class="pre">_id</span></tt> value equal to the documents we were trying to insert. We then create a hashmap of the <tt class="docutils literal"><span class="pre">_id</span></tt> where each value is set to true. Iterating through our original documents if we find it in the hashmap we set the hashmap value to false indicating it's been seen by the application. Any other document in the <tt class="docutils literal"><span class="pre">documents</span></tt> array will then trigger the condition <tt class="docutils literal"><span class="pre">!docHash[documents[i]._id]</span></tt> that will save the index in the <tt class="docutils literal"><span class="pre">documents</span></tt> array to the <tt class="docutils literal"><span class="pre">docsNotFound</span></tt> array. The <tt class="docutils literal"><span class="pre">docsNotFound</span></tt> array will contain all the indexes of the documents that failed to insert during the bulk insert.</p>
<p>You might wonder what the <tt class="docutils literal"><span class="pre">$in</span></tt> means and we will get into that in a later exercise. Sufficient to say for now that it's a asking MongoDB to return all documents where <tt class="docutils literal"><span class="pre">_id</span></tt> is in the list of <tt class="docutils literal"><span class="pre">_id's</span></tt> in the <tt class="docutils literal"><span class="pre">ids</span></tt> array.</p>
<p>One thing to note is that you might get a duplicate key error on another field in your document, how to resolve this issue I leave as an exercise for you to figure out.</p>
</div>
<div class="section" id="save">
<h2>Save<a class="headerlink" href="#save" title="Permalink to this headline">Â¶</a></h2>
<p>If you've looked at the documentation for the driver you might have noticed there is a <tt class="docutils literal"><span class="pre">save</span></tt> function on the <tt class="docutils literal"><span class="pre">collection</span></tt> object. From the beginning this might look like a resonable method to use to save your document. If this document already exists (it matches it by the <tt class="docutils literal"><span class="pre">_id</span></tt>) it will replace the entire document. We will go through why this is non optimial later when we talk about updates but I'll give you a hint. Why replace the whole document if you only want to change a single field ? There are some other side effects of full document replacement that we will highlight later.</p>
<p>But for now let's move on to the next exercise which is about one of the most interesting features of MongoDB the ability to specify the durability concern for your application.</p>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="ex8.html" title="Exercise 8: Write Concerns"
             >next</a></li>
        <li class="right" >
          <a href="ex6.html" title="Exercise 6: Databases and Collections"
             >previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>
    <a name="comments"><hr/></a>

<div sytle="text-align: left">
    <div style="background: white; padding: 10px" id="disqus_thread"></div>
</div>
    <script type="text/javascript">
        var dow = new Date().getDay();

        if(dow == 5 || dow == 6) {
            $("#disqus_thread").html("<h1>Today Is Christians's Day Off</h1><p>I take Saturday and Sunday off.  Comments open again on Monday-Friday.</p>")
        } else {
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'learnmongodbthehardway'; // required: replace example with your forum shortname


            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        }
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <div class="footer">
      &copy; Copyright 2012, Christian Amor Kvalheim.
      Last updated on Jan 31, 2013.
</div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24168052-9']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </body>
</html>