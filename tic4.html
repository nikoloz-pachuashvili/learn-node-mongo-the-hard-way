
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tic-Tac-Toe: Exercise 4 &mdash; Learn MongoDB And Node.js The Hard Way</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Learn MongoDB And Node.js The Hard Way" href="index.html" />
    <link rel="next" title="<no title>" href="next.html" />
    <link rel="prev" title="Tic-Tac-Toe: Exercise 3" href="tic3.html" /> 
  </head>
  <body>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="next.html" title="<no title>"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="tic3.html" title="Tic-Tac-Toe: Exercise 3"
             accesskey="P">previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>



    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="tic-tac-toe-exercise-4">
<h1>Tic-Tac-Toe: Exercise 4<a class="headerlink" href="#tic-tac-toe-exercise-4" title="Permalink to this headline">¶</a></h1>
<p>In the last Exercise we will be adding chat functionality to the game and a button to allow a player to quit a game in progress. As part of allowing a player to quit a game in progress we also are going to handle the situation where they close the browser in the middle of a game, thus disconnecting.</p>
<div class="section" id="where-is-the-code">
<h2>Where Is The Code<a class="headerlink" href="#where-is-the-code" title="Permalink to this headline">¶</a></h2>
<p>The code for this exercise is located at</p>
<p><a class="reference external" href="https://github.com/christkv/tic-tac-toe-steps/tree/step3">https://github.com/christkv/tic-tac-toe-steps/tree/step3</a></p>
</div>
<div class="section" id="chatting-it-up">
<h2>Chatting It Up<a class="headerlink" href="#chatting-it-up" title="Permalink to this headline">¶</a></h2>
<p>Let's start with the chat functionality. Chat is defined as a text instant message conversation between two players over a game to be used for taunting and distracting you opponent so you can clinch victory. We have decided to add the chat messages themselves as an array on the board document in play. So let's open the <tt class="docutils literal"><span class="pre">lib/models/game.js</span></tt> file and modify the <tt class="docutils literal"><span class="pre">Game.create_game</span></tt> function to add the <tt class="docutils literal"><span class="pre">chat:[]</span></tt> field.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1">//</span>
<span class="c1">// Create a new game, it contains all the information about the two players, the empty board, the whole</span>
<span class="c1">// game chat record, who is starting the game and who is the current player.</span>
<span class="c1">//</span>
<span class="nx">Game</span><span class="p">.</span><span class="nx">create_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p1_sid</span><span class="p">,</span> <span class="nx">p1_user_name</span><span class="p">,</span> <span class="nx">p1_full_name</span><span class="p">,</span> <span class="nx">p2_sid</span><span class="p">,</span> <span class="nx">p2_user_name</span><span class="p">,</span> <span class="nx">p2_full_name</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">insert</span><span class="p">({</span>
      <span class="nx">player1_sid</span><span class="o">:</span> <span class="nx">p1_sid</span>
    <span class="p">,</span> <span class="nx">player1_user_name</span><span class="o">:</span> <span class="nx">p1_user_name</span>
    <span class="p">,</span> <span class="nx">player1_full_name</span><span class="o">:</span> <span class="nx">p1_full_name</span>
    <span class="p">,</span> <span class="nx">player2_sid</span><span class="o">:</span> <span class="nx">p2_sid</span>
    <span class="p">,</span> <span class="nx">player2_user_name</span><span class="o">:</span> <span class="nx">p2_user_name</span>
    <span class="p">,</span> <span class="nx">player2_full_name</span><span class="o">:</span> <span class="nx">p2_full_name</span>
    <span class="p">,</span> <span class="nx">board</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
      <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
      <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
      <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="p">,</span> <span class="nx">chat</span><span class="o">:</span> <span class="p">[]</span>
    <span class="p">,</span> <span class="nx">created_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="p">,</span> <span class="nx">starting_player</span><span class="o">:</span> <span class="nx">p1_sid</span>
    <span class="p">,</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">p1_sid</span>
  <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">?</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">result</span><span class="p">);</span>
  <span class="p">})</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Now let's create a handler for the chat messages. Create the file <tt class="docutils literal"><span class="pre">lib/handlers/chat_handler.js</span></tt> and open it with your editor.</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">touch lib/handlers/chat_handler.js</span>
</pre></div>
</td></tr></table></div>
<p>enter</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">emit_message</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_message</span>
  <span class="p">,</span> <span class="nx">is_authenticated</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">is_authenticated</span>
  <span class="p">,</span> <span class="nx">locate_connection_with_session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">locate_connection_with_session</span>
  <span class="p">,</span> <span class="nx">emit_error</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_error</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">game</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/game&#39;</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * This function handles the sending of a chat message between two players in a specific</span>
<span class="cm"> * game</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">send_message</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages</span>
  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;send_message&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;chat_message&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Verify that we are logged in</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Let&#39;s our session id, the game id and the message we </span>
    <span class="c1">// want to save</span>
    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">game_id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>

    <span class="c1">// Use the game id to locate the game</span>
    <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">find_game</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game_doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If there is no game return an error message to the calling function on the client</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

      <span class="c1">// Get the session id of the player we are sending the message to</span>
      <span class="c1">// that is simply the other player or the other side in the game</span>
      <span class="kd">var</span> <span class="nx">destination_sid</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span> <span class="o">==</span> <span class="nx">our_sid</span> <span class="o">?</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player2_sid</span> <span class="o">:</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span><span class="p">;</span>
      
      <span class="c1">// Locate the destination connection</span>
      <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">destination_sid</span><span class="p">);</span>
      
      <span class="c1">// If there is no connection it means the other player went away, send an error message</span>
      <span class="c1">// to the calling function on the client</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

      <span class="c1">// Let&#39;s get the calling functions user name</span>
      <span class="c1">// and the destination user&#39;s user name</span>
      <span class="kd">var</span> <span class="nx">our_user_id</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span> <span class="o">==</span> <span class="nx">our_sid</span> <span class="o">?</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_user_name</span> <span class="o">:</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player2_user_name</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">their_user_id</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span> <span class="o">==</span> <span class="nx">destination_sid</span> <span class="o">?</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_user_name</span> <span class="o">:</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player2_user_name</span><span class="p">;</span>

      <span class="c1">// Save the message to the list of chat messages for the game</span>
      <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">save_chat_message</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">our_user_id</span><span class="p">,</span> <span class="nx">their_user_id</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Failed to save the chat message, notify the calling function on the client about the error</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

        <span class="c1">// Notify the destination user about the new chat message</span>
        <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
          <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span> <span class="nx">from_sid</span><span class="o">:</span> <span class="nx">our_sid</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">message</span> <span class="p">}</span>
        <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>    

        <span class="c1">// Notify the calling function that the message delivery was successful</span>
        <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
          <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{}</span>
        <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>    
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">send_message</span> <span class="o">=</span> <span class="nx">send_message</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>The <tt class="docutils literal"><span class="pre">chat_handler.js</span></tt> file only includes a single method called <tt class="docutils literal"><span class="pre">send_message</span></tt> that takes a <tt class="docutils literal"><span class="pre">SocketIO</span></tt> message that includes the fields <tt class="docutils literal"><span class="pre">game_id</span></tt> and <tt class="docutils literal"><span class="pre">message</span></tt>. Using the <tt class="docutils literal"><span class="pre">Game.find_game</span></tt> method we retrieve the game and knowing the caller session id from the <tt class="docutils literal"><span class="pre">SocketIO</span></tt> socket we determine the recipients session id before calling the new method <tt class="docutils literal"><span class="pre">Game.save_chat</span></tt> in the <tt class="docutils literal"><span class="pre">lib/models/game.js</span></tt> file.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">ObjectID</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">).</span><span class="nx">ObjectID</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>

  <span class="c1">//</span>
  <span class="c1">// Create a new game, it contains all the information about the two players, the empty board, the whole</span>
  <span class="c1">// game chat record, who is starting the game and who is the current player.</span>
  <span class="c1">// </span>
  <span class="nx">Game</span><span class="p">.</span><span class="nx">create_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p1_sid</span><span class="p">,</span> <span class="nx">p1_user_name</span><span class="p">,</span> <span class="nx">p1_full_name</span><span class="p">,</span> <span class="nx">p2_sid</span><span class="p">,</span> <span class="nx">p2_user_name</span><span class="p">,</span> <span class="nx">p2_full_name</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">insert</span><span class="p">({</span>
        <span class="nx">player1_sid</span><span class="o">:</span> <span class="nx">p1_sid</span>
      <span class="p">,</span> <span class="nx">player1_user_name</span><span class="o">:</span> <span class="nx">p1_user_name</span>
      <span class="p">,</span> <span class="nx">player1_full_name</span><span class="o">:</span> <span class="nx">p1_full_name</span>
      <span class="p">,</span> <span class="nx">player2_sid</span><span class="o">:</span> <span class="nx">p2_sid</span>
      <span class="p">,</span> <span class="nx">player2_user_name</span><span class="o">:</span> <span class="nx">p2_user_name</span>
      <span class="p">,</span> <span class="nx">player2_full_name</span><span class="o">:</span> <span class="nx">p2_full_name</span>
      <span class="p">,</span> <span class="nx">board</span><span class="o">:</span> <span class="p">[</span>
          <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
      <span class="p">]</span>
      <span class="p">,</span> <span class="nx">created_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
      <span class="p">,</span> <span class="nx">starting_player</span><span class="o">:</span> <span class="nx">p1_sid</span>
      <span class="p">,</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">p1_sid</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">?</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">result</span><span class="p">);</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="c1">//</span>
  <span class="c1">// Locate an existing game by it&#39;s game id</span>
  <span class="c1">//</span>
  <span class="nx">Game</span><span class="p">.</span><span class="nx">find_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">doc</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;could not find the game with id &quot;</span> <span class="o">+</span> <span class="nx">game_id</span><span class="p">));</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">doc</span><span class="p">);</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="c1">//</span>
  <span class="c1">// Attempt to update the board for a specific game and player</span>
  <span class="c1">// the update fails if the current players is not the player attempting to update the board</span>
  <span class="c1">// notice that since we are doing multiple sets we are using the $atomic operation to ensure</span>
  <span class="c1">// we don&#39;t get any interleaved updates in between the two sets</span>
  <span class="c1">//</span>
  <span class="nx">Game</span><span class="p">.</span><span class="nx">update_board</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">game_id</span><span class="p">,</span> <span class="nx">next_sid</span><span class="p">,</span> <span class="nx">board</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
        <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">),</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">sid</span><span class="p">,</span> <span class="nx">$atomic</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
      <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">board</span><span class="o">:</span> <span class="nx">board</span><span class="p">,</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">next_sid</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;It is not your turn&quot;</span><span class="p">));</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">//</span>
  <span class="c1">// Save a chat message to it&#39;s corresponding game </span>
  <span class="c1">// we also save the user names for the sender and the receiver</span>
  <span class="c1">//</span>
  <span class="nx">Game</span><span class="p">.</span><span class="nx">save_chat_message</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">from_user_id</span><span class="p">,</span> <span class="nx">to_user_id</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
        <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">)}</span>
      <span class="p">,</span> <span class="p">{</span><span class="nx">$push</span><span class="o">:</span> <span class="p">{</span><span class="nx">chat</span><span class="o">:</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">from_user_id</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">to_user_id</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">message</span><span class="p">}}}</span>
      <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;No game found to update&quot;</span><span class="p">));</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">)</span>
  <span class="p">}</span>  

  <span class="c1">// Return Game object class</span>
  <span class="k">return</span> <span class="nx">Game</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The <tt class="docutils literal"><span class="pre">Game.save_chat</span></tt> method performs a <tt class="docutils literal"><span class="pre">$push</span></tt> update operation to push a message object containing a <tt class="docutils literal"><span class="pre">from</span></tt>, <tt class="docutils literal"><span class="pre">to</span></tt> and <tt class="docutils literal"><span class="pre">message</span></tt> field to the back of the <tt class="docutils literal"><span class="pre">chat</span></tt> field array contained in the game document.</p>
<p>If the update is successful <tt class="docutils literal"><span class="pre">send_message</span></tt> notifies both players that the message was successfully transmitted.</p>
<p>Last but not least, lets wire up the <tt class="docutils literal"><span class="pre">send_message</span></tt> handler by opening the <tt class="docutils literal"><span class="pre">app.js</span></tt> file in our editor and adding the lines shown below under the <tt class="docutils literal"><span class="pre">socket.on('place_marker'...</span></tt> line.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1">// Accepts chat messages</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;send_message&#39;</span><span class="p">,</span> <span class="nx">send_message</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
</pre></div>
</td></tr></table></div>
<p>Let's not forget to add the <tt class="docutils literal"><span class="pre">send_message</span></tt> handler to the <tt class="docutils literal"><span class="pre">require</span></tt> section at the top.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">register_handler</span>                  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/login_handler&#39;</span><span class="p">).</span><span class="nx">register_handler</span>
  <span class="p">,</span> <span class="nx">login_handler</span>                     <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/login_handler&#39;</span><span class="p">).</span><span class="nx">login_handler</span>
  <span class="p">,</span> <span class="nx">find_all_available_gamers</span>         <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">).</span><span class="nx">find_all_available_gamers</span>
  <span class="p">,</span> <span class="nx">invite_gamer</span>                      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">).</span><span class="nx">invite_gamer</span>
  <span class="p">,</span> <span class="nx">decline_game</span>                      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">).</span><span class="nx">decline_game</span>
  <span class="p">,</span> <span class="nx">accept_game</span>                       <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">).</span><span class="nx">accept_game</span>
  <span class="p">,</span> <span class="nx">place_marker</span>                      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">).</span><span class="nx">place_marker</span>
  <span class="p">,</span> <span class="nx">send_message</span>                      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/chat_handler&#39;</span><span class="p">).</span><span class="nx">send_message</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="front-end">
<h2>Front End<a class="headerlink" href="#front-end" title="Permalink to this headline">¶</a></h2>
<p>We have to do some simle modifications to the frontend. Let's start by opening the <tt class="docutils literal"><span class="pre">public/javascript/api.js</span></tt> file and adding a method <tt class="docutils literal"><span class="pre">API.prototype.send_message</span></tt>.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Wraps the API used for the game and handles the socketIO connection</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">API</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">domain</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="c1">// Handle the data returned over the SocketIO</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// If the data object has an event member we have</span>
    <span class="c1">// a valid event message from the server</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">data</span><span class="p">.</span><span class="nx">is_error</span> <span class="o">?</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">data</span><span class="p">)</span> <span class="o">:</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">data</span><span class="p">.</span><span class="nx">is_error</span> <span class="o">?</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">pop</span><span class="p">()(</span><span class="nx">data</span><span class="p">)</span> <span class="o">:</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">pop</span><span class="p">()(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Register an event listener callback (will keep receiving messages)</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Register an event listener callback for a single instance of the event</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">once</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Register a new user</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>  
  <span class="c1">// Do basic validation</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">full_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">full_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;Full name cannot be empty&quot;</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;User name cannot be empty&quot;</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;Password name cannot be empty&quot;</span><span class="p">));</span>
  <span class="c1">// Register callback</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="c1">// Fire message</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">full_name</span><span class="o">:</span> <span class="nx">full_name</span>
    <span class="p">,</span> <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Login a user</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">login</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>  
  <span class="c1">// Do basic validation</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;User name cannot be empty&quot;</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;Password name cannot be empty&quot;</span><span class="p">));</span>
  <span class="c1">// Register callback</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="c1">// Fire message</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Find all available gamers that are active</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">find_all_available_gamers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>  
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;find_all_available_gamers&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;find_all_available_gamers&quot;</span><span class="p">,</span> <span class="p">{});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Invite a gamer to a new game</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">invite_gamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gamer</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;invite_gamer&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;invite_gamer&quot;</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">);</span>
<span class="p">}</span> 

<span class="cm">/**</span>
<span class="cm"> * Decline an invite to play a game</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">decline_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">invite</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;decline_game&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;decline_game&quot;</span><span class="p">,</span> <span class="nx">invite</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Accept an invite to play a game</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">accept_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">invite</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;accept_game&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;accept_game&quot;</span><span class="p">,</span> <span class="nx">invite</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Place a marker on a specific game at a specific location</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">place_marker</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>  
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;place_marker&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;place_marker&quot;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">game_id</span><span class="o">:</span> <span class="nx">game_id</span>
    <span class="p">,</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">x</span>
    <span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">y</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Send a message to a specific gamer on a specific game</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">send_message</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;send_message&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>  
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;send_message&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">game_id</span><span class="o">:</span> <span class="nx">game_id</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">message</span><span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Simple method to create a formated error message that fits the</span>
<span class="cm"> * format returned from the server</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">create_error</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
      <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
    <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
    <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Next we need to add the HTML markup for that makes up the chat interface on the frontend. Open the file <tt class="docutils literal"><span class="pre">public/templates/board.ms</span></tt> and add add the following to it, in the area marked <tt class="docutils literal"><span class="pre">&lt;div</span> <span class="pre">class=&quot;span4&quot;&gt;</span></tt></p>
<div class="highlight-html"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span4&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;chat&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">&quot;input-block-level&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;chat message&quot;</span> <span class="na">id=</span><span class="s">&quot;chat_message&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</td></tr></table></div>
<p>Let's pretty it up a bit, by adding some css styling. Open the <tt class="docutils literal"><span class="pre">public/css/app.css</span></tt> file and add the following to the end of it.</p>
<div class="highlight-css"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span class="nf">#chat</span> <span class="nt">p</span> <span class="p">{</span>
  <span class="k">margin</span><span class="o">:</span> <span class="m">0px</span> <span class="m">0px</span> <span class="m">0px</span> <span class="m">0px</span><span class="p">;</span>
  <span class="k">padding</span><span class="o">:</span> <span class="m">0px</span> <span class="m">0px</span> <span class="m">0px</span> <span class="m">0px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#chat</span> <span class="p">{</span>
  <span class="k">border</span><span class="o">:</span> <span class="m">1px</span> <span class="k">solid</span> <span class="nb">gray</span><span class="p">;</span>
  <span class="k">height</span><span class="o">:</span> <span class="m">400px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.chat_msg_other</span> <span class="p">{</span>
  <span class="k">font-size</span><span class="o">:</span> <span class="m">14px</span><span class="p">;</span>
  <span class="k">margin-left</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
  <span class="k">margin-right</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
  <span class="k">color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.chat_msg_current</span> <span class="p">{</span>
  <span class="k">font-size</span><span class="o">:</span> <span class="m">14px</span><span class="p">;</span>
  <span class="k">margin-left</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
  <span class="k">margin-right</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
  <span class="k">color</span><span class="o">:</span> <span class="nb">blue</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>That's formating take care off. It's time to wire up the chat functionality to your application. First open up the <tt class="docutils literal"><span class="pre">public/javascripts/app.js</span></tt> file and add the <tt class="docutils literal"><span class="pre">chat_handler</span></tt> function to it.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Handle chat messages from the user, (activates on the return key)</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">chat_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">which</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">chat_input</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#chat_message&#39;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">chat_window</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#chat&#39;</span><span class="p">);</span>
      <span class="c1">// Fetch the message the user entered</span>
      <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">chat_input</span><span class="p">.</span><span class="nx">val</span><span class="p">();</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

      <span class="c1">// Send the message to the other player</span>
      <span class="nx">api</span><span class="p">.</span><span class="nx">send_message</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If we have an error show the error message to the user</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

        <span class="c1">// Push the current message to the bottom</span>
        <span class="nx">chat_window</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;p class=&quot;chat_msg_current&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">get_date_time_string</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;&amp;#62; &#39;</span> <span class="o">+</span> <span class="nx">message</span> <span class="o">+</span> <span class="s2">&quot;&lt;/p&gt;&quot;</span><span class="p">);</span>
        <span class="c1">// Clear out the messages</span>
        <span class="nx">chat_input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Wire it up by adding the line shown below to the end of the <tt class="docutils literal"><span class="pre">setupBoardGame</span></tt> function in the same <tt class="docutils literal"><span class="pre">public/javascripts/app.js</span></tt> file.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1">// Map up the chat handler</span>
<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#chat_message&#39;</span><span class="p">).</span><span class="nx">keypress</span><span class="p">(</span><span class="nx">chat_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">));</span>
</pre></div>
</td></tr></table></div>
<p>The <tt class="docutils literal"><span class="pre">chat_handler</span></tt> will listen for keyboard key presses and if it detects the <tt class="docutils literal"><span class="pre">return</span></tt> key it will take the content of the chat input box and send it to the server using the <tt class="docutils literal"><span class="pre">api.send_message</span></tt> method and append it to the chat window if the sending of the message succeeded.</p>
<p>The item we need to add is an event handler for <tt class="docutils literal"><span class="pre">chat_message</span></tt> events sent from the server. This event is fired when the server relays a message from the other player. Open up the <tt class="docutils literal"><span class="pre">public/javascripts/app.js</span></tt> and add the event handler shown below.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * The other player sent a message, render the message in the chat box</span>
<span class="cm"> */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;chat_message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="c1">// Get the message</span>
  <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
  <span class="c1">// Get the chat window</span>
  <span class="kd">var</span> <span class="nx">chat_window</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#chat&#39;</span><span class="p">);</span>
  <span class="c1">// Push the current message to the bottom</span>
  <span class="nx">chat_window</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;p class=&quot;chat_msg_other&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">get_date_time_string</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;&amp;#62; &#39;</span> <span class="o">+</span> <span class="nx">message</span> <span class="o">+</span> <span class="s1">&#39;&lt;/p&gt;&#39;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>Notice that we use a method called <tt class="docutils literal"><span class="pre">get_date_time_string</span></tt>. This is a helper method to format a date-time stamp for the chat message. Add the implementation under the <tt class="docutils literal"><span class="pre">Helper</span></tt> section of the <tt class="docutils literal"><span class="pre">public/javascripts/app.js</span></tt> file.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Get a date time string</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">get_date_time_string</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">string</span> <span class="o">=</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">?</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">:</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getHours</span><span class="p">();</span>
  <span class="nx">string</span> <span class="o">+=</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">?</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">()</span> <span class="o">:</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">());</span>
  <span class="nx">string</span> <span class="o">+=</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getSeconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">?</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getSeconds</span><span class="p">()</span> <span class="o">:</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getSeconds</span><span class="p">());</span>
  <span class="k">return</span> <span class="nx">string</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>We've now finished adding the functionality for two players to perform a chat during a game. The only thing that's left to implement is the two ways to leave a game in progress. The first one is if one of the two players closes the browser window containing the game in progress, and the second one is a button on the board for the player to leave the game.</p>
</div>
<div class="section" id="reddit-is-more-interesting-i-m-out-of-here">
<h2>Reddit Is More Interesting I'm Out Of Here<a class="headerlink" href="#reddit-is-more-interesting-i-m-out-of-here" title="Permalink to this headline">¶</a></h2>
<p>The first scenario happens when one of the players close their browser window. In this case we should terminate all the current games they are participating in by sending a user went away message to all the opposing players.</p>
<p>Lets start by creating a new handler that handles socket disconnects by messaging the still active players about them. First let's create the empty handler file.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">touch</span> <span class="nx">lib</span><span class="o">/</span><span class="nx">handlers</span><span class="o">/</span><span class="nx">user_handler</span><span class="p">.</span><span class="nx">js</span>
</pre></div>
</td></tr></table></div>
<p>Then it's time to fire up your editor and edit the newly created file <tt class="docutils literal"><span class="pre">lib/handlers/user_handler.js</span></tt>.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">emit_message</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_message</span>
  <span class="p">,</span> <span class="nx">is_authenticated</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">is_authenticated</span>
  <span class="p">,</span> <span class="nx">emit_message_all</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_message_all</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/user&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/gamer&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">game</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/game&#39;</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Handle the disconnect event from ``SocketIO``</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">disconnected</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages</span>
  <span class="kd">var</span> <span class="nx">event_name</span> <span class="o">=</span> <span class="s2">&quot;disconnected&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// If we are not authenticated we don&#39;t care about signaling anyone</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="c1">// Grab our session id</span>
    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>

    <span class="c1">// Locate any games we are in that are not finalized</span>
    <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">finalize_all_boards_as_draws</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

      <span class="c1">// Emit disconnect message to everyone</span>
      <span class="k">return</span> <span class="nx">emit_message_all</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">event_name</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">our_sid</span>
      <span class="p">},</span> <span class="nx">our_sid</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span> 
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">disconnected</span>              <span class="o">=</span> <span class="nx">disconnected</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>We need to locate all games that are still active for this player and then set them to the status of a <tt class="docutils literal"><span class="pre">draw</span></tt> (it might not be the players fault as his internet connection might have dropped). First add the <tt class="docutils literal"><span class="pre">Gamer.finalize_all_boards_as_draws</span></tt> method to the <tt class="docutils literal"><span class="pre">lib/models/game.js</span></tt> file.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1">//</span>
<span class="c1">// Finalizes all the boards as a draw</span>
<span class="c1">//</span>
<span class="nx">Game</span><span class="p">.</span><span class="nx">finalize_all_boards_as_draws</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
      <span class="p">{</span><span class="nx">$or</span><span class="o">:</span> <span class="p">[{</span><span class="nx">player1_sid</span><span class="o">:</span> <span class="nx">sid</span><span class="p">},</span> <span class="p">{</span><span class="nx">player2_sid</span><span class="o">:</span> <span class="nx">sid</span><span class="p">}],</span> <span class="nx">winner</span><span class="o">:</span> <span class="p">{</span><span class="nx">$exists</span><span class="o">:</span> <span class="kc">false</span><span class="p">}}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">final_state</span><span class="o">:</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="nx">winner</span><span class="o">:</span> <span class="kc">null</span><span class="p">}},</span> <span class="p">{</span><span class="nx">multi</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Failed to finalize the boards with a draw&quot;</span><span class="p">));</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>If you remember from the last exercise an active game is a game without the <tt class="docutils literal"><span class="pre">winner</span></tt> field set. This method locates all the games that the player closing the socket is currently in and sets them to a <tt class="docutils literal"><span class="pre">draw</span></tt> state. It then messages all active players that we have experienced a disconnect event enabling them to recover from a game in progress.</p>
<p>Before we jump to the frontend let's make sure we wire up the new handler. Open the <tt class="docutils literal"><span class="pre">app.js</span></tt> file and add.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">disconnected</span>                      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/user_handler&#39;</span><span class="p">).</span><span class="nx">disconnected</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>at the top and the handler below the <tt class="docutils literal"><span class="pre">send_message</span></tt> handler</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1">// On disconnect</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="nx">disconnected</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
</pre></div>
</td></tr></table></div>
<p>Now let's move to the frontend and get the event wired up correctly so the interface can respond to it.</p>
</div>
<div class="section" id="frontend-handling">
<h2>Frontend Handling<a class="headerlink" href="#frontend-handling" title="Permalink to this headline">¶</a></h2>
<p>Open the <tt class="docutils literal"><span class="pre">public/javascripts/app.js</span></tt> file and add an event handler for the <tt class="docutils literal"><span class="pre">disconnect</span></tt> event.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * A player disconnect from the game, ensure we cancel any games we are playing</span>
<span class="cm"> * with them</span>
<span class="cm"> */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnected&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="c1">// Get the sid</span>
  <span class="kd">var</span> <span class="nx">sid</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
  <span class="c1">// Check if the current game is being played with this user</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span>
    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">player1_sid</span> <span class="o">==</span> <span class="nx">sid</span> <span class="o">||</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">player2_sid</span> <span class="o">==</span> <span class="nx">sid</span><span class="p">))</span> <span class="p">{</span>

    <span class="c1">// Load all the available gamers</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Save the list of games in our game state</span>
      <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>

      <span class="c1">// Show the main dashboard view and render with all the available players</span>
      <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>

      <span class="c1">// Add handlers for each new player so we can play them</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
      <span class="p">}</span>

      <span class="c1">// Reset the game state</span>
      <span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

      <span class="c1">// If we have an error show the error message to the user</span>
      <span class="nx">error_box_show</span><span class="p">(</span><span class="s2">&quot;User disconnected&quot;</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>This handler will trigger on the <tt class="docutils literal"><span class="pre">disconnected</span></tt> event and if the game we are currently playing is with the disconnected player we render the dashboard and display the disconnect error (this effectively puts the player back in a position where they can challenge another player).</p>
<p>We are nearly there but we need to let the gamer have a way to leave a game at their leisure as well. To allow this we are going to add a button to leave a game in progress. Let's modify the <tt class="docutils literal"><span class="pre">public/templates/board.ms</span></tt> file to the button. Modify the <tt class="docutils literal"><span class="pre">&lt;div</span> <span class="pre">class=&quot;span&quot;&gt;</span></tt> with the HTML below adding the <tt class="docutils literal"><span class="pre">Quit</span> <span class="pre">Game</span></tt> button.</p>
<div class="highlight-html"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span4&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div&gt;&lt;button</span> <span class="na">id=</span><span class="s">&quot;quit_game&quot;</span><span class="nt">&gt;</span>Quit Game<span class="nt">&lt;/button&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;chat&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">&quot;input-block-level&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;chat message&quot;</span> <span class="na">id=</span><span class="s">&quot;chat_message&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</td></tr></table></div>
<p>We then need to add a handler for the <tt class="docutils literal"><span class="pre">Quit</span> <span class="pre">Game</span></tt> button. Open up the <tt class="docutils literal"><span class="pre">public/javascripts/app.js</span></tt> file and modify the <tt class="docutils literal"><span class="pre">setupBoardGame</span></tt> to add a handler called <tt class="docutils literal"><span class="pre">quit_game_handler</span></tt> below the <tt class="docutils literal"><span class="pre">$('#chat_message').keypress(chat_handler(application_state,</span> <span class="pre">api,</span> <span class="pre">template_handler,</span> <span class="pre">game));</span></tt> line.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Set up a new game board and add handlers to all the cells of the board</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">setupBoardGame</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Save current game to state</span>
  <span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span> <span class="o">=</span> <span class="nx">game</span><span class="p">;</span>
  <span class="c1">// Let&#39;s render the board game</span>
  <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;board&quot;</span><span class="p">,</span> <span class="p">{});</span>
  <span class="c1">// Set the marker for our player (X if we are the starting player)</span>
  <span class="nx">application_state</span><span class="p">.</span><span class="nx">marker</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span> <span class="o">==</span> <span class="nx">game</span><span class="p">.</span><span class="nx">current_player</span> <span class="o">?</span> <span class="s2">&quot;x&quot;</span> <span class="o">:</span> <span class="s2">&quot;o&quot;</span><span class="p">;</span>
  <span class="c1">// Get all the rows</span>
  <span class="kd">var</span> <span class="nx">rows</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#board div&#39;</span><span class="p">);</span>

  <span class="c1">// Add an event handler to each cell</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cells</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; span&quot;</span><span class="p">);</span>

    <span class="c1">// For each cell create and add the handler</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">cells</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">cells</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">id</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">game_board_cell_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Map up the chat handler</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#chat_message&#39;</span><span class="p">).</span><span class="nx">keypress</span><span class="p">(</span><span class="nx">chat_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">));</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#quit_game&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">quit_game_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Now we need to complete the <tt class="docutils literal"><span class="pre">quit_game_handler</span></tt> method and add it to the <tt class="docutils literal"><span class="pre">public/javascripts/app.js</span></tt> file.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Create a handler for the quit game button on the board, sending a disconnect message</span>
<span class="cm"> * to the server and bringing the player back to the dashboard</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">quit_game_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Execute a disconnect</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">leave_game</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Load all the available gamers</span>
      <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// If we have an error show the error message to the user</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

        <span class="c1">// Save the list of games in our game state</span>
        <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>

        <span class="c1">// Show the main dashboard view and render with all the available players</span>
        <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>

        <span class="c1">// Add handlers for each new player so we can play them</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>To make it all work we need to define a new <tt class="docutils literal"><span class="pre">API</span></tt> call called <tt class="docutils literal"><span class="pre">leave_game</span></tt> that will send a message to the server signaling that the player has left the game. Open up <tt class="docutils literal"><span class="pre">public/javascripts/api.js</span></tt> and add the <tt class="docutils literal"><span class="pre">API</span></tt> call.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Send a disconnect message to the server</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">leave_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;leave_game&quot;</span><span class="p">,</span> <span class="p">{});</span>
  <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Notice that we not expecting a callback as we are in fact reusing the <tt class="docutils literal"><span class="pre">disconnected</span></tt> handler in the <tt class="docutils literal"><span class="pre">lib/handlers/user_handler.js</span></tt> file. We do need to define a new server <tt class="docutils literal"><span class="pre">API</span></tt> call named <tt class="docutils literal"><span class="pre">leave_game</span></tt> but we can reuse the same <tt class="docutils literal"><span class="pre">disconnected</span></tt> handler. Let's go ahead and wire up the <tt class="docutils literal"><span class="pre">disconnect</span></tt> handler in the <tt class="docutils literal"><span class="pre">app.js</span></tt> file.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;leave_game&#39;</span><span class="p">,</span> <span class="nx">disconnected</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="we-did-it">
<h2>We Did It<a class="headerlink" href="#we-did-it" title="Permalink to this headline">¶</a></h2>
<p>That ends the Tic-Tac-Toe tutorial. It's been a long winding road of code and editor usage but you now have your basic Tic-Tac-Toe multi-player game. There are lots of possible improvements that be implemented in the game of course. You could extend the game to be able to run multiple games at the same time against multiple players. Maybe introduce a friend relationship with players ?. Your imagination is the limit. Go forth and expand it as much as you want.</p>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="next.html" title="<no title>"
             >next</a></li>
        <li class="right" >
          <a href="tic3.html" title="Tic-Tac-Toe: Exercise 3"
             >previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>
    <a name="comments"><hr/></a>

<div sytle="text-align: left">
    <div style="background: white; padding: 10px" id="disqus_thread"></div>
</div>
    <script type="text/javascript">
        var dow = new Date().getDay();

        if(dow == 5 || dow == 6) {
            $("#disqus_thread").html("<h1>Today Is Christians's Day Off</h1><p>I take Saturday and Sunday off.  Comments open again on Monday-Friday.</p>")
        } else {
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'learn-code-the-hard-way'; // required: replace example with your forum shortname


            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        }
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <div class="footer">
      &copy; Copyright 2012, Christian Amor Kvalheim.
      Last updated on Jan 31, 2013.
</div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24168052-9']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </body>
</html>