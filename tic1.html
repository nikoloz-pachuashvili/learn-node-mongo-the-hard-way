
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tic-Tac-Toe: Exercise 1 &mdash; Learn MongoDB And Node.js The Hard Way</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Learn MongoDB And Node.js The Hard Way" href="index.html" />
    <link rel="next" title="Tic-Tac-Toe: Exercise 2" href="tic2.html" />
    <link rel="prev" title="<no title>" href="ex52.html" /> 
  </head>
  <body>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="tic2.html" title="Tic-Tac-Toe: Exercise 2"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="ex52.html" title="<no title>"
             accesskey="P">previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>



    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="tic-tac-toe-exercise-1">
<h1>Tic-Tac-Toe: Exercise 1<a class="headerlink" href="#tic-tac-toe-exercise-1" title="Permalink to this headline">¶</a></h1>
<p>We are going to build ourselves a brand new super high-tech multiplayer Tic-Tac-Toe game (and the crowd goes wild). During these exercises we will learn about exiting technologies such as <tt class="docutils literal"><span class="pre">SocketIO</span></tt> and <tt class="docutils literal"><span class="pre">Express</span> <span class="pre">JS`,</span> <span class="pre">two</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">most</span> <span class="pre">popular</span> <span class="pre">``NPM</span></tt> modules, as well as <tt class="docutils literal"><span class="pre">MongoDB</span></tt>, of course. The application is built slightly differently than what you might be used to if you've written other classic web applications. It's 100% client driven and dynamic. Yes, you read that right. It's Javascript powered all the way down. A single controller renders HTML and only a single template. The rest is all rendered in the client using <tt class="docutils literal"><span class="pre">Mustache</span></tt> to create an awesome next generation Tic-Tac-Toe worthy of the title of the best multiplayer Tic-Tac-Toe game ever (irony noted).</p>
<div class="section" id="where-is-the-code">
<h2>Where Is The Code<a class="headerlink" href="#where-is-the-code" title="Permalink to this headline">¶</a></h2>
<p>The code for this exercise is located at</p>
<p><a class="reference external" href="https://github.com/christkv/tic-tac-toe-steps/tree/step0">https://github.com/christkv/tic-tac-toe-steps/tree/step0</a></p>
</div>
<div class="section" id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h2>
<p>Let's look at why we picked <tt class="docutils literal"><span class="pre">SocketIO</span></tt> for communication. <tt class="docutils literal"><span class="pre">SocketIO</span></tt> is an abstraction library for message passing between the client and server. It's got full support for websockets but also has fallback mechanisms if Websockets is not available in the browser. This makes it a great choice for games like Tic-Tac-Toe that do not have strong realtime requirements which need to be able to reliably deliver 25 messages a second.</p>
<p>The main goal is to build our application as a set of API methods that model the interactions between the front (client side javascript) and the server code. This makes the interactions between the client and the server a defined set and gives us some structure for our application so we can extend it in the future.</p>
<p>The first realization is that there are two types of interactions in our application: those initiated by the client (ex: get a list of all available gamers) and those initiated by either the server or another client via the server (ex: player one invites player two to play a game). That means a calling <tt class="docutils literal"><span class="pre">API</span></tt> as well as event handling. Having this in mind, let's look at what kind of actions we need in our fancy Tic-Tac-Toe game.</p>
<p>From the client (browser) there are several actions that we need to consider in relation to the game such as finding the list of available gamers, logging in, inviting a player to a game and actually playing the game by putting down markers.</p>
<table border="1" class="docutils">
<colgroup>
<col width="34%" />
<col width="66%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Action</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>register</td>
<td>Attempt to register a new user</td>
</tr>
<tr class="row-odd"><td>login</td>
<td>Attempt to perform a login of an existing user</td>
</tr>
<tr class="row-even"><td>find_all_available_gamers</td>
<td>Locate all logged on gamers</td>
</tr>
<tr class="row-odd"><td>invite_gamer</td>
<td>Invite another gamer to participate in a new game</td>
</tr>
<tr class="row-even"><td>decline_game</td>
<td>Decline an invitation to participate in a game</td>
</tr>
<tr class="row-odd"><td>accept_game</td>
<td>Accept an invitation to participate in a game</td>
</tr>
<tr class="row-even"><td>place_marker</td>
<td>Attempt to place a new marker on a board</td>
</tr>
<tr class="row-odd"><td>send_message</td>
<td>Send a chat message to another player during a game</td>
</tr>
<tr class="row-even"><td>leave_game</td>
<td>The player wishes to leave a game in progress</td>
</tr>
</tbody>
</table>
<p>We've outlined the actions a client can perform to interact with the server or other players. However, what are the types of messages the client needs to listen to? Let's list them out.</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="82%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Event</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>init</td>
<td>Server calls back with initial state information when <tt class="docutils literal"><span class="pre">SocketIO</span></tt> connects</td>
</tr>
<tr class="row-odd"><td>game_move</td>
<td>A valid placement of a marker on the board was performed by the other player</td>
</tr>
<tr class="row-even"><td>game_over</td>
<td>The game is over, returns the state of the game (who won or if it's a draw)</td>
</tr>
<tr class="row-odd"><td>game_invite</td>
<td>Another user invites the player to a game</td>
</tr>
<tr class="row-even"><td>chat_message</td>
<td>A chat message is received by the gamer</td>
</tr>
<tr class="row-odd"><td>gamer_joined</td>
<td>A new gamer joins the system (lets us update the list of gamers we can play)</td>
</tr>
<tr class="row-even"><td>disconnected</td>
<td>A player leaves a game currently in progress</td>
</tr>
</tbody>
</table>
<p>The simple idea is to model the application interactions as an <tt class="docutils literal"><span class="pre">API</span></tt> where the calls go over <tt class="docutils literal"><span class="pre">SocketIO</span></tt>. This allows us to write the application in a more thick client style without having to rely on server logic and define the boundary between the server and the client. Some of you might point out that there are libraries to help do this already but the core idea of this exercise is to show the basic principals behind such libraries so that you can understand them better and make a more enlightened choice for your own future applications.</p>
<p>So let's get started with the first steps.</p>
</div>
<div class="section" id="mac-osx-and-linux">
<h2>Mac OSX and Linux<a class="headerlink" href="#mac-osx-and-linux" title="Permalink to this headline">¶</a></h2>
<p>Go to the directory where you want to store your application and let's set up the basics.</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">mkdir tic-tac-toe</span>
<span class="go">cd tic-tac-toe</span>
<span class="go">npm init</span>
</pre></div>
</td></tr></table></div>
<p><tt class="docutils literal"><span class="pre">NPM</span></tt> will ask you a lot of questions. Fill them in as you see fit. Once you're done, you need to edit the newly created <tt class="docutils literal"><span class="pre">package.json</span></tt> file. So, open it in your editor and add the <tt class="docutils literal"><span class="pre">dependencies</span></tt> part. The repository version looks like this.</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;tic-tac-toe-steps&quot;</span><span class="p">,</span>
  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.1&quot;</span><span class="p">,</span>
  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;ERROR: No README.md file found!&quot;</span><span class="p">,</span>
  <span class="nt">&quot;main&quot;</span><span class="p">:</span> <span class="s2">&quot;app.js&quot;</span><span class="p">,</span>
  <span class="nt">&quot;scripts&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;test&quot;</span><span class="p">:</span> <span class="s2">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;mongodb&quot;</span><span class="p">:</span> <span class="s2">&quot;1.2.9&quot;</span><span class="p">,</span>
    <span class="nt">&quot;express&quot;</span><span class="p">:</span> <span class="s2">&quot;3.0.4&quot;</span><span class="p">,</span>
    <span class="nt">&quot;cookie&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.5&quot;</span><span class="p">,</span>
    <span class="nt">&quot;socket.io&quot;</span><span class="p">:</span> <span class="s2">&quot;0.9.13&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;repository&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="nt">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="nt">&quot;license&quot;</span><span class="p">:</span> <span class="s2">&quot;BSD&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Notice the part called <tt class="docutils literal"><span class="pre">dependencies</span></tt>. This tells NPM that the application needs to use the <tt class="docutils literal"><span class="pre">MongoDB</span></tt> driver as well as <tt class="docutils literal"><span class="pre">Express</span> <span class="pre">JS</span></tt>, <tt class="docutils literal"><span class="pre">SocketIO</span></tt> and an utility module called <tt class="docutils literal"><span class="pre">cookie</span></tt>.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">npm install</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">NPM</span></tt> will now download the declared dependencies. Once <tt class="docutils literal"><span class="pre">NPM</span></tt> finishes we need to <tt class="docutils literal"><span class="pre">bootstrap</span></tt> the application or in other words set up the initial structure. Let's boot up the console and create our directory structure as well as grab the libraries like <tt class="docutils literal"><span class="pre">bootstrap</span></tt>, <tt class="docutils literal"><span class="pre">jquery</span></tt>, <tt class="docutils literal"><span class="pre">mustache</span></tt> and the images we need for the board.</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">mkdir public</span>
<span class="go">mkdir public/javascripts</span>
<span class="go">mkdir public/css</span>
<span class="go">mkdir public/templates</span>
<span class="go">mkdir public/img</span>
<span class="go">mkdir lib</span>
<span class="go">mkdir lib/controllers</span>
<span class="go">mkdir lib/handlers</span>
<span class="go">mkdir lib/models</span>
<span class="go">mkdir lib/views</span>
<span class="go">touch app.js</span>
<span class="go">touch env.js</span>
<span class="go">touch public/javascripts/app.js</span>
<span class="go">touch public/javascripts/api.js</span>
<span class="go">touch public/javascripts/template_handler.js</span>
<span class="go">touch public/css/app.css</span>
<span class="go">curl http://www.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js &gt; public/javascripts/bootstrap.min.js</span>
<span class="go">curl http://www.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap.css &gt; public/css/bootstrap.css</span>
<span class="go">curl http://www.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-responsive.css &gt; public/css/bootstrap-responsive.css</span>
<span class="go">curl http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js &gt; public/javascripts/jquery.js</span>
<span class="go">curl http://cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.0/mustache.min.js &gt; public/javascripts/mustache.js</span>
<span class="go">curl https://raw.github.com/christkv/tic-tac-toe/master/public/img/board_background_img.png &gt; public/img/board_background_img.png</span>
<span class="go">curl https://raw.github.com/christkv/tic-tac-toe/master/public/img/circle.png &gt; public/img/circle.png</span>
<span class="go">curl https://raw.github.com/christkv/tic-tac-toe/master/public/img/cross.png &gt; public/img/cross.png</span>
<span class="go">curl https://raw.github.com/christkv/tic-tac-toe/master/public/img/glyphicons-halflings-white.png &gt; public/img/glyphicons-halflings-white.png</span>
<span class="go">curl https://raw.github.com/christkv/tic-tac-toe/master/public/img/glyphicons-halflings.png &gt; public/img/glyphicons-halflings.png</span>
</pre></div>
</td></tr></table></div>
<p>Right we are set for the basic structure of the application. Let's get cracking on the first part of the application. The places to start are the <tt class="docutils literal"><span class="pre">app.js</span></tt> and the <tt class="docutils literal"><span class="pre">env.js</span></tt> files.</p>
</div>
<div class="section" id="app-js">
<h2>App.js<a class="headerlink" href="#app-js" title="Permalink to this headline">¶</a></h2>
<p>First, let's have a look at the <tt class="docutils literal"><span class="pre">app.js</span></tt> file. Fire up your preferred code editor and type in the code.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">env</span>                               <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./env&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">main_controller</span>                   <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/controllers/main_controller&#39;</span><span class="p">);</span>

<span class="nx">env</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>  
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

  <span class="c1">//</span>
  <span class="c1">// http routes</span>
  <span class="c1">//</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">main_controller</span><span class="p">.</span><span class="nx">index</span><span class="p">());</span>

  <span class="c1">//</span>
  <span class="c1">// websocket api end point handlers (our API)</span>
  <span class="c1">//</span>
  <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="c1">// Fire the init message to setup the game</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">event</span><span class="o">:</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="nx">ok</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">});</span>
  <span class="p">});</span>

  <span class="c1">//</span>
  <span class="c1">// fire up the server</span>
  <span class="c1">//  </span>
  <span class="nx">env</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    
    <span class="c1">//</span>
    <span class="c1">// nothing to do</span>
    <span class="c1">//</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>Something to notice here is that we have hidden most of the plumbing of the application in the <tt class="docutils literal"><span class="pre">env.js</span></tt> file but that we are setting up the <tt class="docutils literal"><span class="pre">controllers</span></tt> and <tt class="docutils literal"><span class="pre">SocketIO</span></tt> in the <tt class="docutils literal"><span class="pre">app.js</span></tt> file. The function <tt class="docutils literal"><span class="pre">app.get('/',</span> <span class="pre">....)</span></tt> maps the handler <tt class="docutils literal"><span class="pre">main_controller.index()</span></tt> to the root of the web address (if the server is running on <tt class="docutils literal"><span class="pre">localhost</span></tt> and port <tt class="docutils literal"><span class="pre">3000</span></tt> it would map to <tt class="docutils literal"><span class="pre">http://localhost:3000</span></tt>). Let's have a quick look at <tt class="docutils literal"><span class="pre">main_controller.js</span></tt></p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Returns the actual starting page of the game</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/../views/index.html&#39;</span><span class="p">);</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">sendfile</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
  <span class="p">}</span>  
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">index</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>Notice how the <tt class="docutils literal"><span class="pre">index</span></tt> function returns a function that takes a request and a response parameter. Returning a function lets us do things like <tt class="docutils literal"><span class="pre">index(db)</span></tt> and create a function that knows about a shared <tt class="docutils literal"><span class="pre">MongoDB</span></tt> database object (we are creating a function in a scope where the db object exists). In the next exercise we will see how this is used to create handlers for the <tt class="docutils literal"><span class="pre">SocketIO</span></tt> based <tt class="docutils literal"><span class="pre">API</span></tt>. The <tt class="docutils literal"><span class="pre">index</span></tt> controller reads the file <tt class="docutils literal"><span class="pre">lib/views/index.html</span></tt> and sends it to the browser. The <tt class="docutils literal"><span class="pre">index.html</span></tt> file contains the start screen of our Tic-Tac-Toe application. Fire up your editor and enter it.</p>
<div class="highlight-html"><pre>&lt;!DOCTYPE html&gt;
&lt;html lang="en" ng-app="app"&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;title&gt;Tic-Tac-Toe&lt;/title&gt;

    &lt;!-- Le styles --&gt;
    &lt;link href="/css/bootstrap.css" rel="stylesheet"&gt;
    &lt;style type="text/css"&gt;
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
    &lt;/style&gt;
    &lt;link href="/css/bootstrap-responsive.css" rel="stylesheet"&gt;
    &lt;link href="/css/app.css" rel="stylesheet"&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div&gt;
      &lt;ng-view&gt;&lt;/ng-view&gt;
    &lt;/div&gt;
    &lt;script type="text/javascript" src="javascripts/jquery.js"&gt;&lt;/script&gt;
    &lt;script src="/socket.io/socket.io.js"&gt;&lt;/script&gt;
    &lt;script type="text/javascript" src="javascripts/api.js"&gt;&lt;/script&gt;
    &lt;script type="text/javascript" src="javascripts/template_handler.js"&gt;&lt;/script    
    &lt;script type="text/javascript" src="javascripts/mustache.js"&gt;&lt;/script&gt;
    &lt;script type="text/javascript" src="javascripts/bootstrap.min.js"&gt;&lt;/script&gt;
    &lt;script type="text/javascript" src="javascripts/app.js"&gt;&lt;/script&gt;

    &lt;div class="container"&gt;

      &lt;div class="navbar navbar-inverse navbar-fixed-top"&gt;
        &lt;div class="navbar-inner"&gt;
          &lt;div class="container"&gt;
            &lt;a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"&gt;
              &lt;span class="icon-bar"&gt;&lt;/span&gt;
              &lt;span class="icon-bar"&gt;&lt;/span&gt;
              &lt;span class="icon-bar"&gt;&lt;/span&gt;
            &lt;/a&gt;
            &lt;a class="brand" href="#"&gt;Tic-Tac-Toe&lt;/a&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;!-- Main hero unit for a primary marketing message or call to action --&gt;
      &lt;div class="hero-unit"&gt;
        &lt;h1&gt;Tic Tac Toe!&lt;/h1&gt;
        &lt;p&gt;Play Tic Tac Toe against your friends in this multiplayer demo.&lt;/p&gt;
        &lt;p&gt;&lt;a class="btn btn-primary btn-large" href="https://github.com/christkv/tic-tac-toe"&gt;Github &amp;raquo;&lt;/a&gt;&lt;/p&gt;
      &lt;/div&gt;

      &lt;!-- Example row of columns --&gt;
      &lt;div class="row" id="view"&gt;
      &lt;/div&gt;

      &lt;hr&gt;

      &lt;footer&gt;
        &lt;p&gt;&amp;copy; Christian Kvalheim 2012&lt;/p&gt;
      &lt;/footer&gt;

    &lt;/div&gt; &lt;!-- /container --&gt;
    &lt;!-- Modal --&gt;
    &lt;div id="status_box" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="status_box" aria-hidden="true"&gt;
      &lt;div class="modal-header"&gt;
        &lt;button type="button" class="close" data-dismiss="modal" aria-hidden="true"&gt;×&lt;/button&gt;
        &lt;h3 id="status_box_header"&gt;Modal header&lt;/h3&gt;
      &lt;/div&gt;
      &lt;div class="modal-body"&gt;
        &lt;p id="status_box_body"&gt;&lt;/p&gt;
      &lt;/div&gt;
      &lt;div class="modal-footer"&gt;
        &lt;button class="btn" data-dismiss="modal" aria-hidden="true"&gt;Close&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;    
  &lt;/body&gt;
&lt;/html&gt;</pre>
</div>
<p>If you are wondering how this HTML works I suggest you have a look at <a class="reference external" href="http://twitter.github.com/bootstrap/index.html">http://twitter.github.com/bootstrap/index.html</a> for documentation. In short, it lets people like me with lesser well developed design abilities create websites that are not complete eyesores. Also, notice that we are including the javascript files for <tt class="docutils literal"><span class="pre">api.js</span></tt>, <tt class="docutils literal"><span class="pre">app.js</span></tt> and <tt class="docutils literal"><span class="pre">template_handler.js</span></tt> that we <tt class="docutils literal"><span class="pre">touched</span></tt> when we created the initial directory structure. These will include the actual logic for the client side part of the game and their secrets will be revealed in due time.</p>
</div>
<div class="section" id="env-js">
<h2>Env.js<a class="headerlink" href="#env-js" title="Permalink to this headline">¶</a></h2>
<p>Let's take a quick look at <tt class="docutils literal"><span class="pre">env.js</span></tt> file. If you remember the <tt class="docutils literal"><span class="pre">app.js</span></tt> file you would have noticed that it contained two methods that did not exist in the <tt class="docutils literal"><span class="pre">app.js</span></tt> file. The first one was <tt class="docutils literal"><span class="pre">initialize</span></tt> and the second one was <tt class="docutils literal"><span class="pre">run</span></tt>. Open up your editor and bring up the <tt class="docutils literal"><span class="pre">env.js</span></tt> file and get coding.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">).</span><span class="nx">MongoClient</span>
  <span class="p">,</span> <span class="nx">format</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">).</span><span class="nx">format</span>
  <span class="p">,</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>
  <span class="p">,</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">).</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cookie&#39;</span><span class="p">);</span>

<span class="cm">/** </span>
<span class="cm"> * Setting for the application</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">MONGO_DB_URL</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MONGO_DB</span> <span class="o">||</span> <span class="s1">&#39;mongodb://localhost:27017/tic-tac-toe&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">APP_HOST</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">APP_HOST</span> <span class="o">||</span> <span class="s1">&#39;localhost&#39;</span><span class="p">;</span> 
<span class="kd">var</span> <span class="nx">APP_PORT</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">APP_PORT</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">SESSION_SECRET</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SESSION_SECRET</span> <span class="o">||</span> <span class="s1">&#39;CHANGE_ME&#39;</span><span class="p">;</span>

<span class="cm">/** </span>
<span class="cm"> * Keeps the db connection</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Session store, for production use mongo</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">session_store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">express</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">MemoryStore</span><span class="p">();</span>

<span class="cm">/**</span>
<span class="cm"> * Set up the environment for the application</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">initialize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/**</span>
<span class="cm">   * configure express</span>
<span class="cm">   */</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="s1">&#39;development&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">());</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">cookieParser</span><span class="p">());</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/public&#39;</span><span class="p">));</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">errorHandler</span><span class="p">({</span> <span class="nx">dumpExceptions</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">showStack</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}));</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">session</span><span class="p">({</span> 
      <span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;sid&#39;</span><span class="p">,</span>
      <span class="nx">secret</span><span class="o">:</span> <span class="nx">SESSION_SECRET</span><span class="p">,</span>
      <span class="nx">store</span><span class="o">:</span> <span class="nx">session_store</span>
    <span class="p">}));</span>
  <span class="p">});</span>

  <span class="cm">/**</span>
<span class="cm">   * Capture the session id and make it available</span>
<span class="cm">   */</span>
  <span class="nx">io</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;authorization&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">accept</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// check if there&#39;s a cookie header</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;cookie&#39;</span><span class="p">])</span> <span class="p">{</span>
      <span class="c1">// if there is, parse the cookie</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span><span class="p">);</span>
      <span class="c1">// note that you will need to use the same key to grad the</span>
      <span class="c1">// session id, as you specified in the Express setup.</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">cookie</span><span class="p">[</span><span class="s1">&#39;sid&#39;</span><span class="p">];</span>
      <span class="c1">// Set the user as authenticated in on the express session</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
     <span class="c1">// if there isn&#39;t, turn down the connection with a message</span>
     <span class="c1">// and leave the function.</span>
     <span class="k">return</span> <span class="nx">accept</span><span class="p">(</span><span class="s1">&#39;No cookie transmitted.&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// accept the incoming connection</span>
    <span class="nx">accept</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="cm">/**</span>
<span class="cm">   * Connect to MongoDB and start the server</span>
<span class="cm">   */</span>
  <span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">MONGO_DB_URL</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">_db</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

    <span class="c1">// Save the db reference</span>
    <span class="nx">db</span> <span class="o">=</span> <span class="nx">_db</span><span class="p">;</span>

    <span class="c1">// Return the callback</span>
    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">run</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">APP_PORT</span><span class="p">,</span> <span class="nx">APP_HOST</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Print out a nice message to the console</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
        <span class="p">[</span> <span class="s2">&quot;&quot;</span>
        <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
        <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
        <span class="p">,</span> <span class="s2">&quot;  — — — | — — — | — — — &quot;</span>
        <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
        <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
        <span class="p">,</span> <span class="s2">&quot;  — — — | — — — | — — — &quot;</span>
        <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
        <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
        <span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="p">,</span> <span class="s2">&quot;tic-tac-toe server v&quot;</span> <span class="o">+</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./package.json&#39;</span><span class="p">).</span><span class="nx">version</span>
        <span class="p">,</span> <span class="s2">&quot;listening on port &quot;</span> <span class="o">+</span> <span class="nx">APP_PORT</span> <span class="o">+</span> <span class="s2">&quot; and host &quot;</span> <span class="o">+</span> <span class="nx">APP_HOST</span>
      <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">));</span>

    <span class="c1">// Return successful start of server</span>
    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">initialize</span> <span class="o">=</span> <span class="nx">initialize</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">run</span> <span class="o">=</span> <span class="nx">run</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>So, what do the methods do? Well, the <tt class="docutils literal"><span class="pre">intialize</span></tt> function sets up the <tt class="docutils literal"><span class="pre">Express</span> <span class="pre">JS</span></tt> web framework with a <tt class="docutils literal"><span class="pre">session</span></tt> store and a location for static file serving of all files under the <tt class="docutils literal"><span class="pre">/public</span></tt> directory which lets us access the javascripts, css and image files from the browser. At the top of the file, you'll notice the three core lines.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="p">,</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>
<span class="p">,</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">).</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
<span class="p">,</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>This sets up an <tt class="docutils literal"><span class="pre">Express</span> <span class="pre">JS</span></tt> instance and maps <tt class="docutils literal"><span class="pre">SocketIO</span></tt> to the same socket so they can work together. The <tt class="docutils literal"><span class="pre">SocketIO</span></tt> instance is stored in the variable <tt class="docutils literal"><span class="pre">io</span></tt>. One of the things we need to ensure is that our <tt class="docutils literal"><span class="pre">SocketIO</span></tt> instance can be associated with the initial web page the user loaded through a <tt class="docutils literal"><span class="pre">Session</span> <span class="pre">Cookie</span></tt>. To do this, we need to do some mapping between the <tt class="docutils literal"><span class="pre">SocketIO</span></tt> instance and the server session using our <tt class="docutils literal"><span class="pre">Session</span></tt> Store. Luckily <tt class="docutils literal"><span class="pre">SocketIO</span></tt> has thought about this.</p>
<p>The <tt class="docutils literal"><span class="pre">io.set('authorization',</span> <span class="pre">...)</span></tt> event occurs when the web page is first loaded and a <tt class="docutils literal"><span class="pre">SocketIO</span></tt> connection is made. When the connection happens, the code looks up the <tt class="docutils literal"><span class="pre">Session</span> <span class="pre">Cookie</span></tt> set by <tt class="docutils literal"><span class="pre">Express</span> <span class="pre">JS</span></tt> and adds it to the <tt class="docutils literal"><span class="pre">SocketIO</span></tt> connection. This makes it possible for the application to identify which user is associated with which <tt class="docutils literal"><span class="pre">SocketIO</span></tt> connection and future exercises will show how we use this to communicate between two specific users.</p>
<p>Lastly, we call <tt class="docutils literal"><span class="pre">MongoClient.connect</span></tt> to connect to the <tt class="docutils literal"><span class="pre">MongoDB</span></tt> server and if all works well, we'll return to the calling code in <tt class="docutils literal"><span class="pre">app.js</span></tt>. When <tt class="docutils literal"><span class="pre">app.js</span></tt> calls the <tt class="docutils literal"><span class="pre">run</span></tt> method in <tt class="docutils literal"><span class="pre">env.js</span></tt>, the <tt class="docutils literal"><span class="pre">Express</span> <span class="pre">JS</span></tt> server starts up and we print the welcome message to the console. Before we can boot up, we need a <tt class="docutils literal"><span class="pre">MongoDB</span></tt> server. Open another terminal and go to the project directory. Let's start a new server.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">mkdir data</span>
<span class="go">mongod --dbpath=./data</span>
</pre></div>
</div>
<p>In your previous terminal, start the application (make sure your node.js executable is in your path).</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">node app.js</span>
</pre></div>
</div>
<p>You can now go to <tt class="docutils literal"><span class="pre">http://localhost:3000</span></tt> and see the initial page running in your browser. Awesome, right? Now that we have the basic scaffolding in place, we can move on to the next exercise where we will create the <tt class="docutils literal"><span class="pre">login</span></tt> and <tt class="docutils literal"><span class="pre">registration</span></tt> API's.</p>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="tic2.html" title="Tic-Tac-Toe: Exercise 2"
             >next</a></li>
        <li class="right" >
          <a href="ex52.html" title="<no title>"
             >previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>
    <a name="comments"><hr/></a>

<div sytle="text-align: left">
    <div style="background: white; padding: 10px" id="disqus_thread"></div>
</div>
    <script type="text/javascript">
        var dow = new Date().getDay();

        if(dow == 5 || dow == 6) {
            $("#disqus_thread").html("<h1>Today Is Christians's Day Off</h1><p>I take Saturday and Sunday off.  Comments open again on Monday-Friday.</p>")
        } else {
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'learnmongodbthehardway'; // required: replace example with your forum shortname


            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        }
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <div class="footer">
      &copy; Copyright 2012, Christian Amor Kvalheim.
      Last updated on Jan 31, 2013.
</div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24168052-9']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </body>
</html>