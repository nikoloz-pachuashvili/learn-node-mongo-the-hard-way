<!DOCTYPE html>

<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
    <!--[if gt IE 8]><!-->
<html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />

  <!-- Set the viewport width to device width for mobile -->
  <meta name="viewport" content="width=device-width" />

  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.9.1: http://docutils.sourceforge.net/" />
<title>Tic-Tac-Toe: Exercise 1</title>

  <!-- Included CSS Files (Compressed) -->
  <link rel="stylesheet" href="stylesheets/foundation.min.css">
  <link rel="stylesheet" href="stylesheets/pygments.css">
  <link rel="stylesheet" href="stylesheets/app.css">

  <script src="javascripts/modernizr.foundation.js"></script>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-41953057-1', 'learnmongodbthehardway.com');
    ga('send', 'pageview');

  </script>
  
  <!-- IE Fix for HTML5 Tags -->
  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

</head>
<body>

  <div class="row">
          <h1 class="title">Tic-Tac-Toe: Exercise 1</h1>
      </div>
  </div>

  <div class="row">
    <div class="eleven columns">
        <p>We are going to build ourselves a brand new super high-tech multiplayer Tic-Tac-Toe game (and the crowd goes wild). During these exercises we will learn about exiting technologies such as <tt class="docutils literal">SocketIO</tt> and <tt class="docutils literal">Express JS`, two of the most popular ``NPM</tt> modules, as well as <tt class="docutils literal">MongoDB</tt>, of course. The application is built slightly differently than what you might be used to if you've written other classic web applications. It's 100% client driven and dynamic. Yes, you read that right. It's Javascript powered all the way down. A single controller renders HTML and only a single template. The rest is all rendered in the client using <tt class="docutils literal">Mustache</tt> to create an awesome next generation Tic-Tac-Toe worthy of the title of the best multiplayer Tic-Tac-Toe game ever (irony noted).</p>
<div class="section" id="where-is-the-code">
<h1>Where Is The Code</h1>
<p>The code for this exercise is located at</p>
<p><a class="reference external" href="https://github.com/christkv/tic-tac-toe-steps/tree/step0">https://github.com/christkv/tic-tac-toe-steps/tree/step0</a></p>
</div>
<div class="section" id="architecture">
<h1>Architecture</h1>
<p>Let's look at why we picked <tt class="docutils literal">SocketIO</tt> for communication. <tt class="docutils literal">SocketIO</tt> is an abstraction library for message passing between the client and server. It's got full support for websockets but also has fallback mechanisms if Websockets is not available in the browser. This makes it a great choice for games like Tic-Tac-Toe that do not have strong realtime requirements which need to be able to reliably deliver 25 messages a second.</p>
<p>The main goal is to build our application as a set of API methods that model the interactions between the front (client side javascript) and the server code. This makes the interactions between the client and the server a defined set and gives us some structure for our application so we can extend it in the future.</p>
<p>The first realization is that there are two types of interactions in our application: those initiated by the client (ex: get a list of all available gamers) and those initiated by either the server or another client via the server (ex: player one invites player two to play a game). That means a calling <tt class="docutils literal">API</tt> as well as event handling. Having this in mind, let's look at what kind of actions we need in our fancy Tic-Tac-Toe game.</p>
<p>From the client (browser) there are several actions that we need to consider in relation to the game such as finding the list of available gamers, logging in, inviting a player to a game and actually playing the game by putting down markers.</p>
<table border="1" class="docutils">
<colgroup>
<col width="34%" />
<col width="66%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Action</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>register</td>
<td>Attempt to register a new user</td>
</tr>
<tr><td>login</td>
<td>Attempt to perform a login of an existing user</td>
</tr>
<tr><td>find_all_available_gamers</td>
<td>Locate all logged on gamers</td>
</tr>
<tr><td>invite_gamer</td>
<td>Invite another gamer to participate in a new game</td>
</tr>
<tr><td>decline_game</td>
<td>Decline an invitation to participate in a game</td>
</tr>
<tr><td>accept_game</td>
<td>Accept an invitation to participate in a game</td>
</tr>
<tr><td>place_marker</td>
<td>Attempt to place a new marker on a board</td>
</tr>
<tr><td>send_message</td>
<td>Send a chat message to another player during a game</td>
</tr>
<tr><td>leave_game</td>
<td>The player wishes to leave a game in progress</td>
</tr>
</tbody>
</table>
<p>We've outlined the actions a client can perform to interact with the server or other players. However, what are the types of messages the client needs to listen to? Let's list them out.</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="82%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Event</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>init</td>
<td>Server calls back with initial state information when <tt class="docutils literal">SocketIO</tt> connects</td>
</tr>
<tr><td>game_move</td>
<td>A valid placement of a marker on the board was performed by the other player</td>
</tr>
<tr><td>game_over</td>
<td>The game is over, returns the state of the game (who won or if it's a draw)</td>
</tr>
<tr><td>game_invite</td>
<td>Another user invites the player to a game</td>
</tr>
<tr><td>chat_message</td>
<td>A chat message is received by the gamer</td>
</tr>
<tr><td>gamer_joined</td>
<td>A new gamer joins the system (lets us update the list of gamers we can play)</td>
</tr>
<tr><td>disconnected</td>
<td>A player leaves a game currently in progress</td>
</tr>
</tbody>
</table>
<p>The simple idea is to model the application interactions as an <tt class="docutils literal">API</tt> where the calls go over <tt class="docutils literal">SocketIO</tt>. This allows us to write the application in a more thick client style without having to rely on server logic and define the boundary between the server and the client. Some of you might point out that there are libraries to help do this already but the core idea of this exercise is to show the basic principals behind such libraries so that you can understand them better and make a more enlightened choice for your own future applications.</p>
<p>So let's get started with the first steps.</p>
</div>
<div class="section" id="mac-osx-and-linux">
<h1>Mac OSX and Linux</h1>
<p>Go to the directory where you want to store your application and let's set up the basics.</p>
<pre class="code console literal-block">
<span class="go">mkdir tic-tac-toe
cd tic-tac-toe
npm init</span>
</pre>
<p><tt class="docutils literal">NPM</tt> will ask you a lot of questions. Fill them in as you see fit. Once you're done, you need to edit the newly created <tt class="docutils literal">package.json</tt> file. So, open it in your editor and add the <tt class="docutils literal">dependencies</tt> part. The repository version looks like this.</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;tic-tac-toe-steps&quot;</span><span class="p">,</span>
  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.1&quot;</span><span class="p">,</span>
  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;ERROR: No README.md file found!&quot;</span><span class="p">,</span>
  <span class="nt">&quot;main&quot;</span><span class="p">:</span> <span class="s2">&quot;app.js&quot;</span><span class="p">,</span>
  <span class="nt">&quot;scripts&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;test&quot;</span><span class="p">:</span> <span class="s2">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;mongodb&quot;</span><span class="p">:</span> <span class="s2">&quot;1.2.9&quot;</span><span class="p">,</span>
    <span class="nt">&quot;express&quot;</span><span class="p">:</span> <span class="s2">&quot;3.0.4&quot;</span><span class="p">,</span>
    <span class="nt">&quot;cookie&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.5&quot;</span><span class="p">,</span>
    <span class="nt">&quot;socket.io&quot;</span><span class="p">:</span> <span class="s2">&quot;0.9.13&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;repository&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="nt">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="nt">&quot;license&quot;</span><span class="p">:</span> <span class="s2">&quot;BSD&quot;</span>
<span class="p">}</span>
</pre>
<p>Notice the part called <tt class="docutils literal">dependencies</tt>. This tells NPM that the application needs to use the <tt class="docutils literal">MongoDB</tt> driver as well as <tt class="docutils literal">Express JS</tt>, <tt class="docutils literal">SocketIO</tt> and an utility module called <tt class="docutils literal">cookie</tt>.</p>
<pre class="code console literal-block">
<span class="go">npm install</span>
</pre>
<p><tt class="docutils literal">NPM</tt> will now download the declared dependencies. Once <tt class="docutils literal">NPM</tt> finishes we need to <tt class="docutils literal">bootstrap</tt> the application or in other words set up the initial structure. Let's boot up the console and create our directory structure as well as grab the libraries like <tt class="docutils literal">bootstrap</tt>, <tt class="docutils literal">jquery</tt>, <tt class="docutils literal">mustache</tt> and the images we need for the board.</p>
<pre class="code console literal-block">
<span class="go">mkdir public
mkdir public/javascripts
mkdir public/css
mkdir public/templates
mkdir public/img
mkdir lib
mkdir lib/controllers
mkdir lib/handlers
mkdir lib/models
mkdir lib/views
touch app.js
touch env.js
touch public/javascripts/app.js
touch public/javascripts/api.js
touch public/javascripts/template_handler.js
touch public/css/app.css
curl http://www.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js &gt;
public/javascripts/bootstrap.min.js
curl http://www.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap.css &gt;
public/css/bootstrap.css
curl http://www.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-responsive.css &gt;
public/css/bootstrap-responsive.css
curl http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js &gt;
public/javascripts/jquery.js
curl http://cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.0/mustache.min.js &gt;
public/javascripts/mustache.js
curl https://raw.github.com/christkv/tic-tac-toe/master/public/img/board_background_img.
png &gt; public/img/board_background_img.png
curl https://raw.github.com/christkv/tic-tac-toe/master/public/img/circle.png &gt;
public/img/circle.png
curl https://raw.github.com/christkv/tic-tac-toe/master/public/img/cross.png &gt;
public/img/cross.png
curl https://raw.github.com/christkv/tic-tac-toe/master/public/img/glyphicons-halflings-
white.png &gt; public/img/glyphicons-halflings-white.png
curl https://raw.github.com/christkv/tic-tac-toe/master/public/img/glyphicons-halflings.
png &gt; public/img/glyphicons-halflings.png</span>
</pre>
<p>Right we are set for the basic structure of the application. Let's get cracking on the first part of the application. The places to start are the <tt class="docutils literal">app.js</tt> and the <tt class="docutils literal">env.js</tt> files.</p>
</div>
<div class="section" id="app-js">
<h1>App.js</h1>
<p>First, let's have a look at the <tt class="docutils literal">app.js</tt> file. Fire up your preferred code editor and type in the code.</p>
<div class="highlight"><pre><a name="code--tic--tic1--tic1.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">env</span>                               <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./env&#39;</span><span class="p">)</span>
<a name="code--tic--tic1--tic1.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">main_controller</span>                   <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/controllers/main_controller&#39;</span><span class="p">);</span>
<a name="code--tic--tic1--tic1.js-pyg.html-3"></a>
<a name="code--tic--tic1--tic1.js-pyg.html-4"></a><span class="nx">env</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic1.js-pyg.html-5"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
<a name="code--tic--tic1--tic1.js-pyg.html-6"></a>
<a name="code--tic--tic1--tic1.js-pyg.html-7"></a>  <span class="c1">//</span>
<a name="code--tic--tic1--tic1.js-pyg.html-8"></a>  <span class="c1">// http routes</span>
<a name="code--tic--tic1--tic1.js-pyg.html-9"></a>  <span class="c1">//</span>
<a name="code--tic--tic1--tic1.js-pyg.html-10"></a>  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">main_controller</span><span class="p">.</span><span class="nx">index</span><span class="p">());</span>
<a name="code--tic--tic1--tic1.js-pyg.html-11"></a>
<a name="code--tic--tic1--tic1.js-pyg.html-12"></a>  <span class="c1">//</span>
<a name="code--tic--tic1--tic1.js-pyg.html-13"></a>  <span class="c1">// websocket api end point handlers (our API)</span>
<a name="code--tic--tic1--tic1.js-pyg.html-14"></a>  <span class="c1">//</span>
<a name="code--tic--tic1--tic1.js-pyg.html-15"></a>  <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic1.js-pyg.html-16"></a>
<a name="code--tic--tic1--tic1.js-pyg.html-17"></a>    <span class="c1">// Fire the init message to setup the game</span>
<a name="code--tic--tic1--tic1.js-pyg.html-18"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">event</span><span class="o">:</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="nx">ok</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">});</span>
<a name="code--tic--tic1--tic1.js-pyg.html-19"></a>  <span class="p">});</span>
<a name="code--tic--tic1--tic1.js-pyg.html-20"></a>
<a name="code--tic--tic1--tic1.js-pyg.html-21"></a>  <span class="c1">//</span>
<a name="code--tic--tic1--tic1.js-pyg.html-22"></a>  <span class="c1">// fire up the server</span>
<a name="code--tic--tic1--tic1.js-pyg.html-23"></a>  <span class="c1">//  </span>
<a name="code--tic--tic1--tic1.js-pyg.html-24"></a>  <span class="nx">env</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic1.js-pyg.html-25"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
<a name="code--tic--tic1--tic1.js-pyg.html-26"></a>
<a name="code--tic--tic1--tic1.js-pyg.html-27"></a>    <span class="c1">//</span>
<a name="code--tic--tic1--tic1.js-pyg.html-28"></a>    <span class="c1">// nothing to do</span>
<a name="code--tic--tic1--tic1.js-pyg.html-29"></a>    <span class="c1">//</span>
<a name="code--tic--tic1--tic1.js-pyg.html-30"></a>  <span class="p">});</span>
<a name="code--tic--tic1--tic1.js-pyg.html-31"></a><span class="p">});</span>
</pre></div><p>Something to notice here is that we have hidden most of the plumbing of the application in the <tt class="docutils literal">env.js</tt> file but that we are setting up the <tt class="docutils literal">controllers</tt> and <tt class="docutils literal">SocketIO</tt> in the <tt class="docutils literal">app.js</tt> file. The function <tt class="docutils literal"><span class="pre">app.get('/',</span> <span class="pre">....)</span></tt> maps the handler <tt class="docutils literal">main_controller.index()</tt> to the root of the web address (if the server is running on <tt class="docutils literal">localhost</tt> and port <tt class="docutils literal">3000</tt> it would map to <tt class="docutils literal"><span class="pre">http://localhost:3000</span></tt>). Let's have a quick look at <tt class="docutils literal">main_controller.js</tt></p>
<div class="highlight"><pre><a name="code--tic--tic1--tic2.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
<a name="code--tic--tic1--tic2.js-pyg.html-2"></a>
<a name="code--tic--tic1--tic2.js-pyg.html-3"></a><span class="cm">/**</span>
<a name="code--tic--tic1--tic2.js-pyg.html-4"></a><span class="cm"> * Returns the actual starting page of the game</span>
<a name="code--tic--tic1--tic2.js-pyg.html-5"></a><span class="cm"> */</span>
<a name="code--tic--tic1--tic2.js-pyg.html-6"></a><span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic1--tic2.js-pyg.html-7"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic2.js-pyg.html-8"></a>    <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/../views/index.html&#39;</span><span class="p">);</span>
<a name="code--tic--tic1--tic2.js-pyg.html-9"></a>    <span class="nx">response</span><span class="p">.</span><span class="nx">sendfile</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
<a name="code--tic--tic1--tic2.js-pyg.html-10"></a>  <span class="p">}</span>
<a name="code--tic--tic1--tic2.js-pyg.html-11"></a><span class="p">}</span>
<a name="code--tic--tic1--tic2.js-pyg.html-12"></a>
<a name="code--tic--tic1--tic2.js-pyg.html-13"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">index</span><span class="p">;</span>
</pre></div><p>Notice how the <tt class="docutils literal">index</tt> function returns a function that takes a request and a response parameter. Returning a function lets us do things like <tt class="docutils literal">index(db)</tt> and create a function that knows about a shared <tt class="docutils literal">MongoDB</tt> database object (we are creating a function in a scope where the db object exists). In the next exercise we will see how this is used to create handlers for the <tt class="docutils literal">SocketIO</tt> based <tt class="docutils literal">API</tt>. The <tt class="docutils literal">index</tt> controller reads the file <tt class="docutils literal">lib/views/index.html</tt> and sends it to the browser. The <tt class="docutils literal">index.html</tt> file contains the start screen of our Tic-Tac-Toe application. Fire up your editor and enter it.</p>
<div class="highlight"><pre><a name="code--tic--tic1--tic3.html-pyg.html-1"></a><span class="cp">&lt;!DOCTYPE html&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-2"></a><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span> <span class="na">ng-app=</span><span class="s">&quot;app&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-3"></a>  <span class="nt">&lt;head&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-4"></a>    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-5"></a>    <span class="nt">&lt;title&gt;</span>Tic-Tac-Toe<span class="nt">&lt;/title&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-6"></a>
<a name="code--tic--tic1--tic3.html-pyg.html-7"></a>    <span class="c">&lt;!-- Le styles --&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-8"></a>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/css/bootstrap.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-9"></a>    <span class="nt">&lt;style </span><span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-10"></a>      <span class="nt">body</span> <span class="p">{</span>
<a name="code--tic--tic1--tic3.html-pyg.html-11"></a>        <span class="k">padding-top</span><span class="o">:</span> <span class="m">60px</span><span class="p">;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-12"></a>        <span class="k">padding-bottom</span><span class="o">:</span> <span class="m">40px</span><span class="p">;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-13"></a>      <span class="p">}</span>
<a name="code--tic--tic1--tic3.html-pyg.html-14"></a>    <span class="nt">&lt;/style&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-15"></a>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/css/bootstrap-responsive.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-16"></a>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/css/app.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-17"></a>  <span class="nt">&lt;/head&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-18"></a>  <span class="nt">&lt;body&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-19"></a>    <span class="nt">&lt;div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-20"></a>      <span class="nt">&lt;ng</span><span class="na">-view</span><span class="nt">&gt;</span><span class="err">&lt;</span>/ng-view&gt;
<a name="code--tic--tic1--tic3.html-pyg.html-21"></a>    <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-22"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/jquery.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-23"></a>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/socket.io/socket.io.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-24"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/api.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-25"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/template_handler.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-26"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/mustache.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-27"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/bootstrap.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-28"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/app.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-29"></a>
<a name="code--tic--tic1--tic3.html-pyg.html-30"></a>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-31"></a>
<a name="code--tic--tic1--tic3.html-pyg.html-32"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-inverse navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-33"></a>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-34"></a>          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-35"></a>            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-navbar&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;collapse&quot;</span> <span class="na">data-target=</span><span class="s">&quot;.nav-collapse&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-36"></a>              <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-37"></a>              <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-38"></a>              <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-39"></a>            <span class="nt">&lt;/a&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-40"></a>            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;brand&quot;</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Tic-Tac-Toe<span class="nt">&lt;/a&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-41"></a>          <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-42"></a>        <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-43"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-44"></a>
<a name="code--tic--tic1--tic3.html-pyg.html-45"></a>      <span class="c">&lt;!-- Main hero unit for a primary marketing message or call to action --&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-46"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;hero-unit&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-47"></a>        <span class="nt">&lt;h1&gt;</span>Tic Tac Toe!<span class="nt">&lt;/h1&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-48"></a>        <span class="nt">&lt;p&gt;</span>Play Tic Tac Toe against your friends in this multiplayer demo.<span class="nt">&lt;/p&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-49"></a>        <span class="nt">&lt;p&gt;&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary btn-large&quot;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-50"></a>          <span class="na">href=</span><span class="s">&quot;https://github.com/christkv/tic-tac-toe&quot;</span><span class="nt">&gt;</span>Github <span class="ni">&amp;raquo;</span><span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-51"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-52"></a>
<a name="code--tic--tic1--tic3.html-pyg.html-53"></a>      <span class="c">&lt;!-- Example row of columns --&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-54"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span> <span class="na">id=</span><span class="s">&quot;view&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-55"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-56"></a>
<a name="code--tic--tic1--tic3.html-pyg.html-57"></a>      <span class="nt">&lt;hr&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-58"></a>
<a name="code--tic--tic1--tic3.html-pyg.html-59"></a>      <span class="nt">&lt;footer&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-60"></a>        <span class="nt">&lt;p&gt;</span><span class="ni">&amp;copy;</span> Christian Kvalheim 2012<span class="nt">&lt;/p&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-61"></a>      <span class="nt">&lt;/footer&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-62"></a>
<a name="code--tic--tic1--tic3.html-pyg.html-63"></a>    <span class="nt">&lt;/div&gt;</span> <span class="c">&lt;!-- /container --&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-64"></a>    <span class="c">&lt;!-- Modal --&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-65"></a>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;status_box&quot;</span> <span class="na">class=</span><span class="s">&quot;modal hide fade&quot;</span> <span class="na">tabindex=</span><span class="s">&quot;-1&quot;</span> <span class="na">role=</span><span class="s">&quot;dialog&quot;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-66"></a>    <span class="na">aria-labelledby=</span><span class="s">&quot;status_box&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-67"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-header&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-68"></a>        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;button&quot;</span> <span class="na">class=</span><span class="s">&quot;close&quot;</span> <span class="na">data-dismiss=</span><span class="s">&quot;modal&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-69"></a>          ×
<a name="code--tic--tic1--tic3.html-pyg.html-70"></a>        <span class="nt">&lt;/button&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-71"></a>        <span class="nt">&lt;h3</span> <span class="na">id=</span><span class="s">&quot;status_box_header&quot;</span><span class="nt">&gt;</span>Modal header<span class="nt">&lt;/h3&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-72"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-73"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-body&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-74"></a>        <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;status_box_body&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-75"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-76"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-footer&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-77"></a>        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">&quot;btn&quot;</span> <span class="na">data-dismiss=</span><span class="s">&quot;modal&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>Close<span class="nt">&lt;/button&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-78"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-79"></a>    <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-80"></a>  <span class="nt">&lt;/body&gt;</span>
<a name="code--tic--tic1--tic3.html-pyg.html-81"></a><span class="nt">&lt;/html&gt;</span>
</pre></div><p>If you are wondering how this HTML works I suggest you have a look at <a class="reference external" href="http://twitter.github.com/bootstrap/index.html">http://twitter.github.com/bootstrap/index.html</a> for documentation. In short, it lets people like me with lesser well developed design abilities create websites that are not complete eyesores. Also, notice that we are including the javascript files for <tt class="docutils literal">api.js</tt>, <tt class="docutils literal">app.js</tt> and <tt class="docutils literal">template_handler.js</tt> that we <tt class="docutils literal">touched</tt> when we created the initial directory structure. These will include the actual logic for the client side part of the game and their secrets will be revealed in due time.</p>
</div>
<div class="section" id="env-js">
<h1>Env.js</h1>
<p>Let's take a quick look at <tt class="docutils literal">env.js</tt> file. If you remember the <tt class="docutils literal">app.js</tt> file you would have noticed that it contained two methods that did not exist in the <tt class="docutils literal">app.js</tt> file. The first one was <tt class="docutils literal">initialize</tt> and the second one was <tt class="docutils literal">run</tt>. Open up your editor and bring up the <tt class="docutils literal">env.js</tt> file and get coding.</p>
<div class="highlight"><pre><a name="code--tic--tic1--tic4.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)</span>
<a name="code--tic--tic1--tic4.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">).</span><span class="nx">MongoClient</span>
<a name="code--tic--tic1--tic4.js-pyg.html-3"></a>  <span class="p">,</span> <span class="nx">format</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">).</span><span class="nx">format</span>
<a name="code--tic--tic1--tic4.js-pyg.html-4"></a>  <span class="p">,</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>
<a name="code--tic--tic1--tic4.js-pyg.html-5"></a>  <span class="p">,</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">).</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
<a name="code--tic--tic1--tic4.js-pyg.html-6"></a>  <span class="p">,</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
<a name="code--tic--tic1--tic4.js-pyg.html-7"></a>  <span class="p">,</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cookie&#39;</span><span class="p">);</span>
<a name="code--tic--tic1--tic4.js-pyg.html-8"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-9"></a><span class="cm">/** </span>
<a name="code--tic--tic1--tic4.js-pyg.html-10"></a><span class="cm"> * Setting for the application</span>
<a name="code--tic--tic1--tic4.js-pyg.html-11"></a><span class="cm"> */</span>
<a name="code--tic--tic1--tic4.js-pyg.html-12"></a><span class="kd">var</span> <span class="nx">MONGO_DB_URL</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MONGO_DB</span> <span class="o">||</span> <span class="s1">&#39;mongodb://localhost:27017/tic-tac-toe&#39;</span><span class="p">;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-13"></a><span class="kd">var</span> <span class="nx">APP_HOST</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">APP_HOST</span> <span class="o">||</span> <span class="s1">&#39;localhost&#39;</span><span class="p">;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-14"></a><span class="kd">var</span> <span class="nx">APP_PORT</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">APP_PORT</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-15"></a><span class="kd">var</span> <span class="nx">SESSION_SECRET</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SESSION_SECRET</span> <span class="o">||</span> <span class="s1">&#39;CHANGE_ME&#39;</span><span class="p">;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-16"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-17"></a><span class="cm">/** </span>
<a name="code--tic--tic1--tic4.js-pyg.html-18"></a><span class="cm"> * Keeps the db connection</span>
<a name="code--tic--tic1--tic4.js-pyg.html-19"></a><span class="cm"> */</span>
<a name="code--tic--tic1--tic4.js-pyg.html-20"></a><span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-21"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-22"></a><span class="cm">/**</span>
<a name="code--tic--tic1--tic4.js-pyg.html-23"></a><span class="cm"> * Session store, for production use mongo</span>
<a name="code--tic--tic1--tic4.js-pyg.html-24"></a><span class="cm"> */</span>
<a name="code--tic--tic1--tic4.js-pyg.html-25"></a><span class="kd">var</span> <span class="nx">session_store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">express</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">MemoryStore</span><span class="p">();</span>
<a name="code--tic--tic1--tic4.js-pyg.html-26"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-27"></a><span class="cm">/**</span>
<a name="code--tic--tic1--tic4.js-pyg.html-28"></a><span class="cm"> * Set up the environment for the application</span>
<a name="code--tic--tic1--tic4.js-pyg.html-29"></a><span class="cm"> */</span>
<a name="code--tic--tic1--tic4.js-pyg.html-30"></a><span class="kd">var</span> <span class="nx">initialize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-31"></a>  <span class="cm">/**</span>
<a name="code--tic--tic1--tic4.js-pyg.html-32"></a><span class="cm">   * configure express</span>
<a name="code--tic--tic1--tic4.js-pyg.html-33"></a><span class="cm">   */</span>
<a name="code--tic--tic1--tic4.js-pyg.html-34"></a>  <span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="s1">&#39;development&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-35"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">());</span>
<a name="code--tic--tic1--tic4.js-pyg.html-36"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">cookieParser</span><span class="p">());</span>
<a name="code--tic--tic1--tic4.js-pyg.html-37"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/public&#39;</span><span class="p">));</span>
<a name="code--tic--tic1--tic4.js-pyg.html-38"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">errorHandler</span><span class="p">({</span> <span class="nx">dumpExceptions</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">showStack</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}));</span>
<a name="code--tic--tic1--tic4.js-pyg.html-39"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">session</span><span class="p">({</span>
<a name="code--tic--tic1--tic4.js-pyg.html-40"></a>      <span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;sid&#39;</span><span class="p">,</span>
<a name="code--tic--tic1--tic4.js-pyg.html-41"></a>      <span class="nx">secret</span><span class="o">:</span> <span class="nx">SESSION_SECRET</span><span class="p">,</span>
<a name="code--tic--tic1--tic4.js-pyg.html-42"></a>      <span class="nx">store</span><span class="o">:</span> <span class="nx">session_store</span>
<a name="code--tic--tic1--tic4.js-pyg.html-43"></a>    <span class="p">}));</span>
<a name="code--tic--tic1--tic4.js-pyg.html-44"></a>  <span class="p">});</span>
<a name="code--tic--tic1--tic4.js-pyg.html-45"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-46"></a>  <span class="cm">/**</span>
<a name="code--tic--tic1--tic4.js-pyg.html-47"></a><span class="cm">   * Capture the session id and make it available</span>
<a name="code--tic--tic1--tic4.js-pyg.html-48"></a><span class="cm">   */</span>
<a name="code--tic--tic1--tic4.js-pyg.html-49"></a>  <span class="nx">io</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;authorization&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">accept</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-50"></a>    <span class="c1">// check if there&#39;s a cookie header</span>
<a name="code--tic--tic1--tic4.js-pyg.html-51"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;cookie&#39;</span><span class="p">])</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-52"></a>      <span class="c1">// if there is, parse the cookie</span>
<a name="code--tic--tic1--tic4.js-pyg.html-53"></a>      <span class="nx">data</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span><span class="p">);</span>
<a name="code--tic--tic1--tic4.js-pyg.html-54"></a>      <span class="c1">// note that you will need to use the same key to grad the</span>
<a name="code--tic--tic1--tic4.js-pyg.html-55"></a>      <span class="c1">// session id, as you specified in the Express setup.</span>
<a name="code--tic--tic1--tic4.js-pyg.html-56"></a>      <span class="nx">data</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">cookie</span><span class="p">[</span><span class="s1">&#39;sid&#39;</span><span class="p">];</span>
<a name="code--tic--tic1--tic4.js-pyg.html-57"></a>      <span class="c1">// Set the user as authenticated in on the express session</span>
<a name="code--tic--tic1--tic4.js-pyg.html-58"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-59"></a>        <span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a name="code--tic--tic1--tic4.js-pyg.html-60"></a>      <span class="p">}</span>
<a name="code--tic--tic1--tic4.js-pyg.html-61"></a>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-62"></a>     <span class="c1">// if there isn&#39;t, turn down the connection with a message</span>
<a name="code--tic--tic1--tic4.js-pyg.html-63"></a>     <span class="c1">// and leave the function.</span>
<a name="code--tic--tic1--tic4.js-pyg.html-64"></a>     <span class="k">return</span> <span class="nx">accept</span><span class="p">(</span><span class="s1">&#39;No cookie transmitted.&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<a name="code--tic--tic1--tic4.js-pyg.html-65"></a>    <span class="p">}</span>
<a name="code--tic--tic1--tic4.js-pyg.html-66"></a>    <span class="c1">// accept the incoming connection</span>
<a name="code--tic--tic1--tic4.js-pyg.html-67"></a>    <span class="nx">accept</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<a name="code--tic--tic1--tic4.js-pyg.html-68"></a>  <span class="p">});</span>
<a name="code--tic--tic1--tic4.js-pyg.html-69"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-70"></a>  <span class="cm">/**</span>
<a name="code--tic--tic1--tic4.js-pyg.html-71"></a><span class="cm">   * Connect to MongoDB and start the server</span>
<a name="code--tic--tic1--tic4.js-pyg.html-72"></a><span class="cm">   */</span>
<a name="code--tic--tic1--tic4.js-pyg.html-73"></a>  <span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">MONGO_DB_URL</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">_db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-74"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--tic--tic1--tic4.js-pyg.html-75"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-76"></a>    <span class="c1">// Save the db reference</span>
<a name="code--tic--tic1--tic4.js-pyg.html-77"></a>    <span class="nx">db</span> <span class="o">=</span> <span class="nx">_db</span><span class="p">;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-78"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-79"></a>    <span class="c1">// Return the callback</span>
<a name="code--tic--tic1--tic4.js-pyg.html-80"></a>    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">);</span>
<a name="code--tic--tic1--tic4.js-pyg.html-81"></a>  <span class="p">});</span>
<a name="code--tic--tic1--tic4.js-pyg.html-82"></a><span class="p">};</span>
<a name="code--tic--tic1--tic4.js-pyg.html-83"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-84"></a><span class="kd">var</span> <span class="nx">run</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-85"></a>  <span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">APP_PORT</span><span class="p">,</span> <span class="nx">APP_HOST</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-86"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic1--tic4.js-pyg.html-87"></a>      <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a name="code--tic--tic1--tic4.js-pyg.html-88"></a>      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--tic--tic1--tic4.js-pyg.html-89"></a>    <span class="p">}</span>
<a name="code--tic--tic1--tic4.js-pyg.html-90"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-91"></a>    <span class="c1">// Print out a nice message to the console</span>
<a name="code--tic--tic1--tic4.js-pyg.html-92"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
<a name="code--tic--tic1--tic4.js-pyg.html-93"></a>        <span class="p">[</span> <span class="s2">&quot;&quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-94"></a>        <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-95"></a>        <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-96"></a>        <span class="p">,</span> <span class="s2">&quot;  — — — | — — — | — — — &quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-97"></a>        <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-98"></a>        <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-99"></a>        <span class="p">,</span> <span class="s2">&quot;  — — — | — — — | — — — &quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-100"></a>        <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-101"></a>        <span class="p">,</span> <span class="s2">&quot;        |       |&quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-102"></a>        <span class="p">,</span> <span class="s2">&quot;&quot;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-103"></a>        <span class="p">,</span> <span class="s2">&quot;tic-tac-toe server v&quot;</span> <span class="o">+</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./package.json&#39;</span><span class="p">).</span><span class="nx">version</span>
<a name="code--tic--tic1--tic4.js-pyg.html-104"></a>        <span class="p">,</span> <span class="s2">&quot;listening on port &quot;</span> <span class="o">+</span> <span class="nx">APP_PORT</span> <span class="o">+</span> <span class="s2">&quot; and host &quot;</span> <span class="o">+</span> <span class="nx">APP_HOST</span>
<a name="code--tic--tic1--tic4.js-pyg.html-105"></a>      <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">));</span>
<a name="code--tic--tic1--tic4.js-pyg.html-106"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-107"></a>    <span class="c1">// Return successful start of server</span>
<a name="code--tic--tic1--tic4.js-pyg.html-108"></a>    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a name="code--tic--tic1--tic4.js-pyg.html-109"></a>  <span class="p">});</span>
<a name="code--tic--tic1--tic4.js-pyg.html-110"></a><span class="p">}</span>
<a name="code--tic--tic1--tic4.js-pyg.html-111"></a>
<a name="code--tic--tic1--tic4.js-pyg.html-112"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">initialize</span> <span class="o">=</span> <span class="nx">initialize</span><span class="p">;</span>
<a name="code--tic--tic1--tic4.js-pyg.html-113"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">run</span> <span class="o">=</span> <span class="nx">run</span><span class="p">;</span>
</pre></div><p>So, what do the methods do? Well, the <tt class="docutils literal">intialize</tt> function sets up the <tt class="docutils literal">Express JS</tt> web framework with a <tt class="docutils literal">session</tt> store and a location for static file serving of all files under the <tt class="docutils literal">/public</tt> directory which lets us access the javascripts, css and image files from the browser. At the top of the file, you'll notice the three core lines.</p>
<pre class="code javascript literal-block">
<span class="p">,</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">(</span><span class="p">)</span>
<span class="p">,</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">).</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
<span class="p">,</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'socket.io'</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
</pre>
<p>This sets up an <tt class="docutils literal">Express JS</tt> instance and maps <tt class="docutils literal">SocketIO</tt> to the same socket so they can work together. The <tt class="docutils literal">SocketIO</tt> instance is stored in the variable <tt class="docutils literal">io</tt>. One of the things we need to ensure is that our <tt class="docutils literal">SocketIO</tt> instance can be associated with the initial web page the user loaded through a <tt class="docutils literal">Session Cookie</tt>. To do this, we need to do some mapping between the <tt class="docutils literal">SocketIO</tt> instance and the server session using our <tt class="docutils literal">Session</tt> Store. Luckily <tt class="docutils literal">SocketIO</tt> has thought about this.</p>
<p>The <tt class="docutils literal"><span class="pre">io.set('authorization',</span> <span class="pre">...)</span></tt> event occurs when the web page is first loaded and a <tt class="docutils literal">SocketIO</tt> connection is made. When the connection happens, the code looks up the <tt class="docutils literal">Session Cookie</tt> set by <tt class="docutils literal">Express JS</tt> and adds it to the <tt class="docutils literal">SocketIO</tt> connection. This makes it possible for the application to identify which user is associated with which <tt class="docutils literal">SocketIO</tt> connection and future exercises will show how we use this to communicate between two specific users.</p>
<p>Lastly, we call <tt class="docutils literal">MongoClient.connect</tt> to connect to the <tt class="docutils literal">MongoDB</tt> server and if all works well, we'll return to the calling code in <tt class="docutils literal">app.js</tt>. When <tt class="docutils literal">app.js</tt> calls the <tt class="docutils literal">run</tt> method in <tt class="docutils literal">env.js</tt>, the <tt class="docutils literal">Express JS</tt> server starts up and we print the welcome message to the console. Before we can boot up, we need a <tt class="docutils literal">MongoDB</tt> server. Open another terminal and go to the project directory. Let's start a new server.</p>
<pre class="code console literal-block">
<span class="go">mkdir data
mongod --dbpath=./data</span>
</pre>
<p>In your previous terminal, start the application (make sure your node.js executable is in your path).</p>
<pre class="code console literal-block">
<span class="go">node app.js</span>
</pre>
<p>You can now go to <tt class="docutils literal"><span class="pre">http://localhost:3000</span></tt> and see the initial page running in your browser. Awesome, right? Now that we have the basic scaffolding in place, we can move on to the next exercise where we will create the <tt class="docutils literal">login</tt> and <tt class="docutils literal">registration</tt> API's.</p>
</div>
    </div>

    <div class="one columns" id="right-nav">
        <center>
        <p><a href="/book/"><img src="images/48_structure.png"></a></p>
        <p><a href="#"><img src="images/48_email.png"></a></p>
        <p><a href="#faq"><img src="images/48_faq.png"></a></p>
        <p>
        </p>
        </center>
    </div>

  <!-- Included JS Files (Compressed) -->
  <script src="javascripts/jquery.js"></script>
  <script src="javascripts/foundation.min.js"></script>
  
  <!-- Initialize JS Plugins -->
  <script src="javascripts/app.js"></script>

</body>
</html>