
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tic-Tac-Toe: Exercise 3 &mdash; Learn MongoDB And Node.js The Hard Way</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Learn MongoDB And Node.js The Hard Way" href="index.html" />
    <link rel="next" title="Tic-Tac-Toe: Exercise 4" href="tic4.html" />
    <link rel="prev" title="Tic-Tac-Toe: Exercise 2" href="tic2.html" /> 
  </head>
  <body>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="tic4.html" title="Tic-Tac-Toe: Exercise 4"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="tic2.html" title="Tic-Tac-Toe: Exercise 2"
             accesskey="P">previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>



    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="tic-tac-toe-exercise-3">
<h1>Tic-Tac-Toe: Exercise 3<a class="headerlink" href="#tic-tac-toe-exercise-3" title="Permalink to this headline">¶</a></h1>
<p>In this exercise we are going to start implementing the process of selecting a player to play against, and playing the game itself. This is where the code gets really interesting. The first step is to display a list of available gamers that we can invite to a game. Next for the invitation to a game we need to handle the invite and accept/reject game mechanics for the game.</p>
<p>The final functionality we are going to implement in this exercise is to actually create the game board and handle the playing of the game.</p>
<div class="section" id="where-is-the-code">
<h2>Where Is The Code<a class="headerlink" href="#where-is-the-code" title="Permalink to this headline">¶</a></h2>
<p>The code for this exercise is located at</p>
<p><a class="reference external" href="https://github.com/christkv/tic-tac-toe-steps/tree/step2">https://github.com/christkv/tic-tac-toe-steps/tree/step2</a></p>
</div>
<div class="section" id="the-glue-of-it-all">
<h2>The Glue Of It All<a class="headerlink" href="#the-glue-of-it-all" title="Permalink to this headline">¶</a></h2>
<p>The first thing we need to do is to be able to retrieve a list of all the available gamers. To do this we are going to create a new set of API calls for the gamer as well as extend our current <tt class="docutils literal"><span class="pre">Gamer</span></tt> model class with some more methods. Let's start with the <tt class="docutils literal"><span class="pre">Gamer</span></tt> model. Bring up the file <tt class="docutils literal"><span class="pre">lib/models/gamer.js</span></tt> with an editor and let's add the missing <tt class="docutils literal"><span class="pre">API</span></tt> calls.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Gamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>

  <span class="c1">//</span>
  <span class="c1">// Locate a gamer by his session id</span>
  <span class="c1">//</span>
  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">findGamerBySid</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">).</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">sid</span><span class="o">:</span> <span class="nx">sid</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">//</span>
  <span class="c1">// Locate a list of gamers by their session ids</span>
  <span class="c1">//</span>
  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">findAllGamersBySids</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sids</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">({</span><span class="nx">sid</span><span class="o">:</span> <span class="p">{</span><span class="nx">$in</span><span class="o">:</span> <span class="nx">sids</span><span class="p">}}).</span><span class="nx">toArray</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">//</span>
  <span class="c1">// Update the last active time for a list of gamers by their session ids</span>
  <span class="c1">//</span>
  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">updateGamersUpdatedDateBySids</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sids</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">({</span><span class="nx">sid</span><span class="o">:</span><span class="p">{</span><span class="nx">$in</span><span class="o">:</span> <span class="nx">sids</span><span class="p">}},</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">updated_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()}},</span> <span class="p">{</span><span class="nx">multi</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">//</span>
  <span class="c1">// Update a gamers current activity time and session id</span>
  <span class="c1">// when they come back after some time away</span>
  <span class="c1">//</span>
  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">updateGamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">sid</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">({</span><span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span><span class="p">}</span>
      <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">updated_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span> <span class="nx">sid</span><span class="o">:</span><span class="nx">sid</span><span class="p">}}</span>
      <span class="p">,</span> <span class="p">{</span><span class="nx">upsert</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">//</span>
  <span class="c1">// Initialize the gamer collection, by adding indexes etc</span>
  <span class="c1">//</span>
  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">).</span><span class="nx">ensureIndex</span><span class="p">({</span><span class="nx">updated_on</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">expireAfterSeconds</span><span class="o">:</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)},</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">Gamer</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The first method <tt class="docutils literal"><span class="pre">Gamer.findAllGamersBySids</span></tt> lets us locate all the gamers associated with a list of <tt class="docutils literal"><span class="pre">SocketIO</span></tt> session ids. This method is used to get the list of all currently active users. The second method <tt class="docutils literal"><span class="pre">Gamer.updateGamersUpdatedDateBySids</span></tt> is used to update the last active time on a set of users identified by their session ids (remember that the <tt class="docutils literal"><span class="pre">gamers</span></tt> collection is a <tt class="docutils literal"><span class="pre">TTL</span></tt> collection that times out active gamers after 1 hour).</p>
</div>
<div class="section" id="the-game-model">
<h2>The Game Model<a class="headerlink" href="#the-game-model" title="Permalink to this headline">¶</a></h2>
<p>We are going to introduce a concept of a <tt class="docutils literal"><span class="pre">Game</span></tt>. A <tt class="docutils literal"><span class="pre">Game</span></tt> keeps track of a specific game between two players in the application. We need to implement a set of functions to handle the transitions of the game over time.</p>
<table border="1" class="docutils">
<colgroup>
<col width="32%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Function</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>create_gamer</td>
<td>Create a brand new game for two players</td>
</tr>
<tr class="row-odd"><td>find_name</td>
<td>Locate an existing game by the game id</td>
</tr>
<tr class="row-even"><td>update_board</td>
<td>Update an existing board with the board state</td>
</tr>
<tr class="row-odd"><td>finalize_board</td>
<td>Sets the final state of the board (won/draw)</td>
</tr>
</tbody>
</table>
<p>Let's create the files we need.</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">touch lib/handlers/gamer_handler.js</span>
<span class="go">touch lib/models/game.js</span>
</pre></div>
</td></tr></table></div>
<p>Open the <tt class="docutils literal"><span class="pre">lib/models/game.js</span></tt> file and lets enter the code for the methods we need for the application <tt class="docutils literal"><span class="pre">Game.create_gamer</span></tt>, <tt class="docutils literal"><span class="pre">Game.find_name</span></tt>, <tt class="docutils literal"><span class="pre">Game.update_board</span></tt> and <tt class="docutils literal"><span class="pre">Game.finalize_board</span></tt>.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">ObjectID</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">).</span><span class="nx">ObjectID</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>

  <span class="c1">//</span>
  <span class="c1">// Create a new game, it contains all the information about the two players, the empty board, the whole</span>
  <span class="c1">// game chat record, who is starting the game and who is the current player.</span>
  <span class="c1">// </span>
  <span class="nx">Game</span><span class="p">.</span><span class="nx">create_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p1_sid</span><span class="p">,</span> <span class="nx">p1_user_name</span><span class="p">,</span> <span class="nx">p1_full_name</span><span class="p">,</span> <span class="nx">p2_sid</span><span class="p">,</span> <span class="nx">p2_user_name</span><span class="p">,</span> <span class="nx">p2_full_name</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">insert</span><span class="p">({</span>
        <span class="nx">player1_sid</span><span class="o">:</span> <span class="nx">p1_sid</span>
      <span class="p">,</span> <span class="nx">player1_user_name</span><span class="o">:</span> <span class="nx">p1_user_name</span>
      <span class="p">,</span> <span class="nx">player1_full_name</span><span class="o">:</span> <span class="nx">p1_full_name</span>
      <span class="p">,</span> <span class="nx">player2_sid</span><span class="o">:</span> <span class="nx">p2_sid</span>
      <span class="p">,</span> <span class="nx">player2_user_name</span><span class="o">:</span> <span class="nx">p2_user_name</span>
      <span class="p">,</span> <span class="nx">player2_full_name</span><span class="o">:</span> <span class="nx">p2_full_name</span>
      <span class="p">,</span> <span class="nx">board</span><span class="o">:</span> <span class="p">[</span>
          <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
      <span class="p">]</span>
      <span class="p">,</span> <span class="nx">created_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
      <span class="p">,</span> <span class="nx">starting_player</span><span class="o">:</span> <span class="nx">p1_sid</span>
      <span class="p">,</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">p1_sid</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">?</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">result</span><span class="p">);</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="c1">//</span>
  <span class="c1">// Locate an existing game by it&#39;s game id</span>
  <span class="c1">//</span>
  <span class="nx">Game</span><span class="p">.</span><span class="nx">find_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">doc</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;could not find the game with id &quot;</span> <span class="o">+</span> <span class="nx">game_id</span><span class="p">));</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">doc</span><span class="p">);</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="c1">//</span>
  <span class="c1">// Attempt to update the board for a specific game and player</span>
  <span class="c1">// the update fails if the current players is not the player attempting to update the board</span>
  <span class="c1">// notice that since we are doing multiple sets we are using the $atomic operation to ensure</span>
  <span class="c1">// we don&#39;t get any interleaved updates in between the two sets</span>
  <span class="c1">//</span>
  <span class="nx">Game</span><span class="p">.</span><span class="nx">update_board</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">game_id</span><span class="p">,</span> <span class="nx">next_sid</span><span class="p">,</span> <span class="nx">board</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
        <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">),</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">sid</span><span class="p">,</span> <span class="nx">$atomic</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
      <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">board</span><span class="o">:</span> <span class="nx">board</span><span class="p">,</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">next_sid</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;It is not your turn&quot;</span><span class="p">));</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">//</span>
  <span class="c1">// Set the winner on the board if sid == null it&#39;s a draw</span>
  <span class="c1">//</span>
  <span class="nx">Game</span><span class="p">.</span><span class="nx">finalize_board</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">game_id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">sid</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s1">&#39;draw&#39;</span> <span class="o">:</span> <span class="s1">&#39;win&#39;</span><span class="p">;</span>

    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
        <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">)}</span>
      <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">final_state</span><span class="o">:</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">winner</span><span class="o">:</span> <span class="nx">sid</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Failed to finalize the board with a winner or draw&quot;</span><span class="p">));</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="p">});</span>    
  <span class="p">}</span>  

  <span class="c1">// Return Game object class</span>
  <span class="k">return</span> <span class="nx">Game</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Let's start off with the <tt class="docutils literal"><span class="pre">Game.create_game</span></tt> function. As we can see it takes quite a bit of parameters.</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parameter</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>p1_sid</td>
<td>The session id for player 1</td>
</tr>
<tr class="row-odd"><td>p1_user_name</td>
<td>The user name of player 1</td>
</tr>
<tr class="row-even"><td>p1_full_name</td>
<td>The full name of player 1</td>
</tr>
<tr class="row-odd"><td>p2_sid</td>
<td>The session id for player 2</td>
</tr>
<tr class="row-even"><td>p2_user_name</td>
<td>The user name of player 2</td>
</tr>
<tr class="row-odd"><td>p2_full_name</td>
<td>The full name of player 2</td>
</tr>
</tbody>
</table>
<p>The <tt class="docutils literal"><span class="pre">Game.create_game</span></tt> method creates a new game document representing the starting state of a game between two players.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="p">{</span>
    <span class="nx">player1_sid</span><span class="o">:</span> <span class="s2">&quot;some session id 1&quot;</span>
  <span class="p">,</span> <span class="nx">player1_user_name</span><span class="o">:</span> <span class="s2">&quot;player1&quot;</span>
  <span class="p">,</span> <span class="nx">player1_full_name</span><span class="o">:</span> <span class="s2">&quot;Joe Player 1&quot;</span>
  <span class="p">,</span> <span class="nx">player2_sid</span><span class="o">:</span> <span class="s2">&quot;some session id 2&quot;</span>
  <span class="p">,</span> <span class="nx">player2_user_name</span><span class="o">:</span> <span class="s2">&quot;player2&quot;</span>
  <span class="p">,</span> <span class="nx">player2_full_name</span><span class="o">:</span> <span class="s2">&quot;Joe Player 2&quot;</span>
  <span class="p">,</span> <span class="nx">board</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
  <span class="p">]</span>
  <span class="p">,</span> <span class="nx">created_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
  <span class="p">,</span> <span class="nx">starting_player</span><span class="o">:</span> <span class="s2">&quot;some session id 1&quot;</span>
  <span class="p">,</span> <span class="nx">current_player</span><span class="o">:</span> <span class="s2">&quot;some session id 1&quot;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The first six values in the document (<tt class="docutils literal"><span class="pre">player1_sid</span></tt>, <tt class="docutils literal"><span class="pre">player1_user_name</span></tt>, <tt class="docutils literal"><span class="pre">player1_full_name</span></tt>, <tt class="docutils literal"><span class="pre">player2_sid</span></tt>, <tt class="docutils literal"><span class="pre">player2_user_name</span></tt> and <tt class="docutils literal"><span class="pre">player2_full_name</span></tt>) are the ones passed to the function and define who the two players are. The next field down is the <tt class="docutils literal"><span class="pre">board</span></tt> field that contains A <tt class="docutils literal"><span class="pre">2D</span></tt> representation of the <tt class="docutils literal"><span class="pre">Tic-Tac-Toe</span></tt> board where we will store the state of the game.</p>
<p>The <tt class="docutils literal"><span class="pre">created_on</span></tt> field contains the date of when the game was created. The <tt class="docutils literal"><span class="pre">starting_player</span></tt> field is the session id of the player that gets the first move and the <tt class="docutils literal"><span class="pre">current_player</span></tt> field is the session id of player who has the next move. This field is used to make sure only the player who has the next move can update the state of the board.</p>
<p>Next, let's look at the <tt class="docutils literal"><span class="pre">Game.find_game</span></tt> method. Not much to say here. Each <tt class="docutils literal"><span class="pre">Game</span></tt> document has a <tt class="docutils literal"><span class="pre">_id</span></tt> field containing an <tt class="docutils literal"><span class="pre">ObjectID</span></tt> assigned to it by <tt class="docutils literal"><span class="pre">MongoDB</span></tt> and this method lets us locate a board using that <tt class="docutils literal"><span class="pre">ObjectID</span></tt>.</p>
<p>The <tt class="docutils literal"><span class="pre">Game.update_board</span></tt> method handles the updating of a game between two players.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">Game</span><span class="p">.</span><span class="nx">update_board</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">game_id</span><span class="p">,</span> <span class="nx">next_sid</span><span class="p">,</span> <span class="nx">board</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
      <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">),</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">sid</span><span class="p">,</span> <span class="nx">$atomic</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">board</span><span class="o">:</span> <span class="nx">board</span><span class="p">,</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">next_sid</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;It is not your turn&quot;</span><span class="p">));</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The parameters passed passed into <tt class="docutils literal"><span class="pre">Game.update_board</span></tt> are used to locate a board where the <tt class="docutils literal"><span class="pre">game_id</span></tt> and <tt class="docutils literal"><span class="pre">current_player</span></tt> match. This will only happen when the caller attempting to update the board is the current player allowed to make a move. If it's not the current player the number of documents that were updated will be 0 and the method returns an error explaining that it's not that users turn to place a marker on the board.</p>
<p>If it is the callers turn to place a marker the function updates the <tt class="docutils literal"><span class="pre">board</span></tt> field of the document with the new document state and sets the <tt class="docutils literal"><span class="pre">current_player</span></tt> to the session id of the other player allowing the other player to play his turn next.</p>
<p>Finally let's look at the <tt class="docutils literal"><span class="pre">Game.finalize_board</span></tt> where we set the final state of a game after the game is done.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1">//</span>
<span class="c1">// Set the winner on the board if sid == null it&#39;s a draw</span>
<span class="c1">//</span>
<span class="nx">Game</span><span class="p">.</span><span class="nx">finalize_board</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">game_id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">sid</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s1">&#39;draw&#39;</span> <span class="o">:</span> <span class="s1">&#39;win&#39;</span><span class="p">;</span>

  <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
      <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">)}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">final_state</span><span class="o">:</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">winner</span><span class="o">:</span> <span class="nx">sid</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Failed to finalize the board with a winner or draw&quot;</span><span class="p">));</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>If the session id passed in is a <tt class="docutils literal"><span class="pre">null</span></tt> value it's a draw and the <tt class="docutils literal"><span class="pre">final_state</span></tt> field is set to <tt class="docutils literal"><span class="pre">draw</span></tt> and the winner field to <tt class="docutils literal"><span class="pre">null</span></tt>. Otherwise the <tt class="docutils literal"><span class="pre">final_state</span></tt> field is set to <tt class="docutils literal"><span class="pre">win</span></tt> and the <tt class="docutils literal"><span class="pre">winner</span> <span class="pre">field</span></tt> to the winners session id.</p>
<p>We can now create, locate and update as well as finalize a game correctly and also ensure that a board is never updated by a user who's not currently allowed to.</p>
</div>
<div class="section" id="the-game-handler">
<h2>The Game Handler<a class="headerlink" href="#the-game-handler" title="Permalink to this headline">¶</a></h2>
<p>Some of the things we need to ensure is that we should not be able to call functions unless we are correctly logged in as a gamer. We also need to have a way to locate a given <tt class="docutils literal"><span class="pre">SocketIO</span></tt> socket given only another users session id.</p>
<p>For the first part we will implement a method called <tt class="docutils literal"><span class="pre">is_authenticated</span></tt> and for the second part a method called <tt class="docutils literal"><span class="pre">locate_connection_with_session</span></tt>. Bring up the file <tt class="docutils literal"><span class="pre">lib/models/shared.js</span></tt> and add the methods as shown below.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">is_authenticated</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">].</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Emit the standard error message across the SocketIO connection</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">emit_error</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">socket</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">socket</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
        <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span><span class="kc">true</span>
        <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
      <span class="p">});</span>          
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
      <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
      <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span><span class="kc">true</span>
      <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
    <span class="p">});</span>    
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Emit the standard message across the SocketIO connection</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">emit_message</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Add event</span>
  <span class="nx">message</span><span class="p">.</span><span class="nx">event</span> <span class="o">=</span> <span class="nx">event</span><span class="p">;</span>
  <span class="c1">// Emit</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Locate a specific connection by it&#39;s session id of all connections available</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">locate_connection_with_session</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">sid</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">clients</span><span class="p">();</span>

  <span class="c1">// Locate our session id</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">==</span> <span class="nx">sid</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Emit a message to all clients minus the excluded session id connection</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">emit_message_all</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">exclude_sid</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">clients</span><span class="p">();</span>

  <span class="c1">// Locate our session id</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">!=</span> <span class="nx">exclude_sid</span> 
      <span class="o">&amp;&amp;</span> <span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span>
      <span class="o">&amp;&amp;</span> <span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">].</span><span class="nx">user_name</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span> 

<span class="nx">exports</span><span class="p">.</span><span class="nx">is_authenticated</span>                <span class="o">=</span> <span class="nx">is_authenticated</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">emit_error</span>                      <span class="o">=</span> <span class="nx">emit_error</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">emit_message</span>                    <span class="o">=</span> <span class="nx">emit_message</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">locate_connection_with_session</span>  <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">emit_message_all</span>                <span class="o">=</span> <span class="nx">emit_message_all</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>Alright we have the plumbing we need. It's time to implement the logic we need for the game on the backend. Let's open up the <tt class="docutils literal"><span class="pre">lib/handlers/gamer_handler.js</span></tt> file and get typing.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">emit_message</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_message</span>
  <span class="p">,</span> <span class="nx">is_authenticated</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">is_authenticated</span>
  <span class="p">,</span> <span class="nx">locate_connection_with_session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">locate_connection_with_session</span>
  <span class="p">,</span> <span class="nx">emit_error</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_error</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/user&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/gamer&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">game</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/game&#39;</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Locate all the available gamers by their session ids. We do this by introspecting</span>
<span class="cm"> * all available connections for SocketIO. However note that if we wanted to use</span>
<span class="cm"> * the cluster functionality in Node.JS we would probably have to rewrite this as</span>
<span class="cm"> * a lot of the users might be living in different processes and by default SocketIO</span>
<span class="cm"> * is only single process aware.</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">find_all_available_gamers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages</span>
  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;find_all_available_gamers&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling function if it&#39;s not the case</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
    
    <span class="c1">// Locate all active socket connections</span>
    <span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">clients</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">sids</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="c1">// Find all the users session ids excluding the calling functions</span>
    <span class="c1">// this makes up all current active gamers</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">!=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sids</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Locate all the gamers by their session ids</span>
    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findAllGamersBySids</span><span class="p">(</span><span class="nx">sids</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If there is an error during the query return it to the calling function</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>    

      <span class="c1">// Update All the gamers last active time</span>
      <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">updateGamersUpdatedDateBySids</span><span class="p">(</span><span class="nx">sids</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If there is an error during the update return it to the calling function</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>    

        <span class="c1">// Emit the list of gamers to the calling function on the client</span>
        <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
          <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">gamers</span>
        <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>    
      <span class="p">});</span>
    <span class="p">});</span>    
  <span class="p">}</span> 
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Invite a gamer to play a game</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">invite_gamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages</span>
  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;invite_gamer&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;game_invite&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling function if it&#39;s not the case</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Locate the destination connection</span>
    <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>

    <span class="c1">// If there is no connection it means the other player went away, send an error message</span>
    <span class="c1">// to the calling function on the client</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Invited user is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Grab our session id</span>
    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>

    <span class="c1">// Locate our gamer object using our session id</span>
    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findGamerBySid</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamer_doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If there is an error during the query return it to the calling function</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>    
      
      <span class="c1">// Invite the other player to play a game with the</span>
      <span class="c1">// calling player, we send the calling players session id and his gamer information</span>
      <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">sid</span><span class="o">:</span> <span class="nx">our_sid</span>
          <span class="p">,</span> <span class="nx">gamer</span><span class="o">:</span> <span class="nx">gamer_doc</span>          
        <span class="p">}</span>
      <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>    
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Handles the users decision to decline an invitation to a game</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">decline_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages</span>
  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;decline_game&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;invite_gamer&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling function if it&#39;s not the case</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Grab our session id</span>
    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
    <span class="c1">// Locate the destination connection</span>
    <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>

    <span class="c1">// If there is no connection it means the other player went away, send an error message</span>
    <span class="c1">// to the calling function on the client</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Send an error to the player who sent the invite, outlining the decline of the offer</span>
    <span class="c1">// to play a game</span>
    <span class="nx">emit_error</span><span class="p">(</span><span class="nx">invite_gamer</span><span class="p">,</span> <span class="s2">&quot;User declined game&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Handles the users decision to accept an invitation to play a game</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">accept_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages</span>
  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;accept_game&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;invite_gamer&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling function if it&#39;s not the case</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
    <span class="c1">// Our session id</span>
    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
    <span class="c1">// Locate the destination connection</span>
    <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>

    <span class="c1">// If there is no connection it means the other player went away, send an error message</span>
    <span class="c1">// to the calling function on the client</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>    

    <span class="c1">// Locate both the calling player and the destination player by their session ids</span>
    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findAllGamersBySids</span><span class="p">([</span><span class="nx">our_sid</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">players</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error notify both the inviter and the invited player about an error</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="nx">players</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">emit_error</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="s2">&quot;Failed to locate players for game acceptance&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Failed to locate players for game acceptance&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// Grab player 1 and player 2 from the results</span>
      <span class="kd">var</span> <span class="nx">p1</span> <span class="o">=</span> <span class="nx">players</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">p2</span> <span class="o">=</span> <span class="nx">players</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      
      <span class="c1">// Create a new game with player 1 and player 2</span>
      <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">create_game</span><span class="p">(</span><span class="nx">p1</span><span class="p">.</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">p1</span><span class="p">.</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">p1</span><span class="p">.</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">full_name</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game_doc</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If we have an error notify both the inviter and the invited player about an error</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">emit_error</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="s2">&quot;Failed to create a new game&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Failed to create a new game&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// We have a new game, notify both players about the new game information</span>
        <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">game_doc</span> <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
        <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">game_doc</span> <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Handles the users decision to accept an invitation to play a game</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">place_marker</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages</span>
  <span class="kd">var</span> <span class="nx">calling_method_name</span>      <span class="o">=</span> <span class="s2">&quot;place_marker&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name_move</span>          <span class="o">=</span> <span class="s2">&quot;game_move&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name_game_over</span>     <span class="o">=</span> <span class="s2">&quot;game_over&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling function if it&#39;s not the case</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
    <span class="c1">// Grab our session id</span>
    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>

    <span class="c1">// Locate the game we want to place a marker on</span>
    <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">find_game</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game_doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If there is an error during the query return it to the calling function</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Could not find the game&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

      <span class="c1">// Let&#39;s get the current board in play</span>
      <span class="kd">var</span> <span class="nx">board</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">board</span><span class="p">;</span>
      <span class="c1">// Get the marker for the calling player (if we are the starting player we are X)</span>
      <span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">starting_player</span> <span class="o">==</span> <span class="nx">our_sid</span> <span class="o">?</span> <span class="s2">&quot;x&quot;</span> <span class="o">:</span> <span class="s2">&quot;o&quot;</span><span class="p">;</span>
      
      <span class="c1">// Locate other players session id</span>
      <span class="kd">var</span> <span class="nx">other_player_sid</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span> <span class="o">==</span> <span class="nx">our_sid</span> <span class="o">?</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player2_sid</span> <span class="o">:</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span><span class="p">;</span>

      <span class="c1">// If we are trying to set a cell that&#39;s already set emit an error to the calling function</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span> <span class="o">||</span> <span class="nx">board</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span> 
        <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Cell already selected&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);;</span>

      <span class="c1">// Mark the cell with our marker</span>
      <span class="nx">board</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="nx">marker</span><span class="p">;</span>

      <span class="c1">// Attempt to update the board</span>
      <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">update_board</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">other_player_sid</span><span class="p">,</span> <span class="nx">board</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If we have an error it was not our turn</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Not your turn&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

        <span class="c1">// Locate the destination connection</span>
        <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">other_player_sid</span><span class="p">);</span>
  
        <span class="c1">// If there is no connection it means the other player went away, send an error message</span>
        <span class="c1">// to the calling function on the client</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

        <span class="c1">// Emit valid move message to caller and the other player</span>
        <span class="c1">// this notifies the clients that they can draw the marker on the board</span>
        <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
          <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">y</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="o">:</span> <span class="nx">marker</span><span class="p">}</span> <span class="p">}</span>
          <span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>        
        <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_move</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
          <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">y</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="o">:</span> <span class="nx">marker</span><span class="p">}</span> <span class="p">}</span>
          <span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>

        <span class="c1">// If there was no winner this turn</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">is_game_over</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="p">)</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// If there are still fields left on the board, let&#39;s keep playing</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_game_draw</span><span class="p">(</span><span class="nx">board</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

          <span class="c1">// Set the winner</span>
          <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">finalize_board</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If we have an error it was not our turn</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Failed to set winner on table&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
            
            <span class="c1">// If there are no open spots left on the board the game</span>
            <span class="c1">// is a draw</span>
            <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">draw</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span> <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>        
            <span class="k">return</span> <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">draw</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span> <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>          
          <span class="p">});</span>
        <span class="p">}</span>

        <span class="c1">// Set the winner</span>
        <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">finalize_board</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// If we have an error it was not our turn</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Failed to set winner on table&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

          <span class="c1">// There was a winner and it was the last user to place a marker (the calling client)</span>
          <span class="c1">// signal both players who won the game</span>
          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">winner</span><span class="o">:</span> <span class="nx">our_sid</span><span class="p">}</span> <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>        
          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">winner</span><span class="o">:</span> <span class="nx">our_sid</span><span class="p">}</span> <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">})</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Checks if all the spaces in the board have been used</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">is_game_draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">board</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Checks from a given marker position if it&#39;s a winner</span>
<span class="cm"> * on the horizontal, vertical or diagonal</span>
<span class="cm"> *</span>
<span class="cm"> * [0, 0, 0] [0, 1, 0] [1, 0, 0] [0, 0, 1]</span>
<span class="cm"> * [1, 1, 1] [0, 1, 0] [0, 1, 0] [0, 1, 0]</span>
<span class="cm"> * [0, 0, 0] [0, 1, 0] [0, 0, 1] [1, 0, 0]</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">is_game_over</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Check the x and y for the following ranges</span>
  <span class="kd">var</span> <span class="nx">found_vertical</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">found_horizontal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c1">// y and x = 0 to x = n</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found_horizontal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// Found a winning position</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">found_horizontal</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c1">// x and y = 0 to y = n</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found_vertical</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Found a winning position</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">found_vertical</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c1">// 0, 0 to n, n along the diagonal</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Found a winning position</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">found_diagonal</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="c1">// Reset found diagonal</span>
  <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c1">// n, 0 to 0, n along the diagonal</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Return result of looking in the diagonal</span>
  <span class="k">return</span> <span class="nx">found_diagonal</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Export functions</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">find_all_available_gamers</span> <span class="o">=</span> <span class="nx">find_all_available_gamers</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">invite_gamer</span>              <span class="o">=</span> <span class="nx">invite_gamer</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">accept_game</span>               <span class="o">=</span> <span class="nx">accept_game</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">decline_game</span>              <span class="o">=</span> <span class="nx">decline_game</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">place_marker</span>              <span class="o">=</span> <span class="nx">place_marker</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">is_game_over</span>              <span class="o">=</span> <span class="nx">is_game_over</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="the-find-all-available-gamers-handler">
<h2>The find_all_available_gamers Handler<a class="headerlink" href="#the-find-all-available-gamers-handler" title="Permalink to this headline">¶</a></h2>
<p>You might have noticed that the file is fairly big so we will go through each method in turn to make it more manageable. Let's start with the <tt class="docutils literal"><span class="pre">find_all_available_gamers</span></tt> method. This method retrieves a list of all <tt class="docutils literal"><span class="pre">Gamer</span></tt> documents for gamers who are currently active (as in connected to the server using <tt class="docutils literal"><span class="pre">SocketIO</span></tt>)</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Locate all the available gamers by their session ids. We do this by introspecting</span>
<span class="cm"> * all available connections for SocketIO. However note that if we wanted to use</span>
<span class="cm"> * the cluster functionality in Node.JS we would probably have to rewrite this as</span>
<span class="cm"> * a lot of the users might be living in different processes and by default SocketIO</span>
<span class="cm"> * is only single process aware.</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">find_all_available_gamers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages</span>
  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;find_all_available_gamers&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling function if it&#39;s not the case</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Locate all active socket connections</span>
    <span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">clients</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">sids</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="c1">// Find all the users session ids excluding the calling functions</span>
    <span class="c1">// this makes up all current active gamers</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">!=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sids</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Locate all the gamers by their session ids</span>
    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findAllGamersBySids</span><span class="p">(</span><span class="nx">sids</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If there is an error during the query return it to the calling function</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

      <span class="c1">// Update All the gamers last active time</span>
      <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">updateGamersUpdatedDateBySids</span><span class="p">(</span><span class="nx">sids</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If there is an error during the update return it to the calling function</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

        <span class="c1">// Emit the list of gamers to the calling function on the client</span>
        <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
          <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">gamers</span>
        <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The very start of the method performs an <tt class="docutils literal"><span class="pre">is_authenticated</span></tt> verifying that the socket passed in is an authenticated session. If it's not valid we return an error notifying the user that they are not authenticated and unable to call this method. If the caller is authenticated we get all active <tt class="docutils literal"><span class="pre">SocketIO</span></tt> clients and get a list of all session ids for active players. Once we have the list of active players we retrieve all the <tt class="docutils literal"><span class="pre">Gamer</span></tt> documents associated with those session ids, and finally update the last active time stamp for those players before returning the list to the caller.</p>
</div>
<div class="section" id="the-invite-gamer-handler">
<h2>The invite_gamer Handler<a class="headerlink" href="#the-invite-gamer-handler" title="Permalink to this headline">¶</a></h2>
<p>The next method concerns the act of inviting another player to play a game. Let's have a look at the code.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Invite a gamer to play a game</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">invite_gamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages</span>
  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;invite_gamer&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;game_invite&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling function if it&#39;s not the case</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Locate the destination connection</span>
    <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>

    <span class="c1">// If there is no connection it means the other player went away, send an error message</span>
    <span class="c1">// to the calling function on the client</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Invited user is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Grab our session id</span>
    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>

    <span class="c1">// Locate our gamer object using our session id</span>
    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findGamerBySid</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamer_doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If there is an error during the query return it to the calling function</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

      <span class="c1">// Invite the other player to play a game with the</span>
      <span class="c1">// calling player, we send the calling players session id and his gamer information</span>
      <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">sid</span><span class="o">:</span> <span class="nx">our_sid</span>
          <span class="p">,</span> <span class="nx">gamer</span><span class="o">:</span> <span class="nx">gamer_doc</span>
        <span class="p">}</span>
      <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>So just as in the <tt class="docutils literal"><span class="pre">find_all_available_gamers</span></tt> method this method can only be called if the caller is authenticated correctly. Notice how we are calling the <tt class="docutils literal"><span class="pre">locate_connection_with_session</span></tt> method. We only have the session id of the player we wish to invite to a game, so we use this function to locate their <tt class="docutils literal"><span class="pre">SocketIO</span></tt> socket allowing us to communicate with them.</p>
<p>If no connection is found we notify the caller about the missing player, otherwise we locate the <tt class="docutils literal"><span class="pre">Gamer</span></tt> instance for the player and send them a <tt class="docutils literal"><span class="pre">game_invite</span></tt> message so they get notified about the invitation. The <tt class="docutils literal"><span class="pre">game_invite</span></tt> message includes the session id of the gamer making the invitation and the <tt class="docutils literal"><span class="pre">Gamer</span></tt> document of the inviting player allowing the invited player to know who sent the invite.</p>
</div>
<div class="section" id="the-decline-game-handler">
<h2>The decline_game Handler<a class="headerlink" href="#the-decline-game-handler" title="Permalink to this headline">¶</a></h2>
<p>The next method covers the case where the invited gamer decides to decline the invitation to play a game. Let's take a look at the code for the <tt class="docutils literal"><span class="pre">decline_game</span></tt> method.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Handles the users decision to decline an invitation to a game</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">decline_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages</span>
  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;decline_game&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;invite_gamer&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling function if it&#39;s not the case</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Grab our session id</span>
    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
    <span class="c1">// Locate the destination connection</span>
    <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>

    <span class="c1">// If there is no connection it means the other player went away, send an error message</span>
    <span class="c1">// to the calling function on the client</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Send an error to the player who sent the invite, outlining the decline of the offer</span>
    <span class="c1">// to play a game</span>
    <span class="nx">emit_error</span><span class="p">(</span><span class="nx">invite_gamer</span><span class="p">,</span> <span class="s2">&quot;User declined game&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The premise for this method is that the player that received the game invitation decides to decline the invitation. Since the invitation contains the inviting users session id we can locate the connection associated with this session id and if it's present, issue the decline as an error to that users <tt class="docutils literal"><span class="pre">SocketIO</span></tt> socket.</p>
<p>Remember how an <tt class="docutils literal"><span class="pre">API</span></tt> method in the frontend registers a callback with an event waiting for a return message from <tt class="docutils literal"><span class="pre">SocketIO</span></tt> containing that event. In the <tt class="docutils literal"><span class="pre">invite_gamer</span></tt> handler we did not actually issue a message with the event <tt class="docutils literal"><span class="pre">invite_gamer</span></tt>. This left the calling method on the frontend waiting for a message with the <tt class="docutils literal"><span class="pre">invite_gamer</span></tt> event. We now notify the original inviter that the game invitation was declined. This usage of events lets us decouple the server processing from the frontend as we only need to notify the frontend by sending events when we are done. This let's us orchestrate interactions between multiple browsers.</p>
</div>
<div class="section" id="the-accept-game-handler">
<h2>The accept_game Handler<a class="headerlink" href="#the-accept-game-handler" title="Permalink to this headline">¶</a></h2>
<p>The last method that is part of the invite game cycle is the <tt class="docutils literal"><span class="pre">accept_game</span></tt> method. This method lets a player accept an invitation to play a game. Let's take a look at the code.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Handles the users decision to accept an invitation to play a game</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">accept_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages</span>
  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;accept_game&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;invite_gamer&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling function if it&#39;s not the case</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
    <span class="c1">// Our session id</span>
    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
    <span class="c1">// Locate the destination connection</span>
    <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>

    <span class="c1">// If there is no connection it means the other player went away, send an error message</span>
    <span class="c1">// to the calling function on the client</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Locate both the calling player and the destination player by their session ids</span>
    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findAllGamersBySids</span><span class="p">([</span><span class="nx">our_sid</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">players</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error notify both the inviter and the invited player about an error</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="nx">players</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">emit_error</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="s2">&quot;Failed to locate players for game acceptance&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Failed to locate players for game acceptance&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// Grab player 1 and player 2 from the results</span>
      <span class="kd">var</span> <span class="nx">p1</span> <span class="o">=</span> <span class="nx">players</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">p2</span> <span class="o">=</span> <span class="nx">players</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

      <span class="c1">// Create a new game with player 1 and player 2</span>
      <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">create_game</span><span class="p">(</span><span class="nx">p1</span><span class="p">.</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">p1</span><span class="p">.</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">p1</span><span class="p">.</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">full_name</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game_doc</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If we have an error notify both the inviter and the invited player about an error</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">emit_error</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="s2">&quot;Failed to create a new game&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Failed to create a new game&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// We have a new game, notify both players about the new game information</span>
        <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">game_doc</span> <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
        <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">game_doc</span> <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The <tt class="docutils literal"><span class="pre">accept_game</span></tt> method is slightly more complicated than the previous <tt class="docutils literal"><span class="pre">reject_game</span></tt> method but take heart it's not as bad as it looks.</p>
<p>First we check if the other player is still available and if he is, we locate both of the player's <tt class="docutils literal"><span class="pre">Gamer</span></tt> information by using the <tt class="docutils literal"><span class="pre">Gamer.findAllGamersBySids</span></tt> method. If we don't get back two documents we return an error to both players telling them we could not find the two players (the emphasis is we notify both of the players at the same time emitting an error on each players socket).</p>
<p>If we do find two <tt class="docutils literal"><span class="pre">Gamer</span></tt> object we create a new <tt class="docutils literal"><span class="pre">Game</span></tt> for the two players. If there is no error during the creation of the game we notify both players (the calling player and the other player that originally sent the invitation) about the successful acceptance of the game invitation.</p>
<p>That's the whole invite and accept/decline and invitation part of the application. Next up is the actual game play. This contains changes both for the backend and the frontend of our application.</p>
</div>
<div class="section" id="the-place-marker-handler">
<h2>The place_marker Handler<a class="headerlink" href="#the-place-marker-handler" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">place_marker</span></tt> method handles the actual game play between two players. It checks if the game has been won by one of the players or if it ended in a draw. It also updates the board to reflect the last move. Let's have a look at the code.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Handles the users decision to accept an invitation to play a game</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">place_marker</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages</span>
  <span class="kd">var</span> <span class="nx">calling_method_name</span>      <span class="o">=</span> <span class="s2">&quot;place_marker&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name_move</span>          <span class="o">=</span> <span class="s2">&quot;game_move&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name_game_over</span>     <span class="o">=</span> <span class="s2">&quot;game_over&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling function if it&#39;s not the case</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
    <span class="c1">// Grab our session id</span>
    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>

    <span class="c1">// Locate the game we want to place a marker on</span>
    <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">find_game</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game_doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If there is an error during the query return it to the calling function</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Could not find the game&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

      <span class="c1">// Let&#39;s get the current board in play</span>
      <span class="kd">var</span> <span class="nx">board</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">board</span><span class="p">;</span>
      <span class="c1">// Get the marker for the calling player (if we are the starting player we are X)</span>
      <span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">starting_player</span> <span class="o">==</span> <span class="nx">our_sid</span> <span class="o">?</span> <span class="s2">&quot;x&quot;</span> <span class="o">:</span> <span class="s2">&quot;o&quot;</span><span class="p">;</span>

      <span class="c1">// Locate other players session id</span>
      <span class="kd">var</span> <span class="nx">other_player_sid</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span> <span class="o">==</span> <span class="nx">our_sid</span> <span class="o">?</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player2_sid</span> <span class="o">:</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span><span class="p">;</span>

      <span class="c1">// If we are trying to set a cell that&#39;s already set emit an error to the calling function</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span> <span class="o">||</span> <span class="nx">board</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Cell already selected&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);;</span>

      <span class="c1">// Mark the cell with our marker</span>
      <span class="nx">board</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="nx">marker</span><span class="p">;</span>

      <span class="c1">// Attempt to update the board</span>
      <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">update_board</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">other_player_sid</span><span class="p">,</span> <span class="nx">board</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If we have an error it was not our turn</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Not your turn&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

        <span class="c1">// Locate the destination connection</span>
        <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">other_player_sid</span><span class="p">);</span>

        <span class="c1">// If there is no connection it means the other player went away, send an error message</span>
        <span class="c1">// to the calling function on the client</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

        <span class="c1">// Emit valid move message to caller and the other player</span>
        <span class="c1">// this notifies the clients that they can draw the marker on the board</span>
        <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
          <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">y</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="o">:</span> <span class="nx">marker</span><span class="p">}</span> <span class="p">}</span>
          <span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
        <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_move</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
          <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">y</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="o">:</span> <span class="nx">marker</span><span class="p">}</span> <span class="p">}</span>
          <span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>

        <span class="c1">// If there was no winner this turn</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">is_game_over</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="p">)</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// If there are still fields left on the board, let&#39;s keep playing</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_game_draw</span><span class="p">(</span><span class="nx">board</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

          <span class="c1">// Set the winner</span>
          <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">finalize_board</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If we have an error it was not our turn</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Failed to set winner on table&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

            <span class="c1">// If there are no open spots left on the board the game</span>
            <span class="c1">// is a draw</span>
            <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">draw</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span> <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">draw</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span> <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">}</span>

        <span class="c1">// Set the winner</span>
        <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">finalize_board</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// If we have an error it was not our turn</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Failed to set winner on table&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

          <span class="c1">// There was a winner and it was the last user to place a marker (the calling client)</span>
          <span class="c1">// signal both players who won the game</span>
          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">winner</span><span class="o">:</span> <span class="nx">our_sid</span><span class="p">}</span> <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">winner</span><span class="o">:</span> <span class="nx">our_sid</span><span class="p">}</span> <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">})</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The first thing we attempt is to locate the game by the <tt class="docutils literal"><span class="pre">game_id</span></tt> passed in over the <tt class="docutils literal"><span class="pre">SocketIO</span></tt> connection. If we locate a game we grab the game board and assign the calling player a marker.</p>
<p>If the calling player is the same as the <tt class="docutils literal"><span class="pre">starting_player</span></tt> off the game we get the marker <tt class="docutils literal"><span class="pre">x</span></tt> otherwise we get the marker <tt class="docutils literal"><span class="pre">o</span></tt>. We then establish the other players session id by looking at the board (if the called is <tt class="docutils literal"><span class="pre">player_1</span></tt> then the other player is <tt class="docutils literal"><span class="pre">player_2</span></tt>).</p>
<p>It's then time to verify that the co-ordinates passed to the <tt class="docutils literal"><span class="pre">player_marker</span></tt> function point to an empty board position. If it's not empty we return an error to the caller informing them that the cell is already selected. If the board position is empty we place the marker on the board and attempt to update the <tt class="docutils literal"><span class="pre">Game</span></tt> with the new <tt class="docutils literal"><span class="pre">board</span></tt>.</p>
<p>As we discussed earlier this will only succeed if it's the player that is calling this method's turn. Once the update is performed it's time to inform both of the players about the new state of the board by emitting a message with the board position that was changed and what kind of marker was put down.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="p">{</span>   <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">y</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span>
      <span class="p">,</span> <span class="nx">x</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span>
      <span class="p">,</span> <span class="nx">marker</span><span class="o">:</span> <span class="nx">marker</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>After we have emitted the new board state to the frontend, so they can render the board, we try to determine if the game was won by the method's calling player. This is done using the method <tt class="docutils literal"><span class="pre">is_game_over</span></tt>. Let's have a look at the logic in this method.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Checks from a given marker position if it&#39;s a winner</span>
<span class="cm"> * on the horizontal, vertical or diagonal</span>
<span class="cm"> *</span>
<span class="cm"> * [0, 0, 0] [0, 1, 0] [1, 0, 0] [0, 0, 1]</span>
<span class="cm"> * [1, 1, 1] [0, 1, 0] [0, 1, 0] [0, 1, 0]</span>
<span class="cm"> * [0, 0, 0] [0, 1, 0] [0, 0, 1] [1, 0, 0]</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">is_game_over</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Check the x and y for the following ranges</span>
  <span class="kd">var</span> <span class="nx">found_vertical</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">found_horizontal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c1">// y and x = 0 to x = n</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found_horizontal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// Found a winning position</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">found_horizontal</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c1">// x and y = 0 to y = n</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found_vertical</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Found a winning position</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">found_vertical</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c1">// 0, 0 to n, n along the diagonal</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Found a winning position</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">found_diagonal</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="c1">// Reset found diagonal</span>
  <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c1">// n, 0 to 0, n along the diagonal</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Return result of looking in the diagonal</span>
  <span class="k">return</span> <span class="nx">found_diagonal</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>This method checks for the four possible conditions of winning, a <tt class="docutils literal"><span class="pre">diagonal</span></tt>, <tt class="docutils literal"><span class="pre">horizontal</span></tt> or <tt class="docutils literal"><span class="pre">vertical</span></tt> win. There are probably some shorter and smarter versions of this code, but this is left as an exercise to you the reader if you think it's important.</p>
<p>If we determine that the board is not won by the placement of the marker we check if the board is a draw, meaning all positions in the board are marked. This code is very simple and is in the <tt class="docutils literal"><span class="pre">is_game_draw</span></tt> method.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Checks if all the spaces in the board have been used</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">is_game_draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">board</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>We just simply check if all of the fields are marked. If they are it's a draw. A single empty field means we are not in a draw position yet and the game can continue. If we have a draw we signal the players that the game ended in a draw, sending them the following message below. We then call the <tt class="docutils literal"><span class="pre">Game.finalize_board</span></tt> method passing in a null for the session id signaling a <tt class="docutils literal"><span class="pre">draw</span></tt>. This updates the board to it's final state.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="p">{</span>
    <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">draw</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>If the board was won by the calling player we send the players a message containing the winners session id and then call the <tt class="docutils literal"><span class="pre">Game.finalize_board</span></tt> method to finalize the board with the winning session id.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="p">{</span>
    <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">winner</span><span class="o">:</span> <span class="nx">our_sid</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>That covers the backend API's. Before we move on to the frontend code let's wire up the handlers correctly. Open the file <tt class="docutils literal"><span class="pre">app.js</span></tt> and add the new handlers.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">env</span>                               <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./env&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">main_controller</span>                   <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/controllers/main_controller&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">register_handler</span>                  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/login_handler&#39;</span><span class="p">).</span><span class="nx">register_handler</span>
  <span class="p">,</span> <span class="nx">login_handler</span>                     <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/login_handler&#39;</span><span class="p">).</span><span class="nx">login_handler</span>
  <span class="p">,</span> <span class="nx">find_all_available_gamers</span>         <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">).</span><span class="nx">find_all_available_gamers</span>
  <span class="p">,</span> <span class="nx">invite_gamer</span>                      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">).</span><span class="nx">invite_gamer</span>
  <span class="p">,</span> <span class="nx">decline_game</span>                      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">).</span><span class="nx">decline_game</span>
  <span class="p">,</span> <span class="nx">accept_game</span>                       <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">).</span><span class="nx">accept_game</span>
  <span class="p">,</span> <span class="nx">place_marker</span>                      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">).</span><span class="nx">place_marker</span><span class="p">;</span>

<span class="nx">env</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>  
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

  <span class="c1">//</span>
  <span class="c1">// http routes</span>
  <span class="c1">//</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">main_controller</span><span class="p">.</span><span class="nx">index</span><span class="p">());</span>

  <span class="c1">//</span>
  <span class="c1">// websocket api end point handlers (our API)</span>
  <span class="c1">//</span>
  <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;register&#39;</span><span class="p">,</span> <span class="nx">register_handler</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="nx">login_handler</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
    
    <span class="c1">// The game invite and play methods</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;find_all_available_gamers&#39;</span><span class="p">,</span> <span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>  
    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;invite_gamer&#39;</span><span class="p">,</span> <span class="nx">invite_gamer</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;decline_game&#39;</span><span class="p">,</span> <span class="nx">decline_game</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;accept_game&#39;</span><span class="p">,</span> <span class="nx">accept_game</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;place_marker&#39;</span><span class="p">,</span> <span class="nx">place_marker</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>

    <span class="c1">// Fire the init message to setup the game</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">event</span><span class="o">:</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="nx">ok</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">});</span>
  <span class="p">});</span>

  <span class="c1">//</span>
  <span class="c1">// fire up the server</span>
  <span class="c1">//  </span>
  <span class="nx">env</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    
    <span class="c1">//</span>
    <span class="c1">// nothing to do</span>
    <span class="c1">//</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>That's the backend taken care off and all wired up. It's time to turn our attention to the frontend part of the game.</p>
</div>
<div class="section" id="the-front-end">
<h2>The Front End<a class="headerlink" href="#the-front-end" title="Permalink to this headline">¶</a></h2>
<p>Let's get cracking on integrating our awesome backend API's on the frontend so we can play a game of Tic-Tac-Toe. Let's start by implementing the missing API calls on the frontend. Open up the <tt class="docutils literal"><span class="pre">public/javascripts/api.js</span></tt> file in your editor and get typing.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Wraps the API used for the game and handles the socketIO connection</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">API</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">domain</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="c1">// Handle the data returned over the SocketIO</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// If the data object has an event member we have</span>
    <span class="c1">// a valid event message from the server</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">data</span><span class="p">.</span><span class="nx">is_error</span> <span class="o">?</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">data</span><span class="p">)</span> <span class="o">:</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">data</span><span class="p">.</span><span class="nx">is_error</span> <span class="o">?</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">pop</span><span class="p">()(</span><span class="nx">data</span><span class="p">)</span> <span class="o">:</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">pop</span><span class="p">()(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Register an event listener callback (will keep receiving messages)</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Register an event listener callback for a single instance of the event</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">once</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Register a new user</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>  
  <span class="c1">// Do basic validation</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">full_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">full_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;Full name cannot be empty&quot;</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;User name cannot be empty&quot;</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;Password name cannot be empty&quot;</span><span class="p">));</span>
  <span class="c1">// Register callback</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="c1">// Fire message</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">full_name</span><span class="o">:</span> <span class="nx">full_name</span>
    <span class="p">,</span> <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Login a user</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">login</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>  
  <span class="c1">// Do basic validation</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;User name cannot be empty&quot;</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;Password name cannot be empty&quot;</span><span class="p">));</span>
  <span class="c1">// Register callback</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="c1">// Fire message</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Find all available gamers that are active</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">find_all_available_gamers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>  
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;find_all_available_gamers&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;find_all_available_gamers&quot;</span><span class="p">,</span> <span class="p">{});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Invite a gamer to a new game</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">invite_gamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gamer</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;invite_gamer&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;invite_gamer&quot;</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">);</span>
<span class="p">}</span> 

<span class="cm">/**</span>
<span class="cm"> * Decline an invite to play a game</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">decline_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">invite</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;decline_game&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;decline_game&quot;</span><span class="p">,</span> <span class="nx">invite</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Accept an invite to play a game</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">accept_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">invite</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;accept_game&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;accept_game&quot;</span><span class="p">,</span> <span class="nx">invite</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Place a marker on a specific game at a specific location</span>
<span class="cm"> */</span>
<span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">place_marker</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>  
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;place_marker&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;place_marker&quot;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">game_id</span><span class="o">:</span> <span class="nx">game_id</span>
    <span class="p">,</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">x</span>
    <span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">y</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Simple method to create a formated error message that fits the</span>
<span class="cm"> * format returned from the server</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">create_error</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
      <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
    <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
    <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>You might see that we are using two new templates one called <tt class="docutils literal"><span class="pre">board.ms</span></tt> and the other called <tt class="docutils literal"><span class="pre">decline_game.ms</span></tt>. Let's create the two files for now and we will get back to the contents later in the exercise.</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">touch public/templates/board.ms</span>
<span class="go">touch public/templates/decline_game.ms</span>
</pre></div>
</td></tr></table></div>
<p>So what kind of API calls are we missing on the frontend. Well basically we need to wire up the backend functions we created. Let's look at what those methods are.</p>
<table border="1" class="docutils">
<colgroup>
<col width="34%" />
<col width="66%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Function</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>find_all_available_gamers</td>
<td>Locate all currently active gamers in the system</td>
</tr>
<tr class="row-odd"><td>invite_gamer</td>
<td>Invite a player to a game using their session id</td>
</tr>
<tr class="row-even"><td>decline_game</td>
<td>Decline an incoming invitation from another player</td>
</tr>
<tr class="row-odd"><td>accept_game</td>
<td>Accept the invitation to a game from another player</td>
</tr>
<tr class="row-even"><td>place_marker</td>
<td>Attempt to place a marker on the Tic-Tac-Toe game</td>
</tr>
</tbody>
</table>
<p>As we can see the methods all map to the backend <tt class="docutils literal"><span class="pre">API</span></tt> nice and cleanly. So let's start writing the frontend application code to make usage of them.</p>
<p>The first thing we want to do is to add a new dialog for the game invitations to our <tt class="docutils literal"><span class="pre">lib/views/index.html</span></tt> file. Let's open up the file and add the <tt class="docutils literal"><span class="pre">invite_box</span></tt> div.</p>
<div class="highlight-html"><pre>&lt;!DOCTYPE html&gt;
&lt;html lang="en" ng-app="app"&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;title&gt;Tic-Tac-Toe&lt;/title&gt;

    &lt;!-- Le styles --&gt;
    &lt;link href="/css/bootstrap.css" rel="stylesheet"&gt;
    &lt;style type="text/css"&gt;
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
    &lt;/style&gt;
    &lt;link href="/css/bootstrap-responsive.css" rel="stylesheet"&gt;
    &lt;link href="/css/app.css" rel="stylesheet"&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div&gt;
      &lt;ng-view&gt;&lt;/ng-view&gt;
    &lt;/div&gt;
    &lt;script type="text/javascript" src="javascripts/jquery.js"&gt;&lt;/script&gt;
    &lt;script src="/socket.io/socket.io.js"&gt;&lt;/script&gt;
    &lt;script type="text/javascript" src="javascripts/api.js"&gt;&lt;/script&gt;
    &lt;script type="text/javascript" src="javascripts/mustache.js"&gt;&lt;/script&gt;
    &lt;script type="text/javascript" src="javascripts/bootstrap.min.js"&gt;&lt;/script&gt;
    &lt;script type="text/javascript" src="javascripts/template_handler.js"&gt;&lt;/script&gt;
    &lt;script type="text/javascript" src="javascripts/app.js"&gt;&lt;/script&gt;

    &lt;div class="container"&gt;

      &lt;div class="navbar navbar-inverse navbar-fixed-top"&gt;
        &lt;div class="navbar-inner"&gt;
          &lt;div class="container"&gt;
            &lt;a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"&gt;
              &lt;span class="icon-bar"&gt;&lt;/span&gt;
              &lt;span class="icon-bar"&gt;&lt;/span&gt;
              &lt;span class="icon-bar"&gt;&lt;/span&gt;
            &lt;/a&gt;
            &lt;a class="brand" href="#"&gt;Tic-Tac-Toe&lt;/a&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;!-- Main hero unit for a primary marketing message or call to action --&gt;
      &lt;div class="hero-unit"&gt;
        &lt;h1&gt;Tic Tac Toe!&lt;/h1&gt;
        &lt;p&gt;Play Tic Tac Toe against your friends in this multiplayer demo.&lt;/p&gt;
        &lt;p&gt;&lt;a class="btn btn-primary btn-large" href="https://github.com/christkv/tic-tac-toe"&gt;Github &amp;raquo;&lt;/a&gt;&lt;/p&gt;
      &lt;/div&gt;

      &lt;!-- Example row of columns --&gt;
      &lt;div class="row" id="view"&gt;
      &lt;/div&gt;

      &lt;hr&gt;

      &lt;footer&gt;
        &lt;p&gt;&amp;copy; Christian Kvalheim 2012&lt;/p&gt;
      &lt;/footer&gt;

    &lt;/div&gt; &lt;!-- /container --&gt;
    &lt;!-- Modal --&gt;
    &lt;div id="status_box" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="status_box" aria-hidden="true"&gt;
      &lt;div class="modal-header"&gt;
        &lt;button type="button" class="close" data-dismiss="modal" aria-hidden="true"&gt;×&lt;/button&gt;
        &lt;h3 id="status_box_header"&gt;Modal header&lt;/h3&gt;
      &lt;/div&gt;
      &lt;div class="modal-body"&gt;
        &lt;p id="status_box_body"&gt;&lt;/p&gt;
      &lt;/div&gt;
      &lt;div class="modal-footer"&gt;
        &lt;button class="btn" data-dismiss="modal" aria-hidden="true"&gt;Close&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- Modal --&gt;
    &lt;div id="invite_box" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="invite_box" aria-hidden="true"&gt;
      &lt;div class="modal-header"&gt;
        &lt;button type="button" class="close" data-dismiss="modal" aria-hidden="true"&gt;×&lt;/button&gt;
        &lt;h3 id="invite_box_header"&gt;Modal header&lt;/h3&gt;
      &lt;/div&gt;
      &lt;div class="modal-body"&gt;
        &lt;p id="invite_box_body"&gt;&lt;/p&gt;
      &lt;/div&gt;
      &lt;div class="modal-footer"&gt;
        &lt;button id="invite_box_accept" class="btn" data-dismiss="modal" aria-hidden="true"&gt;Accept&lt;/button&gt;
        &lt;button id="invite_box_decline" class="btn" data-dismiss="modal" aria-hidden="true"&gt;Decline&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre>
</div>
<p>The <tt class="docutils literal"><span class="pre">invite_box</span></tt> div adds the dialog we will present to the user when they get invited to a new game allowing them to accept/decline the invitation.</p>
<p>After adding the new dialog we need to finish writing the template for our dashboard to include the list of available players the user can play. The template is in the file <tt class="docutils literal"><span class="pre">public/templates/dashboard.ms</span></tt>. Open it up and add the following code.</p>
<div class="highlight-mustache"><pre>&lt;div class="span8"&gt;
  &lt;h2&gt;All Active Users&lt;/h2&gt;
  &lt;p&gt;All users currently on the system, invite them to play a game.&lt;/p&gt;
  &lt;table class="table table-striped"&gt;
    &lt;thead&gt;
      &lt;th&gt;Player&lt;/th&gt;
      &lt;th&gt;&lt;/th&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
      {{#gamers}}
      &lt;tr&gt;
        &lt;td width="100%"&gt;{{user_name}}&lt;/td&gt;
        &lt;td&gt;&lt;a href="#" id="gamer_{{_id}}"&gt;Play&lt;/a&gt;&lt;/td&gt;
      &lt;/tr&gt;
      {{/gamers}}
    &lt;/tbody&gt;
  &lt;/table&gt;
&lt;/div&gt;
&lt;div class="span4"&gt;
  &lt;h2&gt;The Dashboard&lt;/h2&gt;
  &lt;p&gt;
    The list on the left side shows all the active players (connected via socket.io) and lets you challenge one of them to a game. Click on the play link to give it a go.
  &lt;/p&gt;
&lt;/div&gt;</pre>
</div>
<p>Notice the <tt class="docutils literal"><span class="pre">{{#gamers}}</span></tt> tag that iterates through the <tt class="docutils literal"><span class="pre">gamers</span></tt> array in the <tt class="docutils literal"><span class="pre">context</span></tt> parameter we pass in when using the <tt class="docutils literal"><span class="pre">TemplateHandler.prototype.setTemplate</span></tt> or <tt class="docutils literal"><span class="pre">TemplateHandler.prototype.render</span></tt> method.</p>
<p>For each gamer we add a new row in a table with a link that has the <tt class="docutils literal"><span class="pre">gamer_</span> <span class="pre">+</span> <span class="pre">session</span> <span class="pre">id</span></tt> as an identifier. Later we will see how we wire up this link to be able to invite the player identified by it.</p>
<p>That's the dashboard taken care off. Let's move on and wire it up so that when you log on you can see the list of available players. Let's open up <tt class="docutils literal"><span class="pre">public/javascripts/app.js</span></tt> in the editor.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1">// Contains the application state</span>
<span class="kd">var</span> <span class="nx">application_state</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">session_id</span><span class="o">:</span> <span class="kc">null</span>
  <span class="p">,</span> <span class="nx">modal</span><span class="o">:</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="c1">// Create an instance of the API class</span>
<span class="kd">var</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">API</span><span class="p">();</span>

<span class="c1">// Create a template handler with all the templates</span>
<span class="c1">// used in the application</span>
<span class="kd">var</span> <span class="nx">template_handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TemplateHandler</span><span class="p">({</span>
    <span class="s2">&quot;main&quot;</span><span class="o">:</span> <span class="s2">&quot;/templates/main.ms&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="o">:</span> <span class="s2">&quot;/templates/dashboard.ms&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;board&quot;</span><span class="o">:</span> <span class="s2">&quot;/templates/board.ms&quot;</span>
  <span class="p">,</span> <span class="s2">&quot;decline_game&quot;</span><span class="o">:</span> <span class="s2">&quot;/templates/decline_game.ms&quot;</span>
<span class="p">});</span>

<span class="c1">// Load all the templates and once it&#39;s done</span>
<span class="c1">// register up all the initial button handlers</span>
<span class="nx">template_handler</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Render the main view in the #view div</span>
  <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="p">{});</span>

  <span class="c1">// Wire up the buttons for the main view</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#register_button&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">register_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#login_button&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">login_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>

  <span class="c1">// Wire up invite box buttons (this is in the main view)</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box_accept&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_accept_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box_decline&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_decline_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>

  <span class="c1">// Ensure we have the right state for the modal dialog</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">});</span>  
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;hide&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="p">});</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">});</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;hide&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="p">});</span>
<span class="p">})</span>

<span class="cm">/*********************************************************************************************</span>
<span class="cm"> * Application events we listen to</span>
<span class="cm"> ********************************************************************************************/</span>

<span class="cm">/**</span>
<span class="cm"> * The init event, the server has set up everything an assigned us</span>
<span class="cm"> * a session id that we can use in the application</span>
<span class="cm"> */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">});</span>

<span class="cm">/**</span>
<span class="cm"> * A new gamer logged on, display the new user in the list of available gamers</span>
<span class="cm"> * to play</span>
<span class="cm"> */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;gamer_joined&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="c1">// Get the gamer</span>
  <span class="kd">var</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
  <span class="c1">// Check if we have the gamer already</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="c1">// Check if the gamer already exists and if it does </span>
  <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="c1">// replace it with the new reference</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_gamer</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">_gamer</span><span class="p">.</span><span class="nx">user_name</span> <span class="o">==</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">user_name</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="c1">// Update the sid and update on</span>
      <span class="nx">_gamer</span><span class="p">.</span><span class="nx">sid</span> <span class="o">=</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">sid</span><span class="p">;</span>
      <span class="nx">_gamer</span><span class="p">.</span><span class="nx">updated_on</span> <span class="o">=</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">updated_on</span><span class="p">;</span>      
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// If not found let&#39;s add it to the list</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">found</span><span class="p">)</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">gamer</span><span class="p">);</span>
  <span class="c1">// If we currently have the dashboard</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">.</span><span class="nx">isTemplate</span><span class="p">(</span><span class="s2">&quot;dashboard&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">gamers</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">;</span>
    <span class="c1">// Let&#39;s go to the dashboard of the game</span>
    <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>    
    <span class="c1">// Add handlers to the event</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="cm">/**</span>
<span class="cm"> * The opponent made a valid move, render the move on the board</span>
<span class="cm"> */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;game_move&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="c1">// Get the move data</span>
  <span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">marker</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
  <span class="c1">// Select the right box and mark it</span>
  <span class="kd">var</span> <span class="nx">cell_id_image</span> <span class="o">=</span> <span class="s2">&quot;#row&quot;</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">+</span> <span class="s2">&quot;cell&quot;</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot; img&quot;</span><span class="p">;</span>
  <span class="c1">// It was our turn, let&#39;s show the mark we set down</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">marker</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/cross.png&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/circle.png&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="cm">/**</span>
<span class="cm"> * The game was won, display victory / defeat / draw dialog</span>
<span class="cm"> */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;game_over&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">draw</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;It was a draw&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;Your equally good, it&#39;s a draw&lt;/p&gt;&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">==</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;Congratulations&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;You won&lt;/p&gt;&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;You lost&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;You got beaten buddy&lt;/p&gt;&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Let&#39;s load the first 100 public available games</span>
  <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

    <span class="c1">// Save the list of games in our game state</span>
    <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>
    <span class="c1">// Let&#39;s go to the dashboard of the game</span>
    <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>
    <span class="c1">// Add handlers to the event</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">});</span>

<span class="cm">/**</span>
<span class="cm"> * The user was invited to play a game, show the invitation acceptance / decline box</span>
<span class="cm"> */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;game_invite&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>  
  <span class="c1">// Save the invitation in our application state</span>
  <span class="nx">application_state</span><span class="p">.</span><span class="nx">invite</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
  <span class="c1">// Open the invite box</span>
  <span class="nx">game_invite_box_show</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">gamer</span><span class="p">);</span>
<span class="p">});</span>

<span class="cm">/*********************************************************************************************</span>
<span class="cm"> * Handlers</span>
<span class="cm"> ********************************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm"> * Handles the attempt to register a new user</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">register_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>    
    <span class="c1">// Lets get the values for the registration</span>
    <span class="kd">var</span> <span class="nx">full_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputFullNameRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputUserNameRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputPasswordRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>

    <span class="c1">// Attempt to register a new user</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Load all the available gamers</span>
      <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If we have an error show the error message to the user        </span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

        <span class="c1">// Save the list of games in our game state</span>
        <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>
 
        <span class="c1">// Show the main dashboard view and render with all the available players</span>
        <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>
        
        <span class="c1">// Add handlers for each new player so we can play them</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Handles the attempt to login</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">login_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Lets get the values for the login</span>
    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputUserNameLogin&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputPasswordLogin&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>

    <span class="c1">// Attempt to login the user</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Load all the available gamers</span>
      <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If we have an error show the error message to the user        </span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

        <span class="c1">// Save the list of games in our game state</span>
        <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>

        <span class="c1">// Show the main dashboard view and render with all the available players</span>
        <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>

        <span class="c1">// Add handlers for each new player so we can play them</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Send an invitation to a player to pay a game</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">invite_gamer_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">gamer_id</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="c1">// Get the id</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">gamer_id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\_/</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
    
    <span class="c1">// Locate the gamer object</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span> <span class="o">==</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    
        <span class="c1">// Attempt to invite the gamer to play</span>
        <span class="nx">api</span><span class="p">.</span><span class="nx">invite_gamer</span><span class="p">(</span><span class="nx">gamer</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>          
          <span class="c1">// If we have an error show the declined game to the user</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">decline_box_show</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">);</span>
          
          <span class="c1">// Set up the board for a game</span>
          <span class="nx">setupBoardGame</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
        <span class="p">})</span>        
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Accept an invitation to play a game</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">invite_accept_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Accept the game invite</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">accept_game</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">invite</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user        </span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Set up the board for a game</span>
      <span class="nx">setupBoardGame</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Accept an invitation to play a game</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">invite_decline_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Decline the game invite</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">decline_game</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">invite</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user        </span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
      <span class="c1">// No need to do anything as we declined the game and we are still showing the dashboard</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************************************************************</span>
<span class="cm"> * Setup methods</span>
<span class="cm"> ********************************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm"> * Set up a new game board and add handlers to all the cells of the board</span>
<span class="cm"> */</span> 
<span class="kd">var</span> <span class="nx">setupBoardGame</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Save current game to state</span>
  <span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span> <span class="o">=</span> <span class="nx">game</span><span class="p">;</span>
  <span class="c1">// Let&#39;s render the board game</span>
  <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;board&quot;</span><span class="p">,</span> <span class="p">{});</span>
  <span class="c1">// Set the marker for our player (X if we are the starting player)</span>
  <span class="nx">application_state</span><span class="p">.</span><span class="nx">marker</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span> <span class="o">==</span> <span class="nx">game</span><span class="p">.</span><span class="nx">current_player</span> <span class="o">?</span> <span class="s2">&quot;x&quot;</span> <span class="o">:</span> <span class="s2">&quot;o&quot;</span><span class="p">;</span>
  <span class="c1">// Get all the rows</span>
  <span class="kd">var</span> <span class="nx">rows</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#board div&#39;</span><span class="p">);</span>

  <span class="c1">// Add an event handler to each cell</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cells</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; span&quot;</span><span class="p">);</span>

    <span class="c1">// For each cell create and add the handler</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">cells</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">cells</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">id</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">game_board_cell_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Create a cell click handler that will send the events to the server when the user clicks</span>
<span class="cm"> * on an event, and also show the result</span>
<span class="cm"> */</span> 
<span class="kd">var</span> <span class="nx">game_board_cell_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Split up the id to get the cell position</span>
    <span class="kd">var</span> <span class="nx">row_number</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;row&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">cell_number</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">cell_id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">cell_id_image</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">cell_id</span> <span class="o">+</span> <span class="s2">&quot; img&quot;</span><span class="p">;</span>

    <span class="c1">// Let&#39;s attempt to do a move</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">place_marker</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nx">cell_number</span><span class="p">,</span> <span class="nx">row_number</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// If we won</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">==</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;Congratulations&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;You won&lt;/p&gt;&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;You lost&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;You got beaten buddy&lt;/p&gt;&quot;</span><span class="p">);</span>    
      <span class="p">}</span> 

      <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">marker</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/cross.png&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/circle.png&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************************************************************</span>
<span class="cm"> * Helper methods</span>
<span class="cm"> ********************************************************************************************/</span>

<span class="cm">/**</span>
<span class="cm"> * Show an error message box</span>
<span class="cm"> */</span> 
<span class="kd">var</span> <span class="nx">error_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Set fields for the error</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_header&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;Registration Error&quot;</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_body&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="c1">// Show the modal box</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">({</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>  
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * General message box with configurable title and body content</span>
<span class="cm"> */</span> 
<span class="kd">var</span> <span class="nx">general_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Set fields for the error</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_header&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_body&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
  <span class="c1">// Show the modal box</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">({</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>    
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Show a game decline message box</span>
<span class="cm"> */</span> 
<span class="kd">var</span> <span class="nx">decline_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Set fields for the error</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_header&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;Invitation to game was declined&quot;</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_body&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s2">&quot;decline_game&quot;</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">));</span>
  <span class="c1">// Show the modal box</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">({</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>    
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Show a game invite message box</span>
<span class="cm"> */</span> 
<span class="kd">var</span> <span class="nx">game_invite_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gamer</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Set fields for the error</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box_header&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;You have been invited to a game&quot;</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box_body&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;The user &lt;strong&gt;&quot;</span> <span class="o">+</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">user_name</span> <span class="o">+</span> <span class="s2">&quot;&lt;/strong&gt; has challenged you to a game&quot;</span><span class="p">);</span>
  <span class="c1">// Show the modal box</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">({</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>  
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>We need to add several event handlers as well as several utility methods in <tt class="docutils literal"><span class="pre">public/javascripts/app.js</span></tt>. Let's first look at what we are adding in terms of event handlers.</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="86%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Event</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>gamer_joined</td>
<td>When a new player logs in the list of available players should get updated.</td>
</tr>
<tr class="row-odd"><td>game_move</td>
<td>When a valid move board move was performed update the board graphical display</td>
</tr>
<tr class="row-even"><td>game_over</td>
<td>A move lead to the game finishing, determine what the outcome was and display the appropriate message to the player then return to the dashboard to start again</td>
</tr>
<tr class="row-odd"><td>game_invite</td>
<td>Another player invited you to join them in a game in Tic-Tac-Toe. Display the dialog to the player to allow them to accept/decline the invitation</td>
</tr>
</tbody>
</table>
<p>Secondly lets look at what other handlers we are adding for user interactions with the application as well as methods to render a board, handle the invite process and the game itself.</p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="81%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parameter</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>register_button_handler</td>
<td>When the player registers we now need to render the initial list of available players as well as the dashboard</td>
</tr>
<tr class="row-odd"><td>login_button_handler</td>
<td>When the player logs in we now need to render the initial list of available players as well as the dashboard</td>
</tr>
<tr class="row-even"><td>invite_gamer_button_handler</td>
<td>When the player clicks on another player to invite them to a game</td>
</tr>
<tr class="row-odd"><td>invite_accept_button_handler</td>
<td>Handle the user clicking to accept a game invitation</td>
</tr>
<tr class="row-even"><td>invite_decline_button_handler</td>
<td>Handle the user clicking on decline a game invitation</td>
</tr>
<tr class="row-odd"><td>setupBoardGame</td>
<td>Render a new clean Tic-Tac-Toe board and set up all the handlers for the placement of markers on it</td>
</tr>
<tr class="row-even"><td>game_board_cell_handler</td>
<td>Handle the user clicking on a board cell to place a marker</td>
</tr>
<tr class="row-odd"><td>general_box_show</td>
<td>Show a general message box dialog</td>
</tr>
<tr class="row-even"><td>decline_box_show</td>
<td>Show a dialog where the other player declined a game invitation</td>
</tr>
<tr class="row-odd"><td>game_invite_box_show</td>
<td>Show a dialog when the player gets invited to a new game by another player allowing them to accept/decline the invitation</td>
</tr>
</tbody>
</table>
<p>Let's start with picking apart the code event handlers we listed above.</p>
</div>
<div class="section" id="the-gamer-joined-event-handler">
<h2>The gamer_joined Event Handler<a class="headerlink" href="#the-gamer-joined-event-handler" title="Permalink to this headline">¶</a></h2>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * A new gamer logged on, display the new user in the list of available gamers</span>
<span class="cm"> * to play</span>
<span class="cm"> */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;gamer_joined&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="c1">// Get the gamer</span>
  <span class="kd">var</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
  <span class="c1">// Check if we have the gamer already</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="c1">// Check if the gamer already exists and if it does</span>
  <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="c1">// replace it with the new reference</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_gamer</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">_gamer</span><span class="p">.</span><span class="nx">user_name</span> <span class="o">==</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">user_name</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="c1">// Update the sid and update on</span>
      <span class="nx">_gamer</span><span class="p">.</span><span class="nx">sid</span> <span class="o">=</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">sid</span><span class="p">;</span>
      <span class="nx">_gamer</span><span class="p">.</span><span class="nx">updated_on</span> <span class="o">=</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">updated_on</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// If not found let&#39;s add it to the list</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">found</span><span class="p">)</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">gamer</span><span class="p">);</span>
  <span class="c1">// If we currently have the dashboard</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">.</span><span class="nx">isTemplate</span><span class="p">(</span><span class="s2">&quot;dashboard&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">gamers</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">;</span>
    <span class="c1">// Let&#39;s go to the dashboard of the game</span>
    <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>
    <span class="c1">// Add handlers to the event</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>The <tt class="docutils literal"><span class="pre">gamer_joined</span></tt> event handler gets called every time a new player logs in. If the player already exists in our list we update the players session id and last active time to make sure we can talk to the correct player. If it does not exist we push it to the list of our users.</p>
<p>In the case where are currently showing the <tt class="docutils literal"><span class="pre">dashboard</span></tt> view we re-render the list so we can show the newly added player. We don't re-render the dashboard if a modal dialog is currently being shown to the player.</p>
<p>It's left as an exercise to the user on how to handle the rendering if the modal dialog is showing. One possible solution is to defer the rendering until the modal dialog is closed.</p>
</div>
<div class="section" id="the-game-move-event-handler">
<h2>The game_move Event Handler<a class="headerlink" href="#the-game-move-event-handler" title="Permalink to this headline">¶</a></h2>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * The opponent made a valid move, render the move on the board</span>
<span class="cm"> */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;game_move&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="c1">// Get the move data</span>
  <span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">marker</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
  <span class="c1">// Select the right box and mark it</span>
  <span class="kd">var</span> <span class="nx">cell_id_image</span> <span class="o">=</span> <span class="s2">&quot;#row&quot;</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">+</span> <span class="s2">&quot;cell&quot;</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot; img&quot;</span><span class="p">;</span>
  <span class="c1">// It was our turn, let&#39;s show the mark we set down</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">marker</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/cross.png&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/circle.png&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>The <tt class="docutils literal"><span class="pre">game_move</span></tt> event handler gets called each time a valid marker placement was done on the board. We then figure out if the marker is a <tt class="docutils literal"><span class="pre">x</span></tt> or a <tt class="docutils literal"><span class="pre">o</span></tt> and update the board position to show the image representing the marker placed on the board.</p>
</div>
<div class="section" id="the-game-invite-event-handler">
<h2>The game_invite Event Handler<a class="headerlink" href="#the-game-invite-event-handler" title="Permalink to this headline">¶</a></h2>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * The user was invited to play a game, show the invitation acceptance / decline box</span>
<span class="cm"> */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;game_invite&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="c1">// Save the invitation in our application state</span>
  <span class="nx">application_state</span><span class="p">.</span><span class="nx">invite</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
  <span class="c1">// Open the invite box</span>
  <span class="nx">game_invite_box_show</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">gamer</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>The <tt class="docutils literal"><span class="pre">game_invite</span></tt> event handler will save the invite in progress in the <tt class="docutils literal"><span class="pre">application_state</span></tt> and then display the invite accept/decline dialog box so the player can accept/decline the invitation.</p>
</div>
<div class="section" id="the-register-button-handler-handler">
<h2>The register_button_handler Handler<a class="headerlink" href="#the-register-button-handler-handler" title="Permalink to this headline">¶</a></h2>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Handles the attempt to register a new user</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">register_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Lets get the values for the registration</span>
    <span class="kd">var</span> <span class="nx">full_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputFullNameRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputUserNameRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputPasswordRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>

    <span class="c1">// Attempt to register a new user</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Load all the available gamers</span>
      <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If we have an error show the error message to the user</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

        <span class="c1">// Save the list of games in our game state</span>
        <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>

        <span class="c1">// Show the main dashboard view and render with all the available players</span>
        <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>

        <span class="c1">// Add handlers for each new player so we can play them</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>We've modified the <tt class="docutils literal"><span class="pre">register_button_handler</span></tt> method to fetch the available players and render the <tt class="docutils literal"><span class="pre">dashboard</span></tt> view showing all of them. After finishing rendering the <tt class="docutils literal"><span class="pre">dashboard</span></tt>, we wire up all the links to the players so we can click on them and trigger an invite to be sent.</p>
</div>
<div class="section" id="the-login-button-handler-handler">
<h2>The login_button_handler Handler<a class="headerlink" href="#the-login-button-handler-handler" title="Permalink to this headline">¶</a></h2>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Handles the attempt to login</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">login_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Lets get the values for the login</span>
    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputUserNameLogin&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputPasswordLogin&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>

    <span class="c1">// Attempt to login the user</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Load all the available gamers</span>
      <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If we have an error show the error message to the user</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

        <span class="c1">// Save the list of games in our game state</span>
        <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>

        <span class="c1">// Show the main dashboard view and render with all the available players</span>
        <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>

        <span class="c1">// Add handlers for each new player so we can play them</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>We've modified the <tt class="docutils literal"><span class="pre">login_button_handler</span></tt> method to fetch the available players and render the <tt class="docutils literal"><span class="pre">dashboard</span></tt> view showing all of them. After finishing rendering the <tt class="docutils literal"><span class="pre">dashboard</span></tt>, we wire up all the links to the players so we can click on them and trigger an invite to be sent.</p>
</div>
<div class="section" id="the-invite-gamer-button-handler-handler">
<h2>The invite_gamer_button_handler Handler<a class="headerlink" href="#the-invite-gamer-button-handler-handler" title="Permalink to this headline">¶</a></h2>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Send an invitation to a player to pay a game</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">invite_gamer_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">gamer_id</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="c1">// Get the id</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">gamer_id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\_/</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>

    <span class="c1">// Locate the gamer object</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span> <span class="o">==</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

        <span class="c1">// Attempt to invite the gamer to play</span>
        <span class="nx">api</span><span class="p">.</span><span class="nx">invite_gamer</span><span class="p">(</span><span class="nx">gamer</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// If we have an error show the declined game to the user</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">decline_box_show</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">);</span>

          <span class="c1">// Set up the board for a game</span>
          <span class="nx">setupBoardGame</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
        <span class="p">})</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The <tt class="docutils literal"><span class="pre">invite_gamer_button_handler</span></tt> method triggers when you click on one of the users available to invite. It will first locate the <tt class="docutils literal"><span class="pre">Gamer</span></tt> object for the player and use the <tt class="docutils literal"><span class="pre">api.invite_gamer</span></tt> to attempt to invite the user to a new game. If the other user accepts we call the <tt class="docutils literal"><span class="pre">setupBoardGame</span></tt> function to show the new board and set up all the handlers otherwise we shoe the decline dialog telling the player that the invite was declined.</p>
</div>
<div class="section" id="the-invite-accept-button-handler-handler">
<h2>The invite_accept_button_handler Handler<a class="headerlink" href="#the-invite-accept-button-handler-handler" title="Permalink to this headline">¶</a></h2>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Accept an invitation to play a game</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">invite_accept_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Accept the game invite</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">accept_game</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">invite</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Set up the board for a game</span>
      <span class="nx">setupBoardGame</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The <tt class="docutils literal"><span class="pre">invite_accept_button_handler</span></tt> method handles the user clicking the accept button on the invite dialog. It calls the <tt class="docutils literal"><span class="pre">api.accept_game</span></tt> with the existing invite and if the successful it will set up the board using the <tt class="docutils literal"><span class="pre">setupBoardGame</span></tt> function. If unsuccessful we show an error dialog with the relevant error message. Let's see how we wire up those handlers.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1">// Load all the templates and once it&#39;s done</span>
<span class="c1">// register up all the initial button handlers</span>
<span class="nx">template_handler</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Render the main view in the #view div</span>
  <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="p">{});</span>

  <span class="c1">// Wire up the buttons for the main view</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#register_button&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">register_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#login_button&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">login_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>

  <span class="c1">// Wire up invite box buttons (this is in the main view)</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box_accept&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_accept_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box_decline&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_decline_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>

  <span class="c1">// Ensure we have the right state for the modal dialog</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">});</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;hide&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="p">});</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">});</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;hide&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="p">});</span>
<span class="p">})</span>
</pre></div>
</td></tr></table></div>
<p>Notice how we wire it up in the <tt class="docutils literal"><span class="pre">template_handler.start</span></tt> callback. This goes for both the <tt class="docutils literal"><span class="pre">invite_accept_button_handler</span></tt> and <tt class="docutils literal"><span class="pre">invite_decline_button_handler</span></tt>. We only need to wire up these handlers once as the HTML elements they are wired up to will exist during the entire duration of the applications life. This is in contrast to the <tt class="docutils literal"><span class="pre">Gamer</span></tt> invite links that we need to rewire each time we show the list of <tt class="docutils literal"><span class="pre">Gamers</span></tt> available (Not optimal of course but this is left to you as an exercise to improve on).</p>
</div>
<div class="section" id="the-invite-decline-button-handler-handler">
<h2>The invite_decline_button_handler Handler<a class="headerlink" href="#the-invite-decline-button-handler-handler" title="Permalink to this headline">¶</a></h2>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Accept an invitation to play a game</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">invite_decline_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Decline the game invite</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">decline_game</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">invite</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
      <span class="c1">// No need to do anything as we declined the game and we are still showing the dashboard</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The <tt class="docutils literal"><span class="pre">invite_decline_button_handler</span></tt> handles the user clicking the decline button on invitation dialog. It calls the <tt class="docutils literal"><span class="pre">api.decline_game</span></tt> with the existing invite to cancel the invite and notify the inviting player about the player declining the invitation.</p>
</div>
<div class="section" id="the-setupboardgame-function">
<h2>The setupBoardGame Function<a class="headerlink" href="#the-setupboardgame-function" title="Permalink to this headline">¶</a></h2>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Set up a new game board and add handlers to all the cells of the board</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">setupBoardGame</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Save current game to state</span>
  <span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span> <span class="o">=</span> <span class="nx">game</span><span class="p">;</span>
  <span class="c1">// Let&#39;s render the board game</span>
  <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;board&quot;</span><span class="p">,</span> <span class="p">{});</span>
  <span class="c1">// Set the marker for our player (X if we are the starting player)</span>
  <span class="nx">application_state</span><span class="p">.</span><span class="nx">marker</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span> <span class="o">==</span> <span class="nx">game</span><span class="p">.</span><span class="nx">current_player</span> <span class="o">?</span> <span class="s2">&quot;x&quot;</span> <span class="o">:</span> <span class="s2">&quot;o&quot;</span><span class="p">;</span>
  <span class="c1">// Get all the rows</span>
  <span class="kd">var</span> <span class="nx">rows</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#board div&#39;</span><span class="p">);</span>

  <span class="c1">// Add an event handler to each cell</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cells</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; span&quot;</span><span class="p">);</span>

    <span class="c1">// For each cell create and add the handler</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">cells</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">cells</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">id</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">game_board_cell_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The <tt class="docutils literal"><span class="pre">setupBoardGame</span></tt> function generates a new Tic-Tac-Toe game and renders the board in the browser and then attaches a handler <tt class="docutils literal"><span class="pre">game_board_cell_handler</span></tt> for each cell in the board that will handle the click of the user on that cell.</p>
<p>We created the <tt class="docutils literal"><span class="pre">public/templates/board.ms</span></tt> earlier and it's time to fill in the template with the layout of the board game.</p>
<div class="highlight-javascript"><pre>&lt;div class="span8"&gt;
  &lt;div id="board" class="board"&gt;
    &lt;div id="row0" class="board_row"&gt;
      &lt;span id="row0cell0"&gt;&lt;img src="/img/board_background_img.png"/&gt;&lt;/span&gt;
      &lt;span id="row0cell1"&gt;&lt;img src="/img/board_background_img.png"/&gt;&lt;/span&gt;
      &lt;span id="row0cell2"&gt;&lt;img src="/img/board_background_img.png"/&gt;&lt;/span&gt;
      &lt;span id="row0cell3"&gt;&lt;img src="/img/board_background_img.png"/&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;div id="row1" class="board_row"&gt;
      &lt;span id="row1cell0"&gt;&lt;img src="/img/board_background_img.png"/&gt;&lt;/span&gt;
      &lt;span id="row1cell1"&gt;&lt;img src="/img/board_background_img.png"/&gt;&lt;/span&gt;
      &lt;span id="row1cell2"&gt;&lt;img src="/img/board_background_img.png"/&gt;&lt;/span&gt;
      &lt;span id="row1cell3"&gt;&lt;img src="/img/board_background_img.png"/&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;div id="row2" class="board_row"&gt;
      &lt;span id="row2cell0"&gt;&lt;img src="/img/board_background_img.png"/&gt;&lt;/span&gt;
      &lt;span id="row2cell1"&gt;&lt;img src="/img/board_background_img.png"/&gt;&lt;/span&gt;
      &lt;span id="row2cell2"&gt;&lt;img src="/img/board_background_img.png"/&gt;&lt;/span&gt;
      &lt;span id="row2cell3"&gt;&lt;img src="/img/board_background_img.png"/&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;div id="row3" class="board_row"&gt;
      &lt;span id="row3cell0"&gt;&lt;img src="/img/board_background_img.png"/&gt;&lt;/span&gt;
      &lt;span id="row3cell1"&gt;&lt;img src="/img/board_background_img.png"/&gt;&lt;/span&gt;
      &lt;span id="row3cell2"&gt;&lt;img src="/img/board_background_img.png"/&gt;&lt;/span&gt;
      &lt;span id="row3cell3"&gt;&lt;img src="/img/board_background_img.png"/&gt;&lt;/span&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;div class="span4"&gt;
&lt;/div&gt;
</pre>
</div>
<p>Nothing special here just a table with 4 rows and 4 columns containing a default background image as a placeholder.</p>
</div>
<div class="section" id="the-game-board-cell-handler-function">
<h2>The game_board_cell_handler Function<a class="headerlink" href="#the-game-board-cell-handler-function" title="Permalink to this headline">¶</a></h2>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Create a cell click handler that will send the events to the server when the user clicks</span>
<span class="cm"> * on an event, and also show the result</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">game_board_cell_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Split up the id to get the cell position</span>
    <span class="kd">var</span> <span class="nx">row_number</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;row&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">cell_number</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">cell_id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">cell_id_image</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">cell_id</span> <span class="o">+</span> <span class="s2">&quot; img&quot;</span><span class="p">;</span>

    <span class="c1">// Let&#39;s attempt to do a move</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">place_marker</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nx">cell_number</span><span class="p">,</span> <span class="nx">row_number</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// If we won</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">==</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;Congratulations&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;You won&lt;/p&gt;&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;You lost&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;You got beaten buddy&lt;/p&gt;&quot;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">marker</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/cross.png&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/circle.png&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The <tt class="docutils literal"><span class="pre">game_board_cell_handler</span></tt> is attached to each cell in the Tic-Tac-Toe board and detects the player clicking on it. When its fired, it will attempt to place a marker in that cell calling the <tt class="docutils literal"><span class="pre">api.place_marker</span></tt> method.</p>
<p>If the placement of the marker leads to victory the player will receive a message back with the field <tt class="docutils literal"><span class="pre">winner</span></tt> set to the session id of the winning player. If that session id matches the calling player he won and we show the winning dialog. If it does not match we show the loser dialog. If we don't have a winner or loser we set the cell with the marker to show the move.</p>
</div>
<div class="section" id="the-general-box-show-function">
<h2>The general_box_show Function<a class="headerlink" href="#the-general-box-show-function" title="Permalink to this headline">¶</a></h2>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * General message box with configurable title and body content</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">general_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Set fields for the error</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_header&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_body&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
  <span class="c1">// Show the modal box</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">({</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Generates a general box dialog with a provided title and body. Used to allow us to show a dialog with a custom title and body.</p>
</div>
<div class="section" id="the-decline-box-show-function">
<h2>The decline_box_show Function<a class="headerlink" href="#the-decline-box-show-function" title="Permalink to this headline">¶</a></h2>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Show a game decline message box</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">decline_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Set fields for the error</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_header&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;Invitation to game was declined&quot;</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_body&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s2">&quot;decline_game&quot;</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">));</span>
  <span class="c1">// Show the modal box</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">({</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Generates a decline box dialog with the information about the gamer who declined the invite.</p>
<p>We use a <tt class="docutils literal"><span class="pre">decline_game</span></tt> template here that we created earlier. Let's fill in the template.</p>
<div class="highlight-javascript"><pre>&lt;p&gt;The invitation to play a game was declined by &lt;strong&gt;{{user_name}}&lt;/strong&gt;&lt;/p&gt;</pre>
</div>
<p>As we can see it just renders the decline message using the passed in player information.</p>
</div>
<div class="section" id="the-game-invite-box-show-function">
<h2>The game_invite_box_show Function<a class="headerlink" href="#the-game-invite-box-show-function" title="Permalink to this headline">¶</a></h2>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Show a game invite message box</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">game_invite_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gamer</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Set fields for the error</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box_header&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;You have been invited to a game&quot;</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box_body&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;The user &lt;strong&gt;&quot;</span> <span class="o">+</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">user_name</span> <span class="o">+</span> <span class="s2">&quot;&lt;/strong&gt; has challenged you to a game&quot;</span><span class="p">);</span>
  <span class="c1">// Show the modal box</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">({</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Generates a accept/decline dialog box populated with the information of the inviting player.</p>
</div>
<div class="section" id="styling-that-game">
<h2>Styling That Game<a class="headerlink" href="#styling-that-game" title="Permalink to this headline">¶</a></h2>
<p>Alright we are all wired up just one more thing to fix. Let's pretty up the board a little by adjusting the css for the board. Open the file <tt class="docutils literal"><span class="pre">public/css/app.css</span></tt> and enter the css.</p>
<div class="highlight-css"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="nc">.board</span> <span class="p">{</span>
  <span class="k">margin-left</span><span class="o">:</span><span class="m">20px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.board_row</span> <span class="p">{</span>
  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.board_row</span> <span class="nt">span</span> <span class="p">{</span>
  <span class="k">margin-right</span><span class="o">:</span> <span class="m">5px</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="wrapping-up">
<h2>Wrapping Up<a class="headerlink" href="#wrapping-up" title="Permalink to this headline">¶</a></h2>
<p>Awesome we just finished <tt class="docutils literal"><span class="pre">Exercise</span> <span class="pre">3</span></tt> and we have a fully working Tic-Tac-Toe game. In <tt class="docutils literal"><span class="pre">Exercise</span> <span class="pre">4</span></tt> we will add some bonus features to the game and also handle a user closing the browser window in the middle of a game or deciding to quit a game in progress.</p>
</div>
<div class="section" id="notes">
<h2>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<p>There is lots of room for improvement in the code that you can do. Deferring the rendering of available players when a dialog is showing is one such thing. Rendering the board once only and clearing it instead of re-rendering might be another possible avenue.</p>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
        <ul>
          <li class="right"><a style="color: #C40B46;" href="http://docs.mongodb.org/manual/" title="MongoDB Docs">MongoDB Docs</a></li>
          <li class="right"><a style="color: #C40B46;" href="http://mongodb.github.com/node-mongodb-native/" title="Driver Docs">Driver Docs</a> | </li>
        </ul>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="tic4.html" title="Tic-Tac-Toe: Exercise 4"
             >next</a></li>
        <li class="right" >
          <a href="tic2.html" title="Tic-Tac-Toe: Exercise 2"
             >previous</a> |</li>
        <li><a href="http://ruby.learncodethehardway.org/">Learn MongoDB And Node.js The Hard Way</a> &raquo;</li> 
        <li class="right"><a href="search.html" title="search">search</a> | </li>
      </ul>
    </div>
    <a name="comments"><hr/></a>

<div sytle="text-align: left">
    <div style="background: white; padding: 10px" id="disqus_thread"></div>
</div>
    <script type="text/javascript">
        var dow = new Date().getDay();

        if(dow == 5 || dow == 6) {
            $("#disqus_thread").html("<h1>Today Is Christians's Day Off</h1><p>I take Saturday and Sunday off.  Comments open again on Monday-Friday.</p>")
        } else {
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'learn-code-the-hard-way'; // required: replace example with your forum shortname


            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        }
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <div class="footer">
      &copy; Copyright 2012, Christian Amor Kvalheim.
      Last updated on Jan 31, 2013.
</div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24168052-9']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </body>
</html>