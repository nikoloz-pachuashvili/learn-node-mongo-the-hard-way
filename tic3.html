<!DOCTYPE html>

<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
    <!--[if gt IE 8]><!-->
<html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />

  <!-- Set the viewport width to device width for mobile -->
  <meta name="viewport" content="width=device-width" />

  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.9.1: http://docutils.sourceforge.net/" />
<title>Tic-Tac-Toe: Exercise 3</title>

  <!-- Included CSS Files (Compressed) -->
  <link rel="stylesheet" href="stylesheets/foundation.min.css">
  <link rel="stylesheet" href="stylesheets/pygments.css">
  <link rel="stylesheet" href="stylesheets/app.css">

  <script src="javascripts/modernizr.foundation.js"></script>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-41953057-1', 'christkv.github.io');
    ga('send', 'pageview');

  </script>  

  <!-- IE Fix for HTML5 Tags -->
  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

</head>
<body>

  <div class="row">
          <h1 class="title">Tic-Tac-Toe: Exercise 3</h1>
      </div>
  </div>

  <div class="row">
    <div class="eleven columns">
        <p>In this exercise we are going to start implementing the process of selecting a player to play against, and playing the game itself. This is where the code gets really interesting. The first step is to display a list of available gamers that we can invite to a game. Next for the invitation to a game we need to handle the invite and accept/reject game mechanics for the game.</p>
<p>The final functionality we are going to implement in this exercise is to actually create the game board and handle the playing of the game.</p>
<div class="section" id="where-is-the-code">
<h1>Where Is The Code</h1>
<p>The code for this exercise is located at</p>
<p><a class="reference external" href="https://github.com/christkv/tic-tac-toe-steps/tree/step2">https://github.com/christkv/tic-tac-toe-steps/tree/step2</a></p>
</div>
<div class="section" id="the-glue-of-it-all">
<h1>The Glue Of It All</h1>
<p>The first thing we need to do is to be able to retrieve a list of all the available gamers. To do this we are going to create a new set of API calls for the gamer as well as extend our current <tt class="docutils literal">Gamer</tt> model class with some more methods. Let's start with the <tt class="docutils literal">Gamer</tt> model. Bring up the file <tt class="docutils literal">lib/models/gamer.js</tt> with an editor and let's add the missing <tt class="docutils literal">API</tt> calls.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic1.js-pyg.html-1"></a><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.js-pyg.html-2"></a>  <span class="kd">var</span> <span class="nx">Gamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>
<a name="code--tic--tic3--tic1.js-pyg.html-3"></a>
<a name="code--tic--tic3--tic1.js-pyg.html-4"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-5"></a>  <span class="c1">// Locate a gamer by his session id</span>
<a name="code--tic--tic3--tic1.js-pyg.html-6"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-7"></a>  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">findGamerBySid</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.js-pyg.html-8"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">).</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">sid</span><span class="o">:</span> <span class="nx">sid</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic1.js-pyg.html-9"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic1.js-pyg.html-10"></a>
<a name="code--tic--tic3--tic1.js-pyg.html-11"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-12"></a>  <span class="c1">// Locate a list of gamers by their session ids</span>
<a name="code--tic--tic3--tic1.js-pyg.html-13"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-14"></a>  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">findAllGamersBySids</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sids</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.js-pyg.html-15"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">({</span><span class="nx">sid</span><span class="o">:</span> <span class="p">{</span><span class="nx">$in</span><span class="o">:</span> <span class="nx">sids</span><span class="p">}}).</span><span class="nx">toArray</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic1.js-pyg.html-16"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic1.js-pyg.html-17"></a>
<a name="code--tic--tic3--tic1.js-pyg.html-18"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-19"></a>  <span class="c1">// Update the last active time for a list of gamers by their session ids</span>
<a name="code--tic--tic3--tic1.js-pyg.html-20"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-21"></a>  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">updateGamersUpdatedDateBySids</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sids</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.js-pyg.html-22"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic1.js-pyg.html-23"></a>      <span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">sid</span><span class="o">:</span><span class="p">{</span><span class="nx">$in</span><span class="o">:</span> <span class="nx">sids</span><span class="p">}},</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">updated_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()}},</span> <span class="p">{</span><span class="nx">multi</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic1.js-pyg.html-24"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic1.js-pyg.html-25"></a>
<a name="code--tic--tic3--tic1.js-pyg.html-26"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-27"></a>  <span class="c1">// Update a gamers current activity time and session id</span>
<a name="code--tic--tic3--tic1.js-pyg.html-28"></a>  <span class="c1">// when they come back after some time away</span>
<a name="code--tic--tic3--tic1.js-pyg.html-29"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-30"></a>  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">updateGamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">sid</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.js-pyg.html-31"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">({</span><span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span><span class="p">}</span>
<a name="code--tic--tic3--tic1.js-pyg.html-32"></a>      <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">updated_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span> <span class="nx">sid</span><span class="o">:</span><span class="nx">sid</span><span class="p">}}</span>
<a name="code--tic--tic3--tic1.js-pyg.html-33"></a>      <span class="p">,</span> <span class="p">{</span><span class="nx">upsert</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic1.js-pyg.html-34"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic1.js-pyg.html-35"></a>
<a name="code--tic--tic3--tic1.js-pyg.html-36"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-37"></a>  <span class="c1">// Initialize the gamer collection, by adding indexes etc</span>
<a name="code--tic--tic3--tic1.js-pyg.html-38"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic1.js-pyg.html-39"></a>  <span class="nx">Gamer</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.js-pyg.html-40"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;gamers&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic1.js-pyg.html-41"></a>      <span class="p">.</span><span class="nx">ensureIndex</span><span class="p">({</span><span class="nx">updated_on</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">expireAfterSeconds</span><span class="o">:</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)},</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic1.js-pyg.html-42"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic1.js-pyg.html-43"></a>
<a name="code--tic--tic3--tic1.js-pyg.html-44"></a>  <span class="k">return</span> <span class="nx">Gamer</span><span class="p">;</span>
<a name="code--tic--tic3--tic1.js-pyg.html-45"></a><span class="p">}</span>
</pre></div><p>The first method <tt class="docutils literal">Gamer.findAllGamersBySids</tt> lets us locate all the gamers associated with a list of <tt class="docutils literal">SocketIO</tt> session ids. This method is used to get the list of all currently active users. The second method <tt class="docutils literal">Gamer.updateGamersUpdatedDateBySids</tt> is used to update the last active time on a set of users identified by their session ids (remember that the <tt class="docutils literal">gamers</tt> collection is a <tt class="docutils literal">TTL</tt> collection that times out active gamers after 1 hour).</p>
</div>
<div class="section" id="the-game-model">
<h1>The Game Model</h1>
<p>We are going to introduce a concept of a <tt class="docutils literal">Game</tt>. A <tt class="docutils literal">Game</tt> keeps track of a specific game between two players in the application. We need to implement a set of functions to handle the transitions of the game over time.</p>
<table border="1" class="docutils">
<colgroup>
<col width="32%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Function</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>create_gamer</td>
<td>Create a brand new game for two players</td>
</tr>
<tr><td>find_name</td>
<td>Locate an existing game by the game id</td>
</tr>
<tr><td>update_board</td>
<td>Update an existing board with the board state</td>
</tr>
<tr><td>finalize_board</td>
<td>Sets the final state of the board (won/draw)</td>
</tr>
</tbody>
</table>
<p>Let's create the files we need.</p>
<pre class="code console literal-block">
<span class="go">touch lib/handlers/gamer_handler.js
touch lib/models/game.js</span>
</pre>
<p>Open the <tt class="docutils literal">lib/models/game.js</tt> file and lets enter the code for the methods we need for the application <tt class="docutils literal">Game.create_gamer</tt>, <tt class="docutils literal">Game.find_name</tt>, <tt class="docutils literal">Game.update_board</tt> and <tt class="docutils literal">Game.finalize_board</tt>.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic2.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">ObjectID</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">).</span><span class="nx">ObjectID</span><span class="p">;</span>
<a name="code--tic--tic3--tic2.js-pyg.html-2"></a>
<a name="code--tic--tic3--tic2.js-pyg.html-3"></a><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic2.js-pyg.html-4"></a>  <span class="kd">var</span> <span class="nx">Game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>
<a name="code--tic--tic3--tic2.js-pyg.html-5"></a>
<a name="code--tic--tic3--tic2.js-pyg.html-6"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic2.js-pyg.html-7"></a>  <span class="c1">// Create a new game, it contains all the information about the two players, </span>
<a name="code--tic--tic3--tic2.js-pyg.html-8"></a>  <span class="c1">// the empty board, the whole game chat record, who is starting the game and </span>
<a name="code--tic--tic3--tic2.js-pyg.html-9"></a>  <span class="c1">// who is the current player.</span>
<a name="code--tic--tic3--tic2.js-pyg.html-10"></a>  <span class="c1">// </span>
<a name="code--tic--tic3--tic2.js-pyg.html-11"></a>  <span class="nx">Game</span><span class="p">.</span><span class="nx">create_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p1_sid</span><span class="p">,</span> <span class="nx">p1_user_name</span>
<a name="code--tic--tic3--tic2.js-pyg.html-12"></a>    <span class="p">,</span> <span class="nx">p1_full_name</span><span class="p">,</span> <span class="nx">p2_sid</span><span class="p">,</span> <span class="nx">p2_user_name</span><span class="p">,</span> <span class="nx">p2_full_name</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic2.js-pyg.html-13"></a>      <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">insert</span><span class="p">({</span>
<a name="code--tic--tic3--tic2.js-pyg.html-14"></a>          <span class="nx">player1_sid</span><span class="o">:</span> <span class="nx">p1_sid</span>
<a name="code--tic--tic3--tic2.js-pyg.html-15"></a>        <span class="p">,</span> <span class="nx">player1_user_name</span><span class="o">:</span> <span class="nx">p1_user_name</span>
<a name="code--tic--tic3--tic2.js-pyg.html-16"></a>        <span class="p">,</span> <span class="nx">player1_full_name</span><span class="o">:</span> <span class="nx">p1_full_name</span>
<a name="code--tic--tic3--tic2.js-pyg.html-17"></a>        <span class="p">,</span> <span class="nx">player2_sid</span><span class="o">:</span> <span class="nx">p2_sid</span>
<a name="code--tic--tic3--tic2.js-pyg.html-18"></a>        <span class="p">,</span> <span class="nx">player2_user_name</span><span class="o">:</span> <span class="nx">p2_user_name</span>
<a name="code--tic--tic3--tic2.js-pyg.html-19"></a>        <span class="p">,</span> <span class="nx">player2_full_name</span><span class="o">:</span> <span class="nx">p2_full_name</span>
<a name="code--tic--tic3--tic2.js-pyg.html-20"></a>        <span class="p">,</span> <span class="nx">board</span><span class="o">:</span> <span class="p">[</span>
<a name="code--tic--tic3--tic2.js-pyg.html-21"></a>            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a name="code--tic--tic3--tic2.js-pyg.html-22"></a>          <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a name="code--tic--tic3--tic2.js-pyg.html-23"></a>          <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a name="code--tic--tic3--tic2.js-pyg.html-24"></a>          <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a name="code--tic--tic3--tic2.js-pyg.html-25"></a>        <span class="p">]</span>
<a name="code--tic--tic3--tic2.js-pyg.html-26"></a>        <span class="p">,</span> <span class="nx">created_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
<a name="code--tic--tic3--tic2.js-pyg.html-27"></a>        <span class="p">,</span> <span class="nx">starting_player</span><span class="o">:</span> <span class="nx">p1_sid</span>
<a name="code--tic--tic3--tic2.js-pyg.html-28"></a>        <span class="p">,</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">p1_sid</span>
<a name="code--tic--tic3--tic2.js-pyg.html-29"></a>      <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic2.js-pyg.html-30"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--tic--tic3--tic2.js-pyg.html-31"></a>        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">?</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">result</span><span class="p">);</span>
<a name="code--tic--tic3--tic2.js-pyg.html-32"></a>      <span class="p">})</span>
<a name="code--tic--tic3--tic2.js-pyg.html-33"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic2.js-pyg.html-34"></a>
<a name="code--tic--tic3--tic2.js-pyg.html-35"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic2.js-pyg.html-36"></a>  <span class="c1">// Locate an existing game by it&#39;s game id</span>
<a name="code--tic--tic3--tic2.js-pyg.html-37"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic2.js-pyg.html-38"></a>  <span class="nx">Game</span><span class="p">.</span><span class="nx">find_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic2.js-pyg.html-39"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">)},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic2.js-pyg.html-40"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--tic--tic3--tic2.js-pyg.html-41"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">doc</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
<a name="code--tic--tic3--tic2.js-pyg.html-42"></a>        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;could not find the game with id &quot;</span> <span class="o">+</span> <span class="nx">game_id</span><span class="p">));</span>
<a name="code--tic--tic3--tic2.js-pyg.html-43"></a>      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">doc</span><span class="p">);</span>
<a name="code--tic--tic3--tic2.js-pyg.html-44"></a>    <span class="p">})</span>
<a name="code--tic--tic3--tic2.js-pyg.html-45"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic2.js-pyg.html-46"></a>
<a name="code--tic--tic3--tic2.js-pyg.html-47"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic2.js-pyg.html-48"></a>  <span class="c1">// Attempt to update the board for a specific game and player</span>
<a name="code--tic--tic3--tic2.js-pyg.html-49"></a>  <span class="c1">// the update fails if the current players is not the player attempting to </span>
<a name="code--tic--tic3--tic2.js-pyg.html-50"></a>  <span class="c1">// update the board notice that since we are doing multiple sets we are </span>
<a name="code--tic--tic3--tic2.js-pyg.html-51"></a>  <span class="c1">// using the $atomic operation to ensure we don&#39;t get any interleaved updates </span>
<a name="code--tic--tic3--tic2.js-pyg.html-52"></a>  <span class="c1">// in between the two sets</span>
<a name="code--tic--tic3--tic2.js-pyg.html-53"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic2.js-pyg.html-54"></a>  <span class="nx">Game</span><span class="p">.</span><span class="nx">update_board</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">game_id</span><span class="p">,</span> <span class="nx">next_sid</span><span class="p">,</span> <span class="nx">board</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic2.js-pyg.html-55"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
<a name="code--tic--tic3--tic2.js-pyg.html-56"></a>        <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">),</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">sid</span><span class="p">,</span> <span class="nx">$atomic</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
<a name="code--tic--tic3--tic2.js-pyg.html-57"></a>      <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">board</span><span class="o">:</span> <span class="nx">board</span><span class="p">,</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">next_sid</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic2.js-pyg.html-58"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--tic--tic3--tic2.js-pyg.html-59"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;It is not your turn&quot;</span><span class="p">));</span>
<a name="code--tic--tic3--tic2.js-pyg.html-60"></a>        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
<a name="code--tic--tic3--tic2.js-pyg.html-61"></a>      <span class="p">});</span>
<a name="code--tic--tic3--tic2.js-pyg.html-62"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic2.js-pyg.html-63"></a>
<a name="code--tic--tic3--tic2.js-pyg.html-64"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic2.js-pyg.html-65"></a>  <span class="c1">// Set the winner on the board if sid == null it&#39;s a draw</span>
<a name="code--tic--tic3--tic2.js-pyg.html-66"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic2.js-pyg.html-67"></a>  <span class="nx">Game</span><span class="p">.</span><span class="nx">finalize_board</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">game_id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic2.js-pyg.html-68"></a>    <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">sid</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s1">&#39;draw&#39;</span> <span class="o">:</span> <span class="s1">&#39;win&#39;</span><span class="p">;</span>
<a name="code--tic--tic3--tic2.js-pyg.html-69"></a>
<a name="code--tic--tic3--tic2.js-pyg.html-70"></a>    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
<a name="code--tic--tic3--tic2.js-pyg.html-71"></a>        <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">)}</span>
<a name="code--tic--tic3--tic2.js-pyg.html-72"></a>      <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">final_state</span><span class="o">:</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">winner</span><span class="o">:</span> <span class="nx">sid</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic2.js-pyg.html-73"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<a name="code--tic--tic3--tic2.js-pyg.html-74"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic3--tic2.js-pyg.html-75"></a>          <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Failed to finalize the board with a winner or draw&quot;</span><span class="p">));</span>
<a name="code--tic--tic3--tic2.js-pyg.html-76"></a>        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
<a name="code--tic--tic3--tic2.js-pyg.html-77"></a>      <span class="p">});</span>
<a name="code--tic--tic3--tic2.js-pyg.html-78"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic2.js-pyg.html-79"></a>
<a name="code--tic--tic3--tic2.js-pyg.html-80"></a>  <span class="c1">// Return Game object class</span>
<a name="code--tic--tic3--tic2.js-pyg.html-81"></a>  <span class="k">return</span> <span class="nx">Game</span><span class="p">;</span>
<a name="code--tic--tic3--tic2.js-pyg.html-82"></a><span class="p">}</span>
</pre></div><p>Let's start off with the <tt class="docutils literal">Game.create_game</tt> function. As we can see it takes quite a bit of parameters.</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>p1_sid</td>
<td>The session id for player 1</td>
</tr>
<tr><td>p1_user_name</td>
<td>The user name of player 1</td>
</tr>
<tr><td>p1_full_name</td>
<td>The full name of player 1</td>
</tr>
<tr><td>p2_sid</td>
<td>The session id for player 2</td>
</tr>
<tr><td>p2_user_name</td>
<td>The user name of player 2</td>
</tr>
<tr><td>p2_full_name</td>
<td>The full name of player 2</td>
</tr>
</tbody>
</table>
<p>The <tt class="docutils literal">Game.create_game</tt> method creates a new game document representing the starting state of a game between two players.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
    <span class="nx">player1_sid</span><span class="o">:</span> <span class="s2">&quot;some session id 1&quot;</span>
  <span class="p">,</span> <span class="nx">player1_user_name</span><span class="o">:</span> <span class="s2">&quot;player1&quot;</span>
  <span class="p">,</span> <span class="nx">player1_full_name</span><span class="o">:</span> <span class="s2">&quot;Joe Player 1&quot;</span>
  <span class="p">,</span> <span class="nx">player2_sid</span><span class="o">:</span> <span class="s2">&quot;some session id 2&quot;</span>
  <span class="p">,</span> <span class="nx">player2_user_name</span><span class="o">:</span> <span class="s2">&quot;player2&quot;</span>
  <span class="p">,</span> <span class="nx">player2_full_name</span><span class="o">:</span> <span class="s2">&quot;Joe Player 2&quot;</span>
  <span class="p">,</span> <span class="nx">board</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
  <span class="p">]</span>
  <span class="p">,</span> <span class="nx">created_on</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">starting_player</span><span class="o">:</span> <span class="s2">&quot;some session id 1&quot;</span>
  <span class="p">,</span> <span class="nx">current_player</span><span class="o">:</span> <span class="s2">&quot;some session id 1&quot;</span>
<span class="p">}</span>
</pre>
<p>The first six values in the document (<tt class="docutils literal">player1_sid</tt>, <tt class="docutils literal">player1_user_name</tt>, <tt class="docutils literal">player1_full_name</tt>, <tt class="docutils literal">player2_sid</tt>, <tt class="docutils literal">player2_user_name</tt> and <tt class="docutils literal">player2_full_name</tt>) are the ones passed to the function and define who the two players are. The next field down is the <tt class="docutils literal">board</tt> field that contains A <tt class="docutils literal">2D</tt> representation of the <tt class="docutils literal"><span class="pre">Tic-Tac-Toe</span></tt> board where we will store the state of the game.</p>
<p>The <tt class="docutils literal">created_on</tt> field contains the date of when the game was created. The <tt class="docutils literal">starting_player</tt> field is the session id of the player that gets the first move and the <tt class="docutils literal">current_player</tt> field is the session id of player who has the next move. This field is used to make sure only the player who has the next move can update the state of the board.</p>
<p>Next, let's look at the <tt class="docutils literal">Game.find_game</tt> method. Not much to say here. Each <tt class="docutils literal">Game</tt> document has a <tt class="docutils literal">_id</tt> field containing an <tt class="docutils literal">ObjectID</tt> assigned to it by <tt class="docutils literal">MongoDB</tt> and this method lets us locate a board using that <tt class="docutils literal">ObjectID</tt>.</p>
<p>The <tt class="docutils literal">Game.update_board</tt> method handles the updating of a game between two players.</p>
<pre class="code javascript literal-block">
<span class="nx">Game</span><span class="p">.</span><span class="nx">update_board</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">game_id</span><span class="p">,</span> <span class="nx">next_sid</span><span class="p">,</span> <span class="nx">board</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'games'</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
      <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">),</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">sid</span><span class="p">,</span> <span class="nx">$atomic</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">board</span><span class="o">:</span> <span class="nx">board</span><span class="p">,</span> <span class="nx">current_player</span><span class="o">:</span> <span class="nx">next_sid</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;It is not your turn&quot;</span><span class="p">));</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>The parameters passed passed into <tt class="docutils literal">Game.update_board</tt> are used to locate a board where the <tt class="docutils literal">game_id</tt> and <tt class="docutils literal">current_player</tt> match. This will only happen when the caller attempting to update the board is the current player allowed to make a move. If it's not the current player the number of documents that were updated will be 0 and the method returns an error explaining that it's not that users turn to place a marker on the board.</p>
<p>If it is the callers turn to place a marker the function updates the <tt class="docutils literal">board</tt> field of the document with the new document state and sets the <tt class="docutils literal">current_player</tt> to the session id of the other player allowing the other player to play his turn next.</p>
<p>Finally let's look at the <tt class="docutils literal">Game.finalize_board</tt> where we set the final state of a game after the game is done.</p>
<pre class="code javascript literal-block">
<span class="c1">//
// Set the winner on the board if sid == null it's a draw
//
</span><span class="nx">Game</span><span class="p">.</span><span class="nx">finalize_board</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">game_id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">sid</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s1">'draw'</span> <span class="o">:</span> <span class="s1">'win'</span><span class="p">;</span>

  <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'games'</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span>
      <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectID</span><span class="p">(</span><span class="nx">game_id</span><span class="p">)}</span>
    <span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">final_state</span><span class="o">:</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">winner</span><span class="o">:</span> <span class="nx">sid</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Failed to finalize the board with a winner or draw&quot;</span><span class="p">));</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>If the session id passed in is a <tt class="docutils literal">null</tt> value it's a draw and the <tt class="docutils literal">final_state</tt> field is set to <tt class="docutils literal">draw</tt> and the winner field to <tt class="docutils literal">null</tt>. Otherwise the <tt class="docutils literal">final_state</tt> field is set to <tt class="docutils literal">win</tt> and the <tt class="docutils literal">winner field</tt> to the winners session id.</p>
<p>We can now create, locate and update as well as finalize a game correctly and also ensure that a board is never updated by a user who's not currently allowed to.</p>
</div>
<div class="section" id="the-game-handler">
<h1>The Game Handler</h1>
<p>Some of the things we need to ensure is that we should not be able to call functions unless we are correctly logged in as a gamer. We also need to have a way to locate a given <tt class="docutils literal">SocketIO</tt> socket given only another users session id.</p>
<p>For the first part we will implement a method called <tt class="docutils literal">is_authenticated</tt> and for the second part a method called <tt class="docutils literal">locate_connection_with_session</tt>. Bring up the file <tt class="docutils literal">lib/models/shared.js</tt> and add the methods as shown below.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic3.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">is_authenticated</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-2"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<a name="code--tic--tic3--tic3.js-pyg.html-3"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">].</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<a name="code--tic--tic3--tic3.js-pyg.html-4"></a>  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic3.js-pyg.html-5"></a><span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-6"></a>
<a name="code--tic--tic3--tic3.js-pyg.html-7"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic3.js-pyg.html-8"></a><span class="cm"> * Emit the standard error message across the SocketIO connection</span>
<a name="code--tic--tic3--tic3.js-pyg.html-9"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic3.js-pyg.html-10"></a><span class="kd">var</span> <span class="nx">emit_error</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-11"></a>  <span class="k">if</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">socket</span><span class="p">))</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-12"></a>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-13"></a>      <span class="nx">socket</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-14"></a>          <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
<a name="code--tic--tic3--tic3.js-pyg.html-15"></a>        <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--tic--tic3--tic3.js-pyg.html-16"></a>        <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span><span class="kc">true</span>
<a name="code--tic--tic3--tic3.js-pyg.html-17"></a>        <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
<a name="code--tic--tic3--tic3.js-pyg.html-18"></a>      <span class="p">});</span>
<a name="code--tic--tic3--tic3.js-pyg.html-19"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-20"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-21"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-22"></a>        <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
<a name="code--tic--tic3--tic3.js-pyg.html-23"></a>      <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--tic--tic3--tic3.js-pyg.html-24"></a>      <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span><span class="kc">true</span>
<a name="code--tic--tic3--tic3.js-pyg.html-25"></a>      <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
<a name="code--tic--tic3--tic3.js-pyg.html-26"></a>    <span class="p">});</span>
<a name="code--tic--tic3--tic3.js-pyg.html-27"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-28"></a><span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-29"></a>
<a name="code--tic--tic3--tic3.js-pyg.html-30"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic3.js-pyg.html-31"></a><span class="cm"> * Emit the standard message across the SocketIO connection</span>
<a name="code--tic--tic3--tic3.js-pyg.html-32"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic3.js-pyg.html-33"></a><span class="kd">var</span> <span class="nx">emit_message</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-34"></a>  <span class="c1">// Add event</span>
<a name="code--tic--tic3--tic3.js-pyg.html-35"></a>  <span class="nx">message</span><span class="p">.</span><span class="nx">event</span> <span class="o">=</span> <span class="nx">event</span><span class="p">;</span>
<a name="code--tic--tic3--tic3.js-pyg.html-36"></a>  <span class="c1">// Emit</span>
<a name="code--tic--tic3--tic3.js-pyg.html-37"></a>  <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
<a name="code--tic--tic3--tic3.js-pyg.html-38"></a><span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-39"></a>
<a name="code--tic--tic3--tic3.js-pyg.html-40"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic3.js-pyg.html-41"></a><span class="cm"> * Locate a specific connection by it&#39;s session id of all connections available</span>
<a name="code--tic--tic3--tic3.js-pyg.html-42"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic3.js-pyg.html-43"></a><span class="kd">var</span> <span class="nx">locate_connection_with_session</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">sid</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-44"></a>  <span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">clients</span><span class="p">();</span>
<a name="code--tic--tic3--tic3.js-pyg.html-45"></a>
<a name="code--tic--tic3--tic3.js-pyg.html-46"></a>  <span class="c1">// Locate our session id</span>
<a name="code--tic--tic3--tic3.js-pyg.html-47"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-48"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">==</span> <span class="nx">sid</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-49"></a>      <span class="k">return</span> <span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<a name="code--tic--tic3--tic3.js-pyg.html-50"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-51"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-52"></a>
<a name="code--tic--tic3--tic3.js-pyg.html-53"></a>  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<a name="code--tic--tic3--tic3.js-pyg.html-54"></a><span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-55"></a>
<a name="code--tic--tic3--tic3.js-pyg.html-56"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic3.js-pyg.html-57"></a><span class="cm"> * Emit a message to all clients minus the excluded session id connection</span>
<a name="code--tic--tic3--tic3.js-pyg.html-58"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic3.js-pyg.html-59"></a><span class="kd">var</span> <span class="nx">emit_message_all</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">exclude_sid</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-60"></a>  <span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">clients</span><span class="p">();</span>
<a name="code--tic--tic3--tic3.js-pyg.html-61"></a>
<a name="code--tic--tic3--tic3.js-pyg.html-62"></a>  <span class="c1">// Locate our session id</span>
<a name="code--tic--tic3--tic3.js-pyg.html-63"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-64"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">!=</span> <span class="nx">exclude_sid</span>
<a name="code--tic--tic3--tic3.js-pyg.html-65"></a>      <span class="o">&amp;&amp;</span> <span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span>
<a name="code--tic--tic3--tic3.js-pyg.html-66"></a>      <span class="o">&amp;&amp;</span> <span class="nx">session_store</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">].</span><span class="nx">user_name</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic3.js-pyg.html-67"></a>      <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<a name="code--tic--tic3--tic3.js-pyg.html-68"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-69"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-70"></a><span class="p">}</span>
<a name="code--tic--tic3--tic3.js-pyg.html-71"></a>
<a name="code--tic--tic3--tic3.js-pyg.html-72"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">is_authenticated</span>                <span class="o">=</span> <span class="nx">is_authenticated</span><span class="p">;</span>
<a name="code--tic--tic3--tic3.js-pyg.html-73"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">emit_error</span>                      <span class="o">=</span> <span class="nx">emit_error</span><span class="p">;</span>
<a name="code--tic--tic3--tic3.js-pyg.html-74"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">emit_message</span>                    <span class="o">=</span> <span class="nx">emit_message</span><span class="p">;</span>
<a name="code--tic--tic3--tic3.js-pyg.html-75"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">locate_connection_with_session</span>  <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">;</span>
<a name="code--tic--tic3--tic3.js-pyg.html-76"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">emit_message_all</span>                <span class="o">=</span> <span class="nx">emit_message_all</span><span class="p">;</span>
</pre></div><p>Alright we have the plumbing we need. It's time to implement the logic we need for the game on the backend. Let's open up the <tt class="docutils literal">lib/handlers/gamer_handler.js</tt> file and get typing.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic4.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">emit_message</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_message</span>
<a name="code--tic--tic3--tic4.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">is_authenticated</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">is_authenticated</span>
<a name="code--tic--tic3--tic4.js-pyg.html-3"></a>  <span class="p">,</span> <span class="nx">locate_connection_with_session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-4"></a>                                        <span class="p">.</span><span class="nx">locate_connection_with_session</span>
<a name="code--tic--tic3--tic4.js-pyg.html-5"></a>  <span class="p">,</span> <span class="nx">emit_error</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/shared&quot;</span><span class="p">).</span><span class="nx">emit_error</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-6"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-7"></a><span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/user&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-8"></a>  <span class="p">,</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/gamer&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-9"></a>  <span class="p">,</span> <span class="nx">game</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/game&#39;</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-10"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-11"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic4.js-pyg.html-12"></a><span class="cm"> * Locate all the available gamers by their session IDs. We do this by introspecting</span>
<a name="code--tic--tic3--tic4.js-pyg.html-13"></a><span class="cm"> * all available connections for SocketIO. However note that if we wanted to use</span>
<a name="code--tic--tic3--tic4.js-pyg.html-14"></a><span class="cm"> * the cluster functionality in Node.JS we would probably have to rewrite this as</span>
<a name="code--tic--tic3--tic4.js-pyg.html-15"></a><span class="cm"> * a lot of the users might be living in different processes and by default SocketIO</span>
<a name="code--tic--tic3--tic4.js-pyg.html-16"></a><span class="cm"> * is only single process aware.</span>
<a name="code--tic--tic3--tic4.js-pyg.html-17"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic4.js-pyg.html-18"></a><span class="kd">var</span> <span class="nx">find_all_available_gamers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-19"></a>  <span class="c1">// Easier to keep track of where we emitting messages</span>
<a name="code--tic--tic3--tic4.js-pyg.html-20"></a>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;find_all_available_gamers&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-21"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-22"></a>  <span class="c1">// Function we return that accepts the data from SocketIO</span>
<a name="code--tic--tic3--tic4.js-pyg.html-23"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-24"></a>    <span class="c1">// Ensure the user is logged on and emit an error to the </span>
<a name="code--tic--tic3--tic4.js-pyg.html-25"></a>    <span class="c1">// calling function if it&#39;s not the case</span>
<a name="code--tic--tic3--tic4.js-pyg.html-26"></a>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
<a name="code--tic--tic3--tic4.js-pyg.html-27"></a>      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-28"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-29"></a>    <span class="c1">// Locate all active socket connections</span>
<a name="code--tic--tic3--tic4.js-pyg.html-30"></a>    <span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">clients</span><span class="p">();</span>
<a name="code--tic--tic3--tic4.js-pyg.html-31"></a>    <span class="kd">var</span> <span class="nx">sids</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--tic--tic3--tic4.js-pyg.html-32"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-33"></a>    <span class="c1">// Find all the users session ids excluding the calling functions</span>
<a name="code--tic--tic3--tic4.js-pyg.html-34"></a>    <span class="c1">// this makes up all current active gamers</span>
<a name="code--tic--tic3--tic4.js-pyg.html-35"></a>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-36"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">!=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-37"></a>        <span class="nx">sids</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-38"></a>      <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-39"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-40"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-41"></a>    <span class="c1">// Locate all the gamers by their session ids</span>
<a name="code--tic--tic3--tic4.js-pyg.html-42"></a>    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findAllGamersBySids</span><span class="p">(</span><span class="nx">sids</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-43"></a>      <span class="c1">// If there is an error during the query return it to the calling function</span>
<a name="code--tic--tic3--tic4.js-pyg.html-44"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-45"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-46"></a>      <span class="c1">// Update All the gamers last active time</span>
<a name="code--tic--tic3--tic4.js-pyg.html-47"></a>      <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">updateGamersUpdatedDateBySids</span><span class="p">(</span><span class="nx">sids</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-48"></a>        <span class="c1">// If there is an error during the update return it to the calling function</span>
<a name="code--tic--tic3--tic4.js-pyg.html-49"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-50"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-51"></a>        <span class="c1">// Emit the list of gamers to the calling function on the client</span>
<a name="code--tic--tic3--tic4.js-pyg.html-52"></a>        <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-53"></a>            <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
<a name="code--tic--tic3--tic4.js-pyg.html-54"></a>          <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">gamers</span>
<a name="code--tic--tic3--tic4.js-pyg.html-55"></a>        <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-56"></a>      <span class="p">});</span>
<a name="code--tic--tic3--tic4.js-pyg.html-57"></a>    <span class="p">});</span>
<a name="code--tic--tic3--tic4.js-pyg.html-58"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-59"></a><span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-60"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-61"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic4.js-pyg.html-62"></a><span class="cm"> * Invite a gamer to play a game</span>
<a name="code--tic--tic3--tic4.js-pyg.html-63"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic4.js-pyg.html-64"></a><span class="kd">var</span> <span class="nx">invite_gamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-65"></a>  <span class="c1">// Easier to keep track of where we emitting messages</span>
<a name="code--tic--tic3--tic4.js-pyg.html-66"></a>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;invite_gamer&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-67"></a>  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;game_invite&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-68"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-69"></a>  <span class="c1">// Function we return that accepts the data from SocketIO</span>
<a name="code--tic--tic3--tic4.js-pyg.html-70"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-71"></a>    <span class="c1">// Ensure the user is logged on and emit an error to </span>
<a name="code--tic--tic3--tic4.js-pyg.html-72"></a>    <span class="c1">// the calling function if it&#39;s not the case</span>
<a name="code--tic--tic3--tic4.js-pyg.html-73"></a>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
<a name="code--tic--tic3--tic4.js-pyg.html-74"></a>      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-75"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-76"></a>    <span class="c1">// Locate the destination connection</span>
<a name="code--tic--tic3--tic4.js-pyg.html-77"></a>    <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-78"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-79"></a>    <span class="c1">// If there is no connection it means the other player went away, send an error message</span>
<a name="code--tic--tic3--tic4.js-pyg.html-80"></a>    <span class="c1">// to the calling function on the client</span>
<a name="code--tic--tic3--tic4.js-pyg.html-81"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-82"></a>      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Invited user is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-83"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-84"></a>    <span class="c1">// Grab our session id</span>
<a name="code--tic--tic3--tic4.js-pyg.html-85"></a>    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-86"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-87"></a>    <span class="c1">// Locate our gamer object using our session id</span>
<a name="code--tic--tic3--tic4.js-pyg.html-88"></a>    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findGamerBySid</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamer_doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-89"></a>      <span class="c1">// If there is an error during the query return it to the calling function</span>
<a name="code--tic--tic3--tic4.js-pyg.html-90"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-91"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-92"></a>      <span class="c1">// Invite the other player to play a game with the</span>
<a name="code--tic--tic3--tic4.js-pyg.html-93"></a>      <span class="c1">// calling player, we send the calling players session id and his gamer information</span>
<a name="code--tic--tic3--tic4.js-pyg.html-94"></a>      <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-95"></a>          <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
<a name="code--tic--tic3--tic4.js-pyg.html-96"></a>        <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-97"></a>            <span class="nx">sid</span><span class="o">:</span> <span class="nx">our_sid</span>
<a name="code--tic--tic3--tic4.js-pyg.html-98"></a>          <span class="p">,</span> <span class="nx">gamer</span><span class="o">:</span> <span class="nx">gamer_doc</span>
<a name="code--tic--tic3--tic4.js-pyg.html-99"></a>        <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-100"></a>      <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-101"></a>    <span class="p">});</span>
<a name="code--tic--tic3--tic4.js-pyg.html-102"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-103"></a><span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-104"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-105"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic4.js-pyg.html-106"></a><span class="cm"> * Handles the users decision to decline an invitation to a game</span>
<a name="code--tic--tic3--tic4.js-pyg.html-107"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic4.js-pyg.html-108"></a><span class="kd">var</span> <span class="nx">decline_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-109"></a>  <span class="c1">// Easier to keep track of where we emitting messages</span>
<a name="code--tic--tic3--tic4.js-pyg.html-110"></a>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;decline_game&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-111"></a>  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;invite_gamer&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-112"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-113"></a>  <span class="c1">// Function we return that accepts the data from SocketIO</span>
<a name="code--tic--tic3--tic4.js-pyg.html-114"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-115"></a>    <span class="c1">// Ensure the user is logged on and emit an error to the </span>
<a name="code--tic--tic3--tic4.js-pyg.html-116"></a>    <span class="c1">// calling function if it&#39;s not the case</span>
<a name="code--tic--tic3--tic4.js-pyg.html-117"></a>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
<a name="code--tic--tic3--tic4.js-pyg.html-118"></a>      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-119"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-120"></a>    <span class="c1">// Grab our session id</span>
<a name="code--tic--tic3--tic4.js-pyg.html-121"></a>    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-122"></a>    <span class="c1">// Locate the destination connection</span>
<a name="code--tic--tic3--tic4.js-pyg.html-123"></a>    <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-124"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-125"></a>    <span class="c1">// If there is no connection it means the other player went away, send an error message</span>
<a name="code--tic--tic3--tic4.js-pyg.html-126"></a>    <span class="c1">// to the calling function on the client</span>
<a name="code--tic--tic3--tic4.js-pyg.html-127"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-128"></a>      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-129"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-130"></a>    <span class="c1">// Send an error to the player who sent the invite, outlining the decline of the offer</span>
<a name="code--tic--tic3--tic4.js-pyg.html-131"></a>    <span class="c1">// to play a game</span>
<a name="code--tic--tic3--tic4.js-pyg.html-132"></a>    <span class="nx">emit_error</span><span class="p">(</span><span class="nx">invite_gamer</span><span class="p">,</span> <span class="s2">&quot;User declined game&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-133"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-134"></a><span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-135"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-136"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic4.js-pyg.html-137"></a><span class="cm"> * Handles the users decision to accept an invitation to play a game</span>
<a name="code--tic--tic3--tic4.js-pyg.html-138"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic4.js-pyg.html-139"></a><span class="kd">var</span> <span class="nx">accept_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-140"></a>  <span class="c1">// Easier to keep track of where we emitting messages</span>
<a name="code--tic--tic3--tic4.js-pyg.html-141"></a>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;accept_game&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-142"></a>  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;invite_gamer&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-143"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-144"></a>  <span class="c1">// Function we return that accepts the data from SocketIO</span>
<a name="code--tic--tic3--tic4.js-pyg.html-145"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-146"></a>    <span class="c1">// Ensure the user is logged on and emit an error to the calling </span>
<a name="code--tic--tic3--tic4.js-pyg.html-147"></a>    <span class="c1">// function if it&#39;s not the case</span>
<a name="code--tic--tic3--tic4.js-pyg.html-148"></a>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
<a name="code--tic--tic3--tic4.js-pyg.html-149"></a>      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-150"></a>    <span class="c1">// Our session id</span>
<a name="code--tic--tic3--tic4.js-pyg.html-151"></a>    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-152"></a>    <span class="c1">// Locate the destination connection</span>
<a name="code--tic--tic3--tic4.js-pyg.html-153"></a>    <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-154"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-155"></a>    <span class="c1">// If there is no connection it means the other player went away, send an error message</span>
<a name="code--tic--tic3--tic4.js-pyg.html-156"></a>    <span class="c1">// to the calling function on the client</span>
<a name="code--tic--tic3--tic4.js-pyg.html-157"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-158"></a>      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-159"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-160"></a>    <span class="c1">// Locate both the calling player and the destination player by their session ids</span>
<a name="code--tic--tic3--tic4.js-pyg.html-161"></a>    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findAllGamersBySids</span><span class="p">([</span><span class="nx">our_sid</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">players</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-162"></a>      <span class="c1">// If we have an error notify both the inviter and </span>
<a name="code--tic--tic3--tic4.js-pyg.html-163"></a>      <span class="c1">// the invited player about an error</span>
<a name="code--tic--tic3--tic4.js-pyg.html-164"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="nx">players</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-165"></a>        <span class="nx">emit_error</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="s2">&quot;Failed to locate players for game acceptance&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-166"></a>        <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span>
<a name="code--tic--tic3--tic4.js-pyg.html-167"></a>          <span class="p">,</span> <span class="s2">&quot;Failed to locate players for game acceptance&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-168"></a>      <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-169"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-170"></a>      <span class="c1">// Grab player 1 and player 2 from the results</span>
<a name="code--tic--tic3--tic4.js-pyg.html-171"></a>      <span class="kd">var</span> <span class="nx">p1</span> <span class="o">=</span> <span class="nx">players</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a name="code--tic--tic3--tic4.js-pyg.html-172"></a>      <span class="kd">var</span> <span class="nx">p2</span> <span class="o">=</span> <span class="nx">players</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a name="code--tic--tic3--tic4.js-pyg.html-173"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-174"></a>      <span class="c1">// Create a new game with player 1 and player 2</span>
<a name="code--tic--tic3--tic4.js-pyg.html-175"></a>      <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">create_game</span><span class="p">(</span><span class="nx">p1</span><span class="p">.</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">p1</span><span class="p">.</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">p1</span><span class="p">.</span><span class="nx">full_name</span>
<a name="code--tic--tic3--tic4.js-pyg.html-176"></a>        <span class="p">,</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">full_name</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game_doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-177"></a>          <span class="c1">// If we have an error notify both the inviter and the invited player about an error</span>
<a name="code--tic--tic3--tic4.js-pyg.html-178"></a>          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-179"></a>            <span class="nx">emit_error</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="s2">&quot;Failed to create a new game&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-180"></a>            <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Failed to create a new game&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-181"></a>          <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-182"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-183"></a>          <span class="c1">// We have a new game, notify both players about the new game information</span>
<a name="code--tic--tic3--tic4.js-pyg.html-184"></a>          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">game_doc</span> <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-185"></a>          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">game_doc</span> <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-186"></a>      <span class="p">});</span>
<a name="code--tic--tic3--tic4.js-pyg.html-187"></a>    <span class="p">});</span>
<a name="code--tic--tic3--tic4.js-pyg.html-188"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-189"></a><span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-190"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-191"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic4.js-pyg.html-192"></a><span class="cm"> * Handles the users decision to accept an invitation to play a game</span>
<a name="code--tic--tic3--tic4.js-pyg.html-193"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic4.js-pyg.html-194"></a><span class="kd">var</span> <span class="nx">place_marker</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-195"></a>  <span class="c1">// Easier to keep track of where we emitting messages</span>
<a name="code--tic--tic3--tic4.js-pyg.html-196"></a>  <span class="kd">var</span> <span class="nx">calling_method_name</span>      <span class="o">=</span> <span class="s2">&quot;place_marker&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-197"></a>  <span class="kd">var</span> <span class="nx">event_name_move</span>          <span class="o">=</span> <span class="s2">&quot;game_move&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-198"></a>  <span class="kd">var</span> <span class="nx">event_name_game_over</span>     <span class="o">=</span> <span class="s2">&quot;game_over&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-199"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-200"></a>  <span class="c1">// Function we return that accepts the data from SocketIO</span>
<a name="code--tic--tic3--tic4.js-pyg.html-201"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-202"></a>    <span class="c1">// Ensure the user is logged on and emit an error to the </span>
<a name="code--tic--tic3--tic4.js-pyg.html-203"></a>    <span class="c1">// calling function if it&#39;s not the case</span>
<a name="code--tic--tic3--tic4.js-pyg.html-204"></a>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
<a name="code--tic--tic3--tic4.js-pyg.html-205"></a>      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-206"></a>    <span class="c1">// Grab our session id</span>
<a name="code--tic--tic3--tic4.js-pyg.html-207"></a>    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-208"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-209"></a>    <span class="c1">// Locate the game we want to place a marker on</span>
<a name="code--tic--tic3--tic4.js-pyg.html-210"></a>    <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">find_game</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game_doc</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-211"></a>      <span class="c1">// If there is an error during the query return it to the calling function</span>
<a name="code--tic--tic3--tic4.js-pyg.html-212"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Could not find the game&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-213"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-214"></a>      <span class="c1">// Let&#39;s get the current board in play</span>
<a name="code--tic--tic3--tic4.js-pyg.html-215"></a>      <span class="kd">var</span> <span class="nx">board</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">board</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-216"></a>      <span class="c1">// Get the marker for the calling player (if we are the starting player we are X)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-217"></a>      <span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">starting_player</span> <span class="o">==</span> <span class="nx">our_sid</span> <span class="o">?</span> <span class="s2">&quot;x&quot;</span> <span class="o">:</span> <span class="s2">&quot;o&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-218"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-219"></a>      <span class="c1">// Locate other players session id</span>
<a name="code--tic--tic3--tic4.js-pyg.html-220"></a>      <span class="kd">var</span> <span class="nx">other_player_sid</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span> <span class="o">==</span> <span class="nx">our_sid</span>
<a name="code--tic--tic3--tic4.js-pyg.html-221"></a>        <span class="o">?</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player2_sid</span>
<a name="code--tic--tic3--tic4.js-pyg.html-222"></a>        <span class="o">:</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-223"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-224"></a>      <span class="c1">// If we are trying to set a cell that&#39;s already set emit </span>
<a name="code--tic--tic3--tic4.js-pyg.html-225"></a>      <span class="c1">// an error to the calling function</span>
<a name="code--tic--tic3--tic4.js-pyg.html-226"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span> <span class="o">||</span> <span class="nx">board</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-227"></a>        <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Cell already selected&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-228"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-229"></a>      <span class="c1">// Mark the cell with our marker</span>
<a name="code--tic--tic3--tic4.js-pyg.html-230"></a>      <span class="nx">board</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="nx">marker</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-231"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-232"></a>      <span class="c1">// Attempt to update the board</span>
<a name="code--tic--tic3--tic4.js-pyg.html-233"></a>      <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">update_board</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">other_player_sid</span><span class="p">,</span> <span class="nx">board</span>
<a name="code--tic--tic3--tic4.js-pyg.html-234"></a>        <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-235"></a>          <span class="c1">// If we have an error it was not our turn</span>
<a name="code--tic--tic3--tic4.js-pyg.html-236"></a>          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-237"></a>            <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Not your turn&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-238"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-239"></a>          <span class="c1">// Locate the destination connection</span>
<a name="code--tic--tic3--tic4.js-pyg.html-240"></a>          <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">other_player_sid</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-241"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-242"></a>          <span class="c1">// If there is no connection it means the other player went away, </span>
<a name="code--tic--tic3--tic4.js-pyg.html-243"></a>          <span class="c1">// send an error message to the calling function on the client</span>
<a name="code--tic--tic3--tic4.js-pyg.html-244"></a>          <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-245"></a>            <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-246"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-247"></a>          <span class="c1">// Emit valid move message to caller and the other player</span>
<a name="code--tic--tic3--tic4.js-pyg.html-248"></a>          <span class="c1">// this notifies the clients that they can draw the marker on the board</span>
<a name="code--tic--tic3--tic4.js-pyg.html-249"></a>          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
<a name="code--tic--tic3--tic4.js-pyg.html-250"></a>            <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">y</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="o">:</span> <span class="nx">marker</span><span class="p">}</span> <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-251"></a>            <span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-252"></a>          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_move</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
<a name="code--tic--tic3--tic4.js-pyg.html-253"></a>            <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">y</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="o">:</span> <span class="nx">marker</span><span class="p">}</span> <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-254"></a>            <span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-255"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-256"></a>          <span class="c1">// If there was no winner this turn</span>
<a name="code--tic--tic3--tic4.js-pyg.html-257"></a>          <span class="k">if</span><span class="p">(</span><span class="nx">is_game_over</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="p">)</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-258"></a>            <span class="c1">// If there are still fields left on the board, let&#39;s keep playing</span>
<a name="code--tic--tic3--tic4.js-pyg.html-259"></a>            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_game_draw</span><span class="p">(</span><span class="nx">board</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-260"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-261"></a>            <span class="c1">// Set the winner</span>
<a name="code--tic--tic3--tic4.js-pyg.html-262"></a>            <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">finalize_board</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-263"></a>              <span class="c1">// If we have an error it was not our turn</span>
<a name="code--tic--tic3--tic4.js-pyg.html-264"></a>              <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-265"></a>                <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span>
<a name="code--tic--tic3--tic4.js-pyg.html-266"></a>                  <span class="p">,</span> <span class="s2">&quot;Failed to set winner on table&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-267"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-268"></a>              <span class="c1">// If there are no open spots left on the board the game</span>
<a name="code--tic--tic3--tic4.js-pyg.html-269"></a>              <span class="c1">// is a draw</span>
<a name="code--tic--tic3--tic4.js-pyg.html-270"></a>              <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span>
<a name="code--tic--tic3--tic4.js-pyg.html-271"></a>                <span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">draw</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span> <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-272"></a>              <span class="k">return</span> <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span>
<a name="code--tic--tic3--tic4.js-pyg.html-273"></a>                <span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">draw</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span> <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-274"></a>            <span class="p">});</span>
<a name="code--tic--tic3--tic4.js-pyg.html-275"></a>          <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-276"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-277"></a>          <span class="c1">// Set the winner</span>
<a name="code--tic--tic3--tic4.js-pyg.html-278"></a>          <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">finalize_board</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-279"></a>            <span class="c1">// If we have an error it was not our turn</span>
<a name="code--tic--tic3--tic4.js-pyg.html-280"></a>            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<a name="code--tic--tic3--tic4.js-pyg.html-281"></a>              <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span>
<a name="code--tic--tic3--tic4.js-pyg.html-282"></a>                <span class="p">,</span> <span class="s2">&quot;Failed to set winner on table&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-283"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-284"></a>            <span class="c1">// There was a winner and it was the last user to place a </span>
<a name="code--tic--tic3--tic4.js-pyg.html-285"></a>            <span class="c1">// marker (the calling client) signal both players who won the game</span>
<a name="code--tic--tic3--tic4.js-pyg.html-286"></a>            <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span>
<a name="code--tic--tic3--tic4.js-pyg.html-287"></a>              <span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">winner</span><span class="o">:</span> <span class="nx">our_sid</span><span class="p">}</span> <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-288"></a>            <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span>
<a name="code--tic--tic3--tic4.js-pyg.html-289"></a>              <span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">winner</span><span class="o">:</span> <span class="nx">our_sid</span><span class="p">}</span> <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
<a name="code--tic--tic3--tic4.js-pyg.html-290"></a>          <span class="p">});</span>
<a name="code--tic--tic3--tic4.js-pyg.html-291"></a>      <span class="p">})</span>
<a name="code--tic--tic3--tic4.js-pyg.html-292"></a>    <span class="p">});</span>
<a name="code--tic--tic3--tic4.js-pyg.html-293"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-294"></a><span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-295"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-296"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic4.js-pyg.html-297"></a><span class="cm"> * Checks if all the spaces in the board have been used</span>
<a name="code--tic--tic3--tic4.js-pyg.html-298"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic4.js-pyg.html-299"></a><span class="kd">var</span> <span class="nx">is_game_draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">board</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-300"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-301"></a>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-302"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-303"></a>        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-304"></a>      <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-305"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-306"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-307"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-308"></a>  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-309"></a><span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-310"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-311"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic4.js-pyg.html-312"></a><span class="cm"> * Checks from a given marker position if it&#39;s a winner</span>
<a name="code--tic--tic3--tic4.js-pyg.html-313"></a><span class="cm"> * on the horizontal, vertical or diagonal</span>
<a name="code--tic--tic3--tic4.js-pyg.html-314"></a><span class="cm"> *</span>
<a name="code--tic--tic3--tic4.js-pyg.html-315"></a><span class="cm"> * [0, 0, 0] [0, 1, 0] [1, 0, 0] [0, 0, 1]</span>
<a name="code--tic--tic3--tic4.js-pyg.html-316"></a><span class="cm"> * [1, 1, 1] [0, 1, 0] [0, 1, 0] [0, 1, 0]</span>
<a name="code--tic--tic3--tic4.js-pyg.html-317"></a><span class="cm"> * [0, 0, 0] [0, 1, 0] [0, 0, 1] [1, 0, 0]</span>
<a name="code--tic--tic3--tic4.js-pyg.html-318"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic4.js-pyg.html-319"></a><span class="kd">var</span> <span class="nx">is_game_over</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-320"></a>  <span class="c1">// Check the x and y for the following ranges</span>
<a name="code--tic--tic3--tic4.js-pyg.html-321"></a>  <span class="kd">var</span> <span class="nx">found_vertical</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-322"></a>  <span class="kd">var</span> <span class="nx">found_horizontal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-323"></a>  <span class="kd">var</span> <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-324"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-325"></a>  <span class="c1">// y and x = 0 to x = n</span>
<a name="code--tic--tic3--tic4.js-pyg.html-326"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-327"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-328"></a>      <span class="nx">found_horizontal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-329"></a>      <span class="k">break</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-330"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-331"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-332"></a>  <span class="c1">// Found a winning position</span>
<a name="code--tic--tic3--tic4.js-pyg.html-333"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">found_horizontal</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-334"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-335"></a>  <span class="c1">// x and y = 0 to y = n</span>
<a name="code--tic--tic3--tic4.js-pyg.html-336"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-337"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-338"></a>      <span class="nx">found_vertical</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-339"></a>      <span class="k">break</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-340"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-341"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-342"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-343"></a>  <span class="c1">// Found a winning position</span>
<a name="code--tic--tic3--tic4.js-pyg.html-344"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">found_vertical</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-345"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-346"></a>  <span class="c1">// 0, 0 to n, n along the diagonal</span>
<a name="code--tic--tic3--tic4.js-pyg.html-347"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-348"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-349"></a>      <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-350"></a>      <span class="k">break</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-351"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-352"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-353"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-354"></a>  <span class="c1">// Found a winning position</span>
<a name="code--tic--tic3--tic4.js-pyg.html-355"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">found_diagonal</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-356"></a>  <span class="c1">// Reset found diagonal</span>
<a name="code--tic--tic3--tic4.js-pyg.html-357"></a>  <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-358"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-359"></a>  <span class="c1">// n, 0 to 0, n along the diagonal</span>
<a name="code--tic--tic3--tic4.js-pyg.html-360"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-361"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic4.js-pyg.html-362"></a>      <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-363"></a>      <span class="k">break</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-364"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-365"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-366"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-367"></a>  <span class="c1">// Return result of looking in the diagonal</span>
<a name="code--tic--tic3--tic4.js-pyg.html-368"></a>  <span class="k">return</span> <span class="nx">found_diagonal</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-369"></a><span class="p">}</span>
<a name="code--tic--tic3--tic4.js-pyg.html-370"></a>
<a name="code--tic--tic3--tic4.js-pyg.html-371"></a><span class="c1">// Export functions</span>
<a name="code--tic--tic3--tic4.js-pyg.html-372"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">find_all_available_gamers</span> <span class="o">=</span> <span class="nx">find_all_available_gamers</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-373"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">invite_gamer</span>              <span class="o">=</span> <span class="nx">invite_gamer</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-374"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">accept_game</span>               <span class="o">=</span> <span class="nx">accept_game</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-375"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">decline_game</span>              <span class="o">=</span> <span class="nx">decline_game</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-376"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">place_marker</span>              <span class="o">=</span> <span class="nx">place_marker</span><span class="p">;</span>
<a name="code--tic--tic3--tic4.js-pyg.html-377"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">is_game_over</span>              <span class="o">=</span> <span class="nx">is_game_over</span><span class="p">;</span>
</pre></div></div>
<div class="section" id="the-find-all-available-gamers-handler">
<h1>The find_all_available_gamers Handler</h1>
<p>You might have noticed that the file is fairly big so we will go through each method in turn to make it more manageable. Let's start with the <tt class="docutils literal">find_all_available_gamers</tt> method. This method retrieves a list of all <tt class="docutils literal">Gamer</tt> documents for gamers who are currently active (as in connected to the server using <tt class="docutils literal">SocketIO</tt>)</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Locate all the available gamers by their session ids. We do this by introspecting
 * all available connections for SocketIO. However note that if we wanted to use
 * the cluster functionality in Node.JS we would probably have to rewrite this as
 * a lot of the users might be living in different processes and by default SocketIO
 * is only single process aware.
 */</span>
<span class="kd">var</span> <span class="nx">find_all_available_gamers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages
</span>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;find_all_available_gamers&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO
</span>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling
</span>    <span class="c1">// function if it's not the case
</span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Locate all active socket connections
</span>    <span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">clients</span><span class="p">(</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">sids</span> <span class="o">=</span> <span class="p">[</span><span class="p">];</span>

    <span class="c1">// Find all the users session ids excluding the calling functions
</span>    <span class="c1">// this makes up all current active gamers
</span>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">!=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sids</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Locate all the gamers by their session ids
</span>    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findAllGamersBySids</span><span class="p">(</span><span class="nx">sids</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If there is an error during the query return it to the calling function
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

      <span class="c1">// Update All the gamers last active time
</span>      <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">updateGamersUpdatedDateBySids</span><span class="p">(</span><span class="nx">sids</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If there is an error during the update return it to the calling function
</span>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

        <span class="c1">// Emit the list of gamers to the calling function on the client
</span>        <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
          <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">gamers</span>
        <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The very start of the method performs an <tt class="docutils literal">is_authenticated</tt> verifying that the socket passed in is an authenticated session. If it's not valid we return an error notifying the user that they are not authenticated and unable to call this method. If the caller is authenticated we get all active <tt class="docutils literal">SocketIO</tt> clients and get a list of all session ids for active players. Once we have the list of active players we retrieve all the <tt class="docutils literal">Gamer</tt> documents associated with those session ids, and finally update the last active time stamp for those players before returning the list to the caller.</p>
</div>
<div class="section" id="the-invite-gamer-handler">
<h1>The invite_gamer Handler</h1>
<p>The next method concerns the act of inviting another player to play a game. Let's have a look at the code.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Invite a gamer to play a game
 */</span>
<span class="kd">var</span> <span class="nx">invite_gamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages
</span>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;invite_gamer&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;game_invite&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO
</span>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling
</span>    <span class="c1">// function if it's not the case
</span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Locate the destination connection
</span>    <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>

    <span class="c1">// If there is no connection it means the other player went away, send an error message
</span>    <span class="c1">// to the calling function on the client
</span>    <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span>
        <span class="p">,</span> <span class="s2">&quot;Invited user is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Grab our session id
</span>    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>

    <span class="c1">// Locate our gamer object using our session id
</span>    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findGamerBySid</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamer_doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If there is an error during the query return it to the calling function
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

      <span class="c1">// Invite the other player to play a game with the
</span>      <span class="c1">// calling player, we send the calling players session id and
</span>      <span class="c1">// his gamer information
</span>      <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">sid</span><span class="o">:</span> <span class="nx">our_sid</span>
          <span class="p">,</span> <span class="nx">gamer</span><span class="o">:</span> <span class="nx">gamer_doc</span>
        <span class="p">}</span>
      <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>So just as in the <tt class="docutils literal">find_all_available_gamers</tt> method this method can only be called if the caller is authenticated correctly. Notice how we are calling the <tt class="docutils literal">locate_connection_with_session</tt> method. We only have the session id of the player we wish to invite to a game, so we use this function to locate their <tt class="docutils literal">SocketIO</tt> socket allowing us to communicate with them.</p>
<p>If no connection is found we notify the caller about the missing player, otherwise we locate the <tt class="docutils literal">Gamer</tt> instance for the player and send them a <tt class="docutils literal">game_invite</tt> message so they get notified about the invitation. The <tt class="docutils literal">game_invite</tt> message includes the session id of the gamer making the invitation and the <tt class="docutils literal">Gamer</tt> document of the inviting player allowing the invited player to know who sent the invite.</p>
</div>
<div class="section" id="the-decline-game-handler">
<h1>The decline_game Handler</h1>
<p>The next method covers the case where the invited gamer decides to decline the invitation to play a game. Let's take a look at the code for the <tt class="docutils literal">decline_game</tt> method.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Handles the users decision to decline an invitation to a game
 */</span>
<span class="kd">var</span> <span class="nx">decline_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages
</span>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;decline_game&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;invite_gamer&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO
</span>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling
</span>    <span class="c1">// function if it's not the case
</span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Grab our session id
</span>    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
    <span class="c1">// Locate the destination connection
</span>    <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>

    <span class="c1">// If there is no connection it means the other player went away,
</span>    <span class="c1">// send an error message to the calling function on the client
</span>    <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Send an error to the player who sent the invite, outlining the
</span>    <span class="c1">// decline of the offer to play a game
</span>    <span class="nx">emit_error</span><span class="p">(</span><span class="nx">invite_gamer</span><span class="p">,</span> <span class="s2">&quot;User declined game&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The premise for this method is that the player that received the game invitation decides to decline the invitation. Since the invitation contains the inviting users session id we can locate the connection associated with this session id and if it's present, issue the decline as an error to that users <tt class="docutils literal">SocketIO</tt> socket.</p>
<p>Remember how an <tt class="docutils literal">API</tt> method in the frontend registers a callback with an event waiting for a return message from <tt class="docutils literal">SocketIO</tt> containing that event. In the <tt class="docutils literal">invite_gamer</tt> handler we did not actually issue a message with the event <tt class="docutils literal">invite_gamer</tt>. This left the calling method on the frontend waiting for a message with the <tt class="docutils literal">invite_gamer</tt> event. We now notify the original inviter that the game invitation was declined. This usage of events lets us decouple the server processing from the frontend as we only need to notify the frontend by sending events when we are done. This let's us orchestrate interactions between multiple browsers.</p>
</div>
<div class="section" id="the-accept-game-handler">
<h1>The accept_game Handler</h1>
<p>The last method that is part of the invite game cycle is the <tt class="docutils literal">accept_game</tt> method. This method lets a player accept an invitation to play a game. Let's take a look at the code.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Handles the users decision to accept an invitation to play a game
 */</span>
<span class="kd">var</span> <span class="nx">accept_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages
</span>  <span class="kd">var</span> <span class="nx">calling_method_name</span> <span class="o">=</span> <span class="s2">&quot;accept_game&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name</span>          <span class="o">=</span> <span class="s2">&quot;invite_gamer&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO
</span>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling
</span>    <span class="c1">// function if it's not the case
</span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
    <span class="c1">// Our session id
</span>    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
    <span class="c1">// Locate the destination connection
</span>    <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>

    <span class="c1">// If there is no connection it means the other player went away, send an error message
</span>    <span class="c1">// to the calling function on the client
</span>    <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Locate both the calling player and the destination player by their session ids
</span>    <span class="nx">gamer</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">findAllGamersBySids</span><span class="p">(</span><span class="p">[</span><span class="nx">our_sid</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">players</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error notify both the inviter and the invited player about an error
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="nx">players</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">emit_error</span><span class="p">(</span><span class="nx">event_name</span>
          <span class="p">,</span> <span class="s2">&quot;Failed to locate players for game acceptance&quot;</span>
          <span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span>
                  <span class="p">,</span> <span class="s2">&quot;Failed to locate players for game acceptance&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// Grab player 1 and player 2 from the results
</span>      <span class="kd">var</span> <span class="nx">p1</span> <span class="o">=</span> <span class="nx">players</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">p2</span> <span class="o">=</span> <span class="nx">players</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

      <span class="c1">// Create a new game with player 1 and player 2
</span>      <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">create_game</span><span class="p">(</span><span class="nx">p1</span><span class="p">.</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">p1</span><span class="p">.</span><span class="nx">user_name</span>
        <span class="p">,</span> <span class="nx">p1</span><span class="p">.</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">full_name</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game_doc</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// If we have an error notify both the inviter and the invited player
</span>          <span class="c1">// about an error
</span>          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">emit_error</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="s2">&quot;Failed to create a new game&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Failed to create a new game&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
          <span class="p">}</span>

          <span class="c1">// We have a new game, notify both players about the new game information
</span>          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">game_doc</span> <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">game_doc</span> <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The <tt class="docutils literal">accept_game</tt> method is slightly more complicated than the previous <tt class="docutils literal">reject_game</tt> method but take heart it's not as bad as it looks.</p>
<p>First we check if the other player is still available and if he is, we locate both of the player's <tt class="docutils literal">Gamer</tt> information by using the <tt class="docutils literal">Gamer.findAllGamersBySids</tt> method. If we don't get back two documents we return an error to both players telling them we could not find the two players (the emphasis is we notify both of the players at the same time emitting an error on each players socket).</p>
<p>If we do find two <tt class="docutils literal">Gamer</tt> object we create a new <tt class="docutils literal">Game</tt> for the two players. If there is no error during the creation of the game we notify both players (the calling player and the other player that originally sent the invitation) about the successful acceptance of the game invitation.</p>
<p>That's the whole invite and accept/decline and invitation part of the application. Next up is the actual game play. This contains changes both for the backend and the frontend of our application.</p>
</div>
<div class="section" id="the-place-marker-handler">
<h1>The place_marker Handler</h1>
<p>The <tt class="docutils literal">place_marker</tt> method handles the actual game play between two players. It checks if the game has been won by one of the players or if it ended in a draw. It also updates the board to reflect the last move. Let's have a look at the code.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Handles the users decision to accept an invitation to play a game
 */</span>
<span class="kd">var</span> <span class="nx">place_marker</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Easier to keep track of where we emitting messages
</span>  <span class="kd">var</span> <span class="nx">calling_method_name</span>      <span class="o">=</span> <span class="s2">&quot;place_marker&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name_move</span>          <span class="o">=</span> <span class="s2">&quot;game_move&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">event_name_game_over</span>     <span class="o">=</span> <span class="s2">&quot;game_over&quot;</span><span class="p">;</span>

  <span class="c1">// Function we return that accepts the data from SocketIO
</span>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure the user is logged on and emit an error to the calling
</span>    <span class="c1">// function if it's not the case
</span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_authenticated</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">))</span>
      <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;User not authenticated&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
    <span class="c1">// Grab our session id
</span>    <span class="kd">var</span> <span class="nx">our_sid</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>

    <span class="c1">// Locate the game we want to place a marker on
</span>    <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">find_game</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game_doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If there is an error during the query return it to the calling function
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Could not find the game&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

      <span class="c1">// Let's get the current board in play
</span>      <span class="kd">var</span> <span class="nx">board</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">board</span><span class="p">;</span>
      <span class="c1">// Get the marker for the calling player (if we are the starting player we are X)
</span>      <span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">starting_player</span> <span class="o">==</span> <span class="nx">our_sid</span> <span class="o">?</span> <span class="s2">&quot;x&quot;</span> <span class="o">:</span> <span class="s2">&quot;o&quot;</span><span class="p">;</span>

      <span class="c1">// Locate other players session id
</span>      <span class="kd">var</span> <span class="nx">other_player_sid</span> <span class="o">=</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span> <span class="o">==</span> <span class="nx">our_sid</span>
        <span class="o">?</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player2_sid</span>
        <span class="o">:</span> <span class="nx">game_doc</span><span class="p">.</span><span class="nx">player1_sid</span><span class="p">;</span>

      <span class="c1">// If we are trying to set a cell that's already set emit an error
</span>      <span class="c1">// to the calling function
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span> <span class="o">||</span> <span class="nx">board</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Cell already selected&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span><span class="p">;</span>

      <span class="c1">// Mark the cell with our marker
</span>      <span class="nx">board</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="nx">marker</span><span class="p">;</span>

      <span class="c1">// Attempt to update the board
</span>      <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">update_board</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">other_player_sid</span><span class="p">,</span> <span class="nx">board</span>
        <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// If we have an error it was not our turn
</span>          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="s2">&quot;Not your turn&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

          <span class="c1">// Locate the destination connection
</span>          <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">locate_connection_with_session</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">other_player_sid</span><span class="p">);</span>

          <span class="c1">// If there is no connection it means the other player went
</span>          <span class="c1">// away, send an error message to the calling function on the client
</span>          <span class="k">if</span><span class="p">(</span><span class="nx">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span>
              <span class="p">,</span> <span class="s2">&quot;User is no longer available&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

          <span class="c1">// Emit valid move message to caller and the other player
</span>          <span class="c1">// this notifies the clients that they can draw the marker on the board
</span>          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">calling_method_name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
            <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">y</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="o">:</span> <span class="nx">marker</span><span class="p">}</span> <span class="p">}</span>
            <span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
          <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_move</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
            <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">y</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="o">:</span> <span class="nx">marker</span><span class="p">}</span> <span class="p">}</span>
            <span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>

          <span class="c1">// If there was no winner this turn
</span>          <span class="k">if</span><span class="p">(</span><span class="nx">is_game_over</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="p">)</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If there are still fields left on the board, let's keep playing
</span>            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_game_draw</span><span class="p">(</span><span class="nx">board</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

            <span class="c1">// Set the winner
</span>            <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">finalize_board</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
              <span class="c1">// If we have an error it was not our turn
</span>              <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
                <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span>
                  <span class="p">,</span> <span class="s2">&quot;Failed to set winner on table&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

              <span class="c1">// If there are no open spots left on the board the game
</span>              <span class="c1">// is a draw
</span>              <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span>
                <span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">draw</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span> <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
              <span class="k">return</span> <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span>
                <span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">draw</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span> <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
            <span class="p">});</span>
          <span class="p">}</span>

          <span class="c1">// Set the winner
</span>          <span class="nx">game</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">finalize_board</span><span class="p">(</span><span class="nx">our_sid</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">game_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If we have an error it was not our turn
</span>            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
              <span class="k">return</span> <span class="nx">emit_error</span><span class="p">(</span><span class="nx">calling_method_name</span>
                <span class="p">,</span> <span class="s2">&quot;Failed to set winner on table&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>

            <span class="c1">// There was a winner and it was the last user to place a
</span>            <span class="c1">// marker (the calling client) signal both players who won the game
</span>            <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span>
              <span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">winner</span><span class="o">:</span> <span class="nx">our_sid</span><span class="p">}</span> <span class="p">},</span> <span class="nx">socket</span><span class="p">);</span>
            <span class="nx">emit_message</span><span class="p">(</span><span class="nx">event_name_game_over</span>
              <span class="p">,</span> <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">winner</span><span class="o">:</span> <span class="nx">our_sid</span><span class="p">}</span> <span class="p">},</span> <span class="nx">connection</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">})</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The first thing we attempt is to locate the game by the <tt class="docutils literal">game_id</tt> passed in over the <tt class="docutils literal">SocketIO</tt> connection. If we locate a game we grab the game board and assign the calling player a marker.</p>
<p>If the calling player is the same as the <tt class="docutils literal">starting_player</tt> off the game we get the marker <tt class="docutils literal">x</tt> otherwise we get the marker <tt class="docutils literal">o</tt>. We then establish the other players session id by looking at the board (if the called is <tt class="docutils literal">player_1</tt> then the other player is <tt class="docutils literal">player_2</tt>).</p>
<p>It's then time to verify that the co-ordinates passed to the <tt class="docutils literal">player_marker</tt> function point to an empty board position. If it's not empty we return an error to the caller informing them that the cell is already selected. If the board position is empty we place the marker on the board and attempt to update the <tt class="docutils literal">Game</tt> with the new <tt class="docutils literal">board</tt>.</p>
<p>As we discussed earlier this will only succeed if it's the player that is calling this method's turn. Once the update is performed it's time to inform both of the players about the new state of the board by emitting a message with the board position that was changed and what kind of marker was put down.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>   <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">y</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span>
      <span class="p">,</span> <span class="nx">x</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span>
      <span class="p">,</span> <span class="nx">marker</span><span class="o">:</span> <span class="nx">marker</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>After we have emitted the new board state to the frontend, so they can render the board, we try to determine if the game was won by the method's calling player. This is done using the method <tt class="docutils literal">is_game_over</tt>. Let's have a look at the logic in this method.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Checks from a given marker position if it's a winner
 * on the horizontal, vertical or diagonal
 *
 * [0, 0, 0] [0, 1, 0] [1, 0, 0] [0, 0, 1]
 * [1, 1, 1] [0, 1, 0] [0, 1, 0] [0, 1, 0]
 * [0, 0, 0] [0, 1, 0] [0, 0, 1] [1, 0, 0]
 */</span>
<span class="kd">var</span> <span class="nx">is_game_over</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Check the x and y for the following ranges
</span>  <span class="kd">var</span> <span class="nx">found_vertical</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">found_horizontal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c1">// y and x = 0 to x = n
</span>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found_horizontal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// Found a winning position
</span>  <span class="k">if</span><span class="p">(</span><span class="nx">found_horizontal</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c1">// x and y = 0 to y = n
</span>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found_vertical</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Found a winning position
</span>  <span class="k">if</span><span class="p">(</span><span class="nx">found_vertical</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c1">// 0, 0 to n, n along the diagonal
</span>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Found a winning position
</span>  <span class="k">if</span><span class="p">(</span><span class="nx">found_diagonal</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="c1">// Reset found diagonal
</span>  <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c1">// n, 0 to 0, n along the diagonal
</span>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found_diagonal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Return result of looking in the diagonal
</span>  <span class="k">return</span> <span class="nx">found_diagonal</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p>This method checks for the four possible conditions of winning, a <tt class="docutils literal">diagonal</tt>, <tt class="docutils literal">horizontal</tt> or <tt class="docutils literal">vertical</tt> win. There are probably some shorter and smarter versions of this code, but this is left as an exercise to you the reader if you think it's important.</p>
<p>If we determine that the board is not won by the placement of the marker we check if the board is a draw, meaning all positions in the board are marked. This code is very simple and is in the <tt class="docutils literal">is_game_draw</tt> method.</p>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Checks if all the spaces in the board have been used
 */</span>
<span class="kd">var</span> <span class="nx">is_game_draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">board</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p>We just simply check if all of the fields are marked. If they are it's a draw. A single empty field means we are not in a draw position yet and the game can continue. If we have a draw we signal the players that the game ended in a draw, sending them the following message below. We then call the <tt class="docutils literal">Game.finalize_board</tt> method passing in a null for the session id signaling a <tt class="docutils literal">draw</tt>. This updates the board to it's final state.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
    <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span><span class="nx">draw</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
<span class="p">}</span>
</pre>
<p>If the board was won by the calling player we send the players a message containing the winners session id and then call the <tt class="docutils literal">Game.finalize_board</tt> method to finalize the board with the winning session id.</p>
<pre class="code javascript literal-block">
<span class="p">{</span>
    <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">winner</span><span class="o">:</span> <span class="nx">our_sid</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>That covers the backend API's. Before we move on to the frontend code let's wire up the handlers correctly. Open the file <tt class="docutils literal">app.js</tt> and add the new handlers.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic5.js-pyg.html-1"></a><span class="kd">var</span> <span class="nx">env</span>                        <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./env&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic5.js-pyg.html-2"></a>  <span class="p">,</span> <span class="nx">main_controller</span>            <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/controllers/main_controller&#39;</span><span class="p">);</span>
<a name="code--tic--tic3--tic5.js-pyg.html-3"></a>
<a name="code--tic--tic3--tic5.js-pyg.html-4"></a><span class="kd">var</span> <span class="nx">register_handler</span>           <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/login_handler&#39;</span><span class="p">).</span><span class="nx">register_handler</span>
<a name="code--tic--tic3--tic5.js-pyg.html-5"></a>  <span class="p">,</span> <span class="nx">login_handler</span>              <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/login_handler&#39;</span><span class="p">).</span><span class="nx">login_handler</span>
<a name="code--tic--tic3--tic5.js-pyg.html-6"></a>  <span class="p">,</span> <span class="nx">find_all_available_gamers</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic5.js-pyg.html-7"></a>                                    <span class="p">.</span><span class="nx">find_all_available_gamers</span>
<a name="code--tic--tic3--tic5.js-pyg.html-8"></a>  <span class="p">,</span> <span class="nx">invite_gamer</span>               <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">).</span><span class="nx">invite_gamer</span>
<a name="code--tic--tic3--tic5.js-pyg.html-9"></a>  <span class="p">,</span> <span class="nx">decline_game</span>               <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">).</span><span class="nx">decline_game</span>
<a name="code--tic--tic3--tic5.js-pyg.html-10"></a>  <span class="p">,</span> <span class="nx">accept_game</span>                <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">).</span><span class="nx">accept_game</span>
<a name="code--tic--tic3--tic5.js-pyg.html-11"></a>  <span class="p">,</span> <span class="nx">place_marker</span>               <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/handlers/gamer_handler&#39;</span><span class="p">).</span><span class="nx">place_marker</span><span class="p">;</span>
<a name="code--tic--tic3--tic5.js-pyg.html-12"></a>
<a name="code--tic--tic3--tic5.js-pyg.html-13"></a><span class="nx">env</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">io</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic5.js-pyg.html-14"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
<a name="code--tic--tic3--tic5.js-pyg.html-15"></a>
<a name="code--tic--tic3--tic5.js-pyg.html-16"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic5.js-pyg.html-17"></a>  <span class="c1">// http routes</span>
<a name="code--tic--tic3--tic5.js-pyg.html-18"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic5.js-pyg.html-19"></a>  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">main_controller</span><span class="p">.</span><span class="nx">index</span><span class="p">());</span>
<a name="code--tic--tic3--tic5.js-pyg.html-20"></a>
<a name="code--tic--tic3--tic5.js-pyg.html-21"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic5.js-pyg.html-22"></a>  <span class="c1">// websocket api end point handlers (our API)</span>
<a name="code--tic--tic3--tic5.js-pyg.html-23"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic5.js-pyg.html-24"></a>  <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic5.js-pyg.html-25"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;register&#39;</span><span class="p">,</span> <span class="nx">register_handler</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
<a name="code--tic--tic3--tic5.js-pyg.html-26"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="nx">login_handler</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
<a name="code--tic--tic3--tic5.js-pyg.html-27"></a>
<a name="code--tic--tic3--tic5.js-pyg.html-28"></a>    <span class="c1">// The game invite and play methods</span>
<a name="code--tic--tic3--tic5.js-pyg.html-29"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;find_all_available_gamers&#39;</span>
<a name="code--tic--tic3--tic5.js-pyg.html-30"></a>        <span class="p">,</span> <span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
<a name="code--tic--tic3--tic5.js-pyg.html-31"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;invite_gamer&#39;</span><span class="p">,</span> <span class="nx">invite_gamer</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
<a name="code--tic--tic3--tic5.js-pyg.html-32"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;decline_game&#39;</span><span class="p">,</span> <span class="nx">decline_game</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
<a name="code--tic--tic3--tic5.js-pyg.html-33"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;accept_game&#39;</span><span class="p">,</span> <span class="nx">accept_game</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
<a name="code--tic--tic3--tic5.js-pyg.html-34"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;place_marker&#39;</span><span class="p">,</span> <span class="nx">place_marker</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">session_store</span><span class="p">,</span> <span class="nx">db</span><span class="p">));</span>
<a name="code--tic--tic3--tic5.js-pyg.html-35"></a>
<a name="code--tic--tic3--tic5.js-pyg.html-36"></a>    <span class="c1">// Fire the init message to setup the game</span>
<a name="code--tic--tic3--tic5.js-pyg.html-37"></a>    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">event</span><span class="o">:</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="nx">ok</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">});</span>
<a name="code--tic--tic3--tic5.js-pyg.html-38"></a>  <span class="p">});</span>
<a name="code--tic--tic3--tic5.js-pyg.html-39"></a>
<a name="code--tic--tic3--tic5.js-pyg.html-40"></a>  <span class="c1">//</span>
<a name="code--tic--tic3--tic5.js-pyg.html-41"></a>  <span class="c1">// fire up the server</span>
<a name="code--tic--tic3--tic5.js-pyg.html-42"></a>  <span class="c1">//  </span>
<a name="code--tic--tic3--tic5.js-pyg.html-43"></a>  <span class="nx">env</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic5.js-pyg.html-44"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
<a name="code--tic--tic3--tic5.js-pyg.html-45"></a>
<a name="code--tic--tic3--tic5.js-pyg.html-46"></a>    <span class="c1">//</span>
<a name="code--tic--tic3--tic5.js-pyg.html-47"></a>    <span class="c1">// nothing to do</span>
<a name="code--tic--tic3--tic5.js-pyg.html-48"></a>    <span class="c1">//</span>
<a name="code--tic--tic3--tic5.js-pyg.html-49"></a>  <span class="p">});</span>
<a name="code--tic--tic3--tic5.js-pyg.html-50"></a><span class="p">});</span>
</pre></div><p>That's the backend taken care off and all wired up. It's time to turn our attention to the frontend part of the game.</p>
</div>
<div class="section" id="the-front-end">
<h1>The Front End</h1>
<p>Let's get cracking on integrating our awesome backend API's on the frontend so we can play a game of Tic-Tac-Toe. Let's start by implementing the missing API calls on the frontend. Open up the <tt class="docutils literal">public/javascripts/api.js</tt> file in your editor and get typing.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic6.js-pyg.html-1"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-2"></a><span class="cm"> * Wraps the API used for the game and handles the socketIO connection</span>
<a name="code--tic--tic3--tic6.js-pyg.html-3"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-4"></a><span class="kd">var</span> <span class="nx">API</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-5"></a>  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
<a name="code--tic--tic3--tic6.js-pyg.html-6"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-7"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">domain</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-8"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">=</span> <span class="p">{};</span>
<a name="code--tic--tic3--tic6.js-pyg.html-9"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span> <span class="o">=</span> <span class="p">{};</span>
<a name="code--tic--tic3--tic6.js-pyg.html-10"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-11"></a>  <span class="c1">// Handle the data returned over the SocketIO</span>
<a name="code--tic--tic3--tic6.js-pyg.html-12"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-13"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-14"></a>    <span class="c1">// If the data object has an event member we have</span>
<a name="code--tic--tic3--tic6.js-pyg.html-15"></a>    <span class="c1">// a valid event message from the server</span>
<a name="code--tic--tic3--tic6.js-pyg.html-16"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-17"></a>      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
<a name="code--tic--tic3--tic6.js-pyg.html-18"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-19"></a>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-20"></a>          <span class="nx">data</span><span class="p">.</span><span class="nx">is_error</span> <span class="o">?</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">data</span><span class="p">)</span> <span class="o">:</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-21"></a>        <span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-22"></a>      <span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-23"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-24"></a>      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
<a name="code--tic--tic3--tic6.js-pyg.html-25"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-26"></a>        <span class="k">while</span><span class="p">(</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-27"></a>          <span class="nx">data</span><span class="p">.</span><span class="nx">is_error</span> <span class="o">?</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">pop</span><span class="p">()(</span><span class="nx">data</span><span class="p">)</span> <span class="o">:</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">pop</span><span class="p">()(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-28"></a>        <span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-29"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-30"></a>        <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">event</span><span class="p">];</span>
<a name="code--tic--tic3--tic6.js-pyg.html-31"></a>      <span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-32"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-33"></a>  <span class="p">});</span>
<a name="code--tic--tic3--tic6.js-pyg.html-34"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-35"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-36"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-37"></a><span class="cm"> * Register an event listener callback (will keep receiving messages)</span>
<a name="code--tic--tic3--tic6.js-pyg.html-38"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-39"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-40"></a>  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--tic--tic3--tic6.js-pyg.html-41"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-42"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-43"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-44"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-45"></a><span class="cm"> * Register an event listener callback for a single instance of the event</span>
<a name="code--tic--tic3--tic6.js-pyg.html-46"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-47"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">once</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-48"></a>  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--tic--tic3--tic6.js-pyg.html-49"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once_handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-50"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-51"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-52"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-53"></a><span class="cm"> * Register a new user</span>
<a name="code--tic--tic3--tic6.js-pyg.html-54"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-55"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-56"></a>  <span class="c1">// Do basic validation</span>
<a name="code--tic--tic3--tic6.js-pyg.html-57"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">full_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">full_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic3--tic6.js-pyg.html-58"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;Full name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic3--tic6.js-pyg.html-59"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic3--tic6.js-pyg.html-60"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;User name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic3--tic6.js-pyg.html-61"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic3--tic6.js-pyg.html-62"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;Password name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic3--tic6.js-pyg.html-63"></a>  <span class="c1">// Register callback</span>
<a name="code--tic--tic3--tic6.js-pyg.html-64"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-65"></a>  <span class="c1">// Fire message</span>
<a name="code--tic--tic3--tic6.js-pyg.html-66"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-67"></a>      <span class="nx">full_name</span><span class="o">:</span> <span class="nx">full_name</span>
<a name="code--tic--tic3--tic6.js-pyg.html-68"></a>    <span class="p">,</span> <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
<a name="code--tic--tic3--tic6.js-pyg.html-69"></a>    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
<a name="code--tic--tic3--tic6.js-pyg.html-70"></a>  <span class="p">});</span>
<a name="code--tic--tic3--tic6.js-pyg.html-71"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-72"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-73"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-74"></a><span class="cm"> * Login a user</span>
<a name="code--tic--tic3--tic6.js-pyg.html-75"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-76"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">login</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-77"></a>  <span class="c1">// Do basic validation</span>
<a name="code--tic--tic3--tic6.js-pyg.html-78"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">user_name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user_name</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic3--tic6.js-pyg.html-79"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;User name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic3--tic6.js-pyg.html-80"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="code--tic--tic3--tic6.js-pyg.html-81"></a>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">create_error</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;Password name cannot be empty&quot;</span><span class="p">));</span>
<a name="code--tic--tic3--tic6.js-pyg.html-82"></a>  <span class="c1">// Register callback</span>
<a name="code--tic--tic3--tic6.js-pyg.html-83"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-84"></a>  <span class="c1">// Fire message</span>
<a name="code--tic--tic3--tic6.js-pyg.html-85"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-86"></a>      <span class="nx">user_name</span><span class="o">:</span> <span class="nx">user_name</span>
<a name="code--tic--tic3--tic6.js-pyg.html-87"></a>    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
<a name="code--tic--tic3--tic6.js-pyg.html-88"></a>  <span class="p">});</span>
<a name="code--tic--tic3--tic6.js-pyg.html-89"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-90"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-91"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-92"></a><span class="cm"> * Find all available gamers that are active</span>
<a name="code--tic--tic3--tic6.js-pyg.html-93"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-94"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">find_all_available_gamers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-95"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;find_all_available_gamers&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-96"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;find_all_available_gamers&quot;</span><span class="p">,</span> <span class="p">{});</span>
<a name="code--tic--tic3--tic6.js-pyg.html-97"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-98"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-99"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-100"></a><span class="cm"> * Invite a gamer to a new game</span>
<a name="code--tic--tic3--tic6.js-pyg.html-101"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-102"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">invite_gamer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gamer</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-103"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;invite_gamer&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-104"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;invite_gamer&quot;</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-105"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-106"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-107"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-108"></a><span class="cm"> * Decline an invite to play a game</span>
<a name="code--tic--tic3--tic6.js-pyg.html-109"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-110"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">decline_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">invite</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-111"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;decline_game&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-112"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;decline_game&quot;</span><span class="p">,</span> <span class="nx">invite</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-113"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-114"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-115"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-116"></a><span class="cm"> * Accept an invite to play a game</span>
<a name="code--tic--tic3--tic6.js-pyg.html-117"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-118"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">accept_game</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">invite</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-119"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;accept_game&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-120"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;accept_game&quot;</span><span class="p">,</span> <span class="nx">invite</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-121"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-122"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-123"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-124"></a><span class="cm"> * Place a marker on a specific game at a specific location</span>
<a name="code--tic--tic3--tic6.js-pyg.html-125"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-126"></a><span class="nx">API</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">place_marker</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">game_id</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-127"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;place_marker&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<a name="code--tic--tic3--tic6.js-pyg.html-128"></a>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;place_marker&quot;</span><span class="p">,</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-129"></a>      <span class="nx">game_id</span><span class="o">:</span> <span class="nx">game_id</span>
<a name="code--tic--tic3--tic6.js-pyg.html-130"></a>    <span class="p">,</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">x</span>
<a name="code--tic--tic3--tic6.js-pyg.html-131"></a>    <span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">y</span>
<a name="code--tic--tic3--tic6.js-pyg.html-132"></a>  <span class="p">});</span>
<a name="code--tic--tic3--tic6.js-pyg.html-133"></a><span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-134"></a>
<a name="code--tic--tic3--tic6.js-pyg.html-135"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic6.js-pyg.html-136"></a><span class="cm"> * Simple method to create a formated error message that fits the</span>
<a name="code--tic--tic3--tic6.js-pyg.html-137"></a><span class="cm"> * format returned from the server</span>
<a name="code--tic--tic3--tic6.js-pyg.html-138"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic6.js-pyg.html-139"></a><span class="kd">var</span> <span class="nx">create_error</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-140"></a>  <span class="k">return</span> <span class="p">{</span>
<a name="code--tic--tic3--tic6.js-pyg.html-141"></a>      <span class="nx">event</span><span class="o">:</span> <span class="nx">event</span>
<a name="code--tic--tic3--tic6.js-pyg.html-142"></a>    <span class="p">,</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--tic--tic3--tic6.js-pyg.html-143"></a>    <span class="p">,</span> <span class="nx">is_error</span><span class="o">:</span> <span class="kc">true</span>
<a name="code--tic--tic3--tic6.js-pyg.html-144"></a>    <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
<a name="code--tic--tic3--tic6.js-pyg.html-145"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic6.js-pyg.html-146"></a><span class="p">}</span>
</pre></div><p>You might see that we are using two new templates one called <tt class="docutils literal">board.ms</tt> and the other called <tt class="docutils literal">decline_game.ms</tt>. Let's create the two files for now and we will get back to the contents later in the exercise.</p>
<pre class="code console literal-block">
<span class="go">touch public/templates/board.ms
touch public/templates/decline_game.ms</span>
</pre>
<p>So what kind of API calls are we missing on the frontend. Well basically we need to wire up the backend functions we created. Let's look at what those methods are.</p>
<table border="1" class="docutils">
<colgroup>
<col width="34%" />
<col width="66%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Function</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>find_all_available_gamers</td>
<td>Locate all currently active gamers in the system</td>
</tr>
<tr><td>invite_gamer</td>
<td>Invite a player to a game using their session id</td>
</tr>
<tr><td>decline_game</td>
<td>Decline an incoming invitation from another player</td>
</tr>
<tr><td>accept_game</td>
<td>Accept the invitation to a game from another player</td>
</tr>
<tr><td>place_marker</td>
<td>Attempt to place a marker on the Tic-Tac-Toe game</td>
</tr>
</tbody>
</table>
<p>As we can see the methods all map to the backend <tt class="docutils literal">API</tt> nice and cleanly. So let's start writing the frontend application code to make usage of them.</p>
<p>The first thing we want to do is to add a new dialog for the game invitations to our <tt class="docutils literal">lib/views/index.html</tt> file. Let's open up the file and add the <tt class="docutils literal">invite_box</tt> div.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic1.html-pyg.html-1"></a><span class="cp">&lt;!DOCTYPE html&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-2"></a><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span> <span class="na">ng-app=</span><span class="s">&quot;app&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-3"></a>  <span class="nt">&lt;head&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-4"></a>    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-5"></a>    <span class="nt">&lt;title&gt;</span>Tic-Tac-Toe<span class="nt">&lt;/title&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-6"></a>
<a name="code--tic--tic3--tic1.html-pyg.html-7"></a>    <span class="c">&lt;!-- Le styles --&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-8"></a>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/css/bootstrap.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-9"></a>    <span class="nt">&lt;style </span><span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-10"></a>      <span class="nt">body</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.html-pyg.html-11"></a>        <span class="k">padding-top</span><span class="o">:</span> <span class="m">60px</span><span class="p">;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-12"></a>        <span class="k">padding-bottom</span><span class="o">:</span> <span class="m">40px</span><span class="p">;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-13"></a>      <span class="p">}</span>
<a name="code--tic--tic3--tic1.html-pyg.html-14"></a>    <span class="nt">&lt;/style&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-15"></a>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/css/bootstrap-responsive.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-16"></a>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/css/app.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-17"></a>  <span class="nt">&lt;/head&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-18"></a>  <span class="nt">&lt;body&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-19"></a>    <span class="nt">&lt;div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-20"></a>      <span class="nt">&lt;ng</span><span class="na">-view</span><span class="nt">&gt;</span><span class="err">&lt;</span>/ng-view&gt;
<a name="code--tic--tic3--tic1.html-pyg.html-21"></a>    <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-22"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/jquery.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-23"></a>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/socket.io/socket.io.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-24"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/api.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-25"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/mustache.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-26"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/bootstrap.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-27"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/template_handler.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-28"></a>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/app.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-29"></a>
<a name="code--tic--tic3--tic1.html-pyg.html-30"></a>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-31"></a>
<a name="code--tic--tic3--tic1.html-pyg.html-32"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-inverse navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-33"></a>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-34"></a>          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-35"></a>            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-navbar&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;collapse&quot;</span> <span class="na">data-target=</span><span class="s">&quot;.nav-collapse&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-36"></a>              <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-37"></a>              <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-38"></a>              <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-39"></a>            <span class="nt">&lt;/a&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-40"></a>            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;brand&quot;</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Tic-Tac-Toe<span class="nt">&lt;/a&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-41"></a>          <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-42"></a>        <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-43"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-44"></a>
<a name="code--tic--tic3--tic1.html-pyg.html-45"></a>      <span class="c">&lt;!-- Main hero unit for a primary marketing message or call to action --&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-46"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;hero-unit&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-47"></a>        <span class="nt">&lt;h1&gt;</span>Tic Tac Toe!<span class="nt">&lt;/h1&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-48"></a>        <span class="nt">&lt;p&gt;</span>Play Tic Tac Toe against your friends in this multiplayer demo.<span class="nt">&lt;/p&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-49"></a>        <span class="nt">&lt;p&gt;&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary btn-large&quot;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-50"></a>          <span class="na">href=</span><span class="s">&quot;https://github.com/christkv/tic-tac-toe&quot;</span><span class="nt">&gt;</span>Github <span class="ni">&amp;raquo;</span><span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-51"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-52"></a>
<a name="code--tic--tic3--tic1.html-pyg.html-53"></a>      <span class="c">&lt;!-- Example row of columns --&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-54"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span> <span class="na">id=</span><span class="s">&quot;view&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-55"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-56"></a>
<a name="code--tic--tic3--tic1.html-pyg.html-57"></a>      <span class="nt">&lt;hr&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-58"></a>
<a name="code--tic--tic3--tic1.html-pyg.html-59"></a>      <span class="nt">&lt;footer&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-60"></a>        <span class="nt">&lt;p&gt;</span><span class="ni">&amp;copy;</span> Christian Kvalheim 2012<span class="nt">&lt;/p&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-61"></a>      <span class="nt">&lt;/footer&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-62"></a>
<a name="code--tic--tic3--tic1.html-pyg.html-63"></a>    <span class="nt">&lt;/div&gt;</span> <span class="c">&lt;!-- /container --&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-64"></a>    <span class="c">&lt;!-- Modal --&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-65"></a>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;status_box&quot;</span> <span class="na">class=</span><span class="s">&quot;modal hide fade&quot;</span> <span class="na">tabindex=</span><span class="s">&quot;-1&quot;</span> <span class="na">role=</span><span class="s">&quot;dialog&quot;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-66"></a>    <span class="na">aria-labelledby=</span><span class="s">&quot;status_box&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-67"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-header&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-68"></a>        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;button&quot;</span> <span class="na">class=</span><span class="s">&quot;close&quot;</span> <span class="na">data-dismiss=</span><span class="s">&quot;modal&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-69"></a>          
<a name="code--tic--tic3--tic1.html-pyg.html-70"></a>        <span class="nt">&lt;/button&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-71"></a>        <span class="nt">&lt;h3</span> <span class="na">id=</span><span class="s">&quot;status_box_header&quot;</span><span class="nt">&gt;</span>Modal header<span class="nt">&lt;/h3&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-72"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-73"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-body&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-74"></a>        <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;status_box_body&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-75"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-76"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-footer&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-77"></a>        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">&quot;btn&quot;</span> <span class="na">data-dismiss=</span><span class="s">&quot;modal&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>Close<span class="nt">&lt;/button&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-78"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-79"></a>    <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-80"></a>
<a name="code--tic--tic3--tic1.html-pyg.html-81"></a>    <span class="c">&lt;!-- Modal --&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-82"></a>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;invite_box&quot;</span> <span class="na">class=</span><span class="s">&quot;modal hide fade&quot;</span> <span class="na">tabindex=</span><span class="s">&quot;-1&quot;</span> <span class="na">role=</span><span class="s">&quot;dialog&quot;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-83"></a>    <span class="na">aria-labelledby=</span><span class="s">&quot;invite_box&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-84"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-header&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-85"></a>        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;button&quot;</span> <span class="na">class=</span><span class="s">&quot;close&quot;</span> <span class="na">data-dismiss=</span><span class="s">&quot;modal&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-86"></a>          
<a name="code--tic--tic3--tic1.html-pyg.html-87"></a>        <span class="nt">&lt;/button&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-88"></a>        <span class="nt">&lt;h3</span> <span class="na">id=</span><span class="s">&quot;invite_box_header&quot;</span><span class="nt">&gt;</span>Modal header<span class="nt">&lt;/h3&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-89"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-90"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-body&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-91"></a>        <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;invite_box_body&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-92"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-93"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;modal-footer&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-94"></a>        <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;invite_box_accept&quot;</span> <span class="na">class=</span><span class="s">&quot;btn&quot;</span> <span class="na">data-dismiss=</span><span class="s">&quot;modal&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-95"></a>          Accept
<a name="code--tic--tic3--tic1.html-pyg.html-96"></a>        <span class="nt">&lt;/button&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-97"></a>        <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;invite_box_decline&quot;</span> <span class="na">class=</span><span class="s">&quot;btn&quot;</span> <span class="na">data-dismiss=</span><span class="s">&quot;modal&quot;</span> <span class="na">aria-hidden=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-98"></a>          Decline
<a name="code--tic--tic3--tic1.html-pyg.html-99"></a>        <span class="nt">&lt;/button&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-100"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-101"></a>    <span class="nt">&lt;/div&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-102"></a>  <span class="nt">&lt;/body&gt;</span>
<a name="code--tic--tic3--tic1.html-pyg.html-103"></a><span class="nt">&lt;/html&gt;</span>
</pre></div><p>The <tt class="docutils literal">invite_box</tt> div adds the dialog we will present to the user when they get invited to a new game allowing them to accept/decline the invitation.</p>
<p>After adding the new dialog we need to finish writing the template for our dashboard to include the list of available players the user can play. The template is in the file <tt class="docutils literal">public/templates/dashboard.ms</tt>. Open it up and add the following code.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic1.ms-pyg.html-1"></a>&lt;div class=&quot;span8&quot;&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-2"></a>  &lt;h2&gt;All Active Users&lt;/h2&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-3"></a>  &lt;p&gt;All users currently on the system, invite them to play a game.&lt;/p&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-4"></a>  &lt;table class=&quot;table table-striped&quot;&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-5"></a>    &lt;thead&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-6"></a>      &lt;th&gt;Player&lt;/th&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-7"></a>      &lt;th&gt;&lt;/th&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-8"></a>    &lt;/thead&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-9"></a>    &lt;tbody&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-10"></a>      {{#gamers}}
<a name="code--tic--tic3--tic1.ms-pyg.html-11"></a>      &lt;tr&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-12"></a>        &lt;td width=&quot;100%&quot;&gt;{{user_name}}&lt;/td&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-13"></a>        &lt;td&gt;&lt;a href=&quot;#&quot; id=&quot;gamer_{{_id}}&quot;&gt;Play&lt;/a&gt;&lt;/td&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-14"></a>      &lt;/tr&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-15"></a>      {{/gamers}}
<a name="code--tic--tic3--tic1.ms-pyg.html-16"></a>    &lt;/tbody&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-17"></a>  &lt;/table&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-18"></a>&lt;/div&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-19"></a>&lt;div class=&quot;span4&quot;&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-20"></a>  &lt;h2&gt;The Dashboard&lt;/h2&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-21"></a>  &lt;p&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-22"></a>    The list on the left side shows all the active players (connected via socket.io)
<a name="code--tic--tic3--tic1.ms-pyg.html-23"></a>    and lets you challenge one of them to a game. Click on the play link to give it a go.
<a name="code--tic--tic3--tic1.ms-pyg.html-24"></a>  &lt;/p&gt;
<a name="code--tic--tic3--tic1.ms-pyg.html-25"></a>&lt;/div&gt;
</pre></div><p>Notice the <tt class="docutils literal"><span class="pre">{{#gamers}}</span></tt> tag that iterates through the <tt class="docutils literal">gamers</tt> array in the <tt class="docutils literal">context</tt> parameter we pass in when using the <tt class="docutils literal">TemplateHandler.prototype.setTemplate</tt> or <tt class="docutils literal">TemplateHandler.prototype.render</tt> method.</p>
<p>For each gamer we add a new row in a table with a link that has the <tt class="docutils literal">gamer_ + session id</tt> as an identifier. Later we will see how we wire up this link to be able to invite the player identified by it.</p>
<p>That's the dashboard taken care off. Let's move on and wire it up so that when you log on you can see the list of available players. Let's open up <tt class="docutils literal">public/javascripts/app.js</tt> in the editor.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic7.js-pyg.html-1"></a><span class="c1">// Contains the application state</span>
<a name="code--tic--tic3--tic7.js-pyg.html-2"></a><span class="kd">var</span> <span class="nx">application_state</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-3"></a>    <span class="nx">session_id</span><span class="o">:</span> <span class="kc">null</span>
<a name="code--tic--tic3--tic7.js-pyg.html-4"></a>  <span class="p">,</span> <span class="nx">modal</span><span class="o">:</span> <span class="kc">false</span>
<a name="code--tic--tic3--tic7.js-pyg.html-5"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-6"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-7"></a><span class="c1">// Create an instance of the API class</span>
<a name="code--tic--tic3--tic7.js-pyg.html-8"></a><span class="kd">var</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">API</span><span class="p">();</span>
<a name="code--tic--tic3--tic7.js-pyg.html-9"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-10"></a><span class="c1">// Create a template handler with all the templates</span>
<a name="code--tic--tic3--tic7.js-pyg.html-11"></a><span class="c1">// used in the application</span>
<a name="code--tic--tic3--tic7.js-pyg.html-12"></a><span class="kd">var</span> <span class="nx">template_handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TemplateHandler</span><span class="p">({</span>
<a name="code--tic--tic3--tic7.js-pyg.html-13"></a>    <span class="s2">&quot;main&quot;</span><span class="o">:</span> <span class="s2">&quot;/templates/main.ms&quot;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-14"></a>  <span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="o">:</span> <span class="s2">&quot;/templates/dashboard.ms&quot;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-15"></a>  <span class="p">,</span> <span class="s2">&quot;board&quot;</span><span class="o">:</span> <span class="s2">&quot;/templates/board.ms&quot;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-16"></a>  <span class="p">,</span> <span class="s2">&quot;decline_game&quot;</span><span class="o">:</span> <span class="s2">&quot;/templates/decline_game.ms&quot;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-17"></a><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-18"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-19"></a><span class="c1">// Load all the templates and once it&#39;s done</span>
<a name="code--tic--tic3--tic7.js-pyg.html-20"></a><span class="c1">// register up all the initial button handlers</span>
<a name="code--tic--tic3--tic7.js-pyg.html-21"></a><span class="nx">template_handler</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-22"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-23"></a>  <span class="c1">// Render the main view in the #view div</span>
<a name="code--tic--tic3--tic7.js-pyg.html-24"></a>  <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="p">{});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-25"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-26"></a>  <span class="c1">// Wire up the buttons for the main view</span>
<a name="code--tic--tic3--tic7.js-pyg.html-27"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#register_button&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-28"></a>    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">register_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-29"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#login_button&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-30"></a>    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">login_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-31"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-32"></a>  <span class="c1">// Wire up invite box buttons (this is in the main view)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-33"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box_accept&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-34"></a>    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_accept_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-35"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box_decline&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-36"></a>    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_decline_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-37"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-38"></a>  <span class="c1">// Ensure we have the right state for the modal dialog</span>
<a name="code--tic--tic3--tic7.js-pyg.html-39"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-40"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;hide&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-41"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-42"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;hide&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-43"></a><span class="p">})</span>
<a name="code--tic--tic3--tic7.js-pyg.html-44"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-45"></a><span class="cm">/***************************************************************************************</span>
<a name="code--tic--tic3--tic7.js-pyg.html-46"></a><span class="cm"> * Application events we listen to</span>
<a name="code--tic--tic3--tic7.js-pyg.html-47"></a><span class="cm"> ***************************************************************************************/</span>
<a name="code--tic--tic3--tic7.js-pyg.html-48"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-49"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-50"></a><span class="cm"> * The init event, the server has set up everything an assigned us</span>
<a name="code--tic--tic3--tic7.js-pyg.html-51"></a><span class="cm"> * a session id that we can use in the application</span>
<a name="code--tic--tic3--tic7.js-pyg.html-52"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-53"></a><span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-54"></a>  <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-55"></a><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-56"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-57"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-58"></a><span class="cm"> * A new gamer logged on, display the new user in the list of available gamers</span>
<a name="code--tic--tic3--tic7.js-pyg.html-59"></a><span class="cm"> * to play</span>
<a name="code--tic--tic3--tic7.js-pyg.html-60"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-61"></a><span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;gamer_joined&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-62"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-63"></a>  <span class="c1">// Get the gamer</span>
<a name="code--tic--tic3--tic7.js-pyg.html-64"></a>  <span class="kd">var</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-65"></a>  <span class="c1">// Check if we have the gamer already</span>
<a name="code--tic--tic3--tic7.js-pyg.html-66"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="p">[];</span>
<a name="code--tic--tic3--tic7.js-pyg.html-67"></a>  <span class="c1">// Check if the gamer already exists and if it does </span>
<a name="code--tic--tic3--tic7.js-pyg.html-68"></a>  <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-69"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-70"></a>  <span class="c1">// replace it with the new reference</span>
<a name="code--tic--tic3--tic7.js-pyg.html-71"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-72"></a>    <span class="kd">var</span> <span class="nx">_gamer</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<a name="code--tic--tic3--tic7.js-pyg.html-73"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-74"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">_gamer</span><span class="p">.</span><span class="nx">user_name</span> <span class="o">==</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">user_name</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-75"></a>      <span class="nx">found</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-76"></a>      <span class="c1">// Update the sid and update on</span>
<a name="code--tic--tic3--tic7.js-pyg.html-77"></a>      <span class="nx">_gamer</span><span class="p">.</span><span class="nx">sid</span> <span class="o">=</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">sid</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-78"></a>      <span class="nx">_gamer</span><span class="p">.</span><span class="nx">updated_on</span> <span class="o">=</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">updated_on</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-79"></a>      <span class="k">break</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-80"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-81"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-82"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-83"></a>  <span class="c1">// If not found let&#39;s add it to the list</span>
<a name="code--tic--tic3--tic7.js-pyg.html-84"></a>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">found</span><span class="p">)</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">gamer</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-85"></a>  <span class="c1">// If we currently have the dashboard</span>
<a name="code--tic--tic3--tic7.js-pyg.html-86"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">.</span><span class="nx">isTemplate</span><span class="p">(</span><span class="s2">&quot;dashboard&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-87"></a>    <span class="kd">var</span> <span class="nx">gamers</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-88"></a>    <span class="c1">// Let&#39;s go to the dashboard of the game</span>
<a name="code--tic--tic3--tic7.js-pyg.html-89"></a>    <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-90"></a>    <span class="c1">// Add handlers to the event</span>
<a name="code--tic--tic3--tic7.js-pyg.html-91"></a>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-92"></a>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-93"></a>        <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-94"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-95"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-96"></a><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-97"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-98"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-99"></a><span class="cm"> * The opponent made a valid move, render the move on the board</span>
<a name="code--tic--tic3--tic7.js-pyg.html-100"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-101"></a><span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;game_move&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-102"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-103"></a>  <span class="c1">// Get the move data</span>
<a name="code--tic--tic3--tic7.js-pyg.html-104"></a>  <span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">marker</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-105"></a>  <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-106"></a>  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-107"></a>  <span class="c1">// Select the right box and mark it</span>
<a name="code--tic--tic3--tic7.js-pyg.html-108"></a>  <span class="kd">var</span> <span class="nx">cell_id_image</span> <span class="o">=</span> <span class="s2">&quot;#row&quot;</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">+</span> <span class="s2">&quot;cell&quot;</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot; img&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-109"></a>  <span class="c1">// It was our turn, let&#39;s show the mark we set down</span>
<a name="code--tic--tic3--tic7.js-pyg.html-110"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">marker</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-111"></a>    <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/cross.png&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-112"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-113"></a>    <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/circle.png&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-114"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-115"></a><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-116"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-117"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-118"></a><span class="cm"> * The game was won, display victory / defeat / draw dialog</span>
<a name="code--tic--tic3--tic7.js-pyg.html-119"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-120"></a><span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;game_over&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-121"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">draw</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-122"></a>    <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;It was a draw&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;Your equally good, it&#39;s a draw&lt;/p&gt;&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-123"></a>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">==</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-124"></a>    <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;Congratulations&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;You won&lt;/p&gt;&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-125"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-126"></a>    <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;You lost&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;You got beaten buddy&lt;/p&gt;&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-127"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-128"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-129"></a>  <span class="c1">// Let&#39;s load the first 100 public available games</span>
<a name="code--tic--tic3--tic7.js-pyg.html-130"></a>  <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-131"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-132"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-133"></a>    <span class="c1">// Save the list of games in our game state</span>
<a name="code--tic--tic3--tic7.js-pyg.html-134"></a>    <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-135"></a>    <span class="c1">// Let&#39;s go to the dashboard of the game</span>
<a name="code--tic--tic3--tic7.js-pyg.html-136"></a>    <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-137"></a>    <span class="c1">// Add handlers to the event</span>
<a name="code--tic--tic3--tic7.js-pyg.html-138"></a>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-139"></a>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-140"></a>        <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-141"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-142"></a>  <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-143"></a><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-144"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-145"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-146"></a><span class="cm"> * The user was invited to play a game, show the invitation acceptance / decline box</span>
<a name="code--tic--tic3--tic7.js-pyg.html-147"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-148"></a><span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;game_invite&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-149"></a>  <span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-150"></a>  <span class="c1">// Save the invitation in our application state</span>
<a name="code--tic--tic3--tic7.js-pyg.html-151"></a>  <span class="nx">application_state</span><span class="p">.</span><span class="nx">invite</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-152"></a>  <span class="c1">// Open the invite box</span>
<a name="code--tic--tic3--tic7.js-pyg.html-153"></a>  <span class="nx">game_invite_box_show</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">gamer</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-154"></a><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-155"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-156"></a><span class="cm">/***************************************************************************************</span>
<a name="code--tic--tic3--tic7.js-pyg.html-157"></a><span class="cm"> * Handlers</span>
<a name="code--tic--tic3--tic7.js-pyg.html-158"></a><span class="cm"> ***************************************************************************************/</span>
<a name="code--tic--tic3--tic7.js-pyg.html-159"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-160"></a><span class="cm"> * Handles the attempt to register a new user</span>
<a name="code--tic--tic3--tic7.js-pyg.html-161"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-162"></a><span class="kd">var</span> <span class="nx">register_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-163"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-164"></a>    <span class="c1">// Lets get the values for the registration</span>
<a name="code--tic--tic3--tic7.js-pyg.html-165"></a>    <span class="kd">var</span> <span class="nx">full_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputFullNameRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<a name="code--tic--tic3--tic7.js-pyg.html-166"></a>    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputUserNameRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<a name="code--tic--tic3--tic7.js-pyg.html-167"></a>    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputPasswordRegister&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<a name="code--tic--tic3--tic7.js-pyg.html-168"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-169"></a>    <span class="c1">// Attempt to register a new user</span>
<a name="code--tic--tic3--tic7.js-pyg.html-170"></a>    <span class="nx">api</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-171"></a>      <span class="c1">// If we have an error show the error message to the user</span>
<a name="code--tic--tic3--tic7.js-pyg.html-172"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-173"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-174"></a>      <span class="c1">// Load all the available gamers</span>
<a name="code--tic--tic3--tic7.js-pyg.html-175"></a>      <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-176"></a>        <span class="c1">// If we have an error show the error message to the user        </span>
<a name="code--tic--tic3--tic7.js-pyg.html-177"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-178"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-179"></a>        <span class="c1">// Save the list of games in our game state</span>
<a name="code--tic--tic3--tic7.js-pyg.html-180"></a>        <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-181"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-182"></a>        <span class="c1">// Show the main dashboard view and render with all the available players</span>
<a name="code--tic--tic3--tic7.js-pyg.html-183"></a>        <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-184"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-185"></a>        <span class="c1">// Add handlers for each new player so we can play them</span>
<a name="code--tic--tic3--tic7.js-pyg.html-186"></a>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-187"></a>          <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-188"></a>            <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-189"></a>        <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-190"></a>      <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-191"></a>    <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-192"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-193"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-194"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-195"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-196"></a><span class="cm"> * Handles the attempt to login</span>
<a name="code--tic--tic3--tic7.js-pyg.html-197"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-198"></a><span class="kd">var</span> <span class="nx">login_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-199"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-200"></a>    <span class="c1">// Lets get the values for the login</span>
<a name="code--tic--tic3--tic7.js-pyg.html-201"></a>    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputUserNameLogin&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<a name="code--tic--tic3--tic7.js-pyg.html-202"></a>    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputPasswordLogin&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<a name="code--tic--tic3--tic7.js-pyg.html-203"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-204"></a>    <span class="c1">// Attempt to login the user</span>
<a name="code--tic--tic3--tic7.js-pyg.html-205"></a>    <span class="nx">api</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-206"></a>      <span class="c1">// If we have an error show the error message to the user</span>
<a name="code--tic--tic3--tic7.js-pyg.html-207"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-208"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-209"></a>      <span class="c1">// Load all the available gamers</span>
<a name="code--tic--tic3--tic7.js-pyg.html-210"></a>      <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-211"></a>        <span class="c1">// If we have an error show the error message to the user        </span>
<a name="code--tic--tic3--tic7.js-pyg.html-212"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-213"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-214"></a>        <span class="c1">// Save the list of games in our game state</span>
<a name="code--tic--tic3--tic7.js-pyg.html-215"></a>        <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-216"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-217"></a>        <span class="c1">// Show the main dashboard view and render with all the available players</span>
<a name="code--tic--tic3--tic7.js-pyg.html-218"></a>        <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-219"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-220"></a>        <span class="c1">// Add handlers for each new player so we can play them</span>
<a name="code--tic--tic3--tic7.js-pyg.html-221"></a>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-222"></a>          <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-223"></a>            <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-224"></a>        <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-225"></a>      <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-226"></a>    <span class="p">})</span>
<a name="code--tic--tic3--tic7.js-pyg.html-227"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-228"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-229"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-230"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-231"></a><span class="cm"> * Send an invitation to a player to pay a game</span>
<a name="code--tic--tic3--tic7.js-pyg.html-232"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-233"></a><span class="kd">var</span> <span class="nx">invite_gamer_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-234"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-235"></a>    <span class="kd">var</span> <span class="nx">gamer_id</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-236"></a>    <span class="c1">// Get the id</span>
<a name="code--tic--tic3--tic7.js-pyg.html-237"></a>    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">gamer_id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\_/</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
<a name="code--tic--tic3--tic7.js-pyg.html-238"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-239"></a>    <span class="c1">// Locate the gamer object</span>
<a name="code--tic--tic3--tic7.js-pyg.html-240"></a>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-241"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span> <span class="o">==</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-242"></a>        <span class="kd">var</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<a name="code--tic--tic3--tic7.js-pyg.html-243"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-244"></a>        <span class="c1">// Attempt to invite the gamer to play</span>
<a name="code--tic--tic3--tic7.js-pyg.html-245"></a>        <span class="nx">api</span><span class="p">.</span><span class="nx">invite_gamer</span><span class="p">(</span><span class="nx">gamer</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-246"></a>          <span class="c1">// If we have an error show the declined game to the user</span>
<a name="code--tic--tic3--tic7.js-pyg.html-247"></a>          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">decline_box_show</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-248"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-249"></a>          <span class="c1">// Set up the board for a game</span>
<a name="code--tic--tic3--tic7.js-pyg.html-250"></a>          <span class="nx">setupBoardGame</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-251"></a>        <span class="p">})</span>
<a name="code--tic--tic3--tic7.js-pyg.html-252"></a>      <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-253"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-254"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-255"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-256"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-257"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-258"></a><span class="cm"> * Accept an invitation to play a game</span>
<a name="code--tic--tic3--tic7.js-pyg.html-259"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-260"></a><span class="kd">var</span> <span class="nx">invite_accept_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-261"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-262"></a>    <span class="c1">// Accept the game invite</span>
<a name="code--tic--tic3--tic7.js-pyg.html-263"></a>    <span class="nx">api</span><span class="p">.</span><span class="nx">accept_game</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">invite</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-264"></a>      <span class="c1">// If we have an error show the error message to the user        </span>
<a name="code--tic--tic3--tic7.js-pyg.html-265"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-266"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-267"></a>      <span class="c1">// Set up the board for a game</span>
<a name="code--tic--tic3--tic7.js-pyg.html-268"></a>      <span class="nx">setupBoardGame</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-269"></a>    <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-270"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-271"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-272"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-273"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-274"></a><span class="cm"> * Accept an invitation to play a game</span>
<a name="code--tic--tic3--tic7.js-pyg.html-275"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-276"></a><span class="kd">var</span> <span class="nx">invite_decline_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-277"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-278"></a>    <span class="c1">// Decline the game invite</span>
<a name="code--tic--tic3--tic7.js-pyg.html-279"></a>    <span class="nx">api</span><span class="p">.</span><span class="nx">decline_game</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">invite</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-280"></a>      <span class="c1">// If we have an error show the error message to the user        </span>
<a name="code--tic--tic3--tic7.js-pyg.html-281"></a>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-282"></a>      <span class="c1">// No need to do anything as we declined the game and we are still </span>
<a name="code--tic--tic3--tic7.js-pyg.html-283"></a>      <span class="c1">// showing the dashboard</span>
<a name="code--tic--tic3--tic7.js-pyg.html-284"></a>    <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-285"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-286"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-287"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-288"></a><span class="cm">/****************************************************************************************</span>
<a name="code--tic--tic3--tic7.js-pyg.html-289"></a><span class="cm"> * Setup methods</span>
<a name="code--tic--tic3--tic7.js-pyg.html-290"></a><span class="cm"> ****************************************************************************************/</span>
<a name="code--tic--tic3--tic7.js-pyg.html-291"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-292"></a><span class="cm"> * Set up a new game board and add handlers to all the cells of the board</span>
<a name="code--tic--tic3--tic7.js-pyg.html-293"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-294"></a><span class="kd">var</span> <span class="nx">setupBoardGame</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-295"></a>  <span class="c1">// Save current game to state</span>
<a name="code--tic--tic3--tic7.js-pyg.html-296"></a>  <span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span> <span class="o">=</span> <span class="nx">game</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-297"></a>  <span class="c1">// Let&#39;s render the board game</span>
<a name="code--tic--tic3--tic7.js-pyg.html-298"></a>  <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;board&quot;</span><span class="p">,</span> <span class="p">{});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-299"></a>  <span class="c1">// Set the marker for our player (X if we are the starting player)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-300"></a>  <span class="nx">application_state</span><span class="p">.</span><span class="nx">marker</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span> <span class="o">==</span> <span class="nx">game</span><span class="p">.</span><span class="nx">current_player</span>
<a name="code--tic--tic3--tic7.js-pyg.html-301"></a>    <span class="o">?</span> <span class="s2">&quot;x&quot;</span> <span class="o">:</span> <span class="s2">&quot;o&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-302"></a>  <span class="c1">// Get all the rows</span>
<a name="code--tic--tic3--tic7.js-pyg.html-303"></a>  <span class="kd">var</span> <span class="nx">rows</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#board div&#39;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-304"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-305"></a>  <span class="c1">// Add an event handler to each cell</span>
<a name="code--tic--tic3--tic7.js-pyg.html-306"></a>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-307"></a>    <span class="kd">var</span> <span class="nx">cells</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; span&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-308"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-309"></a>    <span class="c1">// For each cell create and add the handler</span>
<a name="code--tic--tic3--tic7.js-pyg.html-310"></a>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">cells</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-311"></a>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">cells</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">id</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-312"></a>        <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">game_board_cell_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-313"></a>    <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-314"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-315"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-316"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-317"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-318"></a><span class="cm"> * Create a cell click handler that will send the events to the server when </span>
<a name="code--tic--tic3--tic7.js-pyg.html-319"></a><span class="cm"> * the user clicks on an event, and also show the result</span>
<a name="code--tic--tic3--tic7.js-pyg.html-320"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-321"></a><span class="kd">var</span> <span class="nx">game_board_cell_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-322"></a>  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-323"></a>    <span class="c1">// Split up the id to get the cell position</span>
<a name="code--tic--tic3--tic7.js-pyg.html-324"></a>    <span class="kd">var</span> <span class="nx">row_number</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;row&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-325"></a>    <span class="kd">var</span> <span class="nx">cell_number</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-326"></a>    <span class="kd">var</span> <span class="nx">cell_id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-327"></a>    <span class="kd">var</span> <span class="nx">cell_id_image</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">cell_id</span> <span class="o">+</span> <span class="s2">&quot; img&quot;</span><span class="p">;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-328"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-329"></a>    <span class="c1">// Let&#39;s attempt to do a move</span>
<a name="code--tic--tic3--tic7.js-pyg.html-330"></a>    <span class="nx">api</span><span class="p">.</span><span class="nx">place_marker</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nx">cell_number</span><span class="p">,</span> <span class="nx">row_number</span>
<a name="code--tic--tic3--tic7.js-pyg.html-331"></a>      <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-332"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-333"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-334"></a>        <span class="c1">// If we won</span>
<a name="code--tic--tic3--tic7.js-pyg.html-335"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">==</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-336"></a>          <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;Congratulations&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;You won&lt;/p&gt;&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-337"></a>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-338"></a>          <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;You lost&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;You got beaten buddy&lt;/p&gt;&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-339"></a>        <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-340"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-341"></a>        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">marker</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-342"></a>          <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/cross.png&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-343"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-344"></a>          <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/circle.png&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-345"></a>        <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-346"></a>      <span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-347"></a>  <span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-348"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-349"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-350"></a><span class="cm">/***************************************************************************************</span>
<a name="code--tic--tic3--tic7.js-pyg.html-351"></a><span class="cm"> * Helper methods</span>
<a name="code--tic--tic3--tic7.js-pyg.html-352"></a><span class="cm"> ***************************************************************************************/</span>
<a name="code--tic--tic3--tic7.js-pyg.html-353"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-354"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-355"></a><span class="cm"> * Show an error message box</span>
<a name="code--tic--tic3--tic7.js-pyg.html-356"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-357"></a><span class="kd">var</span> <span class="nx">error_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-358"></a>  <span class="c1">// Set fields for the error</span>
<a name="code--tic--tic3--tic7.js-pyg.html-359"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_header&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;Registration Error&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-360"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_body&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-361"></a>  <span class="c1">// Show the modal box</span>
<a name="code--tic--tic3--tic7.js-pyg.html-362"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">({</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
<a name="code--tic--tic3--tic7.js-pyg.html-363"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-364"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-365"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-366"></a><span class="cm"> * General message box with configurable title and body content</span>
<a name="code--tic--tic3--tic7.js-pyg.html-367"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-368"></a><span class="kd">var</span> <span class="nx">general_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-369"></a>  <span class="c1">// Set fields for the error</span>
<a name="code--tic--tic3--tic7.js-pyg.html-370"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_header&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-371"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_body&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-372"></a>  <span class="c1">// Show the modal box</span>
<a name="code--tic--tic3--tic7.js-pyg.html-373"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">({</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
<a name="code--tic--tic3--tic7.js-pyg.html-374"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-375"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-376"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-377"></a><span class="cm"> * Show a game decline message box</span>
<a name="code--tic--tic3--tic7.js-pyg.html-378"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-379"></a><span class="kd">var</span> <span class="nx">decline_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-380"></a>  <span class="c1">// Set fields for the error</span>
<a name="code--tic--tic3--tic7.js-pyg.html-381"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_header&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;Invitation to game was declined&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-382"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box_body&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s2">&quot;decline_game&quot;</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">));</span>
<a name="code--tic--tic3--tic7.js-pyg.html-383"></a>  <span class="c1">// Show the modal box</span>
<a name="code--tic--tic3--tic7.js-pyg.html-384"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#status_box&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">({</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
<a name="code--tic--tic3--tic7.js-pyg.html-385"></a><span class="p">}</span>
<a name="code--tic--tic3--tic7.js-pyg.html-386"></a>
<a name="code--tic--tic3--tic7.js-pyg.html-387"></a><span class="cm">/**</span>
<a name="code--tic--tic3--tic7.js-pyg.html-388"></a><span class="cm"> * Show a game invite message box</span>
<a name="code--tic--tic3--tic7.js-pyg.html-389"></a><span class="cm"> */</span>
<a name="code--tic--tic3--tic7.js-pyg.html-390"></a><span class="kd">var</span> <span class="nx">game_invite_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gamer</span><span class="p">)</span> <span class="p">{</span>
<a name="code--tic--tic3--tic7.js-pyg.html-391"></a>  <span class="c1">// Set fields for the error</span>
<a name="code--tic--tic3--tic7.js-pyg.html-392"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box_header&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;You have been invited to a game&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-393"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box_body&#39;</span><span class="p">)</span>
<a name="code--tic--tic3--tic7.js-pyg.html-394"></a>    <span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;The user &lt;strong&gt;&quot;</span>
<a name="code--tic--tic3--tic7.js-pyg.html-395"></a>      <span class="o">+</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">user_name</span> <span class="o">+</span> <span class="s2">&quot;&lt;/strong&gt; has challenged you to a game&quot;</span><span class="p">);</span>
<a name="code--tic--tic3--tic7.js-pyg.html-396"></a>  <span class="c1">// Show the modal box</span>
<a name="code--tic--tic3--tic7.js-pyg.html-397"></a>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#invite_box&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">({</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
<a name="code--tic--tic3--tic7.js-pyg.html-398"></a><span class="p">}</span>
</pre></div><p>We need to add several event handlers as well as several utility methods in <tt class="docutils literal">public/javascripts/app.js</tt>. Let's first look at what we are adding in terms of event handlers.</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="86%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Event</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>gamer_joined</td>
<td>When a new player logs in the list of available players should get updated.</td>
</tr>
<tr><td>game_move</td>
<td>When a valid move board move was performed update the board graphical display</td>
</tr>
<tr><td>game_over</td>
<td>A move lead to the game finishing, determine what the outcome was and display the appropriate message to the player then return to the dashboard to start again</td>
</tr>
<tr><td>game_invite</td>
<td>Another player invited you to join them in a game in Tic-Tac-Toe. Display the dialog to the player to allow them to accept/decline the invitation</td>
</tr>
</tbody>
</table>
<p>Secondly lets look at what other handlers we are adding for user interactions with the application as well as methods to render a board, handle the invite process and the game itself.</p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="81%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>register_button_handler</td>
<td>When the player registers we now need to render the initial list of available players as well as the dashboard</td>
</tr>
<tr><td>login_button_handler</td>
<td>When the player logs in we now need to render the initial list of available players as well as the dashboard</td>
</tr>
<tr><td>invite_gamer_button_handler</td>
<td>When the player clicks on another player to invite them to a game</td>
</tr>
<tr><td>invite_accept_button_handler</td>
<td>Handle the user clicking to accept a game invitation</td>
</tr>
<tr><td>invite_decline_button_handler</td>
<td>Handle the user clicking on decline a game invitation</td>
</tr>
<tr><td>setupBoardGame</td>
<td>Render a new clean Tic-Tac-Toe board and set up all the handlers for the placement of markers on it</td>
</tr>
<tr><td>game_board_cell_handler</td>
<td>Handle the user clicking on a board cell to place a marker</td>
</tr>
<tr><td>general_box_show</td>
<td>Show a general message box dialog</td>
</tr>
<tr><td>decline_box_show</td>
<td>Show a dialog where the other player declined a game invitation</td>
</tr>
<tr><td>game_invite_box_show</td>
<td>Show a dialog when the player gets invited to a new game by another player allowing them to accept/decline the invitation</td>
</tr>
</tbody>
</table>
<p>Let's start with picking apart the code event handlers we listed above.</p>
</div>
<div class="section" id="the-gamer-joined-event-handler">
<h1>The gamer_joined Event Handler</h1>
<pre class="code javascript literal-block">
<span class="cm">/**
 * A new gamer logged on, display the new user in the list of available gamers
 * to play
 */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'gamer_joined'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="c1">// Get the gamer
</span>  <span class="kd">var</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
  <span class="c1">// Check if we have the gamer already
</span>  <span class="k">if</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="p">[</span><span class="p">];</span>
  <span class="c1">// Check if the gamer already exists and if it does
</span>  <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="c1">// replace it with the new reference
</span>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_gamer</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">_gamer</span><span class="p">.</span><span class="nx">user_name</span> <span class="o">==</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">user_name</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">found</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="c1">// Update the sid and update on
</span>      <span class="nx">_gamer</span><span class="p">.</span><span class="nx">sid</span> <span class="o">=</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">sid</span><span class="p">;</span>
      <span class="nx">_gamer</span><span class="p">.</span><span class="nx">updated_on</span> <span class="o">=</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">updated_on</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// If not found let's add it to the list
</span>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">found</span><span class="p">)</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">gamer</span><span class="p">);</span>
  <span class="c1">// If we currently have the dashboard
</span>  <span class="k">if</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">.</span><span class="nx">isTemplate</span><span class="p">(</span><span class="s2">&quot;dashboard&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">gamers</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">;</span>
    <span class="c1">// Let's go to the dashboard of the game
</span>    <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>
    <span class="c1">// Add handlers to the event
</span>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre>
<p>The <tt class="docutils literal">gamer_joined</tt> event handler gets called every time a new player logs in. If the player already exists in our list we update the players session id and last active time to make sure we can talk to the correct player. If it does not exist we push it to the list of our users.</p>
<p>In the case where are currently showing the <tt class="docutils literal">dashboard</tt> view we re-render the list so we can show the newly added player. We don't re-render the dashboard if a modal dialog is currently being shown to the player.</p>
<p>It's left as an exercise to the user on how to handle the rendering if the modal dialog is showing. One possible solution is to defer the rendering until the modal dialog is closed.</p>
</div>
<div class="section" id="the-game-move-event-handler">
<h1>The game_move Event Handler</h1>
<pre class="code javascript literal-block">
<span class="cm">/**
 * The opponent made a valid move, render the move on the board
 */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'game_move'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="c1">// Get the move data
</span>  <span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">marker</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
  <span class="c1">// Select the right box and mark it
</span>  <span class="kd">var</span> <span class="nx">cell_id_image</span> <span class="o">=</span> <span class="s2">&quot;#row&quot;</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">+</span> <span class="s2">&quot;cell&quot;</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot; img&quot;</span><span class="p">;</span>
  <span class="c1">// It was our turn, let's show the mark we set down
</span>  <span class="k">if</span><span class="p">(</span><span class="nx">marker</span> <span class="o">==</span> <span class="s1">'x'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/cross.png&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/circle.png&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre>
<p>The <tt class="docutils literal">game_move</tt> event handler gets called each time a valid marker placement was done on the board. We then figure out if the marker is a <tt class="docutils literal">x</tt> or a <tt class="docutils literal">o</tt> and update the board position to show the image representing the marker placed on the board.</p>
</div>
<div class="section" id="the-game-invite-event-handler">
<h1>The game_invite Event Handler</h1>
<pre class="code javascript literal-block">
<span class="cm">/**
 * The user was invited to play a game, show the invitation acceptance / decline box
 */</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'game_invite'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="c1">// Save the invitation in our application state
</span>  <span class="nx">application_state</span><span class="p">.</span><span class="nx">invite</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
  <span class="c1">// Open the invite box
</span>  <span class="nx">game_invite_box_show</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">gamer</span><span class="p">);</span>
<span class="p">});</span>
</pre>
<p>The <tt class="docutils literal">game_invite</tt> event handler will save the invite in progress in the <tt class="docutils literal">application_state</tt> and then display the invite accept/decline dialog box so the player can accept/decline the invitation.</p>
</div>
<div class="section" id="the-register-button-handler-handler">
<h1>The register_button_handler Handler</h1>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Handles the attempt to register a new user
 */</span>
<span class="kd">var</span> <span class="nx">register_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Lets get the values for the registration
</span>    <span class="kd">var</span> <span class="nx">full_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#inputFullNameRegister'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#inputUserNameRegister'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#inputPasswordRegister'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="p">);</span>

    <span class="c1">// Attempt to register a new user
</span>    <span class="nx">api</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">full_name</span><span class="p">,</span> <span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Load all the available gamers
</span>      <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If we have an error show the error message to the user
</span>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

        <span class="c1">// Save the list of games in our game state
</span>        <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>

        <span class="c1">// Show the main dashboard view and render with all the available players
</span>        <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>

        <span class="c1">// Add handlers for each new player so we can play them
</span>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span>
              <span class="p">,</span> <span class="nx">api</span>
              <span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>We've modified the <tt class="docutils literal">register_button_handler</tt> method to fetch the available players and render the <tt class="docutils literal">dashboard</tt> view showing all of them. After finishing rendering the <tt class="docutils literal">dashboard</tt>, we wire up all the links to the players so we can click on them and trigger an invite to be sent.</p>
</div>
<div class="section" id="the-login-button-handler-handler">
<h1>The login_button_handler Handler</h1>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Handles the attempt to login
 */</span>
<span class="kd">var</span> <span class="nx">login_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Lets get the values for the login
</span>    <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#inputUserNameLogin'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#inputPasswordLogin'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="p">);</span>

    <span class="c1">// Attempt to login the user
</span>    <span class="nx">api</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="nx">user_name</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Load all the available gamers
</span>      <span class="nx">api</span><span class="p">.</span><span class="nx">find_all_available_gamers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gamers</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If we have an error show the error message to the user
</span>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

        <span class="c1">// Save the list of games in our game state
</span>        <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span> <span class="o">=</span> <span class="nx">gamers</span><span class="p">;</span>

        <span class="c1">// Show the main dashboard view and render with all the available players
</span>        <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gamers</span><span class="o">:</span><span class="nx">gamers</span><span class="p">});</span>

        <span class="c1">// Add handlers for each new player so we can play them
</span>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gamer_&quot;</span> <span class="o">+</span> <span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_gamer_button_handler</span><span class="p">(</span><span class="nx">application_state</span>
              <span class="p">,</span> <span class="nx">api</span>
              <span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>We've modified the <tt class="docutils literal">login_button_handler</tt> method to fetch the available players and render the <tt class="docutils literal">dashboard</tt> view showing all of them. After finishing rendering the <tt class="docutils literal">dashboard</tt>, we wire up all the links to the players so we can click on them and trigger an invite to be sent.</p>
</div>
<div class="section" id="the-invite-gamer-button-handler-handler">
<h1>The invite_gamer_button_handler Handler</h1>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Send an invitation to a player to pay a game
 */</span>
<span class="kd">var</span> <span class="nx">invite_gamer_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">gamer_id</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="c1">// Get the id
</span>    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">gamer_id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\_/</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>

    <span class="c1">// Locate the gamer object
</span>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span> <span class="o">==</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">gamer</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">gamers</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

        <span class="c1">// Attempt to invite the gamer to play
</span>        <span class="nx">api</span><span class="p">.</span><span class="nx">invite_gamer</span><span class="p">(</span><span class="nx">gamer</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// If we have an error show the declined game to the user
</span>          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">decline_box_show</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">);</span>

          <span class="c1">// Set up the board for a game
</span>          <span class="nx">setupBoardGame</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
        <span class="p">})</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The <tt class="docutils literal">invite_gamer_button_handler</tt> method triggers when you click on one of the users available to invite. It will first locate the <tt class="docutils literal">Gamer</tt> object for the player and use the <tt class="docutils literal">api.invite_gamer</tt> to attempt to invite the user to a new game. If the other user accepts we call the <tt class="docutils literal">setupBoardGame</tt> function to show the new board and set up all the handlers otherwise we shoe the decline dialog telling the player that the invite was declined.</p>
</div>
<div class="section" id="the-invite-accept-button-handler-handler">
<h1>The invite_accept_button_handler Handler</h1>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Accept an invitation to play a game
 */</span>
<span class="kd">var</span> <span class="nx">invite_accept_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Accept the game invite
</span>    <span class="nx">api</span><span class="p">.</span><span class="nx">accept_game</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">invite</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

      <span class="c1">// Set up the board for a game
</span>      <span class="nx">setupBoardGame</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The <tt class="docutils literal">invite_accept_button_handler</tt> method handles the user clicking the accept button on the invite dialog. It calls the <tt class="docutils literal">api.accept_game</tt> with the existing invite and if the successful it will set up the board using the <tt class="docutils literal">setupBoardGame</tt> function. If unsuccessful we show an error dialog with the relevant error message. Let's see how we wire up those handlers.</p>
<pre class="code javascript literal-block">
<span class="c1">// Load all the templates and once it's done
// register up all the initial button handlers
</span><span class="nx">template_handler</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Render the main view in the #view div
</span>  <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="p">{</span><span class="p">});</span>

  <span class="c1">// Wire up the buttons for the main view
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#register_button'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">register_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#login_button'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">login_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>

  <span class="c1">// Wire up invite box buttons (this is in the main view)
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#invite_box_accept'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_accept_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#invite_box_decline'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">invite_decline_button_handler</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">));</span>

  <span class="c1">// Ensure we have the right state for the modal dialog
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#status_box'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">});</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#status_box'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;hide&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="p">});</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#invite_box'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">});</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#invite_box'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;hide&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="p">});</span>
<span class="p">})</span>
</pre>
<p>Notice how we wire it up in the <tt class="docutils literal">template_handler.start</tt> callback. This goes for both the <tt class="docutils literal">invite_accept_button_handler</tt> and <tt class="docutils literal">invite_decline_button_handler</tt>. We only need to wire up these handlers once as the HTML elements they are wired up to will exist during the entire duration of the applications life. This is in contrast to the <tt class="docutils literal">Gamer</tt> invite links that we need to rewire each time we show the list of <tt class="docutils literal">Gamers</tt> available (Not optimal of course but this is left to you as an exercise to improve on).</p>
</div>
<div class="section" id="the-invite-decline-button-handler-handler">
<h1>The invite_decline_button_handler Handler</h1>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Accept an invitation to play a game
 */</span>
<span class="kd">var</span> <span class="nx">invite_decline_button_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Decline the game invite
</span>    <span class="nx">api</span><span class="p">.</span><span class="nx">decline_game</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">invite</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If we have an error show the error message to the user
</span>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
      <span class="c1">// No need to do anything as we declined the game and we
</span>      <span class="c1">// are still showing the dashboard
</span>    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The <tt class="docutils literal">invite_decline_button_handler</tt> handles the user clicking the decline button on invitation dialog. It calls the <tt class="docutils literal">api.decline_game</tt> with the existing invite to cancel the invite and notify the inviting player about the player declining the invitation.</p>
</div>
<div class="section" id="the-setupboardgame-function">
<h1>The setupBoardGame Function</h1>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Set up a new game board and add handlers to all the cells of the board
 */</span>
<span class="kd">var</span> <span class="nx">setupBoardGame</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Save current game to state
</span>  <span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span> <span class="o">=</span> <span class="nx">game</span><span class="p">;</span>
  <span class="c1">// Let's render the board game
</span>  <span class="nx">template_handler</span><span class="p">.</span><span class="nx">setTemplate</span><span class="p">(</span><span class="s2">&quot;#view&quot;</span><span class="p">,</span> <span class="s2">&quot;board&quot;</span><span class="p">,</span> <span class="p">{</span><span class="p">});</span>
  <span class="c1">// Set the marker for our player (X if we are the starting player)
</span>  <span class="nx">application_state</span><span class="p">.</span><span class="nx">marker</span> <span class="o">=</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span> <span class="o">==</span> <span class="nx">game</span><span class="p">.</span><span class="nx">current_player</span>
    <span class="o">?</span> <span class="s2">&quot;x&quot;</span> <span class="o">:</span> <span class="s2">&quot;o&quot;</span><span class="p">;</span>
  <span class="c1">// Get all the rows
</span>  <span class="kd">var</span> <span class="nx">rows</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#board div'</span><span class="p">);</span>

  <span class="c1">// Add an event handler to each cell
</span>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cells</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#'</span> <span class="o">+</span> <span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; span&quot;</span><span class="p">);</span>

    <span class="c1">// For each cell create and add the handler
</span>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">cells</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">cells</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">id</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">game_board_cell_handler</span><span class="p">(</span><span class="nx">application_state</span>
          <span class="p">,</span> <span class="nx">api</span>
          <span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The <tt class="docutils literal">setupBoardGame</tt> function generates a new Tic-Tac-Toe game and renders the board in the browser and then attaches a handler <tt class="docutils literal">game_board_cell_handler</tt> for each cell in the board that will handle the click of the user on that cell.</p>
<p>We created the <tt class="docutils literal">public/templates/board.ms</tt> earlier and it's time to fill in the template with the layout of the board game.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic2.ms-pyg.html-1"></a>&lt;div class=&quot;span8&quot;&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-2"></a>  &lt;div id=&quot;board&quot; class=&quot;board&quot;&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-3"></a>    &lt;div id=&quot;row0&quot; class=&quot;board_row&quot;&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-4"></a>      &lt;span id=&quot;row0cell0&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-5"></a>      &lt;span id=&quot;row0cell1&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-6"></a>      &lt;span id=&quot;row0cell2&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-7"></a>      &lt;span id=&quot;row0cell3&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-8"></a>    &lt;/div&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-9"></a>    &lt;div id=&quot;row1&quot; class=&quot;board_row&quot;&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-10"></a>      &lt;span id=&quot;row1cell0&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-11"></a>      &lt;span id=&quot;row1cell1&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-12"></a>      &lt;span id=&quot;row1cell2&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-13"></a>      &lt;span id=&quot;row1cell3&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-14"></a>    &lt;/div&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-15"></a>    &lt;div id=&quot;row2&quot; class=&quot;board_row&quot;&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-16"></a>      &lt;span id=&quot;row2cell0&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-17"></a>      &lt;span id=&quot;row2cell1&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-18"></a>      &lt;span id=&quot;row2cell2&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-19"></a>      &lt;span id=&quot;row2cell3&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-20"></a>    &lt;/div&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-21"></a>    &lt;div id=&quot;row3&quot; class=&quot;board_row&quot;&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-22"></a>      &lt;span id=&quot;row3cell0&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-23"></a>      &lt;span id=&quot;row3cell1&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-24"></a>      &lt;span id=&quot;row3cell2&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-25"></a>      &lt;span id=&quot;row3cell3&quot;&gt;&lt;img src=&quot;/img/board_background_img.png&quot;/&gt;&lt;/span&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-26"></a>    &lt;/div&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-27"></a>  &lt;/div&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-28"></a>&lt;/div&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-29"></a>&lt;div class=&quot;span4&quot;&gt;
<a name="code--tic--tic3--tic2.ms-pyg.html-30"></a>&lt;/div&gt;
</pre></div><p>Nothing special here just a table with 4 rows and 4 columns containing a default background image as a placeholder.</p>
</div>
<div class="section" id="the-game-board-cell-handler-function">
<h1>The game_board_cell_handler Function</h1>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Create a cell click handler that will send the events to the server when the user clicks
 * on an event, and also show the result
 */</span>
<span class="kd">var</span> <span class="nx">game_board_cell_handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">application_state</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">template_handler</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Split up the id to get the cell position
</span>    <span class="kd">var</span> <span class="nx">row_number</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;row&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">cell_number</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">cell_id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">cell_id_image</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">cell_id</span> <span class="o">+</span> <span class="s2">&quot; img&quot;</span><span class="p">;</span>

    <span class="c1">// Let's attempt to do a move
</span>    <span class="nx">api</span><span class="p">.</span><span class="nx">place_marker</span><span class="p">(</span><span class="nx">application_state</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">_id</span>
      <span class="p">,</span> <span class="nx">cell_number</span>
      <span class="p">,</span> <span class="nx">row_number</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">error_box_show</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

        <span class="c1">// If we won
</span>        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">==</span> <span class="nx">application_state</span><span class="p">.</span><span class="nx">session_id</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;Congratulations&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;You won&lt;/p&gt;&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">winner</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">general_box_show</span><span class="p">(</span><span class="s2">&quot;You lost&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;p&gt;You got beaten buddy&lt;/p&gt;&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">marker</span> <span class="o">==</span> <span class="s1">'x'</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/cross.png&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">cell_id_image</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/img/circle.png&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The <tt class="docutils literal">game_board_cell_handler</tt> is attached to each cell in the Tic-Tac-Toe board and detects the player clicking on it. When its fired, it will attempt to place a marker in that cell calling the <tt class="docutils literal">api.place_marker</tt> method.</p>
<p>If the placement of the marker leads to victory the player will receive a message back with the field <tt class="docutils literal">winner</tt> set to the session id of the winning player. If that session id matches the calling player he won and we show the winning dialog. If it does not match we show the loser dialog. If we don't have a winner or loser we set the cell with the marker to show the move.</p>
</div>
<div class="section" id="the-general-box-show-function">
<h1>The general_box_show Function</h1>
<pre class="code javascript literal-block">
<span class="cm">/**
 * General message box with configurable title and body content
 */</span>
<span class="kd">var</span> <span class="nx">general_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Set fields for the error
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#status_box_header'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#status_box_body'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
  <span class="c1">// Show the modal box
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#status_box'</span><span class="p">).</span><span class="nx">modal</span><span class="p">(</span><span class="p">{</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
<span class="p">}</span>
</pre>
<p>Generates a general box dialog with a provided title and body. Used to allow us to show a dialog with a custom title and body.</p>
</div>
<div class="section" id="the-decline-box-show-function">
<h1>The decline_box_show Function</h1>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Show a game decline message box
 */</span>
<span class="kd">var</span> <span class="nx">decline_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Set fields for the error
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#status_box_header'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;Invitation to game was declined&quot;</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#status_box_body'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">template_handler</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s2">&quot;decline_game&quot;</span><span class="p">,</span> <span class="nx">gamer</span><span class="p">));</span>
  <span class="c1">// Show the modal box
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#status_box'</span><span class="p">).</span><span class="nx">modal</span><span class="p">(</span><span class="p">{</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
<span class="p">}</span>
</pre>
<p>Generates a decline box dialog with the information about the gamer who declined the invite.</p>
<p>We use a <tt class="docutils literal">decline_game</tt> template here that we created earlier. Let's fill in the template.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic3.ms-pyg.html-1"></a>&lt;p&gt;The invitation to play a game was declined by &lt;strong&gt;{{user_name}}&lt;/strong&gt;&lt;/p&gt;
</pre></div><p>As we can see it just renders the decline message using the passed in player information.</p>
</div>
<div class="section" id="the-game-invite-box-show-function">
<h1>The game_invite_box_show Function</h1>
<pre class="code javascript literal-block">
<span class="cm">/**
 * Show a game invite message box
 */</span>
<span class="kd">var</span> <span class="nx">game_invite_box_show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gamer</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Set fields for the error
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#invite_box_header'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;You have been invited to a game&quot;</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#invite_box_body'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;The user &lt;strong&gt;&quot;</span>
      <span class="o">+</span> <span class="nx">gamer</span><span class="p">.</span><span class="nx">user_name</span>
      <span class="o">+</span> <span class="s2">&quot;&lt;/strong&gt; has challenged you to a game&quot;</span><span class="p">);</span>
  <span class="c1">// Show the modal box
</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'#invite_box'</span><span class="p">).</span><span class="nx">modal</span><span class="p">(</span><span class="p">{</span><span class="nx">backdrop</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
<span class="p">}</span>
</pre>
<p>Generates a accept/decline dialog box populated with the information of the inviting player.</p>
</div>
<div class="section" id="styling-that-game">
<h1>Styling That Game</h1>
<p>Alright we are all wired up just one more thing to fix. Let's pretty up the board a little by adjusting the css for the board. Open the file <tt class="docutils literal">public/css/app.css</tt> and enter the css.</p>
<div class="highlight"><pre><a name="code--tic--tic3--tic1.css-pyg.html-1"></a><span class="nc">.board</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.css-pyg.html-2"></a>  <span class="k">margin-left</span><span class="o">:</span><span class="m">20px</span><span class="p">;</span>
<a name="code--tic--tic3--tic1.css-pyg.html-3"></a><span class="p">}</span>
<a name="code--tic--tic3--tic1.css-pyg.html-4"></a>
<a name="code--tic--tic3--tic1.css-pyg.html-5"></a><span class="nc">.board_row</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.css-pyg.html-6"></a>  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
<a name="code--tic--tic3--tic1.css-pyg.html-7"></a><span class="p">}</span>
<a name="code--tic--tic3--tic1.css-pyg.html-8"></a>
<a name="code--tic--tic3--tic1.css-pyg.html-9"></a><span class="nc">.board_row</span> <span class="nt">span</span> <span class="p">{</span>
<a name="code--tic--tic3--tic1.css-pyg.html-10"></a>  <span class="k">margin-right</span><span class="o">:</span> <span class="m">5px</span>
<a name="code--tic--tic3--tic1.css-pyg.html-11"></a><span class="p">}</span>
</pre></div></div>
<div class="section" id="wrapping-up">
<h1>Wrapping Up</h1>
<p>Awesome we just finished <tt class="docutils literal">Exercise 3</tt> and we have a fully working Tic-Tac-Toe game. In <tt class="docutils literal">Exercise 4</tt> we will add some bonus features to the game and also handle a user closing the browser window in the middle of a game or deciding to quit a game in progress.</p>
</div>
<div class="section" id="notes">
<h1>Notes</h1>
<p>There is lots of room for improvement in the code that you can do. Deferring the rendering of available players when a dialog is showing is one such thing. Rendering the board once only and clearing it instead of re-rendering might be another possible avenue.</p>
</div>
    </div>

    <div class="one columns" id="right-nav">
        <center>
        <p><a href="/book/"><img src="images/48_structure.png"></a></p>
        <p><a href="#"><img src="images/48_email.png"></a></p>
        <p><a href="#faq"><img src="images/48_faq.png"></a></p>
        <p>
        </p>
        </center>
    </div>

  <!-- Included JS Files (Compressed) -->
  <script src="javascripts/jquery.js"></script>
  <script src="javascripts/foundation.min.js"></script>
  
  <!-- Initialize JS Plugins -->
  <script src="javascripts/app.js"></script>

</body>
</html>